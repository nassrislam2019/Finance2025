<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>My Finance Pro</title>
    <style>
        /* --- CSS STYLING --- */
        :root {
            --primary: #6366f1;
            --primary-rgb: 99, 102, 241;
            --primary-dark: #4338ca;
            --bg-grad-start: #f3f4f6;
            --bg-grad-end: #e0e7ff;
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: rgba(255, 255, 255, 0.6);
            --text: #1e293b;
            --text-sub: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .dark {
            --primary: #818cf8;
            --primary-rgb: 129, 140, 248;
            --primary-dark: #6366f1;
            --bg-grad-start: #0f172a;
            --bg-grad-end: #1e1b4b;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
            --text: #f1f5f9;
            --text-sub: #94a3b8;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            background-attachment: fixed;
            color: var(--text); 
            padding-bottom: 90px; 
            min-height: 100vh;
            transition: color 0.3s; 
            overscroll-behavior-y: none; 
        }

        .container { max-width: 600px; margin: 0 auto; padding: 16px; }

        /* Typography */
        h1, h2, h3 { margin: 0; letter-spacing: -0.02em; }
        .text-3xl { font-size: 28px; font-weight: 800; }
        .text-xl { font-size: 22px; font-weight: 800; }
        .text-lg { font-size: 18px; font-weight: 700; }
        .text-base { font-size: 15px; }
        .text-sm { font-size: 13px; }
        .text-xs { font-size: 11px; }
        .text-sub { color: var(--text-sub); }
        .bold { font-weight: 700; }
        .uppercase { text-transform: uppercase; letter-spacing: 0.05em; }

        /* Components */
        .card { 
            background: var(--card-bg); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px; 
            padding: 20px; 
            box-shadow: var(--shadow); 
            margin-bottom: 16px; 
            border: 1px solid var(--card-border); 
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            position: relative;
            overflow: hidden;
        }
        .summary-card .text-sub { color: rgba(255,255,255,0.7); }
        .summary-blob {
            position: absolute; width: 150px; height: 150px; background: rgba(255,255,255,0.1);
            border-radius: 50%; top: -50px; right: -50px; pointer-events: none;
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }

        .btn { 
            border: none; padding: 12px 16px; border-radius: 14px; 
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            gap: 6px; transition: all 0.2s; font-size: 14px; 
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; width: 100%; 
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
        }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-outline { background: transparent; border: 1px solid var(--card-border); color: var(--text); }
        .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 10px; }

        /* Header & Nav */
        header { 
            position: sticky; top: 0; 
            background: var(--card-bg); 
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            padding: 16px; 
            border-bottom: 1px solid var(--card-border); 
            z-index: 50; display: flex; justify-content: space-between; align-items: center; 
        }
        
        nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--card-bg); 
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid var(--card-border); 
            display: flex; justify-content: space-around; 
            padding: 12px 0 24px 0; z-index: 50; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        
        .nav-item { 
            background: none; border: none; display: flex; flex-direction: column; align-items: center; 
            gap: 5px; color: var(--text-sub); font-size: 10px; font-weight: 600; cursor: pointer; 
            transition: color 0.2s;
        }
        .nav-item svg { transition: transform 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active svg { transform: translateY(-2px); stroke-width: 2.5; }

        /* Inputs */
        .input-group { margin-bottom: 14px; }
        .label { display: block; font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.05em; }
        .input { 
            width: 100%; padding: 14px; border-radius: 14px; 
            border: 1px solid var(--card-border); 
            background: rgba(255,255,255,0.5); 
            color: var(--text); font-size: 16px; outline: none; 
            transition: border-color 0.2s, background 0.2s;
        }
        .dark .input { background: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.1); }
        .input:focus { border-color: var(--primary); background: transparent; }

        /* FAB */
        .fab { 
            position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; 
            border-radius: 20px; 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; border: none; 
            box-shadow: 0 8px 20px rgba(var(--primary-rgb), 0.4); 
            z-index: 40; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            font-size: 28px; transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; padding: 20px; opacity: 0; transition: opacity 0.2s; }
        .modal.open { display: flex; opacity: 1; }
        .modal-content { 
            background: var(--bg-grad-start); 
            width: 100%; max-width: 400px; border-radius: 24px; padding: 24px; 
            max-height: 90vh; overflow-y: auto; 
            box-shadow: var(--glass-shadow);
            transform: scale(0.95); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .dark .modal-content { background: #1e293b; }
        .modal.open .modal-content { transform: scale(1); }

        /* Chart Styling */
        .chart-container { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .donut-chart { 
            width: 160px; height: 160px; border-radius: 50%; 
            background: conic-gradient(var(--text-sub) 0% 100%); 
            position: relative; 
            flex-shrink: 0;
            transition: background 0.5s ease;
        }
        .donut-hole { 
            position: absolute; width: 110px; height: 110px; 
            background: var(--card-bg); border-radius: 50%; 
            top: 25px; left: 25px; 
            display: flex; align-items: center; justify-content: center; 
            flex-direction: column;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            z-index: 2;
        }
        .chart-legend { flex: 1; min-width: 140px; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 13px; font-weight: 500;}
        .legend-color { width: 12px; height: 12px; border-radius: 4px; flex-shrink: 0; }

        /* Transactions List */
        .tx-item { 
            display: flex; align-items: center; gap: 12px; padding: 12px 0; 
            border-bottom: 1px solid var(--card-border); 
            cursor: pointer;
        }
        .tx-item:last-child { border-bottom: none; }
        .tx-icon { width: 40px; height: 40px; border-radius: 12px; background: rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .dark .tx-icon { background: rgba(255,255,255,0.1); }
        .tx-details { flex: 1; min-width: 0; }
        .tx-amount { font-weight: 700; font-size: 15px; }
        
        /* Privacy Blur */
        body.privacy-mode .privacy-blur { filter: blur(6px); transition: filter 0.2s; user-select: none; }
        body.privacy-mode .privacy-blur:hover { filter: blur(0); }

        /* Helpers */
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .hidden { display: none !important; }
        .w-full { width: 100%; }

        /* Budget Bar */
        .budget-bar { height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .budget-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease; }
        .dark .budget-bar { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-2">
            <div style="width:36px; height:36px; background:linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; box-shadow: 0 4px 10px rgba(var(--primary-rgb), 0.3);">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
            </div>
            <div class="text-xl bold" id="appTitle">My Finance</div>
        </div>
        <div class="flex gap-2">
            <button class="btn-ghost" style="font-size:18px; width:40px; height:40px; border-radius:50%;" onclick="togglePrivacy()" id="privacyBtn" title="Privacy Mode">üëÅÔ∏è</button>
            <button class="btn-ghost" style="font-size:20px; width:40px; height:40px; border-radius:50%;" onclick="toggleTheme()" id="themeBtn" aria-label="Toggle theme">üåû</button>
        </div>
    </header>

    <div id="mainContainer" class="container">
        <!-- Content injected by JS -->
    </div>

    <button class="fab" onclick="openModal('add')" aria-label="Add transaction">
        <svg style="width:28px; height:28px; stroke:white; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; fill:none;" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>

    <nav>
        <button class="nav-item active" onclick="switchView('dashboard')" id="nav-dash">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="switchView('transactions')" id="nav-tx">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 17l-5-5 5-5"/><path d="M20 12H4"/></svg>
            <span>Transact</span>
        </button>
        <button class="nav-item" onclick="switchView('accounts')" id="nav-acc">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
            <span>Wallets</span>
        </button>
        <button class="nav-item" onclick="switchView('settings')" id="nav-set">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <span>Settings</span>
        </button>
    </nav>

    <!-- Transaction Modal -->
    <div id="txModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom:20px;">
                <h2 class="text-xl" id="modalTitle">Transaction</h2>
                <button class="btn-ghost" onclick="closeModal()">‚úï</button>
            </div>

            <div class="flex gap-2" style="background:rgba(0,0,0,0.05); padding:4px; border-radius:16px; margin-bottom:16px;">
                <button type="button" class="btn" style="flex:1; background:var(--danger); color:white;" id="btn-exp" onclick="setTxType('exp')">Expense</button>
                <button type="button" class="btn btn-ghost" style="flex:1;" id="btn-inc" onclick="setTxType('inc')">Income</button>
            </div>

            <input type="hidden" id="txId">
            <div class="input-group">
                <label class="label">Amount</label>
                <input type="number" id="txAmount" class="input" placeholder="0.00" inputmode="decimal" step="0.01" />
            </div>
            <div class="input-group">
                <label class="label">Date</label>
                <input type="date" id="txDate" class="input" />
            </div>
            <div class="input-group">
                <label class="label">Description</label>
                <input type="text" id="txDesc" class="input" placeholder="e.g. Lunch" />
            </div>
            <div class="input-group">
                <label class="label">Category</label>
                <input type="text" id="txCat" class="input" list="catList" placeholder="Select or type..." />
                <datalist id="catList"></datalist>
            </div>

            <div class="flex gap-2" style="margin-top:24px;">
                <button class="btn btn-danger hidden" id="btnDelete" onclick="deleteTxClick()" style="flex:1">Delete</button>
                <button class="btn btn-primary" onclick="saveTx()" style="flex:2">Save</button>
            </div>
        </div>
    </div>

    <!-- Script Logic -->
    <script>
        // State
        let transactions = [];
        let currency = '$';
        let currentView = 'dashboard';
        let txType = 'exp'; // 'exp' or 'inc'
        let monthlyBudget = 2000;
        let categories = ["üçî Food", "üè† Rent", "üöó Transport", "üõçÔ∏è Shopping", "üí° Utilities", "üé¨ Entertainment", "üè• Health", "üí∏ Salary", "üìà Investment"];

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initDateInput();
            renderCategories();
            switchView('dashboard');
            
            // Theme Check
            if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
        });

        // --- Core Functions ---

        function loadData() {
            const saved = localStorage.getItem('mf_data');
            if (saved) {
                transactions = JSON.parse(saved);
            } else {
                // Mock Data for new users
                transactions = [
                    { id: 1, amount: 2500, type: 'inc', desc: 'Salary', category: 'üí∏ Salary', date: new Date().toISOString().split('T')[0] },
                    { id: 2, amount: 45.50, type: 'exp', desc: 'Grocery Run', category: 'üçî Food', date: new Date().toISOString().split('T')[0] },
                    { id: 3, amount: 1200, type: 'exp', desc: 'Rent', category: 'üè† Rent', date: new Date(Date.now() - 86400000 * 2).toISOString().split('T')[0] },
                ];
                saveData();
            }
            
            const savedBudget = localStorage.getItem('mf_budget');
            if (savedBudget) monthlyBudget = parseFloat(savedBudget);
        }

        function saveData() {
            localStorage.setItem('mf_data', JSON.stringify(transactions));
            localStorage.setItem('mf_budget', monthlyBudget);
            updateUI();
        }

        function updateUI() {
            if (currentView === 'dashboard') renderDashboard();
            if (currentView === 'transactions') renderTransactionsView();
            if (currentView === 'accounts') renderAccounts(); // Placeholder logic
        }

        function switchView(viewName) {
            currentView = viewName;
            
            // Update Nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + (viewName === 'dashboard' ? 'dash' : viewName === 'transactions' ? 'tx' : viewName === 'accounts' ? 'acc' : 'set')).classList.add('active');

            const container = document.getElementById('mainContainer');
            container.innerHTML = ''; // Clear
            container.classList.remove('animate-enter');
            void container.offsetWidth; // Trigger reflow
            container.classList.add('animate-enter');

            if (viewName === 'dashboard') renderDashboard();
            else if (viewName === 'transactions') renderTransactionsView();
            else if (viewName === 'accounts') renderAccountsView();
            else if (viewName === 'settings') renderSettingsView();
        }

        // --- View Renderers ---

        function renderDashboard() {
            const totalIncome = transactions.reduce((sum, t) => t.type === 'inc' ? sum + t.amount : sum, 0);
            const totalExp = transactions.reduce((sum, t) => t.type === 'exp' ? sum + t.amount : sum, 0);
            const balance = totalIncome - totalExp;

            // Budget Calc (Simulated for this month)
            const currentMonth = new Date().toISOString().slice(0, 7);
            const thisMonthExp = transactions
                .filter(t => t.type === 'exp' && t.date.startsWith(currentMonth))
                .reduce((sum, t) => sum + t.amount, 0);
            const budgetPct = Math.min((thisMonthExp / monthlyBudget) * 100, 100);
            const budgetColor = budgetPct > 90 ? 'var(--danger)' : budgetPct > 70 ? 'var(--warning)' : 'var(--primary)';

            let html = `
                <div class="card summary-card">
                    <div class="summary-blob"></div>
                    <div class="text-sub" style="color:rgba(255,255,255,0.8)">Total Balance</div>
                    <div class="text-3xl bold privacy-blur" style="margin-top:4px;">${formatMoney(balance)}</div>
                    <div class="flex gap-4" style="margin-top:16px;">
                        <div>
                            <div class="text-xs text-sub" style="color:rgba(255,255,255,0.7)">Income</div>
                            <div class="text-lg bold privacy-blur">${formatMoney(totalIncome)}</div>
                        </div>
                        <div>
                            <div class="text-xs text-sub" style="color:rgba(255,255,255,0.7)">Expenses</div>
                            <div class="text-lg bold privacy-blur">${formatMoney(totalExp)}</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center">
                        <div class="text-lg bold">Monthly Budget</div>
                        <div class="text-sm text-sub">${formatMoney(thisMonthExp)} / ${formatMoney(monthlyBudget)}</div>
                    </div>
                    <div class="budget-bar">
                        <div class="budget-fill" style="width:${budgetPct}%; background:${budgetColor}"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="text-lg bold">Spending Breakdown</div>
                    <div class="chart-container" id="chartContainer">
                        <!-- Chart Injected Here -->
                    </div>
                </div>

                <div class="flex justify-between items-center" style="margin-bottom:12px; margin-top:8px;">
                    <div class="text-lg bold">Recent</div>
                    <button class="btn-ghost btn-sm" onclick="switchView('transactions')">View All</button>
                </div>
                <div id="recentTxList"></div>
            `;
            
            document.getElementById('mainContainer').innerHTML = html;
            renderChart();
            renderTxList(transactions.slice().sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5), 'recentTxList');
        }

        function renderTransactionsView() {
            const html = `
                <div class="input-group">
                    <input type="text" id="searchTx" class="input" placeholder="üîç Search transactions..." onkeyup="filterTransactions()">
                </div>
                <div id="fullTxList"></div>
            `;
            document.getElementById('mainContainer').innerHTML = html;
            renderTxList(transactions.slice().sort((a,b) => new Date(b.date) - new Date(a.date)), 'fullTxList');
        }

        function renderAccountsView() {
            // Simplified Accounts View
            const html = `
                <div class="card">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-lg bold">Cash Wallet</div>
                            <div class="text-sm text-sub">Default Account</div>
                        </div>
                        <div class="text-xl bold privacy-blur">${formatMoney(calculateBalance())}</div>
                    </div>
                </div>
                <div class="card" style="border-style:dashed; display:flex; align-items:center; justify-content:center; padding:30px; color:var(--text-sub);">
                    <span>+ Add New Wallet (Pro Feature)</span>
                </div>
            `;
            document.getElementById('mainContainer').innerHTML = html;
        }

        function renderSettingsView() {
            const html = `
                <div class="card">
                    <h3 class="text-lg bold" style="margin-bottom:16px;">Preferences</h3>
                    <div class="input-group">
                        <label class="label">Monthly Budget Goal</label>
                        <input type="number" class="input" value="${monthlyBudget}" onchange="updateBudget(this.value)">
                    </div>
                    <div class="input-group">
                        <label class="label">Currency Symbol</label>
                        <input type="text" class="input" value="${currency}" onchange="updateCurrency(this.value)" style="width:60px;">
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-lg bold" style="margin-bottom:16px;">Data Management</h3>
                    <button class="btn btn-outline w-full" onclick="exportData()" style="margin-bottom:12px;">üì• Export JSON</button>
                    <button class="btn btn-outline w-full" onclick="exportCSV()" style="margin-bottom:12px;">üìä Export CSV</button>
                    <button class="btn btn-danger w-full" onclick="clearData()">üóëÔ∏è Reset All Data</button>
                </div>

                <div class="text-center text-sub text-xs" style="margin-top:20px;">
                    My Finance Pro v1.2<br>Offline-First & Secure
                </div>
            `;
            document.getElementById('mainContainer').innerHTML = html;
        }

        // --- Components Renderers ---

        function renderTxList(list, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (list.length === 0) {
                container.innerHTML = `<div class="text-center text-sub" style="padding:20px;">No transactions found.</div>`;
                return;
            }

            container.innerHTML = list.map(t => {
                const isExp = t.type === 'exp';
                return `
                <div class="tx-item animate-enter" onclick="openModal('edit', ${t.id})">
                    <div class="tx-icon">
                        ${t.category.split(' ')[0] || 'üìÑ'}
                    </div>
                    <div class="tx-details">
                        <div class="text-base bold">${t.desc}</div>
                        <div class="text-xs text-sub">${t.category} ‚Ä¢ ${formatDate(t.date)}</div>
                    </div>
                    <div class="tx-amount ${isExp ? 'text-red' : 'text-green'} privacy-blur">
                        ${isExp ? '-' : '+'}${formatMoney(t.amount)}
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderChart() {
            const container = document.getElementById('chartContainer');
            if (!container) return;

            // Group by category
            const cats = {};
            let total = 0;
            transactions.filter(t => t.type === 'exp').forEach(t => {
                const c = t.category;
                cats[c] = (cats[c] || 0) + t.amount;
                total += t.amount;
            });

            if (total === 0) {
                container.innerHTML = `<div class="text-sub text-sm">No expenses to display.</div>`;
                return;
            }

            // Colors
            const colors = ['#6366f1', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'];
            let gradientStr = '';
            let currentDeg = 0;
            let legendHtml = '';

            Object.entries(cats).sort((a,b) => b[1] - a[1]).forEach(([name, val], index) => {
                const pct = (val / total) * 100;
                const deg = (pct / 100) * 360;
                const color = colors[index % colors.length];
                
                gradientStr += `${color} ${currentDeg}deg ${currentDeg + deg}deg, `;
                currentDeg += deg;

                legendHtml += `
                    <div class="legend-item">
                        <div class="legend-color" style="background:${color}"></div>
                        <div class="flex justify-between w-full">
                            <span>${name.split(' ')[1] || name}</span>
                            <span class="text-sub privacy-blur">${Math.round(pct)}%</span>
                        </div>
                    </div>
                `;
            });

            gradientStr = gradientStr.slice(0, -2); // remove last comma

            container.innerHTML = `
                <div class="donut-chart" style="background: conic-gradient(${gradientStr})">
                    <div class="donut-hole">
                        <span class="text-xs text-sub">Expense</span>
                        <span class="text-lg bold privacy-blur">${formatMoney(total)}</span>
                    </div>
                </div>
                <div class="chart-legend">
                    ${legendHtml}
                </div>
            `;
        }

        function renderCategories() {
            const dl = document.getElementById('catList');
            dl.innerHTML = categories.map(c => `<option value="${c}">`).join('');
        }

        // --- Logic & Actions ---

        function setTxType(type) {
            txType = type;
            document.getElementById('btn-exp').style.background = type === 'exp' ? 'var(--danger)' : 'transparent';
            document.getElementById('btn-exp').style.color = type === 'exp' ? 'white' : 'var(--text-sub)';
            
            document.getElementById('btn-inc').style.background = type === 'inc' ? 'var(--success)' : 'transparent';
            document.getElementById('btn-inc').style.color = type === 'inc' ? 'white' : 'var(--text-sub)';
        }

        function openModal(mode, id = null) {
            const modal = document.getElementById('txModal');
            const title = document.getElementById('modalTitle');
            const btnDel = document.getElementById('btnDelete');
            const hiddenId = document.getElementById('txId');

            // Reset Fields
            document.getElementById('txAmount').value = '';
            document.getElementById('txDesc').value = '';
            document.getElementById('txCat').value = '';
            initDateInput();
            setTxType('exp');

            if (mode === 'edit' && id) {
                const t = transactions.find(x => x.id === id);
                if (t) {
                    title.innerText = 'Edit Transaction';
                    hiddenId.value = t.id;
                    document.getElementById('txAmount').value = t.amount;
                    document.getElementById('txDate').value = t.date;
                    document.getElementById('txDesc').value = t.desc;
                    document.getElementById('txCat').value = t.category;
                    setTxType(t.type);
                    btnDel.classList.remove('hidden');
                }
            } else {
                title.innerText = 'New Transaction';
                hiddenId.value = '';
                btnDel.classList.add('hidden');
            }

            modal.classList.add('open');
        }

        function closeModal() {
            document.getElementById('txModal').classList.remove('open');
        }

        function saveTx() {
            const id = document.getElementById('txId').value;
            const amt = parseFloat(document.getElementById('txAmount').value);
            const date = document.getElementById('txDate').value;
            const desc = document.getElementById('txDesc').value;
            let cat = document.getElementById('txCat').value;

            if (!amt || !desc || !date) {
                alert("Please fill in all fields");
                return;
            }

            if (!cat) cat = 'üìÇ Uncategorized';

            // Add emoji if missing and known
            if (!cat.match(/[\p{Emoji}]/u)) {
               // Simple heuristic
               if(cat.toLowerCase().includes('food')) cat = 'üçî ' + cat;
               else if(cat.toLowerCase().includes('shop')) cat = 'üõçÔ∏è ' + cat;
               else cat = 'üìÑ ' + cat;
            }

            if (id) {
                // Edit
                const idx = transactions.findIndex(t => t.id == id);
                if (idx > -1) {
                    transactions[idx] = { id: parseInt(id), amount: amt, type: txType, desc, category: cat, date };
                }
            } else {
                // Add
                const newId = Date.now();
                transactions.push({ id: newId, amount: amt, type: txType, desc, category: cat, date });
            }

            saveData();
            closeModal();
            updateUI(); // Refresh view
        }

        function deleteTxClick() {
            const id = document.getElementById('txId').value;
            if (confirm('Are you sure you want to delete this?')) {
                transactions = transactions.filter(t => t.id != id);
                saveData();
                closeModal();
                updateUI();
            }
        }

        function filterTransactions() {
            const query = document.getElementById('searchTx').value.toLowerCase();
            const filtered = transactions.filter(t => 
                t.desc.toLowerCase().includes(query) || 
                t.category.toLowerCase().includes(query) ||
                t.amount.toString().includes(query)
            ).sort((a,b) => new Date(b.date) - new Date(a.date));
            renderTxList(filtered, 'fullTxList');
        }

        function updateBudget(val) {
            monthlyBudget = parseFloat(val);
            saveData();
        }
        
        function updateCurrency(val) {
            currency = val;
            updateUI();
        }

        function togglePrivacy() {
            document.body.classList.toggle('privacy-mode');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeBtn').innerText = isDark ? 'üåô' : 'üåû';
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "my_finance_backup.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function exportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,Date,Description,Category,Type,Amount\n";
            transactions.forEach(t => {
                const row = `${t.date},"${t.desc}","${t.category}",${t.type},${t.amount}`;
                csvContent += row + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "my_finance_export.csv");
            document.body.appendChild(link);
            link.click();
        }

        function clearData() {
            if(confirm("DANGER: This will delete ALL your transaction data permanently. Are you sure?")) {
                transactions = [];
                saveData();
                updateUI();
            }
        }

        // --- Helpers ---
        function calculateBalance() {
            return transactions.reduce((sum, t) => t.type === 'inc' ? sum + t.amount : sum - t.amount, 0);
        }

        function formatMoney(amount) {
            return currency + amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            const options = { month: 'short', day: 'numeric' };
            return new Date(dateStr).toLocaleDateString(undefined, options);
        }

        function initDateInput() {
            document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
        }

    </script>
</body>
</html>

