<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساباتي</title>
<meta name="theme-color" content="#0b1220" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220;
  --card:#0f172a;
  --muted:#94a3b8;
  --txt:#e5e7eb;
  --brand:#0369a1;
  --brand-2:#0ea5e9;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#22c55e;
  --border:#1f2a44;
  --radius:12px;
  --field-h:42px;
  --shadow:0 8px 24px rgba(2,6,23,0.5);
}

/* خطوط */
body,h1,h2,h3,h4,h5,h6,p,div,span,li,a,button{font-family:"Cairo",sans-serif !important;}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 100% -10%, rgba(14,165,233,.10), transparent 70%),
    radial-gradient(900px 500px at -10% 100%, rgba(3,105,161,.12), transparent 70%),
    var(--bg);
  color:var(--txt)
}
.container{max-width:1180px;margin-inline:auto;padding:20px}

/* Cards */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:0; overflow:hidden; box-shadow:var(--shadow);
}
.card-head{
  display:flex;align-items:center;justify-content:space-between;padding:12px 14px;
  background:linear-gradient(135deg, rgba(3,105,161,.55), rgba(14,165,233,.12));
  border-bottom:1px solid var(--border);
}
.card-head h3{margin:0;font-size:18px;color:#e2e8f0}
.card-body{padding:14px}
.card.collapsed .card-body{display:none}
.toggle{appearance:none;border:none;background:transparent;cursor:pointer;border-radius:10px;font-size:18px;padding:6px 10px;color:#cbd5e1}

/* Layout */
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,textarea{
  width:100%;background:#0b1220;color:var(--txt);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none;height:var(--field-h)
}
input[type="date"],input[type="month"]{direction:ltr;text-align:center;font-variant-numeric:tabular-nums}
.checkbox-row{display:flex;align-items:center;gap:8px}
.checkbox-row input[type="checkbox"]{width:18px;height:18px}

/* Buttons */
.btn{
  appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer;
  transition:transform .06s ease, opacity .15s,height .08s ease;font-size:13px;height:36px;
}
.btn:hover{opacity:.95;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid rgba(115,140,165,0.12);color:#9fb3c8;padding:8px 10px}
.btn-primary{background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff;border:1px solid rgba(14,165,233,.35)}
.btn-danger{background:linear-gradient(180deg,#ef4444,#d02626);color:#fff;border:1px solid rgba(235,75,75,0.15)}
.btn-muted{background:transparent;color:var(--muted);border:1px dashed var(--border);padding:8px 10px}

/* action buttons داخل الجداول — حجم أصغر */
.actions .btn{height:30px;padding:6px 8px;font-size:13px;border-radius:8px}
.actions .btn-outline{border-color:rgba(115,140,165,0.12);color:#cbe6fb}
.actions .btn-primary{background:linear-gradient(135deg,#3ec9ff,#0b84b8);color:#021826}
.actions .btn-danger{background:#ff5a69;color:#fff}

/* Stats (ملخص الحسابات) */
.stats{display:grid;gap:10px}
@media(min-width:720px){.stats{grid-template-columns:repeat(6,1fr)}}
.stat{
  background:#0b162a;border:1px solid var(--border);border-radius:var(--radius);padding:14px; text-align:center;
  box-shadow:var(--shadow)
}
.stat small{color:#9fb3c8}
.stat .num{font-weight:800;font-size:22px;margin-top:4px;color:#e5edf5}
.pos{color:#34d399}.neg{color:#fb7185}

/* perAccount */
.list-plain{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.list-plain .item{
  background:#0b162a;border:1px solid var(--border);padding:14px;border-radius:var(--radius);
  text-align:center;box-shadow:var(--shadow);font-weight:700;color:#e5edf5
}

/* Reports & Tables */
.report-table-wrap{overflow:auto;max-height:340px}
#tbodyMonthly tr.active{background:rgba(14,165,233,0.18);box-shadow:0 0 0 1px rgba(14,165,233,0.35)}
.month-insights{margin-top:18px;display:grid;gap:16px}
.month-stats{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.month-stats .stat{background:#0b162a}
.month-selected{font-weight:700;font-size:18px;margin-top:6px}
.month-note{color:var(--muted);font-size:12px}
.month-cats{gap:16px}
.month-cats h4{margin:0 0 10px;font-size:15px;color:#9fb3c8}
.bar-list{display:flex;flex-direction:column;gap:10px}
.bar-item{display:grid;gap:6px}
.bar-item .label{font-size:13px;font-weight:800;color:#e2f1fb}
.bar-item .bar-track{background:#071025;border-radius:999px;height:26px;position:relative;overflow:hidden;border:1px solid rgba(14,165,233,0.06)}
.bar-item .bar-fill{position:absolute;left:0;top:0;bottom:0;width:var(--w,0%);border-radius:999px;display:flex;align-items:center;justify-content:flex-end;padding-inline:12px;font-weight:900;color:#fff;font-size:13px;transition:width .3s ease}
.bar-item .bar-fill.expense{background:linear-gradient(90deg,#fb7185,#ef4444)}
.bar-item .bar-fill.income{background:linear-gradient(90deg,#34d399,#22c55e)}
.bar-item .value{font-size:12px;color:#9fb3c8}
.empty-state{padding:12px;border:1px dashed var(--border);border-radius:var(--radius);text-align:center;font-size:13px;color:#9fb3c8}
.report-legend{display:flex;gap:12px;font-size:12px;color:#9fb3c8;align-items:center;flex-wrap:wrap;margin-top:8px}
.legend-dot{width:12px;height:12px;border-radius:999px;display:inline-block}

table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:#9fb3c8;font-weight:600;text-align:right;padding:6px 10px}
tbody tr{background:linear-gradient(180deg,#071226,#0b162a);border:1px solid rgba(255,255,255,0.02);border-radius:10px;transition:transform .08s ease, box-shadow .08s ease}
tbody tr:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(2,6,23,0.6)}
tbody td{padding:12px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);color:#e2f1fb}
tbody tr td:first-child{border-right:1px solid var(--border);border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
tbody tr td:last-child{border-left:1px solid var(--border);border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
.amount.exp{color:#ff9aa0;font-weight:900}.amount.inc{color:#7ef0b8;font-weight:900}

.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.spacer{flex:1}
.badge{display:inline-flex;gap:6px;align-items:center;background:#071225;color:#9fb3c8;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:var(--field-h)}
.badge-group{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
.footer{margin-top:24px;color:#9fb3c8;font-size:12px;text-align:center}
.note{color:var(--warn)}
canvas{background:#0b162a;border:1px solid var(--border);border-radius:var(--radius);display:block;width:100%;height:320px}
.hr{height:1px;background:var(--border);opacity:.7;margin:12px 0;border-radius:999px}

/* تحويل */
.transfer-grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
.transfer-grid .full{grid-column:1/-1}
@media(max-width:900px){.transfer-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:720px){
  .grid-2{grid-template-columns:1fr}
  .grid-4{grid-template-columns:1fr 1fr}
  .badge{height:auto}
  .card-head h3{font-size:17px}
  .transfer-grid{grid-template-columns:1fr}
}

/* استحقاقات قريبة */
.d-none{display:none!important;}
#dueSoonWrap{overflow:auto;-webkit-overflow-scrolling:touch;}
#dueSoonWrap table{min-width:760px;}
#dueSoonCards{display:none;}
@media(max-width:720px){
  #dueSoonWrap{display:none;}
  #dueSoonCards{display:block;}
  .month-stats{grid-template-columns:1fr 1fr;}
  .month-cats{grid-template-columns:1fr;}
  .report-table-wrap{max-height:none;}
}
/* بطاقات موبايل */
.due-card{background:#0b162a;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;display:grid;gap:6px}
.due-card .row{display:flex;justify-content:space-between;gap:8px}
.due-card .name{font-weight:900;color:#e2e8f0}
.due-card .remain{font-weight:900;color:#e2e8f0}
.due-card .state{color:var(--warn);font-weight:800}
.due-card .state.over{color:var(--danger)}
.due-card .meta{color:#9fb3c8;font-size:12px}
.due-card .actions{display:flex;gap:8px}

/* pager */
.pager{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
.pager .info{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <div class="title" style="font-weight:900;font-size:22px;color:#e2f1fb">دفتر حساباتي</div>
    </div>
    <div class="toolbar" style="margin-top:10px">
      <button id="exportJson" class="btn btn-outline" type="button">تصدير JSON</button>
      <button id="exportCsv" class="btn btn-outline" type="button">تصدير CSV</button>
      <label class="btn btn-muted" for="importFile">استيراد JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
      <button id="syncNow" class="btn btn-outline" type="button">مزامنة الآن</button>
      <button id="installBtn" class="btn btn-outline" type="button" style="display:none">تثبيت التطبيق</button>
    </div>
  </header>

  <section class="card" id="card-balance" data-lock="true" style="margin-top:12px">
    <div class="card-head"><h3>ملخص الحسابات</h3></div>
    <div class="card-body">
      <div class="stats">
        <div class="stat"><small>إجمالي الأرصدة</small><div id="totalBalance" class="num">0</div></div>
        <div class="stat"><small>إجمالي التزامات الشهر الحالي</small><div id="monthCommitTotal" class="num neg">0</div></div>
        <div class="stat"><small>إجمالي مبالغ تحت التحصيل (الشهر الحالي)</small><div id="currentMonthCollections" class="num pos">0</div></div>
        <div class="stat"><small>الرصيد بعد خصم الالتزامات الحالية</small><div id="balanceAfterCommitments" class="num">0</div></div>
        <div class="stat"><small>التزامات الشهر القادم (شامل متبقي الحالي)</small><div id="nextCommitWithCarry" class="num neg">0</div></div>
        <div class="stat"><small>إجمالي مبالغ تحت التحصيل الشهر القادم</small><div id="nextMonthCollections" class="num pos">0</div></div>
      </div>

      <div class="hr"></div>

      <div>
        <h3 style="margin:0 0 8px;font-size:14px;color:var(--muted)">تفاصيل الأرصدة بالحساب</h3>
        <div id="perAccount" class="list-plain"></div>
      </div>
    </div>
  </section>

  <section class="card" id="card-dueSoon" style="margin-top:12px">
    <div class="card-head">
      <h3>استحقاقات قريبة</h3>
      <div class="badge-group">
        <span id="dueTotalBadge" class="badge" title="إجمالي المتبقّي لهذا الشهر">إجمالي: 0.00 ج.م</span>
        <span id="dueNextTotalBadge" class="badge" title="إجمالي الاستحقاقات للشهر القادم">الشهر القادم: 0.00 ج.م</span>
      </div>
    </div>
    <div class="card-body">
      <div id="dueSoonWrap">
        <table style="width:100%">
          <thead><tr><th>الاسم</th><th>التاريخ</th><th>الأصل</th><th>المدفوع</th><th>المتبقي</th><th>الحالة</th><th>إجراءات</th></tr></thead>
          <tbody id="tbodyDueSoon"></tbody>
        </table>
      </div>
      <div id="dueSoonCards"></div>
      <div id="noDueSoon" class="d-none" style="color:var(--muted)">لا توجد استحقاقات هذا الشهر غير مسددة.</div>
    </div>
  </section>

  <div class="hr"></div>

  <div class="grid grid-2">
    <section class="card collapsed" id="card-accounts" data-collapsible>
      <div class="card-head"><h3>إدارة الحسابات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
      <div class="card-body">
        <div class="grid grid-3">
          <div><label>اسم الحساب</label><input id="newAccountName" placeholder="مثال: كاش/محفظة" /></div>
          <div><label>رصيد افتتاحي</label><input id="newAccountOpening" type="number" step="0.01" placeholder="0.00" /></div>
          <div><label>&nbsp;</label><button id="addAccount" class="btn btn-outline" style="width:100%">إضافة حساب</button></div>
        </div>
        <div id="accountsList" class="toolbar" style="margin-top:8px;flex-wrap:wrap"></div>
      </div>
    </section>

    <section class="card collapsed" id="card-cats" data-collapsible>
      <div class="card-head"><h3>إدارة الفئات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
      <div class="card-body">
        <div class="grid grid-3">
          <div><label>اسم الفئة</label><input id="newCatName" placeholder="مثال: أكل" /></div>
          <div><label>النوع</label><select id="newCatType"><option value="expense" selected>مصروف</option><option value="income">دخل</option></select></div>
          <div><label>&nbsp;</label><button id="addCategory" class="btn btn-outline" style="width:100%">إضافة فئة</button></div>
        </div>
        <div id="catsList" class="toolbar" style="margin-top:8px;flex-wrap:wrap"></div>
      </div>
    </section>
  </div>

  <div class="hr"></div>

  <section class="card collapsed" id="card-transfer" data-collapsible>
    <div class="card-head"><h3>تحويل بين الحسابات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="transfer-grid">
        <div><label>من حساب</label><select id="trFrom"></select></div>
        <div><label>إلى حساب</label><select id="trTo"></select></div>
        <div><label>المبلغ (ج.م)</label><input id="trAmount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>عمولة التحويل (اختياري)</label><input id="trFee" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>التاريخ</label><input id="trDate" type="date" /></div>
        <div><label>ملاحظة</label><input id="trDesc" type="text" placeholder="مثال: تحويل لمحفظة"/></div>
        <div class="full" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <button id="execTransfer" class="btn btn-primary">تنفيذ التحويل</button>
          <button id="resetTransfer" class="btn btn-outline">إفراغ</button>
        </div>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">ملاحظة: التحويلات لا تُحسب ضمن إجمالي الدخل/المصروف، لكن العمولة تُحسب كمصروف.</div>
    </div>
  </section>

  <div class="hr"></div>

  <section class="card collapsed" id="card-addtx" data-collapsible>
    <div class="card-head"><h3>إضافة حركة</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="grid grid-3">
        <div><label>النوع</label><select id="type"><option value="income">دخل</option><option value="expense" selected>مصروف</option></select></div>
        <div><label>المبلغ (ج.م)</label><input id="amount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>التاريخ</label><input id="date" type="date" /></div>
        <div><label>الوصف</label><input id="desc" type="text" placeholder="مثال: سوبر ماركت" /></div>
        <div><label>الحساب</label><select id="account"></select></div>
        <div><label>الفئة</label><select id="category"></select></div>
        <div><label>ربط الالتزام (اختياري لمصروفات)</label><select id="linkCommit"></select></div>
        <div class="grid grid-2" style="grid-column:1/-1">
          <button id="saveTx" class="btn btn-primary">حفظ</button>
          <button id="resetForm" class="btn btn-outline">إفراغ</button>
        </div>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <section class="card collapsed" id="card-txs" data-collapsible>
    <div class="card-head"><h3>الحركات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="toolbar" style="margin-bottom:8px">
        <input id="search" placeholder="بحث بالوصف" style="max-width:220px"/>
        <select id="fType" style="max-width:150px"><option value="all" selected>الكل</option><option value="income">دخل فقط</option><option value="expense">مصروف فقط</option></select>
        <select id="fAccount" style="max-width:180px"></select>
        <input id="fFrom" type="date" />
        <input id="fTo" type="date" />
        <button id="clearFilters" class="btn btn-outline">مسح الفلاتر</button>
        <span class="spacer"></span>
        <span class="badge">العملة: ج.م</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>التاريخ</th><th>الوصف</th><th>الفئة</th><th>الحساب</th><th>المبلغ</th><th>رصيد الحساب بعد العملية</th><th>إجراءات</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="pager" id="txPager" style="display:none">
        <button id="txPrev" class="btn btn-outline" type="button">السابق</button>
        <div class="info" id="txPagerInfo">صفحة 1 / 1</div>
        <button id="txNext" class="btn btn-outline" type="button">التالي</button>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <section class="card collapsed" id="card-commit" data-collapsible>
    <div class="card-head"><h3>الالتزامات الشهرية</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="grid grid-4">
        <div><label>اسم الالتزام</label><input id="cName" placeholder="مثال: إيجار، إنترنت" /></div>
        <div><label>المبلغ (ج.م)</label><input id="cAmount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>تاريخ أول استحقاق</label><input id="cFirstDue" type="date" required /></div>
        <div class="checkbox-row"><input id="cRecurring" type="checkbox" /><label for="cRecurring" style="margin:0">يتكرر شهريًا</label></div>
        <div style="grid-column:1/span 2"><label>ينتهي في (إجباري عند التكرار)</label><input id="cEndAt" type="date" /></div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button id="addCommitment" class="btn btn-outline">إضافة/تحديث</button>
        <span class="spacer"></span><span class="badge">يمكن السداد جزئيًا من "إضافة حركة"</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr>
            <th>الاسم</th><th>المبلغ</th><th>استحقاق</th><th>مدفوع (الشهر)</th><th>متبقّي</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th>
          </tr></thead>
          <tbody id="tbodyCommit"></tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <section class="card collapsed" id="card-collect" data-collapsible>
    <div class="card-head"><h3>مبالغ تحت التحصيل</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="grid grid-4">
        <div><label>اسم التحصيل</label><input id="coName" placeholder="مثال: إيجار مستلم، مبيعات آجل" /></div>
        <div><label>المبلغ (ج.م)</label><input id="coAmount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>تاريخ أول استحقاق</label><input id="coFirstDue" type="date" required /></div>
        <div class="checkbox-row"><input id="coRecurring" type="checkbox" /><label for="coRecurring" style="margin:0">يتكرر شهريًا</label></div>
        <div style="grid-column:1/span 2"><label>ينتهي في (إجباري عند التكرار)</label><input id="coEndAt" type="date" /></div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button id="addCollect" class="btn btn-outline">إضافة/تحديث</button>
        <span class="spacer"></span><span class="badge">لا يظهر في الحركات إلا بعد "تم التحصيل"</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>الاسم</th><th>المبلغ</th><th>التحصيل القادم</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th></tr></thead>
          <tbody id="tbodyCollect"></tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <section class="card collapsed" id="card-reports" data-collapsible>
    <div class="card-head"><h3>تقارير شهرية و رسوم بيانية</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="toolbar" style="margin-bottom:8px">
        <input id="monthPicker" type="month" />
        <button id="refreshReports" class="btn btn-outline">تحديث</button>
        <span class="spacer"></span><span class="badge">إجمالي الدخل/المصروف لكل شهر</span>
      </div>
      <div class="grid grid-2">
        <div>
          <canvas id="chartMonthly" width="560" height="320" aria-label="Monthly chart"></canvas>
          <div class="report-legend">
            <span><span class="legend-dot" style="background:#22c55e"></span> دخل</span>
            <span><span class="legend-dot" style="background:#ef4444"></span> مصروف</span>
            <span><span class="legend-dot" style="background:transparent;border:2px solid #0ea5e9"></span> صافي</span>
            <span style="margin-inline-start:auto;font-size:11px">القيم مقيّسة وفق أكبر شهر</span>
          </div>
        </div>
        <div class="report-table-wrap">
          <table>
            <thead><tr><th>الشهر</th><th>إجمالي الدخل</th><th>إجمالي المصروف</th><th>الصافي</th></tr></thead>
            <tbody id="tbodyMonthly"></tbody>
          </table>
        </div>
      </div>

      <div class="month-insights">
        <div class="stats month-stats">
          <div class="stat"><small>الشهر المحدد</small><div id="monthSelectedLabel" class="month-selected">—</div></div>
          <div class="stat"><small>إجمالي الدخل</small><div id="monthStatIncome" class="num pos">0.00</div></div>
          <div class="stat"><small>إجمالي المصروف</small><div id="monthStatExpense" class="num neg">0.00</div></div>
          <div class="stat"><small>الصافي</small><div id="monthStatNet" class="num">0.00</div></div>
          <div class="stat"><small>عدد الحركات</small><div id="monthStatTx" class="num">0</div></div>
          <div class="stat"><small>متوسط الصرف اليومي</small><div id="monthStatAvg" class="num">0.00</div></div>
        </div>
        <div id="monthNoData" class="empty-state d-none">لا توجد بيانات للشهر المحدد حتى الآن.</div>
        <div class="month-note">يتم تجاهل التحويلات الداخلية والرسوم المرتبطة بها من حساب الدخل/المصروف.</div>
        <div class="grid grid-2 month-cats">
          <div><h4>أعلى المصروفات حسب الفئة</h4><div id="monthCatsExpense" class="bar-list"></div></div>
          <div><h4>أهم مصادر الدخل</h4><div id="monthCatsIncome" class="bar-list"></div></div>
        </div>
      </div>
    </div>
  </section>

  <section class="card collapsed" id="card-github" data-collapsible>
    <div class="card-head"><h3>إعدادات مزامنة GitHub</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="grid grid-4">
        <div><label>اسم المستخدم</label><input id="ghUser" placeholder="مثال: username" /></div>
        <div><label>المستودع</label><input id="ghRepo" placeholder="مثال: Finance2025" /></div>
        <div><label>الفرع</label><input id="ghBranch" value="main" /></div>
        <div><label>مسار الملف (JSON)</label><input id="ghPath" value="my-finance.json" /></div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <div><label>Personal Access Token</label><input id="ghToken" type="password" placeholder="ghp_..." /></div>
        <div class="checkbox-row" style="margin-top:22px"><input id="ghAuto" type="checkbox"/><label for="ghAuto" style="margin:0">مزامنة تلقائيًا بعد كل تعديل</label></div>
        <div class="grid grid-2" style="margin-top:22px">
          <button id="ghSaveCfg" class="btn btn-outline">حفظ الإعدادات</button>
          <button id="ghTest" class="btn btn-outline">اختبار الاتصال</button>
        </div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <button id="ghPull" class="btn btn-outline">تحميل من GitHub</button>
        <button id="ghPush" class="btn btn-primary">رفع إلى GitHub</button>
        <span id="ghStatus" class="badge">الحالة: غير متصل</span>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">⚠️ الـ Token محفوظ محليًا في جهازك فقط.</div>
    </div>
  </section>

  <div class="footer">
    <div>⚠️ <span class="note">تنبيه:</span> كل البيانات محفوظة محليًا في <code>localStorage</code>. لا تنسَ التصدير كنسخة احتياطية.</div>
    <div style="margin-top:6px">تقدر تثبّت الموقع كتطبيق لأنه PWA.</div>
  </div>
</div>

<script>
/* ===== مفاتيح التخزين ===== */
const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1',
      COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1', GH_KEY='pf_github_cfg_v1';

/* ===== الحالة ===== */
let ledger=JSON.parse(localStorage.getItem(KEY)||'[]');
let accounts=JSON.parse(localStorage.getItem(ACC_KEY)||'[]');
let categories=JSON.parse(localStorage.getItem(CAT_KEY)||'[]');
let commitments=JSON.parse(localStorage.getItem(COM_KEY)||'[]');  // {payments:{'YYYY-MM':number}}
let collections=JSON.parse(localStorage.getItem(COL_KEY)||'[]');
let ghCfg=JSON.parse(localStorage.getItem(GH_KEY)||'{}');

/* افتراضات أولية */
function ensureBaseCategories(){
  const need=[
    {name:'التزامات شهرية',type:'expense'},
    {name:'تحصيلات شهرية',type:'income'},
    {name:'تحويل صادر',type:'expense'},
    {name:'تحويل وارد',type:'income'},
    {name:'عمولة تحويل',type:'expense'},
  ];
  let changed=false;
  if(categories.length===0){
    categories=[
      {name:'مرتب',type:'income'},{name:'دخل آخر',type:'income'},
      {name:'أكل وشرب',type:'expense'},{name:'مواصلات',type:'expense'},{name:'فواتير',type:'expense'},{name:'تسوق',type:'expense'}
    ];
    changed=true;
  }
  for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } }
  if(changed) saveCategories();
}

/* DOM */
const $=s=>document.querySelector(s);
const els={
  totalBalance:$('#totalBalance'),
  monthCommitTotal:$('#monthCommitTotal'),
  currentMonthCollections:$('#currentMonthCollections'),
  balanceAfterCommitments:$('#balanceAfterCommitments'),
  nextCommitWithCarry:$('#nextCommitWithCarry'),
  nextMonthCollections:$('#nextMonthCollections'),
  perAccount:$('#perAccount'),

  tbody:$('#tbody'), type:$('#type'), amount:$('#amount'), date:$('#date'), desc:$('#desc'),
  account:$('#account'), category:$('#category'), linkCommit:$('#linkCommit'),
  saveTx:$('#saveTx'), resetForm:$('#resetForm'), search:$('#search'),

  exportJson:$('#exportJson'), exportCsv:$('#exportCsv'), importFile:$('#importFile'), syncNow:$('#syncNow'),

  newAccountName:$('#newAccountName'), newAccountOpening:$('#newAccountOpening'), addAccount:$('#addAccount'), accountsList:$('#accountsList'),

  newCatName:$('#newCatName'), newCatType:$('#newCatType'), addCategory:$('#addCategory'), catsList:$('#catsList'),

  monthPicker:$('#monthPicker'), refreshReports:$('#refreshReports'), tbodyMonthly:$('#tbodyMonthly'), chartMonthly:$('#chartMonthly'),
  monthSelectedLabel:$('#monthSelectedLabel'), monthStatIncome:$('#monthStatIncome'), monthStatExpense:$('#monthStatExpense'),
  monthStatNet:$('#monthStatNet'), monthStatTx:$('#monthStatTx'), monthStatAvg:$('#monthStatAvg'), monthNoData:$('#monthNoData'),
  monthCatsExpense:$('#monthCatsExpense'), monthCatsIncome:$('#monthCatsIncome'),

  /* التزامات */
  cName:$('#cName'), cAmount:$('#cAmount'), cFirstDue:$('#cFirstDue'), cRecurring:$('#cRecurring'), cEndAt:$('#cEndAt'),
  addCommitment:$('#addCommitment'), tbodyCommit:$('#tbodyCommit'),

  /* تحصيل */
  coName:$('#coName'), coAmount:$('#coAmount'), coFirstDue:$('#coFirstDue'), coRecurring:$('#coRecurring'), coEndAt:$('#coEndAt'),
  addCollect:$('#addCollect'), tbodyCollect:$('#tbodyCollect'),

  /* PWA & تحويل */
  installBtn:$('#installBtn'),
  trFrom:$('#trFrom'), trTo:$('#trTo'), trAmount:$('#trAmount'), trFee:$('#trFee'), trDate:$('#trDate'), trDesc:$('#trDesc'),
  execTransfer:$('#execTransfer'), resetTransfer:$('#resetTransfer'),

  /* GitHub */
  ghUser:$('#ghUser'), ghRepo:$('#ghRepo'), ghBranch:$('#ghBranch'), ghPath:$('#ghPath'), ghToken:$('#ghToken'),
  ghAuto:$('#ghAuto'), ghSaveCfg:$('#ghSaveCfg'), ghTest:$('#ghTest'), ghPull:$('#ghPull'), ghPush:$('#ghPush'), ghStatus:$('#ghStatus'),

  /* إجمالي الاستحقاقات + كروت الموبايل */
  dueTotalBadge:$('#dueTotalBadge'), dueNextTotalBadge:$('#dueNextTotalBadge'), dueSoonCards:$('#dueSoonCards')
};
['saveTx','resetForm','addAccount','addCategory','exportJson','exportCsv','refreshReports','addCommitment','addCollect','execTransfer','resetTransfer','syncNow','ghSaveCfg','ghTest','ghPull','ghPush']
  .forEach(id=>document.getElementById(id)?.setAttribute('type','button'));

/* Utils */
const eid=()=>Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const fmt=n=>Number(n).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const escapeHtml=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
const YM=()=>new Date().toISOString().slice(0,7);
const parseLocalDate=d=>d?new Date(d+'T00:00:00'):new Date(NaN);
const formatLocalDate=d=>d.toISOString().slice(0,10);
const startOfToday=()=>parseLocalDate(formatLocalDate(new Date()));
const daysBetween=(d1,d2)=>Math.round((d2-d1)/(1000*60*60*24));
const monthLabel=ym=>{
  if(!ym||ym.length!==7) return '—';
  const [y,m]=ym.split('-').map(Number);
  const d=new Date(y,m-1,1);
  return d.toLocaleString('ar-EG',{year:'numeric',month:'long'});
}

function addMonthsPreserveDOM(date, months){
  const d=date.getDate();
  date.setMonth(date.getMonth()+months);
  if(date.getDate() !== d) date.setDate(0); // If month changed due to short month, go to last day of previous month
  return date;
}
function addMonthsToYm(ym, months){
  const [y,m]=ym.split('-').map(Number);
  const d=new Date(y,m-1,1);
  d.setMonth(d.getMonth()+months);
  return d.toISOString().slice(0,7);
}

/* التخزين */
function saveLedger(){localStorage.setItem(KEY,JSON.stringify(ledger)); render(); ghCfg.auto && ghPush(); }
function saveAccounts(){localStorage.setItem(ACC_KEY,JSON.stringify(accounts));}
function saveCategories(){localStorage.setItem(CAT_KEY,JSON.stringify(categories));}
function saveCommitments(){localStorage.setItem(COM_KEY,JSON.stringify(commitments));}
function saveCollections(){localStorage.setItem(COL_KEY,JSON.stringify(collections));}
function saveGhCfg(){localStorage.setItem(GH_KEY,JSON.stringify(ghCfg));}

/* ===== إدارة الحسابات ===== */
function buildAccountOptions(excludeName=null){
  return accounts.filter(a=>a.name!==excludeName).map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
}
function refreshAccountSelects(){
  if(els.account) els.account.innerHTML = buildAccountOptions();
  if(els.fAccount) els.fAccount.innerHTML = `<option value="all" selected>الكل</option>` + buildAccountOptions();
  if(els.trFrom) els.trFrom.innerHTML = buildAccountOptions(els.trTo?.value);
  if(els.trTo) els.trTo.innerHTML = buildAccountOptions(els.trFrom?.value);
  drawAccountsBadges();
}
function drawAccountsBadges(){
  if(!els.accountsList) return;
  els.accountsList.innerHTML = accounts.map((a,i)=>`<span class="badge">${escapeHtml(a.name)} (${fmt(a.opening)}) <button class="btn btn-muted" style="margin-inline-start:6px" onclick="renameAccount(${i})">تعديل</button> <button class="btn btn-muted" onclick="removeAccount(${i})">حذف</button></span>`).join('');
}
window.renameAccount=i=>{
  const cur=accounts[i]; if(!cur) return;
  const name=prompt('اسم الحساب', cur.name); if(!name) return;
  const opening=prompt('الرصيد الافتتاحي', cur.opening);
  if(opening!==null){
    const num=parseFloat(opening);
    if(Number.isNaN(num)) return alert('قيمة غير صحيحة');
    cur.opening=num;
  }
  const oldName=cur.name;
  cur.name=name.trim();

  ledger.filter(t=>t.account===oldName).forEach(t=>t.account=cur.name);

  saveAccounts(); saveLedger(); refreshAccountSelects(); render();
};
window.removeAccount=i=>{
  const name=accounts[i].name;
  if(!confirm(`هل تريد حذف حساب ${name}؟ سيتم حذف جميع الحركات المرتبطة به.`)) return;
  accounts.splice(i,1);
  ledger=ledger.filter(t=>t.account!==name);
  saveAccounts(); saveLedger(); refreshAccountSelects(); render();
};
document.getElementById('addAccount')?.addEventListener('click',()=>{
  const name=els.newAccountName.value.trim();
  const opening=parseFloat(els.newAccountOpening.value||'0');
  if(!name){ alert('ادخل اسم الحساب'); return; }
  accounts.push({name, opening:Number.isFinite(opening)?opening:0});
  els.newAccountName.value='';
  els.newAccountOpening.value='';
  saveAccounts(); render();
});

/* ===== إدارة الفئات ===== */
function drawCatsBadges(){
  if(!els.catsList) return;
  els.catsList.innerHTML = categories.map((c,i)=>`<span class="badge">${escapeHtml(c.name)} · ${c.type==='income'?'دخل':'مصروف'} <button class="btn btn-muted" style="margin-inline-start:6px" onclick="renameCat(${i})">تعديل</button> <button class="btn btn-muted" onclick="removeCat(${i})">حذف</button></span>`).join('');
}
window.renameCat=i=>{
  const cur=categories[i]; if(!cur) return;
  const name=prompt('اسم الفئة', cur.name); if(!name) return;
  const type=prompt('النوع (income/expense)', cur.type);
  if(type!=='income'&&type!=='expense') return alert('نوع غير صحيح');
  const oldName=cur.name;
  cur.name=name.trim();
  cur.type=type;

  ledger.filter(t=>t.category===oldName).forEach(t=>t.category=cur.name);

  saveCategories(); refreshCategorySelect(); render();
};
window.removeCat=i=>{
  const name=categories[i].name;
  if(!confirm(`هل تريد حذف فئة ${name}؟ لن يتم حذف الحركات المرتبطة بها لكن ستصبح 'غير مصنفة'.`)) return;
  categories.splice(i,1);
  ledger.filter(t=>t.category===name).forEach(t=>t.category=null);
  saveCategories(); refreshCategorySelect(); render();
};
document.getElementById('addCategory')?.addEventListener('click',()=>{
  const name=els.newCatName.value.trim();
  const type=els.newCatType.value;
  if(!name){ alert('ادخل اسم الفئة'); return; }
  categories.push({name,type});
  els.newCatName.value='';
  saveCategories(); refreshCategorySelect(); render();
});

/* ===== تصدير/استيراد ===== */
document.getElementById('exportJson')?.addEventListener('click',()=>{
  const data={
    ledger, accounts, categories, commitments, collections,
    exportedAt:new Date().toISOString()
  };
  download('my-finance-data.json', JSON.stringify(data,null,2));
});
document.getElementById('exportCsv')?.addEventListener('click',()=>{
  const header=['id','date','desc','type','amount','account','category'];
  const rows=[...ledger].sort((a,b)=> a.date.localeCompare(b.date) || (a.id>b.id?1:-1))
    .map(t=>[t.id,t.date,escCsv(t.desc||''),t.type,t.amount,t.account,t.category]);
  const csv=[header.join(','), ...rows.map(r=>r.join(','))].join('\n');
  download('transactions.csv', csv);
});
function escCsv(s){
  const need=/[",\n]/.test(String(s));
  return need ? '"'+String(s).replace(/"/g,'""')+'"' : String(s);
}
function download(name, content){
  const blob=new Blob([content],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
  URL.revokeObjectURL(a.href);
}
document.getElementById('importFile')?.addEventListener('change', async (e)=>{
  const file=e.target.files?.[0];
  if(!file) return;
  try{
    const text=await file.text();
    const data=JSON.parse(text);
    if(Array.isArray(data.ledger)) ledger=data.ledger;
    if(Array.isArray(data.accounts)) accounts=data.accounts;
    if(Array.isArray(data.categories)) categories=data.categories;
    if(Array.isArray(data.commitments)) commitments=data.commitments;
    if(Array.isArray(data.collections)) collections=data.collections;
    
    // توحيد الحسابات والفئات الأساسية
    ensureBaseCategories();
    commitments=commitments.map(c=>migrateCommit(c));
    collections=collections.map(c=>migrateCollect(c));

    saveLedger(); saveAccounts(); saveCategories(); saveCommitments(); saveCollections();
    refreshAccountSelects(); refreshCategorySelect(); drawCatsBadges();
    drawCommitments(); drawCollections(); drawDueSoon(); render();
    alert('تم الاستيراد بنجاح');
  } catch(err){
    alert('خطأ في استيراد الملف: قد يكون التنسيق غير صحيح.');
    console.error(err);
  }
});

/* ===== الحركات/القيود (Ledger) ===== */
let txPage=1, editId=null;
const TXS_PER_PAGE=15;

els.type?.addEventListener('change', refreshCategorySelect);
els.type?.addEventListener('change', refreshLinkCommitOptions);

els.resetForm?.addEventListener('click',()=>{
  editId=null;
  els.saveTx.textContent='حفظ';
  els.type.value='expense';
  els.amount.value='';
  els.date.value=formatLocalDate(new Date());
  els.desc.value='';
  els.account.selectedIndex=0;
  refreshCategorySelect();
  els.category.selectedIndex=0;
  refreshLinkCommitOptions();
  els.linkCommit.selectedIndex=0;
});
els.resetForm?.click(); // تعيين القيم الافتراضية

// التحقق من الحساب والفئة عند تغيير القائمة
els.account?.addEventListener('change', ()=>{ if(!accounts.some(a=>a.name===els.account.value)) els.account.selectedIndex=0; });
els.category?.addEventListener('change', ()=>{ if(!categories.some(c=>c.name===els.category.value)) els.category.selectedIndex=0; });

els.saveTx?.addEventListener('click',()=>{
  const type=els.type.value, amount=parseFloat(els.amount.value),
        dateStr=els.date.value, desc=els.desc.value,
        account=els.account.value, category=els.category.value,
        linkCommitId=els.linkCommit.value;

  if(!amount || amount<=0 || Number.isNaN(amount)){ alert('المبلغ غير صحيح'); return; }
  if(!dateStr){ alert('التاريخ إجباري'); return; }
  if(!account){ alert('الحساب إجباري'); return; }

  const catObj=categories.find(c=>c.name===category && c.type===type);
  if(!category || !catObj){ alert('يجب اختيار فئة متوافقة مع النوع'); return; }

  const newTx={
    id:editId||eid(), date:dateStr, desc:desc, type:type, amount:amount,
    account:account, category:category
  };

  if(linkCommitId && type==='expense'){
    newTx.linkCommitId=linkCommitId;
    
    const c=commitments.find(x=>x.id===linkCommitId);
    if(c){
      const ym=dateStr.slice(0,7);
      const paid=(c.payments?.[ym]||0);
      const total=Number(c.amount||0);
      const remain=Math.max(0,total-paid);
      
      // إذا كان المبلغ المُسدّد أكبر من المتبقي، يجب التنبيه/التحذير
      if(amount > remain){
        if(!confirm(`مبلغ السداد (${fmt(amount)}) أكبر من المتبقي (${fmt(remain)}). هل تريد الاستمرار؟`)) return;
      }

      // إضافة الدفعة لسجل المدفوعات للالتزام
      addCommitPayment(linkCommitId, ym, amount);

      // إذا كانت هذه الحركة هي سداد التزام كامل، غيّر الفئة لتكون 'التزامات شهرية'
      if(amount>=total) newTx.category='التزامات شهرية';
    }
  }

  if(editId){
    const was=ledger.find(t=>t.id===editId);
    if(was){
      // إذا كان الالتزام القديم موجوداً والمبلغ تغير، يجب تعديل مدفوعات الالتزام القديم
      if(was.linkCommitId && was.linkCommitId===newTx.linkCommitId && was.amount!==newTx.amount){
        const ym=was.date.slice(0,7);
        const c=commitments.find(x=>x.id===was.linkCommitId);
        if(c && c.payments?.[ym]){
          c.payments[ym]=Math.max(0,(c.payments[ym]-was.amount+newTx.amount));
          saveCommitments();
        }
      }
      ledger=ledger.filter(t=>t.id!==editId);
    }
  }

  // إذا كانت حركة تحويل، نمنع حفظها من هنا
  if(newTx.category==='تحويل صادر'||newTx.category==='تحويل وارد'||newTx.category==='عمولة تحويل'){
    alert('لا يمكن حفظ حركات التحويل من هنا. استخدم قسم "تحويل بين الحسابات"');
    return;
  }
  
  ledger.push(newTx);
  ledger.sort((a,b)=> a.date.localeCompare(b.date) || (a.id>b.id?1:-1));
  
  els.resetForm.click();
  saveLedger();
  txPage = 1; // العودة للصفحة الأولى بعد التعديل
  render();
});

function applyFilters(txs){
  let filtered=txs;
  const s=els.search.value.toLowerCase().trim();
  const fType=els.fType.value;
  const fAccount=els.fAccount.value;
  const fFrom=els.fFrom.value;
  const fTo=els.fTo.value;

  if(s) filtered=filtered.filter(t=> (t.desc||'').toLowerCase().includes(s));
  if(fType!=='all') filtered=filtered.filter(t=>t.type===fType);
  if(fAccount!=='all') filtered=filtered.filter(t=>t.account===fAccount);
  if(fFrom) filtered=filtered.filter(t=>t.date>=fFrom);
  if(fTo) filtered=filtered.filter(t=>t.date<=fTo);
  
  return filtered;
}

els.search?.addEventListener('input',()=>txPage=1);
els.fType?.addEventListener('change',()=>txPage=1);
els.fAccount?.addEventListener('change',()=>txPage=1);
els.fFrom?.addEventListener('change',()=>txPage=1);
els.fTo?.addEventListener('change',()=>txPage=1);

[els.search,els.fType,els.fAccount,els.fFrom,els.fTo].forEach(el=>el?.addEventListener('change',render));
els.clearFilters?.addEventListener('click',()=>{
  els.search.value=''; els.fType.value='all'; els.fAccount.value='all'; els.fFrom.value=''; els.fTo.value='';
  txPage=1; render();
});

document.getElementById('txPrev')?.addEventListener('click',()=>{ txPage=Math.max(1,txPage-1); render(); });
document.getElementById('txNext')?.addEventListener('click',()=>{ txPage++; render(); });

function render(){
  refreshLinkCommitOptions();
  recalc(); // حساب الأرصدة أولاً
  drawAccountsBadges();
  drawCommitments();
  drawCollections();
  drawDueSoon();
  drawTxTable();
  drawMonthly();
}

let after=new Map(); // لـ "الرصيد بعد العملية"
function drawTxTable(){
  const allTxs=[...ledger];
  const filtered=applyFilters(allTxs);
  const rowsDesc=[...filtered].reverse(); // العرض من الأحدث للأقدم

  // Pagination
  const totalRows = rowsDesc.length;
  const totalPages = Math.max(1, Math.ceil(totalRows / TXS_PER_PAGE));
  if(txPage > totalPages) txPage = totalPages;
  const start = (txPage-1)*TXS_PER_PAGE;
  const pageRows = rowsDesc.slice(start, start + TXS_PER_PAGE);

  if(els.tbody){
    els.tbody.innerHTML=pageRows.map(t=>{
      const cls=t.type==='income'?'inc':'exp';
      const afterVal=after.has(t.id)?after.get(t.id):0;
      const tag = t.isTransfer ? ' <span style="font-size:11px;color:#9fb3c8">↔︎ تحويل</span>' : '';
      return `<tr>
        <td>${t.date}</td><td>${escapeHtml(t.desc||'—')}${tag}</td><td>${escapeHtml(t.category||'—')}</td><td>${escapeHtml(t.account)}</td>
        <td class="amount ${cls}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
        <td>${fmt(afterVal)}</td>
        <td class="actions"><button class="btn btn-primary" onclick="editTx('${t.id}')">تعديل</button>
        <button class="btn btn-danger" onclick="delTx('${t.id}')">حذف</button></td>
      </tr>`;
    }).join('');
  }

  // pager UI
  const pager = document.getElementById('txPager');
  const pagerInfo = document.getElementById('txPagerInfo');
  const prevBtn = document.getElementById('txPrev');
  const nextBtn = document.getElementById('txNext');

  if(!pager || totalRows <= TXS_PER_PAGE){
    pager && (pager.style.display='none');
  }
  else{
    pager.style.display='flex';
    pagerInfo.textContent = `صفحة ${txPage} / ${totalPages} — إجمالي ${totalRows} حركة`;
    prevBtn.disabled = txPage<=1;
    nextBtn.disabled = txPage>=totalPages;
  }
}

window.editTx=id=>{
  const t=ledger.find(x=>x.id===id);
  if(!t) return;
  editId=id;
  els.saveTx.textContent='تحديث';
  els.type.value=t.type;
  refreshCategorySelect();
  els.amount.value=t.amount;
  els.date.value=t.date;
  els.desc.value=t.desc||'';
  els.account.value=t.account;
  els.category.value=t.category||'';
  refreshLinkCommitOptions(); // للتأكد من تحديث القائمة قبل تعيين القيمة
  els.linkCommit.value=t.linkCommitId||'';
  window.scrollTo({top:0,behavior:'smooth'});
};
window.delTx=id=>{
  if(!confirm('هل تريد حذف هذه الحركة؟')) return;
  const was=ledger.find(t=>t.id===id);
  
  // إذا كانت حركة تحويل، نحذف الحركة المقابلة لها
  if(was.isTransfer && was.link){
    ledger=ledger.filter(t=>t.link!==was.link);
  } else {
    ledger=ledger.filter(t=>t.id!==id);
  }

  saveLedger();
  
  // إذا كانت الحركة مرتبطة بالتزام، نعكس الدفعة من الالتزام
  if(was && was.type==='expense' && was.linkCommitId){
    const ym=was.date.slice(0,7);
    const c=commitments.find(x=>x.id===was.linkCommitId);
    if(c && c.payments?.[ym]){
      c.payments[ym]=Math.max(0,(c.payments[ym]-was.amount));
      saveCommitments();
    }
  }

  txPage = 1;
  render();
};

function refreshLinkCommitOptions(){
  if(!els.linkCommit) return;
  const ym=YM();
  const opts = commitments
    .filter(c=>{
      const due=(c.nextDue||c.firstDue||'').slice(0,7)===ym;
      const paid=(c.payments?.[ym]||0);
      return due && paid < Number(c.amount||0);
    })
    .map(c=>`<option value="${c.id}">${escapeHtml(c.name)} — أصل ${fmt(c.amount)} • مدفوع ${fmt(c.payments?.[ym]||0)} • متبقي ${fmt((Number(c.amount||0)-(c.payments?.[ym]||0)))}</option>`)
    .join('');
  
  // إظهار الخيار فقط للمصروفات
  if(els.type.value==='expense'){
    els.linkCommit.parentElement.style.display='';
    els.linkCommit.innerHTML = `<option value="">— بدون —</option>` + opts;
  } else {
    els.linkCommit.parentElement.style.display='none';
    els.linkCommit.innerHTML = `<option value="">— بدون —</option>`;
  }
}

/* ===== التحويل ===== */
function ensureTransferCategories(){
  const need=[{name:'تحويل صادر',type:'expense'},{name:'تحويل وارد',type:'income'},{name:'عمولة تحويل',type:'expense'}];
  let changed=false;
  for(const n of need){
    if(!categories.some(c=>c.name===n.name && c.type===n.type)){
      categories.push(n); changed=true;
    }
  }
  if(changed) saveCategories();
}

function syncTransferSelects(trigger){
  if(trigger === 'from' && els.trTo){
    const from = els.trFrom.value;
    const prevTo = els.trTo.value;
    els.trTo.innerHTML = buildAccountOptions(from);
    if(prevTo && prevTo !== from && accounts.some(a=>a.name===prevTo)){
      els.trTo.value = prevTo;
    }else{
      els.trTo.selectedIndex = 0;
    }
  }
  else if(trigger === 'to' && els.trFrom){
    const to = els.trTo.value;
    const prevFrom = els.trFrom.value;
    els.trFrom.innerHTML = buildAccountOptions(to);
    if(prevFrom && prevFrom !== to && accounts.some(a=>a.name===prevFrom)){
      els.trFrom.value = prevFrom;
    }else{
      els.trFrom.selectedIndex = 0;
    }
  }
}

function doTransfer(){
  const from=els.trFrom.value, to=els.trTo.value,
        amount=parseFloat(els.trAmount.value), fee=parseFloat(els.trFee.value||'0'),
        date=els.trDate.value||formatLocalDate(new Date()), note=els.trDesc.value.trim();

  if(!from || !to){ alert('يجب اختيار الحسابين'); return; }
  if(from === to){ alert('لا يمكن التحويل لنفس الحساب'); return; }
  if(!amount || amount<=0 || Number.isNaN(amount)){ alert('المبلغ غير صحيح'); return; }
  if(fee<0 || Number.isNaN(fee)){ alert('العمولة غير صحيحة'); return; }

  const link=eid();
  const descOut = note ? `تحويل إلى ${to} — ${note}` : `تحويل إلى ${to}`;
  const descIn = note ? `تحويل من ${from} — ${note}` : `تحويل من ${from}`;

  // 1. حركة خروج المبلغ
  ledger.push({
    id:eid(), link, isTransfer:true, date,
    desc:descOut, type:'expense', amount:amount,
    account:from, category:'تحويل صادر'
  });

  // 2. حركة دخول المبلغ
  ledger.push({
    id:eid(), link, isTransfer:true, date,
    desc:descIn, type:'income', amount:amount,
    account:to, category:'تحويل وارد'
  });

  // 3. حركة عمولة التحويل (إذا وجدت)
  if(fee>0){
    const descFee = note ? `عمولة تحويل — ${note}` : `عمولة تحويل`;
    ledger.push({
      id:eid(), date,
      desc:descFee, type:'expense', amount:fee,
      account:from, category:'عمولة تحويل'
    });
  }

  saveLedger();
  render();

  els.trAmount.value='';
  els.trFee.value='';
  els.trDesc.value='';
}
els.execTransfer?.addEventListener('click', doTransfer);
els.resetTransfer?.addEventListener('click', ()=>{
  els.trAmount.value='';
  els.trFee.value='';
  els.trDesc.value='';
});
els.trFrom?.addEventListener('change', ()=>syncTransferSelects('from'));
els.trTo ?.addEventListener('change', ()=>syncTransferSelects('to'));

/* ===== حساب الأرصدة =====
   IMPORTANT: الأرصدة تُحسب تصاعديًا (من الأقدم للأحدث) عشان "الرصيد بعد العملية" يبقى صحيح. */
function computeBalances(){
  const bal = new Map(accounts.map(a=>[a.name, Number(a.opening||0)]));
  
  // الحركات مرتبة تصاعديًا (من الأقدم للأحدث)
  const sorted=[...ledger].sort((a,b)=>
    a.date.localeCompare(b.date) || (a.id>b.id?1:-1)
  );
  
  after=new Map();

  for(const t of sorted){
    const current=bal.get(t.account)||0;
    const amount=Number(t.amount||0);
    const newBal = current + (t.type==='income' ? amount : -amount);
    bal.set(t.account, newBal);
    after.set(t.id, newBal);
  }

  return {bal, after};
}

function drawPerAccount(balances){
  if(!els.perAccount) return;
  els.perAccount.innerHTML = accounts.map(a=>{
    const bal=balances.get(a.name)||0;
    const cls=bal>=0?'pos':'neg';
    return `<div class="item">${escapeHtml(a.name)}: <span class="${cls}">${fmt(bal)} ج.م</span></div>`;
  }).join('');
}

/* ===== الالتزامات الشهرية والتحصيلات (Commitments & Collections) ===== */

function migrateCommit(c){
  if(!c.payments) c.payments={};
  if(c.firstDue && !c.nextDue){
    const today=startOfToday();
    let due=parseLocalDate(c.firstDue);
    while(due<today){
      const next=addMonthsPreserveDOM(due,1);
      if(c.recurring && (!c.endAt || next<=parseLocalDate(c.endAt))) due=next;
      else break;
    }
    c.nextDue=formatLocalDate(due);
  }
  return c;
}

function migrateCollect(c){
  if(c.firstDue && !c.nextDue){
    const today=startOfToday();
    let due=parseLocalDate(c.firstDue);
    while(due<today){
      const next=addMonthsPreserveDOM(due,1);
      if(c.recurring && (!c.endAt || next<=parseLocalDate(c.endAt))) due=next;
      else break;
    }
    c.nextDue=formatLocalDate(due);
  }
  return c;
}

function addCommitPayment(id, ym, amount){
  const c=commitments.find(x=>x.id===id);
  if(!c) return;
  if(!c.payments) c.payments={};
  c.payments[ym]=(c.payments[ym]||0)+amount;
  saveCommitments();
  drawCommitments();
  drawDueSoon();
}

let editCommitId=null;
function drawCommitments(){
  if(!els.tbodyCommit) return;
  els.tbodyCommit.innerHTML=commitments.map(c=>{
    const ym=YM();
    const paid=(c.payments?.[ym]||0);
    const total=Number(c.amount||0);
    const remaining=Math.max(0,total-paid);
    const repeat=c.recurring?'شهرياً':'مرة واحدة';
    const end=c.endAt?c.endAt:'—';

    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(total)}</td>
      <td>${c.nextDue||c.firstDue}</td>
      <td class="${paid>0?'pos':'neg'}">${fmt(paid)}</td>
      <td class="${remaining>0?'neg':'pos'}">${fmt(remaining)}</td>
      <td>${repeat}</td>
      <td>${end}</td>
      <td class="actions">
        ${remaining>0?`<button class="btn btn-primary" onclick="payCommit('${c.id}')">سداد</button>`:''}
        <button class="btn btn-outline" onclick="editCommit('${c.id}')">تعديل</button>
        <button class="btn btn-danger" onclick="removeCommit('${c.id}')">حذف</button>
      </td>
    </tr>`;
  }).join('');
  endRequiredToggle();
  refreshLinkCommitOptions();
}
window.editCommit=id=>{
  const c=commitments.find(x=>x.id===id);
  if(!c) return;
  editCommitId=id;
  els.addCommitment.textContent='تحديث الالتزام';
  els.cName.value=c.name;
  els.cAmount.value=c.amount;
  els.cFirstDue.value=c.firstDue;
  els.cRecurring.checked=!!c.recurring;
  els.cEndAt.value=c.endAt||'';
  window.scrollTo({top:0,behavior:'smooth'});
  endRequiredToggle();
};
window.removeCommit=id=>{
  if(!confirm('هل تريد حذف هذا الالتزام؟ لن يتم حذف الحركات التي تم سدادها.')) return;
  commitments=commitments.filter(c=>c.id!==id);
  saveCommitments();
  drawCommitments();
  drawDueSoon();
};

function endRequiredToggle(){
  els.cEndAt?.toggleAttribute('required', els.cRecurring?.checked);
}
els.cRecurring?.addEventListener('change', endRequiredToggle);

els.addCommitment?.addEventListener('click',()=>{
  const name=els.cName.value.trim(), amount=parseFloat(els.cAmount.value),
        firstDueStr=els.cFirstDue.value, recurring=els.cRecurring.checked,
        endAtStr=els.cEndAt.value;

  if(!name){ alert('ادخل اسم الالتزام'); return; }
  if(!amount || amount<=0 || Number.isNaN(amount)){ alert('المبلغ غير صحيح'); return; }
  if(!firstDueStr){ alert('تاريخ أول استحقاق إجباري'); return; }
  if(recurring && !endAtStr){ alert('عند التكرار الشهري يجب تحديد تاريخ النهاية'); return; }
  
  if(recurring && endAtStr && parseLocalDate(endAtStr) < parseLocalDate(firstDueStr)){
    alert('تاريخ النهاية يجب أن يكون بعد تاريخ أول استحقاق'); return;
  }

  let firstDue=parseLocalDate(firstDueStr), nextDue=parseLocalDate(firstDueStr);
  const today=startOfToday();
  
  // حساب أقرب تاريخ استحقاق قادم
  while(nextDue<today){
    const tryNext=addMonthsPreserveDOM(nextDue,1);
    if(recurring && (!endAtStr || tryNext<=parseLocalDate(endAtStr))) nextDue=tryNext;
    else break;
  }

  const commit={
    id:editCommitId||eid(), name, amount,
    firstDue:formatLocalDate(firstDue),
    nextDue:formatLocalDate(nextDue),
    recurring,
    endAt:(recurring?(endAtStr||null):null),
    payments:{}
  };

  if(editCommitId){
    const i=commitments.findIndex(c=>c.id===editCommitId);
    if(i>-1) commitments[i]=commit;
    editCommitId=null;
    els.addCommitment.textContent='إضافة/تحديث';
  } else commitments.push(commit);
  
  els.cName.value=''; els.cAmount.value=''; els.cFirstDue.value='';
  els.cRecurring.checked=false; els.cEndAt.value='';
  endRequiredToggle();
  saveCommitments();
  drawCommitments(); drawDueSoon();
});

function chooseAccount(){
  if(accounts.length===0){ alert('لا توجد حسابات لإتمام العملية'); return null; }
  const menu=accounts.map((a,i)=>`${i+1} - ${a.name}`).join('\n');
  const ans=prompt(`اختَر الحساب:\n${menu}`);
  if(ans===null) return null;
  const idx=parseInt(ans,10)-1;
  if(Number.isNaN(idx)||idx<0||idx>=accounts.length){ alert('اختيار غير صحيح'); return null; }
  return accounts[idx].name;
}

window.payCommit=id=>{
  const c=commitments.find(x=>x.id===id); if(!c) return;
  const due=c.nextDue?parseLocalDate(c.nextDue):parseLocalDate(c.firstDue);
  const dateStr=formatLocalDate(due);
  const ym=dateStr.slice(0,7);
  const paid=(c.payments?.[ym]||0);
  const remain=Math.max(0,(Number(c.amount||0)-paid));

  if(remain<=0){ alert('لا يوجد مبلغ متبقٍ لهذا الشهر.'); return; }

  const accName=chooseAccount(); if(!accName) return;

  if(!confirm(`سداد كامل متبقّي الالتزام "${c.name}" بقيمة ${fmt(remain)} ج.م من "${accName}" بتاريخ ${dateStr}؟`)) return;

  const tx={
    id:eid(), date:dateStr, desc:`${c.name} (سداد التزام)`, type:'expense', amount:remain,
    account:accName, category:'التزامات شهرية', linkCommitId:c.id
  };
  ledger.push(tx); saveLedger();
  addCommitPayment(c.id, ym, remain);
  txPage = 1; render();
};

let editCollectId=null;
function drawCollections(){
  if(!els.tbodyCollect) return;
  els.tbodyCollect.innerHTML=collections.map(c=>{
    const repeat=c.recurring?'شهرياً':'مرة واحدة';
    const end=c.endAt?c.endAt:'—';
    const due=c.nextDue||c.firstDue;

    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${due}</td>
      <td>${repeat}</td>
      <td>${end}</td>
      <td class="actions">
        <button class="btn btn-primary" onclick="collectNow('${c.id}')">تم التحصيل</button>
        <button class="btn btn-outline" onclick="editCollect('${c.id}')">تعديل</button>
        <button class="btn btn-danger" onclick="removeCollect('${c.id}')">حذف</button>
      </td>
    </tr>`;
  }).join('');
  endRequiredToggleCollect();
}
window.editCollect=id=>{
  const c=collections.find(x=>x.id===id); if(!c) return;
  editCollectId=id;
  els.addCollect.textContent='تحديث التحصيل';
  els.coName.value=c.name;
  els.coAmount.value=c.amount;
  els.coFirstDue.value=c.firstDue;
  els.coRecurring.checked=!!c.recurring;
  els.coEndAt.value=c.endAt||'';
  window.scrollTo({top:0,behavior:'smooth'});
  endRequiredToggleCollect();
};
window.removeCollect=id=>{
  if(!confirm('هل تريد حذف هذا التحصيل؟')) return;
  collections=collections.filter(c=>c.id!==id);
  saveCollections();
  drawCollections();
  drawDueSoon();
};

function endRequiredToggleCollect(){
  els.coEndAt?.toggleAttribute('required', els.coRecurring?.checked);
}
els.coRecurring?.addEventListener('change', endRequiredToggleCollect);

els.addCollect?.addEventListener('click',()=>{
  const name=els.coName.value.trim(), amount=parseFloat(els.coAmount.value),
        firstDueStr=els.coFirstDue.value, recurring=els.coRecurring.checked,
        endAtStr=els.coEndAt.value;

  if(!name){ alert('ادخل اسم التحصيل'); return; }
  if(!amount || amount<=0 || Number.isNaN(amount)){ alert('المبلغ غير صحيح'); return; }
  if(!firstDueStr){ alert('تاريخ أول استحقاق إجباري'); return; }
  if(recurring && !endAtStr){ alert('عند التكرار الشهري يجب تحديد تاريخ النهاية'); return; }
  if(recurring && endAtStr && parseLocalDate(endAtStr) < parseLocalDate(firstDueStr)){
    alert('تاريخ النهاية يجب أن يكون بعد تاريخ أول استحقاق'); return;
  }
  
  let firstDue=parseLocalDate(firstDueStr), nextDue=parseLocalDate(firstDueStr);
  const today=startOfToday();
  
  // حساب أقرب تاريخ استحقاق قادم
  while(nextDue<today){
    const tryNext=addMonthsPreserveDOM(nextDue,1);
    if(recurring && (!endAtStr || tryNext<=parseLocalDate(endAtStr))) nextDue=tryNext;
    else break;
  }
  
  const item={
    id:editCollectId||eid(), name, amount,
    firstDue:formatLocalDate(firstDue),
    nextDue:formatLocalDate(nextDue),
    recurring,
    endAt:(recurring?(endAtStr||null):null)
  };

  if(editCollectId){
    const i=collections.findIndex(c=>c.id===editCollectId);
    if(i>-1) collections[i]=item;
    editCollectId=null;
    els.addCollect.textContent='إضافة/تحديث';
  } else collections.push(item);
  
  els.coName.value=''; els.coAmount.value=''; els.coFirstDue.value='';
  els.coRecurring.checked=false; els.coEndAt.value='';
  endRequiredToggleCollect();
  saveCollections();
  drawCollections();
});

window.collectNow=id=>{
  const c=collections.find(x=>x.id===id); if(!c) return;
  const due=c.nextDue?parseLocalDate(c.nextDue):parseLocalDate(c.firstDue);
  const dateStr=formatLocalDate(due);

  const accName=chooseAccount(); if(!accName) return;

  if(!confirm(`تأكيد تحصيل "${c.name}" بمبلغ ${fmt(c.amount)} ج.م إلى حساب "${accName}" بتاريخ ${dateStr}؟`)) return;

  // تسجيل الحركة في دفتر القيود
  ledger.push({
    id:eid(), date:dateStr, desc:`${c.name} (تحصيل)`, type:'income', amount:c.amount,
    account:accName, category:'تحصيلات شهرية'
  });
  saveLedger();
  
  // تحديث أو إزالة التحصيل من قائمة التحصيلات
  if(c.recurring){
    const next=addMonthsPreserveDOM(due,1);
    if(c.endAt && next>parseLocalDate(c.endAt)){
      collections=collections.filter(x=>x.id!==id);
    }
    else{
      c.nextDue=formatLocalDate(next);
    }
  }else{
    collections=collections.filter(x=>x.id!==id);
  }
  saveCollections();

  txPage = 1;
  render();
};

/* ===== الاستحقاقات القريبة: جدول + بطاقات ===== */
function hasDueInMonth(item, targetYm){
  const dueStr=item.nextDue||item.firstDue;
  if(!dueStr) return false;
  if(!targetYm || targetYm.indexOf('-')===-1) return false;
  
  const targetStart=parseLocalDate(`${targetYm}-01`);
  if(Number.isNaN(targetStart.getTime())) return false;
  
  let endDate=null;
  if(item.endAt){
    const tmp=parseLocalDate(item.endAt);
    if(!Number.isNaN(tmp.getTime())) endDate=tmp;
  }
  
  const dueDate=parseLocalDate(dueStr);
  if(Number.isNaN(dueDate.getTime())) return false;
  
  const monthOf=date=>formatLocalDate(date).slice(0,7);
  
  if(monthOf(dueDate)===targetYm) return true;
  if(!item.recurring) return false;
  if(endDate && endDate < targetStart) return false;

  let cursor=new Date(dueDate.getTime());
  let guard=0; // لمنع الحلقة اللانهائية

  while(monthOf(cursor) < targetYm && guard < 120){
    const next=addMonthsPreserveDOM(cursor,1);
    if(endDate && next > endDate) return false;
    if(next.getTime()===cursor.getTime()) break;
    cursor=next;
    guard++;
  }
  return monthOf(cursor)===targetYm;
}

function sumCurrentMonthCommitments(){
  const ym=YM();
  let total=0;
  for(const c of commitments){
    const due=(c.nextDue||c.firstDue||'');
    if(due.slice(0,7)===ym){
      const paid=(c.payments?.[ym]||0);
      const remain=Math.max(0,(Number(c.amount||0)-paid));
      total += remain;
    }
  }
  return total;
}

function sumCurrentMonthCollections(){
  const ym=YM();
  let total=0;
  for(const c of collections){
    const due=(c.nextDue||c.firstDue||'');
    if(due.slice(0,7)===ym){
      total += Number(c.amount||0);
    }
  }
  return total;
}

function sumNextMonthCommitmentsIncludingCarry(){
  const ym=YM();
  const nextYm=addMonthsToYm(ym,1);

  // المتبقي من الشهر الحالي (غير المسدد)
  let currentRemain = 0;
  for(const c of commitments){
    const due=(c.nextDue||c.firstDue||'');
    if(due.slice(0,7)===ym){
      const paid=(c.payments?.[ym]||0);
      const remain=Math.max(0,(Number(c.amount||0)-paid));
      currentRemain += remain;
    }
  }

  // التزامات الشهر القادم
  let nextRemain = 0;
  for(const c of commitments){
    if(!hasDueInMonth(c, nextYm)) continue;
    const paidNext=(c.payments?.[nextYm]||0);
    const remainNext=Math.max(0,(Number(c.amount||0)-paidNext));
    nextRemain += remainNext;
  }

  return currentRemain + nextRemain;
}

function sumNextMonthCollections(){
  const ym=YM();
  const nextYm=addMonthsToYm(ym,1);
  let total=0;
  for(const c of collections){
    if(hasDueInMonth(c, nextYm)){
      total += Number(c.amount||0);
    }
  }
  return total;
}

function recalc(){
  const {bal}=computeBalances();
  let total=0;
  for(const v of bal.values()) total+=v;
  
  const monthComRemain = sumCurrentMonthCommitments();
  const currentCol = sumCurrentMonthCollections();
  const nextWithCarry = sumNextMonthCommitmentsIncludingCarry();
  const nextCol = sumNextMonthCollections();

  // قيَم إضافية
  if(els.totalBalance) els.totalBalance.textContent = fmt(total) + ' ج.م';
  if(els.monthCommitTotal) els.monthCommitTotal.textContent = fmt(monthComRemain) + ' ج.م';
  if(els.currentMonthCollections) els.currentMonthCollections.textContent = fmt(currentCol) + ' ج.م';
  if(els.balanceAfterCommitments) els.balanceAfterCommitments.textContent = fmt(total - monthComRemain) + ' ج.م';
  if(els.nextCommitWithCarry) els.nextCommitWithCarry.textContent = fmt(nextWithCarry) + ' ج.م';
  if(els.nextMonthCollections) els.nextMonthCollections.textContent = fmt(nextCol) + ' ج.م';
  if(els.dueNextTotalBadge) els.dueNextTotalBadge.textContent = 'الشهر القادم: ' + fmt(nextRemain) + ' ج.م';
  
  drawPerAccount(bal);
}

function drawDueSoon(){
  const wrap=document.getElementById('dueSoonWrap'), none=document.getElementById('noDueSoon'),
        tbody=document.getElementById('tbodyDueSoon'), cards=document.getElementById('dueSoonCards');
  if(!wrap||!tbody||!cards) return;

  const ym=YM();
  const nextYm=addMonthsToYm(ym,1);
  const today=startOfToday();

  // قائمة الالتزامات المتبقية للشهر الحالي
  const list=commitments.map(c=>{
    const dueStr=c.nextDue||c.firstDue;
    if(!dueStr) return null;
    if(dueStr.slice(0,7)!==ym) return null;

    const paid=(c.payments?.[ym]||0);
    const total=Number(c.amount||0);
    const remaining=Math.max(0,total-paid);
    if(remaining<=0) return null;

    const due=parseLocalDate(dueStr);
    const diff=daysBetween(today,due);

    return {...c,due,dueStr,paid,total,remaining,diff};
  }).filter(Boolean).sort((a,b)=> a.dueStr.localeCompare(b.dueStr));
  
  const totalRemain = list.reduce((s,x)=>s + x.remaining, 0);

  if(els.dueTotalBadge){
    els.dueTotalBadge.textContent = 'إجمالي: ' + fmt(totalRemain) + ' ج.م';
  }

  // جدول (للحواسيب)
  if(list.length>0){
    none.classList.add('d-none');
    tbody.innerHTML=list.map(c=>{
      let state, stateCls;
      if(c.diff<0){ state='متاخر'; stateCls='over'; }
      else if(c.diff===0){ state='اليوم'; stateCls='warn'; }
      else if(c.diff<=7){ state='قريب'; stateCls='warn'; }
      else{ state=`متبقّي ${c.diff} يوم`; stateCls=''; }
      
      const dueLabel=c.diff<=10 ? `${c.dueStr} (${c.diff} يوم)` : c.dueStr;
      
      return `<tr>
        <td>${escapeHtml(c.name)}</td>
        <td>${dueLabel}</td>
        <td>${fmt(c.total)}</td>
        <td class="pos">${fmt(c.paid)}</td>
        <td class="neg">${fmt(c.remaining)}</td>
        <td><span class="${stateCls}">${state}</span></td>
        <td class="actions"><button class="btn btn-primary" onclick="payCommit('${c.id}')">سداد</button></td>
      </tr>`;
    }).join('');
    wrap.style.display='';
  } else {
    none.classList.remove('d-none');
    wrap.style.display='none';
  }

  // بطاقات (للموبايل)
  cards.innerHTML=list.map(c=>{
    let state, stateCls;
    if(c.diff<0){ state='متاخر'; stateCls='over'; }
    else if(c.diff===0){ state='اليوم'; stateCls='warn'; }
    else if(c.diff<=7){ state='قريب'; stateCls='warn'; }
    else{ state=`متبقّي ${c.diff} يوم`; stateCls=''; }
    return `<div class="due-card">
      <div class="row"><div class="name">${escapeHtml(c.name)}</div><div class="remain">${fmt(c.remaining)} ج.م</div></div>
      <div class="row"><div class="meta">${c.dueStr}</div><div class="state ${stateCls}">${state}</div></div>
      <div class="row"><div class="meta">الأصل: ${fmt(c.total)} | المدفوع: ${fmt(c.paid)}</div><div class="actions"><button class="btn btn-primary" onclick="payCommit('${c.id}')">سداد</button></div></div>
    </div>`;
  }).join('');
}


/* ===== التقارير الشهرية ===== */
let monthlyData = [];

function getMonthlyData(){
  const agg=new Map(); // { 'YYYY-MM': {inc, exp, net} }
  let minMonth=YM(), maxMonth=YM();

  for(const t of ledger){
    if(t.isTransfer) continue;
    const ym=t.date.slice(0,7);
    if(ym<minMonth) minMonth=ym;
    if(ym>maxMonth) maxMonth=ym;

    const data=agg.get(ym)||{inc:0,exp:0,net:0,month:ym};
    if(t.type==='income') data.inc+=t.amount;
    else if(t.type==='expense') data.exp+=t.amount;
    data.net=data.inc-data.exp;
    agg.set(ym,data);
  }

  // ملء الفجوات الشهرية بـ 0
  let cursor=minMonth;
  while(cursor<=maxMonth){
    if(!agg.has(cursor)) agg.set(cursor,{inc:0,exp:0,net:0,month:cursor});
    cursor=addMonthsToYm(cursor,1);
  }
  
  monthlyData=[...agg.values()].sort((a,b)=>a.month.localeCompare(b.month));
}

function drawMonthly(){
  getMonthlyData();
  if(!els.tbodyMonthly) return;
  
  const totalMax=Math.max(...monthlyData.map(d=>Math.max(d.inc,d.exp)),1);
  
  els.tbodyMonthly.innerHTML=monthlyData.reverse().map(d=>{
    const netCls=d.net>=0?'pos':'neg';
    const activeCls=d.month===els.monthPicker.value?'active':'';
    return `<tr class="${activeCls}" onclick="selectMonth('${d.month}')">
      <td>${monthLabel(d.month)}</td>
      <td class="inc">${fmt(d.inc)}</td>
      <td class="exp">${fmt(d.exp)}</td>
      <td class="${netCls}">${fmt(d.net)}</td>
    </tr>`;
  }).join('');
  
  drawChart();
  drawMonthSummary(els.monthPicker.value);
}

window.selectMonth=month=>{
  els.monthPicker.value=month;
  drawMonthly(); // لإعادة رسم الجدول وتفعيل التحديد
}
els.monthPicker?.addEventListener('change', drawMonthly);
els.refreshReports?.addEventListener('click', drawMonthly);


function drawChart(){
  const canvas=els.chartMonthly;
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);
  
  const data=monthlyData.slice(-8); // آخر 8 أشهر
  if(data.length===0) return;
  
  const pad=30;
  const innerW=w-2*pad;
  const innerH=h-2*pad;
  
  const maxVal=Math.max(...data.map(d=>Math.max(d.inc,d.exp)),1);
  const minVal=Math.min(...data.map(d=>d.net),0);
  const range=maxVal-minVal;
  
  const barGroup=innerW/data.length;
  const barWidth=Math.max(8, barGroup/3 - 10);
  
  const toY=val=>pad+innerH*(1-(val-minVal)/range);
  const zeroY=toY(0);

  // رسم المحور الأفقي (الصفر)
  ctx.strokeStyle='#1f2a44';
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(pad, zeroY);
  ctx.lineTo(w-pad, zeroY);
  ctx.stroke();

  // رسم الأعمدة
  data.forEach((d,i)=>{
    const xCenter=pad+i*barGroup+barGroup/2;
    
    // مصروفات
    if(d.exp>0){
      const top=zeroY;
      const height=toY(d.exp)-zeroY;
      ctx.fillStyle='#ef4444';
      ctx.fillRect(xCenter-barWidth-4, top, barWidth, height);
    }
    
    // دخل
    if(d.inc>0){
      const top=toY(d.inc);
      const height=zeroY-toY(d.inc);
      ctx.fillStyle='#22c55e';
      ctx.fillRect(xCenter+4, top, barWidth, height);
    }
  });
  
  // رسم خط الصافي
  ctx.strokeStyle='#0ea5e9';
  ctx.lineWidth=2;
  ctx.beginPath();
  data.forEach((d,i)=>{
    const xCenter=pad+i*barGroup+barGroup/2;
    const y=toY(d.net);
    if(i===0) ctx.moveTo(xCenter,y);
    else ctx.lineTo(xCenter,y);
  });
  ctx.stroke();

  // تسميات الشهور
  ctx.fillStyle='#cbd5e1';
  ctx.font='12px system-ui';
  ctx.textAlign='center';
  data.forEach((d,i)=>{
    const xCenter=pad+i*barGroup+barGroup/2;
    ctx.fillText(monthLabel(d.month), xCenter, h-pad+18);
  });
}

function monthTransactions(month){
  if(!month) return [];
  return ledger.filter(t=>!t.isTransfer && t.date.slice(0,7)===month);
}

function aggregateMonthCategories(month,type){
  const map=new Map();
  let total=0;
  for(const t of ledger){
    if(t.isTransfer || t.type!==type) continue;
    if(t.date.slice(0,7)!==month) continue;

    const key=t.category?String(t.category):'غير مصنف';
    const prev=map.get(key)||0;
    const val=prev+t.amount;
    map.set(key,val);
    total+=t.amount;
  }
  const items=[...map.entries()].map(([name,sum])=>({name,sum})).sort((a,b)=>b.sum-a.sum);
  return {total,items};
}

function renderBarList(el, agg, type){
  if(!el) return;
  const items=agg.items.slice(0,6);
  if(!items.length){
    el.innerHTML='<div class="empty-state">لا توجد بيانات.</div>';
    return;
  }
  const maxVal=Math.max(...items.map(i=>i.sum),0);
  const total=agg.total||0;

  el.innerHTML=items.map(item=>{
    const width=maxVal>0?Math.min(100,Math.max(6,(item.sum/maxVal)*100)):0;
    const share=total>0?(item.sum/total):0;
    const shareTxt=(share*100).toLocaleString('ar-EG',{maximumFractionDigits:1,minimumFractionDigits:1});
    const amountTxt=`${fmt(item.sum)} ج.م`;
    
    return `<div class="bar-item"><div class="label">${escapeHtml(item.name)}</div><div class="bar-track"><div class="bar-fill ${type}" style="--w:${width}%"><span>${amountTxt}</span></div></div><div class="value">${amountTxt} • ${shareTxt}٪ من الإجمالي</div></div>`;
  }).join('');
}

function drawMonthSummary(month){
  const txs=monthTransactions(month);
  const totalInc=txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const totalExp=txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const net=totalInc-totalExp;
  
  if(txs.length===0){
    els.monthNoData?.classList.remove('d-none');
  } else {
    els.monthNoData?.classList.add('d-none');
  }

  // حساب متوسط الصرف اليومي
  let avg=0;
  if(totalExp>0){
    const [y,m]=month.split('-').map(Number);
    const daysInMonth=new Date(y,m,0).getDate();
    const today=new Date();
    const currentMonth=YM();
    
    let daysCount=daysInMonth;
    // إذا كان الشهر الحالي، نحسب حتى اليوم
    if(month===currentMonth){
      daysCount=Math.min(today.getDate(),daysInMonth);
    }

    avg=totalExp/daysCount;
  }

  els.monthSelectedLabel.textContent = monthLabel(month);
  els.monthStatIncome.textContent = fmt(totalInc);
  els.monthStatExpense.textContent = fmt(totalExp);
  els.monthStatNet.textContent = fmt(net);
  els.monthStatTx.textContent = txs.length.toLocaleString('ar-EG');
  els.monthStatAvg.textContent = fmt(avg);
  
  const aggExp=aggregateMonthCategories(month,'expense');
  const aggInc=aggregateMonthCategories(month,'income');
  
  renderBarList(els.monthCatsExpense, aggExp, 'expense');
  renderBarList(els.monthCatsIncome, aggInc, 'income');
}

/* ===== كروت الطي/الفتح ===== */
function initCollapsibles(){
  document.querySelectorAll('[data-collapsible]').forEach(sec=>{
    const btn=sec.querySelector('.toggle');
    if(!btn) return;
    btn.addEventListener('click',()=>{
      const isCollapsed=sec.classList.toggle('collapsed');
      btn.textContent=isCollapsed?'▸':'▾';
      btn.setAttribute('aria-expanded',String(!isCollapsed));
    });
    // ابدأ كلها مطوية
    sec.classList.add('collapsed');
    btn.textContent='▸';
    btn.setAttribute('aria-expanded','false');
  });
}

/* ===== PWA ===== */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt=e;
  if(els.installBtn) els.installBtn.style.display='inline-flex';
});
els.installBtn?.addEventListener('click', async ()=>{
  if(!deferredPrompt) return;
  els.installBtn.disabled=true;
  await deferredPrompt.prompt();
  deferredPrompt=null;
  els.installBtn.style.display='none';
});

/* ===== Service Worker ===== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('/my-finance/sw.js').catch(()=>{});
  });
}

/* ===== GitHub Sync ===== */
function ghStatus(msg, ok=true){
  if(!els.ghStatus) return;
  els.ghStatus.textContent = 'الحالة: '+msg;
  els.ghStatus.style.backgroundColor = ok ? '#0b162a' : '#220b0b';
  els.ghStatus.style.borderColor = ok ? '#1f2a44' : '#441f1f';
}
function readGhFormToCfg(){
  if(!els.ghUser) return;
  ghCfg={
    user:els.ghUser.value.trim(),
    repo:els.ghRepo.value.trim(),
    branch:els.ghBranch.value.trim()||'main',
    path:els.ghPath.value.trim()||'my-finance.json',
    token:els.ghToken.value.trim(),
    auto:els.ghAuto.checked
  };
  saveGhCfg();
}
function fillGhFormFromStorage(){
  if(!ghCfg) ghCfg={};
  if(els.ghUser) els.ghUser.value = ghCfg.user || '';
  if(els.ghRepo) els.ghRepo.value = ghCfg.repo || '';
  if(els.ghBranch) els.ghBranch.value = ghCfg.branch || 'main';
  if(els.ghPath) els.ghPath.value = ghCfg.path || 'my-finance.json';
  if(els.ghToken) els.ghToken.value = ghCfg.token || '';
  if(els.ghAuto) els.ghAuto.checked = ghCfg.auto || false;
  
  if(ghCfg.user && ghCfg.repo) ghStatus('غير متصل',false);
}

// Wrapper for GitHub API calls
async function gh_api(url, method='GET', data=null){
  const headers={
    'Authorization':`token ${ghCfg.token}`,
    'Accept':'application/vnd.github.v3+json'
  };
  const body = data ? JSON.stringify(data) : null;
  
  const res=await fetch(url,{method,headers,body});
  if(res.status===204) return null; // No Content
  if(!res.ok) throw new Error(`GitHub API Error: ${res.status} ${res.statusText}`);
  return res.json();
}

async function gh_get_content(){
  const url=`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/contents/${ghCfg.path}?ref=${ghCfg.branch}`;
  const file=await gh_api(url,'GET');
  if(!file || file.type!=='file' || !file.content) throw new Error('الملف غير موجود أو ليس ملفاً');
  const content=atob(file.content);
  return {content, sha:file.sha};
}

async function gh_put_content(content, sha){
  const url=`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/contents/${ghCfg.path}`;
  const msg='Sync: Automatic update from Personal Finance App';
  const data={
    message:msg,
    content:btoa(content),
    sha:sha,
    branch:ghCfg.branch
  };
  return gh_api(url,'PUT',data);
}

async function gh_create_branch(){
  if(ghCfg.branch==='main' || ghCfg.branch==='master') return;
  const repoInfo=await gh_api(`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}`,'GET');
  if(repoInfo?.size===0){
    throw new Error('المستودع فارغ. أنشئ أول commit (مثل README) من GitHub قبل الرفع.');
  }
  const baseBranch=repoInfo?.default_branch || 'main';
  const baseRef=await gh_api(`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/git/ref/heads/${baseBranch}`,'GET');
  const sha=baseRef?.object?.sha;
  if(!sha){
    throw new Error('تعذّر الحصول على المرجع الأساسي لإنشاء الفرع الهدف.');
  }
  try{
    await gh_api(`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/git/refs`,'POST',{ref:`refs/heads/${ghCfg.branch}`, sha});
  } catch(e){
    if(e.message.includes('Reference already exists')) return; // الفرع موجود مسبقاً
    throw e;
  }
}

async function ghTest(){
  readGhFormToCfg();
  if(!ghCfg.user||!ghCfg.repo||!ghCfg.token){ ghStatus('أكمل الإعدادات أولاً',false); return; }
  try{
    await gh_api(`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}`,'GET');
    ghStatus('الاتصال ناجح',true);
  }
  catch(e){ ghStatus('فشل الاتصال: '+e.message,false); }
}

async function ghPull(){
  readGhFormToCfg();
  if(!ghCfg.user||!ghCfg.repo||!ghCfg.token){ ghStatus('أكمل الإعدادات أولاً',false); return; }
  ghStatus('جاري التحميل...',false);
  try{
    const {content}=await gh_get_content();
    const data=JSON.parse(content);
    
    // استبدال البيانات المحلية ببيانات GitHub
    if(Array.isArray(data.ledger)) ledger=data.ledger;
    if(Array.isArray(data.accounts)) accounts=data.accounts;
    if(Array.isArray(data.categories)) categories=data.categories;
    if(Array.isArray(data.commitments)) commitments=data.commitments;
    if(Array.isArray(data.collections)) collections=data.collections;

    // توحيد الحسابات والفئات الأساسية
    ensureBaseCategories();
    commitments=commitments.map(c=>migrateCommit(c));
    collections=collections.map(c=>migrateCollect(c));

    saveLedger(); saveAccounts(); saveCategories(); saveCommitments(); saveCollections();
    refreshAccountSelects(); refreshCategorySelect(); drawCatsBadges();
    drawCommitments(); drawCollections(); drawDueSoon(); render();

    ghStatus('تم التحميل بنجاح',true);
    alert('تم تحميل البيانات من GitHub بنجاح.');
  }
  catch(e){ ghStatus('فشل التحميل: '+e.message,false); }
}

async function ghPush(){
  readGhFormToCfg();
  if(!ghCfg.user||!ghCfg.repo||!ghCfg.token){
    if(!ghCfg.auto) ghStatus('أكمل الإعدادات أولاً',false);
    return;
  }
  ghStatus('جاري الرفع...',false);
  try{
    const data={
      ledger, accounts, categories, commitments, collections,
      exportedAt:new Date().toISOString()
    };
    const content=JSON.stringify(data,null,2);

    // 1. التأكد من وجود الفرع
    await gh_create_branch();
    
    // 2. محاولة الحصول على الـ SHA للملف (لتحديثه)
    let sha=null;
    try{
      const fileInfo=await gh_get_content();
      sha=fileInfo.sha;
    } catch(e){
      if(!e.message.includes('الملف غير موجود')) throw e; // إذا كان خطأ آخر، أعد رمي الخطأ
      // الملف غير موجود، SHA سيبقى null وسيتم إنشاء الملف
    }

    // 3. رفع المحتوى
    await gh_put_content(content, sha);
    ghStatus('تم الرفع بنجاح',true);
  }
  catch(e){ ghStatus('فشل الرفع: '+e.message,false); }
}

els.ghSaveCfg?.addEventListener('click', ghSaveCfg);
els.ghTest?.addEventListener('click', ghTest);
els.ghPull?.addEventListener('click', ghPull);
els.ghPush?.addEventListener('click', ghPush);
els.syncNow?.addEventListener('click', ghPush);

/* ===== تهيئة ===== */
function refreshCategorySelect(){
  if(!els.type) return;
  const cats = categories.filter(c=>c.type===els.type.value);
  els.category.innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
}
function init(){
  if(accounts.length===0){
    accounts=[{name:'كاش',opening:0},{name:'حساب بنكي',opening:0},{name:'محفظة',opening:0}];
    saveAccounts();
  }
  ensureBaseCategories();
  initCollapsibles();
  commitments=commitments.map(c=>migrateCommit(c));
  collections=collections.map(c=>migrateCollect(c));
  saveCommitments(); saveCollections();
  ensureTransferCategories();

  if(els.monthPicker){
    const today=YM();
    if(!els.monthPicker.value) els.monthPicker.value=today;
    els.monthPicker.setAttribute('max', today);
  }

  refreshAccountSelects(); refreshCategorySelect(); drawCatsBadges();
  drawCommitments(); drawCollections(); drawDueSoon(); render();
  fillGhFormFromStorage();
  els.cEndAt?.toggleAttribute('required', els.cRecurring?.checked);
  els.coEndAt?.toggleAttribute('required', els.coRecurring?.checked);
}
init();
</script>
</body>
</html>
