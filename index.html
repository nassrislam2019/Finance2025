<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساباتي — تتبُّع المصروفات والدخل</title>
<meta name="description" content="موقع شخصي بسيط لإدارة المصروفات والدخل — يعمل أوفلاين (PWA) ويحفظ البيانات محليًا." />
<meta name="theme-color" content="#ffffff" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ffffff; --card:#f2f2f2; --muted:#555; --txt:#000;
  --brand:#0077cc; --brand-2:#3399ff; --danger:#ef4444; --warn:#f59e0b; --ok:#22c55e; --border:#d0d0d0;
  --radius:14px; --field-h:46px;
}
body,h1,h2,h3,h4,h5,h6,p,div,span,li,a,button{font-family:"Cairo",sans-serif!important}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--txt)}
a{color:var(--brand);text-decoration:none}
.container{max-width:1180px;margin-inline:auto;padding:20px}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:0;overflow:hidden;margin-bottom:12px}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
.card-head h3{margin:0;font-size:18px}
.card-body{padding:14px;border-top:1px solid var(--border)}
.card.collapsed .card-body{display:none}
.toggle{appearance:none;border:none;background:transparent;cursor:pointer;border-radius:10px;font-size:18px;padding:6px 10px;color:#333}

/* Layout */
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,textarea{width:100%;background:#fff;color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;height:var(--field-h)}
input[type="date"],input[type="month"]{direction:ltr;text-align:center;font-variant-numeric:tabular-nums}
.checkbox-row{display:flex;align-items:center;gap:8px}
.checkbox-row input[type="checkbox"]{width:18px;height:18px}

.btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:opacity .15s;height:var(--field-h)}
.btn:hover{opacity:.95}
.btn-primary{background:var(--brand);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--txt)}
.btn-danger{background:var(--danger);color:#fff}
.btn-muted{background:#e6e6e6;color:var(--muted);border:1px dashed var(--border)}

.stats{display:grid;gap:10px}
@media(min-width:720px){.stats{grid-template-columns:repeat(5,1fr)}}
.stat{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:12px}
.stat small{color:var(--muted)}
.stat .num{font-weight:800;font-size:22px;margin-top:4px}
.pos{color:var(--ok)}.neg{color:var(--danger)}.warn{color:var(--warn)}

.report-table-wrap{overflow:auto;max-height:340px}
#tbodyMonthly tr.active{background:rgba(0,119,204,0.1);box-shadow:0 0 0 1px rgba(0,119,204,0.3)}

.month-insights{margin-top:18px;display:grid;gap:16px}
.month-stats{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.month-stats .stat{background:#fff}
.month-selected{font-weight:700;font-size:18px;margin-top:6px}
.month-note{color:var(--muted);font-size:12px}
.month-cats{gap:16px}
.month-cats h4{margin:0 0 10px;font-size:15px;color:var(--muted)}
.bar-list{display:flex;flex-direction:column;gap:10px}
.bar-item{display:grid;gap:6px}
.bar-item .label{font-size:13px;font-weight:600;color:var(--txt)}
.bar-item .bar-track{background:#f1f5f9;border-radius:999px;height:26px;position:relative;overflow:hidden}
.bar-item .bar-fill{position:absolute;left:0;top:0;bottom:0;width:var(--w,0%);border-radius:999px;display:flex;align-items:center;justify-content:flex-end;padding-inline:12px;font-weight:700;color:#fff;font-size:13px;transition:width .3s ease}
.bar-item .bar-fill span{position:relative;z-index:1}
.bar-item .bar-fill.expense{background:linear-gradient(90deg,#fb7185,#ef4444)}
.bar-item .bar-fill.income{background:linear-gradient(90deg,#34d399,#22c55e)}
.bar-item .value{font-size:12px;color:var(--muted)}
.empty-state{padding:12px;border:1px dashed var(--border);border-radius:var(--radius);text-align:center;font-size:13px;color:var(--muted)}
.report-legend{display:flex;gap:12px;font-size:12px;color:var(--muted);align-items:center;flex-wrap:wrap;margin-top:8px}
.legend-dot{width:12px;height:12px;border-radius:999px;display:inline-block}

table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:right;padding:6px 10px}
tbody tr{background:#fff;border:1px solid var(--border);border-radius:var(--radius)}
tbody td{padding:12px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
tbody tr td:first-child{border-right:1px solid var(--border);border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
tbody tr td:last-child{border-left:1px solid var(--border);border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
.amount.exp{color:var(--danger);font-weight:700}.amount.inc{color:var(--ok);font-weight:700}

.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.spacer{flex:1}
.badge{display:inline-flex;gap:6px;align-items:center;background:#e6e6e6;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:var(--field-h)}
.badge-group{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
.footer{margin-top:24px;color:var(--muted);font-size:12px;text-align:center}
.note{color:var(--warn)}
canvas{background:#fff;border:1px solid var(--border);border-radius:var(--radius);display:block;width:100%;height:320px}
.hr{height:1px;background:var(--border);opacity:.7;margin:12px 0;border-radius:999px}
.list-plain{display:flex;flex-wrap:wrap;gap:8px}
.list-plain .item{background:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:12px}

/* تحويل */
.transfer-grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
.transfer-grid .full{grid-column:1/-1}
@media(max-width:900px){.transfer-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:720px){
  .grid-2{grid-template-columns:1fr}
  .grid-4{grid-template-columns:1fr 1fr}
  .badge{height:auto}
  .card-head h3{font-size:17px}
  .transfer-grid{grid-template-columns:1fr}
}

/* ===== استحقاقات قريبة ===== */
.d-none{display:none!important;} /* للتحكم من JS بدون كسر الميديا */

#dueSoonWrap{overflow:auto;-webkit-overflow-scrolling:touch;}
#dueSoonWrap table{min-width:760px;}
#dueSoon td.actions{white-space:nowrap;}
#dueSoonCards{display:none;}      /* افتراضيًا مخفي */

/* على الشاشات الصغيرة: نخفي الجدول ونُظهر الكروت */
@media(max-width:720px){
  #dueSoonWrap{display:none;}
  #dueSoonCards{display:block;}
  .month-stats{grid-template-columns:1fr 1fr;}
  .month-cats{grid-template-columns:1fr;}
  .report-table-wrap{max-height:none;}
}

/* بطاقات الموبايل */
.due-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;display:grid;gap:6px}
.due-card .row{display:flex;justify-content:space-between;gap:8px}
.due-card .name{font-weight:700}
.due-card .remain{font-weight:800}
.due-card .state{color:var(--warn);font-weight:700}
.due-card .state.over{color:var(--danger)}
.due-card .meta{color:var(--muted);font-size:12px}
.due-card .actions{display:flex;gap:8px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <div class="title">دفتر حساباتي</div>
      <div class="sub">تتبُّع المصروفات والدخل — يعمل أوفلاين (PWA) والبيانات محفوظة محليًا</div>
    </div>
    <div class="toolbar">
      <button id="exportJson" class="btn btn-outline" type="button">تصدير JSON</button>
      <button id="exportCsv" class="btn btn-outline" type="button">تصدير CSV</button>
      <label class="btn btn-muted" for="importFile">استيراد JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
      <button id="syncNow" class="btn btn-outline" type="button">مزامنة الآن</button>
      <button id="installBtn" class="btn btn-outline" type="button" style="display:none">تثبيت التطبيق</button>
    </div>
  </header>

  <!-- (1) ملخص الحسابات -->
  <section class="card" id="card-balance" data-lock="true">
    <div class="card-head"><h3>ملخص الحسابات</h3></div>
    <div class="card-body">
      <div class="stats">
        <div class="stat"><small>إجمالي الأرصدة</small><div id="totalBalance" class="num">0</div></div>
        <div class="stat"><small>دخل الشهر الجاري</small><div id="monthIncome" class="num pos">0</div></div>
        <div class="stat"><small>التزامات الشهر الجاري</small><div id="monthCommitTotal" class="num neg">0</div></div>
        <!-- تمت إزالة: بعد التحصيلات والالتزامات + عدد الحركات -->
        <div class="stat"><small>استحقاقات الشهر الحالي</small><div id="monthDueTotal" class="num neg">0</div></div>
        <div class="stat"><small>استحقاقات الشهر القادم</small><div id="monthNextDueTotal" class="num warn">0</div></div>
      </div>
      <div class="hr"></div>
      <div>
        <h3 style="margin:0 0 8px;font-size:14px;color:var(--muted)">تفاصيل الأرصدة بالحساب</h3>
        <div id="perAccount" class="list-plain"></div>
      </div>
    </div>
  </section>

  <!-- (A) كارت الاستحقاقات القريبة -->
  <section class="card" id="card-dueSoon" style="margin-top:12px" data-collapsible>
    <div class="card-head">
      <h3>استحقاقات قريبة</h3>
      <button class="toggle" aria-expanded="true" title="عرض/إخفاء">▾</button>
      <div class="badge-group">
        <span id="dueTotalBadge" class="badge" title="إجمالي المتبقّي لهذا الشهر">إجمالي: 0.00 ج.م</span>
        <span id="dueNextTotalBadge" class="badge" title="إجمالي الاستحقاقات للشهر القادم">الشهر القادم: 0.00 ج.م</span>
      </div>
    </div>
    <div class="card-body" id="dueSoon">
      <!-- جدول للديسكتوب/التابلت -->
      <div id="dueSoonWrap">
        <table style="width:100%">
          <thead><tr>
            <th>الاسم</th><th>التاريخ</th><th>الأصل</th><th>المدفوع</th>
            <th>المتبقي</th><th>الشهر</th><th>الحالة</th><th>إجراءات</th>
          </tr></thead>
          <tbody id="tbodyDueSoon"></tbody>
        </table>
      </div>
      <!-- بطاقات للموبايل -->
      <div id="dueSoonCards"></div>
      <div id="noDueSoon" class="d-none" style="color:var(--muted)">لا توجد استحقاقات هذا الشهر/الشهر القادم غير مسددة.</div>
    </div>
  </section>

  <div class="hr"></div>

  <!-- (2) إدارة الحسابات + الفئات (مختصرة للتركيز على المطلوب) -->
  <div class="grid grid-2">
    <section class="card collapsed" id="card-accounts" data-collapsible>
      <div class="card-head"><h3>إدارة الحسابات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
      <div class="card-body">
        <div class="grid grid-3">
          <div><label>اسم الحساب</label><input id="newAccountName" placeholder="مثال: كاش/محفظة" /></div>
          <div><label>رصيد افتتاحي</label><input id="newAccountOpening" type="number" step="0.01" placeholder="0.00" /></div>
          <div><label>&nbsp;</label><button id="addAccount" class="btn btn-outline" style="width:100%">إضافة حساب</button></div>
        </div>
        <div id="accountsList" class="toolbar" style="margin-top:8px;flex-wrap:wrap"></div>
      </div>
    </section>

    <section class="card collapsed" id="card-cats" data-collapsible>
      <div class="card-head"><h3>إدارة الفئات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
      <div class="card-body">
        <div class="grid grid-3">
          <div><label>اسم الفئة</label><input id="newCatName" placeholder="مثال: أكل" /></div>
          <div><label>النوع</label><select id="newCatType"><option value="expense" selected>مصروف</option><option value="income">دخل</option></select></div>
          <div><label>&nbsp;</label><button id="addCategory" class="btn btn-outline" style="width:100%">إضافة فئة</button></div>
        </div>
        <div id="catsList" class="toolbar" style="margin-top:8px;flex-wrap:wrap"></div>
      </div>
    </section>
  </div>

  <div class="footer">
    <div>⚠️ <span class="note">تنبيه:</span> كل البيانات محفوظة محليًا في <code>localStorage</code>. لا تنسَ التصدير كنسخة احتياطية.</div>
    <div style="margin-top:6px">تقدر تثبّت الموقع كتطبيق لأنه PWA.</div>
  </div>
</div>

<script>
/* ===== مفاتيح التخزين ===== */
const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1',
      COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1';

/* ===== الحالة ===== */
let ledger=JSON.parse(localStorage.getItem(KEY)||'[]');
let accounts=JSON.parse(localStorage.getItem(ACC_KEY)||'[]');
let categories=JSON.parse(localStorage.getItem(CAT_KEY)||'[]');
let commitments=JSON.parse(localStorage.getItem(COM_KEY)||'[]');  // {payments:{'YYYY-MM':number}}
let collections=JSON.parse(localStorage.getItem(COL_KEY)||'[]');

/* افتراضات أولية */
function ensureBaseCategories(){
  const need=[
    {name:'التزامات شهرية',type:'expense'},
    {name:'تحصيلات شهرية',type:'income'},
    {name:'تحويل صادر',type:'expense'},
    {name:'تحويل وارد',type:'income'},
    {name:'عمولة تحويل',type:'expense'},
  ];
  let changed=false;
  if(categories.length===0){
    categories=[
      {name:'مرتب',type:'income'},{name:'دخل آخر',type:'income'},
      {name:'أكل وشرب',type:'expense'},{name:'مواصلات',type:'expense'},{name:'فواتير',type:'expense'},{name:'تسوق',type:'expense'}
    ];
    changed=true;
  }
  for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } }
  if(changed) saveCategories();
}

/* DOM */
const $=s=>document.querySelector(s);
const els={
  totalBalance:$('#totalBalance'),
  monthCommitTotal:$('#monthCommitTotal'),
  monthIncome:$('#monthIncome'),
  perAccount:$('#perAccount'),
  /* جديدة */
  monthDueTotal:$('#monthDueTotal'),
  monthNextDueTotal:$('#monthNextDueTotal'),
  /* استحقاقات قريبة */
  dueTotalBadge:$('#dueTotalBadge'),
  dueNextTotalBadge:$('#dueNextTotalBadge')
};

/* Utils */
const eid=()=>Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const fmt=n=>Number(n).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const escapeHtml=s=>String(s).replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
function formatLocalDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function parseLocalDate(str){const [y,m,d]=str.split('-').map(Number);const dt=new Date(y,m-1,d,0,0,0,0);dt.setHours(0,0,0,0);return dt;}
function startOfToday(){const t=new Date();t.setHours(0,0,0,0);return t;}
function addMonthsPreserveDOM(date,months){const d=new Date(date.getTime());const targetMonth=d.getMonth()+months;const day=d.getDate(),y=d.getFullYear();const temp=new Date(y,targetMonth+1,0);const lastDay=temp.getDate();d.setMonth(targetMonth,Math.min(day,lastDay));d.setHours(0,0,0,0);return d;}
function daysBetween(a,b){const MS=24*60*60*1000;const da=new Date(a.getFullYear(),a.getMonth(),a.getDate());const db=new Date(b.getFullYear(),b.getMonth(),b.getDate());return Math.round((db-da)/MS);}
const YM=()=>formatLocalDate(startOfToday()).slice(0,7);
const addMonthsToYm=(ym, months)=>{
  const parts=(ym||'').split('-').map(Number);
  const y=parts[0], m=parts[1];
  if(!Number.isFinite(y)||!Number.isFinite(m)) return ym;
  const base=new Date(y,m-1,1);
  const next=addMonthsPreserveDOM(base, months);
  return formatLocalDate(next).slice(0,7);
};
const monthLabel=ym=>{ if(!ym) return '—'; const [y,m]=ym.split('-').map(Number); if(!Number.isFinite(y)||!Number.isFinite(m)) return ym; const dt=new Date(y,m-1,1); return dt.toLocaleDateString('ar-EG',{month:'long',year:'numeric'}); };

/* ===== حفظ ===== */
function saveLedger(){ localStorage.setItem(KEY, JSON.stringify(ledger)); }
function saveAccounts(){ localStorage.setItem(ACC_KEY, JSON.stringify(accounts)); refreshAccountSelects(); drawAccountsBadges(); recalc(); }
function saveCategories(){ localStorage.setItem(CAT_KEY, JSON.stringify(categories)); drawCatsBadges(); }
function saveCommitments(){ localStorage.setItem(COM_KEY, JSON.stringify(commitments)); drawCommitments(); drawDueSoon(); recalc(); }
function saveCollections(){ localStorage.setItem(COL_KEY, JSON.stringify(collections)); drawCollections(); recalc(); }

/* ===== قوائم الحساب/الفئات (مختصرة) ===== */
function buildAccountOptions(excludeName){
  return accounts.filter(a=>a.name!==excludeName).map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
}
function refreshAccountSelects(){}

/* ===== حساب الأرصدة ===== */
function computeBalances(){
  const bal = new Map(accounts.map(a=>[a.name, a.opening||0]));
  const sorted=[...ledger].sort((a,b)=> a.date.localeCompare(b.date) || (a.id>b.id?1:-1));
  for(const t of sorted){
    const cur=bal.get(t.account)??0;
    const delta=(t.type==='income'?t.amount:-t.amount);
    const next=cur+delta;
    bal.set(t.account,next);
  }
  return {bal};
}
function drawPerAccount(balMap){
  const items=[]; for(const a of accounts){const v=balMap.get(a.name)??a.opening??0; items.push(`<span class="item">${escapeHtml(a.name)} · <b>${fmt(v)} ج.م</b></span>`);}
  for(const [name,val] of balMap){ if(!accounts.some(a=>a.name===name)){ items.push(`<span class="item">⚠️ ${escapeHtml(name)} · <b>${fmt(val)} ج.م</b></span>`);} }
  if(els.perAccount) els.perAccount.innerHTML=items.join('');
}

/* ===== دفعات الالتزامات ===== */
function ensurePaymentsObj(c){ if(!c.payments) c.payments={}; }

/* ===== إجماليات الشهر ===== */
function sumCurrentMonthCommitments(){
  const ym=YM();
  let total=0;
  for(const c of commitments){
    const dueStr=c.nextDue||c.firstDue; if(!dueStr) continue;
    if(dueStr.slice(0,7)!==ym) continue;
    const paid=(c.payments?.[ym]||0);
    const remain=(Number(c.amount||0)-paid);
    total += Math.max(remain,0);
  }
  return total;
}
function sumCurrentMonthIncome(){
  const ym=YM();
  return ledger.filter(t=>!t.isTransfer && t.type==='income' && t.date.slice(0,7)===ym)
               .reduce((s,t)=>s+t.amount,0);
}

/* ===== إعادة الحساب + الملخص ===== */
function recalc(){
  const {bal}=computeBalances(); let total=0; for(const v of bal.values()) total+=v;

  // التزامات/دخل الشهر الحالي
  const monthComRemain = sumCurrentMonthCommitments();
  const monthInc = sumCurrentMonthIncome();

  // إجمالي استحقاقات الشهر الحالي والقادم
  const ym = YM();
  const nextYm = addMonthsToYm(ym, 1);
  let currentDue = 0, nextDue = 0;

  for(const c of commitments){
    const dueStr = c.nextDue || c.firstDue;
    if(!dueStr) continue;
    const dueYm = dueStr.slice(0,7);

    const paidNow = c.payments?.[ym] || 0;
    const paidNext = c.payments?.[nextYm] || 0;
    const remainNow = Math.max(0, Number(c.amount || 0) - paidNow);
    const remainNext = Math.max(0, Number(c.amount || 0) - paidNext);

    if(dueYm === ym) currentDue += remainNow;
    if(dueYm === nextYm) nextDue += remainNext;
  }

  if(els.totalBalance) els.totalBalance.textContent=fmt(total);
  if(els.monthCommitTotal) els.monthCommitTotal.textContent='-'+fmt(monthComRemain);
  if(els.monthIncome) els.monthIncome.textContent=fmt(monthInc);
  if(els.monthDueTotal) els.monthDueTotal.textContent=fmt(currentDue);
  if(els.monthNextDueTotal) els.monthNextDueTotal.textContent=fmt(nextDue);

  drawPerAccount(bal);
}

/* ==== الالتزامات (جدول مبسط) ==== */
function migrateCommit(c){
  if(!c.nextDue && c.firstDue){ c.nextDue=c.firstDue; }
  if(typeof c.recurring!=='boolean') c.recurring=false;
  if(c.endAt===undefined) c.endAt=null;
  if(!c.payments) c.payments={};
  return c;
}
function drawCommitments(){/* ليس محور طلبك الآن */}

/* ==== التحصيل (اختياري) ==== */
function drawCollections(){/* ليس محور طلبك الآن */}

/* ===== الاستحقاقات القريبة: جدول + بطاقات ===== */
/* المطلوب: "استحقاقات الشهر القادم تشمل استحقاقات الشهر الجارى التى لم تُسدد حتى الآن" */
function drawDueSoon(){
  const wrap=document.getElementById('dueSoonWrap'),
        none=document.getElementById('noDueSoon'),
        tbody=document.getElementById('tbodyDueSoon'),
        cards=document.getElementById('dueSoonCards');
  if(!wrap||!tbody||!cards) return;

  const ym=YM();
  const nextYm=addMonthsToYm(ym,1);
  const today=startOfToday();

  const inMonth = (c, targetYm)=>{
    const dueStr=c.nextDue||c.firstDue; if(!dueStr) return false;
    return dueStr.slice(0,7)===targetYm;
  };

  // قائمة الشهر الحالي (غير المسدد)
  const listNow=commitments.map(c=>{
    const dueStr=c.nextDue||c.firstDue; if(!dueStr) return null;
    if(!inMonth(c, ym)) return null;
    const paid=(c.payments?.[ym]||0); const total=Number(c.amount||0); const remaining=Math.max(0,total-paid);
    if(remaining<=0) return null;
    const due=parseLocalDate(dueStr);
    const diff=daysBetween(today,due);
    return {...c,due,dueStr,total,paid,remaining,diff,month:ym};
  }).filter(Boolean);

  // قائمة الشهر القادم (مضاف لها المتبقي من الشهر الحالي حسب الطلب)
  const listNext=commitments.map(c=>{
    const dueStr=c.nextDue||c.firstDue; if(!dueStr) return null;
    if(!inMonth(c, nextYm)) return null;
    const paidNext=(c.payments?.[nextYm]||0); const total=Number(c.amount||0); const remainingNext=Math.max(0,total-paidNext);
    if(remainingNext<=0) return null;
    const due=parseLocalDate(dueStr);
    const diff=daysBetween(today,due);
    return {...c,due,dueStr,total,paid:paidNext,remaining:remainingNext,diff,month:nextYm};
  }).filter(Boolean);

  // الإجماليات
  const totalNow = listNow.reduce((s,x)=>s+x.remaining,0);
  const totalNextOnly = listNext.reduce((s,x)=>s+x.remaining,0);
  const totalNextCombined = totalNextOnly + totalNow; // يشمل الشهر الجاري غير المسدد

  // تحديث البادجات
  if(els.dueTotalBadge){
    els.dueTotalBadge.textContent = `إجمالي (${monthLabel(ym)}): ${fmt(totalNow)} ج.م`;
    els.dueTotalBadge.title = `إجمالي استحقاقات ${monthLabel(ym)} المتبقية`;
  }
  if(els.dueNextTotalBadge){
    els.dueNextTotalBadge.textContent = `الشهر القادم (${monthLabel(nextYm)} + متبقي ${monthLabel(ym)}): ${fmt(totalNextCombined)} ج.م`;
    els.dueNextTotalBadge.title = `يشمل ${monthLabel(nextYm)} + المتبقي غير المسدد من ${monthLabel(ym)}`;
  }

  // دمج القائمتين للعرض (عشان تشوف الاثنين سوا بوضوح)
  const list = [...listNow, ...listNext].sort((a,b)=> a.dueStr.localeCompare(b.dueStr));

  if(list.length===0){
    wrap.classList.add('d-none');
    cards.classList.add('d-none');
    none.classList.remove('d-none');
    tbody.innerHTML='';
    cards.innerHTML='';
    return;
  }

  none.classList.add('d-none');
  wrap.classList.remove('d-none');
  cards.classList.remove('d-none');

  // جدول
  tbody.innerHTML=list.map(x=>{
    const state = x.diff<0 ? `<span style="color:var(--danger);font-weight:700">متأخر ${Math.abs(x.diff)} يوم</span>`
                 : x.diff===0 ? `<span style="color:var(--warn);font-weight:700">اليوم</span>`
                 : `<span style="color:var(--warn);font-weight:700">متبقي ${x.diff} يوم</span>`;
    const monthTxt = x.month===ym ? 'الشهر الحالي' : 'الشهر القادم';
    return `<tr>
      <td>${escapeHtml(x.name)}</td>
      <td>${x.dueStr}</td>
      <td>${fmt(x.total)}</td>
      <td>${fmt(x.paid)}</td>
      <td><b>${fmt(x.remaining)}</b></td>
      <td>${monthTxt}</td>
      <td>${state}</td>
      <td class="actions"><button class="btn btn-primary" onclick='payCommit("${x.id}")'>سداد الآن</button></td>
    </tr>`;
  }).join('');

  // بطاقات للموبايل
  cards.innerHTML = list.map(x=>{
    const over = x.diff<0;
    const state = over ? `متأخر ${Math.abs(x.diff)} يوم` : (x.diff===0 ? 'اليوم' : `متبقي ${x.diff} يوم`);
    const stateCls = over ? 'state over' : 'state';
    const monthTxt = x.month===ym ? 'الشهر الحالي' : 'الشهر القادم';
    return `
      <div class="due-card">
        <div class="row"><div class="name">${escapeHtml(x.name)}</div><div class="remain">${fmt(x.remaining)} ج.م</div></div>
        <div class="row meta"><div>الأصل: ${fmt(x.total)} · المدفوع: ${fmt(x.paid)}</div><div>${x.dueStr} · ${monthTxt}</div></div>
        <div class="${stateCls}">${state}</div>
        <div class="actions">
          <button class="btn btn-primary" onclick='payCommit("${x.id}")' style="flex:1">سداد الآن</button>
        </div>
      </div>
    `;
  }).join('');
}

/* ===== سداد الالتزام (مبسطة) ===== */
function payCommit(id){
  const c=commitments.find(x=>x.id===id); if(!c) return;
  const ym= (c.nextDue||c.firstDue||'').slice(0,7) || YM();
  const paid=(c.payments?.[ym]||0);
  const remain=Math.max(0,(Number(c.amount||0)-paid));
  if(remain<=0){ alert('لا يوجد مبلغ متبقٍ لهذا الشهر.'); return; }
  if(!confirm(`سداد "${c.name}" بمبلغ ${fmt(remain)} ج.م ؟`)) return;
  if(!c.payments) c.payments={};
  c.payments[ym]=(c.payments[ym]||0)+remain;
  // لو اكتمل السداد للشهر الحالي انقل nextDue للشهر التالي لو متكرر
  if(c.payments[ym] >= Number(c.amount||0)-1e-9){
    const due=parseLocalDate(c.nextDue||c.firstDue);
    if(c.recurring){
      const next=addMonthsPreserveDOM(due,1);
      if(c.endAt && next>parseLocalDate(c.endAt)){ // انتهى
        commitments=commitments.filter(xx=>xx.id!==id);
      }else{
        c.nextDue=formatLocalDate(next);
      }
    }else{
      commitments=commitments.filter(xx=>xx.id!==id);
    }
  }
  saveCommitments(); drawDueSoon(); recalc();
}

/* ===== كروت الطي/الفتح ===== */
function initCollapsibles(){
  document.querySelectorAll('[data-collapsible]').forEach(sec=>{
    const btn=sec.querySelector('.toggle'); if(!btn) return;
    btn.addEventListener('click',()=>{
      const isCollapsed=sec.classList.toggle('collapsed');
      btn.textContent=isCollapsed?'▸':'▾'; btn.setAttribute('aria-expanded',String(!isCollapsed));
    });
    // الحالة الافتراضية حسب وجود class
    const isCollapsed=sec.classList.contains('collapsed');
    btn.textContent=isCollapsed?'▸':'▾';
    btn.setAttribute('aria-expanded',String(!isCollapsed));
  });
}

/* ===== إعداد بيانات تجريبية عند أول تشغيل ===== */
function seedIfEmpty(){
  if(accounts.length===0){
    accounts=[{name:'كاش',opening:0},{name:'حساب بنكي',opening:0},{name:'محفظة',opening:0}];
    saveAccounts();
  }
  if(commitments.length===0){
    const ym=YM(), nextYm=addMonthsToYm(ym,1);
    commitments=[
      {id:eid(),name:'إيجار',amount:3000,firstDue:`${ym}-05`,nextDue:`${ym}-05`,recurring:true,payments:{}},
      {id:eid(),name:'إنترنت',amount:400,firstDue:`${ym}-10`,nextDue:`${ym}-10`,recurring:true,payments:{}},
      {id:eid(),name:'قسط موبايل',amount:600,firstDue:`${nextYm}-12`,nextDue:`${nextYm}-12`,recurring:true,payments:{}},
    ];
    saveCommitments();
  }
  if(categories.length===0) ensureBaseCategories();
}

/* ===== تهيئة ===== */
function init(){
  seedIfEmpty();
  ensureBaseCategories();
  initCollapsibles();
  commitments=commitments.map(c=>migrateCommit(c));
  saveCommitments(); // يعيد رسم الاستحقاقات ويحدّث الملخص
  recalc();
  drawDueSoon();

  // زرّار تصدير/استيراد بسيط
  document.getElementById('exportJson')?.addEventListener('click',()=>{
    const data={ledger,accounts,categories,commitments,collections,exportedAt:new Date().toISOString()};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='my-finance-data.json'; a.click(); URL.revokeObjectURL(a.href);
  });
  document.getElementById('exportCsv')?.addEventListener('click',()=>{
    const header=['id','date','desc','type','amount','account','category'];
    const rows=[...ledger].sort((a,b)=> a.date.localeCompare(b.date) || (a.id>b.id?1:-1))
                          .map(t=>[t.id,t.date,(''+(t.desc||'')).replace(/"/g,'""'),t.type,t.amount,t.account,t.category]);
    const csv=[header.join(','), ...rows.map(r=>r.map(x=>/[,\"\n]/.test(String(x))?`"${String(x).replace(/"/g,'""')}"`:x).join(','))].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='transactions.csv'; a.click(); URL.revokeObjectURL(a.href);
  });
  document.getElementById('importFile')?.addEventListener('change', async (e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    try{
      const text=await file.text(); const data=JSON.parse(text);
      if(Array.isArray(data.ledger)) ledger=data.ledger;
      if(Array.isArray(data.accounts)) accounts=data.accounts;
      if(Array.isArray(data.categories)) categories=data.categories;
      if(Array.isArray(data.commitments)) commitments=data.commitments.map(migrateCommit);
      if(Array.isArray(data.collections)) collections=data.collections;
      saveLedger(); saveAccounts(); saveCategories(); saveCommitments(); saveCollections();
      drawDueSoon(); recalc();
      alert('تم الاستيراد بنجاح');
    }catch(err){ alert('خطأ أثناء الاستيراد: '+err.message); }
    e.target.value='';
  });
}
init();
</script>
</body>
</html>