<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ â€” ÙƒØ§Ù…Ù„</title>
<meta name="description" content="ØªØ·Ø¨ÙŠÙ‚ ØªØªØ¨Ø¹ Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ¯Ø®Ù„ - ÙƒØ§Ù…Ù„" />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#ffffff; --card:#f8fafc; --muted:#586069; --txt:#062028;
  --brand:#0ea5e9; --danger:#ef4444; --warn:#f59e0b; --ok:#16a34a; --border:#e6eef3;
  --radius:12px; --field-h:44px;
}
*{box-sizing:border-box;font-family:"Cairo",sans-serif}
body{margin:0;background:var(--bg);color:var(--txt);padding:18px}
.container{max-width:1150px;margin-inline:auto}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.title{font-size:20px;font-weight:700}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.btn-outline{background:transparent;border:1px solid var(--border)}
.btn-primary{background:var(--brand);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-top:14px;overflow:hidden}
.card-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px}
.card-body{padding:14px;border-top:1px solid var(--border)}
.stats{display:grid;gap:10px}
@media(min-width:900px){.stats{grid-template-columns:repeat(5,1fr)}}
.stat{background:#fff;padding:12px;border-radius:10px;border:1px solid var(--border)}
.stat small{color:var(--muted);font-size:12px}
.stat .num{font-weight:800;font-size:18px;margin-top:6px}
.list-plain{display:flex;flex-wrap:wrap;gap:8px}
.item{background:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:8px}
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-3{grid-template-columns:repeat(3,1fr)}
.form-row{display:flex;gap:8px;align-items:center}
.input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);height:var(--field-h);background:#fff}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse}
thead th{font-size:13px;color:var(--muted);padding:8px;text-align:right;border-bottom:1px solid var(--border)}
tbody td{padding:10px;border-bottom:1px solid #f1f5f9;background:#fff}
.badge{background:#eef2f7;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:13px}
.small{font-size:13px;color:var(--muted)}
.due-card{background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px;margin-bottom:8px}
.right{direction:rtl;text-align:right}
.row{display:flex;justify-content:space-between;align-items:center;gap:8px}
.small-muted{font-size:12px;color:var(--muted)}
.exec-dt{font-size:12px;color:#3b82f6}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</div>
      <div class="small-muted">ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø±ÙƒØ§ØªØŒ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§ØªØŒ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
    </div>
    <div class="toolbar">
      <button id="exportJson" class="btn btn-outline">ØªØµØ¯ÙŠØ± JSON</button>
      <button id="importBtn" class="btn btn-outline">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button id="syncNow" class="btn btn-outline">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†</button>
      <button id="seedBtn" class="btn btn-outline">Ø£ÙØ±Øº Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
    </div>
  </div>

  <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
  <section class="card" id="card-balance">
    <div class="card-head"><strong>Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</strong><div class="small-muted">ØªØ­Ø¯ÙŠØ« Ø¢Ù†ÙŠ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙÙ€Ø©</div></div>
    <div class="card-body">
      <div class="stats">
        <div class="stat"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©</small><div id="totalBalance" class="num">0</div></div>
        <div class="stat"><small>Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø§Ø±ÙŠ</small><div id="monthIncome" class="num">0</div></div>
        <div class="stat"><small>Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø§Ø±ÙŠ (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ)</small><div id="monthCommitTotal" class="num">0</div></div>
        <div class="stat"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ø§Ù„Øº ØªØ­Øª Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)</small><div id="monthCollectTotal" class="num">0</div></div>
        <div class="stat"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…</small><div id="monthNextDueTotal" class="num">0</div></div>
      </div>
      <div style="height:10px"></div>
      <div>
        <h4 class="small-muted">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h4>
        <div id="perAccount" class="list-plain"></div>
      </div>
    </div>
  </section>

  <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ùˆ Ø§Ù„ÙØ¦Ø§Øª -->
  <section class="card">
    <div class="card-head"><strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª / Ø§Ù„ÙØ¦Ø§Øª</strong><div></div></div>
    <div class="card-body">
      <div class="grid grid-3">
        <div>
          <label class="small-muted">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
          <input id="accName" class="input" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ§Ø´" />
        </div>
        <div>
          <label class="small-muted">Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ</label>
          <input id="accOpening" type="number" class="input" placeholder="0.00" />
        </div>
        <div style="align-self:end">
          <button id="addAccount" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div id="accountsList" class="small-muted"></div>

      <hr style="border:none;height:12px">

      <div class="grid grid-3">
        <div>
          <label class="small-muted">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©</label>
          <input id="catName" class="input" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨" />
        </div>
        <div>
          <label class="small-muted">Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="catType" class="input"><option value="expense">Ù…ØµØ±ÙˆÙ</option><option value="income">Ø¯Ø®Ù„</option></select>
        </div>
        <div style="align-self:end">
          <button id="addCat" class="btn btn-outline">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</button>
        </div>
      </div>
      <div id="catsList" class="small-muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© -->
  <section class="card" id="card-addtx">
    <div class="card-head"><strong>Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</strong><div></div></div>
    <div class="card-body">
      <div class="grid grid-3">
        <div>
          <label class="small-muted">Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="txType" class="input"><option value="expense" selected>Ù…ØµØ±ÙˆÙ</option><option value="income">Ø¯Ø®Ù„</option></select>
        </div>
        <div>
          <label class="small-muted">Ø§Ù„Ù…Ø¨Ù„Øº</label>
          <input id="txAmount" type="number" class="input" placeholder="0.00" />
        </div>
        <div>
          <label class="small-muted">Ø§Ù„ØªØ§Ø±ÙŠØ® (ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚)</label>
          <input id="txDue" type="date" class="input" />
        </div>

        <div>
          <label class="small-muted">Ø§Ù„Ø­Ø³Ø§Ø¨</label>
          <select id="txAccount" class="input"></select>
        </div>
        <div>
          <label class="small-muted">Ø§Ù„ÙØ¦Ø©</label>
          <select id="txCategory" class="input"></select>
        </div>
        <div>
          <label class="small-muted">ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="txExec" type="datetime-local" class="input" />
        </div>

        <div style="grid-column:1 / -1">
          <label class="small-muted">Ø§Ù„ÙˆØµÙ</label>
          <input id="txDesc" class="input" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª" />
        </div>

        <div style="grid-column:1 / -1;display:flex;gap:8px">
          <button id="saveTx" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©</button>
          <button id="resetTx" class="btn btn-outline">Ø¥ÙØ±Ø§Øº</button>
          <div style="flex:1"></div>
          <label class="small-muted">Ø±Ø¨Ø· Ø¨Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="txLinkCommit" class="input" style="max-width:260px"></select>
        </div>
      </div>
    </div>
  </section>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª -->
  <section class="card" id="card-txs">
    <div class="card-head"><strong>Ø§Ù„Ø­Ø±ÙƒØ§Øª</strong><div><span class="badge">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ° (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)</span></div></div>
    <div class="card-body">
      <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center">
        <input id="search" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØµÙ Ø£Ùˆ Ø§Ù„ÙØ¦Ø©" style="max-width:260px" />
        <select id="filterType" class="input" style="max-width:150px"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="income">Ø¯Ø®Ù„</option><option value="expense">Ù…ØµØ±ÙˆÙ</option></select>
        <select id="filterAccount" class="input" style="max-width:200px"></select>
        <div style="flex:1"></div>
        <button id="clearFilters" class="btn btn-outline">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
              <th>Ø§Ù„ÙˆØµÙ</th>
              <th>Ø§Ù„ÙØ¦Ø©</th>
              <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="tbodyTxs"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© -->
  <section class="card" id="card-commit">
    <div class="card-head"><strong>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</strong><div></div></div>
    <div class="card-body">
      <div class="grid grid-4">
        <div><label class="small-muted">Ø§Ø³Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</label><input id="cName" class="input" /></div>
        <div><label class="small-muted">Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="cAmount" type="number" class="input" /></div>
        <div><label class="small-muted">ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input id="cFirstDue" type="date" class="input" /></div>
        <div style="display:flex;align-items:center;gap:8px"><input id="cRecurring" type="checkbox"/><label class="small-muted">ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠÙ‹Ø§</label></div>
        <div><label class="small-muted">ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="cEndAt" type="date" class="input" /></div>
        <div style="grid-column:3 / -1;align-self:end"><button id="addCommit" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</button></div>
      </div>

      <div style="margin-top:12px" class="table-wrap">
        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</th><th>Ù…Ø¯ÙÙˆØ¹ (Ø§Ù„Ø´Ù‡Ø±)</th><th>Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„ØªÙƒØ±Ø§Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody id="tbodyCommit"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Ù…Ø¨Ø§Ù„Øº ØªØ­Øª Ø§Ù„ØªØ­ØµÙŠÙ„ -->
  <section class="card" id="card-collect">
    <div class="card-head"><strong>Ù…Ø¨Ø§Ù„Øº ØªØ­Øª Ø§Ù„ØªØ­ØµÙŠÙ„</strong><div></div></div>
    <div class="card-body">
      <div class="grid grid-4">
        <div><label class="small-muted">Ø§Ø³Ù… Ø§Ù„ØªØ­ØµÙŠÙ„</label><input id="coName" class="input" /></div>
        <div><label class="small-muted">Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="coAmount" type="number" class="input" /></div>
        <div><label class="small-muted">ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input id="coFirstDue" type="date" class="input" /></div>
        <div style="display:flex;align-items:center;gap:8px"><input id="coRecurring" type="checkbox"/><label class="small-muted">ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠÙ‹Ø§</label></div>
        <div><label class="small-muted">ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="coEndAt" type="date" class="input" /></div>
        <div style="grid-column:3 / -1;align-self:end"><button id="addCollect" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­ØµÙŠÙ„</button></div>
      </div>

      <div style="margin-top:12px" class="table-wrap">
        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…</th><th>Ø§Ù„ØªÙƒØ±Ø§Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody id="tbodyCollect"></tbody>
        </table>
      </div>
    </div>
  </section>

  <div style="height:40px"></div>
</div>

<script>
/* ======================
  Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ§Ù„Ù€ state
   ====================== */
const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1',
      COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1', GH_KEY='pf_github_cfg_v1';

let ledger = JSON.parse(localStorage.getItem(KEY) || '[]'); // ÙƒÙ„ Ø­Ø±ÙƒØ©: {id, exec:ISO, due:YYYY-MM-DD, desc, type, amount, account, category, isTransfer, linkCommitId}
let accounts = JSON.parse(localStorage.getItem(ACC_KEY) || '[]'); // {name, opening}
let categories = JSON.parse(localStorage.getItem(CAT_KEY) || '[]'); // {name,type}
let commitments = JSON.parse(localStorage.getItem(COM_KEY) || '[]'); // {id,name,amount,firstDue,nextDue,recurring,endAt,payments:{'YYYY-MM':num}}
let collections = JSON.parse(localStorage.getItem(COL_KEY) || '[]'); // {id,name,amount,firstDue,nextDue,recurring,endAt}

/* ===== Utilities ===== */
const $ = s => document.querySelector(s);
const fmt = n => Number(n).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const eid = ()=> Math.random().toString(36).slice(2,9)+Date.now().toString(36);
const startOfToday = ()=>{ const t=new Date(); t.setHours(0,0,0,0); return t;}
const formatLocalDate = d => { const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`;}
const parseLocalDate = s => { const [y,m,d]= (s||'').split('-').map(Number); if(!y) return null; const dt=new Date(y,m-1,d); dt.setHours(0,0,0,0); return dt;}
const toISO = dt => dt instanceof Date ? dt.toISOString() : dt;
const daysBetween=(a,b)=> Math.round((new Date(b).setHours(0,0,0,0) - new Date(a).setHours(0,0,0,0))/(24*60*60*1000));
const YM = ()=> formatLocalDate(startOfToday()).slice(0,7);
const addMonthsPreserveDOM=(date,months)=>{ const d=new Date(date.getTime()); const m=d.getMonth()+months; const day=d.getDate(),y=d.getFullYear(); const tmp=new Date(y,m+1,0); const last=tmp.getDate(); d.setMonth(m, Math.min(day,last)); d.setHours(0,0,0,0); return d; }
const addMonthsToYm = (ym, n) => { const [y,m]= (ym||'').split('-').map(Number); if(!y) return ym; const base=new Date(y,m-1,1); return formatLocalDate(addMonthsPreserveDOM(base,n)).slice(0,7); }
const monthLabel = ym => { if(!ym) return 'â€”'; const [y,m]=ym.split('-').map(Number); const d=new Date(y,m-1,1); return d.toLocaleDateString('ar-EG',{month:'long', year:'numeric'}); }

/* ===== Ø­ÙØ¸ ===== */
function saveAll(){ localStorage.setItem(KEY, JSON.stringify(ledger)); localStorage.setItem(ACC_KEY, JSON.stringify(accounts)); localStorage.setItem(CAT_KEY, JSON.stringify(categories)); localStorage.setItem(COM_KEY, JSON.stringify(commitments)); localStorage.setItem(COL_KEY, JSON.stringify(collections)); }

/* ===== ØªØ£ÙƒØ¯ ÙˆØ¬ÙˆØ¯ ÙØ¦Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© ===== */
function ensureBaseCategories(){
  const need=[ {name:'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ©',type:'expense'},{name:'ØªØ­ØµÙŠÙ„Ø§Øª Ø´Ù‡Ø±ÙŠØ©',type:'income'},{name:'ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø±',type:'expense'},{name:'ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯',type:'income'},{name:'Ø¹Ù…ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„',type:'expense'} ];
  if(categories.length===0){
    categories=[{name:'Ù…Ø±ØªØ¨',type:'income'},{name:'Ø¯Ø®Ù„ Ø¢Ø®Ø±',type:'income'},{name:'Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨',type:'expense'},{name:'Ù…ÙˆØ§ØµÙ„Ø§Øª',type:'expense'},{name:'ÙÙˆØ§ØªÙŠØ±',type:'expense'}];
  }
  for(const c of need) if(!categories.some(x=>x.name===c.name&&x.type===c.type)) categories.push(c);
  saveAll();
}

/* ===== Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±ØµØ¯Ø©: Ù†Ø±ØªØ¨ Ø­Ø³Ø¨ exec ASC Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ ÙƒÙ„ ØªÙ†ÙÙŠØ° ===== */
function computeBalances(){
  const bal = new Map(accounts.map(a=>[a.name, Number(a.opening||0)]));
  const sorted = [...ledger].sort((a,b)=> (a.exec||a.created||'') .localeCompare(b.exec||b.created||'') );
  const afterMap = new Map();
  for(const t of sorted){
    const cur = bal.get(t.account) || 0;
    const delta = (t.type==='income'? Number(t.amount) : -Number(t.amount));
    const next = cur + delta;
    bal.set(t.account, next);
    afterMap.set(t.id, next);
  }
  return {bal, afterMap};
}

/* ===== Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ===== */
function drawPerAccount(bal){
  const wrap = $('#perAccount'); if(!wrap) return;
  const arr = accounts.map(a=>({name:a.name, val: bal.get(a.name)??Number(a.opening||0)}));
  wrap.innerHTML = arr.map(a=>`<span class="item">${a.name} Â· <b>${fmt(a.val)} Ø¬.Ù…</b></span>`).join('');
}

/* ===== Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªØ¬Ù…ÙŠØ¹: Ø§Ù„ØªØ²Ø§Ù…Ø§Øª/ØªØ­ØµÙŠÙ„/Ø¯Ø®Ù„ ===== */
function sumCurrentMonthCommitments(){
  const ym = YM(); let total=0;
  for(const c of commitments){
    const due=(c.nextDue||c.firstDue||'').slice(0,7); if(due!==ym) continue;
    const paid=(c.payments?.[ym]||0); const remain=Math.max(0, Number(c.amount||0)-paid); total += remain;
  }
  return total;
}
function sumCurrentMonthCollections(){
  const ym = YM(); let total=0;
  for(const c of collections){
    const due=(c.nextDue||c.firstDue||'').slice(0,7); if(due!==ym) continue;
    total += Number(c.amount||0);
  }
  return total;
}
function sumCurrentMonthIncome(){
  const ym = YM();
  return ledger.filter(t=>!t.isTransfer && t.type==='income' && (t.exec||'').slice(0,7)===ym).reduce((s,t)=>s+Number(t.amount||0),0);
}

/* ===== Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø§Ù… + ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù„Ø®Øµ ===== */
function recalc(){
  const {bal, afterMap} = computeBalances();
  let total=0; for(const v of bal.values()) total+=v;
  const monthComRemain = sumCurrentMonthCommitments();
  const monthCollect = sumCurrentMonthCollections();
  const monthInc = sumCurrentMonthIncome();

  // Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ù‚Ø§Ø¯Ù… (Ø§Ù„Ø¨Ø§Ù‚ÙŠ)
  const ym = YM(), nextYm = addMonthsToYm(ym,1);
  let currentDue=0, nextDue=0;
  for(const c of commitments){
    const dueStr = c.nextDue || c.firstDue; if(!dueStr) continue;
    const dueYm = dueStr.slice(0,7);
    const paidNow = c.payments?.[ym] || 0;
    const paidNext = c.payments?.[nextYm] || 0;
    const remainNow = Math.max(0, Number(c.amount||0)-paidNow);
    const remainNext = Math.max(0, Number(c.amount||0)-paidNext);
    if(dueYm === ym) currentDue += remainNow;
    if(dueYm === nextYm) nextDue += remainNext;
  }

  $('#totalBalance').textContent = fmt(total);
  $('#monthCommitTotal').textContent = '-' + fmt(monthComRemain);
  $('#monthCollectTotal').textContent = fmt(monthCollect);
  $('#monthIncome').textContent = fmt(monthInc);
  $('#monthNextDueTotal').textContent = fmt(nextDue);

  drawPerAccount(bal);
  renderTxs(); drawCommitments(); drawCollections(); drawDueSoon();
  saveAll();
}

/* ===== Ø±Ø³Ù…/Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ exec DESC (Ø¹Ø±Ø¶) ===== */
function renderTxs(){
  const tbody = $('#tbodyTxs'); if(!tbody) return;
  const q = $('#search').value.trim().toLowerCase();
  const fType = $('#filterType').value;
  const fAcc = $('#filterAccount').value;
  // compute balances for after value mapping
  const {afterMap} = computeBalances();

  const rows = [...ledger].sort((a,b)=> (b.exec||b.created||'').localeCompare(a.exec||a.created||'') )
    .filter(t=>{
      if(q && !( (t.desc||'').toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q) )) return false;
      if(fType!=='all' && t.type!==fType) return false;
      if(fAcc && fAcc!=='all' && t.account!==fAcc) return false;
      return true;
    });

  tbody.innerHTML = rows.map(t=>{
    const execTxt = t.exec ? (new Date(t.exec)).toLocaleString('ar-EG') : (t.created? (new Date(t.created)).toLocaleString('ar-EG') : 'â€”');
    const dueTxt = t.due || 'â€”';
    const cls = t.type==='income' ? 'amount inc' : 'amount exp';
    const afterVal = afterMap.get(t.id) ?? 0;
    const tag = t.isTransfer ? 'â†”ï¸ ØªØ­ÙˆÙŠÙ„' : (t.linkCommitId ? 'ğŸ”— Ø§Ù„ØªØ²Ø§Ù…' : '');
    return `<tr>
      <td class="right"><div class="exec-dt">${execTxt}</div></td>
      <td class="right">${dueTxt}</td>
      <td>${escapeHtml(t.desc||'â€”')} ${tag}</td>
      <td>${escapeHtml(t.category||'â€”')}</td>
      <td>${escapeHtml(t.account||'â€”')}</td>
      <td class="${cls}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
      <td>${fmt(afterVal)}</td>
      <td>
        <button class="btn btn-outline" onclick="editTx('${t.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-danger" onclick="delTx('${t.id}')">Ø­Ø°Ù</button>
      </td>
    </tr>`;
  }).join('');
}

/* ===== CRUD Ø§Ù„Ø­Ø±ÙƒØ§Øª ===== */
let editId = null;
function clearTxForm(){ $('#txAmount').value=''; $('#txDue').value=''; $('#txDesc').value=''; $('#txExec').value=''; $('#txLinkCommit').value=''; editId=null; $('#saveTx').textContent='Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©'; }
function editTx(id){
  const t = ledger.find(x=>x.id===id); if(!t) return;
  editId = id; $('#saveTx').textContent = 'ØªØ­Ø¯ÙŠØ«';
  $('#txAmount').value = t.amount;
  $('#txDue').value = t.due || '';
  $('#txDesc').value = t.desc || '';
  $('#txType').value = t.type;
  $('#txAccount').value = t.account || (accounts[0]?.name||'');
  $('#txCategory').value = t.category || '';
  $('#txExec').value = t.exec ? new Date(t.exec).toISOString().slice(0,16) : '';
  $('#txLinkCommit').value = t.linkCommitId || '';
  window.scrollTo({top:0,behavior:'smooth'});
}
function delTx(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')) return;
  const t = ledger.find(x=>x.id===id);
  ledger = ledger.filter(x=>x.id!==id);
  // Ù„Ùˆ ÙƒØ§Ù†Øª Ø­Ø±ÙƒØ© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ØªØ²Ø§Ù… ÙˆØ±ØµÙŠØ¯ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ØªØ³Ø­Ø¨ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹
  if(t && t.linkCommitId && t.type==='expense'){
    const ym = (t.exec||t.created||'').slice(0,7);
    const comm = commitments.find(c=>c.id===t.linkCommitId);
    if(comm && comm.payments && comm.payments[ym]){ comm.payments[ym] = Math.max(0, comm.payments[ym] - Number(t.amount||0)); }
  }
  saveAll(); recalc();
}

$('#saveTx').addEventListener('click', ()=>{
  const type = $('#txType').value;
  const amount = Number($('#txAmount').value||0);
  const due = $('#txDue').value;
  const execInput = $('#txExec').value; // datetime-local optional
  const account = $('#txAccount').value;
  const category = $('#txCategory').value;
  const desc = $('#txDesc').value.trim();
  const linkCommitId = $('#txLinkCommit').value || null;

  if(!amount || amount<=0 || !account || !category){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„: Ù†ÙˆØ¹/Ø­Ø³Ø§Ø¨/ÙØ¦Ø©/Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }

  // execution datetime: if provided use it; else if linked to commitment and payment then execution = now; else use due date start-of-day
  let execISO;
  if(execInput) execISO = new Date(execInput).toISOString();
  else if(linkCommitId){ execISO = new Date().toISOString(); } // Ø¥Ø°Ø§ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ØªÙ†ÙÙŠØ° ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  else if(due){ const pd = parseLocalDate(due); pd.setHours(12,0,0,0); execISO = pd.toISOString(); } // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù†ØªØµÙ Ø§Ù„ÙŠÙˆÙ…
  else execISO = new Date().toISOString();

  const tx = {
    id: editId || eid(),
    exec: execISO,
    created: new Date().toISOString(),
    due: due || (execISO.slice(0,10)),
    desc: desc || (linkCommitId ? 'Ø³Ø¯Ø§Ø¯/ØªØ­ØµÙŠÙ„ Ù…Ø±ØªØ¨Ø·' : ''),
    type, amount, account, category,
    isTransfer: false,
    linkCommitId: linkCommitId || undefined
  };

  if(editId){
    const idx = ledger.findIndex(x=>x.id===editId);
    if(idx>-1) ledger[idx] = tx;
    editId = null;
    $('#saveTx').textContent='Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©';
  }else{
    ledger.push(tx);
  }

  // Ù„Ùˆ Ø§Ù„Ø­Ø±ÙƒØ© Ø³Ø¯Ø§Ø¯ Ù„Ø§Ù„ØªØ²Ø§Ù… (Ù…ØµØ±ÙˆÙ ÙˆÙ…Ø±ØªØ¨Ø· Ø¨Ø§Ù„ØªØ²Ø§Ù…)
  if(tx.type==='expense' && tx.linkCommitId){
    addCommitPayment(tx.linkCommitId, tx.exec.slice(0,7), tx.amount);
  }
  // Ù„Ùˆ Ø­Ø±ÙƒØ© ØªØ­ØµÙŠÙ„ (Ø¯Ø®Ù„) Ù…Ø±ØªØ¨Ø·Ø© Ø¨ØªØ­ØµÙŠÙ„ (Ø³Ù†Ø³ØªØ®Ø¯Ù… linkCommitIdØŸ) â€” Ù‡Ù†Ø§ Ù†ÙØªØ±Ø¶ collect Ù…Ù†ÙØµÙ„
  saveAll(); clearTxForm(); recalc();
});

/* ===== ÙÙ„ØªØ±Ø© ÙˆØ§Ø¯ÙˆØ§Øª Ø¬Ø¯ÙˆÙ„ ===== */
$('#search').addEventListener('input', renderTxs);
$('#filterType').addEventListener('change', renderTxs);
$('#filterAccount').addEventListener('change', renderTxs);
$('#clearFilters').addEventListener('click', ()=>{ $('#search').value=''; $('#filterType').value='all'; $('#filterAccount').value='all'; renderTxs(); });

$('#resetTx').addEventListener('click', clearTxForm);

/* ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ùˆ ÙØ¦Ø§Øª ===== */
$('#addAccount').addEventListener('click', ()=>{
  const name = $('#accName').value.trim(); const opening = Number($('#accOpening').value||0);
  if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'); return; }
  accounts.push({name, opening: Number.isFinite(opening)?opening:0});
  $('#accName').value=''; $('#accOpening').value='';
  saveAll(); refreshAccountsUI(); recalc();
});
function refreshAccountsUI(){
  $('#accountsList').innerHTML = accounts.map((a,i)=>`<span class="item">${a.name} Â· <b>${fmt(a.opening||0)}</b> <button class="btn btn-outline" style="margin-inline-start:6px" onclick="renameAcc(${i})">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn btn-danger" onclick="removeAcc(${i})">Ø­Ø°Ù</button></span>`).join('');
  const opts = `<option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>` + accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
  $('#filterAccount').innerHTML = opts;
  $('#txAccount').innerHTML = accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
}
window.renameAcc = i => {
  const cur = accounts[i]; if(!cur) return;
  const name = prompt('Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯', cur.name); if(!name) return;
  const openingStr = prompt('Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ', cur.opening||0); const opening = Number(openingStr);
  const oldName = cur.name;
  accounts[i].name = name.trim();
  if(Number.isFinite(opening)) accounts[i].opening = opening;
  // Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
  for(const t of ledger) if(t.account===oldName) t.account = accounts[i].name;
  saveAll(); refreshAccountsUI(); recalc();
}
window.removeAcc = i => {
  if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù† ØªÙØ­Ø°Ù). Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
  const name = accounts[i].name;
  accounts.splice(i,1);
  // Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù„ÙƒÙ† Ù†ØªØ±Ùƒ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ ÙƒÙ…Ø§ Ù‡Ùˆ Ø­ØªÙ‰ ØªØ¸Ù‡Ø± ØªØ­Ø°ÙŠØ±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶
  saveAll(); refreshAccountsUI(); recalc();
}

$('#addCat').addEventListener('click', ()=>{
  const name = $('#catName').value.trim(); const type = $('#catType').value;
  if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©'); return; }
  categories.push({name,type}); $('#catName').value=''; saveAll(); refreshCatsUI();
});
function refreshCatsUI(){
  $('#catsList').innerHTML = categories.map((c,i)=>`<span class="item">${c.name} Â· ${c.type==='income'?'Ø¯Ø®Ù„':'Ù…ØµØ±ÙˆÙ'} <button class="btn btn-outline" style="margin-inline-start:6px" onclick="renameCat(${i})">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn btn-danger" onclick="removeCat(${i})">Ø­Ø°Ù</button></span>`).join('');
  $('#txCategory').innerHTML = categories.map(c=>`<option value="${c.name}">${c.name} (${c.type})</option>`).join('');
}
window.renameCat = i => { const cur = categories[i]; const name = prompt('Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©', cur.name); if(!name) return; const type = prompt('Ø§Ù„Ù†ÙˆØ¹ (income/expense)', cur.type); if(type!=='income'&&type!=='expense') return alert('Ù†ÙˆØ¹ ØºÙŠØ± ØµØ­ÙŠØ­'); categories[i] = {name:type? name.trim():cur.name, type}; saveAll(); refreshCatsUI(); }
window.removeCat = i => { if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©ØŸ')) return; categories.splice(i,1); saveAll(); refreshCatsUI(); }

/* ===== Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ===== */
let editCommitId = null;
function migrateCommit(c){
  if(c.day && !c.firstDue){ const today = startOfToday(); const base=new Date(today.getFullYear(),today.getMonth(),Math.min(Math.max(1,c.day),28)); c.firstDue=formatLocalDate(base); c.nextDue=c.firstDue; delete c.day; }
  if(!c.nextDue && c.firstDue) c.nextDue = c.firstDue;
  if(typeof c.recurring!=='boolean') c.recurring=false;
  if(c.endAt===undefined) c.endAt=null;
  if(!c.payments) c.payments={};
  return c;
}
function drawCommitments(){
  const tbody = $('#tbodyCommit'); if(!tbody) return;
  commitments = commitments.map(migrateCommit);
  tbody.innerHTML = commitments.map(c=>{
    const ym = YM();
    const paid = c.payments?.[ym] || 0;
    const remain = Math.max(0, Number(c.amount||0)-paid);
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${escapeHtml(c.nextDue||c.firstDue||'â€”')}</td>
      <td>${fmt(paid)}</td>
      <td>${fmt(remain)}</td>
      <td>${c.recurring?'Ø´Ù‡Ø±ÙŠ':'Ù…Ø±Ø©'}</td>
      <td>
        <button class="btn btn-primary" onclick="payCommit('${c.id}')">ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ (Ø¬Ø²Ø¦ÙŠØ§Ù‹/ÙƒØ§Ù…Ù„)</button>
        <button class="btn btn-outline" onclick="editCommit('${c.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-danger" onclick="delCommit('${c.id}')">Ø­Ø°Ù</button>
      </td>
    </tr>`;
  }).join('');
}
$('#addCommit').addEventListener('click', ()=>{
  const name = $('#cName').value.trim(), amount = Number($('#cAmount').value||0), firstDue = $('#cFirstDue').value, recurring = $('#cRecurring').checked, endAt = $('#cEndAt').value || null;
  if(!name || !amount || !firstDue){ alert('Ø§Ø¯Ø®Ù„: Ø§Ø³Ù… + Ù…Ø¨Ù„Øº + ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚'); return; }
  if(recurring && endAt && parseLocalDate(endAt) < parseLocalDate(firstDue)){ alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚'); return; }
  // ØªÙ‚Ø¯ÙŠØ± nextDue Ø¨Ø­ÙŠØ« Ø¥Ø°Ø§ ÙØ§Øª ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„Ù„Ø£Ù‚Ø±Ø¨
  let nextDue = parseLocalDate(firstDue);
  const today = startOfToday();
  while(nextDue < today){
    const tryNext = addMonthsPreserveDOM(nextDue,1);
    if(recurring && (!endAt || tryNext <= parseLocalDate(endAt))) nextDue = tryNext;
    else break;
  }
  const commit = { id: editCommitId || eid(), name, amount, firstDue: formatLocalDate(parseLocalDate(firstDue)), nextDue: formatLocalDate(nextDue), recurring, endAt: recurring ? (endAt||null) : null, payments: {} };
  if(editCommitId){
    const i = commitments.findIndex(x=>x.id===editCommitId); if(i>-1) commitments[i]=commit; editCommitId=null;
  }else commitments.push(commit);
  $('#cName').value=''; $('#cAmount').value=''; $('#cFirstDue').value=''; $('#cRecurring').checked=false; $('#cEndAt').value='';
  saveAll(); drawCommitments(); recalc();
});
window.editCommit = id => {
  const c = commitments.find(x=>x.id===id); if(!c) return;
  editCommitId = id; $('#cName').value = c.name; $('#cAmount').value = c.amount; $('#cFirstDue').value = c.firstDue||''; $('#cRecurring').checked = !!c.recurring; $('#cEndAt').value = c.endAt||'';
}
window.delCommit = id => { if(!confirm('Ø­Ø°Ù Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…ØŸ')) return; commitments = commitments.filter(x=>x.id!==id); saveAll(); drawCommitments(); recalc(); }

/* Ø¯ÙØ¹/Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… â€” ÙŠØ¶ÙŠÙ Ø­Ø±ÙƒØ© expense Ùˆ ÙŠØ­Ø¯Ø« Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø±ØµÙŠØ¯ */
function addCommitPayment(commitId, ym, amount){
  const c = commitments.find(x=>x.id===commitId); if(!c) return;
  c.payments = c.payments || {};
  c.payments[ym] = (c.payments[ym]||0) + Number(amount||0);
  // Ø§Ø°Ø§ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø³Ø¯Ø§Ø¯ Ù„Ù„Ù…ÙˆØ¹Ø¯ØŒ Ø§Ù†Ù‚Ù„ nextDue Ø§Ø°Ø§ Ù…ØªÙƒØ±Ø±
  if(c.payments[ym] >= Number(c.amount||0) - 1e-9){
    const dueDate = parseLocalDate(c.nextDue||c.firstDue);
    if(c.recurring){
      const next = addMonthsPreserveDOM(dueDate, 1);
      if(c.endAt && next > parseLocalDate(c.endAt)){ commitments = commitments.filter(xx=>xx.id!==commitId); }
      else c.nextDue = formatLocalDate(next);
    }else{
      commitments = commitments.filter(xx=>xx.id!==commitId);
    }
  }
  saveAll();
}

/* Ø²Ø± Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… â€” ÙŠÙØªØ­ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨ ÙˆÙŠØ¶ÙŠÙ Ø­Ø±ÙƒØ© Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ° = Ø§Ù„Ø¢Ù† Ùˆ due = ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… */
window.payCommit = id => {
  const c = commitments.find(x=>x.id===id); if(!c) return;
  const dueStr = c.nextDue || c.firstDue || YM()+'-01';
  const ym = dueStr.slice(0,7);
  const paid = c.payments?.[ym] || 0;
  const remain = Math.max(0, Number(c.amount||0) - paid);
  if(remain<=0){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ù‚ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.'); return; }
  const acc = chooseAccount(); if(!acc) return;
  if(!confirm(`Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… "${c.name}" Ø¨Ù‚ÙŠÙ…Ø© ${fmt(remain)} Ø¬.Ù… Ù…Ù† "${acc}"ØŸ`)) return;
  const execISO = new Date().toISOString();
  const tx = { id: eid(), exec: execISO, created: execISO, due: dueStr, desc: `${c.name} (Ø³Ø¯Ø§Ø¯ Ø§Ù„ØªØ²Ø§Ù…)`, type: 'expense', amount: remain, account: acc, category: 'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ©', isTransfer:false, linkCommitId: c.id };
  ledger.push(tx);
  addCommitPayment(c.id, ym, remain);
  saveAll(); recalc();
}

/* Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø³ÙŠØ·Ø© */
function chooseAccount(){
  if(accounts.length===0){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª'); return null; }
  const menu = accounts.map((a,i)=>`${i+1} - ${a.name}`).join('\n');
  const ans = prompt(`Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨:\n${menu}`); if(ans===null) return null;
  const idx = parseInt(ans,10)-1; if(isNaN(idx)||idx<0||idx>=accounts.length){ alert('Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­'); return null; }
  return accounts[idx].name;
}

/* ===== Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª (Collections) ===== */
let editCollectId = null;
function migrateCollect(c){
  if(!c.nextDue && c.firstDue) c.nextDue=c.firstDue;
  if(typeof c.recurring!=='boolean') c.recurring=false;
  if(c.endAt===undefined) c.endAt=null;
  return c;
}
function drawCollections(){
  const tbody = $('#tbodyCollect'); if(!tbody) return;
  collections = collections.map(migrateCollect);
  tbody.innerHTML = collections.map(c=>{
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${escapeHtml(c.nextDue||c.firstDue||'â€”')}</td>
      <td>${c.recurring?'Ø´Ù‡Ø±ÙŠ':'Ù…Ø±Ø©'}</td>
      <td>
        <button class="btn btn-primary" onclick="collectNow('${c.id}')">ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„</button>
        <button class="btn btn-outline" onclick="editCollect('${c.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-danger" onclick="delCollect('${c.id}')">Ø­Ø°Ù</button>
      </td>
    </tr>`;
  }).join('');
}
$('#addCollect').addEventListener('click', ()=>{
  const name = $('#coName').value.trim(), amount = Number($('#coAmount').value||0), firstDue = $('#coFirstDue').value, recurring = $('#coRecurring').checked, endAt = $('#coEndAt').value||null;
  if(!name || !amount || !firstDue){ alert('Ø§Ø¯Ø®Ù„: Ø§Ø³Ù… + Ù…Ø¨Ù„Øº + ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚'); return; }
  let nextDue = parseLocalDate(firstDue);
  const today = startOfToday();
  while(nextDue < today){
    const tryNext = addMonthsPreserveDOM(nextDue,1);
    if(recurring && (!endAt || tryNext <= parseLocalDate(endAt))) nextDue = tryNext; else break;
  }
  const item = { id: editCollectId || eid(), name, amount, firstDue: formatLocalDate(parseLocalDate(firstDue)), nextDue: formatLocalDate(nextDue), recurring, endAt: recurring ? (endAt||null) : null };
  if(editCollectId){ const i = collections.findIndex(x=>x.id===editCollectId); if(i>-1) collections[i]=item; editCollectId=null; } else collections.push(item);
  $('#coName').value=''; $('#coAmount').value=''; $('#coFirstDue').value=''; $('#coRecurring').checked=false; $('#coEndAt').value='';
  saveAll(); drawCollections(); recalc();
});
window.collectNow = id => {
  const c = collections.find(x=>x.id===id); if(!c) return;
  const dueStr = c.nextDue || c.firstDue || YM()+'-01';
  const acc = chooseAccount(); if(!acc) return;
  if(!confirm(`ØªØ­ØµÙŠÙ„ "${c.name}" Ø¨Ù…Ø¨Ù„Øº ${fmt(c.amount)} Ø¬.Ù… Ø¥Ù„Ù‰ "${acc}" Ø¨ØªØ§Ø±ÙŠØ® ${dueStr}?`)) return;
  const execISO = new Date().toISOString();
  ledger.push({ id: eid(), exec: execISO, created: execISO, due: dueStr, desc: `${c.name} (ØªØ­ØµÙŠÙ„)`, type: 'income', amount: Number(c.amount||0), account: acc, category: 'ØªØ­ØµÙŠÙ„Ø§Øª Ø´Ù‡Ø±ÙŠØ©', isTransfer:false });
  // Ø¥Ø°Ø§ Ù…ØªÙƒØ±Ø± Ø§Ù†Ù‚Ù„ nextDue Ù„Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ø£Ùˆ Ø§Ø­Ø°Ù
  if(c.recurring){
    const next = addMonthsPreserveDOM(parseLocalDate(c.nextDue||c.firstDue), 1);
    if(c.endAt && next > parseLocalDate(c.endAt)){ collections = collections.filter(x=>x.id!==id); }
    else c.nextDue = formatLocalDate(next);
  }else{
    collections = collections.filter(x=>x.id!==id);
  }
  saveAll(); recalc();
}
window.editCollect = id => { const c = collections.find(x=>x.id===id); if(!c) return; editCollectId = id; $('#coName').value=c.name; $('#coAmount').value=c.amount; $('#coFirstDue').value=c.firstDue||''; $('#coRecurring').checked=!!c.recurring; $('#coEndAt').value=c.endAt||''; }
window.delCollect = id => { if(!confirm('Ø­Ø°Ù Ø§Ù„ØªØ­ØµÙŠÙ„ØŸ')) return; collections = collections.filter(x=>x.id!==id); saveAll(); drawCollections(); recalc(); }

/* ===== Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ + Ø§Ù„Ù‚Ø§Ø¯Ù…) ===== */
function drawDueSoon(){
  const wrapTable = $('#tbodyDueSoon'), cardsWrap = null; // Ù†Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ§Ù„Ù€ Collects Ù„Ø¹Ø±Ø¶
  const ym = YM(), nextYm = addMonthsToYm(ym,1);
  const today = startOfToday();

  // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø© ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
  const listNow = commitments.map(c=>{
    const dueStr = c.nextDue || c.firstDue; if(!dueStr) return null;
    const dueYm = dueStr.slice(0,7);
    if(dueYm !== ym) return null;
    const paid = c.payments?.[ym] || 0; const total = Number(c.amount||0); const remaining = Math.max(0, total - paid);
    if(remaining<=0) return null;
    const diff = daysBetween(today, parseLocalDate(dueStr));
    return {...c, dueStr, total, paid, remaining, diff, source:'commit'};
  }).filter(Boolean);
  // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…
  const listNext = commitments.map(c=>{
    const dueStr = c.nextDue || c.firstDue; if(!dueStr) return null;
    const dueYm = dueStr.slice(0,7);
    if(dueYm !== nextYm) return null;
    const paidNext = c.payments?.[nextYm] || 0; const total = Number(c.amount||0); const remaining = Math.max(0, total - paidNext);
    if(remaining<=0) return null;
    const diff = daysBetween(today, parseLocalDate(dueStr));
    return {...c, dueStr, total, paid: paidNext, remaining, diff, source:'commit'};
  }).filter(Boolean);

  // Ù…Ø¨Ø§Ù„Øº Ø§Ù„ØªØ­ØµÙŠÙ„ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (collections)
  const collectNow = collections.map(c=>{
    const dueStr = c.nextDue || c.firstDue; if(!dueStr) return null;
    if(dueStr.slice(0,7)!==ym) return null;
    return {...c, dueStr, total: Number(c.amount||0), remaining: Number(c.amount||0), diff: daysBetween(today, parseLocalDate(dueStr)), source:'collect'};
  }).filter(Boolean);

  // Ø¯Ù…Ø¬: Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ Ù†Ø¹Ø±Ø¶ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©) + ØªØ­ØµÙŠÙ„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ + Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…
  let combined = [...listNow, ...collectNow, ...listNext].sort((a,b)=> (a.dueStr||'').localeCompare(b.dueStr));
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
  const totalNow = listNow.reduce((s,x)=>s+x.remaining,0);
  const totalCollectNow = collectNow.reduce((s,x)=>s+x.remaining,0);
  const totalNext = listNext.reduce((s,x)=>s+x.remaining,0);
  $('#dueTotalBadge').textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª ${monthLabel(ym)}: ${fmt(totalNow + totalCollectNow)} Ø¬.Ù…`;
  $('#dueNextTotalBadge').textContent = `Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù… (${monthLabel(nextYm)}): ${fmt(totalNext)} Ø¬.Ù…`;

  // ÙˆÙ†Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (tbody of dueSoonWrap is same as #tbodyDueSoon)
  const tbody = $('#tbodyDueSoon');
  if(!tbody) return;
  if(combined.length===0){ tbody.innerHTML = `<tr><td colspan="8" class="small-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª/ØªØ­ØµÙŠÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø£Ùˆ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù….</td></tr>`; return; }
  tbody.innerHTML = combined.map(x=>{
    const state = x.diff<0 ? `<span style="color:var(--danger);font-weight:700">Ù…ØªØ£Ø®Ø± ${Math.abs(x.diff)} ÙŠÙˆÙ…</span>` : x.diff===0 ? `<span style="color:var(--warn);font-weight:700">Ø§Ù„ÙŠÙˆÙ…</span>` : `<span style="color:var(--muted);font-weight:700">Ù…ØªØ¨Ù‚ÙŠ ${x.diff} ÙŠÙˆÙ…</span>`;
    const sourceTxt = x.source==='commit' ? 'Ø§Ù„ØªØ²Ø§Ù…' : 'ØªØ­ØµÙŠÙ„';
    return `<tr>
      <td>${escapeHtml(x.name)}</td>
      <td>${x.dueStr}</td>
      <td>${fmt(x.total)}</td>
      <td>${fmt(x.paid||0)}</td>
      <td><b>${fmt(x.remaining)}</b></td>
      <td>${sourceTxt}</td>
      <td>${state}</td>
      <td><button class="btn btn-primary" onclick="${x.source==='commit'?`payCommit('${x.id}')`:`collectNow('${x.id}')`}">Ø³Ø¯Ø§Ø¯/ØªØ­ØµÙŠÙ„</button></td>
    </tr>`;
  }).join('');
}

/* ===== Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© (ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON) ===== */
$('#exportJson').addEventListener('click', ()=>{
  const data = { ledger, accounts, categories, commitments, collections, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'my-finance-data.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('#importBtn').addEventListener('click', ()=> $('#importFile').click());
$('#importFile').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const text = await file.text(); const data = JSON.parse(text);
    if(Array.isArray(data.accounts)) accounts = data.accounts;
    if(Array.isArray(data.categories)) categories = data.categories;
    if(Array.isArray(data.ledger)) ledger = data.ledger;
    if(Array.isArray(data.commitments)) commitments = data.commitments.map(migrateCommit);
    if(Array.isArray(data.collections)) collections = data.collections;
    saveAll(); refreshUI(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
  }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: '+err.message); }
  e.target.value='';
});

/* Ø²Ø± Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù† â€” Ù…Ø¬Ø±Ø¯ Ø¯Ø¹ÙˆØ© Ù„Ø­ÙØ¸ (ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø· GitHub Ù„Ø§Ø­Ù‚Ø§Ù‹) */
$('#syncNow').addEventListener('click', ()=>{ saveAll(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§'); });

/* Ø²Ø± ØªÙØ±ÙŠØº Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© */
$('#seedBtn').addEventListener('click', ()=>{
  if(!confirm('Ø³ØªØ­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØªÙ…Ù„Ø£ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
  ledger=[]; accounts=[]; categories=[]; commitments=[]; collections=[];
  initSeed(); saveAll(); refreshUI();
});

/* ===== Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ø¬Ù‡Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø¹Ø§Ù… ===== */
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
function refreshUI(){
  ensureBaseCategories();
  refreshAccountsUI(); refreshCatsUI(); drawCommitments(); drawCollections(); recalc();
  // Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©
  refreshLinkCommitOptions();
}
function refreshCatsUI(){
  $('#catsList').innerHTML = categories.map(c=>`<span class="item">${c.name} Â· ${c.type==='income'?'Ø¯Ø®Ù„':'Ù…ØµØ±ÙˆÙ'}</span>`).join('');
  $('#txCategory').innerHTML = categories.map(c=>`<option value="${c.name}">${c.name} (${c.type})</option>`).join('');
}
function refreshAccountsUI(){
  $('#accountsList').innerHTML = accounts.map((a,i)=>`<span class="item">${a.name} Â· <b>${fmt(a.opening||0)}</b></span>`).join('');
  $('#txAccount').innerHTML = accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
  $('#filterAccount').innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>` + accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
}

/* refresh link commit options (available unpaid commitments for current month) */
function refreshLinkCommitOptions(){
  const sel = $('#txLinkCommit'); if(!sel) return;
  const ym = YM();
  const opts = commitments.filter(c=>{
    const due = (c.nextDue||c.firstDue||'').slice(0,7);
    const paid = c.payments?.[ym] || 0;
    return due===ym && paid < Number(c.amount||0);
  }).map(c=>`<option value="${c.id}">${escapeHtml(c.name)} â€” Ø£ØµÙ„ ${fmt(c.amount)} â€¢ Ù…Ø¯ÙÙˆØ¹ ${fmt(c.payments?.[ym]||0)}</option>`).join('');
  sel.innerHTML = `<option value="">â€” Ø¨Ø¯ÙˆÙ† â€”</option>` + opts;
}

/* ===== ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù€ seed ===== */
function initSeed(){
  accounts = [{name:'ÙƒØ§Ø´',opening:5000},{name:'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ',opening:12000}];
  categories = [{name:'Ù…Ø±ØªØ¨',type:'income'},{name:'Ø¯Ø®Ù„ Ø¢Ø®Ø±',type:'income'},{name:'Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨',type:'expense'},{name:'ÙÙˆØ§ØªÙŠØ±',type:'expense'},{name:'ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø±',type:'expense'},{name:'ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯',type:'income'},{name:'Ø¹Ù…ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„',type:'expense'},{name:'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ©',type:'expense'},{name:'ØªØ­ØµÙŠÙ„Ø§Øª Ø´Ù‡Ø±ÙŠØ©',type:'income'}];
  const ym = YM(), nextYm = addMonthsToYm(ym,1);
  commitments = [
    {id:eid(), name:'Ø¥ÙŠØ¬Ø§Ø±', amount:3000, firstDue:ym+'-05', nextDue:ym+'-05', recurring:true, endAt:null, payments:{}},
    {id:eid(), name:'Ù‚Ø³Ø· Ø³ÙŠØ§Ø±Ø©', amount:1200, firstDue:ym+'-15', nextDue:ym+'-15', recurring:true, endAt:null, payments:{}}
  ];
  collections = [
    {id:eid(), name:'ÙØ§ØªÙˆØ±Ø© Ù…Ø³ØªØ­Ù‚Ø© Ù…Ù† Ø¹Ù…ÙŠÙ„', amount:850, firstDue:ym+'-07', nextDue:ym+'-07', recurring:false, endAt:null}
  ];
  ledger = [
    {id:eid(), exec:new Date().toISOString(), created:new Date().toISOString(), due:ym+'-01', desc:'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ', type:'income', amount:5000, account:'ÙƒØ§Ø´', category:'Ù…Ø±ØªØ¨', isTransfer:false},
    {id:eid(), exec:new Date().toISOString(), created:new Date().toISOString(), due:ym+'-02', desc:'Ø³Ø­Ø¨ Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª', type:'expense', amount:150, account:'ÙƒØ§Ø´', category:'Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨', isTransfer:false}
  ];
  saveAll();
}

/* ===== Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹ ===== */
function boot(){
  ensureBaseCategories();
  if(accounts.length===0 || categories.length===0 || (!commitments.length && !collections.length && !ledger.length)){
    initSeed();
  }
  refreshUI();
  // listeners Ø¨Ø³ÙŠØ·Ø©
  document.getElementById('txType').addEventListener('change', ()=> {
    // ØªØ­Ø¯ÙŠØ« select Ø§Ù„ÙØ¦Ø§Øª Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†ÙˆØ¹
    const t = $('#txType').value;
    const opts = categories.filter(c=>c.type===t).map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
    $('#txCategory').innerHTML = opts;
  });
  // Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù†Ù…Ù„Ø£ ÙÙ„Ø§ØªØ± Ùˆ selects
  refreshLinkCommitOptions();
}
boot();

/* =======================
   Ù…Ø³Ø§Ø¹Ø¯Ø© Ø®Ø·ÙˆØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
   ======================= */
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
</script>
</body>
</html>