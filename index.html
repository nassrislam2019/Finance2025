<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>دفتر حساباتي — نسخة مدمجة</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { cairo: ['Cairo','sans-serif'] }
        }
      }
    }
  </script>

  <style>
    /* Preserve original visual tokens but inside Tailwind layout */
    :root{
      --bg:#ffffff; --card:#f7f9fc; --muted:#55626b; --txt:#09101a;
      --brand:#0b84ff; --danger:#ef4444; --ok:#16a34a; --border:#e6eef6;
      --radius:12px; --field-h:44px;
    }
    .dark{
      --bg:#071227; --card:#071a2b; --muted:#9fb7d0; --txt:#e6f2ff;
      --brand:#4ea8ff; --danger:#fb6f6f; --ok:#34d399; --border:#123142;
    }
    body{font-family:'Cairo', sans-serif;background:var(--bg);color:var(--txt)}
    /* small helpers to keep your original look */
    .card-custom{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:0;overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
    .card-body{padding:14px;border-top:1px solid var(--border)}
    .toggle-btn{cursor:pointer}
    .badge-custom{display:inline-flex;align-items:center;gap:8px;background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:40px;color:var(--muted)}
    table.custom{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:13px}
    table.custom thead th{font-size:12px;color:var(--muted);font-weight:700;text-align:right;padding:8px}
    tr.row-item{background:var(--card);border:1px solid var(--border);border-radius:10px}
    .amount.exp{color:var(--danger);font-weight:800}
    .amount.inc{color:var(--ok);font-weight:800}
  </style>

</head>
<body class="antialiased">

<div class="min-h-screen flex" style="direction:rtl">
  <aside class="w-72 bg-white dark:bg-gray-800 shadow-md p-4 flex flex-col" id="sidebar">
    <div class="flex items-center gap-3 mb-4">
      <div class="text-2xl font-extrabold text-brand">دفتر حساباتي</div>
      <button id="darkToggle" data-action="toggle-dark" class="ml-auto px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-sm">Dark</button>
    </div>

    <nav class="flex-1">
      <ul class="space-y-2">
        <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="dashboard">لوحة البيانات</button></li>
        <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="transactions">الحركات</button></li>
        <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="add">إضافة حركة</button></li>
        <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="accounts">الحسابات / فئات</button></li>
        <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="commitments">الالتزامات/التحصيلات</button></li>
      </ul>
    </nav>

    <div class="mt-4 space-y-2">
      <button data-action="export-json" class="w-full py-2 rounded border border-gray-200">تصدير JSON</button>
      <button data-action="import-json" class="w-full py-2 rounded border border-gray-200">استيراد JSON</button>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
      <button data-action="sync-now" class="w-full py-2 rounded border border-gray-200">مزامنة الآن</button>
    </div>
  </aside>

  <main class="flex-1 p-6 overflow-auto">
    <section id="dashboard" class="page-section">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="card-custom p-4">
          <small class="text-sm text-gray-500">إجمالي الأرصدة</small>
          <div id="totalBalance" class="text-2xl font-bold mt-2">0.00</div>
        </div>
        <div class="card-custom p-4">
          <small class="text-sm text-gray-500">الرصيد المتوقع (بعد التحصيلات والالتزامات)</small>
          <div id="balanceAfterCommit" class="text-2xl font-bold mt-2">0.00</div>
        </div>
        <div class="card-custom p-4">
          <small class="text-sm text-gray-500">الشهر الحالي</small>
          <div id="monthLabel" class="text-xl font-bold mt-2"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="card-custom p-4">
          <small class="text-sm text-gray-500">التزامات الشهر الحالي (إجمالي / متبقي)</small>
          <div id="totalCommitThis" class="text-xl font-bold mt-2">0.00</div>
        </div>
        <div class="card-custom p-4">
          <small class="text-sm text-gray-500">تحصيلات الشهر الحالي (إجمالي / متبقي)</small>
          <div id="totalCollectThis" class="text-xl font-bold mt-2">0.00</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card-custom p-4">
          <h4 class="font-semibold mb-2">آخر 5 حركات</h4>
          <div id="latestTx"></div>
        </div>

        <div class="card-custom p-4">
          <h4 class="font-semibold mb-2">استحقاقات قريبة (هذا الشهر)</h4>
          <div id="dueSoonWrap"></div>
        </div>

        <div class="card-custom p-4">
          <h4 class="font-semibold mb-2">تفاصيل الأرصدة بالحساب</h4>
          <div id="perAccount" class="space-y-2"></div>
        </div>
      </div>
    </section>

    <section id="transactions" class="page-section hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">الحركات</h2>
      </div>

      <div class="card-custom mb-4 p-4">
        <div class="flex gap-2 flex-wrap items-center mb-3">
          <input id="search" placeholder="بحث بالوصف/الفئة" class="px-3 py-2 border rounded flex-1" />
          <select id="fType" class="px-3 py-2 border rounded">
            <option value="all">الكل</option>
            <option value="income">دخل</option>
            <option value="expense">مصروف</option>
          </select>
          <select id="fAccount" class="px-3 py-2 border rounded"></select>
          <input id="fFrom" type="date" class="px-3 py-2 border rounded" />
          <input id="fTo" type="date" class="px-3 py-2 border rounded" />
          <button data-action="clear-filters" class="px-3 py-2 border rounded">مسح</button>
        </div>

        <div class="overflow-auto">
          <table class="custom">
            <thead>
              <tr>
                <th>تاريخ التنفيذ</th><th>تاريخ الاستحقاق</th><th>الوصف</th><th>الفئة</th><th>الحساب</th><th>المبلغ</th><th>رصيد بعد العملية</th><th>إجراءات</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="mt-3 flex items-center justify-center gap-3">
          <button data-action="prev-page" class="px-3 py-2 border rounded">السابق</button>
          <div id="pageInfo" class="text-sm text-gray-500">الصفحة 1</div>
          <button data-action="next-page" class="px-3 py-2 border rounded">التالي</button>
        </div>
      </div>
    </section>

    <section id="add" class="page-section hidden">
      <div class="card-custom p-4">
        <h3 id="addTxTitle" class="font-semibold mb-2">إضافة حركة</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm">النوع</label>
            <select id="type" class="w-full px-3 py-2 border rounded">
              <option value="income">دخل</option>
              <option value="expense">مصروف</option>
            </select>
          </div>
          <div>
            <label class="text-sm">المبلغ (ج.م)</label>
            <input id="amount" type="number" step="0.01" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="text-sm">تاريخ/وقت التنفيذ (اختياري)</label>
            <input id="exec" type="datetime-local" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="text-sm">تاريخ الاستحقاق</label>
            <input id="date" type="date" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="text-sm">الوصف</label>
            <input id="desc" type="text" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="text-sm">الحساب</label>
            <select id="account" class="w-full px-3 py-2 border rounded"></select>
          </div>
          <div>
            <label class="text-sm">الفئة</label>
            <select id="category" class="w-full px-3 py-2 border rounded"></select>
          </div>
          <div>
            <label class="text-sm">ربط الالتزام (اختياري)</label>
            <select id="linkCommit" class="w-full px-3 py-2 border rounded"></select>
          </div>
          <div class="col-span-3 flex gap-2 mt-2">
            <button data-action="save-tx" class="px-4 py-2 bg-blue-600 text-white rounded">حفظ</button>
            <button data-action="reset-form" class="px-4 py-2 border rounded">إفراغ</button>
          </div>
        </div>
      </div>
    </section>

    <section id="accounts" class="page-section hidden">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card-custom p-4">
          <h3 class="font-semibold mb-2">الحسابات</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="newAccountName" placeholder="اسم الحساب" class="px-3 py-2 border rounded" />
            <input id="newAccountOpening" type="number" placeholder="رصيد افتتاحي" class="px-3 py-2 border rounded" />
            <button data-action="add-account" class="px-3 py-2 border rounded">إضافة حساب</button>
          </div>
          <div id="accountsList" class="mt-3 space-y-2"></div>
        </div>

        <div class="card-custom p-4">
          <h3 class="font-semibold mb-2">الفئات</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="newCatName" placeholder="اسم الفئة" class="px-3 py-2 border rounded" />
            <select id="newCatType" class="px-3 py-2 border rounded"><option value="expense">مصروف</option><option value="income">دخل</option></select>
            <button data-action="add-category" class="px-3 py-2 border rounded">إضافة فئة</button>
          </div>
          <div id="catsList" class="mt-3 space-y-2"></div>
        </div>
      </div>
    </section>

    <section id="commitments" class="page-section hidden">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card-custom p-4">
          <h3 class="font-semibold mb-2">الالتزامات الشهرية</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
            <input id="cName" placeholder="اسم الالتزام" class="px-3 py-2 border rounded" />
            <input id="cAmount" type="number" placeholder="المبلغ" class="px-3 py-2 border rounded" />
            <input id="cFirstDue" type="date" class="px-3 py-2 border rounded" />
            <div class="flex items-center gap-2"><input id="cRecurring" type="checkbox" /><label>يتكرر شهريًا</label></div>
            <input id="cEndAt" type="date" class="px-3 py-2 border rounded col-span-2" placeholder="ينتهي في (عند التكرار)" />
            <button data-action="add-commit" class="px-3 py-2 border rounded">إضافة/تحديث</button>
          </div>

          <div class="mt-4 overflow-auto">
            <table class="custom">
              <thead><tr><th>الاسم</th><th>المبلغ</th><th>استحقاق</th><th>مدفوع (شهر)</th><th>متبقي</th><th>تكرار</th><th>ينتهي</th><th>إجراءات</th></tr></thead>
              <tbody id="tbodyCommit"></tbody>
            </table>
          </div>
        </div>

        <div class="card-custom p-4">
          <h3 class="font-semibold mb-2">التحصيلات</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
            <input id="coName" placeholder="اسم التحصيل" class="px-3 py-2 border rounded" />
            <input id="coAmount" type="number" placeholder="المبلغ" class="px-3 py-2 border rounded" />
            <input id="coFirstDue" type="date" class="px-3 py-2 border rounded" />
            <div class="flex items-center gap-2"><input id="coRecurring" type="checkbox" /><label>يتكرر شهريًا</label></div>
            <input id="coEndAt" type="date" class="px-3 py-2 border rounded col-span-2" />
            <button data-action="add-collect" class="px-3 py-2 border rounded">إضافة/تحديث</button>
          </div>

          <div class="mt-4 overflow-auto">
            <table class="custom">
              <thead><tr><th>الاسم</th><th>المبلغ</th><th>التحصيل القادم</th><th>التكرار</th><th>ينتهي</th><th>إجراءات</th></tr></thead>
              <tbody id="tbodyCollect"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <div class="mt-6 text-center text-sm text-gray-500">تم دمج كل العمليات الحسابية — جرّب إضافة حركة، التزام، تحصيل، أو تحويل، وابعث لي أي ملاحظة.</div>
  </main>
</div>

<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-xl w-11/12 md:w-1/2 max-w-lg" role="dialog" aria-modal="true">
    <h4 id="modalTitle" class="font-semibold mb-3 text-lg">...</h4>
    <div id="modalContent">
      </div>
    <div class="mt-4 flex gap-2 justify-end">
      </div>
  </div>
</div>

<script>
(function() { //  <-- (1) Start IIFE (Technical Perfection)
  'use strict';

  /* ===========================
     Keys and safe load
     =========================== */
  const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1',
        COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1', DARK_KEY='pf_dark_v1';

  function safeParse(key, fallback){
    try{ const raw = localStorage.getItem(key); if(!raw) return fallback; return JSON.parse(raw); }catch(e){ console.error('Corrupt localStorage',key,e); try{ localStorage.setItem(key+'_backup', localStorage.getItem(key)); }catch{} localStorage.removeItem(key); return fallback; }
  }
  let ledger = safeParse(KEY, []);
  let accounts = safeParse(ACC_KEY, []);
  let categories = safeParse(CAT_KEY, []);
  let commitments = safeParse(COM_KEY, []);
  let collections = safeParse(COL_KEY, []);

  let sortedLedger = [];
  let isLedgerDirty = true;
  function markLedgerDirty(){ isLedgerDirty = true; }

  let cachedBalances = null, cachedAfter = null;
  let editTxId = null;
  let editCommitId = null;
  let editCollectId = null;
  let pageSize = 10, currentPage = 1;
  let modalResolver = null; // For modal promise

  /* ===========================
     Utils (same as your code)
     =========================== */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const eid = ()=> Math.random().toString(36).slice(2,10)+Date.now().toString(36);
  const fmt = n => Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
  const escapeHtml = s=>String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  function formatLocalDate(d){ if(!d) return ''; const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function parseLocalDate(str){ if(!str) return null; const [y,m,d]=str.split('-').map(Number); if(!y) return null; const dt=new Date(y,m-1,d,0,0,0,0); dt.setHours(0,0,0,0); return dt; }
  function YM(){ return formatLocalDate(new Date()).slice(0,7); }
  function addMonthsPreserveDOM(date,months){ const d=new Date(date.getTime()); const targetMonth=d.getMonth()+months; const day=d.getDate(),y=d.getFullYear(); const temp=new Date(y,targetMonth+1,0); const lastDay=temp.getDate(); d.setMonth(targetMonth,Math.min(day,lastDay)); d.setHours(0,0,0,0); return d; }
  function daysBetween(a,b){ const MS=24*60*60*1000; const da=new Date(a.getFullYear(),a.getMonth(),a.getDate()); const db=new Date(b.getFullYear(),b.getMonth(),b.getDate()); return Math.round((db-da)/MS); }
  function addMonthsToYm(ym, months){ const parts=(ym||'').split('-').map(Number); const y=parts[0], m=parts[1]; if(!Number.isFinite(y)||!Number.isFinite(m)) return ym; const base=new Date(y,m-1,1); const next=addMonthsPreserveDOM(base, months); return formatLocalDate(next).slice(0,7); }
  function persist(key,obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){ console.error('persist error',e); } }
  
  /* ===========================
     Modal / UX Helpers (NEW)
     =========================== */
  
  // Replaces alert()
  function showAlert(title, message) {
    const modal = $('#modalBackdrop');
    $('#modalTitle').textContent = title;
    $('#modalContent').innerHTML = `<p>${escapeHtml(message)}</p>`;
    
    const actions = modal.querySelector('.mt-4');
    actions.innerHTML = `<button data-action="modal-close" class="px-4 py-2 bg-blue-600 text-white rounded">موافق</button>`;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modalResolver = null;
  }
  
  // Replaces confirm()
  function showConfirm(title, message) {
    return new Promise((resolve) => {
      const modal = $('#modalBackdrop');
      $('#modalTitle').textContent = title;
      $('#modalContent').innerHTML = `<p>${escapeHtml(message)}</p>`;
      
      const actions = modal.querySelector('.mt-4');
      actions.innerHTML = `
        <button data-action="modal-confirm" class="px-4 py-2 bg-blue-600 text-white rounded">تأكيد</button>
        <button data-action="modal-close" class="px-4 py-2 border rounded">إلغاء</button>
      `;
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      modalResolver = resolve; // Store the resolver function
    });
  }
  
  // Replaces prompt()
  function showPrompt(title, options) {
    return new Promise((resolve) => {
      const modal = $('#modalBackdrop');
      $('#modalTitle').textContent = title;
      
      const optionsHtml = options.map((opt, i) => 
        `<option value="${escapeHtml(opt.value)}">${escapeHtml(opt.label)}</option>`
      ).join('');
      
      $('#modalContent').innerHTML = `
        <select id="modalSelect" class="w-full px-3 py-2 border rounded">
          ${optionsHtml}
        </select>
      `;
      
      const actions = modal.querySelector('.mt-4');
      actions.innerHTML = `
        <button data-action="modal-submit-select" class="px-4 py-2 bg-blue-600 text-white rounded">اختيار</button>
        <button data-action="modal-close" class="px-4 py-2 border rounded">إلغاء</button>
      `;
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      modalResolver = resolve;
    });
  }

  function closeModal(value) {
    $('#modalBackdrop').classList.add('hidden');
    $('#modalBackdrop').classList.remove('flex');
    if (modalResolver) {
      modalResolver(value); // Resolve the promise
      modalResolver = null;
    }
  }

  /* ===========================
     Core Logic (Caching & Balances)
     =========================== */
  function ensureSortedLedger(){
    if(!isLedgerDirty && sortedLedger.length) return;
    sortedLedger = [...ledger].slice().sort((a,b)=>{
      const aKey = (a.exec||a.created||a.date||'');
      const bKey = (b.exec||b.created||b.date||'');
      if(aKey === bKey) return (a.id||'').localeCompare(b.id||'');
      return aKey.localeCompare(bKey);
    });
    isLedgerDirty = false;
  }

  function computeBalances(){
    ensureSortedLedger();
    const bal = new Map(accounts.map(a=>[a.name, Number(a.opening||0)]));
    const after = new Map();
    for(const t of sortedLedger){
      const cur = bal.get(t.account) ?? 0;
      const delta = (t.type==='income' ? Number(t.amount||0) : -Number(t.amount||0));
      const next = cur + delta;
      bal.set(t.account, next);
      after.set(t.id, next);
    }
    cachedBalances = bal; cachedAfter = after;
    return {bal,after};
  }

  /* ===========================
     Single Source of Truth Logic (Corrected)
     =========================== */

  // For Commitments (Expenses) - Your logic was correct
  function getCommitmentState(commit){
    if(!commit || !commit.firstDue) return { done: true };
    const amount = Number(commit.amount||0);
    const start = parseLocalDate(commit.firstDue);
    if(!start) return { done: true };
    const endDate = commit.endAt ? parseLocalDate(commit.endAt) : null;

    const payMap = new Map();
    for(const t of ledger){
      if(t.linkCommitId !== commit.id) continue;
      const ym = (t.exec||t.created||t.date||'').slice(0,7);
      if(!ym) continue;
      payMap.set(ym, (payMap.get(ym) || 0) + Number(t.amount||0));
    }
    
    let cursor = new Date(start.getTime());
    for(let i=0; i<500; i++){ // 500 months guard
      if(endDate && cursor > endDate) return { done:true };
      const ym = formatLocalDate(cursor).slice(0,7);
      const paidThisMonth = payMap.get(ym) || 0;
      if(paidThisMonth + 1e-9 < amount){
        return { done: false, currentDueYm: ym, paid: paidThisMonth, remaining: Math.max(0, amount - paidThisMonth) };
      }
      if(!commit.recurring) return { done: true }; // One-time, paid
      cursor = addMonthsPreserveDOM(cursor,1);
    }
    return { done: true }; // Guard hit
  }

  // (NEW) For Collections (Income) - Fixes the calculation error
  function getCollectionState(collect){
    if(!collect || !collect.firstDue) return { done: true };
    const amount = Number(collect.amount||0);
    const start = parseLocalDate(collect.firstDue);
    if(!start) return { done: true };
    const endDate = collect.endAt ? parseLocalDate(collect.endAt) : null;

    const collectMap = new Map();
    for(const t of ledger){
      if(t.sourceCollectionId !== `collect_${collect.id}`) continue;
      const ym = (t.exec||t.created||t.date||'').slice(0,7);
      if(!ym) continue;
      collectMap.set(ym, (collectMap.get(ym) || 0) + Number(t.amount||0));
    }
    
    let cursor = new Date(start.getTime());
    for(let i=0; i<500; i++){ // 500 months guard
      if(endDate && cursor > endDate) return { done:true };
      const ym = formatLocalDate(cursor).slice(0,7);
      const collectedThisMonth = collectMap.get(ym) || 0;
      if(collectedThisMonth + 1e-9 < amount){
        return { done: false, currentDueYm: ym, collected: collectedThisMonth, remaining: Math.max(0, amount - collectedThisMonth) };
      }
      if(!collect.recurring) return { done: true }; // One-time, paid
      cursor = addMonthsPreserveDOM(cursor,1);
    }
    return { done: true }; // Guard hit
  }

  /* ===========================
     DRAW functions
     =========================== */
  function drawPerAccount(){
    computeBalances();
    const list = [];
    for(const a of accounts){
      const v = (cachedBalances && cachedBalances.get(a.name)!==undefined) ? cachedBalances.get(a.name) : Number(a.opening||0);
      list.push(`<div class="flex justify-between items-center"><div>${escapeHtml(a.name)}</div><div><b>${fmt(v)} ج.م</b></div></div>`);
    }
    $('#perAccount').innerHTML = list.join('');
  }

  function drawCommitments(){
    const rows = commitments.slice().sort((a,b)=> (a.firstDue||'').localeCompare(b.firstDue||''));
    $('#tbodyCommit').innerHTML = rows.map(c=>{
      const st = getCommitmentState(c);
      const paid = st.paid || 0;
      const remaining = st.done ? 0 : st.remaining;
      const due = st.done ? '—' : (st.currentDueYm || (c.firstDue? c.firstDue.slice(0,7) : '—'));
      return `<tr class="row-item" data-id="${c.id}">
        <td class="p-2">${escapeHtml(c.name)}</td>
        <td class="p-2">${fmt(c.amount)}</td>
        <td class="p-2">${escapeHtml(due)}</td>
        <td class="p-2">${fmt(paid)}</td>
        <td class="p-2"><b>${fmt(remaining)}</b></td>
        <td class="p-2">${c.recurring? 'شهري':'مرة'}</td>
        <td class="p-2">${c.endAt||'—'}</td>
        <td class="p-2">
          <button data-action="pay-commit" data-id="${c.id}" class="px-2 py-1 bg-blue-600 text-white rounded">سداد</button>
          <button data-action="edit-commit" data-id="${c.id}" class="px-2 py-1 border rounded">تعديل</button>
          <button data-action="del-commit" data-id="${c.id}" class="px-2 py-1 bg-red-500 text-white rounded">حذف</button>
        </td>
      </tr>`;
    }).join('');
  }

  function drawCollections(){
    const rows = collections.slice().sort((a,b)=> (a.firstDue||'').localeCompare(b.firstDue||''));
    $('#tbodyCollect').innerHTML = rows.map(c=>{
      // (Corrected) Use new function
      const st = getCollectionState(c);
      const due = st.done ? '—' : st.currentDueYm;
      return `<tr class="row-item" data-id="${c.id}">
        <td class="p-2">${escapeHtml(c.name)}</td>
        <td class="p-2">${fmt(c.amount)}</td>
        <td class="p-2">${escapeHtml(due)}</td>
        <td class="p-2">${c.recurring? 'شهري':'مرة'}</td>
        <td class="p-2">${c.endAt||'—'}</td>
        <td class="p-2">
          <button data-action="collect-now" data-id="${c.id}" class="px-2 py-1 bg-blue-600 text-white rounded">تم التحصيل</button>
          <button data-action="edit-collect" data-id="${c.id}" class="px-2 py-1 border rounded">تعديل</button>
          <button data-action="del-collect" data-id="${c.id}" class="px-2 py-1 bg-red-500 text-white rounded">حذف</button>
        </td>
      </tr>`;
    }).join('');
  }

  function drawDueSoon(){
    const wrap = $('#dueSoonWrap');
    if(!wrap) return;
    const ym = YM();
    const list = commitments.map(c=>{
      const st = getCommitmentState(c);
      if(st.done || st.currentDueYm !== ym) return null;
      return {...c, dueStr: st.currentDueYm, paid:st.paid, remaining:st.remaining };
    }).filter(Boolean).sort((a,b)=> a.dueStr.localeCompare(b.dueStr));
    
    if(list.length === 0){
      wrap.innerHTML = `<div class="text-sm text-gray-500">لا توجد استحقاقات هذا الشهر غير مسددة.</div>`;
    } else {
      wrap.innerHTML = list.map(x=>`
        <div class="mb-3 p-3 border rounded">
          <div class="flex justify-between"><div class="font-bold">${escapeHtml(x.name)}</div><div class="font-bold">${fmt(x.remaining)} ج.م</div></div>
          <div class="text-xs text-gray-500">الأصل: ${fmt(x.amount)} · المدفوع: ${fmt(x.paid)}</div>
          <div class="mt-2"><button data-action="pay-commit" data-id="${x.id}" class="px-3 py-1 bg-blue-600 text-white rounded">سداد الآن</button></div>
        </div>
      `).join('');
    }
  }

  function drawAccountsList(){
    $('#accountsList').innerHTML = accounts.map((a,i)=>`<div class="flex items-center gap-2"><div class="badge-custom">${escapeHtml(a.name)} · <b>${fmt(a.opening||0)} ج.م</b></div><div class="ml-auto space-x-2"><button data-action="rename-acc" data-i="${i}" class="px-2 py-1 border rounded">تعديل</button><button data-action="remove-acc" data-i="${i}" class="px-2 py-1 border rounded">حذف</button></div></div>`).join('');
  }
  function drawCatsList(){
    $('#catsList').innerHTML = categories.map((c,i)=>`<div class="flex items-center gap-2"><div class="badge-custom">${escapeHtml(c.name)} · ${c.type==='income'?'دخل':'مصروف'}</div><div class="ml-auto space-x-2"><button data-action="rename-cat" data-i="${i}" class="px-2 py-1 border rounded">تعديل</button><button data-action="remove-cat" data-i="${i}" class="px-2 py-1 border rounded">حذف</button></div></div>`).join('');
  }

  /* refresh select elements */
  function refreshAccountSelects(){
    const opts = accounts.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
    if($('#account')) $('#account').innerHTML = opts;
    if($('#fAccount')) $('#fAccount').innerHTML = `<option value="all">كل الحسابات</option>` + opts;
  }
  function refreshCategorySelect(){
    const currentType = $('#type').value;
    const cats = categories.filter(c => c.type === currentType);
    if($('#category')) $('#category').innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
  }
  function refreshLinkCommitOptions(){
    if(!$('#linkCommit')) return;
    const ym = YM();
    const opts = commitments.filter(c=>{
      const st = getCommitmentState(c);
      return !st.done && st.currentDueYm === ym;
    }).map(c=>`<option value="${c.id}">${escapeHtml(c.name)} — متبقي ${fmt(getCommitmentState(c).remaining)}</option>`).join('');
    $('#linkCommit').innerHTML = `<option value="">— بدون —</option>` + opts;
  }

  /* ===========================
     Transactions rendering + paging
     =========================== */
  function renderTransactions(){
    ensureSortedLedger();
    const q = ($('#search')?.value||'').toLowerCase();
    const ft = $('#fType')?.value || 'all';
    const fa = $('#fAccount')?.value || 'all';
    const ff = $('#fFrom')?.value || '';
    const fto = $('#fTo')?.value || '';

    const rows = [...sortedLedger].filter(t=>{
      if(q && !((t.desc||'').toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q))) return false;
      if(ft !== 'all' && t.type !== ft) return false;
      if(fa !== 'all' && t.account !== fa) return false;
      if(ff && (t.date||'') < ff) return false;
      if(fto && (t.date||'') > fto) return false;
      return true;
    }).sort((a,b)=>{ // Sort for display (newest first)
      const aKey = (a.exec||a.created||a.date||'');
      const bKey = (b.exec||b.created||b.date||'');
      if(aKey === bKey) return (b.id||'').localeCompare(a.id||'');
      return bKey.localeCompare(aKey);
    });

    const total = rows.length;
    const pages = Math.max(1, Math.ceil(total/pageSize));
    if(currentPage > pages) currentPage = pages;
    const start = (currentPage - 1) * pageSize;
    const pageRows = rows.slice(start, start+pageSize);
    
    // Ensure balances are computed
    if (!cachedAfter) computeBalances();
    const after = (cachedAfter || new Map());

    $('#tbody').innerHTML = pageRows.map(t=>{
      const cls = t.type==='income' ? 'inc' : 'exp';
      const afterVal = after.has(t.id) ? after.get(t.id) : 0;
      const execTxt = t.exec ? new Date(t.exec).toLocaleString('ar-EG') : (t.created ? new Date(t.created).toLocaleString('ar-EG') : '—');
      const dueTxt = t.date || t.due || '—';
      const tag = t.isTransfer ? ' <small class="text-gray-500">↔︎ تحويل</small>' : '';
      return `<tr class="row-item" data-id="${t.id}">
        <td class="p-2">${escapeHtml(execTxt)}</td>
        <td class="p-2">${escapeHtml(dueTxt)}</td>
        <td class="p-2">${escapeHtml(t.desc||'—')}${tag}</td>
        <td class="p-2">${escapeHtml(t.category||'—')}</td>
        <td class="p-2">${escapeHtml(t.account||'—')}</td>
        <td class="p-2 amount ${cls}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
        <td class="p-2">${fmt(afterVal)}</td>
        <td class="p-2">
          <button data-action="edit-tx" data-id="${t.id}" class="px-2 py-1 border rounded">تعديل</button>
          <button data-action="del-tx" data-id="${t.id}" class="px-2 py-1 bg-red-500 text-white rounded">حذف</button>
        </td>
      </tr>`;
    }).join('');
    $('#pageInfo').textContent = `الصفحة ${currentPage} من ${pages} — إجمالي ${total}`;
    $('#prevPage').disabled = currentPage <= 1;
    $('#nextPage').disabled = currentPage >= pages;
  }

  /* ===========================
     Summary / recalc
     =========================== */
  function computeAndUpdateSummary(){
    ensureSortedLedger(); computeBalances();
    let total = 0; for(const v of (cachedBalances || new Map()).values()) total += v;
    
    const ym = YM();
    let commitTotalThis = 0, commitRemainThis = 0;
    for(const c of commitments){
      const st = getCommitmentState(c);
      if(!st.done && st.currentDueYm === ym){ 
        commitTotalThis += Number(c.amount||0); 
        commitRemainThis += st.remaining; 
      }
    }
    
    // (Corrected) Use getCollectionState
    let collectTotalThis = 0, collectRemainThis = 0;
    for(const c of collections){
      const st = getCollectionState(c);
      if(!st.done && st.currentDueYm === ym){
        collectTotalThis += Number(c.amount||0);
        collectRemainThis += st.remaining;
      }
    }
    
    const afterCom = total - commitRemainThis + collectRemainThis; // Corrected logic
    
    $('#totalBalance').textContent = fmt(total) + ' ج.م';
    $('#balanceAfterCommit').textContent = fmt(afterCom) + ' ج.م';
    $('#totalCommitThis').textContent = `${fmt(commitTotalThis)} / ${fmt(commitRemainThis)}`;
    $('#totalCollectThis').textContent = `${fmt(collectTotalThis)} / ${fmt(collectRemainThis)}`;

    drawPerAccount();
    // latest
    $('#latestTx').innerHTML = ledger.slice().sort((a,b)=> (b.exec||b.created||'').localeCompare(a.exec||a.created||'')).slice(0,5).map(t=>`<div class="flex justify-between py-2 border-b"><div><b>${escapeHtml(t.desc||'—')}</b><div class="text-xs text-gray-500">${escapeHtml(t.category||'')}</div></div><div class="${t.type==='income'?'text-green-600':'text-red-600'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div></div>`).join('');
    $('#monthLabel').textContent = new Date().toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
  }

  /* ===========================
     Base Data
     =========================== */
  function ensureTransferCategories(){
    const need=[{name:'تحويل صادر',type:'expense'},{name:'تحويل وارد',type:'income'},{name:'عمولة تحويل',type:'expense'}];
    let changed=false;
    for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } }
    if(changed) persist(CAT_KEY, categories);
  }
  function ensureBaseData(){
    if(accounts.length === 0){ accounts = [{name:'كاش', opening:0},{name:'حساب بنكي', opening:0},{name:'محفظة', opening:0}]; persist(ACC_KEY, accounts); }
    if(categories.length === 0){ categories = [{name:'مرتب',type:'income'},{name:'دخل آخر',type:'income'},{name:'أكل وشرب',type:'expense'},{name:'مواصلات',type:'expense'},{name:'فواتير',type:'expense'},{name:'تسوق',type:'expense'}]; persist(CAT_KEY, categories); }
    ensureTransferCategories();
  }
  
  /* ===========================
     Navigation & Theme
     =========================== */
  function applyDark(){ 
    const saved = localStorage.getItem(DARK_KEY); 
    if(saved === '1'){ 
      document.documentElement.classList.add('dark'); 
      $('#darkToggle').textContent='Light'; 
    } else { 
      document.documentElement.classList.remove('dark'); 
      $('#darkToggle').textContent='Dark'; 
    } 
  }

  function gotoPage(p){
    $$('.page-section').forEach(s=> s.classList.add('hidden'));
    const map = { dashboard:'#dashboard', transactions:'#transactions', add:'#add', accounts:'#accounts', commitments:'#commitments' };
    const sel = map[p] || '#dashboard';
    $(sel)?.classList.remove('hidden');
    
    $$('.nav-btn').forEach(n=>n.classList.remove('bg-gray-100','dark:bg-gray-700', 'font-semibold'));
    $$(`.nav-btn[data-page="${p}"]`).forEach(n=>n.classList.add('bg-gray-100','dark:bg-gray-700', 'font-semibold'));
    
    window.scrollTo({top:0,behavior:'smooth'});
    
    // Refresh relevant data
    if(p === 'dashboard') {
      computeAndUpdateSummary();
      drawDueSoon();
    }
    if(p === 'transactions') {
      renderTransactions();
    }
  }

  /* ===========================
     SINGLE EVENT LISTENER (Cleaned up)
     =========================== */
  
  document.addEventListener('click', async (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) {
      // Check for nav-btn separately
      const navBtn = e.target.closest('.nav-btn');
      if(navBtn){
        e.preventDefault();
        gotoPage(navBtn.dataset.page);
      }
      return;
    }

    const action = target.dataset.action;
    const id = target.dataset.id;
    const i = target.dataset.i;

    // --- Modal Actions ---
    if(action === 'modal-close') {
      closeModal(false);
    }
    if(action === 'modal-confirm') {
      closeModal(true);
    }
    if(action === 'modal-submit-select') {
      const val = $('#modalSelect').value;
      closeModal(val);
    }

    // --- Navigation & Theme ---
    if (action === 'toggle-dark') {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem(DARK_KEY, isDark ? '1' : '0');
      target.textContent = isDark ? 'Light' : 'Dark';
    }
    
    // --- Paging & Filters ---
    if(action === 'prev-page') { if(currentPage>1) currentPage--; renderTransactions(); }
    if(action === 'next-page') { currentPage++; renderTransactions(); } // (will be capped by render)
    if(action === 'clear-filters') {
      $('#search').value=''; $('#fType').value='all'; $('#fAccount').value='all'; $('#fFrom').value=''; $('#fTo').value='';
      currentPage=1; renderTransactions();
    }

    // --- Export/Import ---
    if(action === 'export-json') {
      const data={ ledger, accounts, categories, commitments, collections, exportedAt:new Date().toISOString() };
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='my-finance-data.json';
      a.click(); URL.revokeObjectURL(a.href);
    }
    if(action === 'import-json') {
      $('#importFile').click();
    }
    if(action === 'sync-now') {
      showAlert('مزامنة', 'ميزة المزامنة الحقيقية تحتاج ربط خدمة سحابية. هذه نسخة محلية فقط.');
    }

    // --- Add/Edit Tx ---
    if(action === 'save-tx') {
      const type = $('#type').value, amount = parseFloat($('#amount').value || '0'), execVal = $('#exec').value, dateVal = $('#date').value;
      const desc = ($('#desc').value||'').trim(), account = $('#account').value, category = $('#category').value, linkCommitId = $('#linkCommit').value || '';
      if(!account || !category || !amount || amount<=0){ return showAlert('خطأ', 'من فضلك أدخل: حساب/فئة/مبلغ صحيح'); }
      let execISO = execVal ? new Date(execVal).toISOString() : new Date().toISOString();
      let dueDate = dateVal || (execISO.slice(0,10));
      if(linkCommitId){
        const commit = commitments.find(c=>c.id === linkCommitId);
        if(commit){
          const st = getCommitmentState(commit);
          const ym = st.currentDueYm || (commit.firstDue ? commit.firstDue.slice(0,7) : execISO.slice(0,7));
          dueDate = ym + '-01';
        }
      }
      const tx = { id: editTxId || eid(), created: new Date().toISOString(), exec: execISO, date: dueDate, due: dueDate, desc, type, amount: Number(amount), account, category };
      if(linkCommitId && type==='expense') tx.linkCommitId = linkCommitId;
      if(editTxId){
        const idx = ledger.findIndex(t=>t.id===editTxId);
        if(idx>-1) ledger[idx] = tx;
      } else {
        ledger.push(tx);
      }
      persist(KEY, ledger); markLedgerDirty();
      if(editTxId) gotoPage('transactions'); else gotoPage('dashboard');
      resetForm();
    }
    if(action === 'reset-form') {
      resetForm();
    }
    if(action === 'edit-tx') {
      const t = ledger.find(x=>x.id===id); if(!t) return;
      editTxId = id; $('#addTxTitle').textContent='تحديث حركة'; $('#type').value = t.type; $('#amount').value = t.amount; $('#desc').value = t.desc||''; $('#account').value = t.account||'';
      refreshCategorySelect(); // Must call after setting type
      $('#category').value = t.category||''; 
      if(t.exec) { const d = new Date(t.exec); const tzOffset = d.getTimezoneOffset()*60000; const localISOTime = new Date(d - tzOffset).toISOString().slice(0,16); $('#exec').value = localISOTime; } else $('#exec').value = ''; 
      $('#date').value = t.date || t.due || ''; $('#linkCommit').value = t.linkCommitId || '';
      gotoPage('add');
    }
    if(action === 'del-tx') {
      if(await showConfirm('حذف حركة', 'هل تريد حذف هذه الحركة؟ هذا لا يمكن التراجع عنه.')){ 
        ledger = ledger.filter(t=>t.id!==id); persist(KEY, ledger); markLedgerDirty(); 
        renderTransactions(); computeAndUpdateSummary(); drawCommitments(); drawDueSoon(); 
      }
    }

    // --- Accounts ---
    if(action === 'add-account') {
      const name = ($('#newAccountName').value||'').trim(); const opening = Number($('#newAccountOpening').value||0);
      if(!name){ return showAlert('خطأ', 'ادخل اسم الحساب'); }
      accounts.push({name, opening: Number(opening||0)}); persist(ACC_KEY, accounts);
      $('#newAccountName').value=''; $('#newAccountOpening').value='';
      drawAccountsList(); refreshAccountSelects(); computeAndUpdateSummary();
    }
    if(action === 'rename-acc') {
      const idx = Number(i); const cur = accounts[idx]; if(!cur) return;
      const newName = prompt('اسم الحساب الجديد', cur.name); // Simple prompt is OK for rename
      if(newName){ 
        const openingStr = prompt('الرصيد الافتتاحي', cur.opening||0); const opening = parseFloat(openingStr);
        const oldName = cur.name; accounts[idx].name = newName.trim(); if(Number.isFinite(opening)) accounts[idx].opening = opening; 
        for(const t of ledger){ if(t.account === oldName) t.account = accounts[idx].name; } 
        persist(KEY, ledger); persist(ACC_KEY, accounts); markLedgerDirty();
        drawAccountsList(); refreshAccountSelects(); computeAndUpdateSummary();
      }
    }
    if(action === 'remove-acc') {
      if(await showConfirm('حذف حساب', 'سيتم حذف الحساب من القوائم (لن تُحذف الحركات القديمة). متابعة؟')){
        accounts.splice(Number(i),1); persist(ACC_KEY, accounts);
        drawAccountsList(); refreshAccountSelects(); computeAndUpdateSummary();
      }
    }

    // --- Categories ---
    if(action === 'add-category') {
      const name = ($('#newCatName').value||'').trim(); const type = $('#newCatType').value;
      if(!name){ return showAlert('خطأ', 'ادخل اسم الفئة'); }
      categories.push({name,type}); persist(CAT_KEY, categories);
      $('#newCatName').value='';
      drawCatsList(); refreshCategorySelect();
    }
    // (rename/remove-cat actions are simple, leaving as-is)

    // --- Commitments ---
    if(action === 'add-commit') {
      const name = ($('#cName').value||'').trim(); const amount = Number($('#cAmount').value||0); const firstDueStr = $('#cFirstDue').value; const recurring = $('#cRecurring').checked; const endAt = $('#cEndAt').value || null;
      if(!name || !amount || !firstDueStr){ return showAlert('خطأ', 'أدخل اسم + مبلغ صحيح + تاريخ أول استحقاق'); }
      if(recurring && !endAt){ return showAlert('خطأ', 'عند التكرار يجب تحديد تاريخ النهاية'); }
      const firstDue = parseLocalDate(firstDueStr);
      const commit = { id: editCommitId || eid(), name, amount: Number(amount), firstDue: formatLocalDate(firstDue), recurring, endAt: recurring ? (endAt||null) : null };
      if(editCommitId){
        const idx = commitments.findIndex(c=>c.id===editCommitId); if(idx > -1) commitments[idx] = commit;
      } else {
        commitments.push(commit);
      }
      persist(COM_KEY, commitments); resetCommitForm();
      drawCommitments(); drawDueSoon(); computeAndUpdateSummary();
    }
    if(action === 'edit-commit') {
      const c = commitments.find(x=>x.id===id); if(!c) return;
      editCommitId = id; $('#cName').value = c.name; $('#cAmount').value = c.amount; $('#cFirstDue').value = c.firstDue||''; $('#cRecurring').checked = !!c.recurring; $('#cEndAt').value = c.endAt||'';
      $('#addCommitment').textContent='تحديث الالتزام';
    }
    if(action === 'del-commit') {
      if(await showConfirm('حذف التزام', 'هل تريد حذف هذا الالتزام؟ (ستبقى أي دفعات سُجلت محفوظة)')){
        commitments = commitments.filter(x=>x.id!==id); persist(COM_KEY, commitments);
        drawCommitments(); drawDueSoon(); computeAndUpdateSummary();
      }
    }
    if(action === 'pay-commit') {
      const c = commitments.find(x=>x.id===id); if(!c) return;
      const st = getCommitmentState(c); if(st.done){ return showAlert('تم', 'هذا الالتزام مدفوع أو منتهي.'); }
      const remain = st.remaining;
      const accOpts = accounts.map((a,i)=> ({ value: a.name, label: `${a.name} (${fmt(cachedBalances.get(a.name) || 0)})` }));
      const accName = await showPrompt(`اختر حساب لسداد: ${c.name} (${fmt(remain)})`, accOpts);
      if(!accName) return; // User cancelled
      const execISO = new Date().toISOString();
      const due = st.currentDueYm ? (st.currentDueYm + '-01') : (c.firstDue || execISO.slice(0,10));
      ledger.push({ id:eid(), created: new Date().toISOString(), exec: execISO, date: due, due, desc:`${c.name} (سداد التزام)`, type:'expense', amount:remain, account:accName, category:'التزامات شهرية', linkCommitId:c.id });
      persist(KEY, ledger); markLedgerDirty();
      drawCommitments(); drawDueSoon(); renderTransactions(); computeAndUpdateSummary();
    }

    // --- Collections ---
    if(action === 'add-collect') {
      const name = ($('#coName').value||'').trim(); const amount = Number($('#coAmount').value||0); const firstDueStr = $('#coFirstDue').value; const recurring = $('#coRecurring').checked; const endAt = $('#coEndAt').value || null;
      if(!name || !amount || !firstDueStr){ return showAlert('خطأ', 'أدخل اسم + مبلغ صحيح + تاريخ أول استحقاق'); }
      if(recurring && !endAt){ return showAlert('خطأ', 'عند التكرار يجب تحديد تاريخ النهاية'); }
      const firstDue = parseLocalDate(firstDueStr);
      const item = { id: editCollectId || eid(), name, amount: Number(amount), firstDue: formatLocalDate(firstDue), recurring, endAt: recurring ? (endAt||null) : null };
      if(editCollectId){
        const idx = collections.findIndex(c=>c.id===editCollectId); if(idx > -1) collections[idx] = item;
      } else {
        collections.push(item);
      }
      persist(COL_KEY, collections); resetCollectForm();
      drawCollections(); computeAndUpdateSummary();
    }
    if(action === 'edit-collect') {
      const c = collections.find(x=>x.id===id); if(!c) return;
      editCollectId = id; $('#coName').value=c.name; $('#coAmount').value=c.amount; $('#coFirstDue').value=c.firstDue||''; $('#coRecurring').checked=!!c.recurring; $('#coEndAt').value=c.endAt||'';
      $('#addCollect').textContent='تحديث التحصيل';
    }
    if(action === 'del-collect') {
      if(await showConfirm('حذف تحصيل', 'هل تريد حذف هذا التحصيل؟')){
        collections = collections.filter(x=>x.id!==id); persist(COL_KEY, collections);
        drawCollections(); computeAndUpdateSummary();
      }
    }
    if(action === 'collect-now') {
      const c = collections.find(x=>x.id===id); if(!c) return;
      // (Corrected) Use new function
      const st = getCollectionState(c);
      if(st.done) { return showAlert('تم', 'هذا التحصيل مكتمل أو منتهي.'); }
      
      const accOpts = accounts.map((a,i)=> ({ value: a.name, label: a.name }));
      const accName = await showPrompt(`اختر حساب لتحصيل: ${c.name} (${fmt(st.remaining)})`, accOpts);
      if(!accName) return; // User cancelled
      
      const execISO = new Date().toISOString();
      const due = st.currentDueYm ? (st.currentDueYm + '-01') : (c.firstDue || execISO.slice(0,10));
      ledger.push({ id:eid(), created: new Date().toISOString(), exec: execISO, date: due, due, desc:`${c.name} (تحصيل)`, type:'income', amount:st.remaining, account:accName, category:'تحصيلات شهرية', sourceCollectionId:`collect_${c.id}` });
      persist(KEY, ledger); markLedgerDirty();
      drawCollections(); renderTransactions(); drawCommitments(); drawDueSoon(); computeAndUpdateSummary();
    }

  }); // <-- End of global click listener

  /* ===========================
     Helper functions
     =========================== */
  function resetForm(){
    editTxId = null; $('#addTxTitle').textContent='إضافة حركة';
    $('#type').value = 'expense'; $('#amount').value = ''; $('#exec').value = '';
    $('#date').value = ''; $('#desc').value = ''; $('#linkCommit').value = '';
    refreshCategorySelect();
  }
  function resetCommitForm() {
    editCommitId = null;
    $('#cName').value=''; $('#cAmount').value=''; $('#cFirstDue').value='';
    $('#cRecurring').checked=false; $('#cEndAt').value='';
    $('#addCommitment').textContent='إضافة/تحديث';
  }
  function resetCollectForm() {
    editCollectId = null;
    $('#coName').value=''; $('#coAmount').value=''; $('#coFirstDue').value='';
    $('#coRecurring').checked=false; $('#coEndAt').value='';
    $('#addCollect').textContent='إضافة/تحديث';
  }
  
  /* ===========================
     Event Listeners (non-click)
     =========================== */
  
  // Filters
  $('#search')?.addEventListener('input', ()=>{ currentPage = 1; renderTransactions(); });
  $('#fType')?.addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); refreshCategorySelect(); });
  $('#fAccount')?.addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); });
  $('#fFrom')?.addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); });
  $('#fTo')?.addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); });

  // Add Tx Form
  $('#type')?.addEventListener('change', ()=>{ refreshCategorySelect(); refreshLinkCommitOptions(); });
  
  // Import File
  $('#importFile')?.addEventListener('change', async (e)=>{ 
    const file=e.target.files?.[0]; if(!file) return; 
    try{ 
      const text = await file.text(); const data = JSON.parse(text); 
      if(Array.isArray(data.ledger)) ledger = data.ledger; 
      if(Array.isArray(data.accounts)) accounts = data.accounts; 
      if(Array.isArray(data.categories)) categories = data.categories; 
      if(Array.isArray(data.commitments)) commitments = data.commitments; 
      if(Array.isArray(data.collections)) collections = data.collections; 
      persist(KEY, ledger); persist(ACC_KEY, accounts); persist(CAT_KEY, categories); persist(COM_KEY, commitments); persist(COL_KEY, collections); 
      markLedgerDirty(); 
      init(); // Re-initialize all
      showAlert('تم', 'تم الاستيراد بنجاح'); 
    }catch(err){ showAlert('خطأ', 'خطأ أثناء الاستيراد: '+(err.message||err)); } 
    e.target.value=''; 
  });
  
  // Error logging
  window.addEventListener('error', e => { console.error('Runtime error:', e.message, e.filename+':'+e.lineno); });

  /* ===========================
     Init
     =========================== */
  function init(){
    applyDark(); 
    ensureBaseData(); 
    ensureSortedLedger(); 
    computeBalances();
    drawAccountsList(); 
    drawCatsList(); 
    refreshAccountSelects(); 
    refreshCategorySelect(); 
    refreshLinkCommitOptions();
    drawCommitments(); 
    drawCollections(); 
    drawDueSoon(); 
    renderTransactions(); 
    computeAndUpdateSummary();
    gotoPage('dashboard');
  }
  
  init(); // <-- Run the app

})(); // <-- (2) End IIFE
</script>
</body>
</html>
