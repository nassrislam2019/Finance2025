<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>My Finance</title>
    <style>
        /* --- CSS STYLING --- */
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .dark {
            --primary: #6366f1;
            --primary-light: #312e81;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --text-sub: #94a3b8;
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; transition: background 0.2s, color 0.2s; overscroll-behavior-y: none; }

        .container { max-width: 600px; margin: 0 auto; padding: 16px; }

        /* Typography */
        h1, h2, h3 { margin: 0; }
        .text-xl { font-size: 20px; font-weight: 700; }
        .text-lg { font-size: 18px; font-weight: 700; }
        .text-sm { font-size: 14px; }
        .text-xs { font-size: 12px; }
        .text-sub { color: var(--text-sub); }
        .bold { font-weight: 700; }
        .uppercase { text-transform: uppercase; }

        /* Components */
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 16px; border: 1px solid var(--border); transition: transform 0.2s ease; }
        .btn { border: none; padding: 12px 16px; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 14px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }

        /* Header & Nav */
        header { position: sticky; top: 0; background: var(--card); padding: 16px; border-bottom: 1px solid var(--border); z-index: 50; display: flex; justify-content: space-between; align-items: center; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0 24px 0; z-index: 50; }
        .nav-item { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-sub); font-size: 10px; font-weight: 700; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        /* Inputs */
        .input-group { margin-bottom: 12px; }
        .label { display: block; font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 6px; }
        .input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 16px; outline: none; }
        .input:focus { border-color: var(--primary); }

        /* FAB */
        .fab { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4); z-index: 40; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        [dir="rtl"] .fab { right: auto; left: 20px; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal.open { display: flex; }
        .modal-content { background: var(--card); width: 100%; max-width: 400px; border-radius: 20px; padding: 20px; max-height: 90vh; overflow-y: auto; animation: popUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Icons */
        .icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }

        /* Helpers */
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .hidden { display: none !important; }

        /* Delete Confirm Modal Specifics */
        .confirm-icon { width: 60px; height: 60px; background: #fee2e2; border-radius: 50%; color: var(--danger); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px auto; }

        .small { font-size: 12px; }
        
        /* Swipe visual cue */
        .swipe-hint { transition: transform 0.2s; }
        .swiping { transform: translateX(-30px); opacity: 0.7; }
    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-2">
            <!-- New Icon: Wallet -->
            <div style="width:32px; height:32px; background:var(--primary); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
            </div>
            <div class="text-lg bold" id="appTitle">My Finance</div>
        </div>
        <button class="btn-ghost" style="font-size:20px;" onclick="toggleTheme()" id="themeBtn" aria-label="Toggle theme">ðŸŒž</button>
    </header>

    <div id="mainContainer" class="container"></div>

    <button class="fab" onclick="openModal('add')" aria-label="Add transaction">+</button>

    <nav>
        <button class="nav-item active" onclick="switchView('dashboard')" id="nav-dash" aria-label="Dashboard">
            <svg class="icon"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
            <span data-i18n="dash">Dashboard</span>
        </button>
        <button class="nav-item" onclick="switchView('transactions')" id="nav-tx" aria-label="Transactions">
            <svg class="icon"><path d="M7 10h14"/><path d="M7 14h14"/><path d="M3 10h.01"/><path d="M3 14h.01"/></svg>
            <span data-i18n="tx">Transactions</span>
        </button>
        <button class="nav-item" onclick="switchView('accounts')" id="nav-acc" aria-label="Accounts">
            <svg class="icon"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
            <span data-i18n="accs">Accounts</span>
        </button>
        <button class="nav-item" onclick="switchView('settings')" id="nav-set" aria-label="Settings">
            <svg class="icon"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <span data-i18n="set">Settings</span>
        </button>
    </nav>

    <!-- Transaction Modal -->
    <div id="txModal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="flex justify-between items-center" style="margin-bottom:20px;">
                <h2 class="text-xl" id="modalTitle">Transaction</h2>
                <button class="btn-ghost" onclick="closeModal()" aria-label="Close transaction modal">âœ•</button>
            </div>

            <div class="flex gap-2" style="background:var(--bg); padding:4px; border-radius:12px; margin-bottom:16px;">
                <button type="button" class="btn" style="flex:1; background:var(--danger); color:white;" id="btn-exp" onclick="setTxType('exp')">Deduction</button>
                <button type="button" class="btn btn-ghost" style="flex:1;" id="btn-inc" onclick="setTxType('inc')">Addition</button>
            </div>

            <input type="hidden" id="txId">
            <input type="hidden" id="txRecurringId">

            <div class="input-group">
                <label class="label" for="txAmount" data-i18n="amt">Amount</label>
                <input type="number" id="txAmount" class="input" placeholder="0.00" />
            </div>
            <div class="input-group">
                <label class="label" for="txDate" data-i18n="date">Date</label>
                <input type="date" id="txDate" class="input" />
            </div>
            <div class="input-group">
                <label class="label" for="txDesc" data-i18n="desc">Description</label>
                <input type="text" id="txDesc" class="input" placeholder="e.g. Salary" />
            </div>
            <div class="input-group">
                <label class="label" for="txAcc" data-i18n="acc">Account</label>
                <select id="txAcc" class="input"></select>
            </div>
            <div class="input-group">
                <label class="label" for="txCat" data-i18n="cat">Category</label>
                <input type="text" id="txCat" class="input" list="catList" />
                <datalist id="catList"></datalist>
            </div>

            <div class="flex gap-2" style="margin-top:20px;">
                <button class="btn btn-danger hidden" id="btnDelete" onclick="deleteTxClick()">Delete</button>
                <button class="btn btn-primary" onclick="saveTx()" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Recurring Modal -->
    <div id="recModal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="recModalTitle">
            <div class="flex justify-between items-center" style="margin-bottom:20px;">
                <h2 class="text-xl" id="recModalTitle">Recurring Item</h2>
                <button class="btn-ghost" onclick="closeRecModal()" aria-label="Close recurring modal">âœ•</button>
            </div>

            <div class="flex gap-2" style="background:var(--bg); padding:4px; border-radius:12px; margin-bottom:16px;">
                <button type="button" class="btn" style="flex:1; background:var(--danger); color:white;" id="btn-rec-exp" onclick="setRecType('exp')">Deduction</button>
                <button type="button" class="btn btn-ghost" style="flex:1;" id="btn-rec-inc" onclick="setRecType('inc')">Addition</button>
            </div>

            <input type="hidden" id="recId">

            <div class="input-group">
                <label class="label" for="recName" data-i18n="desc">Description (Name)</label>
                <input type="text" id="recName" class="input" placeholder="e.g. Rent, Salary" />
            </div>
            <div class="input-group">
                <label class="label" for="recAmount" data-i18n="amt">Amount</label>
                <input type="number" id="recAmount" class="input" placeholder="0.00" />
            </div>
            <div class="input-group">
                <label class="label">Next Due Date</label>
                <input type="date" id="recDate" class="input" />
            </div>

            <div class="input-group">
                <label class="label">Frequency</label>
                <select id="recFreq" class="input">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="6months">Every 6 months</option>
                    <option value="one-time">One time</option>
                </select>
            </div>

            <div class="input-group">
                <label class="label">Skip Until (optional)</label>
                <input type="date" id="recSkipUntil" class="input" />
                <div class="small text-sub" style="margin-top:6px;">Set a date to skip occurrences up to and including that date.</div>
            </div>

            <div class="flex gap-2" style="margin-top:20px;">
                <button class="btn btn-danger hidden" id="btnRecDelete" onclick="deleteRecClick()">Delete</button>
                <button class="btn btn-primary" onclick="saveRec()" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal (Generic) -->
    <div id="confirmModal" class="modal" aria-hidden="true">
        <div class="modal-content" style="text-align: center;">
            <div class="confirm-icon">
                <svg class="icon" style="width:32px; height:32px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </div>
            <h2 class="text-xl bold" id="confirmTitle">Are you sure?</h2>
            <p class="text-sub" style="margin-bottom: 24px;" id="confirmText">Do you really want to delete this? This process cannot be undone.</p>
            <div class="flex gap-2">
                <button class="btn btn-ghost" style="flex:1; border:1px solid var(--border);" onclick="closeConfirm()">Cancel</button>
                <button class="btn btn-danger" style="flex:1;" id="btnConfirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Revert Date Modal (Specific custom modal for Revert Question) -->
    <div id="revertModal" class="modal" aria-hidden="true">
        <div class="modal-content" style="text-align:center;">
             <div style="width:50px; height:50px; background:var(--primary-light); color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px auto;">
                <svg class="icon" style="width:24px; height:24px;"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            </div>
            <h2 class="text-xl bold">Revert Recurring Date?</h2>
            <p class="text-sub" style="margin-bottom:24px; margin-top:8px;">You deleted a recurring payment. Do you want to revert the Recurring Date back to the previous date?</p>
            
            <div class="flex gap-2" style="flex-direction:column;">
                <button class="btn btn-primary" id="btnRevertYes">Yes, Revert Date</button>
                <button class="btn btn-outline" id="btnRevertNo">No, Keep Current Date</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const DEFAULT_ACCOUNTS = [
            { id: '1', name: 'Vodafone Cash', initial: 0 },
            { id: '2', name: 'Bank Account', initial: 0 },
            { id: '3', name: 'Credit Card', initial: 0 },
            { id: '4', name: 'Cash', initial: 0 }
        ];

        let data = {
            transactions: [],
            accounts: DEFAULT_ACCOUNTS.slice(),
            categories: [],
            recurring: [],
            settings: { lang: 'en', theme: 'light' }
        };

        let currentView = 'dashboard';
        let txType = 'exp';
        let recType = 'exp';

        // Confirmation callback
        let onConfirmAction = null;
        let onRevertAction = null;

        const TRANSLATIONS = {
            en: { dash: "Dashboard", tx: "Transactions", accs: "Accounts", set: "Settings", amt: "Amount", date: "Date", desc: "Description", acc: "Account", cat: "Category", save: "Save", del: "Delete", income: "Addition", expense: "Deduction", total: "Total Balance", rec: "Recurring", export: "Backup", import: "Restore" },
            ar: { dash: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", tx: "Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª", accs: "Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", set: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", amt: "Ø§Ù„Ù…Ø¨Ù„Øº", date: "Ø§Ù„ØªØ§Ø±ÙŠØ®", desc: "Ø§Ù„ÙˆØµÙ", acc: "Ø§Ù„Ø­Ø³Ø§Ø¨", cat: "Ø§Ù„ÙØ¦Ø©", save: "Ø­ÙØ¸", del: "Ø­Ø°Ù", income: "Ø¥Ø¶Ø§ÙØ©", expense: "Ø®ØµÙ…", total: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯", rec: "Ø¯ÙˆØ±ÙŠ", export: "Ù†Ø³Ø®", import: "Ø§Ø³ØªØ±Ø¬Ø§Ø¹" }
        };

        // --- INIT ---
        window.onload = () => {
            loadData();
            applyTheme();
            applyLang();
            render();
            document.getElementById('txDate').valueAsDate = new Date();
            setupModalBehavior();
        };

        // --- STORAGE & DATA SAFETY ---
        function loadData() {
            const stored = localStorage.getItem('abouTiaData');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    data = Object.assign({
                        transactions: [],
                        accounts: DEFAULT_ACCOUNTS.slice(),
                        categories: [],
                        recurring: [],
                        settings: { lang: 'en', theme: 'light' }
                    }, parsed || {});

                    data.transactions = Array.isArray(data.transactions) ? data.transactions : [];
                    data.accounts = Array.isArray(data.accounts) ? data.accounts : DEFAULT_ACCOUNTS.slice();
                    data.categories = Array.isArray(data.categories) ? data.categories : [];
                    data.recurring = Array.isArray(data.recurring) ? data.recurring : [];
                    data.settings = Object.assign({ lang: 'en', theme: 'light' }, data.settings || {});
                } catch (e) {
                    console.error("Failed to parse stored data", e);
                }
            }
            data.accounts.forEach(a => a.id = String(a.id));
            data.transactions.forEach(t => t.id = String(t.id));
            data.recurring.forEach(r => r.id = String(r.id));
        }

        function saveData(skipRender) {
            localStorage.setItem('abouTiaData', JSON.stringify(data));
            if (!skipRender) render();
        }

        // --- RENDER CORE ---
        function render() {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navMap = { dashboard: 'dash', transactions: 'tx', accounts: 'acc', settings: 'set' };
            document.getElementById(`nav-${navMap[currentView]}`).classList.add('active');

            const container = document.getElementById('mainContainer');
            container.innerHTML = '';

            if (currentView === 'dashboard') renderDashboard(container);
            else if (currentView === 'transactions') renderTransactions(container);
            else if (currentView === 'accounts') renderAccounts(container);
            else if (currentView === 'settings') renderSettings(container);
        }

        // --- HELPERS & FORMATTERS ---
        function t(key) { return TRANSLATIONS[data.settings.lang][key] || key; }
        function fmt(num) {
            const n = Number(num) || 0;
            return new Intl.NumberFormat(data.settings.lang === 'ar' ? 'ar-EG' : 'en-US', { style: 'currency', currency: 'EGP' }).format(n);
        }
        function uid() { return String(Date.now()) + Math.floor(Math.random()*1000); }
        function safeNum(v) { return Number(v) || 0; }
        function eqId(a, b) { return String(a) === String(b); }

        // Date Helpers
        function getNextDate(dateStr, freq) {
            const date = new Date(dateStr);
            const originalDay = date.getDate();
            
            if (freq === 'daily') date.setDate(date.getDate() + 1);
            else if (freq === 'weekly') date.setDate(date.getDate() + 7);
            else if (freq === 'monthly') {
                date.setMonth(date.getMonth() + 1);
                // Handle end of month (e.g. Jan 31 -> Feb 28)
                if (date.getDate() !== originalDay) {
                    date.setDate(0); 
                }
            } 
            else if (freq === 'quarterly') {
                date.setMonth(date.getMonth() + 3);
            }
            else if (freq === '6months') {
                date.setMonth(date.getMonth() + 6);
            }
            return date.toISOString().split('T')[0];
        }

        function getPrevDate(dateStr, freq) {
            const date = new Date(dateStr);
            
            if (freq === 'daily') date.setDate(date.getDate() - 1);
            else if (freq === 'weekly') date.setDate(date.getDate() - 7);
            else if (freq === 'monthly') date.setMonth(date.getMonth() - 1);
            else if (freq === 'quarterly') date.setMonth(date.getMonth() - 3);
            else if (freq === '6months') date.setMonth(date.getMonth() - 6);
            
            return date.toISOString().split('T')[0];
        }

        function daysUntilDate(targetDate) {
            const today = new Date();
            const start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const t = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
            const diff = Math.ceil((t - start) / (1000 * 60 * 60 * 24));
            return diff;
        }

        function getAccBalance(accId) {
            let bal = safeNum(data.accounts.find(a => eqId(a.id, accId))?.initial);
            data.transactions.forEach(tx => {
                if (eqId(tx.accId, accId)) {
                    if (tx.type === 'inc') bal += safeNum(tx.amount);
                    else bal -= safeNum(tx.amount);
                }
            });
            return bal;
        }

        // --- RENDERERS ---
        function getTxHTML(tx) {
            const accName = data.accounts.find(a => eqId(a.id, tx.accId))?.name || 'Unknown';
            const isInc = tx.type === 'inc';
            // Added swipe handler via JS in renderTransactions, identifying via data-id
            return `
                <div class="card flex justify-between items-center swipe-hint" data-id="${tx.id}" style="padding:16px; cursor:pointer;" onclick="editTx('${tx.id}')">
                    <div class="flex items-center gap-2">
                        <div style="width:40px; height:40px; border-radius:50%; background:${isInc ? '#dcfce7' : '#fee2e2'}; display:flex; align-items:center; justify-content:center; font-size:18px;">
                            ${isInc ? 'â†—' : 'â†™'}
                        </div>
                        <div>
                            <div class="bold text-sm">${tx.desc}</div>
                            <div class="text-xs text-sub">${tx.date} â€¢ ${accName}</div>
                        </div>
                    </div>
                    <div class="bold ${isInc ? 'text-green' : 'text-red'}">
                        ${isInc ? '+' : '-'}${fmt(tx.amount)}
                    </div>
                </div>
            `;
        }

        function getRecurringSummaryHTML() {
            const today = new Date();
            const curMonth = today.getMonth();
            const curYear = today.getFullYear();
            
            let unpaidExp = 0;
            let uncollectedInc = 0;

            data.recurring.forEach(r => {
                const d = new Date(r.date);
                // Check if the due date is in current month & year
                if (d.getMonth() === curMonth && d.getFullYear() === curYear) {
                    if (r.type === 'exp') unpaidExp += safeNum(r.amount);
                    else uncollectedInc += safeNum(r.amount);
                }
            });

            return `
                <div class="card" style="padding:16px; margin-top:10px;">
                     <h3 class="text-xs bold text-sub uppercase" style="margin-bottom:10px;">Recurring (This Month)</h3>
                     <div class="flex gap-2">
                        <div style="flex:1;">
                            <div class="text-xs text-sub">Unpaid Deductions</div>
                            <div class="bold text-red" style="font-size:16px;">${fmt(unpaidExp)}</div>
                        </div>
                        <div style="width:1px; background:var(--border);"></div>
                        <div style="flex:1;">
                            <div class="text-xs text-sub">Uncollected Additions</div>
                            <div class="bold text-green" style="font-size:16px;">${fmt(uncollectedInc)}</div>
                        </div>
                     </div>
                </div>
            `;
        }

        function getRecurringAlertsHTML() {
            let html = '';
            const recs = data.recurring.map(r => {
                const d = new Date(r.date);
                return { ...r, dateObj: d };
            }).sort((a,b) => a.dateObj - b.dateObj);

            recs.forEach(r => {
                if (r.skipUntil && new Date(r.skipUntil) >= r.dateObj) return;

                const diffDays = daysUntilDate(r.dateObj);
                if (diffDays > 30) return;

                let color;
                if (r.type === 'inc') color = 'var(--success)';
                else color = diffDays < 0 ? 'var(--danger)' : '#f59e0b';

                const msg = diffDays < 0 ? 'Overdue!' : diffDays === 0 ? 'Due Today' : `Due in ${diffDays} days`;

                html += `
                    <div class="card flex justify-between items-center" style="border-left:4px solid ${color}; padding:12px;">
                        <div>
                            <div class="bold text-sm">${r.name}</div>
                            <div class="text-xs text-sub">${msg} â€¢ ${r.frequency}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="bold text-sm">${fmt(r.amount)}</div>
                            <button class="btn" style="border:1px solid var(--border); padding:4px 10px; font-size:12px; margin-top:4px;" onclick="payRecurring('${r.id}')">${r.type === 'inc' ? 'Collect' : 'Pay'}</button>
                        </div>
                    </div>
                `;
            });
            return html;
        }

        function renderDashboard(container) {
            const total = data.accounts.reduce((sum, acc) => sum + getAccBalance(acc.id), 0);
            const income = data.transactions.filter(t => t.type === 'inc').reduce((sum, t) => sum + safeNum(t.amount), 0);
            const expense = data.transactions.filter(t => t.type === 'exp').reduce((sum, t) => sum + safeNum(t.amount), 0);

            container.innerHTML = `
                <div class="card" style="background: linear-gradient(135deg, var(--primary), #3b82f6); color: white; border:none; margin-bottom:10px;">
                    <div class="text-sm" style="opacity:0.9">${t('total')}</div>
                    <div class="text-xl bold" style="font-size:32px; margin: 4px 0;">${fmt(total)}</div>
                    <div class="flex gap-2 mt-2">
                        <div style="background:rgba(255,255,255,0.2); padding:8px 12px; border-radius:8px; flex:1;">
                            <div class="text-xs">Addition</div>
                            <div class="bold">+${fmt(income)}</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.2); padding:8px 12px; border-radius:8px; flex:1;">
                            <div class="text-xs">Deduction</div>
                            <div class="bold">-${fmt(expense)}</div>
                        </div>
                    </div>
                </div>

                <!-- Recurring MI Block -->
                ${getRecurringSummaryHTML()}

                ${getRecurringAlertsHTML()}

                <h3 class="text-sm bold text-sub uppercase" style="margin-bottom:10px; margin-top:20px;">Accounts</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    ${data.accounts.map(acc => `
                        <div class="card" style="margin:0; padding:16px;">
                            <div class="text-xs text-sub uppercase">${acc.name}</div>
                            <div class="text-lg bold">${fmt(getAccBalance(acc.id))}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="flex justify-between items-center" style="margin-top:24px; margin-bottom:10px;">
                    <h3 class="text-sm bold text-sub uppercase">Recent</h3>
                    <button class="btn-ghost text-xs" onclick="switchView('transactions')">See All</button>
                </div>
                ${data.transactions.length === 0 ? '<div class="text-sub text-center text-sm" style="padding:20px;">No transactions yet</div>' : ''}
                ${data.transactions.slice(0, 5).map(tx => getTxHTML(tx)).join('')}
            `;
            
            // Attach swipe handlers for dashboard recent list
            addSwipeListeners(container);
        }

        function renderTransactions(container) {
            container.innerHTML = `<h2 class="text-xl bold" style="margin-bottom:16px;">${t('tx')}</h2>`;
            if (data.transactions.length === 0) {
                container.innerHTML += `<div class="text-center text-sub" style="margin-top:40px;">No transactions found.</div>`;
            } else {
                const sorted = [...data.transactions].reverse();
                sorted.forEach(tx => container.innerHTML += getTxHTML(tx));
            }
            // Attach swipe handlers
            addSwipeListeners(container);
        }
        
        // --- SWIPE LOGIC ---
        function addSwipeListeners(container) {
            const cards = container.querySelectorAll('.swipe-hint');
            cards.forEach(card => {
                let startX = 0;
                let currentX = 0;
                
                card.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                }, {passive: true});
                
                card.addEventListener('touchmove', (e) => {
                    currentX = e.touches[0].clientX;
                }, {passive: true});

                card.addEventListener('touchend', () => {
                    if (startX && currentX) {
                        const diff = startX - currentX;
                        // Threshold for left swipe
                        if (diff > 80) { 
                            const id = card.getAttribute('data-id');
                            // Trigger delete logic
                            prepareDeleteTx(id);
                        }
                    }
                    startX = 0;
                    currentX = 0;
                });
            });
        }

        function renderAccounts(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center" style="margin-bottom:16px;">
                    <h2 class="text-xl bold">${t('accs')}</h2>
                    <button class="btn btn-primary" style="width:auto;" onclick="addAccount()">+ Add</button>
                </div>
            `;
            data.accounts.forEach(acc => {
                container.innerHTML += `
                    <div class="card relative">
                        <div class="text-xs text-sub uppercase">${acc.name}</div>
                        <div class="text-xl bold">${fmt(getAccBalance(acc.id))}</div>
                        <button class="btn-ghost" style="position:absolute; top:10px; right:10px; color:var(--danger);" onclick="deleteAccount('${acc.id}')">âœ•</button>
                    </div>
                `;
            });
        }

        function renderSettings(container) {
            container.innerHTML = `
                <h2 class="text-xl bold" style="margin-bottom:16px;">${t('set')}</h2>

                <div class="card">
                    <div class="flex justify-between items-center">
                        <span class="bold">Language</span>
                        <button class="btn" style="border:1px solid var(--border);" onclick="toggleLang()">${data.settings.lang === 'en' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'}</button>
                    </div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center" style="margin-bottom:10px;">
                        <span class="bold">Recurring Items</span>
                        <button class="btn btn-primary" style="width:auto; padding:6px 12px;" onclick="openRecModal('add')">+ Add</button>
                    </div>
                    ${data.recurring.length === 0 ? '<div class="text-sub text-center small" style="padding:10px;">No recurring items</div>' : ''}
                    ${data.recurring.sort((a,b) => new Date(a.date) - new Date(b.date)).map(r => `
                        <div class="flex justify-between items-center" style="padding:8px 0; border-bottom:1px solid var(--border); cursor:pointer;">
                            <div style="flex:1" onclick="editRec('${r.id}')">
                                <div class="bold text-sm" style="${r.type === 'inc' ? 'color: var(--success);' : ''}">${r.name}</div>
                                <div class="text-xs text-sub">Next: ${r.date} â€¢ ${r.frequency} â€¢ ${fmt(r.amount)}</div>
                                ${r.skipUntil ? `<div class="text-xs text-red small">Skipped until ${r.skipUntil}</div>` : ''}
                            </div>
                            <div style="display:flex; gap:6px;">
                                <button class="btn-ghost small" onclick="editRec('${r.id}')">âœŽ</button>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="card">
                    <button class="btn" style="width:100%; border:1px solid var(--border); margin-bottom:10px;" onclick="exportData()">â¬‡ ${t('export')}</button>
                    <button class="btn" style="width:100%; border:1px solid var(--border);" onclick="document.getElementById('fileInput').click()">â¬† ${t('import')}</button>
                    <input type="file" id="fileInput" class="hidden" onchange="importData(this)" />
                </div>
            `;
        }

        // --- ACTIONS & MODALS ---
        function switchView(view) {
            currentView = view;
            render();
        }

        function openModal(mode, txData = null) {
            const modal = document.getElementById('txModal');
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');

            const accSelect = document.getElementById('txAcc');
            accSelect.innerHTML = data.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

            const catList = document.getElementById('catList');
            catList.innerHTML = data.categories.map(c => `<option value="${c.name}">`).join('');

            if (mode === 'edit' && txData) {
                document.getElementById('modalTitle').innerText = 'Edit Transaction';
                document.getElementById('txId').value = txData.id;
                document.getElementById('txRecurringId').value = txData.recId || '';
                document.getElementById('txAmount').value = safeNum(txData.amount);
                document.getElementById('txDesc').value = txData.desc;
                document.getElementById('txDate').value = txData.date;
                document.getElementById('txAcc').value = txData.accId;
                document.getElementById('txCat').value = txData.cat || '';
                setTxType(txData.type);
                document.getElementById('btnDelete').classList.remove('hidden');
            } else {
                document.getElementById('modalTitle').innerText = 'New Transaction';
                document.getElementById('txId').value = '';
                document.getElementById('txRecurringId').value = '';
                document.getElementById('txAmount').value = '';
                document.getElementById('txDesc').value = '';
                document.getElementById('txDate').valueAsDate = new Date();
                document.getElementById('txCat').value = '';
                setTxType('exp');
                document.getElementById('btnDelete').classList.add('hidden');
            }
        }

        function closeModal() {
            document.getElementById('txModal').classList.remove('open');
        }

        function openRecModal(mode, recData = null) {
            const modal = document.getElementById('recModal');
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');

            if (mode === 'edit' && recData) {
                document.getElementById('recModalTitle').innerText = 'Edit Recurring';
                document.getElementById('recId').value = recData.id;
                document.getElementById('recName').value = recData.name;
                document.getElementById('recAmount').value = safeNum(recData.amount);
                document.getElementById('recDate').value = recData.date;
                document.getElementById('recFreq').value = recData.frequency || 'monthly';
                document.getElementById('recSkipUntil').value = recData.skipUntil || '';
                setRecType(recData.type || 'exp');
                document.getElementById('btnRecDelete').classList.remove('hidden');
            } else {
                document.getElementById('recModalTitle').innerText = 'New Recurring';
                document.getElementById('recId').value = '';
                document.getElementById('recName').value = '';
                document.getElementById('recAmount').value = '';
                document.getElementById('recDate').valueAsDate = new Date();
                document.getElementById('recFreq').value = 'monthly';
                document.getElementById('recSkipUntil').value = '';
                setRecType('exp');
                document.getElementById('btnRecDelete').classList.add('hidden');
            }
        }

        function closeRecModal() {
            document.getElementById('recModal').classList.remove('open');
        }

        function openConfirm(title, text, callback) {
            onConfirmAction = callback;
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmText').innerText = text;
            document.getElementById('btnConfirmDelete').innerText = "Delete";
            const modal = document.getElementById('confirmModal');
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeConfirm() {
            document.getElementById('confirmModal').classList.remove('open');
            onConfirmAction = null;
        }

        // --- NEW CUSTOM REVERT MODAL LOGIC ---
        function openRevertModal(callbackYes, callbackNo) {
            const modal = document.getElementById('revertModal');
            modal.classList.add('open');
            
            const btnYes = document.getElementById('btnRevertYes');
            const btnNo = document.getElementById('btnRevertNo');

            // clear old listeners to avoid stacks
            const newYes = btnYes.cloneNode(true);
            const newNo = btnNo.cloneNode(true);
            btnYes.parentNode.replaceChild(newYes, btnYes);
            btnNo.parentNode.replaceChild(newNo, btnNo);

            newYes.addEventListener('click', () => {
                callbackYes();
                modal.classList.remove('open');
            });

            newNo.addEventListener('click', () => {
                callbackNo();
                modal.classList.remove('open');
            });
        }

        document.getElementById('btnConfirmDelete').addEventListener('click', () => {
            if (onConfirmAction) onConfirmAction();
            closeConfirm();
        });

        function setTxType(type) {
            txType = type;
            const btnExp = document.getElementById('btn-exp');
            const btnInc = document.getElementById('btn-inc');
            updateTypeButtons(type, btnExp, btnInc);
        }

        function setRecType(type) {
            recType = type;
            const btnExp = document.getElementById('btn-rec-exp');
            const btnInc = document.getElementById('btn-rec-inc');
            updateTypeButtons(type, btnExp, btnInc);
        }

        function updateTypeButtons(type, btnExp, btnInc) {
            if (type === 'exp') {
                btnExp.style.background = 'var(--danger)'; btnExp.style.color = 'white';
                btnInc.style.background = 'transparent'; btnInc.style.color = 'var(--text-sub)';
            } else {
                btnInc.style.background = 'var(--success)'; btnInc.style.color = 'white';
                btnExp.style.background = 'transparent'; btnExp.style.color = 'var(--text-sub)';
            }
        }

        function saveTx() {
            const id = document.getElementById('txId').value;
            const amountRaw = document.getElementById('txAmount').value;
            const amount = parseFloat(amountRaw);
            const desc = document.getElementById('txDesc').value.trim();
            const date = document.getElementById('txDate').value;
            const accId = document.getElementById('txAcc').value;
            const cat = document.getElementById('txCat').value.trim();
            const recId = document.getElementById('txRecurringId').value;

            if (!amount || isNaN(amount) || !desc || !accId) return alert('Please fill details correctly');

            const txObj = {
                id: id ? String(id) : uid(),
                type: txType,
                amount: amount,
                desc, date, accId: String(accId), cat,
                recId: recId || null
            };

            if (id) {
                const idx = data.transactions.findIndex(t => eqId(t.id, id));
                if (idx > -1) data.transactions[idx] = txObj;
            } else {
                data.transactions.push(txObj);
                
                // --- SMART RECURRING UPDATE & ONE-TIME LOGIC ---
                if (recId) {
                    const recIdx = data.recurring.findIndex(r => eqId(r.id, recId));
                    if (recIdx > -1) {
                        const r = data.recurring[recIdx];
                        
                        // Check if one-time -> Delete it
                        if (r.frequency === 'one-time') {
                            data.recurring.splice(recIdx, 1);
                        } else {
                            // Update the Recurring Date to the NEXT occurrence
                            r.date = getNextDate(r.date, r.frequency);
                            data.recurring[recIdx] = r;
                        }
                    }
                }
            }

            if (cat && !data.categories.find(c => c.name === cat)) {
                data.categories.push({ name: cat });
            }

            saveData();
            closeModal();
        }

        function editTx(id) {
            const tx = data.transactions.find(t => eqId(t.id, id));
            if (tx) openModal('edit', tx);
        }

        // Called when swipe or button click triggers delete
        function prepareDeleteTx(id) {
            // Need to set the hidden input so standard delete works if confirmed
            const tx = data.transactions.find(t => eqId(t.id, id));
            if(tx) {
                // If modal is not open, open it temporarily to populate fields or just pass ID?
                // Better: just call logic directly
                document.getElementById('txId').value = id;
                deleteTxClick();
            }
        }

        function deleteTxClick() {
            const id = document.getElementById('txId').value;
            const tx = data.transactions.find(t => eqId(t.id, id));
            
            openConfirm("Delete Transaction?", "Do you really want to delete this?", () => {
                // Remove transaction
                data.transactions = data.transactions.filter(t => !eqId(t.id, id));
                
                // Check if it was recurring
                if (tx && tx.recId) {
                    const rec = data.recurring.find(r => eqId(r.id, tx.recId));
                    if (rec) {
                        // Close confirm modal first (already done by wrapper)
                        // Wait a bit then show Revert Modal
                        setTimeout(() => {
                            openRevertModal(
                                // Yes Revert
                                () => {
                                    rec.date = getPrevDate(rec.date, rec.frequency);
                                    saveData(); 
                                },
                                // No Keep
                                () => {
                                    saveData();
                                }
                            );
                        }, 300);
                        return; 
                    }
                }
                saveData();
                closeModal();
            });
        }

        function addAccount() {
            const name = prompt("Account Name:");
            if (name) {
                const newId = uid();
                data.accounts.push({ id: newId, name: name.trim(), initial: 0 });
                saveData();
            }
        }

        function deleteAccount(id) {
            openConfirm("Delete Account?", "This will delete all related transactions.", () => {
                data.accounts = data.accounts.filter(a => !eqId(a.id, id));
                data.transactions = data.transactions.filter(t => !eqId(t.accId, id));
                saveData();
            });
        }

        function saveRec() {
            const id = document.getElementById('recId').value;
            const name = document.getElementById('recName').value.trim();
            const amtRaw = document.getElementById('recAmount').value;
            const amt = parseFloat(amtRaw);
            const dateVal = document.getElementById('recDate').value;
            const freq = document.getElementById('recFreq').value;
            const skipUntilVal = document.getElementById('recSkipUntil').value;

            if (!name || !amt || isNaN(amt) || !dateVal) { alert("Please fill all fields"); return; }

            const recObj = {
                id: id ? String(id) : uid(),
                name,
                amount: amt,
                date: dateVal, // Now strictly "Next Due Date"
                frequency: freq,
                type: recType,
                skipUntil: skipUntilVal || ''
            };

            if (id) {
                const idx = data.recurring.findIndex(r => eqId(r.id, id));
                if (idx > -1) data.recurring[idx] = recObj;
            } else {
                data.recurring.push(recObj);
            }

            saveData();
            closeRecModal();
        }

        function editRec(id) {
            const r = data.recurring.find(item => eqId(item.id, id));
            if (r) openRecModal('edit', r);
        }

        function deleteRecClick() {
            const id = document.getElementById('recId').value;
            openConfirm("Delete Recurring?", "This won't delete past transactions.", () => {
                data.recurring = data.recurring.filter(r => !eqId(r.id, id));
                saveData();
                closeRecModal();
            });
        }

        function payRecurring(id) {
            const r = data.recurring.find(x => eqId(x.id, id));
            if (r) {
                openModal('add');
                document.getElementById('txAmount').value = safeNum(r.amount);
                document.getElementById('txDesc').value = r.name;
                document.getElementById('txCat').value = 'Recurring';
                document.getElementById('txRecurringId').value = r.id; // Link ID
                setTxType(r.type || 'exp');
                document.getElementById('modalTitle').innerText = r.type === 'inc' ? 'Collect Recurring' : 'Pay Recurring';
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `myfinance_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const incoming = JSON.parse(e.target.result);
                    if (!incoming || typeof incoming !== 'object') throw new Error('Invalid file');

                    data = {
                        transactions: Array.isArray(incoming.transactions) ? incoming.transactions.map(t => ({ ...t, id: String(t.id) })) : [],
                        accounts: Array.isArray(incoming.accounts) ? incoming.accounts.map(a => ({ ...a, id: String(a.id) })) : DEFAULT_ACCOUNTS.slice(),
                        categories: Array.isArray(incoming.categories) ? incoming.categories : [],
                        recurring: Array.isArray(incoming.recurring) ? incoming.recurring.map(r => ({ ...r, id: String(r.id) })) : [],
                        settings: Object.assign({ lang: 'en', theme: 'light' }, incoming.settings || {})
                    };

                    data.transactions.forEach(t => t.amount = safeNum(t.amount));
                    data.recurring.forEach(r => r.amount = safeNum(r.amount));

                    saveData();
                    alert("Data restored!");
                } catch (err) {
                    console.error(err);
                    alert("Invalid file");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function toggleTheme() {
            data.settings.theme = data.settings.theme === 'light' ? 'dark' : 'light';
            saveData();
            applyTheme();
        }

        function applyTheme() {
            const btn = document.getElementById('themeBtn');
            if (data.settings.theme === 'dark') {
                document.body.classList.add('dark');
                btn.innerText = 'ðŸŒ™';
            } else {
                document.body.classList.remove('dark');
                btn.innerText = 'ðŸŒž';
            }
        }

        function toggleLang() {
            data.settings.lang = data.settings.lang === 'en' ? 'ar' : 'en';
            saveData();
            applyLang();
            render();
        }

        function applyLang() {
            document.dir = data.settings.lang === 'ar' ? 'rtl' : 'ltr';
        }

        function setupModalBehavior() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    closeRecModal();
                    closeConfirm();
                }
            });
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (ev) => {
                    if (ev.target === modal) {
                        modal.classList.remove('open');
                        modal.setAttribute('aria-hidden', 'true');
                    }
                });
            });
        }
        
        function ensureOrdering() {
            data.transactions.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
        }
        
        const originalSaveData = saveData;
        saveData = function(skipRender) {
            ensureOrdering();
            localStorage.setItem('abouTiaData', JSON.stringify(data));
            if (!skipRender) render();
        };
        
        ensureOrdering();

    </script>
</body>
</html>

