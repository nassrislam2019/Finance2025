<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المعاملات المالية</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Arabic font and direction -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', // Emerald 500
                        'secondary': '#f97316', // Orange 600
                    },
                    fontFamily: {
                        sans: ['Inter', 'Tahoma', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better aesthetics and readability */
        body {
            background-color: #f3f4f6;
            font-family: 'Tahoma', sans-serif;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .transaction-row:hover {
            background-color: #fef2f2; /* Light red hover for easy delete identification */
        }
        /* Custom scrollbar for transaction list */
        #transactions-list::-webkit-scrollbar {
            width: 8px;
        }
        #transactions-list::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">نظام إدارة المعاملات المالية</h1>

        <!-- Summary Section -->
        <div id="summary-section" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- Net Balance -->
            <div class="card p-4 rounded-xl bg-white border-b-4 border-primary shadow-lg">
                <p class="text-sm font-medium text-gray-500">الرصيد الصافي</p>
                <p id="net-balance" class="text-2xl font-extrabold text-gray-900 mt-1">0.00</p>
            </div>
            <!-- Total Collections -->
            <div class="card p-4 rounded-xl bg-white border-b-4 border-blue-500 shadow-lg">
                <p class="text-sm font-medium text-gray-500">إجمالي التحصيلات (المستحقات)</p>
                <p id="total-collections" class="text-2xl font-extrabold text-blue-600 mt-1">0.00</p>
            </div>
            <!-- Total Payments -->
            <div class="card p-4 rounded-xl bg-white border-b-4 border-red-500 shadow-lg">
                <p class="text-sm font-medium text-gray-500">إجمالي السدادات (الالتزامات)</p>
                <p id="total-payments" class="text-2xl font-extrabold text-red-600 mt-1">0.00</p>
            </div>
            <!-- Total Inflow -->
            <div class="card p-4 rounded-xl bg-white border-b-4 border-green-500 shadow-lg">
                <p class="text-sm font-medium text-gray-500">إجمالي الإيرادات (النقدي)</p>
                <p id="total-inflow" class="text-2xl font-extrabold text-green-600 mt-1">0.00</p>
            </div>
        </div>

        <!-- Transaction Forms Section -->
        <div class="bg-white p-6 rounded-xl card mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">إضافة معاملة جديدة</h2>

            <!-- Input Fields for all transactions -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" id="transaction-description" placeholder="الوصف (إيراد/مصروف/مستحق/التزام)" class="p-3 border rounded-lg md:col-span-2 focus:ring-primary focus:border-primary transition duration-150" required>
                <input type="number" id="transaction-amount" placeholder="المبلغ" class="p-3 border rounded-lg focus:ring-primary focus:border-primary transition duration-150" required min="1">
                <input type="date" id="transaction-date" class="p-3 border rounded-lg focus:ring-primary focus:border-primary transition duration-150" required>
            </div>

            <!-- Transaction Type Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="addTransaction('income')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md">إضافة إيراد</button>
                <button onclick="addTransaction('expense')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md">إضافة مصروف</button>
                <button onclick="addTransaction('receivable_collection')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md">تحصيل المستحقات</button>
                <button onclick="addTransaction('liability_payment')" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md">سداد الالتزامات</button>
            </div>
        </div>

        <!-- Transactions List Section -->
        <div class="bg-white p-6 rounded-xl card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">سجل المعاملات</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الوصف</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">النوع</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ (±)</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراء</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-list" class="bg-white divide-y divide-gray-200">
                        <!-- Transactions will be rendered here -->
                        <tr><td colspan="5" class="text-center py-4 text-gray-500">الرجاء الانتظار... يتم تحميل البيانات.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- User ID display for collaborative/debug purposes -->
        <div class="mt-4 text-center text-xs text-gray-500">
            <p>معرف المستخدم: <span id="user-id-display">جار التحميل...</span></p>
        </div>

    </div>

    <!-- Firebase Imports and Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, deleteDoc, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // IMPORTANT: Set Firestore log level for debugging
        setLogLevel('Debug');

        let app;
        let db;
        let auth;
        let userId = 'loading';
        
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Converts transaction type string to Arabic display name and CSS class.
         * @param {string} type - The transaction type (e.g., 'income').
         * @returns {{name: string, class: string}}
         */
        function getTransactionDisplay(type) {
            const displays = {
                'income': { name: 'إيراد (نقدي)', class: 'bg-green-100 text-green-800' },
                'expense': { name: 'مصروف (نقدي)', class: 'bg-red-100 text-red-800' },
                'receivable_collection': { name: 'تحصيل مستحقات', class: 'bg-blue-100 text-blue-800' },
                'liability_payment': { name: 'سداد التزامات', class: 'bg-orange-100 text-orange-800' }
            };
            return displays[type] || { name: 'غير معروف', class: 'bg-gray-100 text-gray-800' };
        }

        /**
         * Initializes Firebase and handles user authentication.
         */
        async function initFirebaseAndAuth() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                document.getElementById('transactions-list').innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">خطأ: إعدادات قاعدة البيانات غير متوفرة.</td></tr>`;
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using the provided token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up authentication state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        console.log("User authenticated:", userId);
                        // Start listening to transactions once authenticated
                        listenForTransactions();
                    } else {
                        // This should ideally not happen after initial sign-in
                        console.log("User signed out or failed authentication.");
                        document.getElementById('user-id-display').textContent = 'غير مصادق';
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                document.getElementById('transactions-list').innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">فشل في الاتصال بالخدمة.</td></tr>`;
            }
        }

        /**
         * Calculates the summary statistics from a list of transactions.
         * @param {Array<Object>} transactions - List of transaction objects.
         */
        function calculateSummary(transactions) {
            let totalInflow = 0;
            let totalOutflow = 0;
            let totalCollections = 0; // تحصيل المستحقات
            let totalPayments = 0; // سداد الالتزامات

            transactions.forEach(t => {
                const amount = parseFloat(t.amount) || 0;

                switch (t.type) {
                    case 'income':
                        totalInflow += amount;
                        break;
                    case 'expense':
                        totalOutflow += amount;
                        break;
                    case 'receivable_collection':
                        totalInflow += amount;
                        totalCollections += amount;
                        break;
                    case 'liability_payment':
                        totalOutflow += amount;
                        totalPayments += amount;
                        break;
                }
            });

            const netBalance = totalInflow - totalOutflow;

            // Update DOM
            document.getElementById('net-balance').textContent = netBalance.toFixed(2) + ' ر.ع'; // ر.ع = رمز عملة افتراضي
            document.getElementById('total-inflow').textContent = totalInflow.toFixed(2) + ' ر.ع';
            document.getElementById('total-collections').textContent = totalCollections.toFixed(2) + ' ر.ع';
            document.getElementById('total-payments').textContent = totalPayments.toFixed(2) + ' ر.ع';
        }

        /**
         * Renders the transaction list and updates the summary.
         * @param {Array<Object>} transactions - List of transaction objects.
         */
        function renderApp(transactions) {
            const listElement = document.getElementById('transactions-list');
            listElement.innerHTML = ''; // Clear existing list

            // Sort transactions by date (most recent first)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (transactions.length === 0) {
                listElement.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">لا توجد معاملات مسجلة بعد.</td></tr>`;
            } else {
                transactions.forEach(t => {
                    const display = getTransactionDisplay(t.type);
                    
                    let amountSign = '';
                    let amountClass = 'text-gray-900';
                    if (t.type === 'income' || t.type === 'receivable_collection') {
                        amountSign = '+';
                        amountClass = 'text-green-600 font-semibold';
                    } else if (t.type === 'expense' || t.type === 'liability_payment') {
                        amountSign = '-';
                        amountClass = 'text-red-600 font-semibold';
                    }

                    const row = `
                        <tr class="transaction-row transition duration-100" data-doc-id="${t.id}">
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${t.description}</td>
                            <td class="px-3 py-3 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${display.class}">
                                    ${display.name}
                                </span>
                            </td>
                            <td class="px-3 py-3 whitespace-nowrap text-sm ${amountClass}">${amountSign}${parseFloat(t.amount).toFixed(2)}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-center text-sm font-medium">
                                <button onclick="deleteTransaction('${t.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition duration-150" aria-label="حذف المعاملة">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                    listElement.insertAdjacentHTML('beforeend', row);
                });
            }

            calculateSummary(transactions);
        }

        /**
         * Sets up the real-time listener for the user's transactions.
         */
        function listenForTransactions() {
            if (!db || !userId) return;

            // Path: /artifacts/{appId}/users/{userId}/financial_transactions
            const collectionPath = `artifacts/${appId}/users/${userId}/financial_transactions`;
            const q = collection(db, collectionPath);
            
            // onSnapshot provides real-time updates and handles the initial fetch
            onSnapshot(q, (querySnapshot) => {
                const transactions = [];
                querySnapshot.forEach((doc) => {
                    // Spread operator is used to include the document ID (id) with the data
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                console.log("Transactions updated in real-time:", transactions.length);
                // The new list is passed to renderApp, which recalculates the summary automatically.
                renderApp(transactions);
            }, (error) => {
                console.error("Error listening to transactions:", error);
                document.getElementById('transactions-list').innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">فشل في جلب المعاملات: ${error.message}</td></tr>`;
            });
        }

        /**
         * Saves a new transaction to Firestore.
         * @param {string} type - 'income', 'expense', 'receivable_collection', or 'liability_payment'.
         */
        window.addTransaction = async function(type) {
            if (!db || !userId) {
                console.warn("Database or user not ready.");
                return;
            }

            const description = document.getElementById('transaction-description').value.trim();
            const amountStr = document.getElementById('transaction-amount').value;
            const date = document.getElementById('transaction-date').value;

            if (!description || !amountStr || !date || parseFloat(amountStr) <= 0) {
                alert("الرجاء إدخال وصف ومبلغ وتاريخ صالحين."); // Custom modal preferred, but using alert for simplicity in one-file JS
                return;
            }

            const amount = parseFloat(amountStr);

            const transactionData = {
                type: type,
                description: description,
                amount: amount,
                date: date, // YYYY-MM-DD format for easy sorting
                createdAt: serverTimestamp() // To track order of creation
            };

            const collectionPath = `artifacts/${appId}/users/${userId}/financial_transactions`;

            try {
                await addDoc(collection(db, collectionPath), transactionData);
                console.log("Transaction added successfully:", type);
                
                // Clear inputs after successful add
                document.getElementById('transaction-description').value = '';
                document.getElementById('transaction-amount').value = '';
                // Keep date field if user is entering a series of transactions for the same date
                
            } catch (error) {
                console.error("Error adding transaction:", error);
                alert("فشل في إضافة المعاملة: " + error.message);
            }
        }

        /**
         * Deletes a transaction from Firestore.
         * The real-time listener will automatically handle the recalculation.
         * @param {string} docId - The Firestore document ID.
         */
        window.deleteTransaction = async function(docId) {
            if (!db || !userId) return;

            // In a real app, you would use a custom confirmation modal here instead of 'confirm'
            if (!confirm("هل أنت متأكد من حذف هذه المعاملة؟ سيتم تحديث الأرصدة والالتزامات/التحصيلات تلقائياً.")) {
                return;
            }
            
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/financial_transactions`, docId);
            
            try {
                // The deletion ensures that both the value and the date (by removing the entry entirely) 
                // are removed from consideration, fulfilling the user's requirement.
                await deleteDoc(docRef);
                console.log("Transaction deleted successfully:", docId);
            } catch (error) {
                console.error("Error deleting transaction:", error);
                alert("فشل في حذف المعاملة: " + error.message);
            }
        }

        // Initialize the application on load
        initFirebaseAndAuth();

    </script>
</body>
</html>

