<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Dark Mode) */
        :root{ 
            --bg:#0b1220; 
            --card:#0f172a; 
            --muted:#94a3b8; 
            --txt:#e5e7eb; 
            --brand:#0369a1; 
            --brand-2:#0ea5e9; 
            --danger:#ef4444; 
            --warn:#f59e0b; 
            --ok:#22c55e; 
            --border:#1f2a44; 
            --radius:12px; 
            --field-h:42px; 
            --shadow:0 8px 24px rgba(2, 6, 23, 0.4); 
        } 
        /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ (Light Mode) */ 
        html.light-mode{ 
            --bg:#f8fafc; 
            --card:#ffffff; 
            --muted:#64748b; 
            --txt:#1e293b; 
            --brand:#1d4ed8; 
            --brand-2:#3b82f6; 
            --danger:#dc2626; 
            --warn:#f59e0b; 
            --ok:#16a34a; 
            --border:#e2e8f0; 
            --shadow:0 8px 24px rgba(0, 0, 0, 0.1); 
        } 
        html.light-mode header{ 
            box-shadow:0 2px 4px rgba(0, 0, 0, 0.1); 
        } 
        html.light-mode input:focus, html.light-mode select:focus, html.light-mode textarea:focus{ 
            border-color:var(--brand); 
        } 
        html.light-mode body { 
            color: var(--txt); 
        } 
        /* Ù†Ù‡Ø§ÙŠØ© ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ */ 
        *{ 
            box-sizing:border-box; 
        } 
        html,body{ 
            margin:0; 
            padding:0; 
            background-color:var(--bg); 
            color:var(--txt); 
            font-family:'Cairo', sans-serif; 
            font-size:16px; 
            line-height:1.6; 
        } 
        header{ 
            background-color:var(--card); 
            padding:1rem; 
            box-shadow:var(--shadow); 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            margin-bottom:1rem; 
            position: sticky;
            top: 0;
            z-index: 100;
        } 
        header h1{ 
            margin:0; 
            font-size:1.5rem; 
            color:var(--brand-2); 
        } 
        main{ 
            padding:0 1rem 1rem; 
            max-width:1200px; 
            margin:0 auto; 
        } 
        .card{ 
            background-color:var(--card); 
            padding:1rem; 
            border-radius:var(--radius); 
            margin-bottom:1rem; 
            box-shadow:var(--shadow); 
            border:1px solid var(--border); 
        } 
        .card-header{ 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            cursor:pointer; 
            padding-bottom:0.5rem; 
            margin-bottom:0.5rem; 
            border-bottom:1px solid var(--border); 
        } 
        .card-header h2{ 
            margin:0; 
            font-size:1.25rem; 
            color:var(--brand-2); 
        } 
        .content{ 
            display:block; 
            padding-top:0.5rem; 
        } 
        .content.hidden{ 
            display:none; 
        } 
        .grid{ 
            display:grid; 
            gap:1rem; 
        } 
        @media (min-width: 768px) { 
            .grid-2{ 
                grid-template-columns:1fr 1fr; 
            } 
            .grid-3{ 
                grid-template-columns:1fr 1fr 1fr; 
            } 
        } 
        form{ 
            display:flex; 
            flex-direction:column; 
            gap:1rem; 
        } 
        .form-group{ 
            display:flex; 
            flex-direction:column; 
            gap:0.25rem; 
        } 
        label{ 
            color:var(--muted); 
            font-size:0.9rem; 
        } 
        input[type="text"], input[type="number"], input[type="date"], input[type="month"], select, textarea{ 
            background-color:var(--bg); 
            color:var(--txt); 
            border:1px solid var(--border); 
            padding:0 0.75rem; 
            height:var(--field-h); 
            border-radius:var(--radius); 
            font-size:1rem; 
            transition:border-color 0.2s; 
            font-family:'Cairo', sans-serif; 
        } 
        textarea{ 
            height:auto; 
            min-height:80px; 
            padding:0.75rem; 
        } 
        input:focus, select:focus, textarea:focus{ 
            border-color:var(--brand-2); 
            outline:none; 
        } 
        .btn{ 
            background-color:var(--brand); 
            color:white; 
            border:none; 
            padding:0.75rem 1rem; 
            border-radius:var(--radius); 
            cursor:pointer; 
            font-size:1rem; 
            transition:background-color 0.2s; 
            height:var(--field-h); 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            font-family:'Cairo', sans-serif; 
        } 
        .btn:hover{ 
            background-color:var(--brand-2); 
        } 
        .btn-danger{ 
            background-color:var(--danger); 
        } 
        .btn-danger:hover{ 
            background-color:#c81919; 
        } 
        .btn-warn{ 
            background-color:var(--warn); 
        } 
        .btn-warn:hover{ 
            background-color:#d4900a; 
        } 
        .btn-ok{ 
            background-color:var(--ok); 
        } 
        .btn-ok:hover{ 
            background-color:#1e9c4c; 
        } 
        .btn-sm{
            height: 30px !important;
            padding: 0 0.5rem !important;
            font-size: 0.85rem !important;
        }
        table{ 
            width:100%; 
            border-collapse:collapse; 
            margin-top:1rem; 
            font-size:0.95rem; 
        } 
        th,td{ 
            padding:0.75rem; 
            text-align:right; 
            border-bottom:1px solid var(--border); 
        } 
        th{ 
            background-color:var(--bg); 
            color:var(--brand-2); 
            font-weight:bold; 
            position:sticky; 
            top:0; 
        } 
        tr:hover{ 
            background-color:rgba(255, 255, 255, 0.05); 
        } 
        .text-danger{ 
            color:var(--danger); 
        } 
        .text-ok{ 
            color:var(--ok); 
        } 
        .text-warn{ 
            color:var(--warn); 
        } 
        .badge{ 
            display:inline-block; 
            padding:0.25rem 0.5rem; 
            border-radius:9999px; 
            font-size:0.8rem; 
            margin-left:0.5rem; 
        } 
        .badge-danger{ 
            background-color:rgba(239, 68, 68, 0.2); 
            color:var(--danger); 
        } 
        .badge-ok{ 
            background-color:rgba(34, 197, 94, 0.2); 
            color:var(--ok); 
        } 
        .badge-warn{ 
            background-color:rgba(245, 158, 11, 0.2); 
            color:var(--warn); 
        } 
        .nav{ 
            display:flex; 
            border-bottom:2px solid var(--border); 
            margin-bottom:1rem; 
        } 
        .nav-btn{ 
            padding:0.75rem 1.25rem; 
            cursor:pointer; 
            transition:background-color 0.2s, color 0.2s; 
            color:var(--muted); 
            border-bottom:2px solid transparent; 
        } 
        .nav-btn:hover{ 
            color:var(--txt); 
        } 
        .nav-btn.active{ 
            color:var(--brand-2); 
            border-bottom-color:var(--brand-2); 
            font-weight:bold; 
        } 
        .tab-content{ 
            display:none; 
        } 
        .tab-content.active{ 
            display:block; 
        } 
        .summary-box{ 
            background-color:var(--card); 
            padding:1rem; 
            border-radius:var(--radius); 
            text-align:center; 
            border:1px solid var(--border); 
        } 
        .summary-box h3{ 
            margin-top:0; 
            font-size:1rem; 
            color:var(--muted); 
        } 
        .summary-box p{ 
            margin-bottom:0; 
            font-size:1.5rem; 
            font-weight:bold; 
        } 
        .summary-grid{ 
            display:grid; 
            grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); 
            gap:1rem; 
            margin-bottom:1rem; 
        } 
        ul{ 
            list-style:none; 
            padding:0; 
        } 
        ul li{ 
            padding:0.5rem 0; 
            border-bottom:1px solid var(--border); 
        } 
        ul li:last-child{ 
            border-bottom:none; 
        } 
        .actions{
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .actions button{ 
            margin-left:0; /* ØªØ¹Ø¯ÙŠÙ„ */
        } 
        .search-controls{ 
            display:flex; 
            gap:1rem; 
            align-items:center; 
            margin-bottom:1rem; 
        } 
        .search-controls input[type="month"]{ 
            flex-grow:1; 
        } 
        .search-controls button{ 
            width:auto; 
        } 
        .collapsible-icon{ 
            transition:transform 0.3s; 
        } 
        .card.collapsed .collapsible-icon{ 
            transform:rotate(180deg); 
        } 
        .toggle-switch{ 
            position:relative; 
            display:inline-block; 
            width:50px; 
            height:24px; 
        } 
        .toggle-switch input{ 
            opacity:0; 
            width:0; 
            height:0; 
        } 
        .slider{ 
            position:absolute; 
            cursor:pointer; 
            top:0; 
            left:0; 
            right:0; 
            bottom:0; 
            background-color:var(--muted); 
            transition:0.4s; 
            border-radius:24px; 
        } 
        .slider:before{ 
            position:absolute; 
            content:""; 
            height:16px; 
            width:16px; 
            left:4px; 
            bottom:4px; 
            background-color:white; 
            transition:0.4s; 
            border-radius:50%; 
        } 
        input:checked + .slider{ 
            background-color:var(--brand-2); 
        } 
        input:checked + .slider:before{ 
            transform:translateX(26px); 
        } 
        .inline-toggle{ 
            display:flex; 
            align-items:center; 
            gap:1rem; 
        } 
        .no-data{ 
            text-align:center; 
            color:var(--muted); 
            padding:2rem 0; 
        }
        /* ØªØµÙ…ÙŠÙ… Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 101; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: var(--card);
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid var(--border);
            width: 80%; 
            max-width: 600px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
        }
        .close-btn {
            color: var(--muted);
            float: left;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: var(--danger);
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        <h1>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</h1>
        <div class="inline-toggle">
            <button id="btnSettings" class="btn btn-sm" style="height: 30px; width: 30px; padding: 0;">âš™ï¸</button>
            <button id="btnThemeToggle" class="btn btn-sm" style="height: 30px; width: 30px; padding: 0;">ğŸŒ™</button>
        </div>
    </header>

    <main>
        <div class="nav">
            <div class="nav-btn active" data-tab="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            <div class="nav-btn" data-tab="transactions">Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
            <div class="nav-btn" data-tab="commitments">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</div>
            <div class="nav-btn" data-tab="collections">Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª</div>
            <div class="nav-btn" data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
        </div>

        <div id="tab-home" class="tab-content active">
            <div class="summary-grid">
                <div class="summary-box">
                    <h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ</h3>
                    <p id="totalBalance">0.00 EGP</p>
                </div>
                <div class="summary-box">
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ (Ø§Ù„Ø´Ù‡Ø±)</h3>
                    <p id="monthlyIncome" class="text-ok">0.00 EGP</p>
                </div>
                <div class="summary-box">
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø§Ù„Ø´Ù‡Ø±)</h3>
                    <p id="monthlyExpense" class="text-danger">0.00 EGP</p>
                </div>
            </div>

            <div class="card collapsed">
                <div class="card-header">
                    <h2>Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© <span class="badge badge-warn" id="dueSoonCount">0</span></h2>
                    <span class="collapsible-icon">â–¼</span>
                </div>
                <div class="content hidden">
                    <ul id="dueSoonList">
                        <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹.</li>
                    </ul>
                </div>
            </div>
            
            <div class="card collapsed">
                <div class="card-header">
                    <h2>Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
                    <span class="collapsible-icon">â–¼</span>
                </div>
                <div class="content hidden">
                    <button id="btnOpenAccountForm" class="btn btn-sm" style="margin-bottom: 1rem;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
                    <ul id="accountsList">
                        <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                    <span class="collapsible-icon">â–¼</span>
                </div>
                <div class="content">
                    <form id="transactionForm">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="type">Ø§Ù„Ù†ÙˆØ¹</label>
                                <select id="type" required>
                                    <option value="Ø¯Ø®Ù„">Ø¯Ø®Ù„</option>
                                    <option value="Ù…ØµØ±ÙˆÙ">Ù…ØµØ±ÙˆÙ</option>
                                    <option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„</option>
                                </select>
                            </div>
                            <div class="form-group" id="categoryGroup">
                                <label for="category">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                                <select id="category" required></select>
                            </div>
                        </div>

                        <div class="grid grid-3">
                            <div class="form-group">
                                <label for="amount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                                <input type="number" id="amount" required min="0.01" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="accountFrom">Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„Ù…ØµØ¯Ø±)</label>
                                <select id="accountFrom" required></select>
                            </div>
                            <div class="form-group" id="accountToGroup" style="display: none;">
                                <label for="accountTo">Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„ÙˆØ¬Ù‡Ø©)</label>
                                <select id="accountTo"></select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea id="notes"></textarea>
                        </div>

                        <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="tab-transactions" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
                    <span class="collapsible-icon">â–¼</span>
                </div>
                <div class="content">
                    <div class="search-controls">
                        <input type="month" id="monthPicker">
                        <select id="filterAccount">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>
                        </select>
                        <button class="btn" id="btnApplyFilter" style="width: 80px;">ØªØ·Ø¨ÙŠÙ‚</button>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                    <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="no-data-row"><td colspan="7" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-commitments" class="tab-content">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2>Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ²Ø§Ù… Ø´Ù‡Ø±ÙŠ Ø¬Ø¯ÙŠØ¯ (Ø¯ÙØ¹Ø§Øª ØµØ§Ø¯Ø±Ø©)</h2>
                        <span class="collapsible-icon">â–¼</span>
                    </div>
                    <div class="content">
                        <form id="commitmentForm">
                            <div class="form-group">
                                <label for="cName">Ø§Ø³Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</label>
                                <input type="text" id="cName" required>
                            </div>
                            <div class="inline-toggle">
                                <label for="cRecurring">Ù…ØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠØ§Ù‹</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="cRecurring" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="cAmount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                                <input type="number" id="cAmount" required min="0.01" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="cFirstDue">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„</label>
                                <input type="date" id="cFirstDue" required>
                            </div>
                            <div class="form-group" id="cEndAtGroup">
                                <label for="cEndAt">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                <input type="date" id="cEndAt">
                            </div>
                            <div class="form-group">
                                <label for="cNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="cNotes"></textarea>
                            </div>
                            <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h2>
                        <span class="collapsible-icon">â–¼</span>
                    </div>
                    <div class="content">
                        <ul id="commitmentsList">
                            <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-collections" class="tab-content">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2>Ø¥Ø¶Ø§ÙØ© ØªØ¬Ù…ÙŠØ¹/Ø§Ù‚ØªØ·Ø§Ø¹ Ø´Ù‡Ø±ÙŠ Ø¬Ø¯ÙŠØ¯ (Ø¯ÙØ¹Ø§Øª ÙˆØ§Ø±Ø¯Ø©)</h2>
                        <span class="collapsible-icon">â–¼</span>
                    </div>
                    <div class="content">
                        <form id="collectionForm">
                            <div class="form-group">
                                <label for="coName">Ø§Ø³Ù… Ø§Ù„ØªØ¬Ù…ÙŠØ¹</label>
                                <input type="text" id="coName" required>
                            </div>
                            <div class="inline-toggle">
                                <label for="coRecurring">Ù…ØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠØ§Ù‹</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="coRecurring" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="coAmount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                                <input type="number" id="coAmount" required min="0.01" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="coFirstDue">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„</label>
                                <input type="date" id="coFirstDue" required>
                            </div>
                            <div class="form-group" id="coEndAtGroup">
                                <label for="coEndAt">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                <input type="date" id="coEndAt">
                            </div>
                            <div class="form-group">
                                <label for="coNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="coNotes"></textarea>
                            </div>
                            <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„ØªØ¬Ù…ÙŠØ¹</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h2>
                        <span class="collapsible-icon">â–¼</span>
                    </div>
                    <div class="content">
                        <ul id="collectionsList">
                            <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-reports" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
                    <span class="collapsible-icon">â–¼</span>
                </div>
                <div class="content">
                    <div class="search-controls">
                        <input type="month" id="reportMonthPicker">
                        <button class="btn" id="btnGenerateReport">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                    </div>
                    <div style="max-width: 500px; margin: 1rem auto;">
                        <canvas id="chartMonthly"></canvas>
                    </div>
                </div>
            </div>

            <div class="card collapsed">
                <div class="card-header">
                    <h2>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±</h2>
                    <span class="collapsible-icon">â–¼</span>
                </div>
                <div class="content hidden">
                    <h3>Ù…Ù„Ø®Øµ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…ØµØ±ÙˆÙØ§Ù‹)</h3>
                    <div id="catsSummary">
                        <div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶.</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="accountModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" id="closeAccountModal">&times;</span>
                <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
                <form id="accountForm">
                    <div class="form-group">
                        <label for="accountName">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                        <input type="text" id="accountName" required>
                    </div>
                    <div class="form-group">
                        <label for="accountOpening">Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­</label>
                        <input type="number" id="accountOpening" value="0" step="0.01">
                    </div>
                    <button type="submit" class="btn">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨</button>
                </form>

                <hr style="border-color: var(--border); margin: 1rem 0;">

                <h3>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                <ul id="manageAccountsList">
                    <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</li>
                </ul>
            </div>
        </div>

        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" id="closeSettingsModal">&times;</span>
                <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h2>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ</h3>
                    </div>
                    <div class="content inline-toggle">
                        <label>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ / Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="themeToggleInput">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Ù…Ø²Ø§Ù…Ù†Ø© GitHub Gist</h3>
                    </div>
                    <div class="content">
                        <p style="color: var(--muted); font-size: 0.9rem; margin-top: 0;">Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø¹Ø¨Ø± GitHub Gist.</p>
                        <form id="ghSyncForm">
                            <div class="form-group">
                                <label for="ghToken">Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ (Token)</label>
                                <input type="text" id="ghToken" placeholder="ghp_xxxxxx" required>
                            </div>
                            <div class="form-group">
                                <label for="ghGistId">Ù…Ø¹Ø±Ù Gist (ID)</label>
                                <input type="text" id="ghGistId" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                            </div>
                            <div class="actions">
                                <button type="submit" class="btn btn-ok">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                                <button type="button" class="btn btn-brand" id="btnGhPull">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù† (Ø³Ø­Ø¨)</button>
                                <button type="button" class="btn btn-brand-2" id="btnGhPush">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù† (Ø¯ÙØ¹)</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card collapsed">
                    <div class="card-header">
                        <h2>Ø£Ø¯ÙˆØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
                        <span class="collapsible-icon">â–¼</span>
                    </div>
                    <div class="content hidden">
                        <div class="actions" style="margin-top: 1rem;">
                            <button class="btn btn-warn" id="btnExport">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
                            <input type="file" id="importFile" accept="application/json" style="display: none;">
                            <button class="btn btn-warn" id="btnImport">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
                            <button class="btn btn-danger" id="btnClearData">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <script>
        // ====================================================================== 
        // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© 
        // ====================================================================== 
        const escapeHtml=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); 
        const YM = (d=new Date())=>{ 
            const year=d.getFullYear(); 
            const month=String(d.getMonth()+1).padStart(2, '0'); 
            return `${year}-${month}`; 
        }; 
        const startOfToday = () => { 
            const d = new Date(); 
            d.setHours(0, 0, 0, 0); 
            return d; 
        }; 
        const parseLocalDate = (s) => { 
            if (!s) return null; 
            const parts = s.split('-').map(p => parseInt(p, 10)); 
            // -1 Ù„Ù„Ø´Ù‡Ø± Ù„Ø£Ù† Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª ØªØ¨Ø¯Ø£ Ø§Ù„Ø´Ù‡ÙˆØ± Ù…Ù† 0
            return new Date(parts[0], parts[1] - 1, parts[2]); 
        }; 
        const formatLocalDate = (d) => { 
            if (!d) return ''; 
            const year = d.getFullYear(); 
            const month = String(d.getMonth() + 1).padStart(2, '0'); 
            const day = String(d.getDate()).padStart(2, '0'); 
            return `${year}-${month}-${day}`; 
        }; 
        const addMonthsPreserveDOM = (dateStr, months) => { 
            if (!dateStr) return ''; 
            const d = parseLocalDate(dateStr); 
            if (!d) return dateStr; 
            const dayOfMonth = d.getDate(); 
            d.setMonth(d.getMonth() + months); 
            if (d.getDate() !== dayOfMonth) { 
                d.setDate(0); 
            } 
            return formatLocalDate(d); 
        }; 
        const daysBetween = (s1, s2) => { 
            const d1 = parseLocalDate(s1); 
            const d2 = parseLocalDate(s2); 
            if (!d1 || !d2) return 0; 
            const diffTime = Math.abs(d2.getTime() - d1.getTime()); 
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        }; 
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ±Ø­ÙŠÙ„ Placeholder
        const migrateCommit=(c)=>c; 
        const migrateCollect=(c)=>c; 

        const STORAGE_KEY='myFin'; 
        const BASE_CATEGORIES = [ 
            {name: 'Ø±Ø§ØªØ¨', type: 'Ø¯Ø®Ù„'}, 
            {name: 'Ù‡Ø¯ÙŠØ©', type: 'Ø¯Ø®Ù„'}, 
            {name: 'ÙÙˆØ§ØªÙŠØ±', type: 'Ù…ØµØ±ÙˆÙ'}, 
            {name: 'Ø·Ø¹Ø§Ù…', type: 'Ù…ØµØ±ÙˆÙ'}, 
            {name: 'ØªØ³Ù„ÙŠØ©', type: 'Ù…ØµØ±ÙˆÙ'}, 
        ]; 

        let transactions=[], accounts=[], categories=[], commitments=[], collections=[], settings={}; 
        let currentMonth = YM(); 
        let currentAccountFilter = ''; 

        // Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const els = { 
            // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            totalBalance: document.getElementById('totalBalance'), 
            monthlyIncome: document.getElementById('monthlyIncome'), 
            monthlyExpense: document.getElementById('monthlyExpense'), 
            transactionsTableBody: document.querySelector('#transactionsTable tbody'), 
            monthPicker: document.getElementById('monthPicker'), 
            reportMonthPicker: document.getElementById('reportMonthPicker'), 
            filterAccount: document.getElementById('filterAccount'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            btnApplyFilter: document.getElementById('btnApplyFilter'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            btnGenerateReport: document.getElementById('btnGenerateReport'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§

            // Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø­Ø±ÙƒØ§Øª 
            transactionForm: document.getElementById('transactionForm'), 
            type: document.getElementById('type'), 
            category: document.getElementById('category'), 
            categoryGroup: document.getElementById('categoryGroup'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            amount: document.getElementById('amount'), 
            accountFrom: document.getElementById('accountFrom'), 
            accountTo: document.getElementById('accountTo'), 
            accountToGroup: document.getElementById('accountToGroup'), 
            date: document.getElementById('date'),
            notes: document.getElementById('notes'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§

            // Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª 
            commitmentForm: document.getElementById('commitmentForm'), 
            cRecurring: document.getElementById('cRecurring'), 
            cEndAt: document.getElementById('cEndAt'), 
            cEndAtGroup: document.getElementById('cEndAtGroup'), 

            // Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª 
            collectionForm: document.getElementById('collectionForm'), 
            coRecurring: document.getElementById('coRecurring'), 
            coEndAt: document.getElementById('coEndAt'), 
            coEndAtGroup: document.getElementById('coEndAtGroup'), 

            // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© 
            settingsModal: document.getElementById('settingsModal'), 
            btnSettings: document.getElementById('btnSettings'), 
            closeSettingsModal: document.getElementById('closeSettingsModal'), 
            ghSyncForm: document.getElementById('ghSyncForm'), 
            ghToken: document.getElementById('ghToken'), 
            ghGistId: document.getElementById('ghGistId'), 
            btnGhPush: document.getElementById('btnGhPush'),
            btnGhPull: document.getElementById('btnGhPull'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            btnThemeToggle: document.getElementById('btnThemeToggle'),
            themeToggleInput: document.getElementById('themeToggleInput'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            btnClearData: document.getElementById('btnClearData'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            btnExport: document.getElementById('btnExport'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            btnImport: document.getElementById('btnImport'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            importFile: document.getElementById('importFile'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§

            // Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… 
            accountsList: document.getElementById('accountsList'), 
            dueSoonList: document.getElementById('dueSoonList'), 
            dueSoonCount: document.getElementById('dueSoonCount'), 
            commitmentsList: document.getElementById('commitmentsList'), 
            collectionsList: document.getElementById('collectionsList'), 

            // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª 
            accountModal: document.getElementById('accountModal'),
            btnOpenAccountForm: document.getElementById('btnOpenAccountForm'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            closeAccountModal: document.getElementById('closeAccountModal'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            accountForm: document.getElementById('accountForm'), 
            accountName: document.getElementById('accountName'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            accountOpening: document.getElementById('accountOpening'), // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§
            manageAccountsList: document.getElementById('manageAccountsList'), 
        }; 

        // ====================================================================== 
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† (Storage Functions) 
        // ====================================================================== 
        function loadData(){ 
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); 
            transactions = data.transactions || []; 
            accounts = data.accounts || []; 
            categories = data.categories || []; 
            commitments = data.commitments || []; 
            collections = data.collections || []; 
            settings = data.settings || {}; 
        } 
        function saveData(){ 
            const data = {transactions, accounts, categories, commitments, collections, settings}; 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); 
        } 
        function saveSettings(){ 
            saveData(); 
        } 
        // ====================================================================== 
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ (Formatting & Theme Functions) 
        // ====================================================================== 
        function formatCurrency(amount){ 
            // ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ (EGP) 
            return new Intl.NumberFormat('ar-EG', {style: 'currency', currency: 'EGP'}).format(amount); 
        } 
        function loadTheme() { 
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            const isLight = savedTheme === 'light';

            if (isLight) { 
                document.documentElement.classList.add('light-mode'); 
            } else { 
                document.documentElement.classList.remove('light-mode'); 
            } 
            
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ (Ø§Ù„Ù…Ø¯Ø®Ù„ Ø¯Ø§Ø®Ù„Ù‡)
            if (els.themeToggleInput) els.themeToggleInput.checked = isLight;
            // ØªØ­Ø¯ÙŠØ« Ø±Ù…Ø² Ø§Ù„Ø²Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
            if (els.btnThemeToggle) els.btnThemeToggle.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™'; 
        } 
        function toggleTheme() { 
            const isLight = document.documentElement.classList.toggle('light-mode'); 
            localStorage.setItem('theme', isLight ? 'light' : 'dark'); 
            
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ (Ø§Ù„Ù…Ø¯Ø®Ù„ Ø¯Ø§Ø®Ù„Ù‡)
            if (els.themeToggleInput) els.themeToggleInput.checked = isLight;
            // ØªØ­Ø¯ÙŠØ« Ø±Ù…Ø² Ø§Ù„Ø²Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
            if (els.btnThemeToggle) els.btnThemeToggle.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™'; 

            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù„ÙˆØ§Ù† 
            if (document.getElementById('tab-reports').classList.contains('active') && monthlyChartInstance) { 
                drawMonthly(); 
            } 
        } 
        // ====================================================================== 
        // Ø¯ÙˆØ§Ù„ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ (Business Logic) 
        // ====================================================================== 
        function calculateAccountBalance(accountName){ 
            const account = accounts.find(a => a.name === accountName); 
            if (!account) return 0; 
            const initial = parseFloat(account.opening) || 0; // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ø±Ù‚Ù…
            const balance = transactions 
                .filter(t => t.account === accountName || t.accountTo === accountName) 
                .reduce((sum, t) => { 
                    if (t.type === 'Ø¯Ø®Ù„' && t.account === accountName) return sum + parseFloat(t.amount); 
                    if (t.type === 'Ù…ØµØ±ÙˆÙ' && t.account === accountName) return sum - parseFloat(t.amount); 
                    if (t.type === 'ØªØ­ÙˆÙŠÙ„') { 
                        if (t.account === accountName) return sum - parseFloat(t.amount); 
                        if (t.accountTo === accountName) return sum + parseFloat(t.amount); 
                    } 
                    return sum; 
                }, 0); 
            return initial + balance; 
        } 
        function calculateTotalBalance(){ 
            return accounts.reduce((sum, a) => sum + calculateAccountBalance(a.name), 0); 
        } 
        function ensureBaseCategories(){ 
            BASE_CATEGORIES.forEach(baseCat => { 
                if (!categories.find(c => c.name === baseCat.name && c.type === baseCat.type)) { 
                    categories.push(baseCat); 
                } 
            }); 
            saveData(); 
        } 
        function ensureTransferCategories(){ 
            const transferCat = {name: 'ØªØ­ÙˆÙŠÙ„', type: 'Ù†Ø¸Ø§Ù…ÙŠ'}; 
            if (!categories.find(c => c.name === transferCat.name)) { 
                categories.push(transferCat); 
            } 
            saveData(); 
        } 
        function calculateMonthlySummary(month){ 
            const filtered = transactions.filter(t => t.date.startsWith(month)); 
            const income = filtered.filter(t => t.type === 'Ø¯Ø®Ù„').reduce((sum, t) => sum + parseFloat(t.amount), 0); 
            const expense = filtered.filter(t => t.type === 'Ù…ØµØ±ÙˆÙ').reduce((sum, t) => sum + parseFloat(t.amount), 0); 
            return {income, expense}; 
        } 

        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…
        function generateDueTransactions(commitmentsOrCollections, isCommitment) {
            const today = startOfToday();
            const yearMonth = YM(today);
            const list = [];
            
            // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø³Ù†Ù‚ÙˆÙ… ÙÙ‚Ø· Ø¨Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª/Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ùˆ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹
            commitmentsOrCollections.forEach(item => {
                let currentDueDate = parseLocalDate(item.firstDue);
                
                // Ø§Ù„ØªØ¬Ø§ÙˆØ² Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ùˆ Ø£Ù‚Ø±Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ
                while (currentDueDate && currentDueDate.getTime() < today.getTime() && YM(currentDueDate) !== yearMonth) {
                    currentDueDate = parseLocalDate(addMonthsPreserveDOM(formatLocalDate(currentDueDate), 1));
                    if (item.endAt && currentDueDate > parseLocalDate(item.endAt)) {
                        currentDueDate = null; // ØªØ¬Ø§ÙˆØ² ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                        break;
                    }
                }

                if (currentDueDate && YM(currentDueDate) === yearMonth) {
                    const daysLeft = daysBetween(formatLocalDate(today), formatLocalDate(currentDueDate));
                    const status = daysLeft === 0 ? 'Ø§Ù„ÙŠÙˆÙ…' : (daysLeft > 0 ? `Ø¨Ø¹Ø¯ ${daysLeft} ÙŠÙˆÙ…` : `ØªØ£Ø®ÙŠØ± ${Math.abs(daysLeft)} ÙŠÙˆÙ…`);
                    
                    list.push({
                        name: item.name,
                        amount: item.amount,
                        dueDate: formatLocalDate(currentDueDate),
                        status: status,
                        type: isCommitment ? 'Ø§Ù„ØªØ²Ø§Ù…' : 'ØªØ¬Ù…ÙŠØ¹',
                    });
                }
            });

            return list.sort((a, b) => parseLocalDate(a.dueDate) - parseLocalDate(b.dueDate));
        }
        // ====================================================================== 
        // Ø¯ÙˆØ§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UI/Rendering) 
        // ====================================================================== 
        function refreshAccountSelects(){ 
            const accountOptions = accounts.map(a => `<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join(''); 
            if(els.accountFrom) els.accountFrom.innerHTML = accountOptions; 
            if(els.accountTo) els.accountTo.innerHTML = accountOptions; 
            const filterOptions = `<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>` + accountOptions; 
            if(els.filterAccount) els.filterAccount.innerHTML = filterOptions; 
        } 
        function refreshCategorySelect(){ 
            if(!els.type) return; 
            // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ù„Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª
            if (els.type.value === 'ØªØ­ÙˆÙŠÙ„') {
                els.category.innerHTML = '';
                return;
            }
            const cats = categories.filter(c=>c.type===els.type.value); 
            els.category.innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join(''); 
        } 
        function renderTransactions(month, accountName = ''){ 
            const filtered = transactions 
                .filter(t => t.date.startsWith(month)) 
                .filter(t => !accountName || t.account === accountName || t.accountTo === accountName) 
                .sort((a, b) => parseLocalDate(b.date).getTime() - parseLocalDate(a.date).getTime()); 
            
            if (filtered.length === 0) { 
                els.transactionsTableBody.innerHTML = `<tr class="no-data-row"><td colspan="7" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>`; 
                return; 
            } 
            
            const rows = filtered.map(t => { 
                const amountClass = t.type === 'Ø¯Ø®Ù„' ? 'text-ok' : (t.type === 'Ù…ØµØ±ÙˆÙ' ? 'text-danger' : ''); 
                const accountDisplay = t.type === 'ØªØ­ÙˆÙŠÙ„' ? `${t.account} â¡ï¸ ${t.accountTo}` : t.account; 
                const typeDisplay = t.type === 'ØªØ­ÙˆÙŠÙ„' ? 'ØªØ­ÙˆÙŠÙ„' : t.type; 
                const amountSign = t.type === 'Ù…ØµØ±ÙˆÙ' ? '-' : (t.type === 'Ø¯Ø®Ù„' ? '+' : ''); 
                const categoryDisplay = t.type === 'ØªØ­ÙˆÙŠÙ„' ? 'Ù†Ø¸Ø§Ù…ÙŠ' : t.category;
                
                return ` 
                    <tr> 
                        <td>${escapeHtml(t.date)}</td> 
                        <td>${escapeHtml(typeDisplay)}</td> 
                        <td>${escapeHtml(categoryDisplay)}</td> 
                        <td>${escapeHtml(accountDisplay)}</td> 
                        <td class="${amountClass}">${amountSign}${formatCurrency(t.amount)}</td> 
                        <td>${escapeHtml(t.notes || '')}</td> 
                        <td><button class="btn btn-danger btn-sm" onclick="deleteTransaction('${t.id}')">Ø­Ø°Ù</button></td> 
                    </tr> 
                `; 
            }).join(''); 
            els.transactionsTableBody.innerHTML = rows; 
        } 
        function renderSummary(month){ 
            const {income, expense} = calculateMonthlySummary(month); 
            els.totalBalance.textContent = formatCurrency(calculateTotalBalance()); 
            els.monthlyIncome.textContent = formatCurrency(income); 
            els.monthlyExpense.textContent = formatCurrency(expense); 
        } 
        function render(){ 
            renderSummary(currentMonth); 
            renderTransactions(currentMonth, currentAccountFilter); 
            drawAccountsList(); 
            drawManageAccountsList();
        } 
        function drawAccountsList(){ 
            if(!els.accountsList) return; 
            const listHtml = accounts.map(a=>`<li>${escapeHtml(a.name)}: ${formatCurrency(calculateAccountBalance(a.name))}</li>`).join(''); 
            els.accountsList.innerHTML = listHtml || '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</li>'; 
        }
        function drawManageAccountsList(){
            if(!els.manageAccountsList) return;
            const listHtml = accounts.map(a => `
                <li>
                    ${escapeHtml(a.name)} - Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ: ${formatCurrency(a.opening || 0)}
                    <button class="btn btn-danger btn-sm" onclick="deleteAccount('${escapeHtml(a.name)}')">Ø­Ø°Ù</button>
                </li>
            `).join('');
            els.manageAccountsList.innerHTML = listHtml || '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</li>';
        } 
        function drawCommitments(){ 
            if(!els.commitmentsList) return; 
            const listHtml = commitments.map(c=>`
                <li>
                    ${escapeHtml(c.name)} - ${formatCurrency(c.amount)} ${c.recurring ? ' (Ø´Ù‡Ø±ÙŠ)' : ''}
                    <div style="font-size: 0.8rem; color: var(--muted);">${c.firstDue} ${c.endAt ? ` - Ø¥Ù„Ù‰ ${c.endAt}` : ''}</div>
                    <button class="btn btn-danger btn-sm" onclick="deleteCommitment('${c.id}')">Ø­Ø°Ù</button>
                </li>
            `).join('');
            els.commitmentsList.innerHTML = listHtml || '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>'; 
        } 
        function drawCollections(){ 
            if(!els.collectionsList) return; 
            const listHtml = collections.map(c=>`
                <li>
                    ${escapeHtml(c.name)} - ${formatCurrency(c.amount)} ${c.recurring ? ' (Ø´Ù‡Ø±ÙŠ)' : ''}
                    <div style="font-size: 0.8rem; color: var(--muted);">${c.firstDue} ${c.endAt ? ` - Ø¥Ù„Ù‰ ${c.endAt}` : ''}</div>
                    <button class="btn btn-danger btn-sm" onclick="deleteCollection('${c.id}')">Ø­Ø°Ù</button>
                </li>
            `).join('');
            els.collectionsList.innerHTML = listHtml || '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>'; 
        } 
        function drawDueSoon(){ 
            if(!els.dueSoonList) return; 
            const allDues = [
                ...generateDueTransactions(commitments, true),
                ...generateDueTransactions(collections, false)
            ];

            const listHtml = allDues.map(d => {
                const badgeClass = d.status.includes('Ø§Ù„ÙŠÙˆÙ…') ? 'badge-danger' : (d.status.includes('ØªØ£Ø®ÙŠØ±') ? 'badge-warn' : 'badge-ok');
                return `
                    <li>
                        ${escapeHtml(d.name)} (${d.type}): ${formatCurrency(d.amount)}
                        <span class="badge ${badgeClass}">${escapeHtml(d.status)}</span>
                        <div style="font-size: 0.8rem; color: var(--muted);">${d.dueDate}</div>
                    </li>
                `;
            }).join('');

            els.dueSoonList.innerHTML = listHtml || '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹.</li>';
            els.dueSoonCount.textContent = allDues.length.toString();
        } 

        let monthlyChartInstance = null; 
        function drawMonthly(){ 
            if(monthlyChartInstance) monthlyChartInstance.destroy(); 
            const ctx = document.getElementById('chartMonthly').getContext('2d'); 
            
            // Ø­Ø³Ø§Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ 
            const currentReportMonth = els.reportMonthPicker.value || YM(); 
            const {income, expense} = calculateMonthlySummary(currentReportMonth); 
            
            const isLightMode = document.documentElement.classList.contains('light-mode'); 
            const data = { 
                labels: [`Ø¯Ø®Ù„ (${formatCurrency(income)})`, `Ù…ØµØ±ÙˆÙ (${formatCurrency(expense)})`], 
                datasets: [{ 
                    label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº', 
                    data: [income, expense], 
                    backgroundColor: [isLightMode ? '#16a34a' : '#22c55e', isLightMode ? '#dc2626' : '#ef4444'], 
                    hoverOffset: 4 
                }] 
            }; 
            
            monthlyChartInstance = new Chart(ctx, { 
                type: 'doughnut', 
                data: data, 
                options: { 
                    responsive: true, 
                    plugins: { 
                        legend: { 
                            position: 'top', 
                            labels: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--txt'), // Ù„ÙˆÙ† Ø§Ù„Ù†Øµ 
                                font: { family: 'Cairo, sans-serif' } 
                            } 
                        }, 
                        title: { 
                            display: true, 
                            text: `ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª (${currentReportMonth})`, 
                            color: getComputedStyle(document.documentElement).getPropertyValue('--brand-2'), 
                            font: { family: 'Cairo, sans-serif', size: 16 } 
                        } 
                    } 
                } 
            }); 
        } 
        function drawCatsBadges(){} // Ø¯Ø§Ù„Ø© placeholder 
        // ====================================================================== 
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Handlers) 
        // ====================================================================== 
        function deleteTransaction(id){ 
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')) return; 
            transactions = transactions.filter(t => t.id !== id); 
            saveData(); 
            render(); 
        }
        function deleteCommitment(id){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…ØŸ')) return;
            commitments = commitments.filter(c => c.id !== id);
            saveData();
            drawCommitments();
            drawDueSoon();
        }
        function deleteCollection(id){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ØŸ')) return;
            collections = collections.filter(c => c.id !== id);
            saveData();
            drawCollections();
            drawDueSoon();
        }
        function deleteAccount(name){
            if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ${name}ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø­Ø±ÙƒØ§ØªÙ‡.`)) return;
            accounts = accounts.filter(a => a.name !== name);
            transactions = transactions.filter(t => t.account !== name && t.accountTo !== name);
            saveData();
            refreshAccountSelects();
            render();
            alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ­Ø±ÙƒØ§ØªÙ‡.');
        }

        function handleTransactionTypeChange(e){ 
            const isTransfer = e.target.value === 'ØªØ­ÙˆÙŠÙ„'; 
            
            // Ø¥Ø¯Ø§Ø±Ø© Ø­Ù‚Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„ÙˆØ¬Ù‡Ø©)
            els.accountToGroup.style.display = isTransfer ? 'flex' : 'none'; 
            if(els.accountTo) els.accountTo.toggleAttribute('required', isTransfer); 
            
            // Ø¥Ø¯Ø§Ø±Ø© Ø­Ù‚Ù„ Ø§Ù„ØªØµÙ†ÙŠÙ
            if(els.category) els.category.toggleAttribute('required', !isTransfer); 
            if(els.categoryGroup) els.categoryGroup.style.display = isTransfer ? 'none' : 'flex'; 

            refreshCategorySelect(); 
        } 
        function addTransaction(e){ 
            e.preventDefault(); 
            const type = els.type.value; 
            const amount = parseFloat(els.amount.value); 
            const date = els.date.value; 
            const accountFrom = els.accountFrom.value; 
            const notes = els.notes.value; 
            
            if(amount <= 0 || !date || !accountFrom) { 
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ÙˆØ­Ø³Ø§Ø¨ ÙˆØªØ§Ø±ÙŠØ® ØµØ§Ù„Ø­ÙŠÙ†.'); 
                return; 
            } 
            
            if (type === 'ØªØ­ÙˆÙŠÙ„') { 
                const accountTo = els.accountTo.value; 
                if (accountFrom === accountTo) { 
                    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† ÙˆØ¥Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨.'); 
                    return; 
                } 
                // Ø§Ù„Ø­Ø±ÙƒØ© 1: Ù…ØµØ±ÙˆÙ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ¯Ø± 
                transactions.push({ 
                    id: Date.now() + '-out', 
                    type: 'Ù…ØµØ±ÙˆÙ', 
                    category: 'ØªØ­ÙˆÙŠÙ„', 
                    amount: amount, 
                    account: accountFrom, 
                    date: date, 
                    notes: `ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø± Ø¥Ù„Ù‰ ${accountTo}` 
                }); 
                // Ø§Ù„Ø­Ø±ÙƒØ© 2: Ø¯Ø®Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ¬Ù‡Ø© 
                transactions.push({ 
                    id: (Date.now() + 1) + '-in', // ID ÙØ±ÙŠØ¯
                    type: 'Ø¯Ø®Ù„', 
                    category: 'ØªØ­ÙˆÙŠÙ„', 
                    amount: amount, 
                    accountTo: accountTo, // Ù†Ø³ØªØ®Ø¯Ù… accountTo ÙƒØ§Ø®ØªØµØ§Ø± Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ¬Ù‡Ø©
                    account: accountFrom, // Ù†Ø³ØªØ®Ø¯Ù… account ÙƒØ§Ø®ØªØµØ§Ø± Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ¯Ø±
                    date: date, 
                    notes: `ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯ Ù…Ù† ${accountFrom}` 
                }); 
            } else { 
                // Ø¯Ø®Ù„ Ø£Ùˆ Ù…ØµØ±ÙˆÙ Ø¹Ø§Ø¯ÙŠ 
                const category = els.category.value; 
                if (!category) { 
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªØµÙ†ÙŠÙ.'); 
                    return; 
                } 
                transactions.push({ 
                    id: Date.now().toString(), 
                    type: type, 
                    category: category, 
                    amount: amount, 
                    account: accountFrom, 
                    date: date, 
                    notes: notes,
                    accountTo: null, // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡ Ù„Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                }); 
            } 
            saveData(); 
            e.target.reset(); 
            els.date.value = formatLocalDate(startOfToday()); 
            render(); 
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!'); 
        } 
        function addCommitment(e){ 
            e.preventDefault(); 
            const name = document.getElementById('cName').value; 
            const amount = parseFloat(document.getElementById('cAmount').value); 
            const firstDueStr = document.getElementById('cFirstDue').value; 
            const notes = document.getElementById('cNotes').value; 
            const recurring = els.cRecurring.checked; 
            const endAtStr = els.cEndAt.value; 
            
            if (amount <= 0 || !firstDueStr || !name) { 
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ÙˆØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ­Ù‚Ø§Ù‚ ØµØ§Ù„Ø­ÙŠÙ†.'); 
                return; 
            } 
            if(recurring && endAtStr && parseLocalDate(endAtStr) < parseLocalDate(firstDueStr)){ 
                alert('ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„.'); 
                return; 
            } 
            
            commitments.push({ 
                id: Date.now().toString(), 
                name, 
                amount, 
                firstDue: firstDueStr, 
                notes, 
                recurring, 
                endAt: recurring && endAtStr ? endAtStr : null 
            }); 
            
            saveData(); 
            e.target.reset(); 
            drawCommitments(); 
            drawDueSoon(); 
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!'); 
        } 
        function addCollection(e){ 
            e.preventDefault(); 
            const name = document.getElementById('coName').value; 
            const amount = parseFloat(document.getElementById('coAmount').value); 
            const firstDueStr = document.getElementById('coFirstDue').value; 
            const notes = document.getElementById('coNotes').value; 
            const recurring = els.coRecurring.checked; 
            const endAtStr = els.coEndAt.value; 
            
            if (amount <= 0 || !firstDueStr || !name) { 
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ÙˆØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ­Ù‚Ø§Ù‚ ØµØ§Ù„Ø­ÙŠÙ†.'); 
                return; 
            } 
            if(recurring && endAtStr && parseLocalDate(endAtStr) < parseLocalDate(firstDueStr)){ 
                alert('ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„.'); 
                return; 
            } 
            
            collections.push({ 
                id: Date.now().toString(), 
                name, 
                amount, 
                firstDue: firstDueStr, 
                notes, 
                recurring, 
                endAt: recurring && endAtStr ? endAtStr : null
            }); 
            
            saveData(); 
            e.target.reset(); 
            drawCollections(); 
            drawDueSoon(); 
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!'); 
        } 
        function handleMonthFilter(e){ 
            currentMonth = els.monthPicker.value; 
            currentAccountFilter = els.filterAccount.value; 
            render(); 
        }

        function addAccount(e){
            e.preventDefault();
            const name = els.accountName.value.trim();
            const opening = parseFloat(els.accountOpening.value) || 0;

            if (!name) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨.');
                return;
            }

            const existingAccount = accounts.find(a => a.name === name);

            if (existingAccount) {
                existingAccount.opening = opening;
                alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ Ù„Ø­Ø³Ø§Ø¨: ${name}`);
            } else {
                accounts.push({ name, opening });
                alert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯: ${name}`);
            }

            saveData();
            e.target.reset();
            refreshAccountSelects();
            render();
        }

        // ====================================================================== 
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub (ØªØµØ­ÙŠØ­ Ø§Ù„ÙƒÙˆØ¯) 
        // ====================================================================== 
        function ghSaveSettings(e){ 
            e.preventDefault(); 
            settings.ghToken = els.ghToken.value.trim(); 
            settings.ghGistId = els.ghGistId.value.trim(); 
            saveSettings(); 
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub.'); 
        } 
        function fillGhFormFromStorage(){ 
            els.ghToken.value = settings.ghToken || ''; 
            els.ghGistId.value = settings.ghGistId || ''; 
        } 

        async function ghPush(){
            const { ghToken, ghGistId } = settings;
            if (!ghToken || !ghGistId) {
                alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ ÙˆÙ…Ø¹Ø±Ù Gist ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            const dataToSave = {
                transactions, accounts, categories, commitments, collections, settings
            };
            const content = JSON.stringify(dataToSave, null, 2);
            const filename = 'myfinances.json'; // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ Gist

            try {
                const response = await fetch(`https://api.github.com/gists/${ghGistId}`, {
                    method: 'PATCH', // ØªØ­Ø¯ÙŠØ« Gist Ù…ÙˆØ¬ÙˆØ¯
                    headers: {
                        'Authorization': `token ${ghToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            [filename]: { content }
                        }
                    })
                });

                if (response.ok) {
                    alert('âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­ (Ø¯ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Gist).');
                } else {
                    const errorData = await response.json();
                    console.error('GitHub Push Error:', errorData);
                    alert(`âŒ ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹ Ø¥Ù„Ù‰ Gist: ${response.status}. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ Token ÙˆÙ…Ø¹Ø±Ù Gist.`);
                }
            } catch (error) {
                console.error('Network or Push Error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¯ÙØ¹.');
            }
        }

        async function ghPull(){
            const { ghToken, ghGistId } = settings;
            if (!ghToken || !ghGistId) {
                alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ ÙˆÙ…Ø¹Ø±Ù Gist ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            
            const filename = 'myfinances.json';

            try {
                const response = await fetch(`https://api.github.com/gists/${ghGistId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${ghToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const gist = await response.json();
                    const file = gist.files[filename];

                    if (file && file.content) {
                        const remoteData = JSON.parse(file.content);
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Gist
                        transactions = remoteData.transactions || transactions;
                        accounts = remoteData.accounts || accounts;
                        categories = remoteData.categories || categories;
                        commitments = remoteData.commitments || commitments;
                        collections = remoteData.collections || collections;
                        // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Token Ùˆ Gist ID Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ±Ø§ Ø¹Ù† Ø¨Ø¹Ø¯
                        settings = {...settings, ...remoteData.settings}; 
                        
                        saveData();
                        init(); // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                        alert('âœ… ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Gist Ø¨Ù†Ø¬Ø§Ø­.');
                    } else {
                        alert(`âŒ Ø§Ù„Ù…Ù„Ù "${filename}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Gist Ø£Ùˆ ÙØ§Ø±Øº.`);
                    }
                } else {
                    const errorData = await response.json();
                    console.error('GitHub Pull Error:', errorData);
                    alert(`âŒ ÙØ´Ù„ Ø³Ø­Ø¨ Gist: ${response.status}. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ Token ÙˆÙ…Ø¹Ø±Ù Gist.`);
                }
            } catch (error) {
                console.error('Network or Pull Error:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ø³Ø­Ø¨.');
            }
        }
        
        // ====================================================================== 
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ (Initialization & Interaction) 
        // ====================================================================== 
        function initCollapsibles(){ 
            document.querySelectorAll('.card-header').forEach(header => { 
                header.addEventListener('click', () => { 
                    const card = header.closest('.card'); 
                    card.classList.toggle('collapsed'); 
                    const content = card.querySelector('.content'); 
                    if (content) content.classList.toggle('hidden'); 
                }); 
            }); 
        } 
        function initTabs(){ 
            document.querySelectorAll('.nav-btn').forEach(btn => { 
                btn.addEventListener('click', (e) => { 
                    const tabId = e.target.dataset.tab; 
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); 
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
                    e.target.classList.add('active'); 
                    const targetContent = document.getElementById(`tab-${tabId}`); 
                    if (targetContent) targetContent.classList.add('active'); 
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± 
                    if (tabId === 'reports') { 
                        const defaultReportMonth = els.reportMonthPicker.value || YM(); 
                        if(!els.reportMonthPicker.value) els.reportMonthPicker.value = defaultReportMonth; 
                        drawMonthly(); 
                    }
                    if (tabId === 'home') {
                        drawDueSoon(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    }
                }); 
            }); 
        } 

        function clearAllData() {
            if (!confirm('ØªØ­Ø°ÙŠØ±! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) return;
            localStorage.removeItem(STORAGE_KEY);
            transactions = [];
            accounts = [];
            categories = [];
            commitments = [];
            collections = [];
            settings = {};
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
            init(); 
            alert('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
        }

        function exportData() {
            const data = JSON.stringify({transactions, accounts, categories, commitments, collections, settings}, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `myfinances-backup-${formatLocalDate(new Date())}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (!confirm('ØªØ­Ø°ÙŠØ±! Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
                    
                    transactions = importedData.transactions || [];
                    accounts = importedData.accounts || [];
                    categories = importedData.categories || [];
                    commitments = importedData.commitments || [];
                    collections = importedData.collections || [];
                    settings = {...settings, ...importedData.settings}; // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Token/ID Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                    
                    saveData();
                    init();
                    alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
                } catch (error) {
                    alert('âŒ ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­.');
                    console.error('Import Error:', error);
                }
            };
            reader.readAsText(file);
        }

        /* ===== ØªÙ‡ÙŠØ¦Ø© ===== */ 
        function init(){ 
            loadTheme(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ Ø£ÙˆÙ„Ø§Ù‹ 
            loadData(); 
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            if(accounts.length===0){ 
                accounts=[{name:'ÙƒØ§Ø´',opening:0},{name:'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ',opening:0},{name:'Ù…Ø­ÙØ¸Ø©',opening:0}]; 
                saveData(); 
            } 
            ensureBaseCategories(); 
            initCollapsibles(); 
            initTabs(); 
            
            commitments=commitments.map(c=>migrateCommit(c)); 
            collections=collections.map(c=>migrateCollect(c)); 
            saveData(); 
            ensureTransferCategories(); 
            
            // ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„Ø´Ù‡Ø±
            const todayYM=YM();
            const todayDate = formatLocalDate(startOfToday());
            if(els.monthPicker){ 
                if(!els.monthPicker.value) els.monthPicker.value=todayYM; 
                els.monthPicker.setAttribute('max', todayYM); 
            } 
            if(els.reportMonthPicker) {
                if(!els.reportMonthPicker.value) els.reportMonthPicker.value=todayYM; 
                els.reportMonthPicker.setAttribute('max', todayYM);
            }
            if(els.date) els.date.value = todayDate;
            if(document.getElementById('cFirstDue')) document.getElementById('cFirstDue').value = todayDate;
            if(document.getElementById('coFirstDue')) document.getElementById('coFirstDue').value = todayDate;

            refreshAccountSelects(); 
            refreshCategorySelect(); 
            drawCatsBadges(); 
            drawCommitments(); 
            drawCollections(); 
            drawDueSoon(); 
            render(); 
            fillGhFormFromStorage(); 
            
            // ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ·Ø©
            els.cEndAtGroup.style.display = els.cRecurring?.checked ? 'flex' : 'none';
            els.coEndAtGroup.style.display = els.coRecurring?.checked ? 'flex' : 'none';
        } 

        // ====================================================================== 
        // Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª (Event Listeners) 
        // ====================================================================== 
        document.addEventListener('DOMContentLoaded', init); 

        // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ 
        els.btnThemeToggle?.addEventListener('click', toggleTheme);
        els.themeToggleInput?.addEventListener('change', toggleTheme);

        // Ø­Ø±ÙƒØ§Øª 
        els.transactionForm.addEventListener('submit', addTransaction); 
        els.type.addEventListener('change', handleTransactionTypeChange); 
        els.type.addEventListener('change', refreshCategorySelect); 
        els.btnApplyFilter?.addEventListener('click', handleMonthFilter);
        els.filterAccount?.addEventListener('change', handleMonthFilter); // ØªØµÙÙŠØ© ÙÙˆØ±ÙŠØ©
        els.monthPicker?.addEventListener('change', handleMonthFilter); // ØªØµÙÙŠØ© ÙÙˆØ±ÙŠØ©

        // Ø§Ù„ØªØ²Ø§Ù…Ø§Øª 
        els.commitmentForm.addEventListener('submit', addCommitment); 
        els.cRecurring?.addEventListener('change', e => { 
            els.cEndAtGroup.style.display = e.target.checked ? 'flex' : 'none'; 
            els.cEndAt?.toggleAttribute('required', e.target.checked); 
        }); 

        // ØªØ¬Ù…ÙŠØ¹Ø§Øª 
        els.collectionForm.addEventListener('submit', addCollection); 
        els.coRecurring?.addEventListener('change', e => { 
            els.coEndAtGroup.style.display = e.target.checked ? 'flex' : 'none'; 
            els.coEndAt?.toggleAttribute('required', e.target.checked); 
        }); 

        // ØªÙ‚Ø§Ø±ÙŠØ± 
        els.btnGenerateReport?.addEventListener('click', drawMonthly);
        els.reportMonthPicker?.addEventListener('change', drawMonthly); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Modal)
        els.btnOpenAccountForm?.addEventListener('click', () => { 
            els.accountModal.style.display = 'block'; 
            drawManageAccountsList(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        }); 
        els.closeAccountModal?.addEventListener('click', () => { 
            els.accountModal.style.display = 'none'; 
        }); 
        els.accountForm?.addEventListener('submit', addAccount);

        // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Modal) 
        els.btnSettings?.addEventListener('click', () => { 
            els.settingsModal.style.display = 'block'; 
            fillGhFormFromStorage();
        }); 
        els.closeSettingsModal?.addEventListener('click', () => { 
            els.settingsModal.style.display = 'none'; 
        }); 
        els.ghSyncForm?.addEventListener('submit', ghSaveSettings); 
        els.btnGhPush?.addEventListener('click', ghPush);
        els.btnGhPull?.addEventListener('click', ghPull);

        // Ø£Ø¯ÙˆØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
        els.btnClearData?.addEventListener('click', clearAllData);
        els.btnExport?.addEventListener('click', exportData);
        els.btnImport?.addEventListener('click', () => els.importFile.click());
        els.importFile?.addEventListener('change', importData);

    </script>
</body>
</html>
