
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>جمع المتطلبات — index.html</title>
  <style>
    body{font-family: Tajawal, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:18px; background:#f7fafc; color:#0f172a}
    .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(12,20,40,0.06); margin-bottom:16px}
    h1{margin:0 0 10px 0;font-size:20px}
    label{display:inline-block;margin-bottom:8px}
    input[type=file]{display:block}
    button{background:#0ea5a4;color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;margin:6px 6px 0 0}
    button.secondary{background:#64748b}
    pre{background:#0b1221;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e6eef8;padding:8px;text-align:right}
    .flex{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
    .small{font-size:13px;color:#475569}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#e6f6f6;color:#064e4e;font-weight:600}
    .hidden{display:none}
    @media (max-width:600px){body{padding:12px}}
  </style>
  <!-- js-yaml for YAML parsing -->
  <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>جامع المتطلبات — افتح الملفات وجمّعها في ملف واحد</h1>
    <p class="small">ارفع ملفات JSON / YAML / MD. السكربت هيطبع النتائج ويخلّيك تحمّلها كـ JSON / CSV / MD.</p>

    <label>اختر ملفات (متعدد)</label>
    <input id="files" type="file" multiple accept=".json,.yaml,.yml,.md,text/markdown,application/json" />

    <div style="margin-top:10px" class="flex">
      <button id="processBtn">ابدأ التجميع</button>
      <button id="clearBtn" class="secondary">مسح النتائج</button>
      <button id="downloadJson" class="hidden">تحميل JSON</button>
      <button id="downloadCsv" class="hidden">تحميل CSV</button>
      <button id="downloadMd" class="hidden">تحميل Markdown</button>
    </div>

    <div id="stats" style="margin-top:12px" class="small"></div>
  </div>

  <div id="resultContainer" class="card hidden">
    <h1>النتيجة</h1>
    <div id="summary" class="small"></div>
    <div id="tableWrap"></div>
  </div>

<script>
/*
  index.html — requirements aggregator (client-side)
  - يدعم قراءة .json, .yaml/.yml, .md
  - يقوم بتوحيد الحقول: title, description, priority, tags, status, assignee, created_at
  - يدمج التكرارات البسيطة بناءً على تطبيع العنوان (normalize)
  - يتيح تحميل النتائج كـ JSON / CSV / Markdown
*/

// Helpers
function normalizeText(s){
  if(!s) return "";
  s = String(s).trim().toLowerCase();
  // remove punctuation, keep arabic letters and latin/digits
  s = s.replace(/[^\p{L}\p{N}\s]/gu, ""); // unicode letters & numbers
  s = s.replace(/\s+/g, " ");
  return s;
}

function parseMarkdown(content, sourceFile){
  // بسيط: كل heading (#..######) يبدأ عنصر جديد.
  const lines = content.split(/\r?\n/);
  const items = [];
  let curr = null;
  let descBuf = [];
  let metaBuf = {};
  for(let i=0;i<=lines.length;i++){
    const line = lines[i] ?? "";
    const h = line.match(/^(#{1,6})\s+(.*)$/);
    const kv = line.match(/^\s*([A-Za-z0-9_-]+)\s*:\s*(.+)$/);
    if(h){
      if(curr){
        curr.description = descBuf.join("\n").trim();
        Object.assign(curr, metaBuf);
        items.push(curr);
      }
      curr = { title: h[2].trim(), source_file: sourceFile };
      descBuf = [];
      metaBuf = {};
    } else if(kv && curr){
      const key = kv[1].trim().toLowerCase();
      const val = kv[2].trim();
      if(key === "priority") metaBuf.priority = val;
      else if(key === "tags") metaBuf.tags = val.split(",").map(t=>t.trim()).filter(Boolean);
      else if(key === "status") metaBuf.status = val;
      else if(key === "assignee") metaBuf.assignee = val;
      else metaBuf[key] = val;
    } else {
      if(curr) descBuf.push(line);
    }
  }
  if(!items.length && content.trim()){
    items.push({ title: sourceFile, description: content.trim(), source_file: sourceFile });
  }
  return items;
}

function unifyItem(raw, sourceFile){
  const title = raw.title || raw.name || raw.summary || "";
  const desc = raw.description || raw.details || raw.body || "";
  let prio = raw.priority || raw.p || raw.urgency || "medium";
  let tags = raw.tags || raw.labels || [];
  if(typeof tags === "string") tags = tags.split(",").map(t=>t.trim()).filter(Boolean);
  const status = raw.status || "open";
  const assignee = raw.assignee || raw.owner || "";
  let created_at = raw.created_at || raw.date || "";
  // try ISO normalization if possible (naive)
  try {
    if(created_at){
      const d = new Date(created_at);
      if(!isNaN(d)) created_at = d.toISOString();
    }
  } catch(e){}
  return {
    title: String(title).trim(),
    description: String(desc).trim(),
    priority: String(prio).trim(),
    tags: tags,
    status: String(status).trim(),
    assignee: String(assignee).trim(),
    created_at: created_at,
    source_file: sourceFile
  };
}

function mergeRequirements(items){
  const merged = [];
  const indexByNorm = {};
  const order = { "low":1, "medium":2, "high":3, "critical":4 };
  items.forEach(it=>{
    let title = it.title || "";
    if(!title.trim()){
      title = (it.description || "").slice(0,80) || "untitled";
      it.title = title;
    }
    const norm = normalizeText(title);
    if(indexByNorm[norm] !== undefined){
      const base = merged[indexByNorm[norm]];
      // longer description
      if((it.description || "").length > (base.description || "").length){
        base.description = it.description;
      }
      // priority: choose higher
      const curPr = order[(it.priority||"").toLowerCase()] || 0;
      const basePr = order[(base.priority||"").toLowerCase()] || 0;
      if(curPr > basePr) base.priority = it.priority;
      // merge tags
      const s = new Set([...(base.tags||[]), ...(it.tags||[])]);
      base.tags = Array.from(s);
      // status: if any closed/done -> closed
      if(["closed","done","resolved"].includes((it.status||"").toLowerCase()) || ["closed","done","resolved"].includes((base.status||"").toLowerCase())){
        base.status = "closed";
      }
      // sources
      base.sources = Array.from(new Set([...(base.sources||[]), it.source_file]));
      // assignee: keep existing, else new
      if(!base.assignee && it.assignee) base.assignee = it.assignee;
    } else {
      const copy = Object.assign({}, it);
      copy.sources = [it.source_file];
      merged.push(copy);
      indexByNorm[norm] = merged.length - 1;
    }
  });
  return merged;
}

function itemsToCsv(items){
  const keys = ["id","title","description","priority","tags","status","assignee","created_at","sources"];
  const rows = [keys.join(",")];
  items.forEach((it,i)=>{
    const row = [
      i+1,
      `"${(it.title||"").replace(/"/g,'""')}"`,
      `"${(it.description||"").replace(/"/g,'""').replace(/\n/g,' \\n ')}"`,
      `"${(it.priority||"")}"`,
      `"${((it.tags||[]).join(","))}"`,
      `"${(it.status||"")}"`,
      `"${(it.assignee||"")}"`,
      `"${(it.created_at||"")}"`,
      `"${((it.sources||[]).join(","))}"`
    ];
    rows.push(row.join(","));
  });
  return rows.join("\n");
}

function itemsToMarkdown(items){
  const byPrio = {};
  items.forEach(it=>{
    const p = (it.priority||"medium").toLowerCase();
    byPrio[p] = byPrio[p] || [];
    byPrio[p].push(it);
  });
  const lines = [];
  lines.push("# Requirements Report");
  lines.push(`_Generated: ${new Date().toISOString()}_\n`);
  lines.push("## Summary");
  lines.push(`- Total merged requirements: **${items.length}**\n`);
  Object.keys(byPrio).sort().reverse().forEach(p=>{
    lines.push(`- ${p.charAt(0).toUpperCase()+p.slice(1)}: ${byPrio[p].length}`);
  });
  lines.push("\n---\n");
  items.forEach((it,i)=>{
    lines.push(`### ${i+1}. ${it.title}`);
    lines.push(`- **Priority:** ${it.priority}`);
    lines.push(`- **Status:** ${it.status}`);
    if((it.tags||[]).length) lines.push(`- **Tags:** ${(it.tags||[]).join(", ")}`);
    if(it.assignee) lines.push(`- **Assignee:** ${it.assignee}`);
    if(it.sources) lines.push(`- **Sources:** ${it.sources.join(", ")}`);
    if(it.created_at) lines.push(`- **Created at:** ${it.created_at}`);
    lines.push("");
    if(it.description) lines.push(it.description);
    lines.push("\n---\n");
  });
  return lines.join("\n");
}

// UI wiring
const fileInput = document.getElementById("files");
const processBtn = document.getElementById("processBtn");
const clearBtn = document.getElementById("clearBtn");
const downloadJson = document.getElementById("downloadJson");
const downloadCsv = document.getElementById("downloadCsv");
const downloadMd = document.getElementById("downloadMd");
const stats = document.getElementById("stats");
const resultContainer = document.getElementById("resultContainer");
const summary = document.getElementById("summary");
const tableWrap = document.getElementById("tableWrap");

let lastMerged = null;

processBtn.addEventListener("click", async ()=>{
  const files = Array.from(fileInput.files || []);
  if(!files.length){
    alert("عايز ملف واحد على الأقل (JSON / YAML / MD).");
    return;
  }
  stats.innerHTML = "جاري القراءة والمعالجة... رجاءً انتظر لحظة";
  resultContainer.classList.add("hidden");
  tableWrap.innerHTML = "";
  summary.innerHTML = "";

  const rawItems = [];
  for(const f of files){
    try {
      const text = await f.text();
      const name = f.name || "file";
      if(name.endsWith(".json")){
        try {
          const data = JSON.parse(text);
          let arr = [];
          if(Array.isArray(data)) arr = data;
          else if(typeof data === "object" && data !== null){
            if(Array.isArray(data.requirements)) arr = data.requirements;
            else arr = [data];
          }
          arr.forEach(a=>{
            rawItems.push(unifyItem(a, name));
          });
        } catch(e){
          console.warn("JSON parse failed for", name, e);
        }
      } else if(name.endsWith(".yaml") || name.endsWith(".yml")){
        try {
          const doc = jsyaml.load(text);
          let arr = [];
          if(Array.isArray(doc)) arr = doc;
          else if(typeof doc === "object" && doc !== null){
            if(Array.isArray(doc.requirements)) arr = doc.requirements;
            else arr = [doc];
          }
          arr.forEach(a=>{
            rawItems.push(unifyItem(a, name));
          });
        } catch(e){
          console.warn("YAML parse failed for", name, e);
        }
      } else if(name.endsWith(".md") || name.endsWith(".markdown")){
        const parsed = parseMarkdown(text, name);
        parsed.forEach(p=>{
          rawItems.push(unifyItem(p, name));
        });
      } else {
        // try to guess content: JSON fallback
        try {
          const data = JSON.parse(text);
          const arr = Array.isArray(data) ? data : [data];
          arr.forEach(a=> rawItems.push(unifyItem(a, name)));
        } catch(e){
          // treat as markdown
          const parsed = parseMarkdown(text, name);
          parsed.forEach(p=> rawItems.push(unifyItem(p, name)));
        }
      }
    } catch(err){
      console.warn("file read error", f.name, err);
    }
  }

  if(!rawItems.length){
    stats.innerHTML = "لم يتم استخراج أي عناصر من الملفات. تأكد من صيغة الملفات أو محتواها.";
    return;
  }

  stats.innerHTML = `تم استخراج ${rawItems.length} عنصر أولي — جارِ الدمج...`;
  const merged = mergeRequirements(rawItems);
  lastMerged = merged;

  stats.innerHTML = `تم الدمج: ${rawItems.length} → ${merged.length} عناصر فريدة. يمكنك تحميل النتائج أو معاينتها أدناه.`;
  downloadJson.classList.remove("hidden");
  downloadCsv.classList.remove("hidden");
  downloadMd.classList.remove("hidden");
  resultContainer.classList.remove("hidden");

  // show summary
  const prioCount = merged.reduce((acc,it)=>{
    const p = (it.priority||"medium").toLowerCase();
    acc[p] = (acc[p]||0)+1; return acc;
  },{});
  const topTags = {};
  merged.forEach(it => (it.tags||[]).forEach(t => topTags[t] = (topTags[t]||0)+1));
  summary.innerHTML = `
    <div class="small">
      <div><span class="badge">مجمّع</span> العناصر المدموجة: <strong>${merged.length}</strong></div>
      <div style="margin-top:6px">الأولوية حسب العدد: ${Object.entries(prioCount).map(([k,v])=>` ${k}:${v}`).join(" | ")}</div>
      <div style="margin-top:6px">أهم التاجز: ${Object.entries(topTags).sort((a,b)=>b[1]-a[1]).slice(0,8).map(t=>t[0]).join(", ") || "-"}</div>
    </div>
  `;

  // build table
  const table = document.createElement("table");
  const thead = document.createElement("thead");
  thead.innerHTML = "<tr><th>#</th><th>العنوان</th><th>الوصف</th><th>الأولوية</th><th>التاجز</th><th>الحالة</th><th>المصدر</th></tr>";
  table.appendChild(thead);
  const tbody = document.createElement("tbody");
  merged.forEach((it,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td>
      <td>${escapeHtml(it.title)}</td>
      <td><pre style="white-space:pre-wrap;margin:0;padding:0;border:none;background:transparent">${escapeHtml(it.description||"")}</pre></td>
      <td>${escapeHtml(it.priority||"")}</td>
      <td>${(it.tags||[]).map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join(" ")}</td>
      <td>${escapeHtml(it.status||"")}</td>
      <td>${(it.sources||[]).map(s=>escapeHtml(s)).join(", ")}</td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  tableWrap.innerHTML = "";
  tableWrap.appendChild(table);

});

clearBtn.addEventListener("click", ()=>{
  fileInput.value = "";
  stats.innerHTML = "";
  resultContainer.classList.add("hidden");
  tableWrap.innerHTML = "";
  summary.innerHTML = "";
  downloadJson.classList.add("hidden");
  downloadCsv.classList.add("hidden");
  downloadMd.classList.add("hidden");
  lastMerged = null;
});

downloadJson.addEventListener("click", ()=>{
  if(!lastMerged) return alert("لا توجد نتائج للتحميل.");
  const content = JSON.stringify(lastMerged, null, 2);
  downloadBlob(content, "merged_requirements.json", "application/json;charset=utf-8");
});

downloadCsv.addEventListener("click", ()=>{
  if(!lastMerged) return alert("لا توجد نتائج للتحميل.");
  const csv = itemsToCsv(lastMerged);
  downloadBlob(csv, "merged_requirements.csv", "text/csv;charset=utf-8");
});

downloadMd.addEventListener("click", ()=>{
  if(!lastMerged) return alert("لا توجد نتائج للتحميل.");
  const md = itemsToMarkdown(lastMerged);
  downloadBlob(md, "requirements_report.md", "text/markdown;charset=utf-8");
});

// small util
function downloadBlob(content, filename, mime){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function escapeHtml(str){
  return String(str || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

// expose unifyItem for internal use
function unifyItem(raw, sourceFile){ return (window.__unifyItem || (window.__unifyItem = (r,s)=> {
  const title = r.title || r.name || r.summary || "";
  const desc = r.description || r.details || r.body || "";
  let prio = r.priority || r.p || r.urgency || "medium";
  let tags = r.tags || r.labels || [];
  if(typeof tags === "string") tags = tags.split(",").map(t=>t.trim()).filter(Boolean);
  const status = r.status || "open";
  const assignee = r.assignee || r.owner || "";
  let created_at = r.created_at || r.date || "";
  try { if(created_at){ const d = new Date(created_at); if(!isNaN(d)) created_at = d.toISOString(); } } catch(e){}
  return {
    title: String(title).trim(),
    description: String(desc).trim(),
    priority: String(prio).trim(),
    tags: tags,
    status: String(status).trim(),
    assignee: String(assignee).trim(),
    created_at: created_at,
    source_file: s
  };
}))(raw, sourceFile);
}

</script>
</body>
