<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abou Tia Finance Manager</title>
    
    <!-- React & ReactDOM (Core) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel (To allow JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        indigo: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' }
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        /* Custom scrollbar for cleaner look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Safe Storage Wrapper ---
        // Prevents crashes if browser blocks cookies/storage
        const safeStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } 
                catch (e) { return null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } 
                catch (e) { console.warn('Storage blocked'); }
            }
        };

        // --- Icons (Inline SVGs to prevent loading errors) ---
        const Icon = ({ path, className, size = 24 }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {path}
            </svg>
        );

        const Icons = {
            Wallet: (props) => <Icon {...props} path={<><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" /><path d="M3 5v14a2 2 0 0 0 2 2h16v-5" /><path d="M18 12a2 2 0 0 0 0 4h4v-4Z" /></>} />,
            TrendingUp: (props) => <Icon {...props} path={<><polyline points="22 7 13.5 15.5 8.5 10.5 2 17" /><polyline points="16 7 22 7 22 13" /></>} />,
            TrendingDown: (props) => <Icon {...props} path={<><polyline points="22 17 13.5 8.5 8.5 13.5 2 7" /><polyline points="16 17 22 17 22 11" /></>} />,
            Plus: (props) => <Icon {...props} path={<><path d="M5 12h14" /><path d="M12 5v14" /></>} />,
            ArrowRightLeft: (props) => <Icon {...props} path={<><path d="m16 3 4 4-4 4" /><path d="M20 7H4" /><path d="m8 21-4-4 4-4" /><path d="M4 17h16" /></>} />,
            Settings: (props) => <Icon {...props} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></>} />,
            Moon: (props) => <Icon {...props} path={<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />} />,
            Sun: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></>} />,
            Download: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>} />,
            Upload: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>} />,
            Check: (props) => <Icon {...props} path={<polyline points="20 6 9 17 4 12" />} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></>} />,
            X: (props) => <Icon {...props} path={<><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>} />,
            Calendar: (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></>} />,
        };


        // --- Translations ---
        const TRANSLATIONS = {
            en: {
                appTitle: "Abou Tia Finance",
                dashboard: "Dashboard",
                transactions: "Transactions",
                accounts: "Accounts",
                settings: "Settings",
                totalBalance: "Total Balance",
                income: "Income",
                expense: "Expense",
                transfer: "Transfer",
                addTransaction: "Add Transaction",
                recentHistory: "Recent History",
                noTransactions: "No transactions yet.",
                description: "Description",
                amount: "Amount (EGP)",
                category: "Category",
                account: "Account",
                date: "Date",
                save: "Save",
                cancel: "Cancel",
                delete: "Delete",
                edit: "Edit",
                selectAccount: "Select Account",
                selectCategory: "Select Category",
                createCategory: "Create New Category",
                manageCategories: "Manage Categories",
                manageAccounts: "Manage Accounts",
                darkMode: "Dark Mode",
                language: "Language",
                exportData: "Backup Data (Export)",
                importData: "Restore Data (Import)",
                exportDesc: "Download a file to save your data safely.",
                importDesc: "Load a previously saved backup file.",
                recurringBills: "Recurring Bills & Reminders",
                addRecurring: "Add Recurring Bill",
                dueDay: "Due Day (1-31)",
                upcoming: "Upcoming Due",
                paid: "Mark as Paid",
                daysRemaining: "days remaining",
                overdue: "Overdue!",
                dueToday: "Due Today",
                payNow: "Pay Now",
                reminderNote: "Reminders appear 5 days before due date.",
                fromAccount: "From Account",
                toAccount: "To Account",
                initialBalance: "Initial Balance",
                accountName: "Account Name",
                addAccount: "Add Account",
                confirmDelete: "Are you sure you want to delete this?",
                importSuccess: "Data restored successfully!",
                importError: "Invalid file format.",
                transactionAdded: "Transaction added successfully.",
                categories: { uncategorized: "Uncategorized" },
                confirm: "Confirm",
                name: "Name"
            },
            ar: {
                appTitle: "مدير مالية أبو طيعة",
                dashboard: "الرئيسية",
                transactions: "المعاملات",
                accounts: "الحسابات",
                settings: "الإعدادات",
                totalBalance: "إجمالي الرصيد",
                income: "دخل",
                expense: "صرف",
                transfer: "تحويل",
                addTransaction: "إضافة معاملة",
                recentHistory: "أحدث المعاملات",
                noTransactions: "لا توجد معاملات بعد.",
                description: "الوصف",
                amount: "المبلغ (ج.م)",
                category: "الفئة",
                account: "الحساب",
                date: "التاريخ",
                save: "حفظ",
                cancel: "إلغاء",
                delete: "حذف",
                edit: "تعديل",
                selectAccount: "اختر الحساب",
                selectCategory: "اختر الفئة",
                createCategory: "إنشاء فئة جديدة",
                manageCategories: "إدارة الفئات",
                manageAccounts: "إدارة الحسابات",
                darkMode: "الوضع الليلي",
                language: "اللغة",
                exportData: "نسخ احتياطي (تصدير)",
                importData: "استرجاع بيانات (استيراد)",
                exportDesc: "حمل ملف لحفظ بياناتك بأمان.",
                importDesc: "تحميل ملف نسخ احتياطي سابق.",
                recurringBills: "الفواتير المتكررة والتذكيرات",
                addRecurring: "إضافة فاتورة دورية",
                dueDay: "يوم الاستحقاق (1-31)",
                upcoming: "مستحقة الدفع",
                paid: "تم الدفع",
                daysRemaining: "أيام متبقية",
                overdue: "متأخرة!",
                dueToday: "مستحقة اليوم",
                payNow: "ادفع الآن",
                reminderNote: "تظهر التذكيرات قبل الميعاد بـ 5 أيام.",
                fromAccount: "من حساب",
                toAccount: "إلى حساب",
                initialBalance: "الرصيد الافتتاحي",
                accountName: "اسم الحساب",
                addAccount: "إضافة حساب",
                confirmDelete: "هل أنت متأكد من الحذف؟",
                importSuccess: "تم استرجاع البيانات بنجاح!",
                importError: "صيغة الملف غير صحيحة.",
                transactionAdded: "تمت إضافة المعاملة.",
                categories: { uncategorized: "غير مصنف" },
                confirm: "تأكيد",
                name: "الاسم"
            }
        };

        const DEFAULT_ACCOUNTS = [
            { id: '1', name: 'Vodafone Cash', type: 'wallet', initialBalance: 0 },
            { id: '2', name: 'Bank Account', type: 'bank', initialBalance: 0 },
            { id: '3', name: 'Credit Card', type: 'credit', initialBalance: 0 },
            { id: '4', name: 'Cash', type: 'cash', initialBalance: 0 },
        ];

        // --- Main App Component ---
        function App() {
            // State
            const [lang, setLang] = useState('en'); 
            const [theme, setTheme] = useState('light');
            const [view, setView] = useState('dashboard');
            
            const [transactions, setTransactions] = useState([]);
            const [accounts, setAccounts] = useState(DEFAULT_ACCOUNTS);
            const [categories, setCategories] = useState([]);
            const [recurringRules, setRecurringRules] = useState([]); 

            const [showAddModal, setShowAddModal] = useState(false);
            const [showRecurringModal, setShowRecurringModal] = useState(false);
            const [showAccountModal, setShowAccountModal] = useState(false);
            
            const [notification, setNotification] = useState(null); 
            const [confirmDialog, setConfirmDialog] = useState(null); 

            // Load Data (Protected)
            useEffect(() => {
                const savedData = safeStorage.getItem('abouTiaFinanceData_v4');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.transactions) setTransactions(parsed.transactions);
                        if (parsed.accounts) setAccounts(parsed.accounts);
                        if (parsed.categories) setCategories(parsed.categories);
                        if (parsed.recurringRules) setRecurringRules(parsed.recurringRules);
                        if (parsed.settings) {
                            setLang(parsed.settings.lang || 'en');
                            setTheme(parsed.settings.theme || 'light');
                        }
                    } catch (e) { console.error("Data load error", e); }
                }
            }, []);

            // Save Data (Protected)
            useEffect(() => {
                const dataToSave = {
                    transactions, accounts, categories, recurringRules,
                    settings: { lang, theme }
                };
                safeStorage.setItem('abouTiaFinanceData_v4', JSON.stringify(dataToSave));
            }, [transactions, accounts, categories, recurringRules, lang, theme]);

            // Theme Management
            useEffect(() => {
                if (theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [theme]);

            // Notification Timer
            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(null), 3000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            // Helpers
            const t = (key) => TRANSLATIONS[lang][key] || key;
            const isRTL = lang === 'ar';

            const showToast = (message, type = 'success') => {
                setNotification({ message, type });
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat(lang === 'ar' ? 'ar-EG' : 'en-EG', {
                    style: 'currency', currency: 'EGP'
                }).format(amount);
            };

            const getAccountBalance = (accountId) => {
                const account = accounts.find(a => a.id === accountId);
                if (!account) return 0;
                let balance = parseFloat(account.initialBalance);
                transactions.forEach(tx => {
                    if (tx.accountId === accountId) {
                        if (tx.type === 'income') balance += parseFloat(tx.amount);
                        if (tx.type === 'expense') balance -= parseFloat(tx.amount);
                        if (tx.type === 'transfer_out') balance -= parseFloat(tx.amount);
                    }
                    if (tx.toAccountId === accountId && tx.type === 'transfer_in') {
                        balance += parseFloat(tx.amount);
                    }
                });
                return balance;
            };

            const getTotalBalance = () => {
                return accounts.reduce((acc, curr) => acc + getAccountBalance(curr.id), 0);
            };

            // Handlers
            const handleAddTransaction = (formData) => {
                const newTx = {
                    id: Date.now().toString(),
                    date: formData.date,
                    amount: parseFloat(formData.amount),
                    type: formData.type, 
                    description: formData.description,
                    categoryId: formData.categoryId,
                    accountId: formData.accountId,
                    toAccountId: formData.toAccountId || null,
                };

                if (newTx.type === 'transfer') {
                    const txOut = { ...newTx, type: 'transfer_out', id: Date.now().toString() + '_1' };
                    const txIn = { ...newTx, type: 'transfer_in', accountId: null, toAccountId: null, 
                                   accountId: formData.toAccountId, description: `Transfer from ${accounts.find(a=>a.id===formData.accountId)?.name}`, 
                                   id: Date.now().toString() + '_2' };
                    setTransactions([txOut, txIn, ...transactions]);
                } else {
                    setTransactions([newTx, ...transactions]);
                }
                setShowAddModal(false);
                showToast(t('transactionAdded'));
            };

            const handleDeleteTransaction = (id) => {
                setConfirmDialog({
                    message: t('confirmDelete'),
                    onConfirm: () => {
                        setTransactions(transactions.filter(t => t.id !== id));
                        setConfirmDialog(null);
                    }
                });
            };

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                    transactions, accounts, categories, recurringRules, settings: { lang, theme }
                }));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "abou_tia_backup_" + new Date().toISOString().slice(0,10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const handleImport = (event) => {
                const fileReader = new FileReader();
                fileReader.readAsText(event.target.files[0], "UTF-8");
                fileReader.onload = e => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        if (parsed.transactions && parsed.accounts) {
                            setTransactions(parsed.transactions);
                            setAccounts(parsed.accounts);
                            if(parsed.categories) setCategories(parsed.categories);
                            if(parsed.recurringRules) setRecurringRules(parsed.recurringRules);
                            showToast(t('importSuccess'), 'success');
                        } else {
                            showToast(t('importError'), 'error');
                        }
                    } catch (err) {
                        showToast(t('importError'), 'error');
                    }
                };
            };

            // --- Sub-Components ---

            const Toast = () => {
                if (!notification) return null;
                return (
                    <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[60] px-6 py-3 rounded-full shadow-lg flex items-center gap-2 ${
                        notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-emerald-600 text-white'
                    }`}>
                        {notification.type === 'error' ? <Icons.AlertCircle size={18} /> : <Icons.Check size={18} />}
                        <span className="font-medium text-sm">{notification.message}</span>
                    </div>
                );
            };

            const ConfirmModal = () => {
                if (!confirmDialog) return null;
                return (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[70]">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 shadow-xl">
                            <h3 className="text-lg font-bold text-center text-slate-800 dark:text-white mb-4">{t('confirm')}</h3>
                            <p className="text-center text-slate-500 dark:text-slate-400 mb-6">{confirmDialog.message}</p>
                            <div className="flex gap-3">
                                <button onClick={() => setConfirmDialog(null)} className="flex-1 py-2.5 rounded-xl border dark:border-slate-600 text-slate-700 dark:text-slate-200">{t('cancel')}</button>
                                <button onClick={confirmDialog.onConfirm} className="flex-1 py-2.5 rounded-xl bg-red-600 text-white hover:bg-red-700">{t('delete')}</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const AddTransactionModal = () => {
                const [type, setType] = useState('expense');
                const [amount, setAmount] = useState('');
                const [description, setDescription] = useState('');
                const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
                const [accountId, setAccountId] = useState(accounts[0]?.id || '');
                const [toAccountId, setToAccountId] = useState(accounts[1]?.id || '');
                const [categoryId, setCategoryId] = useState('');
                const [newCatName, setNewCatName] = useState('');

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!amount || !accountId) return;
                    let finalCatId = categoryId;
                    if (type !== 'transfer' && !categoryId && newCatName) {
                        const newCat = { id: Date.now().toString(), name: newCatName };
                        setCategories([...categories, newCat]);
                        finalCatId = newCat.id;
                    }
                    handleAddTransaction({ type, amount, description, date, accountId, toAccountId, categoryId: finalCatId });
                };

                return (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md overflow-hidden shadow-xl flex flex-col max-h-[90vh]">
                            <div className="p-4 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                                <h3 className="font-bold text-lg dark:text-white">{t('addTransaction')}</h3>
                                <button onClick={() => setShowAddModal(false)} className="p-1"><Icons.X size={20} className="text-slate-500" /></button>
                            </div>
                            <div className="overflow-y-auto p-4 flex-1">
                                <form id="txForm" onSubmit={handleSubmit} className="space-y-4">
                                    <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                                        {['income', 'expense', 'transfer'].map(tType => (
                                            <button key={tType} type="button" onClick={() => setType(tType)}
                                                className={`flex-1 py-2 text-sm font-medium rounded-lg capitalize ${type === tType ? (tType === 'income' ? 'bg-green-500 text-white' : tType === 'expense' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white') : 'text-slate-600 dark:text-slate-300'}`}>
                                                {t(tType)}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 mb-1">{t('amount')}</label>
                                            <input type="number" step="0.01" value={amount} onChange={e => setAmount(e.target.value)} className="w-full p-3 rounded-xl border dark:bg-slate-700 dark:border-slate-600 dark:text-white" required />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 mb-1">{t('date')}</label>
                                            <input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-3 rounded-xl border dark:bg-slate-700 dark:border-slate-600 dark:text-white" required />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 mb-1">{type === 'transfer' ? t('fromAccount') : t('account')}</label>
                                        <select value={accountId} onChange={e => setAccountId(e.target.value)} className="w-full p-3 rounded-xl border dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                            {accounts.map(acc => <option key={acc.id} value={acc.id}>{acc.name}</option>)}
                                        </select>
                                    </div>
                                    {type === 'transfer' ? (
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 mb-1">{t('toAccount')}</label>
                                            <select value={toAccountId} onChange={e => setToAccountId(e.target.value)} className="w-full p-3 rounded-xl border dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                                {accounts.filter(a => a.id !== accountId).map(acc => <option key={acc.id} value={acc.id}>{acc.name}</option>)}
                                            </select>
                                        </div>
                                    ) : (
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 mb-1">{t('category')}</label>
                                            <select value={categoryId} onChange={e => setCategoryId(e.target.value)} className="w-full p-3 rounded-xl border dark:bg-slate-700 dark:border-slate-600 dark:text-white mb-2">
                                                <option value="">{t('createCategory')}</option>
                                                {categories.map(cat => <option key={cat.id} value={cat.id}>{cat.name}</option>)}
                                            </select>
                                            {!categoryId && <input type="text" value={newCatName} onChange={e => setNewCatName(e.target.value)} className="w-full p-3 rounded-xl border border-dashed dark:bg-slate-700 dark:border-slate-500 dark:text-white" placeholder={t('createCategory') + "..."} />}
                                        </div>
                                    )}
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 mb-1">{t('description')}</label>
                                        <input type="text" value={description} onChange={e => setDescription(e.target.value)} className="w-full p-3 rounded-xl border dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="e.g. Salary" />
                                    </div>
                                    <button type="submit" className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold mt-4 shadow-lg">{t('save')}</button>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            const ReminderCard = () => {
                const reminders = recurringRules.map(rule => {
                    const today = new Date();
                    const currentDay = today.getDate();
                    const dueDay = parseInt(rule.dayOfMonth);
                    const currentMonthStr = `${today.getFullYear()}-${today.getMonth()}`;
                    if (rule.lastPaidMonthString === currentMonthStr) return null;
                    let daysDiff = dueDay - currentDay;
                    if (daysDiff < 0) return { rule, status: 'overdue', days: Math.abs(daysDiff) };
                    if (daysDiff <= 5 && daysDiff >= 0) return { rule, status: 'due_soon', days: daysDiff };
                    return null;
                }).filter(Boolean);
                
                if (reminders.length === 0) return null;

                return (
                    <div className="mb-6 space-y-3">
                        <h3 className="font-bold text-slate-700 dark:text-slate-200 px-1">{t('upcoming')} ({reminders.length})</h3>
                        {reminders.map(({ rule, status, days }) => (
                            <div key={rule.id} className={`flex items-center justify-between p-4 rounded-xl border-l-4 shadow-sm ${status === 'overdue' ? 'bg-red-50 border-red-500 dark:bg-red-900/20' : 'bg-amber-50 border-amber-500 dark:bg-amber-900/20'}`}>
                                <div>
                                    <h4 className="font-bold text-slate-800 dark:text-slate-100">{rule.name}</h4>
                                    <p className="text-sm text-slate-500 dark:text-slate-400">{formatCurrency(rule.amount)} • {status === 'overdue' ? t('overdue') : days === 0 ? t('dueToday') : `${days} ${t('daysRemaining')}`}</p>
                                </div>
                                <button onClick={() => {
                                    const newTx = { id: Date.now().toString(), date: new Date().toISOString().split('T')[0], amount: parseFloat(rule.amount), type: 'expense', description: `Recurring: ${rule.name}`, categoryId: rule.categoryId, accountId: rule.accountId };
                                    setTransactions([newTx, ...transactions]);
                                    setRecurringRules(recurringRules.map(r => r.id === rule.id ? { ...r, lastPaidMonthString: `${new Date().getFullYear()}-${new Date().getMonth()}` } : r));
                                    showToast(t('paid'));
                                }} className="bg-white dark:bg-slate-800 text-slate-900 dark:text-white px-3 py-1.5 text-sm font-medium rounded-lg border dark:border-slate-700">{t('payNow')}</button>
                            </div>
                        ))}
                    </div>
                );
            };

            // --- Render Logic ---

            return (
                <div dir={isRTL ? 'rtl' : 'ltr'} className={`min-h-screen ${theme === 'dark' ? 'dark bg-slate-900' : 'bg-slate-50'} transition-colors duration-300 font-sans pb-24`}>
                    <Toast />
                    <ConfirmModal />
                    {showAddModal && <AddTransactionModal />}

                    {/* Recurring Modal */}
                    {showRecurringModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 space-y-4">
                                <h3 className="font-bold dark:text-white">{t('addRecurring')}</h3>
                                <input id="recName" placeholder="Name" className="w-full p-3 border rounded-xl dark:bg-slate-700 dark:text-white" />
                                <input id="recAmount" type="number" placeholder="Amount" className="w-full p-3 border rounded-xl dark:bg-slate-700 dark:text-white" />
                                <input id="recDay" type="number" placeholder="Day (1-31)" className="w-full p-3 border rounded-xl dark:bg-slate-700 dark:text-white" />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowRecurringModal(false)} className="flex-1 py-2 text-slate-500">{t('cancel')}</button>
                                    <button onClick={() => {
                                        const name = document.getElementById('recName').value;
                                        const amount = document.getElementById('recAmount').value;
                                        const day = document.getElementById('recDay').value;
                                        if(name && amount && day) {
                                            setRecurringRules([...recurringRules, { id: Date.now().toString(), name, amount, dayOfMonth: day, lastPaidMonthString: '', accountId: accounts[0].id }]);
                                            setShowRecurringModal(false);
                                        }
                                    }} className="flex-1 py-2 bg-indigo-600 text-white rounded-lg">{t('save')}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Account Modal */}
                    {showAccountModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 space-y-4">
                                <h3 className="font-bold dark:text-white">{t('addAccount')}</h3>
                                <input id="accName" placeholder={t('accountName')} className="w-full p-3 border rounded-xl dark:bg-slate-700 dark:text-white" />
                                <input id="accBal" type="number" placeholder={t('initialBalance')} className="w-full p-3 border rounded-xl dark:bg-slate-700 dark:text-white" />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowAccountModal(false)} className="flex-1 py-2 text-slate-500">{t('cancel')}</button>
                                    <button onClick={() => {
                                        const name = document.getElementById('accName').value;
                                        const bal = document.getElementById('accBal').value;
                                        if(name) {
                                            setAccounts([...accounts, { id: Date.now().toString(), name, type: 'general', initialBalance: parseFloat(bal||0) }]);
                                            setShowAccountModal(false);
                                        }
                                    }} className="flex-1 py-2 bg-indigo-600 text-white rounded-lg">{t('save')}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <header className="sticky top-0 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 px-4 py-3 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <div className="w-9 h-9 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">A</div>
                            <h1 className="font-bold text-slate-800 dark:text-white hidden sm:block">{t('appTitle')}</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setLang(lang === 'en' ? 'ar' : 'en')} className="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full text-xs font-bold dark:text-white">{lang === 'en' ? 'AR' : 'EN'}</button>
                            <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} className="p-2 dark:text-white">{theme === 'light' ? <Icons.Moon size={20}/> : <Icons.Sun size={20}/>}</button>
                        </div>
                    </header>

                    <main className="max-w-xl mx-auto p-4 md:p-6">
                        
                        {/* Dashboard View */}
                        {view === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="bg-gradient-to-br from-indigo-600 to-indigo-800 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                                    <div className="relative z-10">
                                        <p className="text-indigo-200 text-sm font-medium">{t('totalBalance')}</p>
                                        <h2 className="text-4xl font-bold mt-1">{formatCurrency(getTotalBalance())}</h2>
                                    </div>
                                    <div className="flex gap-4 mt-6 relative z-10">
                                        <div className="flex-1 bg-white/10 rounded-2xl p-3 backdrop-blur-sm">
                                            <div className="flex items-center gap-2 mb-1"><Icons.TrendingUp size={16} className="text-green-300"/><span className="text-xs text-indigo-100">{t('income')}</span></div>
                                            <p className="font-semibold text-lg">{formatCurrency(transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0))}</p>
                                        </div>
                                        <div className="flex-1 bg-white/10 rounded-2xl p-3 backdrop-blur-sm">
                                            <div className="flex items-center gap-2 mb-1"><Icons.TrendingDown size={16} className="text-red-300"/><span className="text-xs text-indigo-100">{t('expense')}</span></div>
                                            <p className="font-semibold text-lg">{formatCurrency(transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0))}</p>
                                        </div>
                                    </div>
                                </div>
                                <ReminderCard />
                                <div className="grid grid-cols-2 gap-3">
                                    {accounts.map(acc => (
                                        <div key={acc.id} className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                            <p className="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase">{acc.name}</p>
                                            <p className="font-bold text-lg text-slate-800 dark:text-white truncate">{formatCurrency(getAccountBalance(acc.id))}</p>
                                        </div>
                                    ))}
                                </div>
                                <div>
                                    <div className="flex justify-between items-center mb-4 px-1">
                                        <h3 className="font-bold text-slate-700 dark:text-slate-200">{t('recentHistory')}</h3>
                                        <button onClick={() => setView('transactions')} className="text-indigo-600 dark:text-indigo-400 text-sm font-bold">See All</button>
                                    </div>
                                    <div className="space-y-3">
                                        {transactions.slice(0, 5).map(tx => (
                                            <div key={tx.id} className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm flex justify-between items-center">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${tx.type === 'income' ? 'bg-green-100 text-green-600' : tx.type === 'expense' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                                                        {tx.type === 'income' ? <Icons.TrendingUp size={18}/> : tx.type === 'expense' ? <Icons.TrendingDown size={18}/> : <Icons.ArrowRightLeft size={18}/>}
                                                    </div>
                                                    <div>
                                                        <p className="font-bold text-slate-800 dark:text-white text-sm">{tx.description}</p>
                                                        <p className="text-xs text-slate-500">{new Date(tx.date).toLocaleDateString()}</p>
                                                    </div>
                                                </div>
                                                <p className={`font-bold ${tx.type === 'income' ? 'text-green-600' : tx.type === 'expense' ? 'text-red-600' : 'text-blue-600'}`}>
                                                    {tx.type === 'expense' || tx.type.includes('out') ? '-' : '+'}{formatCurrency(tx.amount)}
                                                </p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Transactions View */}
                        {view === 'transactions' && (
                            <div className="space-y-4 animate-in fade-in">
                                <h2 className="text-2xl font-bold dark:text-white">{t('transactions')}</h2>
                                {transactions.map(tx => (
                                    <div key={tx.id} className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${tx.type === 'income' ? 'bg-green-100 text-green-600' : tx.type === 'expense' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                                                {tx.type === 'income' ? <Icons.TrendingUp size={18}/> : tx.type === 'expense' ? <Icons.TrendingDown size={18}/> : <Icons.ArrowRightLeft size={18}/>}
                                            </div>
                                            <div>
                                                <p className="font-bold text-slate-800 dark:text-white text-sm">{tx.description}</p>
                                                <p className="text-xs text-slate-500">{new Date(tx.date).toLocaleDateString()} • {accounts.find(a=>a.id===tx.accountId)?.name}</p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className={`font-bold ${tx.type === 'income' ? 'text-green-600' : tx.type === 'expense' ? 'text-red-600' : 'text-blue-600'}`}>
                                                {tx.type === 'expense' || tx.type.includes('out') ? '-' : '+'}{formatCurrency(tx.amount)}
                                            </p>
                                            <button onClick={() => handleDeleteTransaction(tx.id)} className="text-xs text-red-400 mt-1">{t('delete')}</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Accounts View */}
                        {view === 'accounts' && (
                            <div className="space-y-6 animate-in fade-in">
                                <h2 className="text-2xl font-bold dark:text-white">{t('manageAccounts')}</h2>
                                {accounts.map(acc => (
                                    <div key={acc.id} className="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm relative overflow-hidden">
                                        <Icons.Wallet className="absolute top-4 right-4 text-slate-100 dark:text-slate-700 w-24 h-24"/>
                                        <div className="relative z-10">
                                            <p className="text-slate-500 dark:text-slate-400 text-sm font-bold uppercase mb-2">{acc.name}</p>
                                            <h3 className="text-3xl font-bold text-slate-800 dark:text-white mb-2">{formatCurrency(getAccountBalance(acc.id))}</h3>
                                            <p className="text-xs text-slate-400">Initial: {formatCurrency(acc.initialBalance)}</p>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => setShowAccountModal(true)} className="w-full py-4 border-2 border-dashed border-indigo-200 dark:border-slate-600 rounded-3xl text-indigo-500 font-bold flex flex-col items-center justify-center hover:bg-indigo-50 dark:hover:bg-slate-800">
                                    <Icons.Plus size={24} className="mb-2"/> {t('addAccount')}
                                </button>
                            </div>
                        )}

                        {/* Settings View */}
                        {view === 'settings' && (
                            <div className="space-y-6 animate-in fade-in">
                                <h2 className="text-2xl font-bold dark:text-white">{t('settings')}</h2>
                                
                                <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm">
                                    <h3 className="font-bold text-slate-700 dark:text-slate-200 mb-4">{t('manageCategories')}</h3>
                                    <div className="flex flex-wrap gap-2 mb-4">
                                        {categories.map(cat => (
                                            <span key={cat.id} className="bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-sm dark:text-white flex items-center gap-2">
                                                {cat.name} <button onClick={() => setCategories(categories.filter(c => c.id !== cat.id))} className="text-red-400"><Icons.X size={14}/></button>
                                            </span>
                                        ))}
                                    </div>
                                    <input placeholder={t('createCategory')} className="w-full p-2 bg-slate-50 dark:bg-slate-900 rounded-lg text-sm dark:text-white" onKeyDown={(e) => {
                                        if(e.key === 'Enter' && e.target.value) { setCategories([...categories, { id: Date.now().toString(), name: e.target.value }]); e.target.value = ''; }
                                    }}/>
                                </div>

                                <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-slate-700 dark:text-slate-200">{t('recurringBills')}</h3>
                                        <button onClick={() => setShowRecurringModal(true)} className="bg-indigo-100 text-indigo-600 p-1 rounded-full"><Icons.Plus size={18}/></button>
                                    </div>
                                    {recurringRules.map(rule => (
                                        <div key={rule.id} className="flex justify-between items-center text-sm p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl mb-2">
                                            <div><span className="block font-bold dark:text-white">{rule.name}</span><span className="text-xs text-slate-500">{t('dueDay')}: {rule.dayOfMonth}</span></div>
                                            <button onClick={() => setRecurringRules(recurringRules.filter(r => r.id !== rule.id))} className="text-red-400"><Icons.Trash2 size={16}/></button>
                                        </div>
                                    ))}
                                </div>

                                <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm space-y-3">
                                    <button onClick={handleExport} className="w-full p-4 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-2xl font-bold flex items-center justify-center gap-2">
                                        <Icons.Download size={20}/> {t('exportData')}
                                    </button>
                                    <label className="w-full p-4 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-2xl font-bold flex items-center justify-center gap-2 cursor-pointer">
                                        <Icons.Upload size={20}/> {t('importData')}
                                        <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                                    </label>
                                </div>
                            </div>
                        )}

                    </main>

                    {/* Floating Action Button */}
                    <button onClick={() => setShowAddModal(true)} className="fixed bottom-24 right-4 w-16 h-16 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-2xl flex items-center justify-center z-40 transition-transform active:scale-90">
                        <Icons.Plus size={32} />
                    </button>

                    {/* Bottom Nav */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 pb-safe pt-2 px-6 z-40">
                        <div className="flex justify-between items-center max-w-xl mx-auto pb-4">
                            <button onClick={() => setView('dashboard')} className={`flex flex-col items-center gap-1 ${view === 'dashboard' ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400'}`}><Icons.TrendingUp size={24}/><span className="text-[10px] font-bold">{t('dashboard')}</span></button>
                            <button onClick={() => setView('transactions')} className={`flex flex-col items-center gap-1 ${view === 'transactions' ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400'}`}><Icons.ArrowRightLeft size={24}/><span className="text-[10px] font-bold">{t('transactions')}</span></button>
                            <div className="w-8"></div>
                            <button onClick={() => setView('accounts')} className={`flex flex-col items-center gap-1 ${view === 'accounts' ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400'}`}><Icons.Wallet size={24}/><span className="text-[10px] font-bold">{t('accounts')}</span></button>
                            <button onClick={() => setView('settings')} className={`flex flex-col items-center gap-1 ${view === 'settings' ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400'}`}><Icons.Settings size={24}/><span className="text-[10px] font-bold">{t('settings')}</span></button>
                        </div>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


