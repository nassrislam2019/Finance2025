<!doctype html>
<html lang="ar" dir="rtl">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ â€” Ù†Ø³Ø®Ø© Ù…Ø¯Ù…Ø¬Ø©</title>

Â  Â  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">

Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script>
Â  Â  tailwind.config = {
Â  Â  Â  darkMode: 'class',
Â  Â  Â  theme: {
Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  fontFamily: { cairo: ['Cairo','sans-serif'] }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  </script>

Â  <style>
Â  Â  :root{
Â  Â  Â  --bg:#ffffff; --card:#f7f9fc; --muted:#55626b; --txt:#09101a;
Â  Â  Â  --brand:#0b84ff; --danger:#ef4444; --ok:#16a34a; --border:#e6eef6;
Â  Â  Â  --radius:12px; --field-h:44px;
Â  Â  }
Â  Â  .dark{
Â  Â  Â  --bg:#071227; --card:#071a2b; --muted:#9fb7d0; --txt:#e6f2ff;
Â  Â  Â  --brand:#4ea8ff; --danger:#fb6f6f; --ok:#34d399; --border:#123142;
Â  Â  }
Â  Â  body{font-family:'Cairo', sans-serif;background:var(--bg);color:var(--txt)}
Â  Â  .card-custom{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:0;overflow:hidden}
Â  Â  .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
Â  Â  .card-body{padding:14px;border-top:1px solid var(--border)}
Â  Â  .toggle-btn{cursor:pointer}
Â  Â  .badge-custom{display:inline-flex;align-items:center;gap:8px;background:transparent;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:40px;color:var(--muted)}
Â  Â  table.custom{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:13px}
Â  Â  table.custom thead th{font-size:12px;color:var(--muted);font-weight:700;text-align:right;padding:8px}
Â  Â  tr.row-item{background:var(--card);border:1px solid var(--border);border-radius:10px}
Â  Â  .amount.exp{color:var(--danger);font-weight:800}
Â  Â  .amount.inc{color:var(--ok);font-weight:800}

Â  Â  /* Sidebar collapsed */
Â  Â  #sidebar.collapsed { width:64px !important; }
Â  Â  #sidebar.collapsed .nav-btn { text-align:center; padding-left:0; padding-right:0; }
Â  Â  #sidebar.collapsed .nav-btn::before { display:block; }
Â  Â  #sidebar.collapsed .nav-btn span:last-child { display:none; }
Â  Â  #sidebar.collapsed .nav-btn span:first-child { margin-right: 0; }
Â  Â  #sidebar .nav-btn span:first-child { display:inline-block; margin-left:8px; direction:ltr; }
Â  Â  #sidebar { transition: width .18s ease; min-width:64px; max-width:320px; }
Â  Â  /* mobile improvements */
Â  Â  @media (max-width:768px){
Â  Â  Â  #sidebar { position:fixed; left:0; top:0; bottom:0; z-index:40; transform:translateX(0); width:66%; max-width:320px; }
Â  Â  Â  body.sidebar-open main { margin-right:66%; }
Â  Â  Â  .min-h-screen.flex { gap:0; }
Â  Â  }
Â  Â  .dashboard-actions{display:flex;gap:8px;flex-wrap:wrap}
Â  </style>

</head>
<body class="antialiased">

<div class="min-h-screen flex" style="direction:rtl">
Â  Â  <aside class="w-72 bg-white dark:bg-gray-800 shadow-md p-4 flex flex-col" id="sidebar" aria-label="Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ">
Â  Â  <div class="flex items-center gap-3 mb-4">
Â  Â  Â  <div class="text-2xl font-extrabold text-brand">Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</div>
Â  Â  Â  <div class="ml-auto flex items-center gap-2">
Â  Â  Â  Â  <button id="collapseSidebar" class="px-2 py-1 rounded border text-sm" title="Ø·ÙŠ / ÙØªØ­ Ø§Ù„Ø´Ø±ÙŠØ·">â‰¡</button>
Â  Â  Â  Â  <button id="darkToggle" class="px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-sm">Dark</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <nav class="flex-1">
Â  Â  Â  <ul class="space-y-2">
Â  Â  Â  Â  <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="dashboard"><span>ğŸ </span><span>Ù„ÙˆØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span></button></li>
Â  Â  Â  Â  <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="transactions"><span>ğŸ“‹</span><span>Ø§Ù„Ø­Ø±ÙƒØ§Øª</span></button></li>
Â  Â  Â  Â  <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="add"><span>â•</span><span>Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</span></button></li>
Â  Â  Â  Â  <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="accounts"><span>ğŸ¦</span><span>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª / ÙØ¦Ø§Øª</span></button></li>
Â  Â  Â  Â  <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="commitments"><span>ğŸ“†</span><span>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª/Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</span></button></li>
        <li><button class="w-full text-right py-2 px-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 nav-btn" data-page="sync"><span>ğŸ”„</span><span>Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub</span></button></li>
Â  Â  Â  </ul>
Â  Â  </nav>

Â  Â  <div class="mt-4 space-y-2">
Â  Â  Â  <button id="exportJson" class="w-full py-2 rounded border border-gray-200">ØªØµØ¯ÙŠØ± JSON</button>
Â  Â  Â  <button id="importJsonBtn" class="w-full py-2 rounded border border-gray-200">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
Â  Â  Â  <input id="importFile" type="file" accept="application/json" class="hidden" />
Â  Â  Â  <button id="syncNow" class="w-full py-2 rounded border border-gray-200">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†</button>
Â  Â  </div>
Â  </aside>

Â  Â  <main class="flex-1 p-6 overflow-auto" id="mainContent">
Â  Â  Â  Â  <section id="dashboard" class="page-section">
Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
Â  Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  Â  <small class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©</small>
Â  Â  Â  Â  Â  <div id="totalBalance" class="text-2xl font-bold mt-2">0.00</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  Â  <small class="text-sm text-gray-500">Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ù…Ø¨Ø§Ù„Øº ØªØ­Øª Ø§Ù„ØªØ­ØµÙŠÙ„)</small>
Â  Â  Â  Â  Â  <div id="totalCommitThisAndCollections" class="text-xl font-bold mt-2">â€”</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  Â  <small class="text-sm text-gray-500">Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…</small>
Â  Â  Â  Â  Â  <div id="totalCommitNext" class="text-xl font-bold mt-2">0.00</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
Â  Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-2">
Â  Â  Â  Â  Â  Â  <h4 class="font-semibold">Ø¢Ø®Ø± 10 Ø­Ø±ÙƒØ§Øª</h4>
Â  Â  Â  Â  Â  Â  <div class="dashboard-actions">
Â  Â  Â  Â  Â  Â  Â  <button id="dashAddBtn" class="px-3 py-1 border rounded text-sm">Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="latestTx" class="space-y-2"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  Â  <h4 class="font-semibold mb-2">Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ù‚Ø±ÙŠØ¨Ø©</h4>
Â  Â  Â  Â  Â  <div id="dueSoonWrap" class="overflow-auto"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  Â  <h4 class="font-semibold mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨</h4>
Â  Â  Â  Â  Â  <div id="perAccount" class="space-y-2"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="transactions" class="page-section hidden">
Â  Â  Â  <div class="flex items-center justify-between mb-4">
Â  Â  Â  Â  <h2 class="text-xl font-bold">Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
Â  Â  Â  </div>

Â  Â  Â  <div class="card-custom mb-4 p-4">
Â  Â  Â  Â  <div class="flex gap-2 flex-wrap items-center mb-3">
Â  Â  Â  Â  Â  <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØµÙ/Ø§Ù„ÙØ¦Ø©" class="px-3 py-2 border rounded flex-1" />
Â  Â  Â  Â  Â  <select id="fType" class="px-3 py-2 border rounded">
Â  Â  Â  Â  Â  Â  <option value="all">Ø§Ù„ÙƒÙ„</option>
Â  Â  Â  Â  Â  Â  <option value="income">Ø¯Ø®Ù„</option>
Â  Â  Â  Â  Â  Â  <option value="expense">Ù…ØµØ±ÙˆÙ</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  <select id="fAccount" class="px-3 py-2 border rounded"></select>
Â  Â  Â  Â  Â  <input id="fFrom" type="date" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  <input id="fTo" type="date" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  <button id="clearFilters" class="px-3 py-2 border rounded">Ù…Ø³Ø­</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="overflow-auto">
Â  Â  Â  Â  Â  <table class="custom">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="tbody"></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="mt-3 flex items-center justify-center gap-3">
Â  Â  Â  Â  Â  <button id="prevPage" class="px-3 py-2 border rounded">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
Â  Â  Â  Â  Â  <div id="pageInfo" class="text-sm text-gray-500">Ø§Ù„ØµÙØ­Ø© 1</div>
Â  Â  Â  Â  Â  <button id="nextPage" class="px-3 py-2 border rounded">Ø§Ù„ØªØ§Ù„ÙŠ</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="add" class="page-section hidden">
Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  <h3 class="font-semibold mb-2">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø­Ø±ÙƒØ©</h3>
Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="text-sm">Ø§Ù„Ù†ÙˆØ¹</label>
Â  Â  Â  Â  Â  Â  <select id="type" class="px-3 py-2 border rounded">
Â  Â  Â  Â  Â  Â  Â  <option value="income">Ø¯Ø®Ù„</option>
Â  Â  Â  Â  Â  Â  Â  <option value="expense">Ù…ØµØ±ÙˆÙ</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="text-sm">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)</label>
Â  Â  Â  Â  Â  Â  <input id="amount" type="number" step="0.01" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="text-sm">ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
Â  Â  Â  Â  Â  Â  <input id="exec" type="datetime-local" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="text-sm">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
Â  Â  Â  Â  Â  Â  <input id="date" type="date" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="text-sm">Ø§Ù„ÙˆØµÙ</label>
Â  Â  Â  Â  Â  Â  <input id="desc" type="text" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="text-sm">Ø§Ù„Ø­Ø³Ø§Ø¨</label>
Â  Â  Â  Â  Â  Â  <select id="account" class="px-3 py-2 border rounded"></select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="text-sm">Ø§Ù„ÙØ¦Ø©</label>
Â  Â  Â  Â  Â  Â  <select id="category" class="px-3 py-2 border rounded"></select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="text-sm">Ø±Ø¨Ø· Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
Â  Â  Â  Â  Â  Â  <select id="linkCommit" class="px-3 py-2 border rounded"></select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="col-span-3 flex gap-2 mt-2">
Â  Â  Â  Â  Â  Â  <button id="saveTx" class="px-4 py-2 bg-blue-600 text-white rounded">Ø­ÙØ¸</button>
Â  Â  Â  Â  Â  Â  <button id="resetForm" class="px-4 py-2 border rounded">Ø¥ÙØ±Ø§Øº</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="accounts" class="page-section hidden">
Â  Â  Â  <div class="grid md:grid-cols-2 gap-4">
Â  Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  Â  <h3 class="font-semibold mb-2">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
Â  Â  Â  Â  Â  Â  <input id="newAccountName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  Â  <input id="newAccountOpening" type="number" placeholder="Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  Â  <button id="addAccount" class="px-3 py-2 border rounded">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="accountsList" class="mt-3 space-y-2"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  Â  <h3 class="font-semibold mb-2">Ø§Ù„ÙØ¦Ø§Øª</h3>
Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
Â  Â  Â  Â  Â  Â  <input id="newCatName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  Â  <select id="newCatType" class="px-3 py-2 border rounded"><option value="expense">Ù…ØµØ±ÙˆÙ</option><option value="income">Ø¯Ø®Ù„</option></select>
Â  Â  Â  Â  Â  Â  <button id="addCategory" class="px-3 py-2 border rounded">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="catsList" class="mt-3 space-y-2"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="commitments" class="page-section hidden">
Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  Â  <h3 class="font-semibold mb-2">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
Â  Â  Â  Â  Â  Â  <input id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  Â  <input id="cAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  Â  <input id="cFirstDue" type="date" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2"><input id="cRecurring" type="checkbox" /><label>ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠÙ‹Ø§</label></div>
Â  Â  Â  Â  Â  Â  <input id="cEndAt" type="date" class="px-3 py-2 border rounded col-span-2" placeholder="ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ (Ø¹Ù†Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±)" />
Â  Â  Â  Â  Â  Â  <button id="addCommitment" class="px-3 py-2 border rounded">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ«</button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="mt-4 overflow-auto">
Â  Â  Â  Â  Â  Â  <table class="custom">
Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ù…Ø¯ÙÙˆØ¹ (Ø´Ù‡Ø±)</th><th>Ù…ØªØ¨Ù‚ÙŠ</th><th>ØªÙƒØ±Ø§Ø±</th><th>ÙŠÙ†ØªÙ‡ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  <tbody id="tbodyCommit"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card-custom p-4">
Â  Â  Â  Â  Â  <h3 class="font-semibold mb-2">Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</h3>
Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
Â  Â  Â  Â  Â  Â  <input id="coName" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ­ØµÙŠÙ„" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  Â  <input id="coAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  Â  <input id="coFirstDue" type="date" class="px-3 py-2 border rounded" />
Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2"><input id="coRecurring" type="checkbox" /><label>ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠÙ‹Ø§</label></div>
Â  Â  Â  Â  Â  Â  <input id="coEndAt" type="date" class="px-3 py-2 border rounded col-span-2" />
Â  Â  Â  Â  Â  Â  <button id="addCollect" class="px-3 py-2 border rounded">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ«</button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="mt-4 overflow-auto">
Â  Â  Â  Â  Â  Â  <table class="custom">
Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…</th><th>Ø§Ù„ØªÙƒØ±Ø§Ø±</th><th>ÙŠÙ†ØªÙ‡ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  <tbody id="tbodyCollect"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

    <section id="sync" class="page-section hidden">
      <h2 class="text-xl font-bold mb-4">Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub Gist</h2>
      <div class="card-custom p-4">
        <h3 class="font-semibold mb-2">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h3>
        <p class="text-sm text-gray-500 mb-4">
          Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¹Ù„Ù‰ GitHubØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ù†Ø´Ø§Ø¡ 
          <a href="https://github.com/settings/tokens/new?scopes=gist" target="_blank" class="text-brand underline">Personal Access Token (PAT)</a> 
          Ø¨ØµÙ„Ø§Ø­ÙŠØ© `gist`ØŒ ÙˆØ¥Ù†Ø´Ø§Ø¡ Gist Ø³Ø±ÙŠ (Secret Gist) ÙˆÙ†Ø³Ø® Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡.
          <br>
          <strong class="text-red-500">ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­. Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ ÙÙ‚Ø·.</strong>
        </p>
        <div class="space-y-3">
          <div>
            <label class="text-sm">GitHub Personal Access Token (PAT)</label>
            <input id="syncToken" type="password" placeholder="ghp_..." class="px-3 py-2 border rounded w-full" />
          </div>
          <div>
            <label class="text-sm">GitHub Gist ID</label>
            <input id="syncGistId" type="text" placeholder="e.g., 012345abcdef..." class="px-3 py-2 border rounded w-full" />
          </div>
          <button id="saveSyncSettings" class="px-4 py-2 bg-blue-600 text-white rounded">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
      </div>

      <div class="card-custom p-4 mt-4">
        <h3 class="font-semibold mb-2">Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h3>
        <div class="flex gap-4 flex-wrap">
           <button id="syncUpload" class="px-4 py-2 bg-green-600 text-white rounded">â¬†ï¸ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù† (Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ Gist)</button>
           <button id="syncDownload" class="px-4 py-2 bg-red-600 text-white rounded">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù† (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ)</button>
        </div>
        <div id="syncStatus" class="mt-4 text-sm text-gray-500"></div>
      </div>
    </section>
    Â  Â  <div class="mt-6 text-center text-sm text-gray-500">ØªÙ… Ø¯Ù…Ø¬ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© â€” Ø¬Ø±Ù‘Ø¨ Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©ØŒ Ø§Ù„ØªØ²Ø§Ù…ØŒ ØªØ­ØµÙŠÙ„ØŒ Ø£Ùˆ ØªØ­ÙˆÙŠÙ„ØŒ ÙˆØ§Ø¨Ø¹Ø« Ù„ÙŠ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø©.</div>
Â  </main>
</div>

<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
Â  <div class="bg-white dark:bg-gray-800 p-4 rounded w-11/12 md:w-1/2" role="dialog" aria-modal="true">
Â  Â  <h4 id="modalTitle" class="font-semibold mb-2">...</h4>
Â  Â  <div id="modalContent"></div>
Â  Â  <div class="mt-4 text-right">
Â  Â  Â  <button id="modalClose" class="px-3 py-1 border rounded">Ø¥ØºÙ„Ø§Ù‚</button>
Â  Â  </div>
Â  </div>
</div>

<script>
/* ===========================
Â  Â Storage keys & safe load
Â  Â ============================ */
const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1',
Â  Â  Â  COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1', DARK_KEY='pf_dark_v1';
// ADDED
const GH_TOKEN_KEY = 'pf_github_token';
const GH_GIST_ID_KEY = 'pf_github_gist_id';


function safeParse(key, fallback){
Â  try{ const raw = localStorage.getItem(key); if(!raw) return fallback; return JSON.parse(raw); }catch(e){ console.error('Corrupt localStorage',key,e); try{ localStorage.setItem(key+'_backup', localStorage.getItem(key)); }catch{} localStorage.removeItem(key); return fallback; }
}
let ledger = safeParse(KEY, []);
let accounts = safeParse(ACC_KEY, []);
let categories = safeParse(CAT_KEY, []);
let commitments = safeParse(COM_KEY, []);
let collections = safeParse(COL_KEY, []);

/* caching for sorted ledger */
let sortedLedger = [];
let isLedgerDirty = true;
function markLedgerDirty(){ isLedgerDirty = true; }

/* utils */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const eid = ()=> Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const fmt = n => Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const escapeHtml = s=>String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
function formatLocalDate(d){ if(!d) return ''; const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function parseLocalDate(str){ if(!str) return null; const [y,m,d]=str.split('-').map(Number); if(!y) return null; const dt=new Date(y,m-1,d,0,0,0,0); dt.setHours(0,0,0,0); return dt; }
function nowISO(){ return new Date().toISOString(); }
function monthKeyFromDateStr(dateStr){ if(!dateStr) return null; return dateStr.slice(0,7); }
function YM(){ return formatLocalDate(new Date()).slice(0,7); }
function addMonthsPreserveDOM(date,months){ const d=new Date(date.getTime()); const targetMonth=d.getMonth()+months; const day=d.getDate(),y=d.getFullYear(); const temp=new Date(y,targetMonth+1,0); const lastDay=temp.getDate(); d.setMonth(targetMonth,Math.min(day,lastDay)); d.setHours(0,0,0,0); return d; }
function daysBetween(a,b){ const MS=24*60*60*1000; const da=new Date(a.getFullYear(),a.getMonth(),a.getDate()); const db=new Date(b.getFullYear(),b.getMonth(),b.getDate()); return Math.round((db-da)/MS); }
function addMonthsToYm(ym, months){ const parts=(ym||'').split('-').map(Number); const y=parts[0], m=parts[1]; if(!Number.isFinite(y)||!Number.isFinite(m)) return ym; const base=new Date(y,m-1,1); const next=addMonthsPreserveDOM(base, months); return formatLocalDate(next).slice(0,7); }

/* persist helper */
function persist(key,obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){ console.error('persist error',e); } }

/* sorted ledger caching */
function ensureSortedLedger(){
Â  if(!isLedgerDirty && sortedLedger.length) return;
Â  sortedLedger = [...ledger].slice().sort((a,b)=>{
Â  Â  const aKey = (a.exec||a.created||a.date||'');
Â  Â  const bKey = (b.exec||b.created||b.date||'');
Â  Â  if(aKey === bKey) return (a.id||'').localeCompare(b.id||'');
Â  Â  return aKey.localeCompare(bKey);
Â  });
Â  isLedgerDirty = false;
}

/* compute balances - uses sortedLedger ascending to compute after balances */
let cachedBalances = null, cachedAfter = null;
function computeBalances(){
Â  ensureSortedLedger();
Â  const bal = new Map(accounts.map(a=>[a.name, Number(a.opening||0)]));
Â  const after = new Map();
Â  for(const t of sortedLedger){
Â  Â  const cur = bal.get(t.account) ?? 0;
Â  Â  const delta = (t.type==='income' ? Number(t.amount||0) : -Number(t.amount||0));
Â  Â  const next = cur + delta;
Â  Â  bal.set(t.account, next);
Â  Â  after.set(t.id, next);
Â  }
Â  cachedBalances = bal; cachedAfter = after;
Â  return {bal,after};
}

/* Commitment state derived from ledger (single source of truth) */
function getCommitmentState(commit){
Â  if(!commit || !commit.firstDue) return { currentDueYm:null, paid:0, remaining:Number(commit.amount||0) };
Â  const amount = Number(commit.amount||0);
Â  const start = parseLocalDate(commit.firstDue);
Â  if(!start) return { currentDueYm:null, paid:0, remaining:amount };
Â  const endDate = commit.endAt ? parseLocalDate(commit.endAt) : null;
Â  const payMap = new Map();
Â  for(const t of ledger){
Â  Â  if(t.linkCommitId !== commit.id) continue;
Â  Â  const ym = (t.exec||t.created||t.date||'').slice(0,7);
Â  Â  if(!ym) continue;
Â  Â  const arr = payMap.get(ym) || [];
Â  Â  arr.push(t);
Â  Â  payMap.set(ym, arr);
Â  }
Â  let cursor = new Date(start.getTime());
Â  let guard = 0;
Â  while(guard < 500){
Â  Â  const ym = formatLocalDate(cursor).slice(0,7);
Â  Â  if(endDate && cursor > endDate) return { done:true };
Â  Â  const txs = payMap.get(ym) || [];
Â  Â  const paidThisMonth = txs.reduce((s,t)=>s + Number(t.amount||0), 0);
Â  Â  if(paidThisMonth + 1e-9 < amount){
Â  Â  Â  return { currentDueYm: ym, paid: paidThisMonth, remaining: Math.max(0, amount - paidThisMonth) };
Â  Â  } else {
Â  Â  Â  if(!commit.recurring) return { done:true };
Â  Â  Â  const next = addMonthsPreserveDOM(cursor,1);
Â  Â  Â  if(endDate && next > endDate) return { done:true };
Â  Â  Â  cursor = next;
Â  Â  }
Â  Â  guard++;
Â  }
Â  return { done:true };
}

/* Collections: rely on sourceCollectionId */
function collectedCollectionsForYm(ym){
Â  let total=0;
Â  for(const t of ledger){
Â  Â  if(t.type !== 'income') continue;
Â  Â  const when = (t.exec||t.created||t.date||'').slice(0,7);
Â  Â  if(when !== ym) continue;
Â  Â  if(t.sourceCollectionId && String(t.sourceCollectionId).startsWith('collect_')) total += Number(t.amount||0);
Â  }
Â  return total;
}

/* DRAW functions */
function drawPerAccount(){
Â  computeBalances();
Â  const list = [];
Â  for(const a of accounts){
Â  Â  const v = (cachedBalances && cachedBalances.get(a.name)!==undefined) ? cachedBalances.get(a.name) : Number(a.opening||0);
Â  Â  list.push(`<div class="flex justify-between items-center"><div>${escapeHtml(a.name)}</div><div><b>${fmt(v)} Ø¬.Ù…</b></div></div>`);
Â  }
Â  $('#perAccount').innerHTML = list.join('');
}

function drawCommitments(){
Â  const rows = commitments.slice().sort((a,b)=> (a.firstDue||'').localeCompare(b.firstDue||''));
Â  $('#tbodyCommit').innerHTML = rows.map(c=>{
Â  Â  const st = getCommitmentState(c);
Â  Â  const paid = st.paid || 0;
Â  Â  const remaining = st.remaining !== undefined ? st.remaining : Number(c.amount||0);
Â  Â  const due = st.currentDueYm || (c.firstDue? c.firstDue.slice(0,7) : 'â€”');
Â  Â  return `<tr class="row-item" data-id="${c.id}">
Â  Â  Â  <td class="p-2">${escapeHtml(c.name)}</td>
Â  Â  Â  <td class="p-2">${fmt(c.amount)}</td>
Â  Â  Â  <td class="p-2">${escapeHtml(due)}</td>
Â  Â  Â  <td class="p-2">${fmt(paid)}</td>
Â  Â  Â  <td class="p-2"><b>${fmt(remaining)}</b></td>
Â  Â  Â  <td class="p-2">${c.recurring? 'Ø´Ù‡Ø±ÙŠ':'Ù…Ø±Ø©'}</td>
Â  Â  Â  <td class="p-2">${c.endAt||'â€”'}</td>
Â  Â  Â  <td class="p-2">
Â  Â  Â  Â  <button data-action="pay-commit" data-id="${c.id}" class="px-2 py-1 bg-blue-600 text-white rounded">Ø³Ø¯Ø§Ø¯</button>
Â  Â  Â  Â  <button data-action="edit-commit" data-id="${c.id}" class="px-2 py-1 border rounded">ØªØ¹Ø¯ÙŠÙ„</button>
Â  Â  Â  Â  <button data-action="del-commit" data-id="${c.id}" class="px-2 py-1 bg-red-500 text-white rounded">Ø­Ø°Ù</button>
Â  Â  Â  </td>
Â  Â  </tr>`;
Â  }).join('');
}

function drawCollections(){
Â  const rows = collections.slice().sort((a,b)=> (a.nextDue||a.firstDue||'').localeCompare(b.nextDue||b.firstDue||''));
Â  $('#tbodyCollect').innerHTML = rows.map(c=>{
Â  Â  return `<tr class="row-item" data-id="${c.id}">
Â  Â  Â  <td class="p-2">${escapeHtml(c.name)}</td>
Â  Â  Â  <td class="p-2">${fmt(c.amount)}</td>
Â  Â  Â  <td class="p-2">${escapeHtml(c.nextDue||c.firstDue||'â€”')}</td>
Â  Â  Â  <td class="p-2">${c.recurring? 'Ø´Ù‡Ø±ÙŠ':'Ù…Ø±Ø©'}</td>
Â  Â  Â  <td class="p-2">${c.endAt||'â€”'}</td>
Â  Â  Â  <td class="p-2">
Â  Â  Â  Â  <button data-action="collect-now" data-id="${c.id}" class="px-2 py-1 bg-blue-600 text-white rounded">ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„</button>
Â  Â  Â  Â  <button data-action="edit-collect" data-id="${c.id}" class="px-2 py-1 border rounded">ØªØ¹Ø¯ÙŠÙ„</button>
Â  Â  Â  Â  <button data-action="del-collect" data-id="${c.id}" class="px-2 py-1 bg-red-500 text-white rounded">Ø­Ø°Ù</button>
Â  Â  Â  </td>
Â  Â  </tr>`;
Â  }).join('');
}

/* Due soon table (shows upcoming commitments & collections rows) */
function drawDueSoon(){
Â  const today = new Date();
Â  const daysAhead = 30;
Â  const cutoff = new Date(today.getTime() + daysAhead*24*60*60*1000);
Â  const rows = [];

Â  // commitments upcoming due dates (next due month)
Â  for(const c of commitments){
Â  Â  const st = getCommitmentState(c);
Â  Â  if(st.done) continue;
Â  Â  if(!st.currentDueYm) continue;
Â  Â  const due = parseLocalDate(st.currentDueYm+'-01');
Â  Â  if(due >= today && due <= cutoff){
Â  Â  Â  rows.push({ type:'Ø§Ù„ØªØ²Ø§Ù…', id:c.id, name:c.name, amount:c.amount, remaining:st.remaining, due, action:'pay-commit' });
Â  Â  }
Â  }
Â  // collections upcoming
Â  for(const c of collections){
Â  Â  const next = c.nextDue || c.firstDue;
Â  Â  if(!next) continue;
Â  Â  const due = parseLocalDate(next);
Â  Â  if(due >= today && due <= cutoff){
Â  Â  Â  rows.push({ type:'ØªØ­ØµÙŠÙ„', id:c.id, name:c.name, amount:c.amount, remaining:c.amount, due, action:'collect-now' });
Â  Â  }
Â  }

Â  rows.sort((a,b)=> a.due - b.due);

Â  if(rows.length === 0){
Â  Â  $('#dueSoonWrap').innerHTML = `<div class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ù‚Ø±ÙŠØ¨Ø© Ø®Ù„Ø§Ù„ ${daysAhead} ÙŠÙˆÙ….</div>`;
Â  Â  return;
Â  }

Â  const html = `<table class="custom"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>` +
Â  Â  rows.map(r=>`<tr class="row-item">
Â  Â  Â  <td class="p-2">${r.type}</td>
Â  Â  Â  <td class="p-2">${escapeHtml(r.name)}</td>
Â  Â  Â  <td class="p-2">${fmt(r.amount)}</td>
Â  Â  Â  <td class="p-2">${fmt(r.remaining)}</td>
Â  Â  Â  <td class="p-2">${formatLocalDate(r.due)}</td>
Â  Â  Â  <td class="p-2"><button data-action="${r.action}" data-id="${r.id}" class="px-2 py-1 bg-blue-600 text-white rounded">Ù†ÙÙ‘Ø°</button></td>
Â  Â  </tr>`).join('') + `</tbody></table>`;
Â  $('#dueSoonWrap').innerHTML = html;
}

/* Draw accounts/categories lists */
function drawAccountsList(){
Â  $('#accountsList').innerHTML = accounts.map((a,i)=>`<div class="flex items-center gap-2"><div class="badge-custom">${escapeHtml(a.name)} Â· <b>${fmt(a.opening||0)} Ø¬.Ù…</b></div><div class="ml-auto space-x-2"><button data-action="rename-acc" data-i="${i}" class="px-2 py-1 border rounded">ØªØ¹Ø¯ÙŠÙ„</button><button data-action="remove-acc" data-i="${i}" class="px-2 py-1 border rounded">Ø­Ø°Ù</button></div></div>`).join('');
}
function drawCatsList(){
Â  $('#catsList').innerHTML = categories.map((c,i)=>`<div class="flex items-center gap-2"><div class="badge-custom">${escapeHtml(c.name)} Â· ${c.type==='income'?'Ø¯Ø®Ù„':'Ù…ØµØ±ÙˆÙ'}</div><div class="ml-auto space-x-2"><button data-action="rename-cat" data-i="${i}" class="px-2 py-1 border rounded">ØªØ¹Ø¯ÙŠÙ„</button><button data-action="remove-cat" data-i="${i}" class="px-2 py-1 border rounded">Ø­Ø°Ù</button></div></div>`).join('');
}

/* refresh select elements */
function refreshAccountSelects(){
Â  const opts = accounts.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
Â  if($('#account')) $('#account').innerHTML = opts;
Â  if($('#fAccount')) $('#fAccount').innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>` + opts;
}
function refreshCategorySelect(){
Â  const cats = categories.filter(c=>c.type === ($('#type')?$('#type').value:'income'));
Â  if($('#category')) $('#category').innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
}
function refreshLinkCommitOptions(){
Â  if(!$('#linkCommit')) return;
Â  const ym = YM();
Â  const opts = commitments.filter(c=>{
Â  Â  const st = getCommitmentState(c);
Â  Â  return !st.done && st.currentDueYm === ym;
Â  }).map(c=>`<option value="${c.id}">${escapeHtml(c.name)} â€” Ø£ØµÙ„ ${fmt(c.amount)} â€¢ Ù…ØªØ¨Ù‚ÙŠ ${fmt(getCommitmentState(c).remaining)}</option>`).join('');
Â  $('#linkCommit').innerHTML = `<option value="">â€” Ø¨Ø¯ÙˆÙ† â€”</option>` + opts;
}

/* ===========================
Â  Â Transactions rendering + paging
Â  Â ============================ */
let pageSize = 10, currentPage = 1;
function renderTransactions(){
Â  ensureSortedLedger();
Â  const q = ($('#search')?.value||'').toLowerCase();
Â  const ft = $('#fType')?.value || 'all';
Â  const fa = $('#fAccount')?.value || 'all';
Â  const ff = $('#fFrom')?.value || '';
Â  const fto = $('#fTo')?.value || '';

Â  const rows = [...sortedLedger].filter(t=>{
Â  Â  if(q && !((t.desc||'').toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q))) return false;
Â  Â  if(ft !== 'all' && t.type !== ft) return false;
Â  Â  if(fa !== 'all' && t.account !== fa) return false;
Â  Â  if(ff && (t.date||'') < ff) return false;
Â  Â  if(fto && (t.date||'') > fto) return false;
Â  Â  return true;
Â  }).sort((a,b)=>{
Â  Â  const aKey = (a.exec||a.created||a.date||'');
Â  Â  const bKey = (b.exec||b.created||b.date||'');
Â  Â  if(aKey === bKey) return (b.id||'').localeCompare(a.id||'');
Â  Â  return bKey.localeCompare(aKey);
Â  });

Â  const total = rows.length;
Â  const pages = Math.max(1, Math.ceil(total/pageSize));
Â  if(currentPage > pages) currentPage = pages;
Â  const start = (currentPage - 1) * pageSize;
Â  const pageRows = rows.slice(start, start+pageSize);
Â  const after = (cachedAfter || new Map());

Â  $('#tbody').innerHTML = pageRows.map(t=>{
Â  Â  const cls = t.type==='income' ? 'inc' : 'exp';
Â  Â  const afterVal = after.has(t.id) ? after.get(t.id) : 0;
Â  Â  const execTxt = t.exec ? new Date(t.exec).toLocaleString('ar-EG') : (t.created ? new Date(t.created).toLocaleString('ar-EG') : 'â€”');
Â  Â  const dueTxt = t.date || t.due || 'â€”';
Â  Â  const tag = t.isTransfer ? ' <small class="text-gray-500">â†”ï¸ ØªØ­ÙˆÙŠÙ„</small>' : '';
Â  Â  return `<tr class="row-item" data-id="${t.id}">
Â  Â  Â  <td class="p-2">${escapeHtml(execTxt)}</td>
Â  Â  Â  <td class="p-2">${escapeHtml(dueTxt)}</td>
Â  Â  Â  <td class="p-2">${escapeHtml(t.desc||'â€”')}${tag}</td>
Â  Â  Â  <td class="p-2">${escapeHtml(t.category||'â€”')}</td>
Â  Â  Â  <td class="p-2">${escapeHtml(t.account||'â€”')}</td>
Â  Â  Â  <td class="p-2 amount ${cls}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
Â  Â  Â  <td class="p-2">${fmt(afterVal)}</td>
Â  Â  Â  <td class="p-2">
Â  Â  Â  Â  <button data-action="edit-tx" data-id="${t.id}" class="px-2 py-1 border rounded">ØªØ¹Ø¯ÙŠÙ„</button>
Â  Â  Â  Â  <button data-action="del-tx" data-id="${t.id}" class="px-2 py-1 bg-red-500 text-white rounded">Ø­Ø°Ù</button>
Â  Â  Â  </td>
Â  Â  </tr>`;
Â  }).join('');
Â  $('#pageInfo').textContent = `Ø§Ù„ØµÙØ­Ø© ${currentPage} Ù…Ù† ${pages} â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${total}`;
Â  $('#prevPage').disabled = currentPage <= 1;
Â  $('#nextPage').disabled = currentPage >= pages;
}

/* pagination */
$('#prevPage')?.addEventListener('click', ()=>{ if(currentPage>1) currentPage--; renderTransactions(); });
$('#nextPage')?.addEventListener('click', ()=>{ currentPage++; renderTransactions(); });

/* ===========================
Â  Â Add / Edit / Delete Tx
Â  Â ============================ */
let editTxId = null;
$('#saveTx')?.addEventListener('click', ()=>{
Â  const type = $('#type').value;
Â  const amount = parseFloat($('#amount').value || '0');
Â  const execVal = $('#exec').value; // datetime-local string in local
Â  const dateVal = $('#date').value; // due date
Â  const desc = ($('#desc').value||'').trim();
Â  const account = $('#account').value;
Â  const category = $('#category').value;
Â  const linkCommitId = $('#linkCommit').value || '';
Â  if(!account || !category || !amount || amount<=0){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„: Ø­Ø³Ø§Ø¨/ÙØ¦Ø©/Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }
Â  let execISO = null;
Â  if(execVal){
Â  Â  const d = new Date(execVal); execISO = d.toISOString();
Â  }else{ execISO = new Date().toISOString(); }
Â  let dueDate = dateVal || (execISO.slice(0,10));
Â  if(linkCommitId){
Â  Â  const commit = commitments.find(c=>c.id === linkCommitId);
Â  Â  if(commit){
Â  Â  Â  const st = getCommitmentState(commit);
Â  Â  Â  const ym = st.currentDueYm || (commit.firstDue ? commit.firstDue.slice(0,7) : execISO.slice(0,7));
Â  Â  Â  dueDate = ym + '-01';
Â  Â  }
Â  }
Â  const tx = { id: editTxId || eid(), created: new Date().toISOString(), exec: execISO, date: dueDate, due: dueDate, desc, type, amount: Number(amount), account, category };
Â  if(linkCommitId && type==='expense') tx.linkCommitId = linkCommitId;
Â  if(editTxId){
Â  Â  const idx = ledger.findIndex(t=>t.id===editTxId);
Â  Â  if(idx>-1) ledger[idx] = tx;
Â  Â  editTxId = null; $('#saveTx').textContent = 'Ø­ÙØ¸';
Â  } else {
Â  Â  ledger.push(tx);
Â  }
Â  persist(KEY, ledger); markLedgerDirty(); ensureSortedLedger();
Â  $('#desc').value=''; $('#amount').value=''; $('#exec').value=''; $('#date').value=''; $('#linkCommit').value='';
Â  renderTransactions(); drawCommitments(); drawDueSoon(); computeAndUpdateSummary();
});

$('#resetForm')?.addEventListener('click', ()=>{ editTxId=null; $('#saveTx').textContent='Ø­ÙØ¸'; $('#desc').value=''; $('#amount').value=''; $('#exec').value=''; $('#date').value=''; $('#linkCommit').value=''; });

function loadTxIntoForm(id){
Â  const t = ledger.find(x=>x.id===id); if(!t) return;
Â  editTxId = id; $('#saveTx').textContent='ØªØ­Ø¯ÙŠØ«';
Â  $('#type').value = t.type; $('#amount').value = t.amount; $('#desc').value = t.desc||''; $('#account').value = t.account||''; $('#category').value = t.category||'';
Â  if(t.exec) {
Â  Â  const d = new Date(t.exec);
Â  Â  const tzOffset = d.getTimezoneOffset()*60000;
Â  Â  const localISOTime = new Date(d - tzOffset).toISOString().slice(0,16);
Â  Â  $('#exec').value = localISOTime;
Â  } else $('#exec').value = '';
Â  $('#date').value = t.date || t.due || '';
Â  $('#linkCommit').value = t.linkCommitId || '';
Â  gotoPage('add');
Â  window.scrollTo({top:0,behavior:'smooth'});
}

/* ===========================
Â  Â Transfer
Â  Â ============================ */
function ensureTransferCategories(){
Â  const need=[{name:'ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø±',type:'expense'},{name:'ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯',type:'income'},{name:'Ø¹Ù…ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„',type:'expense'}];
Â  let changed=false;
Â  for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } }
Â  if(changed) persist(CAT_KEY, categories);
}

/* ===========================
Â  Â Commitments: add/edit/delete/pay (derived)
Â  Â ============================ */
let editCommitId = null;
$('#addCommitment')?.addEventListener('click', ()=>{
Â  const name = ($('#cName').value||'').trim(); const amount = Number($('#cAmount').value||0); const firstDueStr = $('#cFirstDue').value; const recurring = $('#cRecurring').checked; const endAt = $('#cEndAt').value || null;
Â  if(!name || !amount || !firstDueStr){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… + Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ + ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚'); return; }
Â  if(recurring && !endAt){ alert('Ø¹Ù†Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'); return; }
Â  const firstDue = parseLocalDate(firstDueStr);
Â  let nextDue = new Date(firstDue.getTime());
Â  const today = new Date(); nextDue.setHours(0,0,0,0);
Â  while(nextDue < today){
Â  Â  const tryNext = addMonthsPreserveDOM(nextDue,1);
Â  Â  if(recurring && endAt && tryNext > parseLocalDate(endAt)) break;
Â  Â  nextDue = tryNext;
Â  Â  if(!recurring) break;
Â  }
Â  const commit = { id: editCommitId || eid(), name, amount: Number(amount), firstDue: formatLocalDate(firstDue), recurring, endAt: recurring ? (endAt||null) : null, nextDue: formatLocalDate(nextDue) };
Â  if(editCommitId){
Â  Â  const i = commitments.findIndex(c=>c.id===editCommitId); if(i>-1) commitments[i] = commit; editCommitId = null; $('#addCommitment').textContent = 'Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ«';
Â  } else commitments.push(commit);
Â  persist(COM_KEY, commitments); $('#cName').value=''; $('#cAmount').value=''; $('#cFirstDue').value=''; $('#cRecurring').checked=false; $('#cEndAt').value=''; drawCommitments(); drawDueSoon(); computeAndUpdateSummary();
});

document.addEventListener('click', function(e){
Â  const btn = e.target.closest('button[data-action]');
Â  if(!btn) return;
Â  const action = btn.getAttribute('data-action'), id = btn.getAttribute('data-id');
Â  if(action === 'pay-commit'){ const c = commitments.find(x=>x.id===id); if(!c) return; const st = getCommitmentState(c); if(st.done){ alert('Ù‡Ø°Ø§ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ù…Ø¯ÙÙˆØ¹ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ.'); return; } const remain = st.remaining; const acc = prompt('Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ø³Ø¯Ø§Ø¯:\n' + accounts.map((a,i)=>`${i+1}. ${a.name}`).join('\n')); if(!acc) return; const idx = parseInt(acc,10)-1; if(isNaN(idx) || !accounts[idx]){ alert('Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­'); return; } const accName = accounts[idx].name; if(!confirm(`Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ${fmt(remain)} Ø¬.Ù… Ù…Ù† "${accName}"ØŸ`)) return; const execISO = new Date().toISOString(); const due = st.currentDueYm ? (st.currentDueYm + '-01') : (c.firstDue || execISO.slice(0,10)); ledger.push({ id:eid(), created: new Date().toISOString(), exec: execISO, date: due, due, desc:`${c.name} (Ø³Ø¯Ø§Ø¯ Ø§Ù„ØªØ²Ø§Ù…)`, type:'expense', amount:remain, account:accName, category:'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ©', linkCommitId:c.id }); persist(KEY, ledger); markLedgerDirty(); ensureSortedLedger(); drawCommitments(); drawDueSoon(); renderTransactions(); computeAndUpdateSummary(); }
Â  else if(action === 'del-commit'){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…ØŸ (Ø³ØªØ¨Ù‚Ù‰ Ø£ÙŠ Ø¯ÙØ¹Ø§Øª Ø³ÙØ¬Ù„Øª Ù…Ø­ÙÙˆØ¸Ø©)')) return; commitments = commitments.filter(x=>x.id!==id); persist(COM_KEY, commitments); drawCommitments(); drawDueSoon(); computeAndUpdateSummary(); }
Â  else if(action === 'edit-commit'){ const c = commitments.find(x=>x.id===id); if(!c) return; editCommitId = id; $('#cName').value = c.name; $('#cAmount').value = c.amount; $('#cFirstDue').value = c.firstDue||''; $('#cRecurring').checked = !!c.recurring; $('#cEndAt').value = c.endAt||''; $('#addCommitment').textContent='ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…'; gotoPage('commitments'); window.scrollTo({top:0,behavior:'smooth'}); }
sÂ  else if(action === 'collect-now'){
Â  Â  const c = collections.find(x=>x.id===id); if(!c) return;
Â  Â  const accIndex = prompt('Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„ÙŠÙ‡:\n' + accounts.map((a,i)=>`${i+1}. ${a.name}`).join('\n'));
Â  Â  if(!accIndex) return;
Â  Â  const idx = parseInt(accIndex,10)-1; if(isNaN(idx) || !accounts[idx]){ alert('Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­'); return; }
Â  Â  const accName = accounts[idx].name;
Â  Â  if(!confirm(`ØªØ£ÙƒÙŠØ¯ ØªØ­ØµÙŠÙ„ "${c.name}" Ø¨Ù…Ø¨Ù„Øº ${fmt(c.amount)} Ø¬.Ù… Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ "${accName}"ØŸ`)) return;
Â  Â  const execISO = new Date().toISOString();
Â  Â  const due = c.nextDue || c.firstDue || execISO.slice(0,10);
Â  Â  ledger.push({ id:eid(), created: new Date().toISOString(), exec: execISO, date: due, due, desc:`${c.name} (ØªØ­ØµÙŠÙ„)`, type:'income', amount:c.amount, account:accName, category:'ØªØ­ØµÙŠÙ„Ø§Øª Ø´Ù‡Ø±ÙŠØ©', sourceCollectionId:`collect_${c.id}` });
Â  Â  persist(KEY, ledger); markLedgerDirty(); ensureSortedLedger();
Â  Â  if(c.recurring){
Â  Â  Â  const next = addMonthsPreserveDOM(parseLocalDate(c.nextDue||c.firstDue),1);
Â  Â  Â  if(c.endAt && next > parseLocalDate(c.endAt)) collections = collections.filter(x=>x.id!==id);
Â  Â  Â  else { const ci = collections.find(x=>x.id===id); if(ci) ci.nextDue = formatLocalDate(next); }
Â  Â  } else collections = collections.filter(x=>x.id!==id);
Â  Â  persist(COL_KEY, collections); drawCollections(); renderTransactions(); drawCommitments(); drawDueSoon(); computeAndUpdateSummary();
Â  } else if(action === 'del-collect'){ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ­ØµÙŠÙ„ØŸ')){ collections = collections.filter(x=>x.id!==id); persist(COL_KEY, collections); drawCollections(); computeAndUpdateSummary(); } }
Â  else if(action === 'edit-collect'){ const c = collections.find(x=>x.id===id); if(!c) return; editCollectId = id; $('#coName').value=c.name; $('#coAmount').value=c.amount; $('#coFirstDue').value=c.firstDue||''; $('#coRecurring').checked=!!c.recurring; $('#coEndAt').value=c.endAt||''; $('#addCollect').textContent='ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­ØµÙŠÙ„'; gotoPage('commitments'); window.scrollTo({top:0,behavior:'smooth'}); }
Â  else if(action === 'edit-tx'){ loadTxIntoForm(id); }
Â  else if(action === 'del-tx'){ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')){ ledger = ledger.filter(t=>t.id!==id); persist(KEY, ledger); markLedgerDirty(); ensureSortedLedger(); renderTransactions(); drawCommitments(); drawDueSoon(); computeAndUpdateSummary(); } }
});

/* ===========================
Â  Â Collections: add/edit/del/collect-now
Â  Â ============================ */
let editCollectId = null;
$('#addCollect')?.addEventListener('click', ()=>{
Â  const name = ($('#coName').value||'').trim(); const amount = Number($('#coAmount').value||0); const firstDueStr = $('#coFirstDue').value; const recurring = $('#coRecurring').checked; const endAt = $('#coEndAt').value || null;
Â  if(!name || !amount || !firstDueStr){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… + Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ + ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚'); return; }
Â  if(recurring && !endAt){ alert('Ø¹Ù†Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'); return; }
Â  const firstDue = parseLocalDate(firstDueStr);
Â  let nextDue = new Date(firstDue.getTime());
Â  const today = new Date(); nextDue.setHours(0,0,0,0);
Â  while(nextDue < today){
Â  Â  const tryNext = addMonthsPreserveDOM(nextDue,1);
Â  Â  if(recurring && endAt && tryNext > parseLocalDate(endAt)) break;
Â  Â  nextDue = tryNext;
Â  Â  if(!recurring) break;
Â  }
Â  const item = { id: editCollectId || eid(), name, amount: Number(amount), firstDue: formatLocalDate(firstDue), recurring, endAt: recurring ? (endAt||null) : null, nextDue: formatLocalDate(nextDue) };
Â  if(editCollectId){ const i = collections.findIndex(x=>x.id===editCollectId); if(i>-1) collections[i] = item; editCollectId = null; $('#addCollect').textContent='Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ«'; } else collections.push(item);
Â  persist(COL_KEY, collections); $('#coName').value=''; $('#coAmount').value=''; $('#coFirstDue').value=''; $('#coRecurring').checked=false; $('#coEndAt').value=''; drawCollections(); computeAndUpdateSummary();
});

/* ===========================
Â  Â Summary / recalc
Â  Â ============================ */
function computeAndUpdateSummary(){
Â  ensureSortedLedger(); computeBalances();
Â  let total = 0; for(const v of (cachedBalances || new Map()).values()) total += v;
Â  const ym = YM(); const nextYm = addMonthsToYm(ym,1);
Â  let commitTotalThis = 0, commitRemainThis = 0;
Â  for(const c of commitments){
Â  Â  const st = getCommitmentState(c);
Â  Â  if(!st.done && st.currentDueYm === ym){ commitTotalThis += Number(c.amount||0); commitRemainThis += st.remaining; }
Â  }
Â  let collectionsThis = 0, collectionsRemainThis=0;
Â  for(const c of collections){
Â  Â  if((c.nextDue && c.nextDue.slice(0,7) === ym) || (c.firstDue && c.firstDue.slice(0,7) === ym)) {
Â  Â  Â  collectionsThis += Number(c.amount||0);
Â  Â  Â  // check collected amount this month
Â  Â  Â  const collected = collectedCollectionsForYm(ym);
Â  Â  Â  collectionsRemainThis = Math.max(0, collectionsThis - collected);
Â  Â  }
Â  }
Â  const collectedThis = collectedCollectionsForYm(ym);
Â  const notCollected = Math.max(0, collectionsThis - collectedThis);
Â  // after computing totals, show formatted string for "Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ"
Â  $('#totalBalance').textContent = fmt(total) + ' Ø¬.Ù…';

Â  // show commitments and collections separately in one field
Â  const commitStr = `Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ${fmt(commitTotalThis)} (Ù…ØªØ¨Ù‚ÙŠ ${fmt(commitRemainThis)})`;
Â  const collectStr = `ØªØ­ØµÙŠÙ„Ø§Øª ${fmt(collectionsThis)} (Ù…ØªØ¨Ù‚ÙŠ ${fmt(notCollected)})`;
Â  $('#totalCommitThisAndCollections').innerHTML = `${commitStr} <div class="text-sm text-gray-500 mt-1">${collectStr}</div>`;

Â  // next month: include commitments due next month + collections next month
Â  let nextTotal = 0;
Â  for(const c of commitments){ const st = getCommitmentState(c); if(!st.done && st.currentDueYm === nextYm) nextTotal += st.remaining; }
Â  let nextColl = 0;
Â  for(const c of collections){ if((c.nextDue && c.nextDue.slice(0,7) === nextYm) || (c.firstDue && c.firstDue.slice(0,7) === nextYm)) nextColl += Number(c.amount||0); }
Â  const nextAll = nextTotal + nextColl;
Â  $('#totalCommitNext').textContent = fmt(nextAll) + ' Ø¬.Ù…';

Â  drawPerAccount();
Â  // latest (last 10) - sorted descending by exec/created
Â  $('#latestTx').innerHTML = ledger.slice().sort((a,b)=> (b.exec||b.created||'').localeCompare(a.exec||a.created||'')).slice(0,10).map(t=>{
Â  Â  const when = t.exec ? new Date(t.exec).toLocaleString('ar-EG') : (t.created? new Date(t.created).toLocaleString('ar-EG') : 'â€”');
Â  Â  return `<div class="flex justify-between py-2 border-b items-center">
Â  Â  Â  <div>
Â  Â  Â  Â  <div><b>${escapeHtml(t.desc||'â€”')}</b></div>
Â  Â  Â  Â  <div class="text-xs text-gray-500">${escapeHtml(t.category||'')} Â· ${escapeHtml(t.account||'â€”')}</div>
Â  Â  Â  Â  <div class="text-xs text-gray-500">${escapeHtml(when)}</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="text-right">
Â  Â  Â  Â  <div class="${t.type==='income'?'text-green-600':'text-red-600'} font-bold">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div>
Â  Â  Â  Â  <div class="mt-2 flex gap-1">
Â  Â  Â  Â  Â  <button data-action="edit-tx" data-id="${t.id}" class="px-2 py-1 border rounded text-sm">ØªØ¹Ø¯ÙŠÙ„</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>`;
Â  }).join('');
}

/* ===========================
Â  Â Accounts / Categories add/edit/delete wiring
Â  Â ============================ */
$('#addAccount')?.addEventListener('click', ()=>{ const name = ($('#newAccountName').value||'').trim(); const opening = Number($('#newAccountOpening').value||0); if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'); return; } accounts.push({name, opening: Number(opening||0)}); persist(ACC_KEY, accounts); $('#newAccountName').value=''; $('#newAccountOpening').value=''; drawAccountsList(); refreshAccountSelects(); computeAndUpdateSummary(); });
$('#addCategory')?.addEventListener('click', ()=>{ const name = ($('#newCatName').value||'').trim(); const type = ($('#newCatType').value||'expense'); if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©'); return; } categories.push({name,type}); persist(CAT_KEY, categories); $('#newCatName').value=''; drawCatsList(); refreshCategorySelect(); drawCommitments(); });

document.addEventListener('click', function(e){
Â  const btn = e.target.closest('button[data-action]');
Â  if(btn){
Â  Â  const action = btn.getAttribute('data-action'), i = btn.getAttribute('data-i');
Â  Â  if(action === 'rename-acc'){ const idx = Number(i); const cur = accounts[idx]; const newName = prompt('Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯', cur.name); if(newName){ const openingStr = prompt('Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ', cur.opening||0); const opening = parseFloat(openingStr); const oldName = cur.name; accounts[idx].name = newName.trim(); if(Number.isFinite(opening)) accounts[idx].opening = opening; for(const t of ledger){ if(t.account === oldName) t.account = accounts[idx].name; } persist(KEY, ledger); persist(ACC_KEY, accounts); drawAccountsList(); refreshAccountSelects(); computeAndUpdateSummary(); } }
Â  Â  else if(action === 'remove-acc'){ if(confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ù„Ù† ØªÙØ­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©). Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')){ accounts.splice(Number(i),1); persist(ACC_KEY, accounts); drawAccountsList(); refreshAccountSelects(); computeAndUpdateSummary(); } }
Â  Â  else if(action === 'rename-cat'){ const idx = Number(i); const cur = categories[idx]; const name = prompt('Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©', cur.name); if(!name) return; const type = prompt('Ø§Ù„Ù†ÙˆØ¹ (income/expense)', cur.type); if(type!=='income' && type!=='expense'){ alert('Ù†ÙˆØ¹ ØºÙŠØ± ØµØ­ÙŠØ­'); return; } categories[idx] = {name:name.trim(), type}; persist(CAT_KEY, categories); drawCatsList(); refreshCategorySelect(); }
Â  Â  else if(action === 'remove-cat'){ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©ØŸ')){ categories.splice(Number(i),1); persist(CAT_KEY, categories); drawCatsList(); refreshCategorySelect(); } }
Â  }
});

/* ===========================
Â  Â Export / Import / Sync
Â  Â ============================ */
$('#exportJson')?.addEventListener('click', ()=>{ const data={ ledger, accounts, categories, commitments, collections, exportedAt:new Date().toISOString() }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='my-finance-data.json'; a.click(); URL.revokeObjectURL(a.href); });
$('#importJsonBtn')?.addEventListener('click', ()=>{ $('#importFile').click(); });
$('#importFile')?.addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return; try{ const text = await file.text(); const data = JSON.parse(text); if(Array.isArray(data.ledger)) ledger = data.ledger; if(Array.isArray(data.accounts)) accounts = data.accounts; if(Array.isArray(data.categories)) categories = data.categories; if(Array.isArray(data.commitments)) commitments = data.commitments; if(Array.isArray(data.collections)) collections = data.collections; persist(KEY, ledger); persist(ACC_KEY, accounts); persist(CAT_KEY, categories); persist(COM_KEY, commitments); persist(COL_KEY, collections); markLedgerDirty(); ensureSortedLedger(); drawAccountsList(); drawCatsList(); refreshAccountSelects(); refreshCategorySelect(); drawCommitments(); drawCollections(); drawDueSoon(); renderTransactions(); computeAndUpdateSummary(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­'); }catch(err){ alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: '+(err.message||err)); } e.target.value=''; });

$('#syncNow')?.addEventListener('click', ()=>{ 
    // MODIFIED: Point user to the new sync page
    alert('Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© "Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.');
    gotoPage('sync');
});


/* ===========================
Â  Â GitHub Sync Logic (NEW)
Â  Â ============================ */
const GIST_FILENAME = 'daftari-data.json';

async function syncToGist(direction = 'upload') {
  const token = localStorage.getItem(GH_TOKEN_KEY);
  const gistId = localStorage.getItem(GH_GIST_ID_KEY);
  if (!token || !gistId) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ø§Ù„ØªÙˆÙƒÙ† Ùˆ Gist ID) Ø£ÙˆÙ„Ø§Ù‹.');
    gotoPage('sync');
    return;
  }

  const statusEl = $('#syncStatus');
  const headers = {
    'Authorization': `Bearer ${token}`,
    'Accept': 'application/vnd.github.v3+json',
    'X-GitHub-Api-Version': '2022-11-28'
  };

  if (direction === 'upload') {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù„Ù‰ GitHubØŸ')) return;
    statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
    try {
      const dataToSync = {
        ledger,
        accounts,
        categories,
        commitments,
        collections,
        syncedAt: new Date().toISOString()
      };
      const content = JSON.stringify(dataToSync, null, 2);
      
      const response = await fetch(`https://api.github.com/gists/${gistId}`, {
        method: 'PATCH',
        headers: { ...headers, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          files: {
            [GIST_FILENAME]: {
              content: content
            }
          }
        })
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(`GitHub API Error: ${err.message || response.status}`);
      }
      
      statusEl.textContent = 'âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ ' + new Date().toLocaleTimeString();
    } catch (err) {
      console.error('Sync Upload Error:', err);
      statusEl.textContent = `âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ${err.message}`;
    }
  } 
  
  else if (direction === 'download') {
    if (!confirm('!!! ØªØ­Ø°ÙŠØ± !!!\nØ³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ GitHub. \nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
    statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
    try {
      const response = await fetch(`https://api.github.com/gists/${gistId}`, {
        method: 'GET',
        headers: headers
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(`GitHub API Error: ${err.message || response.status}`);
      }
      
      const gistData = await response.json();
      const file = gistData.files[GIST_FILENAME];
      
      if (!file) {
        throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù '${GIST_FILENAME}' ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù€ Gist.`);
      }
      
      const data = JSON.parse(file.content);
      
      // Restore data
      ledger = data.ledger || [];
      accounts = data.accounts || [];
      categories = data.categories || [];
      commitments = data.commitments || [];
      collections = data.collections || [];

      // Persist all
      persist(KEY, ledger);
      persist(ACC_KEY, accounts);
      persist(CAT_KEY, categories);
      persist(COM_KEY, commitments);
      persist(COL_KEY, collections);

      markLedgerDirty();
      
      // Full UI reload
      init(); // re-run init to redraw everything
      gotoPage('dashboard'); // send user to dashboard
      
      alert('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­. ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
      statusEl.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ ' + new Date().toLocaleTimeString();

    } catch (err) {
      console.error('Sync Download Error:', err);
      statusEl.textContent = `âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${err.message}`;
    }
  }
}

// --- Bind Sync UI (NEW) ---
$('#saveSyncSettings')?.addEventListener('click', () => {
  const token = $('#syncToken').value;
  const gistId = $('#syncGistId').value;
  if (token) localStorage.setItem(GH_TOKEN_KEY, token);
  if (gistId) localStorage.setItem(GH_GIST_ID_KEY, gistId);
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
  $('#syncToken').value = ''; // Clear password field for security
});

$('#syncUpload')?.addEventListener('click', () => syncToGist('upload'));
$('#syncDownload')?.addEventListener('click', () => syncToGist('download'));

// --- Load settings on init (NEW) ---
function loadSyncSettings() {
  // We don't load the token back into the field for security
  // We only load the Gist ID
  $('#syncGistId').value = localStorage.getItem(GH_GIST_ID_KEY) || '';
}


/* ===========================
Â  Â Dark mode & navigation & init
Â  Â ============================ */
function applyDark(){ const saved = localStorage.getItem(DARK_KEY); if(saved === '1'){ document.documentElement.classList.add('dark'); $('#darkToggle').textContent='Light'; } else { document.documentElement.classList.remove('dark'); $('#darkToggle').textContent='Dark'; } }
$('#darkToggle')?.addEventListener('click', ()=>{ const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem(DARK_KEY, isDark ? '1' : '0'); $('#darkToggle').textContent = isDark ? 'Light' : 'Dark'; });

/* sidebar collapse */
$('#collapseSidebar')?.addEventListener('click', ()=>{
Â  const sb = $('#sidebar');
Â  sb.classList.toggle('collapsed');
});

/* mobile open/close (simple) */
function closeSidebarOnMobile(){
Â  if(window.innerWidth <= 768) {
Â  Â  // hide sidebar visually by small transform (optional)
Â  Â  // for now rely on user collapse button
Â  }
}

/* navigation */
$$('.nav-btn').forEach(b=> b.addEventListener('click', (ev)=>{ ev.preventDefault(); const p=b.dataset.page; gotoPage(p); $$('aside .nav-btn').forEach(n=>n.classList.remove('bg-gray-100','dark:bg-gray-700')); b.classList.add('bg-gray-100','dark:bg-gray-700'); }));

function gotoPage(p){
Â  $$('.page-section').forEach(s=> s.classList.add('hidden'));
  // MODIFIED
Â  const map = { dashboard:'#dashboard', transactions:'#transactions', add:'#add', accounts:'#accounts', commitments:'#commitments', sync:'#sync' };
Â  const sel = map[p] || '#dashboard';
Â  document.querySelector(sel)?.classList.remove('hidden');
Â  window.scrollTo({top:0,behavior:'smooth'});
}

/* ensure base data */
function ensureBaseData(){
Â  if(accounts.length === 0){ accounts = [{name:'ÙƒØ§Ø´', opening:0},{name:'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ', opening:0},{name:'Ù…Ø­ÙØ¸Ø©', opening:0}]; persist(ACC_KEY, accounts); }
Â  if(categories.length === 0){ categories = [{name:'Ù…Ø±ØªØ¨',type:'income'},{name:'Ø¯Ø®Ù„ Ø¢Ø®Ø±',type:'income'},{name:'Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨',type:'expense'},{name:'Ù…ÙˆØ§ØµÙ„Ø§Øª',type:'expense'},{name:'ÙÙˆØ§ØªÙŠØ±',type:'expense'},{name:'ØªØ³ÙˆÙ‚',type:'expense'}]; persist(CAT_KEY, categories); }
Â  ensureTransferCategories();
}

/* init */
function init(){
Â  applyDark(); ensureBaseData(); ensureSortedLedger(); drawAccountsList(); drawCatsList(); refreshAccountSelects(); refreshCategorySelect(); refreshLinkCommitOptions();
Â  drawCommitments(); drawCollections(); drawDueSoon(); renderTransactions(); computeAndUpdateSummary();
  loadSyncSettings(); // ADDED
Â  gotoPage('dashboard');
}
init();

/* small UX: filters */
$('#search')?.addEventListener('input', ()=>{ currentPage = 1; renderTransactions(); });
$('#fType')?.addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); refreshCategorySelect(); });
$('#fAccount')?.addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); });
$('#fFrom')?.addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); });
$('#fTo')?.addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); });
$('#clearFilters')?.addEventListener('click', ()=>{ $('#search').value=''; $('#fType').value='all'; $('#fAccount').value='all'; $('#fFrom').value=''; $('#fTo').value=''; currentPage=1; renderTransactions(); });

/* refresh link commit options when type changes or commitments change */
$('#type')?.addEventListener('change', ()=>{ refreshCategorySelect(); refreshLinkCommitOptions(); });
document.addEventListener('click', ()=>{ refreshLinkCommitOptions(); });

/* Dashboard add button */
$('#dashAddBtn')?.addEventListener('click', ()=>{ gotoPage('add'); });

/* Small UI: open add from dashboard shortcut */
$('#dashAddBtn')?.addEventListener('click', ()=>{ gotoPage('add'); });

/* small error logging */
window.addEventListener('error', e => { console.error('Runtime error:', e.message, e.filename+':'+e.lineno); });

</script>
</body>
</html>
