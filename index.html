<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساباتي</title>
<meta name="theme-color" content="#0b1220" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
/* CSS styles are assumed complete and correct from the original file */
:root{
  --bg:#0b1220;
  --card:#0f172a;
  --muted:#94a3b8;
  --txt:#e5e7eb;
  --brand:#0369a1;
  --brand-2:#0ea5e9;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#22c55e;
  --border:#1f2a44;
  --radius:12px;
  --field-h:42px;
  --shadow:0 8px 24px rgba(2, 6, 23, 0.4);
}
*{
  box-sizing:border-box;
}
html,body{
  margin:0;
  padding:0;
  background-color:var(--bg);
  color:var(--txt);
  font-family:'Cairo', sans-serif;
  font-size:16px;
  line-height:1.6;
}
header{
  background-color:var(--card);
  padding:1rem;
  box-shadow:var(--shadow);
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:1rem;
}
header h1{
  margin:0;
  font-size:1.5rem;
  color:var(--brand-2);
}
main{
  padding:0 1rem 1rem;
  max-width:1200px;
  margin:0 auto;
}
.card{
  background-color:var(--card);
  padding:1rem;
  border-radius:var(--radius);
  margin-bottom:1rem;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}
.card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  padding-bottom:0.5rem;
  margin-bottom:0.5rem;
  border-bottom:1px solid var(--border);
}
.card-header h2{
  margin:0;
  font-size:1.25rem;
  color:var(--brand-2);
}
.content{
  display:block;
  padding-top:0.5rem;
}
.content.hidden{
  display:none;
}
.grid{
  display:grid;
  gap:1rem;
}
@media (min-width: 768px) {
  .grid-2{
    grid-template-columns:1fr 1fr;
  }
  .grid-3{
    grid-template-columns:1fr 1fr 1fr;
  }
}
form{
  display:flex;
  flex-direction:column;
  gap:1rem;
}
.form-group{
  display:flex;
  flex-direction:column;
  gap:0.25rem;
}
label{
  color:var(--muted);
  font-size:0.9rem;
}
input[type="text"], input[type="number"], input[type="date"], input[type="month"], select, textarea{
  background-color:var(--bg);
  color:var(--txt);
  border:1px solid var(--border);
  padding:0 0.75rem;
  height:var(--field-h);
  border-radius:var(--radius);
  font-size:1rem;
  transition:border-color 0.2s;
  font-family:'Cairo', sans-serif;
}
textarea{
  height:auto;
  min-height:80px;
  padding:0.75rem;
}
input:focus, select:focus, textarea:focus{
  border-color:var(--brand-2);
  outline:none;
}
.btn{
  background-color:var(--brand);
  color:white;
  border:none;
  padding:0.75rem 1rem;
  border-radius:var(--radius);
  cursor:pointer;
  font-size:1rem;
  transition:background-color 0.2s;
  height:var(--field-h);
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:'Cairo', sans-serif;
}
.btn:hover{
  background-color:var(--brand-2);
}
.btn-danger{
  background-color:var(--danger);
}
.btn-danger:hover{
  background-color:#c81919;
}
.btn-warn{
  background-color:var(--warn);
}
.btn-warn:hover{
  background-color:#d4900a;
}
.btn-ok{
  background-color:var(--ok);
}
.btn-ok:hover{
  background-color:#1e9c4c;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:1rem;
  font-size:0.95rem;
}
th,td{
  padding:0.75rem;
  text-align:right;
  border-bottom:1px solid var(--border);
}
th{
  background-color:var(--bg);
  color:var(--brand-2);
  font-weight:bold;
  position:sticky;
  top:0;
}
tr:hover{
  background-color:rgba(255, 255, 255, 0.05);
}
.text-danger{
  color:var(--danger);
}
.text-ok{
  color:var(--ok);
}
.text-warn{
  color:var(--warn);
}
.badge{
  display:inline-block;
  padding:0.25rem 0.5rem;
  border-radius:9999px;
  font-size:0.8rem;
  margin-left:0.5rem;
}
.badge-danger{
  background-color:rgba(239, 68, 68, 0.2);
  color:var(--danger);
}
.badge-ok{
  background-color:rgba(34, 197, 94, 0.2);
  color:var(--ok);
}
.badge-warn{
  background-color:rgba(245, 158, 11, 0.2);
  color:var(--warn);
}
.nav{
  display:flex;
  border-bottom:2px solid var(--border);
  margin-bottom:1rem;
}
.nav-btn{
  padding:0.75rem 1.25rem;
  cursor:pointer;
  transition:background-color 0.2s, color 0.2s;
  color:var(--muted);
  border-bottom:2px solid transparent;
}
.nav-btn:hover{
  color:var(--txt);
}
.nav-btn.active{
  color:var(--brand-2);
  border-bottom-color:var(--brand-2);
  font-weight:bold;
}
.tab-content{
  display:none;
}
.tab-content.active{
  display:block;
}
.summary-box{
  background-color:var(--card);
  padding:1rem;
  border-radius:var(--radius);
  text-align:center;
  border:1px solid var(--border);
}
.summary-box h3{
  margin-top:0;
  font-size:1rem;
  color:var(--muted);
}
.summary-box p{
  margin-bottom:0;
  font-size:1.5rem;
  font-weight:bold;
}
.summary-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
  gap:1rem;
  margin-bottom:1rem;
}
ul{
  list-style:none;
  padding:0;
}
ul li{
  padding:0.5rem 0;
  border-bottom:1px solid var(--border);
}
ul li:last-child{
  border-bottom:none;
}
.actions button{
  margin-left:0.5rem;
}
.search-controls{
  display:flex;
  gap:1rem;
  align-items:center;
  margin-bottom:1rem;
}
.search-controls input[type="month"]{
  flex-grow:1;
}
.search-controls button{
  width:auto;
}
.collapsible-icon{
  transition:transform 0.3s;
}
.card.collapsed .collapsible-icon{
  transform:rotate(180deg);
}
.toggle-switch{
  position:relative;
  display:inline-block;
  width:50px;
  height:24px;
}
.toggle-switch input{
  opacity:0;
  width:0;
  height:0;
}
.slider{
  position:absolute;
  cursor:pointer;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background-color:var(--muted);
  transition:0.4s;
  border-radius:24px;
}
.slider:before{
  position:absolute;
  content:"";
  height:16px;
  width:16px;
  left:4px;
  bottom:4px;
  background-color:white;
  transition:0.4s;
  border-radius:50%;
}
input:checked + .slider{
  background-color:var(--brand-2);
}
input:checked + .slider:before{
  transform:translateX(26px);
}
.inline-toggle{
  display:flex;
  align-items:center;
  gap:1rem;
}
.no-data{
  text-align:center;
  color:var(--muted);
  padding:2rem 0;
}
</style>
</head>
<body>

<header>
  <h1>دفتر حساباتي</h1>
  <button id="btnSettings" class="btn">الإعدادات</button>
</header>

<main>
  
  <div id="tabsContainer">
    <div class="nav">
      <div class="nav-btn active" data-tab="home">الرئيسية</div>
      <div class="nav-btn" data-tab="transactions">الحركات</div>
      <div class="nav-btn" data-tab="reports">التقارير</div>
      <div class="nav-btn" data-tab="commitments">الالتزامات</div>
      <div class="nav-btn" data-tab="collections">التجميعات</div>
    </div>

    <div id="tab-home" class="tab-content active">
      <div class="summary-grid">
        <div class="summary-box">
          <h3>الرصيد الكلي</h3>
          <p id="totalBalance"></p>
        </div>
        <div class="summary-box">
          <h3>إجمالي الدخل (الشهر)</h3>
          <p id="monthlyIncome" class="text-ok"></p>
        </div>
        <div class="summary-box">
          <h3>إجمالي المصروفات (الشهر)</h3>
          <p id="monthlyExpense" class="text-danger"></p>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card" id="cardDueSoon">
          <div class="card-header">
            <h2>المستحقات القادمة <span class="badge badge-warn" id="dueSoonCount">0</span></h2>
            <span class="collapsible-icon">▼</span>
          </div>
          <div class="content">
            <ul id="dueSoonList">
              <li class="no-data">لا توجد مستحقات قريباً.</li>
            </ul>
          </div>
        </div>

        <div class="card" id="cardAccountsList">
          <div class="card-header">
            <h2>الأرصدة الحالية</h2>
            <span class="collapsible-icon">▼</span>
          </div>
          <div class="content">
            <ul id="accountsList">
              </ul>
            <div class="actions" style="margin-top:1rem; text-align:left;">
              <button id="btnOpenAccountForm" class="btn">إدارة الحسابات</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-transactions" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>إضافة حركة جديدة</h2>
          <span class="collapsible-icon">▼</span>
        </div>
        <div class="content" id="transactionFormContent">
          <form id="transactionForm">
            <div class="grid grid-3">
              <div class="form-group">
                <label for="type">النوع</label>
                <select id="type" required>
                  <option value="دخل">دخل</option>
                  <option value="مصروف">مصروف</option>
                  <option value="تحويل">تحويل</option>
                </select>
              </div>
              <div class="form-group" id="categoryGroup">
                <label for="category">التصنيف</label>
                <select id="category" required>
                  </select>
              </div>
              <div class="form-group">
                <label for="amount">المبلغ</label>
                <input type="number" id="amount" required min="0.01" step="0.01">
              </div>
            </div>
            <div class="grid grid-2">
              <div class="form-group">
                <label for="accountFrom">الحساب (المصدر)</label>
                <select id="accountFrom" required>
                  </select>
              </div>
              <div class="form-group" id="accountToGroup" style="display:none;">
                <label for="accountTo">الحساب (الوجهة)</label>
                <select id="accountTo">
                  </select>
              </div>
            </div>
            <div class="form-group">
              <label for="date">التاريخ</label>
              <input type="date" id="date" required>
            </div>
            <div class="form-group">
              <label for="notes">ملاحظات</label>
              <textarea id="notes"></textarea>
            </div>
            <button type="submit" class="btn">حفظ الحركة</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>سجل الحركات</h2>
          <span class="collapsible-icon">▼</span>
        </div>
        <div class="content">
          <div class="search-controls">
            <input type="month" id="monthPicker">
            <select id="filterAccount">
              <option value="">جميع الحسابات</option>
              </select>
            <button id="btnApplyFilter" class="btn">تطبيق</button>
          </div>
          <div style="overflow-x:auto;">
            <table id="transactionsTable">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>النوع</th>
                  <th>التصنيف</th>
                  <th>الحساب</th>
                  <th>المبلغ</th>
                  <th>ملاحظات</th>
                  <th>الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                <tr class="no-data-row" style="display:none;"><td colspan="7" class="no-data">لا توجد حركات مسجلة في هذا الشهر.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-reports" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>توزيع المصروفات والدخل الشهري</h2>
        </div>
        <div class="content">
          <div class="search-controls">
            <input type="month" id="reportMonthPicker">
            <button id="btnGenerateReport" class="btn">عرض التقرير</button>
          </div>
          <div class="grid grid-2">
            <div>
              <canvas id="chartMonthly"></canvas>
            </div>
            <div>
              <h3>إحصائيات الشهر</h3>
              <ul id="reportStatsList">
                </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2>ملخص التصنيفات (الأعلى مصروفاً)</h2>
        </div>
        <div class="content">
          <ul id="categorySummaryList">
            </ul>
        </div>
      </div>
    </div>

    <div id="tab-commitments" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>إضافة التزام شهري جديد (دفعات صادرة)</h2>
          <span class="collapsible-icon">▼</span>
        </div>
        <div class="content">
          <form id="commitmentForm">
            <div class="form-group">
              <label for="cName">اسم الالتزام</label>
              <input type="text" id="cName" required>
            </div>
            <div class="form-group inline-toggle">
              <label for="cRecurring">متكرر شهرياً</label>
              <label class="toggle-switch">
                <input type="checkbox" id="cRecurring">
                <span class="slider"></span>
              </label>
            </div>
            <div class="grid grid-3">
              <div class="form-group">
                <label for="cAmount">المبلغ</label>
                <input type="number" id="cAmount" required min="0.01" step="0.01">
              </div>
              <div class="form-group">
                <label for="cFirstDue">تاريخ الاستحقاق الأول</label>
                <input type="date" id="cFirstDue" required>
              </div>
              <div class="form-group" id="cEndAtGroup" style="display:none;">
                <label for="cEndAt">تاريخ الانتهاء (اختياري)</label>
                <input type="date" id="cEndAt">
              </div>
            </div>
            <div class="form-group">
              <label for="cNotes">ملاحظات</label>
              <textarea id="cNotes"></textarea>
            </div>
            <button type="submit" class="btn">حفظ الالتزام</button>
          </form>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>قائمة الالتزامات الشهرية</h2>
          <span class="collapsible-icon">▼</span>
        </div>
        <div class="content">
          <ul id="commitmentsList">
            <li class="no-data">لا توجد التزامات شهرية مسجلة.</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="tab-collections" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>إضافة تجميع/اقتطاع شهري جديد (دفعات واردة)</h2>
          <span class="collapsible-icon">▼</span>
        </div>
        <div class="content">
          <form id="collectionForm">
            <div class="form-group">
              <label for="coName">اسم التجميع</label>
              <input type="text" id="coName" required>
            </div>
            <div class="form-group inline-toggle">
              <label for="coRecurring">متكرر شهرياً</label>
              <label class="toggle-switch">
                <input type="checkbox" id="coRecurring">
                <span class="slider"></span>
              </label>
            </div>
            <div class="grid grid-3">
              <div class="form-group">
                <label for="coAmount">المبلغ</label>
                <input type="number" id="coAmount" required min="0.01" step="0.01">
              </div>
              <div class="form-group">
                <label for="coFirstDue">تاريخ الاستحقاق الأول</label>
                <input type="date" id="coFirstDue" required>
              </div>
              <div class="form-group" id="coEndAtGroup" style="display:none;">
                <label for="coEndAt">تاريخ الانتهاء (اختياري)</label>
                <input type="date" id="coEndAt">
              </div>
            </div>
            <div class="form-group">
              <label for="coNotes">ملاحظات</label>
              <textarea id="coNotes"></textarea>
            </div>
            <button type="submit" class="btn">حفظ التجميع</button>
          </form>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>قائمة التجميعات الشهرية</h2>
          <span class="collapsible-icon">▼</span>
        </div>
        <div class="content">
          <ul id="collectionsList">
            <li class="no-data">لا توجد تجميعات شهرية مسجلة.</li>
          </ul>
        </div>
      </div>
    </div>

  </div>

  <div id="accountModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100;">
    <div class="card" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:500px;">
      <div class="card-header">
        <h2>إدارة الحسابات</h2>
        <button id="closeAccountModal" class="btn btn-danger" style="height:30px; padding:0 0.5rem;">X</button>
      </div>
      <div class="content">
        <form id="accountForm">
          <div class="form-group">
            <label for="accountName">اسم الحساب</label>
            <input type="text" id="accountName" required>
          </div>
          <div class="form-group">
            <label for="accountOpening">رصيد الافتتاح</label>
            <input type="number" id="accountOpening" required min="0" step="0.01" value="0">
          </div>
          <button type="submit" class="btn">إضافة/تحديث حساب</button>
        </form>
        <h3 style="margin-top:1rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem; color:var(--muted);">الحسابات الحالية</h3>
        <ul id="manageAccountsList">
          </ul>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100;">
    <div class="card" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:500px;">
      <div class="card-header">
        <h2>الإعدادات والمزامنة</h2>
        <button id="closeSettingsModal" class="btn btn-danger" style="height:30px; padding:0 0.5rem;">X</button>
      </div>
      <div class="content">
        <h3>مزامنة GitHub Gist</h3>
        <p style="font-size:0.85rem; color:var(--muted);">لحفظ بياناتك بشكل آمن عبر GitHub Gist.</p>
        <form id="ghSyncForm">
          <div class="form-group">
            <label for="ghToken">رمز الوصول الشخصي (Token)</label>
            <input type="text" id="ghToken" placeholder="ghp_..." required>
          </div>
          <div class="form-group">
            <label for="ghGistId">معرف Gist (ID)</label>
            <input type="text" id="ghGistId" placeholder="ex: 123abc456def..." required>
          </div>
          <div class="grid grid-2">
            <button type="submit" id="btnSaveGhSettings" class="btn">حفظ الإعدادات</button>
            <button type="button" id="btnGhPush" class="btn btn-ok">مزامنة الآن</button>
          </div>
        </form>

        <h3 style="margin-top:1.5rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem; color:var(--muted);">أدوات متقدمة</h3>
        <button id="btnExportData" class="btn btn-warn">تصدير البيانات (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;">
        <button id="btnImportData" class="btn" style="margin-top:1rem;">استيراد البيانات (JSON)</button>
        <button id="btnClearData" class="btn btn-danger" style="margin-top:1rem;">مسح جميع البيانات</button>
      </div>
    </div>
  </div>

</main>

<script>
// ======================================================================
// الدوال المساعدة المفقودة (تمت إضافتها)
// ======================================================================

// 1. تصحيح الخطأ النحوي في دالة escapeHtml
const escapeHtml=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);

// 2. دوال مساعدة لإدارة التواريخ
const YM = (d=new Date())=>{
  const year=d.getFullYear();
  const month=String(d.getMonth()+1).padStart(2, '0');
  return `${year}-${month}`;
};
const startOfToday = () => {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  return d;
};
const parseLocalDate = (s) => {
  if (!s) return null;
  // يفترض أن s هو في صيغة 'YYYY-MM-DD'
  const parts = s.split('-').map(p => parseInt(p, 10));
  // الشهر في دالة Date هو 0-indexed
  return new Date(parts[0], parts[1] - 1, parts[2]);
};
const formatLocalDate = (d) => {
  if (!d) return '';
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};
const addMonthsPreserveDOM = (dateStr, months) => {
  if (!dateStr) return '';
  const d = parseLocalDate(dateStr);
  if (!d) return dateStr;
  const dayOfMonth = d.getDate();
  d.setMonth(d.getMonth() + months);

  // إذا كان اليوم الجديد غير موجود (مثل 31 يناير + شهر = 3 مارس)، يتم تعيينه إلى آخر يوم في الشهر
  if (d.getDate() !== dayOfMonth) {
      d.setDate(0); // يضبط التاريخ إلى آخر يوم في الشهر السابق (الذي هو الشهر الصحيح)
  }
  return formatLocalDate(d);
};
const daysBetween = (s1, s2) => {
  const d1 = parseLocalDate(s1);
  const d2 = parseLocalDate(s2);
  if (!d1 || !d2) return 0;
  const diffTime = Math.abs(d2.getTime() - d1.getTime());
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
};

// 3. دوال الترحيل (Migration) - تنفيذ أساسي
const migrateCommit=(c)=>c;
const migrateCollect=(c)=>c;

// 4. دوال تحديث واجهة المستخدم (Drawing/Rendering) - تنفيذ أساسي لمنع الأخطاء في init()
function drawAccountsList(){
    // يجب استبدال هذا بمنطق تحديث قائمة الحسابات الفعلية بناءً على transactions
    if(!els.accountsList) return;
    els.accountsList.innerHTML = accounts.map(a=>`<li>${escapeHtml(a.name)}: ${formatCurrency(calculateAccountBalance(a.name))}</li>`).join('');
}
function drawCommitments(){
    // يجب استبدال هذا بمنطق تحديث قائمة الالتزامات الفعلية
    if(!els.commitmentsList) return;
    els.commitmentsList.innerHTML = commitments.length ? commitments.map(c=>`<li>${escapeHtml(c.name)} - ${formatCurrency(c.amount)}</li>`).join('') : '<li class="no-data">لا توجد التزامات شهرية مسجلة.</li>';
}
function drawCollections(){
    // يجب استبدال هذا بمنطق تحديث قائمة التجميعات الفعلية
    if(!els.collectionsList) return;
    els.collectionsList.innerHTML = collections.length ? collections.map(c=>`<li>${escapeHtml(c.name)} - ${formatCurrency(c.amount)}</li>`).join('') : '<li class="no-data">لا توجد تجميعات شهرية مسجلة.</li>';
}
function drawDueSoon(){
    // يجب استبدال هذا بمنطق تحديث قائمة المستحقات القادمة
    if(!els.dueSoonList) return;
    els.dueSoonList.innerHTML = '<li class="no-data">لا توجد مستحقات قريباً.</li>';
    els.dueSoonCount.textContent = '0';
}
function drawMonthly(){
    // منطق رسم المخطط الشهري باستخدام Chart.js
    console.log('Drawing monthly chart...');
    if(window.myChart) window.myChart.destroy();
    const ctx = document.getElementById('chartMonthly').getContext('2d');
    
    // بيانات وهمية بسيطة للعرض
    const data = {
        labels: ['دخل', 'مصروف'],
        datasets: [{
            label: 'إجمالي المبلغ',
            data: [
                transactions.filter(t=>t.type==='دخل').reduce((acc, t)=>acc+t.amount, 0),
                transactions.filter(t=>t.type==='مصروف').reduce((acc, t)=>acc+t.amount, 0)
            ],
            backgroundColor: ['#22c55e', '#ef4444'],
            hoverOffset: 4
        }]
    };

    window.myChart = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: 'var(--txt)',
                        font: { family: 'Cairo, sans-serif' }
                    }
                },
                title: {
                    display: true,
                    text: 'توزيع الدخل والمصروفات',
                    color: 'var(--brand-2)',
                    font: { family: 'Cairo, sans-serif', size: 16 }
                }
            }
        }
    });
}
function drawCatsBadges(){} // دالة placeholder

// ======================================================================
// بدء الكود الأصلي (مع افتراض وجود باقي الدوال غير المفقودة)
// ======================================================================

const STORAGE_KEY='myFin';
const BASE_CATEGORIES = [
  {name: 'راتب', type: 'دخل'},
  {name: 'هدية', type: 'دخل'},
  {name: 'فواتير', type: 'مصروف'},
  {name: 'طعام', type: 'مصروف'},
  {name: 'تسلية', type: 'مصروف'},
];

let transactions=[], accounts=[], categories=[], commitments=[], collections=[], settings={};
let currentMonth = YM();
let currentAccountFilter = '';

const els = {
  // العناصر الأساسية
  totalBalance: document.getElementById('totalBalance'),
  monthlyIncome: document.getElementById('monthlyIncome'),
  monthlyExpense: document.getElementById('monthlyExpense'),
  transactionsTableBody: document.querySelector('#transactionsTable tbody'),
  monthPicker: document.getElementById('monthPicker'),
  reportMonthPicker: document.getElementById('reportMonthPicker'),
  
  // نماذج الحركات
  transactionForm: document.getElementById('transactionForm'),
  type: document.getElementById('type'),
  category: document.getElementById('category'),
  amount: document.getElementById('amount'),
  accountFrom: document.getElementById('accountFrom'),
  accountTo: document.getElementById('accountTo'),
  accountToGroup: document.getElementById('accountToGroup'),
  date: document.getElementById('date'),

  // نماذج الالتزامات
  commitmentForm: document.getElementById('commitmentForm'),
  cRecurring: document.getElementById('cRecurring'),
  cEndAt: document.getElementById('cEndAt'),
  cEndAtGroup: document.getElementById('cEndAtGroup'),
  
  // نماذج التجميعات
  collectionForm: document.getElementById('collectionForm'),
  coRecurring: document.getElementById('coRecurring'),
  coEndAt: document.getElementById('coEndAt'),
  coEndAtGroup: document.getElementById('coEndAtGroup'),
  
  // الإعدادات والمزامنة
  settingsModal: document.getElementById('settingsModal'),
  btnSettings: document.getElementById('btnSettings'),
  closeSettingsModal: document.getElementById('closeSettingsModal'),
  ghSyncForm: document.getElementById('ghSyncForm'),
  ghToken: document.getElementById('ghToken'),
  ghGistId: document.getElementById('ghGistId'),
  btnGhPush: document.getElementById('btnGhPush'),
  
  // القوائم
  accountsList: document.getElementById('accountsList'),
  dueSoonList: document.getElementById('dueSoonList'),
  dueSoonCount: document.getElementById('dueSoonCount'),
  commitmentsList: document.getElementById('commitmentsList'),
  collectionsList: document.getElementById('collectionsList'),
  
  // إدارة الحسابات
  accountModal: document.getElementById('accountModal'),
  accountForm: document.getElementById('accountForm'),
  manageAccountsList: document.getElementById('manageAccountsList'),
};

// ======================================================================
// دوال التخزين (Storage Functions)
// ======================================================================
function loadData(){
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  transactions = data.transactions || [];
  accounts = data.accounts || [];
  categories = data.categories || [];
  commitments = data.commitments || [];
  collections = data.collections || [];
  settings = data.settings || {};
}
function saveData(){
  const data = {transactions, accounts, categories, commitments, collections, settings};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function saveTransactions(){ saveData(); }
function saveAccounts(){ saveData(); }
function saveCategories(){ saveData(); }
function saveCommitments(){ saveData(); }
function saveCollections(){ saveData(); }
function saveSettings(){ saveData(); }

// ======================================================================
// دوال التنسيق (Formatting Functions)
// ======================================================================
function formatCurrency(amount){
  return new Intl.NumberFormat('ar-EG', {style: 'currency', currency: 'SAR'}).format(amount);
}

// ======================================================================
// دوال منطق الأعمال (Business Logic)
// ======================================================================

function calculateAccountBalance(accountName){
  const account = accounts.find(a => a.name === accountName);
  if (!account) return 0;
  
  const initial = account.opening || 0;
  const balance = transactions
    .filter(t => t.account === accountName || t.accountTo === accountName)
    .reduce((sum, t) => {
      if (t.type === 'دخل' && t.account === accountName) return sum + t.amount;
      if (t.type === 'مصروف' && t.account === accountName) return sum - t.amount;
      if (t.type === 'تحويل') {
        if (t.account === accountName) return sum - t.amount; // تحويل صادر
        if (t.accountTo === accountName) return sum + t.amount; // تحويل وارد
      }
      return sum;
    }, 0);

  return initial + balance;
}

function calculateTotalBalance(){
  return accounts.reduce((sum, a) => sum + calculateAccountBalance(a.name), 0);
}

function ensureBaseCategories(){
  BASE_CATEGORIES.forEach(baseCat => {
    if (!categories.find(c => c.name === baseCat.name && c.type === baseCat.type)) {
      categories.push(baseCat);
    }
  });
  saveCategories();
}

function ensureTransferCategories(){
  const transferCat = {name: 'تحويل', type: 'نظامي'};
  if (!categories.find(c => c.name === transferCat.name)) {
    categories.push(transferCat);
  }
  saveCategories();
}

function calculateMonthlySummary(month){
  const filtered = transactions.filter(t => t.date.startsWith(month));
  const income = filtered.filter(t => t.type === 'دخل').reduce((sum, t) => sum + t.amount, 0);
  const expense = filtered.filter(t => t.type === 'مصروف').reduce((sum, t) => sum + t.amount, 0);
  return {income, expense};
}

// ======================================================================
// دوال واجهة المستخدم (UI/Rendering)
// ======================================================================

function refreshAccountSelects(){
  const accountOptions = accounts.map(a => `<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
  
  if(els.accountFrom) els.accountFrom.innerHTML = accountOptions;
  if(els.accountTo) els.accountTo.innerHTML = accountOptions;
  
  const filterOptions = `<option value="">جميع الحسابات</option>` + accountOptions;
  if(els.filterAccount) els.filterAccount.innerHTML = filterOptions;
}

function refreshCategorySelect(){
  if(!els.type) return;
  const cats = categories.filter(c=>c.type===els.type.value);
  els.category.innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
}

function renderTransactions(month, accountName = ''){
  const filtered = transactions
    .filter(t => t.date.startsWith(month))
    .filter(t => !accountName || t.account === accountName || t.accountTo === accountName)
    .sort((a, b) => parseLocalDate(b.date).getTime() - parseLocalDate(a.date).getTime());
  
  if (filtered.length === 0) {
    els.transactionsTableBody.innerHTML = `<tr class="no-data-row"><td colspan="7" class="no-data">لا توجد حركات مسجلة في هذا الشهر.</td></tr>`;
    return;
  }
  
  const rows = filtered.map(t => {
    const amountClass = t.type === 'دخل' ? 'text-ok' : (t.type === 'مصروف' ? 'text-danger' : '');
    const accountDisplay = t.type === 'تحويل' ? `${t.account} -> ${t.accountTo}` : t.account;
    const typeDisplay = t.type === 'تحويل' ? 'تحويل' : t.type;
    const amountSign = t.type === 'مصروف' ? '-' : (t.type === 'دخل' ? '+' : '');
    
    return `
      <tr>
        <td>${escapeHtml(t.date)}</td>
        <td>${escapeHtml(typeDisplay)}</td>
        <td>${escapeHtml(t.category)}</td>
        <td>${escapeHtml(accountDisplay)}</td>
        <td class="${amountClass}">${amountSign}${formatCurrency(t.amount)}</td>
        <td>${escapeHtml(t.notes || '')}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteTransaction('${t.id}')" style="height:30px; padding:0 0.5rem;">حذف</button></td>
      </tr>
    `;
  }).join('');
  
  els.transactionsTableBody.innerHTML = rows;
}

function renderSummary(month){
  const {income, expense} = calculateMonthlySummary(month);
  
  els.totalBalance.textContent = formatCurrency(calculateTotalBalance());
  els.monthlyIncome.textContent = formatCurrency(income);
  els.monthlyExpense.textContent = formatCurrency(expense);
}

function render(){
  renderSummary(currentMonth);
  renderTransactions(currentMonth, currentAccountFilter);
  // يجب أن يتم استدعاء drawAccountsList هنا لتحديث قائمة الأرصدة في الرئيسية
  drawAccountsList(); 
}

// ======================================================================
// دوال الأحداث (Event Handlers)
// ======================================================================

function deleteTransaction(id){
  if(!confirm('هل أنت متأكد من حذف هذه الحركة؟')) return;
  transactions = transactions.filter(t => t.id !== id);
  saveTransactions();
  render();
}

function handleTransactionTypeChange(e){
  const isTransfer = e.target.value === 'تحويل';
  els.accountToGroup.style.display = isTransfer ? 'flex' : 'none';
  if(els.accountTo) els.accountTo.toggleAttribute('required', isTransfer);
  if(els.category) els.category.toggleAttribute('required', !isTransfer);
  if(els.categoryGroup) els.categoryGroup.style.display = isTransfer ? 'none' : 'flex';
  refreshCategorySelect();
}

function addTransaction(e){
  e.preventDefault();
  
  const type = els.type.value;
  const amount = parseFloat(els.amount.value);
  const date = els.date.value;
  const accountFrom = els.accountFrom.value;
  const notes = els.notes.value;
  
  if(amount <= 0 || !date) {
    alert('الرجاء إدخال مبلغ وتاريخ صالحين.');
    return;
  }
  
  if (type === 'تحويل') {
    const accountTo = els.accountTo.value;
    if (accountFrom === accountTo) {
      alert('لا يمكن التحويل من وإلى نفس الحساب.');
      return;
    }
    
    // الحركة 1: مصروف من الحساب المصدر
    transactions.push({
      id: Date.now() + '-out',
      type: 'مصروف',
      category: 'تحويل', // استخدام تصنيف التحويل
      amount: amount,
      account: accountFrom,
      date: date,
      notes: `تحويل صادر إلى ${accountTo}`
    });
    
    // الحركة 2: دخل إلى الحساب الوجهة
    transactions.push({
      id: Date.now() + '-in',
      type: 'دخل',
      category: 'تحويل', // استخدام تصنيف التحويل
      amount: amount,
      account: accountTo,
      date: date,
      notes: `تحويل وارد من ${accountFrom}`
    });
    
  } else {
    // دخل أو مصروف عادي
    const category = els.category.value;
    if (!category) {
      alert('الرجاء اختيار تصنيف.');
      return;
    }
    
    transactions.push({
      id: Date.now().toString(),
      type: type,
      category: category,
      amount: amount,
      account: accountFrom,
      date: date,
      notes: notes
    });
  }
  
  saveTransactions();
  e.target.reset();
  
  // ضبط تاريخ اليوم تلقائياً
  els.date.value = formatLocalDate(startOfToday());
  
  render();
  alert('تم حفظ الحركة بنجاح!');
}

function addCommitment(e){
  e.preventDefault();
  const name = document.getElementById('cName').value;
  const amount = parseFloat(document.getElementById('cAmount').value);
  const firstDueStr = document.getElementById('cFirstDue').value;
  const notes = document.getElementById('cNotes').value;
  const recurring = els.cRecurring.checked;
  const endAtStr = els.cEndAt.value;

  if (amount <= 0 || !firstDueStr) {
      alert('الرجاء إدخال اسم ومبلغ وتاريخ استحقاق صالحين.');
      return;
  }
  
  // تصحيح الخطأ النحوي: إضافة القوس الناقص )
  if(recurring && endAtStr && parseLocalDate(endAtStr) < parseLocalDate(firstDueStr)){
    alert('تاريخ انتهاء الالتزام الشهري يجب أن يكون بعد تاريخ الاستحقاق الأول.');
    e.preventDefault();
    return;
  }

  commitments.push({
    id: Date.now().toString(),
    name, amount, firstDue: firstDueStr, notes, recurring, endAt: endAtStr || null
  });

  saveCommitments();
  e.target.reset();
  drawCommitments();
  drawDueSoon();
  alert('تم حفظ الالتزام بنجاح!');
}

function addCollection(e){
  e.preventDefault();
  const name = document.getElementById('coName').value;
  const amount = parseFloat(document.getElementById('coAmount').value);
  const firstDueStr = document.getElementById('coFirstDue').value;
  const notes = document.getElementById('coNotes').value;
  const recurring = els.coRecurring.checked;
  const endAtStr = els.coEndAt.value;

  if (amount <= 0 || !firstDueStr) {
      alert('الرجاء إدخال اسم ومبلغ وتاريخ استحقاق صالحين.');
      return;
  }

  // تصحيح الخطأ النحوي: يجب إضافة نفس التحقق من التاريخ هنا أيضاً
  if(recurring && endAtStr && parseLocalDate(endAtStr) < parseLocalDate(firstDueStr)){
    alert('تاريخ انتهاء التجميع الشهري يجب أن يكون بعد تاريخ الاستحقاق الأول.');
    e.preventDefault();
    return;
  }

  collections.push({
    id: Date.now().toString(),
    name, amount, firstDue: firstDueStr, notes, recurring, endAt: endAtStr || null
  });

  saveCollections();
  e.target.reset();
  drawCollections();
  drawDueSoon();
  alert('تم حفظ التجميع بنجاح!');
}

function handleMonthFilter(e){
  currentMonth = els.monthPicker.value;
  currentAccountFilter = els.filterAccount.value;
  render();
}

// ======================================================================
// دوال التهيئة والتفاعل (Initialization & Interaction)
// ======================================================================

function initCollapsibles(){
  document.querySelectorAll('.card-header').forEach(header => {
    header.addEventListener('click', () => {
      const card = header.closest('.card');
      card.classList.toggle('collapsed');
      const content = card.querySelector('.content');
      if (content) content.classList.toggle('hidden');
    });
  });
}

function initTabs(){
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tabId = e.target.dataset.tab;
      
      // إزالة Active من الجميع
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      // إضافة Active للتبويب المحدد
      e.target.classList.add('active');
      const targetContent = document.getElementById(`tab-${tabId}`);
      if (targetContent) targetContent.classList.add('active');
      
      // إعادة رسم التقرير عند الانتقال لتبويب التقارير
      if (tabId === 'reports') {
        const defaultReportMonth = YM();
        if(!els.reportMonthPicker.value) els.reportMonthPicker.value = defaultReportMonth;
        drawMonthly();
      }
    });
  });
}

// Placeholder for GH Sync functions (to avoid runtime errors)
function ghSaveSettings(e){
    e.preventDefault();
    settings.ghToken = els.ghToken.value;
    settings.ghGistId = els.ghGistId.value;
    saveSettings();
    alert('تم حفظ إعدادات GitHub.');
}
function fillGhFormFromStorage(){
    els.ghToken.value = settings.ghToken || '';
    els.ghGistId.value = settings.ghGistId || '';
}
function ghPush(){
    alert('وظيفة المزامنة غير مفعلة في هذا الإصدار.');
}

// ======================================================================
/* ===== تهيئة ===== */
function init(){
  loadData();
  
  if(accounts.length===0){
    accounts=[{name:'كاش',opening:0},{name:'حساب بنكي',opening:0},{name:'محفظة',opening:0}];
    saveAccounts();
  }
  ensureBaseCategories();
  initCollapsibles();
  initTabs(); // تهيئة التبويبات

  // الآن تعمل هذه الدوال لأننا عرفناها كدوال تمرير أساسية
  commitments=commitments.map(c=>migrateCommit(c));
  collections=collections.map(c=>migrateCollect(c));
  saveCommitments(); saveCollections();
  ensureTransferCategories();

  if(els.monthPicker){
    const today=YM(); // الآن YM معرفة
    if(!els.monthPicker.value) els.monthPicker.value=today;
    els.monthPicker.setAttribute('max', today);
  }
  
  // ضبط تاريخ الحركة الافتراضي لليوم
  if(els.date) els.date.value = formatLocalDate(startOfToday());

  refreshAccountSelects(); refreshCategorySelect(); drawCatsBadges();
  // الآن تعمل دوال الرسم لأننا عرفناها
  drawCommitments(); drawCollections(); drawDueSoon(); render();
  fillGhFormFromStorage();
  
  // التبديل بين حقول تاريخ الانتهاء بناءً على التكرار
  els.cEndAt?.toggleAttribute('required', els.cRecurring?.checked);
  els.coEndAt?.toggleAttribute('required', els.coRecurring?.checked);
}

// ======================================================================
// المستمعات (Event Listeners)
// ======================================================================
document.addEventListener('DOMContentLoaded', init);

// حركات
els.transactionForm.addEventListener('submit', addTransaction);
els.type.addEventListener('change', handleTransactionTypeChange);
els.type.addEventListener('change', refreshCategorySelect);
els.btnApplyFilter?.addEventListener('click', handleMonthFilter);

// التزامات
els.commitmentForm.addEventListener('submit', addCommitment);
els.cRecurring?.addEventListener('change', e => {
  els.cEndAtGroup.style.display = e.target.checked ? 'flex' : 'none';
  els.cEndAt?.toggleAttribute('required', e.target.checked);
});

// تجميعات
els.collectionForm.addEventListener('submit', addCollection);
els.coRecurring?.addEventListener('change', e => {
  els.coEndAtGroup.style.display = e.target.checked ? 'flex' : 'none';
  els.coEndAt?.toggleAttribute('required', e.target.checked);
});

// تقارير
els.btnGenerateReport?.addEventListener('click', drawMonthly);


// إدارة الحسابات (Modal) - افتراض
els.btnOpenAccountForm?.addEventListener('click', () => {
  els.accountModal.style.display = 'block';
  // يجب إضافة منطق عرض الحسابات هنا
});
els.closeAccountModal?.addEventListener('click', () => {
  els.accountModal.style.display = 'none';
});

// الإعدادات (Modal)
els.btnSettings?.addEventListener('click', () => {
  els.settingsModal.style.display = 'block';
});
els.closeSettingsModal?.addEventListener('click', () => {
  els.settingsModal.style.display = 'none';
});
els.ghSyncForm?.addEventListener('submit', ghSaveSettings);
els.btnGhPush?.addEventListener('click', ghPush);
// [يُفترض وجود باقي المستمعات مثل تصدير/استيراد البيانات، مسح البيانات، وإدارة الحسابات]

</script>
</body>
</html>
