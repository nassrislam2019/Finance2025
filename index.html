<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساباتي</title>
<meta name="theme-color" content="#0b1220" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
<style>
/* تعاريف الوضع الداكن (افتراضي) */
:root{
  --bg:#0b1220;
  --card:#0f172a;
  --muted:#94a3b8;
  --txt:#e5e7eb;
  --brand:#0369a1;
  --brand-2:#0ea5e9;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#22c55e;
  --border:#1f2a44;
  --radius:12px;
  --field-h:42px;
  --shadow:0 8px 24px rgba(2,6,23,0.5);
  --header-bg:var(--bg);
}

/* تعاريف الوضع الفاتح */
.light-mode:root{
  --bg:#f8fafc;
  --card:#fff;
  --muted:#64748b;
  --txt:#1e293b;
  --brand:#0ea5e9;
  --brand-2:#0369a1;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#10b981;
  --border:#e2e8f0;
  --shadow:0 8px 24px rgba(100,100,100,0.15);
  --header-bg:#f1f5f9;
}
.light-mode body{
  background:var(--bg) !important;
}
.light-mode .card-head{
  background:var(--header-bg);
}
.light-mode input, .light-mode select, .light-mode textarea{
  background:var(--bg);
}
.light-mode tbody tr{
  background:var(--card);
}
.light-mode .stat{
  background:var(--header-bg);
}
.light-mode .list-plain .item{
  background:var(--header-bg);
}
.light-mode .report-table-wrap, .light-mode canvas{
  border:1px solid var(--border);
}
.light-mode .nav-tabs{
  background:var(--card);
}
.light-mode .btn-primary{
  background:var(--brand);color:#fff;border:1px solid var(--brand);
}

/* خطوط */
body,h1,h2,h3,h4,h5,h6,p,div,span,li,a,button{font-family:"Cairo",sans-serif !important;}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0 0 60px 0; /* مساحة لشريط التنقل السفلي */
  background:
    radial-gradient(1200px 600px at 100% -10%, rgba(14,165,233,.10), transparent 70%),
    radial-gradient(900px 500px at -10% 100%, rgba(3,105,161,.12), transparent 70%),
    var(--bg);
  color:var(--txt)
}
.light-mode body{
  background:var(--bg);
}
.container{max-width:1180px;margin-inline:auto;padding:20px}

/* Cards */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:0; overflow:hidden; box-shadow:var(--shadow);
  margin-top:12px;
}
.card-head{
  display:flex;align-items:center;justify-content:space-between;padding:12px 14px;
  background:linear-gradient(135deg, rgba(3,105,161,.55), rgba(14,165,233,.12));
  border-bottom:1px solid var(--border);
}
.light-mode .card-head{
  background:var(--header-bg);
}
.card-head h3{margin:0;font-size:18px;color:var(--txt)}
.card-body{padding:14px}
.toggle{appearance:none;border:none;background:transparent;cursor:pointer;border-radius:10px;font-size:18px;padding:6px 10px;color:var(--muted)}

/* Layout */
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,textarea{
  width:100%;background:#0b1220;color:var(--txt);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none;height:var(--field-h)
}
.light-mode input, .light-mode select, .light-mode textarea{
  background:var(--bg);
}
input[type="date"],input[type="month"]{direction:ltr;text-align:center;font-variant-numeric:tabular-nums}

/* ... (باقي الستايلات لم تتغير) ... */

/* Buttons */
.btn{
  appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer;
  transition:transform .06s ease, opacity .15s,height .08s ease;font-size:13px;height:36px;
}
.btn:hover{opacity:.95;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--txt);padding:8px 10px}
.btn-primary{background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff;border:1px solid rgba(14,165,233,.35)}
.btn-danger{background:linear-gradient(180deg,#ef4444,#d02626);color:#fff;border:1px solid rgba(235,75,75,0.15)}
.btn-muted{background:transparent;color:var(--muted);border:1px dashed var(--border);padding:8px 10px}
.light-mode .btn-outline{border-color:var(--border);color:var(--txt)}
.light-mode .btn-primary{background:var(--brand);border-color:var(--brand)}
.light-mode .btn-danger{background:#dc2626}

/* action buttons داخل الجداول — حجم أصغر */
.actions .btn{height:30px;padding:6px 8px;font-size:13px;border-radius:8px}
.actions .btn-primary{background:linear-gradient(135deg,#3ec9ff,#0b84b8);color:var(--txt)}
.light-mode .actions .btn-primary{background:var(--brand);color:#fff}

/* Stats (ملخص الحسابات) */
.stats{display:grid;gap:10px}
@media(min-width:720px){.stats{grid-template-columns:repeat(6,1fr)}}
.stat{
  background:#0b162a;border:1px solid var(--border);border-radius:var(--radius);padding:14px; text-align:center;
  box-shadow:var(--shadow)
}
.light-mode .stat{background:var(--header-bg);}
.stat small{color:var(--muted)}
.stat .num{font-weight:800;font-size:22px;margin-top:4px;color:var(--txt)}
.pos{color:var(--ok)}.neg{color:var(--danger)}

/* perAccount */
.list-plain{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.list-plain .item{
  background:#0b162a;border:1px solid var(--border);padding:14px;border-radius:var(--radius);
  text-align:center;box-shadow:var(--shadow);font-weight:700;color:var(--txt)
}
.light-mode .list-plain .item{background:var(--header-bg);}

/* Reports & Tables */
.report-table-wrap{overflow:auto;max-height:340px}
#tbodyMonthly tr.active{background:rgba(14,165,233,0.18);box-shadow:0 0 0 1px rgba(14,165,233,0.35)}
.light-mode #tbodyMonthly tr.active{background:rgba(14,165,233,0.1);box-shadow:0 0 0 1px rgba(14,165,233,0.35)}

.month-insights{margin-top:18px;display:grid;gap:16px}
.month-stats{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.month-stats .stat{background:#0b162a}
.light-mode .month-stats .stat{background:var(--header-bg);}

/* ... (ستايلات التقارير الشهرية) ... */

table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:right;padding:6px 10px}
tbody tr{background:linear-gradient(180deg,#071226,#0b162a);border:1px solid rgba(255,255,255,0.02);border-radius:10px;transition:transform .08s ease, box-shadow .08s ease}
.light-mode tbody tr{background:var(--card);border:1px solid var(--border);}
tbody tr:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(2,6,23,0.6)}
.light-mode tbody tr:hover{box-shadow:0 10px 30px rgba(100,100,100,0.2)}
tbody td{padding:12px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);color:var(--txt)}
tbody tr td:first-child{border-right:1px solid var(--border);border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
tbody tr td:last-child{border-left:1px solid var(--border);border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
.amount.exp{color:var(--danger);font-weight:900}.amount.inc{color:var(--ok);font-weight:900}

.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.spacer{flex:1}
.badge{display:inline-flex;gap:6px;align-items:center;background:#071225;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:var(--field-h)}
.light-mode .badge{background:var(--header-bg);}

.footer{margin-top:24px;color:var(--muted);font-size:12px;text-align:center}
.hr{height:1px;background:var(--border);opacity:.7;margin:12px 0;border-radius:999px}
.sub-card-head{font-size:16px;font-weight:700;margin:16px 0 8px 0;color:var(--brand-2)}

/* New for Screens/Navigation (Bottom Fixed Nav) */
.screen{display:none;margin-top:12px}
.screen.active{display:block}
.nav-tabs{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  display:flex;
  flex-wrap:nowrap;
  gap:2px;
  background:var(--card);
  padding:4px;
  border-top:1px solid var(--border);
  box-shadow:0 -5px 15px rgba(0,0,0,0.2);
  z-index:100;
  overflow-x:auto; /* للسماح بالتمرير إذا كان هناك الكثير من الأزرار */
  justify-content:space-between;
}
.nav-tabs button{
  flex:1 1 0; /* توزيع متساوي مع إمكانية الانكماش/التمدد */
  min-width:60px; /* أصغر حجم ممكن للزر */
  background:transparent;
  border:none;
  color:var(--muted);
  font-weight:600;
  cursor:pointer;
  transition:all .15s ease;
  height:48px;
  padding:0 4px;
  border-radius:8px;
  font-size:10px; /* تصغير خط النص */
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
}
.nav-tabs button i{
  font-size:18px; /* حجم الأيقونة */
  margin-bottom:2px;
}
.nav-tabs button.active{
  background:var(--brand);
  color:#fff;
  box-shadow:0 2px 8px rgba(14,165,233,.2);
}
.light-mode .nav-tabs{
  box-shadow:0 -5px 15px rgba(100,100,100,0.1);
}
.light-mode .nav-tabs button.active{
  background:var(--brand);
}

/* Categories Table Style */
#catsTableWrap{overflow:auto}
#catsTableWrap table{border-spacing:0;margin-top:8px}
#catsTableWrap tbody tr{background:transparent;box-shadow:none;border-radius:0}
#catsTableWrap tbody tr:hover{transform:none;box-shadow:none}
#catsTableWrap tbody td{padding:8px 10px;border:none;border-bottom:1px solid var(--border);}
#catsTableWrap tbody td:first-child, #catsTableWrap tbody td:last-child{border-radius:0;border-left:none;border-right:none;}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJzL32c0D/T9/sQ+3B8jY0n2aXf7X/Q5qfKz2O+oF2u/g5p5B7x5W5F5t5O5g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<div class="container">
  <header style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <div class="title" style="font-weight:900;font-size:22px;color:var(--txt)">دفتر حساباتي</div>
    </div>
    <div class="toolbar" style="margin-top:0">
      <button id="toggleDarkMode" class="btn btn-outline" type="button" title="وضع الليل/النهار" style="width:42px;height:42px;border-radius:50%;padding:0;">
        <i class="fa-solid fa-sun"></i>
      </button>
      <button id="exportJson" class="btn btn-outline" type="button">JSON تصدير</button>
      <button id="exportCsv" class="btn btn-outline" type="button">CSV تصدير</button>
      <label class="btn btn-muted" for="importFile">JSON استيراد<input id="importFile" type="file" accept="application/json" style="display:none"></label>
      <button id="syncNow" class="btn btn-outline" type="button">مزامنة الآن</button>
      <button id="installBtn" class="btn btn-outline" type="button" style="display:none">تثبيت التطبيق</button>
    </div>
  </header>

  <section class="card screen" id="card-overview" data-lock="true">
    <div class="card-head"><h3>الملخص، الأرصدة والتقارير</h3></div>
    <div class="card-body">
      <h4 class="sub-card-head">ملخص الأرصدة</h4>
      <div class="stats">
        <div class="stat"><small>إجمالي الأرصدة</small><div id="totalBalance" class="num">0</div></div>
        <div class="stat"><small>إجمالي التزامات الشهر الحالي</small><div id="monthCommitTotal" class="num neg">0</div></div>
        <div class="stat"><small>إجمالي مبالغ تحت التحصيل (الشهر الحالي)</small><div id="currentMonthCollections" class="num pos">0</div></div>
        <div class="stat"><small>الرصيد بعد خصم الالتزامات الحالية</small><div id="balanceAfterCommitments" class="num">0</div></div>
        <div class="stat"><small>التزامات الشهر القادم (شامل متبقي الحالي)</small><div id="nextCommitWithCarry" class="num neg">0</div></div>
        <div class="stat"><small>إجمالي مبالغ تحت التحصيل الشهر القادم</small><div id="nextMonthCollections" class="num pos">0</div></div>
      </div>
      <div class="hr"></div>
      <div>
        <h4 class="sub-card-head">تفاصيل الأرصدة بالحساب</h4>
        <div id="perAccount" class="list-plain"></div>
      </div>
      <div class="hr"></div>

      <h4 class="sub-card-head">استحقاقات قريبة (التزامات)</h4>
      <div class="toolbar" style="margin-bottom:8px">
        <span id="dueTotalBadge" class="badge" title="إجمالي المتبقّي لهذا الشهر">إجمالي: 0.00 ج.م</span>
        <span id="dueNextTotalBadge" class="badge" title="إجمالي الاستحقاقات للشهر القادم">الشهر القادم: 0.00 ج.م</span>
      </div>
      <div id="dueSoonWrap">
        <table style="width:100%">
          <thead><tr><th>الاسم</th><th>التاريخ</th><th>الأصل</th><th>المدفوع</th><th>المتبقي</th><th>الحالة</th><th>إجراءات</th></tr></thead>
          <tbody id="tbodyDueSoon"></tbody>
        </table>
      </div>
      <div id="dueSoonCards"></div>
      <div id="noDueSoon" class="d-none empty-state" style="color:var(--muted)">لا توجد استحقاقات هذا الشهر غير مسددة.</div>
      <div class="hr"></div>

      <h4 class="sub-card-head">تقارير شهرية و رسوم بيانية</h4>
      <div class="toolbar" style="margin-bottom:8px">
        <input id="monthPicker" type="month" />
        <button id="refreshReports" class="btn btn-outline">تحديث</button>
        <span class="spacer"></span><span class="badge">إجمالي الدخل/المصروف لكل شهر</span>
      </div>
      <div class="grid grid-2">
        <div>
          <canvas id="chartMonthly" width="560" height="320" aria-label="Monthly chart"></canvas>
          <div class="report-legend">
            <span><span class="legend-dot" style="background:var(--ok)"></span> دخل</span>
            <span><span class="legend-dot" style="background:var(--danger)"></span> مصروف</span>
            <span><span class="legend-dot" style="background:transparent;border:2px solid var(--brand-2)"></span> صافي</span>
            <span style="margin-inline-start:auto;font-size:11px">القيم مقيّسة وفق أكبر شهر</span>
          </div>
        </div>
        <div class="report-table-wrap">
          <table>
            <thead><tr><th>الشهر</th><th>إجمالي الدخل</th><th>إجمالي المصروف</th><th>الصافي</th></tr></thead>
            <tbody id="tbodyMonthly"></tbody>
          </table>
        </div>
      </div>
      <div class="month-insights">
        <div class="stats month-stats">
          <div class="stat"><small>الشهر المحدد</small><div id="monthSelectedLabel" class="month-selected">—</div></div>
          <div class="stat"><small>إجمالي الدخل</small><div id="monthStatIncome" class="num pos">0.00</div></div>
          <div class="stat"><small>إجمالي المصروف</small><div id="monthStatExpense" class="num neg">0.00</div></div>
          <div class="stat"><small>الصافي</small><div id="monthStatNet" class="num">0.00</div></div>
          <div class="stat"><small>عدد الحركات</small><div id="monthStatTx" class="num">0</div></div>
          <div class="stat"><small>متوسط الصرف اليومي</small><div id="monthStatAvg" class="num">0.00</div></div>
        </div>
        <div id="monthNoData" class="empty-state d-none">لا توجد بيانات للشهر المحدد حتى الآن.</div>
        <div class="month-note">يتم تجاهل التحويلات الداخلية والرسوم المرتبطة بها من حساب الدخل/المصروف.</div>
        <div class="grid grid-2 month-cats">
          <div><h4>أعلى المصروفات حسب الفئة</h4><div id="monthCatsExpense" class="bar-list"></div></div>
          <div><h4>أهم مصادر الدخل</h4><div id="monthCatsIncome" class="bar-list"></div></div>
        </div>
      </div>

    </div>
  </section>

  <section class="card screen" id="card-transactions">
    <div class="card-head"><h3>إضافة وعرض الحركات</h3></div>
    <div class="card-body">
      <h4 class="sub-card-head">إضافة حركة جديدة</h4>
      <div class="grid grid-3">
        <div><label>النوع</label><select id="type"><option value="income">دخل</option><option value="expense" selected>مصروف</option></select></div>
        <div><label>المبلغ (ج.م)</label><input id="amount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>التاريخ</label><input id="date" type="date" /></div>
        <div><label>الوصف</label><input id="desc" type="text" placeholder="مثال: سوبر ماركت" /></div>
        <div><label>الحساب</label><select id="account"></select></div>
        <div><label>الفئة</label><select id="category"></select></div>
        <div><label>ربط الالتزام (اختياري لمصروفات)</label><select id="linkCommit"></select></div>
        <div class="grid grid-2" style="grid-column:1/-1">
          <button id="saveTx" class="btn btn-primary">حفظ</button>
          <button id="resetForm" class="btn btn-outline">إفراغ</button>
        </div>
      </div>
      <div class="hr"></div>

      <h4 class="sub-card-head">جدول الحركات</h4>
      <div class="toolbar" style="margin-bottom:8px">
        <input id="search" placeholder="بحث بالوصف" style="max-width:220px"/>
        <select id="fType" style="max-width:150px"><option value="all" selected>الكل</option><option value="income">دخل فقط</option><option value="expense">مصروف فقط</option></select>
        <select id="fAccount" style="max-width:180px"></select>
        <input id="fFrom" type="date" />
        <input id="fTo" type="date" />
        <button id="clearFilters" class="btn btn-outline">مسح الفلاتر</button>
        <span class="spacer"></span>
        <span class="badge">العملة: ج.م</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>التاريخ</th><th>الوصف</th><th>الفئة</th><th>الحساب</th><th>المبلغ</th><th>رصيد الحساب بعد العملية</th><th>إجراءات</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="pager" id="txPager" style="display:none">
        <button id="txPrev" class="btn btn-outline" type="button">السابق</button>
        <div class="info" id="txPagerInfo">صفحة 1 / 1</div>
        <button id="txNext" class="btn btn-outline" type="button">التالي</button>
      </div>
    </div>
  </section>

  <section class="card screen" id="card-commit-collect">
    <div class="card-head"><h3>إدارة الالتزامات الشهرية ومبالغ التحصيل</h3></div>
    <div class="card-body">
      <h4 class="sub-card-head">الالتزامات الشهرية (المصروفات الثابتة)</h4>
      <div class="grid grid-4">
        <div><label>اسم الالتزام</label><input id="cName" placeholder="مثال: إيجار، إنترنت" /></div>
        <div><label>المبلغ (ج.م)</label><input id="cAmount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>تاريخ أول استحقاق</label><input id="cFirstDue" type="date" required /></div>
        <div class="checkbox-row"><input id="cRecurring" type="checkbox" /><label for="cRecurring" style="margin:0">يتكرر شهريًا</label></div>
        <div style="grid-column:1/span 2;display:none" id="cEndAtWrap"><label>ينتهي في (إجباري عند التكرار)</label><input id="cEndAt" type="date" /></div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button id="addCommitment" class="btn btn-outline">إضافة/تحديث</button>
        <span class="spacer"></span><span class="badge">يمكن السداد جزئيًا من "إضافة حركة"</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr>
            <th>الاسم</th><th>المبلغ</th><th>استحقاق</th><th>مدفوع (الشهر)</th><th>متبقّي</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th>
          </tr></thead>
          <tbody id="tbodyCommit"></tbody>
        </table>
      </div>
      <div class="hr"></div>

      <h4 class="sub-card-head">مبالغ تحت التحصيل (الدخل الثابت المتوقع)</h4>
      <div class="grid grid-4">
        <div><label>اسم التحصيل</label><input id="coName" placeholder="مثال: إيجار مستلم، مبيعات آجل" /></div>
        <div><label>المبلغ (ج.م)</label><input id="coAmount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>تاريخ أول استحقاق</label><input id="coFirstDue" type="date" required /></div>
        <div class="checkbox-row"><input id="coRecurring" type="checkbox" /><label for="coRecurring" style="margin:0">يتكرر شهريًا</label></div>
        <div style="grid-column:1/span 2;display:none" id="coEndAtWrap"><label>ينتهي في (إجباري عند التكرار)</label><input id="coEndAt" type="date" /></div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button id="addCollect" class="btn btn-outline">إضافة/تحديث</button>
        <span class="spacer"></span><span class="badge">لا يظهر في الحركات إلا بعد "تم التحصيل"</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>الاسم</th><th>المبلغ</th><th>التحصيل القادم</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th></tr></thead>
          <tbody id="tbodyCollect"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="card screen" id="card-accounts-manage">
    <div class="card-head"><h3>إدارة الحسابات والتحويل</h3></div>
    <div class="card-body">
      <h4 class="sub-card-head">إدارة الحسابات</h4>
      <div class="grid grid-3">
        <div><label>اسم الحساب</label><input id="newAccountName" placeholder="مثال: كاش/محفظة" /></div>
        <div><label>رصيد افتتاحي</label><input id="newAccountOpening" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>&nbsp;</label><button id="addAccount" class="btn btn-outline" style="width:100%">إضافة حساب</button></div>
      </div>
      <div id="accountsList" class="toolbar" style="margin-top:8px;flex-wrap:wrap"></div>
      <div class="hr"></div>

      <h4 class="sub-card-head">تحويل بين الحسابات</h4>
      <div class="transfer-grid">
        <div><label>من حساب</label><select id="trFrom"></select></div>
        <div><label>إلى حساب</label><select id="trTo"></select></div>
        <div><label>المبلغ (ج.م)</label><input id="trAmount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>عمولة التحويل (اختياري)</label><input id="trFee" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>التاريخ</label><input id="trDate" type="date" /></div>
        <div><label>ملاحظة</label><input id="trDesc" type="text" placeholder="مثال: تحويل لمحفظة"/></div>
        <div class="full" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <button id="execTransfer" class="btn btn-primary">تنفيذ التحويل</button>
          <button id="resetTransfer" class="btn btn-outline">إفراغ</button>
        </div>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">ملاحظة: التحويلات لا تُحسب ضمن إجمالي الدخل/المصروف، لكن العمولة تُحسب كمصروف.</div>
    </div>
  </section>

  <section class="card screen" id="card-cats">
    <div class="card-head"><h3>إدارة الفئات</h3></div>
    <div class="card-body">
      <div class="grid grid-3">
        <div><label>اسم الفئة</label><input id="newCatName" placeholder="مثال: أكل" /></div>
        <div><label>النوع</label><select id="newCatType"><option value="expense" selected>مصروف</option><option value="income">دخل</option></select></div>
        <div><label>&nbsp;</label><button id="addCategory" class="btn btn-outline" style="width:100%">إضافة فئة</button></div>
      </div>

      <div id="catsTableWrap">
        <table>
          <thead>
            <tr><th>الاسم</th><th>النوع</th><th>الإجراءات</th></tr>
          </thead>
          <tbody id="catsList">
            </tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="card screen" id="card-github">
    <div class="card-head"><h3>إعدادات مزامنة GitHub</h3></div>
    <div class="card-body">
      <div class="grid grid-4">
        <div><label>اسم المستخدم</label><input id="ghUser" placeholder="مثال: username" /></div>
        <div><label>المستودع</label><input id="ghRepo" placeholder="مثال: Finance2025" /></div>
        <div><label>الفرع</label><input id="ghBranch" value="main" /></div>
        <div><label>مسار الملف (JSON)</label><input id="ghPath" value="my-finance.json" /></div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <div><label>Personal Access Token</label><input id="ghToken" type="password" placeholder="ghp_..." /></div>
        <div class="checkbox-row" style="margin-top:22px"><input id="ghAuto" type="checkbox"/><label for="ghAuto" style="margin:0">مزامنة تلقائيًا بعد كل تعديل</label></div>
        <div class="grid grid-2" style="margin-top:22px">
          <button id="ghSaveCfg" class="btn btn-outline">حفظ الإعدادات</button>
          <button id="ghTest" class="btn btn-outline">اختبار الاتصال</button>
        </div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <button id="ghPull" class="btn btn-outline">تحميل من GitHub</button>
        <button id="ghPush" class="btn btn-primary">رفع إلى GitHub</button>
        <span id="ghStatus" class="badge">الحالة: غير متصل</span>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">⚠️ الـ Token محفوظ محليًا في جهازك فقط.</div>
    </div>
  </section>

  <div class="footer">
    <div>⚠️ <span class="note">تنبيه:</span> كل البيانات محفوظة محليًا في <code>localStorage</code>. لا تنسَ التصدير كنسخة احتياطية.</div>
    <div style="margin-top:6px">تقدر تثبّت الموقع كتطبيق لأنه PWA.</div>
  </div>
</div>

<nav class="nav-tabs">
    <button data-screen="card-overview">
      <i class="fa-solid fa-chart-line"></i>
      <span>الرئيسية</span>
    </button>
    <button data-screen="card-transactions">
      <i class="fa-solid fa-right-left"></i>
      <span>الحركات</span>
    </button>
    <button data-screen="card-accounts-manage">
      <i class="fa-solid fa-wallet"></i>
      <span>الحسابات</span>
    </button>
    <button data-screen="card-commit-collect">
      <i class="fa-solid fa-calendar-check"></i>
      <span>الالتزامات</span>
    </button>
    <button data-screen="card-cats">
      <i class="fa-solid fa-list-ul"></i>
      <span>الفئات</span>
    </button>
    <button data-screen="card-github">
      <i class="fa-brands fa-github"></i>
      <span>المزامنة</span>
    </button>
</nav>

<script>
/* ===== مفاتيح التخزين ===== */
const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1',
      COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1', GH_KEY='pf_github_cfg_v1', THEME_KEY='pf_theme';

/* ===== الحالة ===== */
let ledger=JSON.parse(localStorage.getItem(KEY)||'[]');
let accounts=JSON.parse(localStorage.getItem(ACC_KEY)||'[]');
let categories=JSON.parse(localStorage.getItem(CAT_KEY)||'[]');
let commitments=JSON.parse(localStorage.getItem(COM_KEY)||'[]');
let collections=JSON.parse(localStorage.getItem(COL_KEY)||'[]');
let ghCfg=JSON.parse(localStorage.getItem(GH_KEY)||'{}');

/* افتراضات أولية */
function ensureBaseCategories(){
  const need=[
    {name:'التزامات شهرية',type:'expense'},
    {name:'تحصيلات شهرية',type:'income'},
    {name:'تحويل صادر',type:'expense'},
    {name:'تحويل وارد',type:'income'},
    {name:'عمولة تحويل',type:'expense'},
  ];
  let changed=false;
  if(categories.length===0){
    categories=[
      {name:'مرتب',type:'income'},{name:'دخل آخر',type:'income'},
      {name:'أكل وشرب',type:'expense'},{name:'مواصلات',type:'expense'},{name:'فواتير',type:'expense'},{name:'تسوق',type:'expense'}
    ];
    changed=true;
  }
  for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } }
  if(changed) saveCategories();
}

/* DOM */
const $=s=>document.querySelector(s);
const els={
  totalBalance:$('#totalBalance'),
  monthCommitTotal:$('#monthCommitTotal'),
  currentMonthCollections:$('#currentMonthCollections'),
  balanceAfterCommitments:$('#balanceAfterCommitments'),
  nextCommitWithCarry:$('#nextCommitWithCarry'),
  nextMonthCollections:$('#nextMonthCollections'),
  perAccount:$('#perAccount'),

  tbody:$('#tbody'), type:$('#type'), amount:$('#amount'), date:$('#date'), desc:$('#desc'),
  account:$('#account'), category:$('#category'), linkCommit:$('#linkCommit'),
  saveTx:$('#saveTx'), resetForm:$('#resetForm'), search:$('#search'),

  exportJson:$('#exportJson'), exportCsv:$('#exportCsv'), importFile:$('#importFile'), syncNow:$('#syncNow'),

  newAccountName:$('#newAccountName'), newAccountOpening:$('#newAccountOpening'), addAccount:$('#addAccount'), accountsList:$('#accountsList'),

  newCatName:$('#newCatName'), newCatType:$('#newCatType'), addCategory:$('#addCategory'), catsList:$('#catsList'), // #catsList هو الآن tbody

  monthPicker:$('#monthPicker'), refreshReports:$('#refreshReports'), tbodyMonthly:$('#tbodyMonthly'), chartMonthly:$('#chartMonthly'),
  monthSelectedLabel:$('#monthSelectedLabel'), monthStatIncome:$('#monthStatIncome'), monthStatExpense:$('#monthStatExpense'),
  monthStatNet:$('#monthStatNet'), monthStatTx:$('#monthStatTx'), monthStatAvg:$('#monthStatAvg'), monthNoData:$('#monthNoData'),
  monthCatsExpense:$('#monthCatsExpense'), monthCatsIncome:$('#monthCatsIncome'),

  /* الالتزامات */
  cName:$('#cName'), cAmount:$('#cAmount'), cFirstDue:$('#cFirstDue'), cRecurring:$('#cRecurring'), cEndAt:$('#cEndAt'), cEndAtWrap:$('#cEndAtWrap'),
  addCommitment:$('#addCommitment'), tbodyCommit:$('#tbodyCommit'),

  /* تحصيل */
  coName:$('#coName'), coAmount:$('#coAmount'), coFirstDue:$('#coFirstDue'), coRecurring:$('#coRecurring'), coEndAt:$('#coEndAt'), coEndAtWrap:$('#coEndAtWrap'),
  addCollect:$('#addCollect'), tbodyCollect:$('#tbodyCollect'),

  /* PWA & تحويل */
  installBtn:$('#installBtn'),
  trFrom:$('#trFrom'), trTo:$('#trTo'), trAmount:$('#trAmount'), trFee:$('#trFee'), trDate:$('#trDate'), trDesc:$('#trDesc'),
  execTransfer:$('#execTransfer'), resetTransfer:$('#resetTransfer'),

  /* GitHub */
  ghUser:$('#ghUser'), ghRepo:$('#ghRepo'), ghBranch:$('#ghBranch'), ghPath:$('#ghPath'), ghToken:$('#ghToken'),
  ghAuto:$('#ghAuto'), ghSaveCfg:$('#ghSaveCfg'), ghTest:$('#ghTest'), ghPull:$('#ghPull'), ghPush:$('#ghPush'), ghStatus:$('#ghStatus'),

  /* إجمالي الاستحقاقات + كروت الموبايل */
  dueTotalBadge:$('#dueTotalBadge'), dueNextTotalBadge:$('#dueNextTotalBadge'), dueSoonCards:$('#dueSoonCards'),

  /* فلاتر الحركات */
  fType:$('#fType'), fAccount:$('#fAccount'), fFrom:$('#fFrom'), fTo:$('#fTo'), clearFilters:$('#clearFilters'),

  /* وضع الليل/النهار */
  toggleDarkMode:$('#toggleDarkMode')
};
['saveTx','resetForm','addAccount','addCategory','exportJson','exportCsv','refreshReports','addCommitment','addCollect','execTransfer','resetTransfer','syncNow','ghSaveCfg','ghTest','ghPull','ghPush','toggleDarkMode']
  .forEach(id=>document.getElementById(id)?.setAttribute('type','button'));

/* Utils */
const eid=()=>Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const fmt=n=>Number(n).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const escapeHtml=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
const YM=()=>new Date().toISOString().slice(0,7);
const parseLocalDate=d=>d?new Date(d+'T00:00:00'):new Date(NaN);
const formatLocalDate=d=>d.toISOString().slice(0,10);
const startOfToday=()=>parseLocalDate(formatLocalDate(new Date()));
const daysBetween=(d1,d2)=>Math.round((d2.getTime()-d1.getTime())/(1000*60*60*24));
const monthLabel=ym=>{const [y,m]=ym.split('-'); return new Date(y,m-1).toLocaleString('ar-EG',{year:'numeric',month:'long'})};
const addMonthsToYm=(ym,m)=>{const [y,month]=ym.split('-').map(Number); const d=new Date(y,month-1+m); return d.toISOString().slice(0,7)};
const addMonthsPreserveDOM=(date,m)=>{const d=new Date(date.getTime()); d.setMonth(d.getMonth()+m); return d};
// تم حذف chooseAccount و chooseCategory لأنها غير مستخدمة في الكود المحدث (تم استبدالها بقوائم منسدلة)

/* New: Screen Navigation */
function showScreen(screenId){
  document.querySelectorAll('.screen').forEach(el=>{
    el.classList.remove('active');
  });
  const activeScreen = document.getElementById(screenId);
  if(activeScreen) activeScreen.classList.add('active');

  document.querySelectorAll('.nav-tabs button').forEach(btn=>{
    if(btn.dataset.screen === screenId){
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  window.scrollTo({top:0,behavior:'smooth'}); // scroll to top on screen switch
}

document.querySelectorAll('.nav-tabs button').forEach(button=>{
  button.addEventListener('click', e => {
    showScreen(e.target.dataset.screen);
  });
});
/* End New: Screen Navigation */

/* ===== Dark/Light Mode Toggle ===== */
function applyTheme(theme){
  if(theme === 'light'){
    document.body.classList.add('light-mode');
    if(els.toggleDarkMode) els.toggleDarkMode.innerHTML = '<i class="fa-solid fa-moon"></i>';
    localStorage.setItem(THEME_KEY, 'light');
  } else {
    document.body.classList.remove('light-mode');
    if(els.toggleDarkMode) els.toggleDarkMode.innerHTML = '<i class="fa-solid fa-sun"></i>';
    localStorage.setItem(THEME_KEY, 'dark');
  }
}

els.toggleDarkMode?.addEventListener('click', ()=>{
  const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
  applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
  // إعادة رسم المخطط البياني لتحديث الألوان
  getMonthlyData();
  drawChart();
});

/* ===== حفظ البيانات ===== */
const saveLedger=()=>localStorage.setItem(KEY,JSON.stringify(ledger));
const saveAccounts=()=>localStorage.setItem(ACC_KEY,JSON.stringify(accounts));
const saveCategories=()=>localStorage.setItem(CAT_KEY,JSON.stringify(categories));
const saveCommitments=()=>localStorage.setItem(COM_KEY,JSON.stringify(commitments));
const saveCollections=()=>localStorage.setItem(COL_KEY,JSON.stringify(collections));
const saveGhCfg=()=>{
  localStorage.setItem(GH_KEY,JSON.stringify(ghCfg));
  ghStatus();
};

/* ===== الحسابات ===== */
function drawAccounts(){
  if(!els.accountsList) return;
  // تم تغيير عرض الحسابات من badges إلى قائمة أبسط ضمن إدارة الحسابات
  els.accountsList.innerHTML = accounts.map((a,i)=>
    `<div class="badge-group" style="margin-top:4px">
      <span class="badge">${escapeHtml(a.name)}: ${fmt(a.opening)} ج.م</span>
      <button class="btn actions btn-outline" onclick="editAccount(${i})">تعديل</button>
      <button class="btn actions btn-danger" onclick="removeAccount(${i})">حذف</button>
    </div>`
  ).join('');
  refreshAccountSelects();
  // drawPerAccount يتم استدعائها في recalc()
}
window.editAccount=i=>{
  const a=accounts[i];
  const newName=prompt('ادخل الاسم الجديد:',a.name);
  if(!newName || newName.trim()===a.name) return;
  if(accounts.some(x=>x.name===newName.trim())) return alert('هذا الاسم مستخدم مسبقاً');
  const oldName=a.name;
  a.name=newName.trim();
  ledger.filter(t=>t.account===oldName).forEach(t=>t.account=a.name);
  saveAccounts(); saveLedger();
  drawAccounts(); render();
};
window.removeAccount=i=>{
  const name=accounts[i].name;
  if(!confirm(`هل تريد حذف حساب ${name}؟ سيتم حذف جميع الحركات المرتبطة به.`)) return;
  accounts.splice(i,1);
  ledger=ledger.filter(t=>t.account!==name);
  saveAccounts(); saveLedger();
  drawAccounts(); render();
};
document.getElementById('addAccount')?.addEventListener('click',()=>{
  const name=els.newAccountName.value.trim();
  const opening=parseFloat(els.newAccountOpening.value||'0');
  if(!name){ alert('ادخل اسم الحساب'); return; }
  if(accounts.some(a=>a.name===name)){ alert('هذا الاسم موجود مسبقاً'); return; }
  accounts.push({name,opening});
  els.newAccountName.value=''; els.newAccountOpening.value='';
  saveAccounts();
  drawAccounts(); render();
});
function refreshAccountSelects(excludeName=null){
  const opts=accounts.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');

  if(els.account) els.account.innerHTML=opts;
  if(els.fAccount) els.fAccount.innerHTML=`<option value="all">كل الحسابات</option>`+opts;
  if(els.trFrom) els.trFrom.innerHTML=opts;
  if(els.trTo) els.trTo.innerHTML=opts;

  if(els.trFrom && els.trTo){
    // لضمان عدم التحويل إلى نفس الحساب
    syncTransferSelects('from');
  }
}

/* ===== الفئات (عرض جدول) ===== */
function drawCategories(){
  if(!els.catsList) return;
  // تم تغيير العرض إلى جدول
  els.catsList.innerHTML = categories.map((c,i)=>
    `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td><span class="badge" style="background:${c.type==='income'?'var(--ok)':'var(--danger)'};color:#fff;border:none;">${c.type==='income'?'دخل':'مصروف'}</span></td>
      <td class="actions">
        <button class="btn btn-outline" onclick="editCat(${i})">تعديل</button>
        <button class="btn btn-danger" onclick="removeCat(${i})">حذف</button>
      </td>
    </tr>`
  ).join('');
  refreshCategorySelect();
}
window.editCat=i=>{
  const cur=categories[i];
  const name=prompt('ادخل الاسم الجديد:',cur.name);
  if(!name || name.trim()===cur.name) return;
  const type=prompt('ادخل النوع (income/expense)', cur.type);
  if(type!=='income'&&type!=='expense') return alert('نوع غير صحيح');
  const oldName=cur.name;
  cur.name=name.trim();
  cur.type=type;
  ledger.filter(t=>t.category===oldName).forEach(t=>t.category=cur.name);
  saveCategories();
  drawCategories(); render();
};
window.removeCat=i=>{
  const name=categories[i].name;
  if(!confirm(`هل تريد حذف فئة ${name}؟ لن يتم حذف الحركات المرتبطة بها لكن ستصبح 'غير مصنفة'.`)) return;
  categories.splice(i,1);
  ledger.filter(t=>t.category===name).forEach(t=>t.category=null);
  saveCategories();
  drawCategories(); render();
};
document.getElementById('addCategory')?.addEventListener('click',()=>{
  const name=els.newCatName.value.trim();
  const type=els.newCatType.value;
  if(!name){ alert('ادخل اسم الفئة'); return; }
  categories.push({name,type});
  els.newCatName.value='';
  saveCategories();
  drawCategories(); render();
});
function refreshCategorySelect(){
  if(!els.type) return;
  const cats = categories.filter(c=>c.type===els.type.value);
  els.category.innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
}


/* ===== تصدير/استيراد (لم يتغير) ===== */
document.getElementById('exportJson')?.addEventListener('click',()=>{
  const data={
    ledger, accounts, categories, commitments, collections,
    exportedAt:new Date().toISOString()
  };
  download('my-finance-data.json', JSON.stringify(data,null,2));
});
document.getElementById('exportCsv')?.addEventListener('click',()=>{
  const header=['id','date','desc','type','amount','account','category'];
  const rows=[...ledger].sort((a,b)=>
    a.date.localeCompare(b.date) || (a.id>b.id?1:-1))
    .map(t=>[t.id,t.date,escCsv(t.desc||''),t.type,t.amount,t.account,t.category]);
  const csv=[header.join(','), ...rows.map(r=>r.join(','))].join('\n');
  download('transactions.csv', csv);
});
function escCsv(s){
  const need=/[",\n]/.test(String(s));
  return need ? '"'+String(s).replace(/"/g,'""')+'"' : String(s);
}
function download(name, content){
  const blob=new Blob([content],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
  URL.revokeObjectURL(a.href);
}
document.getElementById('importFile')?.addEventListener('change', async (e)=>{
  const file=e.target.files?.[0];
  if(!file) return;
  try{
    const text=await file.text();
    const data=JSON.parse(text);
    if(Array.isArray(data.ledger)) ledger=data.ledger;
    if(Array.isArray(data.accounts)) accounts=data.accounts;
    if(Array.isArray(data.categories)) categories=data.categories;
    if(Array.isArray(data.commitments)) commitments=data.commitments;
    if(Array.isArray(data.collections)) collections=data.collections;

    // توحيد الحسابات والفئات الأساسية
    ensureBaseCategories();
    commitments=commitments.map(c=>migrateCommit(c));
    collections=collections.map(c=>migrateCollect(c));
    saveLedger(); saveAccounts(); saveCategories(); saveCommitments(); saveCollections();
    txPage = 1; // العودة للصفحة الأولى بعد الاستيراد
    render();
    alert('تم الاستيراد بنجاح');
  }
  catch(err){ alert('فشل في استيراد الملف: '+err.message); }
  e.target.value=null; // لإتاحة استيراد نفس الملف مرة أخرى
});

/* ===== الحركات (Ledger) ===== */
let txPage=1;
const TXS_PER_PAGE=10;
let filteredTxs=[];

function renderTxTable(){
  if(!els.tbody) return;
  filteredTxs=applyFilters(ledger);

  const start=(txPage-1)*TXS_PER_PAGE;
  const end=start+TXS_PER_PAGE;
  const pageTxs=filteredTxs.slice(start,end);

  const {after}=computeBalances();

  els.tbody.innerHTML=pageTxs.map(t=>{
    const amountCls=t.type==='expense'?'exp':'inc';
    const amountSign=t.type==='expense'?'-':'';
    const balanceAfter=after.get(t.id)||0;
    const balanceCls=balanceAfter>=0?'pos':'neg';
    return `<tr id="tx-${t.id}">
      <td>${t.date}</td>
      <td>${escapeHtml(t.desc||'—')}</td>
      <td>${escapeHtml(t.category||'غير مصنفة')}</td>
      <td>${escapeHtml(t.account||'—')}</td>
      <td class="amount ${amountCls}">${amountSign}${fmt(t.amount)}</td>
      <td class="${balanceCls}">${fmt(balanceAfter)}</td>
      <td class="actions">
        <button class="btn btn-outline" onclick="editTx('${t.id}')">تعديل</button>
        <button class="btn btn-danger" onclick="removeTx('${t.id}')">حذف</button>
      </td>
    </tr>`;
  }).join('');

  const totalPages=Math.max(1,Math.ceil(filteredTxs.length/TXS_PER_PAGE));
  const hasPager=totalPages>1;

  if(els.txPager){
    els.txPager.style.display=hasPager?'flex':'none';
    els.txPagerInfo.textContent=`صفحة ${txPage} / ${totalPages} (إجمالي: ${filteredTxs.length})`;
    document.getElementById('txPrev').disabled=txPage<=1;
    document.getElementById('txNext').disabled=txPage>=totalPages;
  }
}

window.removeTx=id=>{
  if(!confirm('هل تريد حذف هذه الحركة؟')) return;
  const tx=ledger.find(t=>t.id===id);
  // إذا كانت الحركة مرتبطة بالتزام، نعكس الدفعة
  if(tx && tx.linkCommitId){
    const ym=tx.date.slice(0,7);
    const c=commitments.find(x=>x.id===tx.linkCommitId);
    if(c && c.payments?.[ym]){
      c.payments[ym]=Math.max(0,(c.payments[ym]-tx.amount));
      saveCommitments();
    }
  }

  ledger=ledger.filter(t=>t.id!==id);
  saveLedger();
  txPage=Math.min(txPage,Math.max(1,Math.ceil(applyFilters(ledger).length/TXS_PER_PAGE)));
  render();
};

let editId=null;
window.editTx=id=>{
  const tx=ledger.find(t=>t.id===id);
  if(!tx) return;
  editId=id;

  els.type.value=tx.type;
  refreshCategorySelect(); // تحديث الفئات وفقاً للنوع
  els.amount.value=tx.amount;
  els.date.value=tx.date;
  els.desc.value=tx.desc;
  els.account.value=tx.account||'';
  els.category.value=tx.category||'';
  refreshLinkCommitSelect(); // تحديث قائمة الالتزامات

  if(tx.linkCommitId){
    els.linkCommit.value=tx.linkCommitId;
  } else {
    els.linkCommit.value='';
  }

  els.saveTx.textContent='تحديث الحركة';
  showScreen('card-transactions');
  window.scrollTo({top:0,behavior:'smooth'}); // الصعود للأعلى

};

els.resetForm?.addEventListener('click',()=>{
  editId=null;
  els.saveTx.textContent='حفظ';
  els.type.value='expense';
  els.amount.value='';
  els.date.value=formatLocalDate(new Date());
  els.desc.value='';
  els.account.value=accounts.length?accounts[0].name:'';
  els.category.value=categories.filter(c=>c.type==='expense').length?categories.filter(c=>c.type==='expense')[0].name:'';
  refreshCategorySelect();
  refreshLinkCommitSelect();
});

els.type?.addEventListener('change',refreshCategorySelect);
els.type?.addEventListener('change',refreshLinkCommitSelect);
els.date?.addEventListener('change',refreshLinkCommitSelect); // لتحديث قائمة الالتزامات بناءً على الشهر

els.saveTx?.addEventListener('click',()=>{
  const newTx={
    type:els.type.value,
    amount:parseFloat(els.amount.value),
    date:els.date.value,
    desc:els.desc.value.trim(),
    account:els.account.value,
    category:els.category.value,
    linkCommitId:els.linkCommit.value||null
  };

  if(!newTx.amount || newTx.amount<=0 || !newTx.date || !newTx.account || !newTx.category){
    alert('جميع الحقول إجبارية (باستثناء الوصف وربط الالتزام)');
    return;
  }
  if(isNaN(newTx.amount)){
    alert('المبلغ يجب أن يكون رقماً صحيحاً.');
    return;
  }

  if(!editId){
    newTx.id=eid();
  } else {
    const was=ledger.find(t=>t.id===editId);
    if(!was){ alert('خطأ: لم يتم العثور على الحركة الأصلية'); return; }
    newTx.id=editId;

    // إذا كانت الحركة السابقة مرتبطة بالتزام والمبلغ تغير، يجب تعديل مدفوعات الالتزام القديم
    if(was.linkCommitId && was.linkCommitId===newTx.linkCommitId && was.amount!==newTx.amount){
      const ym=was.date.slice(0,7);
      const c=commitments.find(x=>x.id===was.linkCommitId);
      if(c && c.payments?.[ym]){
        c.payments[ym]=Math.max(0,(c.payments[ym]-was.amount+newTx.amount));
        saveCommitments();
      }
    }
    ledger=ledger.filter(t=>t.id!==editId);
  }

  // إذا كانت حركة تحويل، نمنع حفظها من هنا
  if(newTx.category==='تحويل صادر'||newTx.category==='تحويل وارد'||newTx.category==='عمولة تحويل'){
    alert('لا يمكن حفظ حركات التحويل من هنا. استخدم قسم "تحويل بين الحسابات"');
    return;
  }

  ledger.push(newTx);
  ledger.sort((a,b)=> a.date.localeCompare(b.date) || (a.id>b.id?1:-1));

  // تحديث مدفوعات الالتزام الجديد (أو المحرر)
  if(newTx.linkCommitId && newTx.type==='expense'){
    addCommitPayment(newTx.linkCommitId, newTx.date.slice(0,7), newTx.amount);
  }

  els.resetForm.click();
  saveLedger();
  txPage = 1; // العودة للصفحة الأولى بعد التعديل
  render();
});

// تصحيح الأخطاء: يجب التأكد من وجود العنصر قبل الوصول إلى قيمته
function applyFilters(txs){
  let filtered=txs;
  const s = els.search ? els.search.value.toLowerCase().trim() : '';
  const fType = els.fType ? els.fType.value : 'all';
  const fAccount = els.fAccount ? els.fAccount.value : 'all';
  const fFrom = els.fFrom ? els.fFrom.value : '';
  const fTo = els.fTo ? els.fTo.value : '';

  if(s) filtered=filtered.filter(t=>
    (t.desc||'').toLowerCase().includes(s)
  );
  if(fType!=='all') filtered=filtered.filter(t=>t.type===fType);
  if(fAccount!=='all') filtered=filtered.filter(t=>t.account===fAccount);
  if(fFrom) filtered=filtered.filter(t=>t.date>=fFrom);
  if(fTo) filtered=filtered.filter(t=>t.date<=fTo);

  return filtered;
}

els.search?.addEventListener('input',()=>txPage=1);
els.fType?.addEventListener('change',()=>txPage=1);
els.fAccount?.addEventListener('change',()=>txPage=1);
els.fFrom?.addEventListener('change',()=>txPage=1);
els.fTo?.addEventListener('change',()=>txPage=1);
[els.search,els.fType,els.fAccount,els.fFrom,els.fTo].forEach(el=>el?.addEventListener('change',render));
els.clearFilters?.addEventListener('click',()=>{
  if(els.search) els.search.value='';
  if(els.fType) els.fType.value='all';
  if(els.fAccount) els.fAccount.value='all';
  if(els.fFrom) els.fFrom.value='';
  if(els.fTo) els.fTo.value='';
  txPage=1;
  render();
});
document.getElementById('txPrev')?.addEventListener('click',()=>{
  if(txPage>1){ txPage--; renderTxTable(); }
});
document.getElementById('txNext')?.addEventListener('click',()=>{
  const totalPages=Math.max(1,Math.ceil(filteredTxs.length/TXS_PER_PAGE));
  if(txPage<totalPages){ txPage++; renderTxTable(); }
});

function refreshLinkCommitSelect(){
  if(!els.linkCommit) return;
  const targetDate=els.date.value;
  if(!targetDate) return;

  const ym=targetDate.slice(0,7);

  const opts = commitments
    .filter(c=>{
      const due=(c.nextDue||c.firstDue||'').slice(0,7)===ym;
      const paid=(c.payments?.[ym]||0);
      return due && paid < Number(c.amount||0);
    })
    .map(c=>`<option value="${c.id}">${escapeHtml(c.name)} — أصل ${fmt(c.amount)} • مدفوع ${fmt(c.payments?.[ym]||0)} • متبقي ${fmt((Number(c.amount||0)-(c.payments?.[ym]||0)))}</option>`)
    .join('');

  // إظهار الخيار فقط للمصروفات
  if(els.type.value==='expense'){
    els.linkCommit.parentElement.style.display='';
    els.linkCommit.innerHTML = `<option value="">— بدون —</option>` + opts;
  } else {
    els.linkCommit.parentElement.style.display='none';
    els.linkCommit.innerHTML = `<option value="">— بدون —</option>`;
  }
}

/* ===== التحويل ===== */
function ensureTransferCategories(){
  const need=[{name:'تحويل صادر',type:'expense'},{name:'تحويل وارد',type:'income'},{name:'عمولة تحويل',type:'expense'}];
  let changed=false;
  for(const n of need){
    if(!categories.some(c=>c.name===n.name && c.type===n.type)){
      categories.push(n); changed=true;
    }
  }
  if(changed) saveCategories();
}
function syncTransferSelects(trigger){
  if(trigger === 'from' && els.trTo){
    const from = els.trFrom.value;
    const prevTo = els.trTo.value;
    els.trTo.innerHTML = buildAccountOptions(from);
    if(prevTo && prevTo !== from && accounts.some(a=>a.name===prevTo)){
      els.trTo.value = prevTo;
    }else{
      els.trTo.selectedIndex = 0;
    }
  } else if(trigger === 'to' && els.trFrom){
    const to = els.trTo.value;
    const prevFrom = els.trFrom.value;
    els.trFrom.innerHTML = buildAccountOptions(to);
    if(prevFrom && prevFrom !== to && accounts.some(a=>a.name===prevFrom)){
      els.trFrom.value = prevFrom;
    }else{
      els.trFrom.selectedIndex = 0;
    }
  }
}
function buildAccountOptions(excludeName=null){
  return accounts.filter(a=>a.name!==excludeName).map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
}
function doTransfer(){
  const from=els.trFrom.value, to=els.trTo.value,
        amount=parseFloat(els.trAmount.value), fee=parseFloat(els.trFee.value||'0'),
        date=els.trDate.value||formatLocalDate(new Date()),
        note=els.trDesc.value.trim();

  if(!from || !to){ alert('يجب اختيار الحسابين'); return; }
  if(from===to){ alert('لا يمكن التحويل إلى نفس الحساب'); return; }
  if(!amount || amount<=0 || isNaN(amount)){ alert('المبلغ غير صحيح'); return; }
  if(isNaN(fee) || fee<0){ alert('عمولة التحويل غير صحيحة'); return; }

  const desc=note||`تحويل من ${from} إلى ${to}`;

  const txs=[
    // الحركة الصادرة
    {id:eid(), date, desc:`${desc} (رئيسي)`, type:'expense', amount, account:from, category:'تحويل صادر', isTransfer:true},
    // الحركة الواردة
    {id:eid(), date, desc:`${desc} (مستلم)`, type:'income', amount, account:to, category:'تحويل وارد', isTransfer:true}
  ];

  // عمولة التحويل (إن وُجدت)
  if(fee>0){
    txs.push({id:eid(), date, desc:`عمولة تحويل ${desc}`, type:'expense', amount:fee, account:from, category:'عمولة تحويل', isTransfer:true});
  }

  ledger.push(...txs);
  ledger.sort((a,b)=> a.date.localeCompare(b.date) || (a.id>b.id?1:-1));

  els.resetTransfer.click();
  saveLedger();
  txPage = 1;
  render();
  alert('تم تنفيذ التحويل بنجاح.');
}
els.trFrom?.addEventListener('change',()=>syncTransferSelects('from'));
els.trTo?.addEventListener('change',()=>syncTransferSelects('to'));
els.execTransfer?.addEventListener('click',doTransfer);
els.resetTransfer?.addEventListener('click',()=>{
  els.trAmount.value=''; els.trFee.value=''; els.trDate.value=formatLocalDate(new Date()); els.trDesc.value='';
});

/* ===== حساب الأرصدة (لم يتغير) ===== */
function computeBalances(){
  const bal=new Map(); // { 'accountName': balance }
  const after=new Map(); // { 'txId': balanceAfterTx }

  for(const a of accounts){ bal.set(a.name, Number(a.opening||0)); }

  for(const t of ledger){
    const current=bal.get(t.account)||0;
    const amount=Number(t.amount||0);
    const newBal = current + (t.type==='income' ? amount : -amount);
    bal.set(t.account, newBal);
    after.set(t.id, newBal);
  }
  return {bal, after};
}

function drawPerAccount(balances){
  if(!els.perAccount) return;
  els.perAccount.innerHTML = accounts.map(a=>{
    const bal=balances.get(a.name)||0;
    const cls=bal>=0?'pos':'neg';
    return `<div class="item">${escapeHtml(a.name)}: <span class="${cls}">${fmt(bal)} ج.م</span></div>`;
  }).join('');
}

/* ===== الالتزامات الشهرية والتحصيلات (لم يتغير سوى toggle) ===== */
function migrateCommit(c){
  if(!c.payments) c.payments={};
  if(c.firstDue && !c.nextDue){
    const today=startOfToday();
    let due=parseLocalDate(c.firstDue);
    while(due<today){
      const next=addMonthsPreserveDOM(due,1);
      if(c.recurring && (!c.endAt || next<=parseLocalDate(c.endAt))) due=next;
      else break;
    }
    c.nextDue=formatLocalDate(due);
  }
  return c;
}
function migrateCollect(c){
  if(c.firstDue && !c.nextDue){
    const today=startOfToday();
    let due=parseLocalDate(c.firstDue);
    while(due<today){
      const next=addMonthsPreserveDOM(due,1);
      if(c.recurring && (!c.endAt || next<=parseLocalDate(c.endAt))) due=next;
      else break;
    }
    c.nextDue=formatLocalDate(due);
  }
  return c;
}
function addCommitPayment(id, ym, amount){
  const c=commitments.find(x=>x.id===id);
  if(!c) return;
  if(!c.payments) c.payments={};
  c.payments[ym]=(c.payments[ym]||0)+amount;
  saveCommitments();
  drawCommitments(); drawDueSoon();
}

let editCommitId=null;
function drawCommitments(){
  if(!els.tbodyCommit) return;
  els.tbodyCommit.innerHTML=commitments.map(c=>{
    const ym=YM();
    const paid=(c.payments?.[ym]||0);
    const total=Number(c.amount||0);
    const remaining=Math.max(0,total-paid);
    const repeat=c.recurring?'شهرياً':'مرة واحدة';
    const end=c.endAt?c.endAt:'—';
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(total)}</td>
      <td>${c.nextDue||c.firstDue}</td>
      <td class="${paid>0?'pos':'neg'}">${fmt(paid)}</td>
      <td class="${remaining>0?'neg':'pos'}">${fmt(remaining)}</td>
      <td>${repeat}</td>
      <td>${end}</td>
      <td class="actions">
        ${remaining>0?`<button class="btn btn-primary" onclick="payCommit('${c.id}')">سداد</button>`:''}
        <button class="btn btn-outline" onclick="editCommit('${c.id}')">تعديل</button>
        <button class="btn btn-danger" onclick="removeCommit('${c.id}')">حذف</button>
      </td>
    </tr>`;
  }).join('');
  endRequiredToggleCommit();
}

els.addCommitment?.addEventListener('click',()=>{
  const name=els.cName.value.trim();
  const amount=parseFloat(els.cAmount.value);
  const firstDue=els.cFirstDue.value;
  const recurring=els.cRecurring.checked;
  const endAt=els.cEndAt.value;

  if(!name||!amount||amount<=0||isNaN(amount)||!firstDue){
    alert('جميع الحقول إجبارية (باستثناء ينتهي في)'); return;
  }
  if(recurring&&!endAt){
    alert('عند التكرار شهرياً، يجب تحديد تاريخ الانتهاء.'); return;
  }

  const c={id:editCommitId||eid(), name, amount, firstDue, recurring, endAt, payments:{}};
  migrateCommit(c); // لحساب nextDue

  if(editCommitId){
    commitments=commitments.map(x=>x.id===editCommitId?c:x);
  } else {
    commitments.push(c);
  }

  editCommitId=null;
  els.addCommitment.textContent='إضافة/تحديث';
  els.cName.value=''; els.cAmount.value=''; els.cFirstDue.value=''; els.cRecurring.checked=false; els.cEndAt.value='';

  saveCommitments();
  drawCommitments();
  drawDueSoon();
  recalc();
  refreshLinkCommitSelect();
});
window.editCommit=id=>{
  const c=commitments.find(x=>x.id===id);
  if(!c) return;
  editCommitId=id;
  els.addCommitment.textContent='تحديث الالتزام';
  els.cName.value=c.name;
  els.cAmount.value=c.amount;
  els.cFirstDue.value=c.firstDue;
  els.cRecurring.checked=!!c.recurring;
  els.cEndAt.value=c.endAt||'';
  showScreen('card-commit-collect');
  window.scrollTo({top:0,behavior:'smooth'});
  endRequiredToggleCommit();
};
window.removeCommit=id=>{
  if(!confirm('هل تريد حذف هذا الالتزام؟')) return;
  commitments=commitments.filter(c=>c.id!==id);
  ledger=ledger.filter(t=>t.linkCommitId!==id); // حذف الحركات المرتبطة بالالتزام المحذوف
  saveCommitments(); saveLedger();
  drawCommitments(); drawDueSoon(); recalc(); refreshLinkCommitSelect();
};
els.cRecurring?.addEventListener('change',endRequiredToggleCommit);
function endRequiredToggleCommit(){
  if(!els.cEndAtWrap) return;
  els.cEndAtWrap.style.display=els.cRecurring.checked?'block':'none';
  els.cEndAt.required=els.cRecurring.checked;
}

window.payCommit=id=>{
  const c=commitments.find(x=>x.id===id);
  if(!c) return;
  const due=c.nextDue?parseLocalDate(c.nextDue):parseLocalDate(c.firstDue);
  const dateStr=formatLocalDate(due);
  const ym=dateStr.slice(0,7);
  const paid=(c.payments?.[ym]||0);
  const remain=Math.max(0,(Number(c.amount||0)-paid));
  if(remain<=0){ alert('لا يوجد مبلغ متبقٍ لهذا الشهر.'); return; }
  const accName=prompt('ادخل اسم الحساب الذي تريد السحب منه:', accounts.length ? accounts[0].name : '');
  if(!accName || !accounts.some(a=>a.name===accName)) return;

  if(!confirm(`سداد كامل متبقّي الالتزام "${c.name}" بقيمة ${fmt(remain)} ج.م من "${accName}" بتاريخ ${dateStr}؟`)) return;

  const tx={
    id:eid(),
    date:dateStr,
    desc:`${c.name} (سداد التزام)`,
    type:'expense',
    amount:remain,
    account:accName,
    category:'التزامات شهرية',
    linkCommitId:c.id
  };

  ledger.push(tx);
  saveLedger();
  addCommitPayment(c.id, ym, remain);
  txPage = 1;
  render();
};

let editCollectId=null;
function drawCollections(){
  if(!els.tbodyCollect) return;
  els.tbodyCollect.innerHTML=collections.map(c=>{
    const repeat=c.recurring?'شهرياً':'مرة واحدة';
    const end=c.endAt?c.endAt:'—';
    const due=c.nextDue||c.firstDue;
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${due}</td>
      <td>${repeat}</td>
      <td>${end}</td>
      <td class="actions">
        <button class="btn btn-primary" onclick="collectNow('${c.id}')">تم التحصيل</button>
        <button class="btn btn-outline" onclick="editCollect('${c.id}')">تعديل</button>
        <button class="btn btn-danger" onclick="removeCollect('${c.id}')">حذف</button>
      </td>
    </tr>`;
  }).join('');
  endRequiredToggleCollect();
}

els.addCollect?.addEventListener('click',()=>{
  const name=els.coName.value.trim();
  const amount=parseFloat(els.coAmount.value);
  const firstDue=els.coFirstDue.value;
  const recurring=els.coRecurring.checked;
  const endAt=els.coEndAt.value;

  if(!name||!amount||amount<=0||isNaN(amount)||!firstDue){
    alert('جميع الحقول إجبارية (باستثناء ينتهي في)'); return;
  }
  if(recurring&&!endAt){
    alert('عند التكرار شهرياً، يجب تحديد تاريخ الانتهاء.'); return;
  }

  const c={id:editCollectId||eid(), name, amount, firstDue, recurring, endAt};
  migrateCollect(c); // لحساب nextDue

  if(editCollectId){
    collections=collections.map(x=>x.id===editCollectId?c:x);
  } else {
    collections.push(c);
  }

  editCollectId=null;
  els.addCollect.textContent='إضافة/تحديث';
  els.coName.value=''; els.coAmount.value=''; els.coFirstDue.value=''; els.coRecurring.checked=false; els.coEndAt.value='';

  saveCollections();
  drawCollections();
  drawDueSoon();
  recalc();
});
window.editCollect=id=>{
  const c=collections.find(x=>x.id===id);
  if(!c) return;
  editCollectId=id;
  els.addCollect.textContent='تحديث التحصيل';
  els.coName.value=c.name;
  els.coAmount.value=c.amount;
  els.coFirstDue.value=c.firstDue;
  els.coRecurring.checked=!!c.recurring;
  els.coEndAt.value=c.endAt||'';
  showScreen('card-commit-collect');
  window.scrollTo({top:0,behavior:'smooth'});
  endRequiredToggleCollect();
};
window.removeCollect=id=>{
  if(!confirm('هل تريد حذف هذا التحصيل؟')) return;
  collections=collections.filter(c=>c.id!==id);
  saveCollections();
  drawCollections(); drawDueSoon(); recalc();
};
window.collectNow=id=>{
  const c=collections.find(x=>x.id===id);
  if(!c) return;
  const accName=prompt('ادخل اسم الحساب الذي تم التحصيل فيه:', accounts.length ? accounts[0].name : '');
  if(!accName || !accounts.some(a=>a.name===accName)) return;

  const due=c.nextDue?parseLocalDate(c.nextDue):parseLocalDate(c.firstDue);
  const dateStr=formatLocalDate(new Date());

  if(!confirm(`هل تم تحصيل "${c.name}" بقيمة ${fmt(c.amount)} ج.م في حساب "${accName}" بتاريخ اليوم (${dateStr})؟`)) return;

  const tx={
    id:eid(),
    date:dateStr,
    desc:`${c.name} (تحصيل)`,
    type:'income',
    amount:Number(c.amount||0),
    account:accName,
    category:'تحصيلات شهرية',
    linkCollectId:c.id // يتم الحفظ للإشارة إلى أنه تم التحصيل
  };

  // تحديث nextDue للموعد القادم قبل الحفظ
  if(c.recurring){
    const next=addMonthsPreserveDOM(due,1);
    if(c.endAt && next > parseLocalDate(c.endAt)){
      alert(`انتهت دورة التحصيل لـ "${c.name}". سيتم حذفها.`);
      collections=collections.filter(x=>x.id!==id);
    } else {
      c.nextDue=formatLocalDate(next);
    }
  } else {
    collections=collections.filter(x=>x.id!==id); // حذف التحصيل لمرة واحدة
  }

  ledger.push(tx);
  saveLedger();
  saveCollections();
  txPage = 1;
  render();
  alert('تم إضافة حركة التحصيل بنجاح.');
};

els.coRecurring?.addEventListener('change',endRequiredToggleCollect);
function endRequiredToggleCollect(){
  if(!els.coEndAtWrap) return;
  els.coEndAtWrap.style.display=els.coRecurring.checked?'block':'none';
  els.coEndAt.required=els.coRecurring.checked;
}

// ... (باقي دوال التقارير والملخص لم تتغير)

/* ===== وظيفة الرسم الشاملة ===== */
function render(){
  // 1. تحديث قوائم الحسابات والفئات
  drawAccounts();
  drawCategories();
  drawCommitments();
  drawCollections();
  // 2. تحديث جدول الحركات
  renderTxTable();
  // 3. إعادة حساب الملخص
  recalc();
  // 4. إعادة رسم التقارير
  getMonthlyData();
  renderMonthlyTable();
  drawChart();

  // تحديث شاشة إضافة حركة (لتحديث قائمة الالتزامات بعد أي تغيير)
  refreshLinkCommitSelect();
}

/* ===== تهيئة ===== */
function init(){
  // تطبيق الثيم
  const savedTheme = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
  applyTheme(savedTheme);

  if(accounts.length===0){
    accounts=[{name:'كاش',opening:0},{name:'حساب بنكي',opening:0},{name:'محفظة',opening:0}];
    saveAccounts();
  }
  ensureBaseCategories();
  commitments=commitments.map(c=>migrateCommit(c));
  collections=collections.map(c=>migrateCollect(c));
  saveCommitments(); saveCollections();
  ensureTransferCategories();

  if(els.monthPicker){
    const today=YM();
    if(!els.monthPicker.value) els.monthPicker.value=today;
    els.monthPicker.setAttribute('max', today);
  }
  els.date.value=formatLocalDate(new Date());
  els.trDate.value=formatLocalDate(new Date());

  ghLoadCfg();

  // تفعيل الشاشة الافتراضية
  showScreen('card-overview');

  render();
}
// ... (باقي دوال المزامنة و PWA لم تتغير)

window.addEventListener('load',init);
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</body>
</html>
