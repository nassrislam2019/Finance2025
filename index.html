<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساباتي</title>
<meta name="theme-color" content="#0b1220" id="themeColorMeta" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
/* ====== الوضع الليلي الافتراضي (Dark Theme) ====== */
:root{
  --bg:#0b1220;
  --card:#0f172a;
  --muted:#94a3b8;
  --txt:#e5e7eb;
  --brand:#0369a1;
  --brand-2:#0ea5e9;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#22c55e;
  --border:#1f2a44;
  --radius:12px;
  --field-h:42px;
  --shadow:0 8px 24px rgba(2,6,23,0.5);
  --sync-idle: #0c1a2f; 
  --sync-syncing: #0d2a45;
  --sync-success: #1a3224;
  --sync-danger: #351c1c;
  --table-row-bg: linear-gradient(180deg,#071226,#0b162a);
  --table-row-hover-shadow: 0 10px 30px rgba(2,6,23,0.6);
  --table-border-color: var(--border);
  /* ألوان التنقل السفلي */
  --nav-bg: #0f172a;
  --nav-item-color: var(--muted);
  --nav-item-active-color: var(--brand-2);
}

/* ====== الوضع النهاري (Light Theme) ====== */
body.light-theme {
  --bg: #f8fafc;
  --card: #ffffff;
  --muted: #64748b;
  --txt: #1e293b;
  --brand: #0369a1;
  --brand-2: #0ea5e9;
  --danger: #ef4444;
  --warn: #f59e0b;
  --ok: #22c55e;
  --border: #e2e8f0;
  --shadow: 0 4px 12px rgba(0,0,0,0.08);
  --sync-idle: #f1f5f9;
  --sync-syncing: #f0f9ff;
  --sync-success: #f0fff4;
  --sync-danger: #fff5f5;
  --table-row-bg: #ffffff;
  --table-row-hover-shadow: 0 4px 12px rgba(0,0,0,0.1);
  --table-border-color: #e2e8f0;
  /* ألوان التنقل السفلي */
  --nav-bg: #ffffff;
  --nav-item-color: var(--muted);
  --nav-item-active-color: var(--brand-2);
  background:
    radial-gradient(1200px 600px at 100% -10%, rgba(14,165,233,.05), transparent 70%),
    radial-gradient(900px 500px at -10% 100%, rgba(3,105,161,.06), transparent 70%),
    var(--bg);
}

/* خطوط */
body,h1,h2,h3,h4,h5,h6,p,div,span,li,a,button{font-family:"Cairo",sans-serif !important;}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 100% -10%, rgba(14,165,233,.10), transparent 70%),
    radial-gradient(900px 500px at -10% 100%, rgba(3,105,161,.12), transparent 70%),
    var(--bg); 
  color:var(--txt);
  transition: background-color 0.3s, color 0.3s;
  /* إضافة مسافة في الأسفل لـ Navigation Bar */
  padding-bottom: 60px; /* ارتفاع شريط التنقل */
}
.container{
  max-width:1180px;
  margin-inline:auto;
  padding:20px;
  /* ضبط المساحة العلوية للـ Toolbar */
  padding-top: 80px; 
}

/* Header and Toolbar (Fixed) */
header {
    position: fixed;
    top: 0;
    right: 0;
    left: 0;
    z-index: 100;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 10px 20px;
    box-shadow: var(--shadow);
}
header .container {
    padding: 0;
    max-width: 1180px;
    margin: auto;
}
header .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.title {
    font-weight: 900;
    font-size: 22px;
    color: var(--txt);
}
.header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}
.btn-toggle-theme {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    font-size: 15px;
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 999px;
    transition: all 0.2s;
}

/* ====== Navigation Bar ====== */
.nav-bar {
    position: fixed;
    bottom: 0;
    right: 0;
    left: 0;
    z-index: 1000;
    height: 60px;
    background: var(--nav-bg);
    border-top: 1px solid var(--border);
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-around;
    padding-top: 4px;
}
body.light-theme .nav-bar {
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
}
.nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 600;
    color: var(--nav-item-color);
    cursor: pointer;
    transition: color 0.2s;
    user-select: none;
}
.nav-item i {
    font-size: 20px;
    margin-bottom: 2px;
}
.nav-item.active {
    color: var(--nav-item-active-color);
}
/* إخفاء تسمية العناصر في شاشات سطح المكتب */
@media (min-width: 720px) {
    .nav-item span {
        display: none;
    }
    .nav-item i {
        font-size: 24px;
        margin: 0;
    }
    .nav-bar {
        width: 100px;
        height: auto;
        top: 80px;
        bottom: auto;
        left: 0;
        right: auto;
        flex-direction: column;
        border-top: none;
        border-right: 1px solid var(--border);
        box-shadow: none;
        padding: 10px 0;
        background: transparent;
    }
    .container {
        /* إزاحة المحتوى عن الشريط الجانبي */
        padding-right: 120px; 
    }
    header {
        /* إزاحة الـ Header عن الشريط الجانبي */
        right: 100px; 
    }
}
/* ====== Page Management ====== */
.page {
    display: none;
}
.page.active {
    display: block;
}

/* Cards */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:0; overflow:hidden; box-shadow:var(--shadow);
  transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
  margin-top: 12px;
}
.card-head{
  display:flex;align-items:center;justify-content:space-between;padding:12px 14px;
  background:linear-gradient(135deg, rgba(3,105,161,.55), rgba(14,165,233,.12));
  border-bottom:1px solid var(--border);
}
body.light-theme .card-head {
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(3, 105, 161, 0.05));
    border-bottom-color: #f1f5f9;
}
.card-head h3{margin:0;font-size:18px;color:var(--txt)} 
.card-body{padding:14px}
.card.collapsed .card-body{display:none}
.toggle{appearance:none;border:none;background:transparent;cursor:pointer;border-radius:10px;font-size:18px;padding:6px 10px;color:var(--muted)}

/* Layout */
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,textarea{
  width:100%;background:var(--bg);
  color:var(--txt);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none;height:var(--field-h);
  transition: background-color 0.3s, border-color 0.3s, color 0.3s;
}
body.light-theme input, body.light-theme select, body.light-theme textarea { background: #f1f5f9; }
.btn-primary{background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff;border:1px solid rgba(14,165,233,.35)}
.hr{height:1px;background:var(--border);opacity:.7;margin:12px 0;border-radius:999px}
.btn{
  appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer;
  transition:transform .06s ease, opacity .15s,height .08s ease;font-size:13px;height:36px;
}
.btn:hover:not(:disabled){opacity:.95;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--txt);padding:8px 10px}
body.light-theme .btn-outline { border-color: #cbd5e1; color: #334155; }
.btn-danger{background:linear-gradient(180deg,#ef4444,#d02626);color:#fff;border:1px solid rgba(235,75,75,0.15)}
.btn-muted{background:transparent;color:var(--muted);border:1px dashed var(--border);padding:8px 10px}
.actions .btn{height:30px;padding:6px 8px;font-size:13px;border-radius:8px}
.actions .btn-outline{border-color:var(--border);color:var(--txt)}
.stats{display:grid;gap:10px}
@media(min-width:720px){.stats{grid-template-columns:repeat(5,1fr)}}
.stat{
  background:var(--card); 
  border:1px solid var(--border);border-radius:var(--radius);padding:14px; text-align:center;
  box-shadow:var(--shadow)
}
body.light-theme .stat { background: #f1f5f9; }
.stat small{color:var(--muted)}
.stat .num{font-weight:800;font-size:22px;margin-top:4px;color:var(--txt)}
.pos{color:#34d399}.neg{color:#fb7185}
.list-plain{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.list-plain .item{
  background:var(--card); 
  border:1px solid var(--border);padding:14px;border-radius:var(--radius);
  text-align:center;box-shadow:var(--shadow);font-weight:700;color:var(--txt)
}
body.light-theme .list-plain .item { background: #f1f5f9; }
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.spacer{flex:1}
.badge{
    display:inline-flex;gap:6px;align-items:center;
    background:var(--bg); 
    color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:var(--field-h);
    transition: background-color 0.3s, border-color 0.3s, color 0.3s;
}
body.light-theme .badge { background: #f1f5f9; }
.badge-group{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
.d-none{display:none!important;}

/* تنسيقات المزامنة */
#sync-card-v2 .card-head h3 i {margin-left: 8px; font-size: 1.1em;}
.sync-status-display {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: var(--radius); /* توحيد باستخدام متغير الكارد */
    margin-bottom: 12px;
    border: 1px solid var(--border);
    font-weight: 600;
    transition: all 0.3s ease;
}
.sync-status-display i { margin-left: 12px; font-size: 1.5em; } /* لمسة جمالية: زيادة حجم الأيقونة */
.status-idle {background-color: var(--sync-idle); color: var(--muted);}
.status-syncing {background-color: var(--sync-syncing); color: var(--brand-2); border-color: var(--brand-2);} /* لمسة جمالية: تحديد لون الإطار */
.status-success {background-color: var(--sync-success); color: var(--ok);}
.status-error {background-color: var(--sync-danger); color: var(--danger);}

/* لمسة جمالية: إضافة تأثير نبض خفيف لحالة المزامنة */
@keyframes pulse-sync {
    0% { box-shadow: 0 0 0 0px var(--brand-2); }
    50% { box-shadow: 0 0 0 6px rgba(14, 165, 233, 0.2); }
    100% { box-shadow: 0 0 0 0px rgba(14, 165, 233, 0.0); }
}
.sync-status-display.status-syncing {
    animation: pulse-sync 1.5s infinite ease-out;
    border-color: var(--brand-2);
}

/* لمسة جمالية: تحسين مظهر زر المزامنة الأساسي */
#sync-card-v2 .toolbar .btn-primary {
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(3, 105, 161, 0.5);
}
#sync-card-v2 .toolbar .btn-primary:hover {
    box-shadow: 0 6px 16px rgba(3, 105, 161, 0.7);
    transform: translateY(-2px);
}

/* لمسة جمالية: تحسين زر تبديل الوضع */
.btn-toggle-theme:hover {
    color: var(--brand-2);
    border-color: var(--brand-2);
    background: rgba(14, 165, 233, 0.1);
}

/* تصميم كارت إعدادات GitHub المتقدم */
#card-github { margin-top: 12px; }
#card-github .card-body .grid-3 { grid-template-columns: 1fr 1fr auto; }
#card-github .card-body input { font-size: 12px; }
#card-github .card-body .badge { height: auto; }
#card-github .card-body .btn { height: 36px; }

</style>
</head>
<body id="appBody">

<header>
  <div class="container">
    <div class="toolbar">
      <div class="title" id="pageTitle">دفتر حساباتي - الرئيسية</div>
      <div class="header-actions">
        <button id="toggleThemeBtn" class="btn btn-toggle-theme" type="button" title="تبديل الوضع"><i class="fas fa-sun"></i></button>
        <button id="installBtn" class="btn btn-primary" type="button" style="display:none">تثبيت</button>
      </div>
    </div>
  </div>
</header>

<div class="container" id="pagesContainer">
    
    <div class="page active" id="page-home">
        <section class="card" id="card-balance" data-lock="true">
            <div class="card-head"><h3>ملخص الحسابات</h3></div>
            <div class="card-body">
              <div class="stats">
                <div class="stat"><small>إجمالي الأرصدة</small><div id="totalBalance" class="num">0</div></div>
                <div class="stat"><small>إجمالي التزامات الشهر الحالي</small><div id="monthCommitTotal" class="num neg">0</div></div>
                <div class="stat"><small>إجمالي مبالغ تحت التحصيل (الشهر الحالي)</small><div id="currentMonthCollections" class="num pos">0</div></div>
                <div class="stat"><small>التزامات الشهر القادم (شامل متبقي الحالي)</small><div id="nextCommitWithCarry" class="num neg">0</div></div>
                <div class="stat"><small>إجمالي مبالغ تحت التحصيل الشهر القادم</small><div id="nextMonthCollections" class="num pos">0</div></div>
              </div>
              <div class="hr"></div>
              <div>
                <h3 style="margin:0 0 8px;font-size:14px;color:var(--muted)">تفاصيل الأرصدة بالحساب</h3>
                <div id="perAccount" class="list-plain"></div>
              </div>
            </div>
        </section>

        <section class="card" id="card-dueSoon">
            <div class="card-head">
              <h3>استحقاقات قريبة</h3>
              <div class="badge-group">
                <span id="dueTotalBadge" class="badge" title="إجمالي المتبقّي لهذا الشهر">إجمالي: 0.00 ج.م</span>
                <span id="dueNextTotalBadge" class="badge" title="إجمالي الاستحقاقات للشهر القادم">الشهر القادم: 0.00 ج.م</span>
              </div>
            </div>
            <div class="card-body">
              <div id="dueSoonWrap">
                <table style="width:100%">
                  <thead><tr><th>الاسم</th><th>التاريخ</th><th>الأصل</th><th>المدفوع</th><th>المتبقي</th><th>الحالة</th><th>إجراءات</th></tr></thead>
                  <tbody id="tbodyDueSoon"></tbody>
                </table>
              </div>
              <div id="dueSoonCards"></div>
              <div id="noDueSoon" class="d-none" style="color:var(--muted)">لا توجد استحقاقات هذا الشهر غير مسددة.</div>
            </div>
        </section>

        <section class="card" id="sync-card-v2">
            <div class="card-head">
                <h3><i class="fas fa-cloud-upload-alt"></i> حالة مزامنة GitHub</h3>
            </div>
            <div class="card-body">
                <div id="syncStatusDisplayV2" class="sync-status-display status-idle">
                    <i id="syncIconV2" class="fas fa-clock"></i>
                    <span id="syncMessageV2">الإعدادات محفوظة محلياً. اضغط **مزامنة الآن** للبدء.</span>
                </div>
                <div class="toolbar">
                    <button id="syncPushBtnV2" class="btn btn-primary" type="button" title="رفع البيانات الحالية إلى GitHub">مزامنة الآن (رفع)</button>
                    <button id="syncPullBtnV2" class="btn btn-outline" type="button" title="تحميل البيانات من GitHub واستبدال المحلي">تحميل من GitHub</button>
                    <span class="spacer"></span>
                    <span id="syncLastTimeV2" class="badge">آخر تحديث: —</span>
                    <button class="btn btn-outline" onclick="toggleCard('card-github')">الإعدادات المتقدمة</button>
                </div>
                <div style="margin-top:8px;color:var(--muted);font-size:12px;text-align:right;">
                     <span id="syncConfigInfo">المستودع: — / الفرع: main</span>
                </div>
            </div>
        </section>

        <section class="card collapsed" id="card-github" data-collapsible>
            <div class="card-head"><h3>إعدادات GitHub المتقدمة</h3></div>
            <div class="card-body">
                <div class="grid grid-2">
                    <div><label>GitHub Token (شخصي)</label><input id="ghToken" type="password" placeholder="ghp_..." /></div>
                    <div><label>Gist ID (المعرّف)</label><input id="ghGistId" placeholder="المعرّف في GitHub Gist" /></div>
                </div>
                <div class="grid grid-2" style="margin-top:10px">
                    <div><label>اسم الملف (اختياري)</label><input id="ghFilename" placeholder="finance.json" /></div>
                    <div class="checkbox-row" style="margin-top:22px"><input id="ghAuto" type="checkbox"/><label for="ghAuto" style="margin:0">مزامنة تلقائيًا بعد كل تعديل</label></div>
                </div>
                <div class="grid grid-2" style="margin-top:22px">
                    <button id="ghSaveCfg" class="btn btn-outline">حفظ الإعدادات</button>
                    <button id="ghTest" class="btn btn-outline">اختبار الاتصال</button>
                </div>
                <div style="margin-top:8px;color:var(--muted);font-size:12px">⚠️ الـ Token محفوظ محليًا في جهازك فقط.</div>
            </div>
        </section>
        
    </div>

    <div class="page" id="page-txs">
        <section class="card" id="card-addtx" data-collapsible>
            <div class="card-head"><h3>إضافة حركة</h3><button class="toggle" onclick="toggleCard('card-addtx')" aria-expanded="false" title="عرض/إخفاء">▾</button></div>
            <div class="card-body">
              <div class="grid grid-3">
                <div><label>النوع</label><select id="type"><option value="income">دخل</option><option value="expense" selected>مصروف</option></select></div>
                <div><label>المبلغ (ج.م)</label><input id="amount" type="number" step="0.01" placeholder="0.00" /></div>
                <div><label>التاريخ</label><input id="date" type="date" /></div>
                <div><label>الوصف</label><input id="desc" type="text" placeholder="مثال: سوبر ماركت" /></div>
                <div><label>الحساب</label><select id="account"></select></div>
                <div><label>الفئة</label><select id="category"></select></div>
                <div><label>ربط الالتزام (اختياري لمصروفات)</label><select id="linkCommit"></select></div>
                <div class="grid grid-2" style="grid-column:1/-1">
                  <button id="saveTx" class="btn btn-primary">حفظ</button>
                  <button id="resetForm" class="btn btn-outline">إفراغ</button>
                </div>
              </div>
            </div>
        </section>
        <div class="hr"></div>
        <section class="card" id="card-txs">
             <div class="card-head"><h3>سجل الحركات</h3><button class="toggle" onclick="toggleCard('card-txs')" aria-expanded="false" title="عرض/إخفاء">▾</button></div>
             <div class="card-body">
                <div class="toolbar" style="margin-bottom:10px">
                    <input id="fSearch" placeholder="بحث بالوصف" />
                    <select id="fType"><option value="all">كل الأنواع</option><option value="income">دخل</option><option value="expense">مصروف</option></select>
                    <select id="fAccount"><option value="all">كل الحسابات</option></select>
                    <input id="fFrom" type="date" title="من تاريخ" />
                    <input id="fTo" type="date" title="إلى تاريخ" />
                </div>
                <div style="overflow:auto">
                    <table>
                        <thead><tr><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>الحساب</th><th>الوصف/الفئة</th><th>الرصيد بعد</th><th>إجراءات</th></tr></thead>
                        <tbody id="tbodyTxs"></tbody>
                    </table>
                </div>
                <div class="toolbar" style="margin-top:10px;justify-content:center">
                    <button id="prevPage" class="btn btn-outline" disabled>السابق</button>
                    <span id="pageInfo" class="badge">صفحة 1 من 1</span>
                    <button id="nextPage" class="btn btn-outline" disabled>التالي</button>
                </div>
             </div>
        </section>
    </div>

    <div class="page" id="page-commitments">
        <section class="card" id="card-commit" data-collapsible>
            <div class="card-head"><h3>إضافة التزام شهري</h3><button class="toggle" onclick="toggleCard('card-commit')" aria-expanded="false" title="عرض/إخفاء">▾</button></div>
            <div class="card-body">
                <div class="grid grid-4">
                    <div><label>اسم الالتزام</label><input id="cName" placeholder="مثال: إيجار، قسط سيارة" /></div>
                    <div><label>المبلغ (ج.م)</label><input id="cAmount" type="number" step="0.01" placeholder="0.00" /></div>
                    <div><label>تاريخ أول استحقاق</label><input id="cFirstDue" type="date" required /></div>
                    <div class="checkbox-row"><input id="cRecurring" type="checkbox" /><label for="cRecurring" style="margin:0">يتكرر شهريًا</label></div>
                    <div style="grid-column:1/span 2"><label>ينتهي في (إجباري عند التكرار)</label><input id="cEndAt" type="date" /></div>
                </div>
                <div class="toolbar" style="margin-top:10px">
                    <button id="addCommitment" class="btn btn-outline">إضافة/تحديث</button>
                    <span class="spacer"></span><span class="badge">يمكن السداد جزئيًا من "إضافة حركة"</span>
                </div>
                <div style="overflow:auto;margin-top:10px">
                    <table style="font-size:13px">
                        <thead><tr>
                            <th>الاسم</th><th>المبلغ</th><th>استحقاق</th><th>مدفوع (الشهر)</th><th>متبقّي</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th>
                        </tr></thead>
                        <tbody id="tbodyCommit"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <div class="page" id="page-settings">
        <section class="card" id="card-reports" data-collapsible>
            <div class="card-head"><h3>تقارير شهرية و رسوم بيانية</h3><button class="toggle" onclick="toggleCard('card-reports')" aria-expanded="false" title="عرض/إخفاء">▾</button></div>
            <div class="card-body">
                <p>محتوى تقارير غير مكتمل في هذا الدمج، يرجى مراجعة الكود الأصلي لـ `حسابات.html`.</p>
            </div>
        </section>
        
        <div class="hr"></div>

        <div class="toolbar" style="justify-content:center;">
             <button id="exportJson" class="btn btn-outline" type="button">تصدير JSON</button>
             <button id="exportCsv" class="btn btn-outline" type="button">تصدير CSV</button>
             <label class="btn btn-muted" for="importFile">استيراد JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
         </div>

        <div class="footer" style="margin-top:24px;color:var(--muted);font-size:12px;text-align:center">
             <div>⚠️ <span class="note" style="color:var(--warn)">تنبيه:</span> كل البيانات محفوظة محليًا في <code>localStorage</code>. لا تنسَ التصدير كنسخة احتياطية.</div>
        </div>
    </div>
    
</div>

<nav class="nav-bar" id="bottomNav">
    <div class="nav-item active" data-page="page-home"><i class="fas fa-home"></i><span>الرئيسية</span></div>
    <div class="nav-item" data-page="page-txs"><i class="fas fa-exchange-alt"></i><span>حركات</span></div>
    <div class="nav-item" data-page="page-commitments"><i class="fas fa-calendar-check"></i><span>التزامات</span></div>
    <div class="nav-item" data-page="page-settings"><i class="fas fa-cog"></i><span>إعدادات</span></div>
</nav>

<script>
// =================== إعداد وتخزين البيانات (مدمج من حسابات2.html) ===================
// تم توحيد هياكل البيانات في كائن 'store' كما في حسابات2.html لتبسيط الإدارة
const STORAGE_KEY = 'pf_ledger_v1_full';
const GH_KEY = 'pf_github_cfg_v1';
const THEME_KEY = 'pf_theme_v1';

let store = {
  transactions: [],
  accounts: [],
  commitments: [],
  collections: [],
  settings: {} // {ghToken, ghGistId, theme}
};
let ghCfg = {}; // تم إبقاء هذا للاستخدام مع واجهة حسابات.html

function loadStore(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) store = JSON.parse(raw);
    const ghRaw = localStorage.getItem(GH_KEY);
    if(ghRaw) ghCfg = JSON.parse(ghRaw);
  }catch(e){
    console.error('loadStore', e);
  }
}
function saveStore(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }
  catch(e){ console.error('saveStore', e); }
}
function saveGhCfg(){
  try{ localStorage.setItem(GH_KEY, JSON.stringify(ghCfg)); }
  catch(e){ console.error('saveGhCfg', e); }
}

loadStore();

// =================== عناصر DOM (تم تعديلها لتناسب حسابات.html) ===================
const els = {
    appBody: document.getElementById('appBody'),
    toggleThemeBtn: document.getElementById('toggleThemeBtn'),
    themeColorMeta: document.getElementById('themeColorMeta'),
    pagesContainer: document.getElementById('pagesContainer'),
    pageTitle: document.getElementById('pageTitle'),
    bottomNav: document.getElementById('bottomNav'),

    // عناصر المزامنة
    syncStatusDisplayV2: document.getElementById('syncStatusDisplayV2'),
    syncIconV2: document.getElementById('syncIconV2'),
    syncMessageV2: document.getElementById('syncMessageV2'),
    syncPushBtnV2: document.getElementById('syncPushBtnV2'),
    syncPullBtnV2: document.getElementById('syncPullBtnV2'),
    syncLastTimeV2: document.getElementById('syncLastTimeV2'),
    syncConfigInfo: document.getElementById('syncConfigInfo'),

    // إعدادات GitHub المتقدمة
    ghToken: document.getElementById('ghToken'),
    ghGistId: document.getElementById('ghGistId'),
    ghSaveCfg: document.getElementById('ghSaveCfg'),
    ghTest: document.getElementById('ghTest'),
    ghFilename: document.getElementById('ghFilename'),
    ghAuto: document.getElementById('ghAuto'),
};

let currentTheme = localStorage.getItem(THEME_KEY) || 'dark';
let activePage = 'page-home';

// =================== مساعدات بسيطة ===================
const fmt = n => Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const YM = (d=new Date()) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
const formatTime = d=>d.toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit',hour12:true});
const escapeHtml = s => String(s).replace(/[&<>"']/g, function (m) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]; });

// =================== دوال الواجهة (UI Functions) ===================

function toggleCard(id) {
    const card = document.getElementById(id);
    if (!card) return;
    card.classList.toggle('collapsed');
    const toggleBtn = card.querySelector('.toggle');
    if (toggleBtn) {
        toggleBtn.textContent = card.classList.contains('collapsed') ? '▸' : '▾';
        toggleBtn.setAttribute('aria-expanded', !card.classList.contains('collapsed'));
    }
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const page = document.getElementById(pageId);
    if (page) page.classList.add('active');

    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
    if (navItem) navItem.classList.add('active');
    
    // تحديث العنوان
    const titleMap = {
        'page-home': 'دفتر حساباتي - الرئيسية',
        'page-txs': 'دفتر حساباتي - الحركات',
        'page-commitments': 'دفتر حساباتي - الالتزامات والتحصيلات',
        'page-settings': 'دفتر حساباتي - الإعدادات',
    };
    if(els.pageTitle) els.pageTitle.textContent = titleMap[pageId] || 'دفتر حساباتي';
    activePage = pageId;
}

// دالة لتحديث حالة المزامنة
function syncStatus(message, statusClass) {
    if (!els.syncStatusDisplayV2 || !els.syncIconV2 || !els.syncMessageV2) return;
    els.syncStatusDisplayV2.className = `sync-status-display ${statusClass}`;
    els.syncMessageV2.innerHTML = message;
    
    // تحديث الأيقونة حسب الحالة
    if (statusClass.includes('syncing')) els.syncIconV2.className = 'fas fa-sync-alt fa-spin';
    else if (statusClass.includes('success')) els.syncIconV2.className = 'fas fa-check-circle';
    else if (statusClass.includes('error')) els.syncIconV2.className = 'fas fa-times-circle';
    else els.syncIconV2.className = 'fas fa-clock';
    
    // إزالة النبض من الحالات الأخرى
    if (!statusClass.includes('syncing')) els.syncStatusDisplayV2.classList.remove('status-syncing');

    // تحديث زر الرفع ليكون غير مفعل أثناء المزامنة
    els.syncPushBtnV2.disabled = statusClass.includes('syncing');
}

// =================== منطق المزامنة (GitHub Gist Sync Logic) ===================
const GH_FILENAME = els.ghFilename?.value || 'finance.json'; // اسم الملف

// ملء نموذج الإعدادات من التخزين
function fillGhFormFromStorage(){
    if(!ghCfg.token) ghCfg.token = '';
    if(!ghCfg.gistId) ghCfg.gistId = '';
    if(!ghCfg.filename) ghCfg.filename = GH_FILENAME;
    if(!ghCfg.auto) ghCfg.auto = false;

    if(els.ghToken) els.ghToken.value = ghCfg.token;
    if(els.ghGistId) els.ghGistId.value = ghCfg.gistId;
    if(els.ghFilename) els.ghFilename.value = ghCfg.filename;
    if(els.ghAuto) els.ghAuto.checked = ghCfg.auto;

    updateSyncCardInfo();
    checkInitialSyncStatus();
}

function updateSyncCardInfo(){
    if(els.syncConfigInfo) els.syncConfigInfo.textContent = `Gist ID: ${ghCfg.gistId||'—'} / الملف: ${ghCfg.filename||GH_FILENAME}`;
}

function checkInitialSyncStatus(){
    if(ghCfg.token && ghCfg.gistId){
        syncStatus('الإعدادات جاهزة. اضغط **مزامنة الآن** لرفع البيانات.', 'status-idle');
    } else {
        syncStatus('لم يتم إعداد المزامنة. يرجى إدخال البيانات في الإعدادات المتقدمة.', 'status-idle');
    }
}

// دالة حفظ إعدادات GitHub
function saveGhSettings(e) {
    e.preventDefault();
    const token = els.ghToken?.value.trim() || '';
    const gistId = els.ghGistId?.value.trim() || '';
    const filename = els.ghFilename?.value.trim() || GH_FILENAME;
    const auto = els.ghAuto?.checked || false;

    if (!token) { alert('يجب إدخال GitHub Token'); return; }

    ghCfg.token = token;
    ghCfg.gistId = gistId;
    ghCfg.filename = filename;
    ghCfg.auto = auto;
    saveGhCfg();

    alert('تم حفظ إعدادات GitHub. يمكنك الآن المزامنة.');
    updateSyncCardInfo();
    checkInitialSyncStatus();
}

// دالة اختبار الاتصال
async function testGhConnection() {
    if (!ghCfg.token) { alert('يجب حفظ GitHub Token أولاً.'); return; }
    syncStatus('اختبار الاتصال...', 'status-syncing');
    try {
        const res = await fetch('https://api.github.com/user/gists', {
            headers: { Authorization: `token ${ghCfg.token}` }
        });
        if (res.ok) {
            syncStatus('تم الاتصال بنجاح مع GitHub.', 'status-success');
        } else {
            throw new Error(`خطأ في المصادقة: ${res.statusText}`);
        }
    } catch (err) {
        syncStatus(`فشل الاتصال: ${err.message}`, 'status-error');
    }
}

// دالة رفع البيانات (Push)
async function ghPush() {
    if (!ghCfg.token) { alert('يرجى حفظ GitHub Token أولاً في الإعدادات المتقدمة.'); return; }
    syncStatus('رفع البيانات قيد التنفيذ...', 'status-syncing');

    try {
        const payload = JSON.stringify(store);
        const url = ghCfg.gistId ? `https://api.github.com/gists/${ghCfg.gistId}` : 'https://api.github.com/gists';
        const method = ghCfg.gistId ? 'PATCH' : 'POST';

        const res = await fetch(url, {
            method: method,
            headers: {
                Authorization: 'token ' + ghCfg.token,
                'Content-Type': 'application/json',
                Accept: 'application/vnd.github+json'
            },
            body: JSON.stringify({
                description: 'دفتر حساباتي - نسخة احتياطية',
                public: false,
                files: {
                    [ghCfg.filename]: { content: payload }
                }
            })
        });

        if (!res.ok) throw new Error('فشل المزامنة: ' + res.status);
        
        const json = await res.json();
        if (method === 'POST') {
            ghCfg.gistId = json.id;
            saveGhCfg();
            updateSyncCardInfo();
        }

        const now = new Date();
        const lastTime = formatTime(now);
        
        syncStatus('تم رفع البيانات بنجاح.', 'status-success');
        if(els.syncLastTimeV2) els.syncLastTimeV2.textContent = `آخر تحديث: ${lastTime}`;

    } catch (err) {
        syncStatus('خطأ أثناء الرفع: ' + (err.message || 'خطأ غير معروف.'), 'status-error');
        console.error('Push Error:', err);
    }
}

// دالة سحب البيانات (Pull)
async function ghPull() {
    if (!ghCfg.token || !ghCfg.gistId) { alert('يرجى حفظ GitHub Token ومعرّف Gist أولاً.'); return; }
    if (!confirm('سيتم استبدال البيانات المحلية بالبيانات الموجودة على GitHub. هل أنت متأكد؟')) return;

    syncStatus('تحميل البيانات قيد التنفيذ...', 'status-syncing');
    try {
        const res = await fetch(`https://api.github.com/gists/${ghCfg.gistId}`, {
            headers: { Accept: 'application/vnd.github.v3+json', Authorization: `token ${ghCfg.token}` }
        });
        if (!res.ok) throw new Error(`فشل تحميل Gist: ${res.status}`);

        const gist = await res.json();
        const file = gist.files[ghCfg.filename];
        if (!file || !file.raw_url) throw new Error('الملف غير موجود في Gist المحدّد.');
        
        const content = await fetch(file.raw_url).then(r => r.text());
        if (!content) throw new Error('محتوى الملف فارغ.');

        // استبدال المتجر المحلي بالبيانات المستوردة
        store = JSON.parse(content);
        saveStore();
        
        // *هنا يجب إعادة رسم كل عناصر الواجهة* (تم تركها فارغة هنا لعدم اكتمال منطق التطبيق)
        // مثال: renderTransactions(); renderSummary(); showPage(activePage);

        const now = new Date(gist.updated_at);
        const lastTime = formatTime(now);

        syncStatus('تم استيراد البيانات بنجاح.', 'status-success');
        if(els.syncLastTimeV2) els.syncLastTimeV2.textContent = `آخر تحديث: ${lastTime}`;

    } catch (err) {
        syncStatus('خطأ أثناء الاستيراد: ' + (err.message || 'خطأ غير معروف.'), 'status-error');
        console.error('Pull Error:', err);
    }
}

// =================== تهيئة وتوصيل الأحداث ===================

// تبديل الوضع
function setTheme(theme){
    if(!els.appBody || !els.toggleThemeBtn) return;
    currentTheme = theme;
    localStorage.setItem(THEME_KEY, theme);
    if(theme === 'light'){
        els.appBody.classList.add('light-theme');
        els.toggleThemeBtn.innerHTML = '<i class="fas fa-moon"></i>';
        els.toggleThemeBtn.title = 'الوضع الليلي';
        if(els.themeColorMeta) els.themeColorMeta.content = '#f8fafc';
    } else {
        els.appBody.classList.remove('light-theme');
        els.toggleThemeBtn.innerHTML = '<i class="fas fa-sun"></i>';
        els.toggleThemeBtn.title = 'الوضع النهاري';
        if(els.themeColorMeta) els.themeColorMeta.content = '#0b1220';
    }
}
setTheme(currentTheme); // تطبيق الوضع المحفوظ عند التحميل

els.toggleThemeBtn?.addEventListener('click', ()=>{
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
});

// التنقل بين الصفحات
els.bottomNav?.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        showPage(item.dataset.page);
    });
});

// توصيل أزرار المزامنة
els.syncPushBtnV2?.addEventListener('click', ghPush);
els.syncPullBtnV2?.addEventListener('click', ghPull);

// توصيل أزرار إعدادات GitHub المتقدمة
els.ghSaveCfg?.addEventListener('click', saveGhSettings);
els.ghTest?.addEventListener('click', testGhConnection);

// تهيئة النموذج والإعدادات عند بدء التشغيل
fillGhFormFromStorage();

// إظهار الصفحة الافتراضية
showPage(activePage);

// تهيئة إخفاء/إظهار الإعدادات المتقدمة
document.getElementById('card-github').querySelector('.toggle').textContent = document.getElementById('card-github').classList.contains('collapsed') ? '▸' : '▾';

</script>
</body>
</html>
