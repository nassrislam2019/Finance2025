<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</title>
<meta name="theme-color" content="#0b1220" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0b1220;
  --card:#0f172a;
  --muted:#94a3b8;
  --txt:#e5e7eb;
  --brand:#0369a1;
  --brand-2:#0ea5e9;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#22c55e;
  --border:#1f2a44;
  --radius:12px;
  --shadow:0 8px 24px rgba(2,6,23,0.4);
}
html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:'Cairo',sans-serif;}
header{background:var(--card);padding:1rem;box-shadow:var(--shadow);display:flex;justify-content:space-between;align-items:center;}
h1{margin:0;color:var(--brand-2);}
.btn{background:var(--brand);border:none;color:white;padding:.5rem 1rem;border-radius:var(--radius);cursor:pointer;}
.btn:hover{background:var(--brand-2);}
.card{background:var(--card);border-radius:var(--radius);padding:1rem;margin-bottom:1rem;box-shadow:var(--shadow);}
.nav{display:flex;border-bottom:1px solid var(--border);}
.nav-btn{padding:.75rem 1.25rem;color:var(--muted);cursor:pointer;}
.nav-btn.active{color:var(--brand-2);border-bottom:2px solid var(--brand-2);}
.tab-content{display:none;}
.tab-content.active{display:block;}
table{width:100%;border-collapse:collapse;}
th,td{padding:.75rem;border-bottom:1px solid var(--border);}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:100;}
.modal .card{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;}
</style>
</head>
<body>

<header>
  <h1>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</h1>
  <div style="display:flex;gap:10px;">
    <button id="btnThemeToggle" class="btn">ğŸŒ™</button>
    <button id="btnSettings" class="btn">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  </div>
</header>

<main>
  <div class="nav">
    <div class="nav-btn active" data-tab="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="nav-btn" data-tab="transactions">Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
    <div class="nav-btn" data-tab="commitments">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</div>
    <div class="nav-btn" data-tab="collections">Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª</div>
    <div class="nav-btn" data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
  </div>

  <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <div id="tab-home" class="tab-content active">
    <div class="card"><h2>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ</h2><p id="totalBalance">0</p></div>
  </div>

  <!-- Ø§Ù„Ø­Ø±ÙƒØ§Øª -->
  <div id="tab-transactions" class="tab-content">
    <div class="card">
      <h2>Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</h2>
      <form id="transactionForm">
        <div>
          <label>Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="type"><option>Ø¯Ø®Ù„</option><option>Ù…ØµØ±ÙˆÙ</option><option>ØªØ­ÙˆÙŠÙ„</option></select>
        </div>
        <div>
          <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
          <input type="number" id="amount" required min="0.01">
        </div>
        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="date" required>
        </div>
        <div>
          <label>Ø§Ù„Ø­Ø³Ø§Ø¨</label>
          <input type="text" id="account">
        </div>
        <button class="btn">Ø­ÙØ¸</button>
      </form>
    </div>
    <div class="card">
      <h2>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
      <table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody id="transactionsList"></tbody></table>
    </div>
  </div>

  <!-- Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª -->
  <div id="tab-commitments" class="tab-content">
    <div class="card">
      <h2>Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ²Ø§Ù… Ø´Ù‡Ø±ÙŠ</h2>
      <form id="commitmentForm">
        <input type="text" id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…" required>
        <input type="number" id="cAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" required>
        <input type="date" id="cDate" required>
        <button class="btn">Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</button>
      </form>
    </div>
    <div class="card">
      <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</h2>
      <ul id="commitmentsList"></ul>
    </div>
  </div>
<!-- Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª -->
  <div id="tab-collections" class="tab-content">
    <div class="card">
      <h2>Ø¥Ø¶Ø§ÙØ© ØªØ¬Ù…ÙŠØ¹ Ø´Ù‡Ø±ÙŠ</h2>
      <form id="collectionForm">
        <input type="text" id="coName" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ¬Ù…ÙŠØ¹" required>
        <input type="number" id="coAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" required>
        <input type="date" id="coDate" required>
        <button class="btn">Ø­ÙØ¸ Ø§Ù„ØªØ¬Ù…ÙŠØ¹</button>
      </form>
    </div>
    <div class="card">
      <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª</h2>
      <ul id="collectionsList"></ul>
    </div>
  </div>

  <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
  <div id="tab-reports" class="tab-content">
    <div class="card">
      <h2>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
      <input type="month" id="reportMonthPicker" />
      <button id="btnGenerateReport" class="btn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      <canvas id="chartMonthly"></canvas>
    </div>
  </div>
</main>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª -->
<div id="accountModal" class="modal">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
      <button id="closeAccountModal" class="btn btn-danger">X</button>
    </div>
    <form id="accountForm">
      <input type="text" id="accountName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨" required>
      <input type="number" id="accountOpening" placeholder="Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ" min="0" step="0.01" required>
      <button class="btn">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„</button>
    </form>
    <ul id="manageAccountsList"></ul>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div id="settingsModal" class="modal">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h2>
      <button id="closeSettingsModal" class="btn btn-danger">X</button>
    </div>
    <hr>
    <h3>Ù…Ø²Ø§Ù…Ù†Ø© GitHub Gist</h3>
    <form id="ghSyncForm">
      <label>Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ (Token)</label>
      <input type="text" id="ghToken" placeholder="ghp_..." required>
      <label>Ù…Ø¹Ø±Ù‘Ù Gist (ID)</label>
      <input type="text" id="ghGistId" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯">
      <div class="grid grid-2" style="margin-top:1rem;">
        <button type="submit" id="btnSaveGhSettings" class="btn">ğŸ’¾ Ø­ÙØ¸</button>
        <button type="button" id="btnGhPush" class="btn btn-ok">â¬†ï¸ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†</button>
        <button type="button" id="btnGhPull" class="btn">â¬‡ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Gist</button>
      </div>
    </form>
  </div>
</div>
<script>
// =================== Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===================
const STORAGE_KEY = 'pf_ledger_v1_full';
let store = {
  transactions: [],   // {id,date,type:'Ø¯Ø®Ù„'|'Ù…ØµØ±ÙˆÙ'|'ØªØ­ÙˆÙŠÙ„',amount,account,accountTo?,category?,notes?}
  accounts: [],       // {id,name,opening}
  commitments: [],    // {id,name,amount,firstDue,recurring,endAt?,payments:{'YYYY-MM':num}}
  collections: [],    // {id,name,amount,firstDue,recurring,endAt?}
  settings: {}        // {ghToken, ghGistId, theme}
};

function loadStore(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) store = JSON.parse(raw);
  }catch(e){
    console.error('loadStore', e);
  }
}
function saveStore(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }
  catch(e){ console.error('saveStore', e); }
}
loadStore();

// =================== Ø¹Ù†Ø§ØµØ± DOM ===================
const navBtns = document.querySelectorAll('.nav-btn');
const tabContents = document.querySelectorAll('.tab-content');

const transactionForm = document.getElementById('transactionForm');
const transactionsList = document.getElementById('transactionsList');
const typeEl = document.getElementById('type');
const amountEl = document.getElementById('amount');
const dateEl = document.getElementById('date');
const accountEl = document.getElementById('account');

const commitmentForm = document.getElementById('commitmentForm');
const commitmentsList = document.getElementById('commitmentsList');

const collectionForm = document.getElementById('collectionForm');
const collectionsList = document.getElementById('collectionsList');

const reportMonthPicker = document.getElementById('reportMonthPicker');
const btnGenerateReport = document.getElementById('btnGenerateReport');
const chartCanvas = document.getElementById('chartMonthly');

const accountModal = document.getElementById('accountModal');
const accountForm = document.getElementById('accountForm');
const manageAccountsList = document.getElementById('manageAccountsList');

const btnSettings = document.getElementById('btnSettings');
const settingsModal = document.getElementById('settingsModal');
const closeSettingsModal = document.getElementById('closeSettingsModal');
const ghSyncForm = document.getElementById('ghSyncForm');
const ghToken = document.getElementById('ghToken');
const ghGistId = document.getElementById('ghGistId');
const btnGhPush = document.getElementById('btnGhPush');
const btnGhPull = document.getElementById('btnGhPull');

const btnOpenAccountForm = document.getElementById('btnOpenAccountForm');
const closeAccountModal = document.getElementById('closeAccountModal');

const totalBalanceEl = document.getElementById('totalBalance');
const btnThemeToggle = document.getElementById('btnThemeToggle');

// Chart instance
let monthlyChart = null;

// =================== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø¨Ø³ÙŠØ·Ø© ===================
const uid = ()=>Date.now().toString(36) + Math.random().toString(36).slice(2,8);
const fmt = n => Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const YM = (d=new Date()) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
const parseDate = s => s ? new Date(s+'T00:00:00') : null;

// =================== ØªØ¨ÙˆÙŠØ¨Ø§Øª ===================
navBtns.forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    navBtns.forEach(b=>b.classList.remove('active'));
    tabContents.forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    const t = document.getElementById('tab-'+btn.dataset.tab);
    if(t) t.classList.add('active');
    // Ù„Ùˆ Ø¯Ø®Ù„Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ø±Ø³Ù…
    if(btn.dataset.tab==='reports'){ if(!reportMonthPicker.value) reportMonthPicker.value = YM(); drawMonthly(); }
  });
});

// =================== Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ===================
function ensureDefaultAccounts(){
  if(store.accounts.length===0){
    store.accounts = [
      {id:uid(), name:'ÙƒØ§Ø´', opening:0},
      {id:uid(), name:'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ', opening:0},
      {id:uid(), name:'Ù…Ø­ÙØ¸Ø©', opening:0}
    ];
    saveStore();
  }
}
ensureDefaultAccounts();

function renderAccountsList(){
  manageAccountsList.innerHTML = '';
  if(store.accounts.length===0){ manageAccountsList.innerHTML = '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª.</li>'; return; }
  store.accounts.forEach(acc=>{
    const li = document.createElement('li');
    li.innerHTML = `${escapeHtml(acc.name)} Â· Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ: ${fmt(acc.opening)} 
      <button class="btn" data-id="${acc.id}" style="margin-left:8px">ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn btn-danger" data-delete="${acc.id}">Ø­Ø°Ù</button>`;
    manageAccountsList.appendChild(li);
  });
  // ØªØ­Ø±ÙŠØ± / Ø­Ø°Ù
  manageAccountsList.querySelectorAll('button[data-id]').forEach(b=>{
    b.addEventListener('click', e=>{
      const id = b.getAttribute('data-id');
      const acc = store.accounts.find(a=>a.id===id);
      if(!acc) return;
      document.getElementById('accountName').value = acc.name;
      document.getElementById('accountOpening').value = acc.opening;
      // Ø­ÙØ¸ Ø¹Ù†Ø¯ submit Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ø¶Ø§ÙØ©
      accountForm.dataset.editId = id;
      accountModal.style.display = 'block';
    });
  });
  manageAccountsList.querySelectorAll('button[data-delete]').forEach(b=>{
    b.addEventListener('click', e=>{
      const id = b.getAttribute('data-delete');
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ (Ù„Ù† ØªØ­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©)')) return;
      store.accounts = store.accounts.filter(a=>a.id!==id);
      saveStore(); renderAccountsList(); refreshAccountSelects(); render();
    });
  });
}
renderAccountsList();

accountForm.addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('accountName').value.trim();
  const opening = parseFloat(document.getElementById('accountOpening').value||0);
  if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'); return; }
  const editId = accountForm.dataset.editId;
  if(editId){
    const a = store.accounts.find(x=>x.id===editId);
    if(a){ a.name = name; a.opening = opening; delete accountForm.dataset.editId; }
  } else {
    store.accounts.push({id:uid(), name, opening});
  }
  saveStore(); renderAccountsList(); refreshAccountSelects(); accountModal.style.display='none';
});

// ÙØªØ­/Ø§ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø­Ø³Ø§Ø¨Ø§Øª
btnOpenAccountForm?.addEventListener('click', ()=>{ accountModal.style.display='block'; });
closeAccountModal?.addEventListener('click', ()=>{ accountModal.style.display='none'; });

// =================== Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ùˆ ÙØ¦Ø§Øª (simplified) ===================
function refreshAccountSelects(){
  const opts = store.accounts.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
  if(accountEl) accountEl.innerHTML = opts;
}
refreshAccountSelects();

// =================== Ø§Ù„Ø­Ø±ÙƒØ§Øª (transactions) ===================
function renderTransactions(){
  transactionsList.innerHTML = '';
  const month = YM(dateEl.value ? parseDate(dateEl.value) : new Date());
  const rows = store.transactions
                 .filter(t=> t.date && t.date.startsWith(month))
                 .sort((a,b)=> b.date.localeCompare(a.date) || b.id.localeCompare(a.id));
  if(rows.length===0){
    transactionsList.innerHTML = `<tr class="no-data-row"><td colspan="3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>`;
    return;
  }
  transactionsList.innerHTML = rows.map(t=>{
    const typeText = t.type;
    const acc = t.type==='ØªØ­ÙˆÙŠÙ„' ? `${escapeHtml(t.account)} â†’ ${escapeHtml(t.accountTo||'')}` : escapeHtml(t.account||'â€”');
    const amt = (t.type==='Ù…ØµØ±ÙˆÙ' ? '-' : t.type==='Ø¯Ø®Ù„' ? '+' : '') + fmt(t.amount);
    return `<tr>
      <td>${escapeHtml(t.date)}</td>
      <td>${typeText}</td>
      <td>${amt}</td>
    </tr>`;
  }).join('');
}
renderTransactions();

transactionForm.addEventListener('submit', e=>{
  e.preventDefault();
  const type = typeEl.value;
  const amount = parseFloat(amountEl.value||0);
  const date = dateEl.value;
  const account = accountEl.value || (store.accounts[0]?.name||'');
  if(!amount || !date){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ÙˆØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­ÙŠÙ†'); return; }

  if(type === 'ØªØ­ÙˆÙŠÙ„'){
    // for UI simplicity this form currently doesn't ask 'accountTo' - if needed can extend
    const toAcc = prompt('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ¬Ù‡Ø© (Ø§ÙƒØªØ¨Ù‡ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª):');
    if(!toAcc){ alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨ ÙˆØ¬Ù‡Ø©'); return; }
    store.transactions.push({id:uid(), date, type:'Ù…ØµØ±ÙˆÙ', amount, account, notes:`ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ${toAcc}`});
    store.transactions.push({id:uid(), date, type:'Ø¯Ø®Ù„', amount, account:toAcc, notes:`ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯ Ù…Ù† ${account}`});
  } else {
    store.transactions.push({id:uid(), date, type, amount, account});
  }
  saveStore(); transactionForm.reset(); dateEl.value = new Date().toISOString().slice(0,10); renderTransactions(); renderSummary();
});

// =================== Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (commitments) ===================
function renderCommitments(){
  commitmentsList.innerHTML = '';
  if(store.commitments.length===0){ commitmentsList.innerHTML = '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>'; return; }
  store.commitments.forEach(c=>{
    const paidThisMonth = (c.payments && c.payments[YM(new Date())]) || 0;
    const remain = Math.max(0, c.amount - paidThisMonth);
    const li = document.createElement('li');
    li.innerHTML = `${escapeHtml(c.name)} â€” Ø£ØµÙ„ ${fmt(c.amount)} â€” Ù…ØªØ¨Ù‚ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ${fmt(remain)}
      <button class="btn" data-pay="${c.id}" style="margin-left:8px">Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¢Ù†</button>
      <button class="btn btn-danger" data-del="${c.id}">Ø­Ø°Ù</button>`;
    commitmentsList.appendChild(li);
  });
  commitmentsList.querySelectorAll('button[data-pay]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-pay');
      payCommit(id);
    });
  });
  commitmentsList.querySelectorAll('button[data-del]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-del');
      if(!confirm('Ø­Ø°Ù Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…ØŸ')) return;
      store.commitments = store.commitments.filter(x=>x.id!==id);
      saveStore(); renderCommitments(); renderSummary();
    });
  });
}
function payCommit(id){
  const c = store.commitments.find(x=>x.id===id);
  if(!c) return;
  const ym = YM(new Date());
  const paid = (c.payments && c.payments[ym]) || 0;
  const remain = Math.max(0, c.amount - paid);
  if(remain<=0){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ù‚ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±'); return; }
  const acc = prompt('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¯Ø¯ Ù…Ù†Ù‡:') || (store.accounts[0]?.name||'');
  if(!acc){ alert('Ù„Ø§Ø¨Ø¯ Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨'); return; }
  // Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ù…ØµØ±ÙˆÙ
  store.transactions.push({id:uid(), date: formatDateForTx(c.firstDue||new Date()), type:'Ù…ØµØ±ÙˆÙ', amount:remain, account:acc, notes:`Ø³Ø¯Ø§Ø¯ ${c.name}`});
  c.payments = c.payments || {};
  c.payments[ym] = (c.payments[ym]||0) + remain;
  // ØªØ­Ø¯ÙŠØ« nextDue Ø¥Ù† ÙƒØ§Ù† Ù…ØªÙƒØ±Ø±
  if(c.recurring){
    const next = addMonthsPreserveDOM(c.firstDue, 1);
    c.firstDue = next;
  }else{
    // Ù„Ù… ÙŠØªÙƒØ±Ø±ØŒ Ù†Ø­Ø°Ù
    store.commitments = store.commitments.filter(x=>x.id!==id);
  }
  saveStore(); renderCommitments(); renderTransactions(); renderSummary();
}
commitmentForm.addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('cName').value.trim();
  const amount = parseFloat(document.getElementById('cAmount').value||0);
  const firstDue = document.getElementById('cDate').value;
  if(!name || !amount || !firstDue){ alert('Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©'); return; }
  store.commitments.push({id:uid(), name, amount, firstDue, recurring:false, payments:{}});
  saveStore(); commitmentForm.reset(); renderCommitments(); renderSummary();
});
renderCommitments();

// =================== Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª (collections) ===================
function renderCollections(){
  collectionsList.innerHTML = '';
  if(store.collections.length===0){ collectionsList.innerHTML = '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø´Ù‡Ø±ÙŠØ©.</li>'; return; }
  store.collections.forEach(c=>{
    const li = document.createElement('li');
    li.innerHTML = `${escapeHtml(c.name)} â€” ${fmt(c.amount)} â€” ØªØ­ØµÙŠÙ„ ÙÙŠ ${escapeHtml(c.firstDue||'â€”')}
      <button class="btn" data-collect="${c.id}" style="margin-left:8px">ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„</button>
      <button class="btn btn-danger" data-del="${c.id}">Ø­Ø°Ù</button>`;
    collectionsList.appendChild(li);
  });
  collectionsList.querySelectorAll('button[data-collect]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-collect');
      collectNow(id);
    });
  });
  collectionsList.querySelectorAll('button[data-del]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-del');
      if(!confirm('Ø­Ø°Ù Ø§Ù„ØªØ¬Ù…ÙŠØ¹ØŸ')) return;
      store.collections = store.collections.filter(x=>x.id!==id);
      saveStore(); renderCollections(); renderTransactions(); renderSummary();
    });
  });
}
function collectNow(id){
  const c = store.collections.find(x=>x.id===id);
  if(!c) return;
  const acc = prompt('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªØ­ØµÙ„ ÙÙŠÙ‡ Ø§Ù„Ù…Ø¨Ù„Øº:') || (store.accounts[0]?.name||'');
  if(!acc){ alert('Ø­Ø¯Ø¯ Ø­Ø³Ø§Ø¨'); return; }
  const date = c.firstDue || new Date().toISOString().slice(0,10);
  store.transactions.push({id:uid(), date, type:'Ø¯Ø®Ù„', amount:c.amount, account:acc, notes:`ØªØ­ØµÙŠÙ„ ${c.name}`});
  // advance or remove
  if(c.recurring){
    c.firstDue = addMonthsPreserveDOM(c.firstDue, 1);
  } else {
    store.collections = store.collections.filter(x=>x.id!==id);
  }
  saveStore(); renderCollections(); renderTransactions(); renderSummary();
}
collectionForm.addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('coName').value.trim();
  const amount = parseFloat(document.getElementById('coAmount').value||0);
  const firstDue = document.getElementById('coDate').value;
  if(!name || !amount || !firstDue){ alert('Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©'); return; }
  store.collections.push({id:uid(), name, amount, firstDue, recurring:false});
  saveStore(); collectionForm.reset(); renderCollections(); renderSummary();
});
renderCollections();

// =================== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø§Ù„Ø±Ø³Ù…) ===================
function aggregateMonth(month){
  const txs = store.transactions.filter(t=> t.date && t.date.startsWith(month));
  const inc = txs.filter(t=>t.type==='Ø¯Ø®Ù„').reduce((s,t)=>s+t.amount,0);
  const exp = txs.filter(t=>t.type==='Ù…ØµØ±ÙˆÙ').reduce((s,t)=>s+t.amount,0);
  return {inc, exp};
}
function drawMonthly(){
  const month = reportMonthPicker.value || YM();
  const agg = aggregateMonth(month);
  // destroy previous chart
  if(monthlyChart){ monthlyChart.destroy(); monthlyChart = null; }
  monthlyChart = new Chart(chartCanvas.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: ['Ø¯Ø®Ù„','Ù…ØµØ±ÙˆÙ'],
      datasets:[{data:[agg.inc, agg.exp], backgroundColor:['#22c55e','#ef4444']}]
    },
    options:{plugins:{legend:{position:'top'}}}
  });
  // Ø§Ø­Ø³Ø¨ ÙˆØ§Ø­Ø· Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø³ÙŠØ·Ø©
  const statsUl = document.getElementById('reportStatsList');
  if(statsUl) statsUl.innerHTML = `<li>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯Ø®Ù„: ${fmt(agg.inc)}</li><li>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ØµØ±ÙˆÙ: ${fmt(agg.exp)}</li><li>Ø§Ù„ØµØ§ÙÙŠ: ${fmt(agg.inc-agg.exp)}</li>`;
}
btnGenerateReport?.addEventListener('click', drawMonthly);

// =================== Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ ÙˆØ§Ù„Ø±ØµÙŠØ¯ ===================
function calculateAccountBalance(accountName){
  const acc = store.accounts.find(a=>a.name===accountName);
  const opening = acc ? Number(acc.opening||0) : 0;
  const inc = store.transactions.filter(t=>t.type==='Ø¯Ø®Ù„' && t.account===accountName).reduce((s,t)=>s+t.amount,0);
  const exp = store.transactions.filter(t=>t.type==='Ù…ØµØ±ÙˆÙ' && t.account===accountName).reduce((s,t)=>s+t.amount,0);
  return opening + inc - exp;
}
function calculateTotalBalance(){
  return store.accounts.reduce((s,a)=>s + calculateAccountBalance(a.name), 0);
}
function renderSummary(){
  if(totalBalanceEl) totalBalanceEl.textContent = fmt(calculateTotalBalance());
}
renderSummary();

// =================== Utils small ===================
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
function formatDateForTx(d){ if(!d) return new Date().toISOString().slice(0,10); if(typeof d==='string') return d.slice(0,10); return formatDate(d); }
function formatDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function addMonthsPreserveDOM(dStr, months){
  if(!dStr) return dStr;
  const parts = dStr.split('-').map(n=>parseInt(n));
  const dt = new Date(parts[0], parts[1]-1, parts[2]||1);
  const day = dt.getDate();
  dt.setMonth(dt.getMonth()+months);
  if(dt.getDate() !== day){ dt.setDate(0); }
  return formatDate(dt);
}

// =================== Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ ===================
function loadTheme(){
  const t = store.settings?.theme || localStorage.getItem('theme') || 'dark';
  if(t==='light'){ document.body.classList.add('light'); btnThemeToggle.textContent='â˜€ï¸'; }
  else { document.body.classList.remove('light'); btnThemeToggle.textContent='ğŸŒ™'; }
}
btnThemeToggle?.addEventListener('click', ()=>{
  const isLight = document.body.classList.toggle('light');
  btnThemeToggle.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
});
loadTheme();

// =================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub Gist ===================
function fillGhFormFromStorage(){
  ghToken.value = store.settings?.ghToken || '';
  ghGistId.value = store.settings?.ghGistId || '';
}
ghSyncForm?.addEventListener('submit', (e)=>{
  e.preventDefault();
  store.settings = store.settings || {};
  store.settings.ghToken = ghToken.value.trim();
  store.settings.ghGistId = ghGistId.value.trim() || null;
  saveStore();
  alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub Ù…Ø­Ù„ÙŠÙ‹Ø§.');
});
btnGhPush?.addEventListener('click', async ()=>{
  try{
    if(!store.settings?.ghToken && !ghToken.value){ alert('Ø£Ø¯Ø®Ù„ Token Ø£ÙˆÙ„Ø§Ù‹'); return; }
    store.settings.ghToken = store.settings.ghToken || ghToken.value.trim();
    saveStore();
    const payload = JSON.stringify({...store, exportedAt:new Date().toISOString()}, null, 2);
    const fileName = 'my-finance-data.json';
    if(store.settings.ghGistId){
      // ØªØ­Ø¯ÙŠØ«
      const res = await fetch(`https://api.github.com/gists/${store.settings.ghGistId}`, {
        method:'PATCH',
        headers:{ Authorization: 'token '+store.settings.ghToken, 'Content-Type':'application/json', Accept:'application/vnd.github+json' },
        body: JSON.stringify({ files: { [fileName]: { content: payload } } })
      });
      if(!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Gist: ' + res.status);
      alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Gist Ø¨Ù†Ø¬Ø§Ø­.');
    } else {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
      const res = await fetch('https://api.github.com/gists', {
        method:'POST',
        headers:{ Authorization: 'token '+store.settings.ghToken, 'Content-Type':'application/json', Accept:'application/vnd.github+json' },
        body: JSON.stringify({ public:false, description:'my-finance backup', files: { [fileName]: { content: payload } } })
      });
      if(!res.ok) throw new Error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Gist: ' + res.status);
      const json = await res.json();
      store.settings.ghGistId = json.id; saveStore(); ghGistId.value = json.id;
      alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Gist ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù.');
    }
  }catch(err){ alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + (err.message||err)); console.error(err); }
});
btnGhPull?.addEventListener('click', async ()=>{
  try{
    const id = ghGistId.value.trim() || store.settings?.ghGistId;
    if(!id){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù‘Ù Gist'); return; }
    const token = store.settings?.ghToken || ghToken.value.trim();
    if(!token){ alert('Ø£Ø¯Ø®Ù„ Token'); return; }
    const res = await fetch(`https://api.github.com/gists/${id}`, {
      headers:{ Authorization: 'token '+token, Accept:'application/vnd.github+json' }
    });
    if(!res.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Gist: ' + res.status);
    const json = await res.json();
    const files = json.files || {};
    const file = files['my-finance-data.json'] || Object.values(files)[0];
    if(!file) throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ØµØ§Ù„Ø­ ÙÙŠ Gist.');
    const content = typeof file.content === 'string' ? file.content : (file.raw_url ? await fetch(file.raw_url).then(r=>r.text()) : null);
    if(!content) throw new Error('Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº.');
    const imported = JSON.parse(content);
    // ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„Ù„Ø¯Ù…Ø¬ Ø¨Ø¯Ù„ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„)
    store = imported;
    saveStore();
    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… ÙƒÙ„ Ø´ÙŠØ¡
    refreshAccountSelects();
    renderAccountsList();
    renderTransactions();
    renderCommitments();
    renderCollections();
    renderSummary();
    alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Gist.');
  }catch(err){ alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + (err.message||err)); console.error(err); }
});

// =================== ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª ===================
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
btnSettings?.addEventListener('click', ()=>{
  settingsModal.style.display = 'block';
  fillGhFormFromStorage();
});
closeSettingsModal?.addEventListener('click', ()=>settingsModal.style.display = 'none');
window.addEventListener('click', (ev)=>{ if(ev.target === settingsModal) settingsModal.style.display = 'none'; });

// Ø­Ø³Ø§Ø¨Ø§Øª
// already wired above for open/close

// =================== ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© ===================
(function init(){
  // set default date today
  dateEl.value = new Date().toISOString().slice(0,10);
  reportMonthPicker.value = YM();
  // ensure defaults
  ensureDefaultAccounts();
  refreshAccountSelects();
  renderAccountsList();
  renderTransactions();
  renderCommitments();
  renderCollections();
  renderSummary();
  fillGhFormFromStorage();
})();
</script>