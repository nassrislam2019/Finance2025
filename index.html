<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</title>

  <!-- Cairo font -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  <!-- Tailwind CDN (Play) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Cairo', 'sans-serif']
          },
          colors: {
            brand: '#0b84ff'
          }
        }
      }
    }
  </script>

  <style>
    /* Small local tweaks */
    html,body { height:100%; }
    body { font-family: Cairo, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", Tahoma, Arial; }
    /* Fix table overflow on small screens */
    .table-fixed { overflow:auto; }
    /* Collapsible caret rotation */
    .toggle-rot { transform: rotate(90deg); transition: transform .18s ease; }
    .toggle-rot.open { transform: rotate(270deg); }
    /* Mobile bottom nav */
    .mobile-nav { display:none; }
    @media(max-width:768px){
      .sidebar { display:none; }
      .mobile-nav { display:flex; }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

<script>
(function(){
  'use strict';

  /* ===== Keys & safe parser ===== */
  const KEY='pf_ledger_v3', ACC_KEY='pf_accounts_v3', CAT_KEY='pf_categories_v3', COM_KEY='pf_commitments_v3', COL_KEY='pf_collections_v3', THEME_KEY='pf_theme_v3';
  function safeParse(k, fallback){ try{ const s=localStorage.getItem(k); if(!s) return fallback; return JSON.parse(s); }catch(e){ console.warn('corrupt',k); localStorage.removeItem(k); return fallback; } }
  function persist(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){ console.error(e); } }

  /* ===== State ===== */
  let ledger = safeParse(KEY, []);
  let accounts = safeParse(ACC_KEY, []);
  let categories = safeParse(CAT_KEY, []);
  let commitments = safeParse(COM_KEY, []);
  let collections = safeParse(COL_KEY, []);
  ensureDefaults();

  /* ===== Utils ===== */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const eid = ()=> Math.random().toString(36).slice(2,9) + Date.now().toString(36);
  const fmt = n => Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
  function parseDateYmd(s){ if(!s) return null; const p=s.split('-').map(Number); if(p.length<3) return null; return new Date(p[0],p[1]-1,p[2]); }
  function formatYmd(d){ if(!d) return ''; const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function toISOLocalDatetime(date){ const t = new Date(date); const tz = t.getTimezoneOffset()*60000; return new Date(t - tz).toISOString().slice(0,16); }

  /* ===== Defaults ===== */
  function ensureDefaults(){
    if(!accounts.length){ accounts = [{name:'ÙƒØ§Ø´',opening:0},{name:'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ',opening:0},{name:'Ù…Ø­ÙØ¸Ø©',opening:0}]; persist(ACC_KEY, accounts); }
    if(!categories.length){
      categories = [
        {name:'Ù…Ø±ØªØ¨',type:'income'},{name:'Ø¯Ø®Ù„ Ø¢Ø®Ø±',type:'income'},
        {name:'Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨',type:'expense'},{name:'Ù…ÙˆØ§ØµÙ„Ø§Øª',type:'expense'},{name:'ÙÙˆØ§ØªÙŠØ±',type:'expense'},{name:'ØªØ³ÙˆÙ‚',type:'expense'}
      ];
      persist(CAT_KEY, categories);
    }
  }

  /* ===== Sorted ledger caching ===== */
  let sortedLedger = [], isLedgerDirty = true;
  function markDirty(){ isLedgerDirty = true; }
  function ensureSorted(){
    if(!isLedgerDirty && sortedLedger.length) return;
    sortedLedger = [...ledger].slice().sort((a,b)=>{
      const aKey = (a.exec||a.created||a.date||'');
      const bKey = (b.exec||b.created||b.date||'');
      if(aKey === bKey) return (b.created||'').localeCompare(a.created||'');
      return bKey.localeCompare(aKey);
    });
    isLedgerDirty = false;
  }

  /* ===== Balances calculation ===== */
  let cachedBalances = null, cachedAfter = null;
  function computeBalances(){
    ensureSorted();
    const bal = new Map(accounts.map(a=>[a.name, Number(a.opening||0)]));
    const after = new Map();
    for(const t of sortedLedger){
      const cur = bal.get(t.account) ?? 0;
      const delta = t.type === 'income' ? Number(t.amount||0) : -Number(t.amount||0);
      const next = cur + delta;
      bal.set(t.account, next);
      after.set(t.id, next);
    }
    cachedBalances = bal; cachedAfter = after;
    return {bal,after};
  }

  /* ===== Commitments state derived from ledger (single source of truth) ===== */
  function addMonthsPreserve(date, months){
    const d = new Date(date.getTime());
    const targetMonth = d.getMonth() + months;
    const day = d.getDate(), y = d.getFullYear();
    const temp = new Date(y, targetMonth+1, 0);
    const lastDay = temp.getDate();
    d.setMonth(targetMonth, Math.min(day, lastDay));
    d.setHours(0,0,0,0);
    return d;
  }

  function getCommitmentState(c){
    // returns { done:boolean, currentDueYm, paid, remaining }
    if(!c || !c.firstDue) return {done:true};
    const amount = Number(c.amount||0);
    const start = parseDateYmd(c.firstDue);
    if(!start) return {done:true};
    const endDate = c.endAt ? parseDateYmd(c.endAt) : null;
    // aggregate payments per ym from ledger where linkCommitId === c.id
    const payments = {};
    for(const t of ledger){
      if(t.linkCommitId !== c.id) continue;
      const ym = (t.exec||t.created||t.date||'').slice(0,7);
      if(!ym) continue;
      payments[ym] = (payments[ym]||0) + Number(t.amount||0);
    }
    let cursor = new Date(start.getTime()); cursor.setHours(0,0,0,0);
    for(let i=0;i<240;i++){ // guard
      if(endDate && cursor > endDate) return {done:true};
      const ym = formatYmd(cursor).slice(0,7);
      const paidThis = payments[ym]||0;
      if(paidThis + 1e-9 < amount){
        return {done:false, currentDueYm: ym, paid: paidThis, remaining: Math.max(0, amount - paidThis)};
      }
      if(!c.recurring) return {done:true};
      cursor = addMonthsPreserve(cursor,1);
    }
    return {done:true};
  }

  /* ===== Collections helper ===== */
  function collectedCollectionsForYm(ym){
    let total = 0;
    for(const t of ledger){
      if(t.type !== 'income') continue;
      const when = (t.exec||t.created||t.date||'').slice(0,7);
      if(when !== ym) continue;
      if(t.sourceCollectionId && String(t.sourceCollectionId).startsWith('collect_')) total += Number(t.amount||0);
    }
    return total;
  }

  /* ===== UI: build layout (HTML) ===== */
  document.body.innerHTML = `
  <div class="flex h-screen" style="direction:rtl">
    <aside class="sidebar w-64 bg-white dark:bg-gray-800 shadow-xl flex flex-col p-4 hidden md:flex">
      <div class="flex items-center gap-3 mb-6">
        <h1 id="appTitle" class="text-2xl font-bold text-brand">Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</h1>
      </div>
      <nav class="flex-1">
        <ul class="space-y-2">
          <li><a href="#dashboard" data-page="dashboard" class="nav-link block p-2 rounded-lg bg-gray-100 dark:bg-gray-700 font-semibold">Ù„ÙˆØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a></li>
          <li><a href="#transactions" data-page="transactions" class="nav-link block p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Ø§Ù„Ø­Ø±ÙƒØ§Øª</a></li>
          <li><a href="#add" data-page="add" class="nav-link block p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</a></li>
          <li><a href="#management" data-page="management" class="nav-link block p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a></li>
          <li><a href="#commitments" data-page="commitments" class="nav-link block p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</a></li>
        </ul>
      </nav>
      <div class="mt-4">
        <button id="darkToggle" class="w-full text-left p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>
      </div>
    </aside>

    <main class="flex-1 p-6 overflow-auto">
      <!-- Mobile nav -->
      <div class="mobile-nav fixed bottom-4 left-1/2 -translate-x-1/2 bg-white dark:bg-gray-800 border rounded-xl px-3 py-2 shadow-md z-50 md:hidden flex gap-2">
        <button data-page="dashboard" class="nav-link px-3 py-2 rounded">ğŸ </button>
        <button data-page="transactions" class="nav-link px-3 py-2 rounded">ğŸ“‹</button>
        <button data-page="add" class="nav-link px-3 py-2 rounded bg-brand text-white">+</button>
        <button data-page="management" class="nav-link px-3 py-2 rounded">âš™ï¸</button>
      </div>

      <!-- Sections -->
      <section id="dashboard-section" class="page-section">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-extrabold">Ù„ÙˆØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
          <div class="flex items-center gap-3">
            <div id="summaryBalance" class="text-sm text-gray-500 dark:text-gray-300"></div>
            <div id="summaryAfter" class="text-sm text-gray-500 dark:text-gray-300"></div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <small class="text-sm text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©</small>
            <div id="totalBalance" class="text-2xl font-bold mt-2">0.00 Ø¬.Ù…</div>
          </div>

          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <small class="text-sm text-gray-500 dark:text-gray-400">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</small>
            <div id="balanceAfter" class="text-2xl font-bold mt-2">0.00 Ø¬.Ù…</div>
            <div class="text-xs text-gray-400 mt-2">Ø§Ù„Ø£Ø³Ø§Ø³: Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¢Ù† - Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø± + Ù…Ø§ Ù„Ù… ÙŠÙØ­ØµÙ‘ÙÙ„ Ù…Ù† Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</div>
          </div>

          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <small class="text-sm text-gray-500 dark:text-gray-400">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</small>
            <div id="monthLabel" class="text-xl font-bold mt-2"></div>
          </div>
        </div>

        <!-- Grid two by two -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <div class="flex justify-between items-center">
              <div>
                <div class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                <div id="commitThis_total" class="text-xl font-bold mt-2">0.00 Ø¬.Ù…</div>
                <div class="text-xs text-gray-400">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="commitThis_remain">0.00</span></div>
              </div>
            </div>
          </div>

          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <div class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div id="collectThis_total" class="text-xl font-bold mt-2">0.00 Ø¬.Ù…</div>
            <div class="text-xs text-gray-400">Ù„Ù… ÙŠÙØ­ØµÙ‘Ù„: <span id="collectThis_remain">0.00</span></div>
          </div>

          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <div class="text-sm text-gray-500">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù… (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ)</div>
            <div id="commitNext_total" class="text-xl font-bold mt-2">0.00 Ø¬.Ù…</div>
          </div>

          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <div class="text-sm text-gray-500">ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…</div>
            <div id="collectNext_total" class="text-xl font-bold mt-2">0.00 Ø¬.Ù…</div>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-2 card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <div class="flex justify-between items-center mb-3">
              <div class="font-semibold">Ø¢Ø®Ø± 5 Ø­Ø±ÙƒØ§Øª</div>
              <div class="text-xs text-gray-400">Ù…Ø±ØªØ¨Ø© Ø¨Ø­Ø³Ø¨ ØªÙ†ÙÙŠØ° (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ù‹Ø§)</div>
            </div>
            <div id="latestTx" class="space-y-2"></div>
          </div>

          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <div class="flex justify-between items-center mb-3">
              <div class="font-semibold">Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ù‚Ø±ÙŠØ¨Ø©</div>
              <div class="text-xs text-gray-400">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ùˆ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…</div>
            </div>
            <div id="dueSoonList" class="space-y-2"></div>
            <div class="mt-3">
              <canvas id="pieChart" width="300" height="200"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Transactions -->
      <section id="transactions-section" class="page-section hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-extrabold">Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
        </div>

        <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow mb-4">
          <div class="flex gap-2 flex-wrap mb-3">
            <input id="filterSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØµÙ/Ø§Ù„ÙØ¦Ø©" class="border p-2 rounded flex-1" />
            <select id="filterType" class="border p-2 rounded"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="income">Ø¯Ø®Ù„</option><option value="expense">Ù…ØµØ±ÙˆÙ</option></select>
            <select id="filterAccount" class="border p-2 rounded"></select>
            <input id="filterFrom" type="date" class="border p-2 rounded" />
            <input id="filterTo" type="date" class="border p-2 rounded" />
            <button id="clearFilters" class="px-3 py-2 bg-gray-100 rounded">Ù…Ø³Ø­</button>
          </div>

          <div class="table-fixed overflow-auto">
            <table class="w-full text-right">
              <thead><tr class="text-sm text-gray-500"><th class="p-2">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</th><th class="p-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th class="p-2">Ø§Ù„ÙˆØµÙ</th><th class="p-2">Ø§Ù„ÙØ¦Ø©</th><th class="p-2">Ø§Ù„Ø­Ø³Ø§Ø¨</th><th class="p-2">Ø§Ù„Ù…Ø¨Ù„Øº</th><th class="p-2">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody id="txTableBody"></tbody>
            </table>
          </div>

          <div class="flex items-center justify-center gap-2 mt-3">
            <button id="prevPage" class="px-3 py-2 bg-gray-100 rounded">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <div id="pageInfo" class="text-sm text-gray-500">Ø§Ù„ØµÙØ­Ø© 1</div>
            <button id="nextPage" class="px-3 py-2 bg-gray-100 rounded">Ø§Ù„ØªØ§Ù„ÙŠ</button>
          </div>
        </div>
      </section>

      <!-- Add -->
      <section id="add-section" class="page-section hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-extrabold">Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</h2>
        </div>

        <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm">Ø§Ù„Ù†ÙˆØ¹</label>
              <select id="add_type" class="border p-2 rounded w-full"><option value="expense">Ù…ØµØ±ÙˆÙ</option><option value="income">Ø¯Ø®Ù„</option></select>
            </div>
            <div>
              <label class="text-sm">Ø§Ù„Ù…Ø¨Ù„Øº</label>
              <input id="add_amount" type="number" step="0.01" class="border p-2 rounded w-full" />
            </div>
            <div>
              <label class="text-sm">ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="add_exec" type="datetime-local" class="border p-2 rounded w-full" />
            </div>

            <div>
              <label class="text-sm">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
              <input id="add_date" type="date" class="border p-2 rounded w-full" />
            </div>
            <div>
              <label class="text-sm">Ø§Ù„Ø­Ø³Ø§Ø¨</label>
              <select id="add_account" class="border p-2 rounded w-full"></select>
            </div>
            <div>
              <label class="text-sm">Ø§Ù„ÙØ¦Ø©</label>
              <select id="add_category" class="border p-2 rounded w-full"></select>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm">Ø§Ù„ÙˆØµÙ</label>
              <input id="add_desc" class="border p-2 rounded w-full" />
            </div>
            <div>
              <label class="text-sm">Ø±Ø¨Ø· Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <select id="add_linkCommit" class="border p-2 rounded w-full"><option value="">â€” Ø¨Ø¯ÙˆÙ† â€”</option></select>
            </div>

            <div class="md:col-span-3 flex gap-2">
              <button id="add_save" class="px-4 py-2 bg-brand text-white rounded">Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©</button>
              <button id="add_reset" class="px-4 py-2 bg-gray-100 rounded">Ø¥ÙØ±Ø§Øº</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Management & Commitments -->
      <section id="management-section" class="page-section hidden">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <h3 class="font-semibold mb-3">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
            <div class="grid grid-cols-1 gap-2 mb-3">
              <input id="acc_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨" class="border p-2 rounded" />
              <input id="acc_open" placeholder="Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ" type="number" class="border p-2 rounded" />
              <div class="flex gap-2">
                <button id="btn_add_acc" class="px-3 py-2 bg-gray-800 text-white rounded">Ø¥Ø¶Ø§ÙØ©</button>
                <button id="btn_refresh_acc" class="px-3 py-2 bg-gray-100 rounded">ØªØ­Ø¯ÙŠØ«</button>
              </div>
            </div>
            <div id="accountsList" class="space-y-2 text-sm"></div>
          </div>

          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <h3 class="font-semibold mb-3">Ø§Ù„ÙØ¦Ø§Øª</h3>
            <div class="grid grid-cols-1 gap-2 mb-3">
              <input id="cat_name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©" class="border p-2 rounded" />
              <select id="cat_type" class="border p-2 rounded"><option value="expense">Ù…ØµØ±ÙˆÙ</option><option value="income">Ø¯Ø®Ù„</option></select>
              <div class="flex gap-2">
                <button id="btn_add_cat" class="px-3 py-2 bg-gray-800 text-white rounded">Ø¥Ø¶Ø§ÙØ©</button>
                <button id="btn_refresh_cat" class="px-3 py-2 bg-gray-100 rounded">ØªØ­Ø¯ÙŠØ«</button>
              </div>
            </div>
            <div id="catsList" class="space-y-2 text-sm"></div>
          </div>
        </div>
      </section>

      <section id="commitments-section" class="page-section hidden mt-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <h3 class="font-semibold mb-3">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
            <div class="grid grid-cols-1 gap-2 mb-3">
              <input id="c_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…" class="border p-2 rounded" />
              <input id="c_amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="border p-2 rounded" />
              <input id="c_first" type="date" class="border p-2 rounded" />
              <div class="flex gap-2 items-center">
                <label class="inline-flex items-center"><input id="c_rec" type="checkbox" class="ml-2"/>ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠÙ‹Ø§</label>
                <input id="c_end" type="date" class="border p-2 rounded" placeholder="ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ" />
              </div>
              <div class="flex gap-2">
                <button id="btn_add_commit" class="px-3 py-2 bg-gray-800 text-white rounded">Ø¥Ø¶Ø§ÙØ©</button>
                <button id="btn_refresh_commit" class="px-3 py-2 bg-gray-100 rounded">ØªØ­Ø¯ÙŠØ«</button>
              </div>
            </div>
            <div id="commitList" class="space-y-2 text-sm"></div>
          </div>

          <div class="card p-4 rounded-lg bg-white dark:bg-gray-800 shadow">
            <h3 class="font-semibold mb-3">Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</h3>
            <div class="grid grid-cols-1 gap-2 mb-3">
              <input id="col_name" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ­ØµÙŠÙ„" class="border p-2 rounded" />
              <input id="col_amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="border p-2 rounded" />
              <input id="col_first" type="date" class="border p-2 rounded" />
              <div class="flex gap-2 items-center">
                <label class="inline-flex items-center"><input id="col_rec" type="checkbox" class="ml-2"/>ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠÙ‹Ø§</label>
                <input id="col_end" type="date" class="border p-2 rounded" placeholder="ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ" />
              </div>
              <div class="flex gap-2">
                <button id="btn_add_col" class="px-3 py-2 bg-gray-800 text-white rounded">Ø¥Ø¶Ø§ÙØ©</button>
                <button id="btn_refresh_col" class="px-3 py-2 bg-gray-100 rounded">ØªØ­Ø¯ÙŠØ«</button>
              </div>
            </div>
            <div id="collectList" class="space-y-2 text-sm"></div>
          </div>
        </div>
      </section>

    </main>
  </div>
  `;

  /* ===== Chart container setup (Chart.js) ===== */
  let pieChart = null;

  /* ===== Render / UI helpers ===== */
  function refreshAccountDisplays(){
    $('#accountsList').innerHTML = accounts.map((a,i)=>`<div class="flex justify-between items-center"><div>${a.name} Â· <span class="text-gray-500">${fmt(a.opening)} Ø¬.Ù…</span></div><div><button data-acc-index="${i}" class="btn-edit-acc text-xs px-2 py-1 bg-gray-100 rounded">ØªØ¹Ø¯ÙŠÙ„</button> <button data-acc-del="${i}" class="btn-del-acc text-xs px-2 py-1 bg-red-100 rounded">Ø­Ø°Ù</button></div></div>`).join('');
    $('#add_account').innerHTML = accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
    $('#filterAccount').innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>` + accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
  }

  function refreshCatDisplays(){
    $('#catsList').innerHTML = categories.map((c,i)=>`<div class="flex justify-between items-center"><div>${c.name} Â· <span class="text-gray-500">${c.type}</span></div><div><button data-cat-index="${i}" class="btn-edit-cat text-xs px-2 py-1 bg-gray-100 rounded">ØªØ¹Ø¯ÙŠÙ„</button> <button data-cat-del="${i}" class="btn-del-cat text-xs px-2 py-1 bg-red-100 rounded">Ø­Ø°Ù</button></div></div>`).join('');
    $('#add_category').innerHTML = categories.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
  }

  function refreshCommitDisplays(){
    $('#commitList').innerHTML = commitments.map(c=>{
      const st = getCommitmentState(c);
      const due = st.done ? 'â€”' : (st.currentDueYm || c.firstDue.slice(0,7));
      const rem = st.done ? 0 : (st.remaining||0);
      return `<div class="flex justify-between items-center"><div><div class="font-semibold">${c.name} Â· ${fmt(c.amount)} Ø¬.Ù…</div><div class="text-xs text-gray-500">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚: ${due}</div></div><div><button data-commit-pay="${c.id}" class="px-2 py-1 bg-green-100 rounded text-xs">Ø³Ø¯Ø§Ø¯</button> <button data-commit-del="${c.id}" class="px-2 py-1 bg-red-100 rounded text-xs">Ø­Ø°Ù</button></div></div>`;
    }).join('');
    // fill add_linkCommit options for current month
    const ym = (new Date()).toISOString().slice(0,7);
    const opts = commitments.filter(c=>{ const st=getCommitmentState(c); return !st.done && st.currentDueYm===ym; }).map(c=>`<option value="${c.id}">${c.name} â€” Ø£ØµÙ„ ${fmt(c.amount)} â€¢ Ù…ØªØ¨Ù‚ÙŠ ${fmt(getCommitmentState(c).remaining||0)}</option>`).join('');
    $('#add_linkCommit').innerHTML = `<option value="">â€” Ø¨Ø¯ÙˆÙ† â€”</option>` + opts;
  }

  function refreshCollectDisplays(){
    $('#collectList').innerHTML = collections.map(c=>{
      return `<div class="flex justify-between items-center"><div><div class="font-semibold">${c.name} Â· ${fmt(c.amount)} Ø¬.Ù…</div><div class="text-xs text-gray-500">Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…: ${(c.nextDue||c.firstDue||'â€”')}</div></div><div><button data-collect-now="${c.id}" class="px-2 py-1 bg-blue-100 rounded text-xs">ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¢Ù†</button> <button data-collect-del="${c.id}" class="px-2 py-1 bg-red-100 rounded text-xs">Ø­Ø°Ù</button></div></div>`;
    }).join('');
  }

  /* Draw Dashboard numbers and charts */
  function drawDashboard(){
    computeBalances();
    let totalBal = 0;
    for(const v of (cachedBalances||new Map()).values()) totalBal += v;
    $('#totalBalance').textContent = fmt(totalBal) + ' Ø¬.Ù…';
    $('#summaryBalance').textContent = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©: ' + fmt(totalBal) + ' Ø¬.Ù…';

    const now = new Date(); const ym = now.toISOString().slice(0,7);
    const next = new Date(now.getFullYear(), now.getMonth()+1,1).toISOString().slice(0,7);

    let commitThis_total = 0, commitThis_remain = 0;
    for(const c of commitments){
      const st = getCommitmentState(c);
      if(!st.done && st.currentDueYm === ym){
        commitThis_total += Number(c.amount||0);
        commitThis_remain += Number(st.remaining||0);
      }
    }

    let collectThis_target = 0;
    for(const c of collections){ const dueYm = (c.nextDue||c.firstDue||'').slice(0,7); if(dueYm === ym) collectThis_target += Number(c.amount||0); }
    const collectedThis = collectedCollectionsForYm(ym);
    const collectThis_not = Math.max(0, collectThis_target - collectedThis);

    let commitNext_total = 0;
    for(const c of commitments){ const st = getCommitmentState(c); if(!st.done && st.currentDueYm === next) commitNext_total += Number(st.remaining||0); }
    let collectNext_total = 0;
    for(const c of collections){ const dueYm = (c.nextDue||c.firstDue||'').slice(0,7); if(dueYm === next) collectNext_total += Number(c.amount||0); }

    const after = totalBal - commitThis_remain + collectThis_not;

    $('#balanceAfter').textContent = fmt(after) + ' Ø¬.Ù…';
    $('#commitThis_total').textContent = fmt(commitThis_total) + ' Ø¬.Ù…';
    $('#commitThis_remain').textContent = fmt(commitThis_remain) + ' Ø¬.Ù…';
    $('#collectThis_total').textContent = fmt(collectThis_target) + ' Ø¬.Ù…';
    $('#collectThis_remain').textContent = fmt(collectThis_not) + ' Ø¬.Ù…';
    $('#commitNext_total').textContent = fmt(commitNext_total) + ' Ø¬.Ù…';
    $('#collectNext_total').textContent = fmt(collectNext_total) + ' Ø¬.Ù…';
    $('#monthLabel').textContent = new Date().toLocaleDateString('ar-EG',{month:'long',year:'numeric'});

    // latest 5
    ensureSorted();
    const latest = sortedLedger.slice(0,5);
    $('#latestTx').innerHTML = latest.map(t=>{
      const execTxt = t.exec ? new Date(t.exec).toLocaleString('ar-EG') : (t.created ? new Date(t.created).toLocaleString('ar-EG') : 'â€”');
      return `<div class="flex justify-between items-center border-b pb-2"><div><div class="font-semibold">${t.desc||'â€”'}</div><div class="text-xs text-gray-500">${t.category||''} â€¢ ${t.account||''}</div></div><div class="text-right"><div class="${t.type==='income'?'text-green-600':'text-red-600'} font-bold">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div><div class="text-xs text-gray-400">${execTxt}</div></div></div>`;
    }).join('');

    // due soon list (this month + next)
    const dueList = commitments.map(c=>{
      const st = getCommitmentState(c);
      if(st.done) return null;
      return { id:c.id, name:c.name, due:st.currentDueYm, remaining:st.remaining };
    }).filter(Boolean).sort((a,b)=> (a.due||'').localeCompare(b.due||''));
    $('#dueSoonList').innerHTML = dueList.slice(0,8).map(d=>`<div class="flex justify-between items-center"><div><div class="font-semibold">${d.name}</div><div class="text-xs text-gray-500">${d.due}</div></div><div class="text-right"><div class="font-bold text-red-600">${fmt(d.remaining)} Ø¬.Ù…</div></div></div>`).join('');

    // pie chart: expense categories this month
    const agg = {};
    for(const t of ledger){
      const when = (t.exec||t.created||t.date||'').slice(0,7);
      if(when !== ym) continue;
      if(t.type !== 'expense') continue;
      const key = t.category || 'ØºÙŠØ± Ù…ØµÙ†Ù';
      agg[key] = (agg[key]||0) + Number(t.amount||0);
    }
    const labels = Object.keys(agg);
    const data = labels.map(l=>agg[l]);
    const ctx = document.getElementById('pieChart').getContext('2d');
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, { type:'pie', data:{ labels, datasets:[{ data, backgroundColor: labels.map((_,i)=>['#ef4444','#f59e0b','#10b981','#0ea5e9','#7c3aed'][i%5]) }] }, options:{plugins:{legend:{position:'bottom'}}} );
  }

  /* ===== Transactions render with paging ===== */
  let pageSize = 10, currentPage = 1;
  function renderTransactions(){
    ensureSorted();
    const q = $('#filterSearch').value.trim().toLowerCase();
    const ft = $('#filterType').value;
    const fa = $('#filterAccount').value;
    const ff = $('#filterFrom').value;
    const fto = $('#filterTo').value;
    const rows = sortedLedger.filter(t=>{
      if(q && !((t.desc||'').toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q))) return false;
      if(ft !== 'all' && t.type !== ft) return false;
      if(fa !== 'all' && t.account !== fa) return false;
      if(ff && (t.date||'') < ff) return false;
      if(fto && (t.date||'') > fto) return false;
      return true;
    });
    const total = rows.length;
    const pages = Math.max(1, Math.ceil(total/pageSize));
    if(currentPage > pages) currentPage = pages;
    const start = (currentPage-1)*pageSize;
    const pageRows = rows.slice(start, start+pageSize);
    $('#txTableBody').innerHTML = pageRows.map(t=>{
      const execTxt = t.exec ? new Date(t.exec).toLocaleString('ar-EG') : (t.created ? new Date(t.created).toLocaleString('ar-EG') : 'â€”');
      return `<tr class="border-b"><td class="p-2 align-top">${execTxt}</td><td class="p-2 align-top">${t.date||'â€”'}</td><td class="p-2 align-top">${t.desc||'â€”'}</td><td class="p-2 align-top">${t.category||'â€”'}</td><td class="p-2 align-top">${t.account||'â€”'}</td><td class="p-2 align-top font-bold ${t.type==='income'?'text-green-600':'text-red-600'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td><td class="p-2 align-top"><button data-edit-id="${t.id}" class="px-2 py-1 bg-gray-100 rounded text-xs">ØªØ¹Ø¯ÙŠÙ„</button> <button data-del-id="${t.id}" class="px-2 py-1 bg-red-100 rounded text-xs">Ø­Ø°Ù</button></td></tr>`;
    }).join('');
    $('#pageInfo').textContent = `Ø§Ù„ØµÙØ­Ø© ${currentPage} Ù…Ù† ${pages} â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${total}`;
  }

  /* ===== Add transaction logic ===== */
  $('#add_save').addEventListener('click', ()=>{
    const type = $('#add_type').value;
    const amount = Number($('#add_amount').value||0);
    const execVal = $('#add_exec').value;
    const exec = execVal ? new Date(execVal).toISOString() : null;
    const date = $('#add_date').value || (exec? new Date(exec).toISOString().slice(0,10): new Date().toISOString().slice(0,10));
    const account = $('#add_account').value;
    const category = $('#add_category').value;
    const desc = $('#add_desc').value || '';
    const linkCommit = $('#add_linkCommit').value || '';
    if(!account || !category || !amount || amount<=0){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨/Ø§Ù„ÙØ¦Ø©/Ø§Ù„Ù…Ø¨Ù„Øº'); return; }
    const tx = { id:eid(), created: new Date().toISOString(), exec: exec || new Date().toISOString(), date: date, desc, type, amount: Number(amount), account, category };
    if(linkCommit && type==='expense'){ tx.linkCommitId = linkCommit; }
    ledger.push(tx); persist(KEY, ledger); markDirty(); renderAll();
    // clear
    $('#add_amount').value=''; $('#add_exec').value=''; $('#add_date').value=''; $('#add_desc').value=''; $('#add_linkCommit').value='';
    gotoPage('transactions');
  });

  $('#add_reset').addEventListener('click', ()=>{
    $('#add_amount').value=''; $('#add_exec').value=''; $('#add_date').value=''; $('#add_desc').value=''; $('#add_linkCommit').value='';
  });

  /* ===== Filters & paging events ===== */
  $('#filterSearch').addEventListener('input', ()=>{ currentPage=1; renderTransactions(); });
  $('#filterType').addEventListener('change', ()=>{ currentPage=1; renderTransactions(); });
  $('#filterAccount').addEventListener('change', ()=>{ currentPage=1; renderTransactions(); });
  $('#filterFrom').addEventListener('change', ()=>{ currentPage=1; renderTransactions(); });
  $('#filterTo').addEventListener('change', ()=>{ currentPage=1; renderTransactions(); });
  $('#clearFilters').addEventListener('click', ()=>{ $('#filterSearch').value=''; $('#filterType').value='all'; $('#filterAccount').value='all'; $('#filterFrom').value=''; $('#filterTo').value=''; currentPage=1; renderTransactions(); });
  $('#prevPage').addEventListener('click', ()=>{ if(currentPage>1) currentPage--; renderTransactions(); });
  $('#nextPage').addEventListener('click', ()=>{ currentPage++; renderTransactions(); });

  /* ===== Global click delegation for edit/delete + commitments/collections actions ===== */
  document.addEventListener('click', (e)=>{
    const del = e.target.closest('[data-del-id]');
    const edit = e.target.closest('[data-edit-id]');
    if(del){ const id = del.getAttribute('data-del-id'); if(confirm('Ø­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')){ ledger = ledger.filter(t=>t.id!==id); persist(KEY, ledger); markDirty(); renderAll(); } }
    if(edit){ const id = edit.getAttribute('data-edit-id'); const tx = ledger.find(t=>t.id===id); if(!tx) return;
      // populate add form and remove old tx (simple edit flow)
      $('#add_type').value = tx.type; $('#add_amount').value = tx.amount; if(tx.exec){ const d=new Date(tx.exec); const tz=d.getTimezoneOffset()*60000; $('#add_exec').value = new Date(d - tz).toISOString().slice(0,16); } else $('#add_exec').value='';
      $('#add_date').value = tx.date || ''; $('#add_account').value = tx.account || ''; $('#add_category').value = tx.category || ''; $('#add_desc').value = tx.desc || ''; $('#add_linkCommit').value = tx.linkCommitId||'';
      if(confirm('Ø³ØªÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©. Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ø¢Ù†. Ù…ÙˆØ§ÙÙ‚ØŸ')){ ledger = ledger.filter(t=>t.id!==id); persist(KEY, ledger); markDirty(); renderAll(); gotoPage('add'); }
    }

    // accounts deletion
    const accDel = e.target.closest('[data-acc-del]');
    if(accDel){ const i = Number(accDel.getAttribute('data-acc-del')); if(confirm('Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ (Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø³ØªØ¨Ù‚Ù‰)')){ accounts.splice(i,1); persist(ACC_KEY, accounts); refreshAccountDisplays(); renderAll(); } }
    // categories deletion
    const catDel = e.target.closest('[data-cat-del]');
    if(catDel){ const i = Number(catDel.getAttribute('data-cat-del')); if(confirm('Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©ØŸ')){ categories.splice(i,1); persist(CAT_KEY, categories); refreshCatDisplays(); renderAll(); } }
    // commit delete
    const commitDel = e.target.closest('[data-commit-del]');
    if(commitDel){ const id = commitDel.getAttribute('data-commit-del'); if(confirm('Ø­Ø°Ù Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…ØŸ (Ø³ØªØ¨Ù‚Ù‰ Ø£ÙŠ Ø¯ÙØ¹Ø§Øª Ø³ÙØ¬Ù„Øª ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ§Øª)')){ commitments = commitments.filter(c=>c.id!==id); persist(COM_KEY, commitments); refreshCommitDisplays(); renderAll(); } }
    // commit pay -> create ledger expense for remaining and advance nextDue (handled by derived state)
    const commitPay = e.target.closest('[data-commit-pay]');
    if(commitPay){
      const id = commitPay.getAttribute('data-commit-pay');
      const c = commitments.find(x=>x.id===id); if(!c) return;
      const st = getCommitmentState(c); if(st.done){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ù„Øº Ù…ØªØ¨Ù‚Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù….'); return; }
      // choose account
      const accIndex = prompt('Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ø³Ø¯Ø§Ø¯:\n' + accounts.map((a,i)=>`${i+1}. ${a.name}`).join('\n'));
      if(!accIndex) return;
      const idx = parseInt(accIndex,10)-1; if(isNaN(idx)||!accounts[idx]){ alert('Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­'); return; }
      const accName = accounts[idx].name;
      const dateStr = st.currentDueYm + '-01';
      const remain = st.remaining;
      if(!confirm(`Ø³Ø¯Ø§Ø¯ ${fmt(remain)} Ø¬.Ù… Ù…Ù† "${accName}" Ù„Ù„Ø§Ù„ØªØ²Ø§Ù… "${c.name}"ØŸ`)) return;
      // create expense tx linked to commit
      const tx = { id:eid(), created: new Date().toISOString(), exec: new Date().toISOString(), date: dateStr, desc: `${c.name} (Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…)`, type:'expense', amount: remain, account: accName, category:'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ©', linkCommitId:c.id };
      ledger.push(tx); persist(KEY, ledger); markDirty();
      // no manual nextDue update here â€” state is derived from ledger
      renderAll();
    }

    // collect now
    const collectNow = e.target.closest('[data-collect-now]');
    if(collectNow){
      const id = collectNow.getAttribute('data-collect-now');
      const c = collections.find(x=>x.id===id); if(!c) return;
      const accIndex = prompt('Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„ØªØ­ØµÙŠÙ„ Ø¥Ù„ÙŠÙ‡:\n' + accounts.map((a,i)=>`${i+1}. ${a.name}`).join('\n'));
      if(!accIndex) return;
      const idx = parseInt(accIndex,10)-1; if(isNaN(idx)||!accounts[idx]){ alert('Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­'); return; }
      const accName = accounts[idx].name;
      const execISO = new Date().toISOString();
      const due = c.nextDue || c.firstDue || execISO.slice(0,10);
      ledger.push({ id:eid(), created: new Date().toISOString(), exec: execISO, date: due, desc: `${c.name} (ØªØ­ØµÙŠÙ„)`, type:'income', amount:c.amount, account:accName, category:'ØªØ­ØµÙŠÙ„Ø§Øª Ø´Ù‡Ø±ÙŠØ©', sourceCollectionId:`collect_${c.id}` });
      persist(KEY, ledger); markDirty();
      // advance nextDue if recurring
      if(c.recurring){
        const next = addMonthsPreserve(parseDateYmd(c.nextDue||c.firstDue),1);
        if(c.endAt && next > parseDateYmd(c.endAt)){ collections = collections.filter(x=>x.id!==id); } else { const it = collections.find(x=>x.id===id); if(it) it.nextDue = formatYmd(next); }
      } else { collections = collections.filter(x=>x.id!==id); }
      persist(COL_KEY, collections);
      refreshCollectDisplays(); renderAll();
    }

    // collect delete
    const collectDel = e.target.closest('[data-collect-del]');
    if(collectDel){ const id = collectDel.getAttribute('data-collect-del'); if(confirm('Ø­Ø°Ù Ø§Ù„ØªØ­ØµÙŠÙ„ØŸ')){ collections = collections.filter(x=>x.id!==id); persist(COL_KEY, collections); refreshCollectDisplays(); renderAll(); } }
  });

  /* ===== Accounts / categories / commit / collect add handlers ===== */
  $('#btn_add_acc').addEventListener('click', ()=>{
    const name = $('#acc_name').value.trim(); const opening = Number($('#acc_open').value||0);
    if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'); return; }
    accounts.push({name, opening: Number(opening||0)}); persist(ACC_KEY, accounts); refreshAccountDisplays(); renderAll();
    $('#acc_name').value=''; $('#acc_open').value='';
  });

  $('#btn_add_cat').addEventListener('click', ()=>{
    const name = $('#cat_name').value.trim(); const type = $('#cat_type').value;
    if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©'); return; }
    categories.push({name,type}); persist(CAT_KEY, categories); refreshCatDisplays(); renderAll();
    $('#cat_name').value='';
  });

  $('#btn_add_commit').addEventListener('click', ()=>{
    const name = $('#c_name').value.trim(); const amount = Number($('#c_amount').value||0); const first = $('#c_first').value; const rec = $('#c_rec').checked; const end = $('#c_end').value||null;
    if(!name || !amount || !first){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… + Ù…Ø¨Ù„Øº + ØªØ§Ø±ÙŠØ®'); return; }
    let firstDate = parseDateYmd(first); let next = new Date(firstDate.getTime()); next.setHours(0,0,0,0);
    const today = new Date(); today.setHours(0,0,0,0);
    while(next < today){ const candidate = addMonthsPreserve(next,1); if(rec && end && candidate > parseDateYmd(end)) break; next = candidate; if(!rec) break; }
    const commit = { id:eid(), name, amount: Number(amount), firstDue: formatYmd(firstDate), recurring: !!rec, endAt: rec ? (end||null): null, nextDue: formatYmd(next) };
    commitments.push(commit); persist(COM_KEY, commitments); refreshCommitDisplays(); renderAll();
    $('#c_name').value=''; $('#c_amount').value=''; $('#c_first').value=''; $('#c_rec').checked=false; $('#c_end').value='';
  });

  $('#btn_add_col').addEventListener('click', ()=>{
    const name = $('#col_name').value.trim(); const amount = Number($('#col_amount').value||0); const first = $('#col_first').value; const rec = $('#col_rec').checked; const end = $('#col_end').value||null;
    if(!name || !amount || !first){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… + Ù…Ø¨Ù„Øº + ØªØ§Ø±ÙŠØ®'); return; }
    let firstDate = parseDateYmd(first); let next = new Date(firstDate.getTime()); next.setHours(0,0,0,0);
    const today = new Date(); today.setHours(0,0,0,0);
    while(next < today){ const candidate = addMonthsPreserve(next,1); if(rec && end && candidate > parseDateYmd(end)) break; next = candidate; if(!rec) break; }
    const item = { id:eid(), name, amount: Number(amount), firstDue: formatYmd(firstDate), recurring: !!rec, endAt: rec ? (end||null): null, nextDue: formatYmd(next) };
    collections.push(item); persist(COL_KEY, collections); refreshCollectDisplays(); renderAll();
    $('#col_name').value=''; $('#col_amount').value=''; $('#col_first').value=''; $('#col_rec').checked=false; $('#col_end').value='';
  });

  /* ===== Navigation + Collapsibles + Theme ===== */
  function gotoPage(p){
    currentPage = 1;
    $('#filterSearch').value=''; $('#filterType').value='all'; $('#filterAccount').value='all'; $('#filterFrom').value=''; $('#filterTo').value='';
    $$('.page-section').forEach(el=>el.classList.add('hidden'));
    const mapping = { dashboard:'dashboard-section', transactions:'transactions-section', add:'add-section', management:'management-section', commitments:'commitments-section' };
    const id = mapping[p] || 'dashboard-section';
    const el = document.getElementById(id);
    if(el) el.classList.remove('hidden');
    // set active link style
    $$('.nav-link').forEach(n=>n.classList.remove('bg-gray-100','dark:bg-gray-700','font-semibold'));
    $$('.nav-link[data-page="'+p+'"]').forEach(n=>n.classList.add('bg-gray-100','dark:bg-gray-700','font-semibold'));
  }
  function setupNavigation(){
    $$('.nav-link').forEach(b=>{
      b.addEventListener('click', (ev)=>{
        ev.preventDefault();
        const page = b.getAttribute('data-page');
        gotoPage(page);
      });
    });
  }

  function initCollapsibles(){
    $$('.card-body').forEach(b=>b.classList.add('hidden'));
    $$('.card-head').forEach(h=>{
      h.addEventListener('click', ()=>{
        const body = h.nextElementSibling;
        if(!body) return;
        body.classList.toggle('hidden');
        const btn = h.querySelector('.toggle');
        if(btn) btn.classList.toggle('open');
      });
    });
  }

  function applyTheme(){
    const t = localStorage.getItem(THEME_KEY) || 'light';
    if(t === 'dark'){ document.documentElement.classList.add('dark'); $('#darkToggle').textContent = 'ÙˆØ¶Ø¹ ÙØ§ØªØ­'; }
    else { document.documentElement.classList.remove('dark'); $('#darkToggle').textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ'; }
  }
  $('#darkToggle').addEventListener('click', ()=>{
    const dark = document.documentElement.classList.toggle('dark');
    localStorage.setItem(THEME_KEY, dark? 'dark': 'light');
    applyTheme();
  });

  /* ===== Collapsible init (if present) ===== */
  function init(){
    applyTheme();
    setupNavigation();
    initCollapsibles();
    refreshAccountDisplays();
    refreshCatDisplays();
    refreshCommitDisplays();
    refreshCollectDisplays();
    markDirty();
    renderAll();
    gotoPage('dashboard');
    // periodically refresh link options (for newly added commitments)
    setInterval(()=>{ refreshCommitDisplays(); }, 1500);
  }

  /* ===== Render everything ===== */
  function renderAll(){
    markDirty(); ensureSorted(); computeBalances(); drawDashboard(); refreshAccountDisplays(); refreshCatDisplays(); refreshCommitDisplays(); refreshCollectDisplays(); renderTransactions();
  }

  /* ===== Initialize handlers for edit/delete in lists (delegation already handles) ===== */

  /* ===== init call ===== */
  init();

  /* expose for debugging */
  window._pf = { ledger, accounts, categories, commitments, collections, persist, renderAll, getCommitmentState };

})(); // IIFE end
</script>
</body>
</html>