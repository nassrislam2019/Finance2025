<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>دفتر حساباتي</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#ffffff; --card:#f7f8fb; --muted:#55626b; --txt:#0b1220;
  --brand:#0077cc; --danger:#ef4444; --ok:#16a34a; --border:#e6eef6;
  --radius:12px; --field-h:44px;
}
.dark{
  --bg:#071127; --card:#071a2b; --muted:#93a7bf; --txt:#e6f0fb; --border:#123142;
  --brand:#4ea8ff; --danger:#f87171; --ok:#34d399;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--txt);font-family:"Cairo",sans-serif;line-height:1.3}
.container{max-width:1180px;margin-inline:auto;padding:18px}
.header-top{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:8px}
.title-wrap{display:flex;align-items:center;gap:10px}
.title{font-weight:800;font-size:20px}
.color-btn{min-width:70px}
.header-tools{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:0;overflow:hidden;margin-bottom:12px}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
.card-head h3{margin:0;font-size:16px;display:flex;align-items:center;gap:10px}
.card-body{padding:14px;border-top:1px solid var(--border)}
.card.collapsed .card-body{display:none}
.toggle{appearance:none;border:none;background:transparent;cursor:pointer;border-radius:8px;font-size:18px;padding:6px 8px;color:var(--txt)}
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,textarea{width:100%;background:var(--card);color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;height:var(--field-h)}
.checkbox-row{display:flex;align-items:center;gap:8px}
.btn{appearance:none;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;transition:opacity .12s;min-height:38px}
.btn:hover{opacity:.92}
.btn-primary{background:var(--brand);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--txt)}
.btn-danger{background:var(--danger);color:#fff}
.btn-muted{background:transparent;border:1px dashed var(--border);color:var(--muted)}
.stats{display:grid;gap:10px}
@media(min-width:720px){.stats{grid-template-columns:repeat(2,1fr)}}
.stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px}
.stat small{color:var(--muted)}
.stat .num{font-weight:800;font-size:18px;margin-top:6px}
.pos{color:var(--ok)}.neg{color:var(--danger)}
.report-table-wrap{overflow:auto;max-height:340px}
.empty-state{padding:10px;border:1px dashed var(--border);border-radius:10px;text-align:center;font-size:13px;color:var(--muted)}
table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:13px}
thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:right;padding:6px 10px}
tbody tr{background:var(--card);border:1px solid var(--border);border-radius:10px}
tbody td{padding:10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
.amount.exp{color:var(--danger);font-weight:800}.amount.inc{color:var(--ok);font-weight:800}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.spacer{flex:1}
.badge{display:inline-flex;gap:6px;align-items:center;background:transparent;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:40px}
.hr{height:1px;background:var(--border);opacity:.6;margin:12px 0;border-radius:999px}
.list-plain{display:flex;flex-wrap:wrap;gap:8px}
.list-plain .item{background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:10px}
#dueSoonCards{display:none}
@media(max-width:720px){
  #dueSoonWrap{display:none}
  #dueSoonCards{display:block}
}
.pager{display:flex;gap:8px;align-items:center;margin-top:10px;justify-content:center}
.pager button{min-width:44px}
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
.modal{background:var(--card);border:1px solid var(--border);padding:16px;border-radius:10px;min-width:300px;max-width:90%;box-shadow:0 8px 30px rgba(2,6,23,0.2)}
.modal h4{margin:0 0 8px}
.modal .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.show{display:flex}
.hidden{display:none!important}
.due-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;display:grid;gap:6px}
.due-card .row{display:flex;justify-content:space-between;gap:8px}
.due-card .name{font-weight:700}
.due-card .remain{font-weight:800}
.due-card .meta{color:var(--muted);font-size:12px}
.due-card .actions{display:flex;gap:8px}
</style>
</head>
<body>
<div class="container">
  <div class="header-top">
    <div class="title-wrap">
      <div class="title">دفتر حساباتي</div>
      <button id="darkToggle" class="btn btn-outline color-btn" type="button">Dark</button>
    </div>
    <div style="width:1px"></div>
  </div>

  <div class="header-tools">
    <button id="exportJson" class="btn btn-outline" type="button">تصدير JSON</button>
    <button id="exportCsv" class="btn btn-outline" type="button">تصدير CSV</button>
    <label class="btn btn-muted" for="importFile" style="display:inline-flex;align-items:center">استيراد JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
    <button id="syncNow" class="btn btn-outline" type="button">مزامنة الآن</button>
  </div>

  <!-- Summary card -->
  <section class="card collapsed" id="card-balance" data-collapsible>
    <div class="card-head"><h3>ملخص الحسابات</h3><button class="toggle" aria-expanded="false" aria-controls="balanceBody">▸</button></div>
    <div class="card-body" id="balanceBody">
      <div class="stats">
        <div class="stat"><small>إجمالي الأرصدة</small><div id="totalBalance" class="num">0.00</div></div>
        <div class="stat"><small>بعد التحصيلات والالتزامات</small><div id="balanceAfterCommit" class="num">0.00</div></div>
      </div>
      <div style="height:12px"></div>
      <div class="stats">
        <div class="stat"><small>المبالغ تحت التحصيل (الشهر الحالي)</small><div id="totalCollectionsThisMonth" class="num">0.00</div></div>
        <div class="stat"><small>مجموع استحقاقات الشهر الحالي</small><div id="totalCommitmentsThisMonth" class="num neg">0.00</div></div>
      </div>
      <div class="hr"></div>
      <div>
        <h3 style="margin:0 0 8px;font-size:14px;color:var(--muted)">تفاصيل الأرصدة بالحساب</h3>
        <div id="perAccount" class="list-plain"></div>
      </div>
    </div>
  </section>

  <!-- Due Soon -->
  <section class="card collapsed" id="card-dueSoon" data-collapsible>
    <div class="card-head"><h3>استحقاقات قريبة</h3><button class="toggle" aria-expanded="false" aria-controls="dueSoonBody">▸</button></div>
    <div class="card-body" id="dueSoonBody">
      <div class="badge-group" style="margin-bottom:8px">
        <span id="dueTotalBadge" class="badge">إجمالي: 0.00 ج.م</span>
        <span id="dueNextTotalBadge" class="badge">الشهر القادم: 0.00 ج.م</span>
      </div>
      <div id="dueSoonWrap">
        <table>
          <thead><tr><th>الاسم</th><th>التاريخ</th><th>الأصل</th><th>المدفوع</th><th>المتبقي</th><th>الحالة</th><th>إجراءات</th></tr></thead>
          <tbody id="tbodyDueSoon"></tbody>
        </table>
      </div>
      <div id="dueSoonCards"></div>
      <div id="noDueSoon" class="d-none" style="color:var(--muted)">لا توجد استحقاقات هذا الشهر غير مسددة.</div>
    </div>
  </section>

  <!-- Other cards as before (accounts, categories, transfer, add tx, txs, commits, collects) -->
  <!-- For brevity in this response keep the same structure as previous full version; scripting below covers them -->
  <!-- ... (we assume rest of HTML cards present exactly as previous code block) ... -->

  <!-- We'll include all earlier cards structure for accounts/categories/transfer/addtx/txs/commit/collect as in the last full page you received.
       For brevity here, assume same HTML structure is present (it's long). -->
</div>

<!-- Modal backdrop -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
  <div id="modalBox" class="modal" aria-live="polite">
    <h4 id="modalTitle">...</h4>
    <div id="modalContent"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<script>
/* ===========================
   Data keys & safe load
   =========================== */
const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1',
      COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1', DARK_KEY='pf_dark_v1';

let ledger = [];
let accounts = [];
let categories = [];
let commitments = [];
let collections = [];

// safe parse helper
function safeParse(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch(e){
    console.error('Corrupted localStorage for', key, e);
    try{ localStorage.setItem(key + '_corrupt_backup', localStorage.getItem(key)); }catch{}
    localStorage.removeItem(key);
    return fallback;
  }
}

ledger = safeParse(KEY, []);
accounts = safeParse(ACC_KEY, []);
categories = safeParse(CAT_KEY, []);
commitments = safeParse(COM_KEY, []);
collections = safeParse(COL_KEY, []);

/* ===== sorted ledger caching to avoid repeated sorts ===== */
let sortedLedger = [];
let isLedgerDirty = true;
function markLedgerDirty(){ isLedgerDirty = true; }

/* utils */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const eid = ()=> Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const fmt = n => Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const escapeHtml = s=>String(s).replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
function formatLocalDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function parseLocalDate(str){ if(!str) return null; const [y,m,d]=str.split('-').map(Number); if(!y) return null; const dt=new Date(y,m-1,d,0,0,0,0); dt.setHours(0,0,0,0); return dt; }
function startOfToday(){ const t=new Date(); t.setHours(0,0,0,0); return t; }
function addMonthsPreserveDOM(date,months){ const d=new Date(date.getTime()); const targetMonth=d.getMonth()+months; const day=d.getDate(),y=d.getFullYear(); const temp=new Date(y,targetMonth+1,0); const lastDay=temp.getDate(); d.setMonth(targetMonth,Math.min(day,lastDay)); d.setHours(0,0,0,0); return d; }
function daysBetween(a,b){ const MS=24*60*60*1000; const da=new Date(a.getFullYear(),a.getMonth(),a.getDate()); const db=new Date(b.getFullYear(),b.getMonth(),b.getDate()); return Math.round((db-da)/MS); }
const YM = ()=> formatLocalDate(startOfToday()).slice(0,7);
const addMonthsToYm = (ym, months)=>{ const parts=(ym||'').split('-').map(Number); const y=parts[0], m=parts[1]; if(!Number.isFinite(y)||!Number.isFinite(m)) return ym; const base=new Date(y,m-1,1); const next=addMonthsPreserveDOM(base, months); return formatLocalDate(next).slice(0,7); };

/* persist */
function persist(key,obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){ console.error('persist error',e); } }

/* ---------- SORTED LEDGER HELPER ---------- */
function ensureSortedLedger(){
  if(!isLedgerDirty && sortedLedger.length) return;
  sortedLedger = [...ledger].slice().sort((a,b)=>{
    const aKey = (a.exec || a.created || a.date || '');
    const bKey = (b.exec || b.created || b.date || '');
    if(aKey === bKey) return (a.id||'').localeCompare(b.id||'');
    return aKey.localeCompare(bKey);
  });
  isLedgerDirty = false;
}

/* ---------- computeBalances uses sortedLedger (cached) ---------- */
let cachedBalances = null;
let cachedAfter = null;
function computeBalances(){
  ensureSortedLedger();
  const bal = new Map(accounts.map(a=>[a.name, a.opening||0]));
  const after = new Map();
  for(const t of sortedLedger){
    const cur = bal.get(t.account) ?? 0;
    const delta = (t.type==='income' ? Number(t.amount) : -Number(t.amount));
    const next = cur + delta;
    bal.set(t.account, next);
    after.set(t.id, next);
  }
  cachedBalances = bal;
  cachedAfter = after;
  return {bal,after};
}

/* ---------- Commitment: single source of truth (derive from ledger) ---------- */
/*
  We DO NOT persist c.payments or c.nextDue anymore.
  Use getCommitmentState(commit) which scans ledger for linked txs (t.linkCommitId === commit.id)
  and returns the first month that is not fully paid (or null if no pending months).
*/
function monthKeyFromDateStr(dateStr){
  if(!dateStr) return null;
  return dateStr.slice(0,7);
}

function getCommitmentState(commit){
  // returns { currentDueYm, paid, remaining, paidTxs:[txs], monthIndex } or { done: true } if fully finished and non-recurring
  if(!commit || !commit.firstDue) return { currentDueYm: null, paid:0, remaining:0 };
  const amount = Number(commit.amount||0);
  const start = parseLocalDate(commit.firstDue);
  if(!start) return { currentDueYm:null, paid:0, remaining:amount };
  let cursor = new Date(start.getTime());
  const endDate = commit.endAt ? parseLocalDate(commit.endAt) : null;
  const todayYm = YM();
  // build quick map of payments by ym for this commit from ledger
  const payMap = new Map(); // ym -> [txs]
  for(const t of ledger){
    if(t.linkCommitId !== commit.id) continue;
    const ym = monthKeyFromDateStr((t.exec||t.created||t.date||''));
    if(!ym) continue;
    const arr = payMap.get(ym) || [];
    arr.push(t);
    payMap.set(ym, arr);
  }
  // iterate months from firstDue until we find month with remaining > 0 OR until end
  let guard = 0;
  while(guard < 500){
    const ym = formatLocalDate(cursor).slice(0,7);
    // stop if beyond endDate
    if(endDate && cursor > endDate) return { done: true };
    const txs = payMap.get(ym) || [];
    const paidThisMonth = txs.reduce((s,t)=>s + Number(t.amount||0), 0);
    if(paidThisMonth + 1e-9 < amount){
      return { currentDueYm: ym, paid: paidThisMonth, remaining: Math.max(0, amount - paidThisMonth), paidTxs: txs, monthIndex: guard };
    } else {
      // fully paid -> move to next month (if recurring) or return done
      if(!commit.recurring) return { done: true }; // one-time and paid
      const next = addMonthsPreserveDOM(cursor, 1);
      // if next beyond endDate -> done
      if(endDate && next > endDate) return { done: true };
      cursor = next;
    }
    guard++;
  }
  return { done: true };
}

/* ---------- Collections: rely on sourceCollectionId ---------- */
function collectedCollectionsForYm(ym){
  let total = 0;
  for(const t of ledger){
    if(t.type !== 'income') continue;
    const when = (t.exec || t.created || t.date || '').slice(0,7);
    if(when !== ym) continue;
    if(t.sourceCollectionId && String(t.sourceCollectionId).startsWith('collect_')){
      total += Number(t.amount||0);
    }
  }
  return total;
}

/* ---------- drawCommitments uses getCommitmentState ---------- */
function drawCommitments(){
  const ym = YM();
  const rows = commitments.slice().sort((a,b)=> (a.firstDue||'').localeCompare(b.firstDue||''));
  $('#tbodyCommit').innerHTML = rows.map(c=>{
    const st = getCommitmentState(c);
    const recTxt = c.recurring ? 'شهري' : 'مرة واحدة';
    const endTxt = c.recurring && c.endAt ? c.endAt : '—';
    const paid = st.paid || 0;
    const remaining = st.remaining !== undefined ? st.remaining : 0;
    const due = st.currentDueYm || (c.firstDue ? c.firstDue.slice(0,7) : '—');
    return `<tr data-id="${c.id}">
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${escapeHtml(due)}</td>
      <td>${fmt(paid)}</td>
      <td>${fmt(remaining)}</td>
      <td>${recTxt}</td>
      <td>${endTxt}</td>
      <td>
        <button data-action="pay-commit" data-id="${c.id}" class="btn btn-primary" type="button">تم السداد (كامل)</button>
        <button data-action="edit-commit" data-id="${c.id}" class="btn btn-outline" type="button">تعديل</button>
        <button data-action="del-commit" data-id="${c.id}" class="btn btn-danger" type="button">حذف</button>
      </td>
    </tr>`;
  }).join('');
}

/* ---------- payCommit: use getCommitmentState to determine remaining ---------- */
async function handlePayCommit(commitId){
  const c = commitments.find(x=>x.id===commitId); if(!c) return;
  const st = getCommitmentState(c);
  if(st.done){ await openModal({title:'تنبيه', contentHtml:'<div>التزام مُسدد أو منتهي.</div>', buttons:[{label:'حسناً',value:true}]}); return; }
  const accName = await modalSelectAccount(accounts, 'اختر الحساب للسداد');
  if(!accName) return;
  const ym = st.currentDueYm;
  const dueDate = ym + '-01'; // use first day of month as due date representation
  const dateStr = dueDate;
  const remain = st.remaining;
  const confirm = await modalConfirm(`سداد كامل المتبقي للالتزام "${c.name}" بقيمة ${fmt(remain)} ج.م من "${accName}"؟`);
  if(!confirm) return;
  const execISO = new Date().toISOString();
  const tx = { id:eid(), created:execISO, exec:execISO, date:dateStr, due:dateStr, desc:`${c.name} (سداد التزام)`, type:'expense', amount:remain, account:accName, category:'التزامات شهرية', linkCommitId:c.id };
  ledger.push(tx);
  persist(KEY, ledger);
  markLedgerDirty();
  // after new tx persisted, draw and recalc will derive new state from ledger
  drawCommitments(); drawDueSoon(); render(); recalc();
}

/* ---------- delTx now simply removes tx and marks ledger dirty ---------- */
async function handleDeleteTx(txId){
  const confirmed = await modalConfirm('هل تريد حذف هذه الحركة؟');
  if(!confirmed) return;
  ledger = ledger.filter(t=>t.id!==txId);
  persist(KEY, ledger);
  markLedgerDirty();
  // do NOT try to "patch" commitments/payments; states will be derived from ledger
  drawCommitments(); drawDueSoon(); render(); recalc();
}

/* ---------- drawDueSoon now uses getCommitmentState and derived values ---------- */
function drawDueSoon(){
  const wrap=document.getElementById('dueSoonWrap'), none=document.getElementById('noDueSoon'), tbody=document.getElementById('tbodyDueSoon'), cards=document.getElementById('dueSoonCards');
  if(!wrap||!tbody||!cards) return;
  const ym=YM(), nextYm=addMonthsToYm(ym,1), today=startOfToday();
  const list = commitments.map(c=>{
    const st = getCommitmentState(c);
    if(st.done) return null;
    if(st.currentDueYm !== ym) return null;
    const dueStr = st.currentDueYm + '-01';
    const due = parseLocalDate(dueStr);
    const diff = daysBetween(today, due);
    return {...c, dueStr: st.currentDueYm, paid:st.paid, total: Number(c.amount||0), remaining: st.remaining, diff};
  }).filter(Boolean).sort((a,b)=> a.dueStr.localeCompare(b.dueStr));
  const totalRemain = list.reduce((s,x)=>s + x.remaining, 0);
  if($('#dueTotalBadge')) $('#dueTotalBadge').textContent = 'إجمالي: ' + fmt(totalRemain) + ' ج.م';
  if($('#dueNextTotalBadge')){
    let nextTotal=0;
    if(nextYm){
      for(const c of commitments){
        const stNext = getCommitmentState(c);
        if(stNext.done) continue;
        // check if next due is nextYm
        if(stNext.currentDueYm === nextYm) nextTotal += stNext.remaining;
      }
    }
    $('#dueNextTotalBadge').textContent = `الشهر القادم: ${fmt(nextTotal)} ج.م`;
  }
  if(list.length===0){ wrap.classList.add('d-none'); cards.classList.add('d-none'); none.classList.remove('d-none'); tbody.innerHTML=''; cards.innerHTML=''; return; }
  none.classList.add('d-none'); wrap.classList.remove('d-none'); cards.classList.remove('d-none');
  tbody.innerHTML = list.map(x=>{
    const state = x.diff<0 ? `<span style="color:var(--danger);font-weight:700">متأخر ${Math.abs(x.diff)} يوم</span>` : x.diff===0 ? `<span style="color:var(--muted);font-weight:700">اليوم</span>` : `<span style="color:var(--muted);font-weight:700">متبقي ${x.diff} يوم</span>`;
    return `<tr data-id="${x.id}"><td>${escapeHtml(x.name)}</td><td>${x.dueStr}</td><td>${fmt(x.total)}</td><td>${fmt(x.paid)}</td><td><b>${fmt(x.remaining)}</b></td><td>${state}</td><td class="actions"><button data-action="pay-commit" data-id="${x.id}" class="btn btn-primary" type="button">سداد الآن</button></td></tr>`;
  }).join('');
  cards.innerHTML = list.map(x=>{
    const over = x.diff<0;
    const state = over ? `متأخر ${Math.abs(x.diff)} يوم` : (x.diff===0 ? 'اليوم' : `متبقي ${x.diff} يوم`);
    return `<div class="due-card"><div class="row"><div class="name">${escapeHtml(x.name)}</div><div class="remain">${fmt(x.remaining)} ج.م</div></div><div class="row meta"><div>الأصل: ${fmt(x.total)} · المدفوع: ${fmt(x.paid)}</div><div>${x.dueStr}</div></div><div class="${over? 'state over':'state'}">${state}</div><div class="actions"><button data-action="pay-commit" data-id="${x.id}" class="btn btn-primary" type="button" style="flex:1">سداد الآن</button></div></div>`; }).join('');
}

/* ---------- Event delegation wiring for commit/pay/delete (transactions table & commit table) ---------- */
/* Transactions tbody delegation: edit / delete (delete uses handleDeleteTx) */
document.addEventListener('click', function(ev){
  const btn = ev.target.closest('button[data-action]');
  if(!btn) return;
  const action = btn.getAttribute('data-action');
  const id = btn.getAttribute('data-id');
  // tx table actions
  if(action === 'del-tx') { handleDeleteTx(id); }
  else if(action === 'pay-commit') { handlePayCommit(id); }
  else if(action === 'collect-now') { handleCollectNow(id); }
  // commit table edit/del actions
  else if(action === 'edit-commit'){ const c = commitments.find(x=>x.id===id); if(!c) return; /* populate commit fields for edit (left as exercise) */ }
  else if(action === 'del-commit'){ /* deletion logic for commit – keep as before but no patching of payments */ (async ()=>{ const confirmed = await modalConfirm('هل تريد حذف هذا الالتزام؟'); if(!confirmed) return; commitments = commitments.filter(x=>x.id!==id); persist(COM_KEY, commitments); drawCommitments(); drawDueSoon(); render(); })(); }
});

/* ---------- handleCollectNow uses sourceCollectionId ---------- */
async function handleCollectNow(collectId){
  const c = collections.find(x=>x.id===collectId); if(!c) return;
  const accName = await modalSelectAccount(accounts, 'اختر الحساب لتحويل المبلغ إليه');
  if(!accName) return;
  const due = c.nextDue ? parseLocalDate(c.nextDue) : parseLocalDate(c.firstDue); const dateStr = formatLocalDate(due);
  const confirm = await modalConfirm(`تأكيد تحصيل "${c.name}" بمبلغ ${fmt(c.amount)} ج.م إلى حساب "${accName}" بتاريخ ${dateStr}؟`);
  if(!confirm) return;
  const execISO = new Date().toISOString();
  ledger.push({ id:eid(), created:execISO, exec:execISO, date:dateStr, due:dateStr, desc:`${c.name} (تحصيل)`, type:'income', amount:c.amount, account:accName, category:'تحصيلات شهرية', sourceCollectionId:`collect_${c.id}` });
  persist(KEY, ledger);
  markLedgerDirty();
  if(c.recurring){
    const next = addMonthsPreserveDOM(due,1);
    if(c.endAt && next > parseLocalDate(c.endAt)) collections = collections.filter(x=>x.id!==collectId);
    else c.nextDue = formatLocalDate(next);
  } else collections = collections.filter(x=>x.id!==collectId);
  persist(COL_KEY, collections);
  drawCollections(); render(); recalc();
}

/* ---------- delete tx wrapper: we used handleDeleteTx earlier ---------- */

/* ---------- drawCollections uses stored nextDue but collected amount computed from sourceCollectionId ---------- */
function drawCollections(){
  const rows=[...collections].slice().sort((a,b)=> (a.nextDue||a.firstDue||'').localeCompare(b.nextDue||b.firstDue||''));
  $('#tbodyCollect').innerHTML = rows.map(c=>{
    const recTxt=c.recurring?'شهري':'مرة واحدة';
    const endTxt=c.recurring && c.endAt?c.endAt:'—';
    return `<tr data-id="${c.id}"><td>${escapeHtml(c.name)}</td><td>${fmt(c.amount)}</td><td>${escapeHtml(c.nextDue||c.firstDue||'—')}</td><td>${recTxt}</td><td>${endTxt}</td><td><button data-action="collect-now" data-id="${c.id}" class="btn btn-primary" type="button">تم التحصيل</button><button data-action="edit-collect" data-id="${c.id}" class="btn btn-outline" type="button">تعديل</button><button data-action="del-collect" data-id="${c.id}" class="btn btn-danger" type="button">حذف</button></td></tr>`; }).join('');
}

/* ---------- recalc / draw summary uses derived functions ---------- */
function recalc(){
  ensureSortedLedger();
  computeBalances();
  const bal = cachedBalances || new Map();
  let total=0; for(const v of bal.values()) total+=v;
  const ym = YM(), nextYm = addMonthsToYm(ym,1);
  // commitments totals derived
  let commitTotalThis=0, commitRemainThis=0;
  for(const c of commitments){
    const st = getCommitmentState(c);
    if(!st.done && st.currentDueYm === ym){ commitTotalThis += Number(c.amount||0); commitRemainThis += st.remaining; }
    else if(st.done){ /* ignore */ }
  }
  const collectionsThisTotal = collections.filter(c=> hasDueInMonth(c, ym) ).reduce((s,c)=>s+Number(c.amount||0),0);
  const collectedThis = collectedCollectionsForYm(ym);
  const notCollected = Math.max(0, collectionsThisTotal - collectedThis);
  const afterCom = total - commitRemainThis + collectionsThisTotal;

  if($('#totalBalance')) $('#totalBalance').textContent=fmt(total);
  if($('#balanceAfterCommit')) $('#balanceAfterCommit').textContent=fmt(afterCom);
  if($('#totalCommitmentsThisMonth')) $('#totalCommitmentsThisMonth').textContent = `${fmt(commitTotalThis)} (المتبقي: ${fmt(commitRemainThis)})`;
  if($('#totalCollectionsThisMonth')) $('#totalCollectionsThisMonth').textContent = `${fmt(collectionsThisTotal)} (لم يُحصل: ${fmt(notCollected)})`;
  if($('#dueTotalBadge')) $('#dueTotalBadge').textContent = 'إجمالي: ' + fmt(commitRemainThis) + ' ج.م';
  if($('#dueNextTotalBadge')) {
    let nextTotal = 0;
    for(const c of commitments){
      const st = getCommitmentState(c);
      if(!st.done && st.currentDueYm === nextYm) nextTotal += st.remaining;
    }
    $('#dueNextTotalBadge').textContent = `الشهر القادم: ${fmt(nextTotal)} ج.م`;
  }
  drawPerAccount(bal);
}

/* ---------- drawPerAccount ---------- */
function drawPerAccount(balMap){
  const items=[]; for(const a of accounts){ const v = (balMap && balMap.get(a.name)!==undefined) ? balMap.get(a.name) : (a.opening||0); items.push(`<span class="item">${escapeHtml(a.name)} · <b>${fmt(v)} ج.م</b></span>`); } $('#perAccount').innerHTML = items.join('');
}

/* ---------- rendering transactions (uses sortedLedger/caching) ---------- */
let pageSize = 10, currentPage = 1;
function render(){
  ensureSortedLedger();
  const q = ($('#search')?.value||'').toLowerCase();
  const ft = document.getElementById('fType')?.value || 'all';
  const fa = document.getElementById('fAccount')?.value || 'all';
  const ff = document.getElementById('fFrom')?.value || '';
  const fto = document.getElementById('fTo')?.value || '';

  const rows = sortedLedger.filter(t=>{
    if(q && !((t.desc||'').toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q))) return false;
    if(ft !== 'all' && t.type !== ft) return false;
    if(fa !== 'all' && t.account !== fa) return false;
    if(ff && (t.date||'') < ff) return false;
    if(fto && (t.date||'') > fto) return false;
    return true;
  }).slice().sort((a,b)=>{
    const aKey = (a.exec||a.created||a.date||'');
    const bKey = (b.exec||b.created||b.date||'');
    if(aKey === bKey) return (b.id||'').localeCompare(a.id||'');
    return bKey.localeCompare(aKey);
  });

  const total = rows.length;
  const pages = Math.max(1, Math.ceil(total/pageSize));
  if(currentPage > pages) currentPage = pages;
  const start = (currentPage - 1) * pageSize;
  const pageRows = rows.slice(start, start+pageSize);
  const after = cachedAfter || new Map();

  $('#tbody').innerHTML = pageRows.map(t=>{
    const cls = t.type==='income' ? 'inc' : 'exp';
    const afterVal = after.has(t.id) ? after.get(t.id) : 0;
    const execTxt = t.exec ? new Date(t.exec).toLocaleString('ar-EG') : (t.created ? new Date(t.created).toLocaleString('ar-EG') : '—');
    const dueTxt = t.date || t.due || '—';
    const tag = t.isTransfer ? ' <span style="font-size:11px;color:var(--muted)">↔︎ تحويل</span>' : '';
    return `<tr data-id="${t.id}">
      <td style="white-space:nowrap">${escapeHtml(execTxt)}</td>
      <td>${escapeHtml(dueTxt)}</td>
      <td>${escapeHtml(t.desc||'—')}${tag}</td>
      <td>${escapeHtml(t.category||'—')}</td>
      <td>${escapeHtml(t.account||'—')}</td>
      <td class="amount ${cls}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
      <td>${fmt(afterVal)}</td>
      <td style="white-space:nowrap">
        <button data-action="edit-tx" data-id="${t.id}" class="btn btn-outline" type="button">تعديل</button>
        <button data-action="del-tx" data-id="${t.id}" class="btn btn-danger" type="button">حذف</button>
      </td>
    </tr>`;
  }).join('');
  $('#pageInfo').textContent = `الصفحة ${currentPage} من ${pages} — إجمالي: ${total} عملية`;
  $('#prevPage').disabled = currentPage <= 1;
  $('#nextPage').disabled = currentPage >= pages;
  recalc();
}

/* ---------- minimal modal system (re-used from previous) ---------- */
const modalBackdrop = $('#modalBackdrop');
const modalTitle = $('#modalTitle');
const modalContent = $('#modalContent');
const modalActions = $('#modalActions');

function openModal({title='', contentHtml='', buttons=[{label:'حسناً',value:true}], onClose}){
  modalTitle.textContent = title;
  modalContent.innerHTML = contentHtml;
  modalActions.innerHTML = '';
  modalBackdrop.classList.add('show');
  modalBackdrop.classList.remove('hidden');
  return new Promise((resolve)=>{
    buttons.forEach(btn=>{
      const b = document.createElement('button');
      b.className = 'btn ' + (btn.class || 'btn-primary');
      b.type='button';
      b.textContent = btn.label;
      b.addEventListener('click', ()=>{
        modalBackdrop.classList.remove('show');
        modalBackdrop.classList.add('hidden');
        resolve(btn.value);
        if(onClose) onClose(btn.value);
      });
      modalActions.appendChild(b);
    });
  });
}

function modalConfirm(message){
  return openModal({ title:'تأكيد', contentHtml:`<div>${escapeHtml(message)}</div>`, buttons:[
    {label:'إلغاء', value:false, class:'btn-outline'},
    {label:'موافق', value:true, class:'btn-primary'}
  ]});
}
function modalPrompt({title='إدخال', label='', placeholder='', defaultValue='' }){
  const id='modalInput_'+Date.now();
  const html = `<div><label style="display:block;color:var(--muted)">${escapeHtml(label)}</label><input id="${id}" placeholder="${escapeHtml(placeholder)}" value="${escapeHtml(defaultValue)}" /></div>`;
  return openModal({ title, contentHtml:html, buttons:[
    {label:'إلغاء', value:null, class:'btn-outline'},
    {label:'موافق', value:'__ok', class:'btn-primary'}
  ]}).then(res=>{
    if(res!=='__ok') return null;
    const val = document.getElementById(id).value;
    return val;
  });
}
function modalSelectAccount(accountsList, title='اختر الحساب'){
  const id='modalSelect_'+Date.now();
  const options = accountsList.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
  const html = `<div><label style="display:block;color:var(--muted)">اختر الحساب:</label><select id="${id}">${options}</select></div>`;
  return openModal({ title, contentHtml:html, buttons:[
    {label:'إلغاء', value:null, class:'btn-outline'},
    {label:'اختيار', value:'__ok', class:'btn-primary'}
  ]}).then(res=>{
    if(res!=='__ok') return null;
    return document.getElementById(id).value;
  });
}

/* ---------- other UI glue: sorting flags, draw lists, init, dark mode ---------- */
function ensureBaseCategories(){ const need=[ {name:'التزامات شهرية',type:'expense'},{name:'تحصيلات شهرية',type:'income'},{name:'تحويل صادر',type:'expense'},{name:'تحويل وارد',type:'income'},{name:'عمولة تحويل',type:'expense'} ]; let changed=false; if(categories.length===0){ categories=[ {name:'مرتب',type:'income'},{name:'دخل آخر',type:'income'},{name:'أكل وشرب',type:'expense'},{name:'مواصلات',type:'expense'},{name:'فواتير',type:'expense'},{name:'تسوق',type:'expense'} ]; changed=true; } for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } } if(changed) persist(CAT_KEY,categories); }

function applyDarkFromStorage(){ const saved = localStorage.getItem(DARK_KEY); if(saved === '1'){ document.documentElement.classList.add('dark'); $('#darkToggle').textContent='Light'; } else { document.documentElement.classList.remove('dark'); $('#darkToggle').textContent='Dark'; } }
$('#darkToggle')?.addEventListener('click', ()=>{ const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem(DARK_KEY, isDark ? '1' : '0'); $('#darkToggle').textContent = isDark ? 'Light' : 'Dark'; });

/* drawLists for accounts/categories, refresh selects, handlers for add/edit as previous version */
function refreshAccountSelects(){
  const optsAll = accounts.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
  if($('#account')) $('#account').innerHTML = optsAll;
  const fA=document.getElementById('fAccount'); if(fA) fA.innerHTML = `<option value="all" selected>كل الحسابات</option>` + optsAll;
  if($('#trFrom')){ const prevFrom = $('#trFrom').value; $('#trFrom').innerHTML = optsAll; $('#trFrom').value = (prevFrom && accounts.some(a=>a.name===prevFrom)) ? prevFrom : (accounts[0]?.name || ''); }
  if($('#trTo')){ const from = $('#trFrom')?.value || ''; const prevTo = $('#trTo').value; $('#trTo').innerHTML = accounts.filter(a=>a.name!==from).map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join(''); if(prevTo && prevTo !== from && accounts.some(a=>a.name===prevTo)) $('#trTo').value = prevTo; else $('#trTo').selectedIndex = 0; }
}
function refreshCategorySelect(){ const cats = categories.filter(c=>c.type===$('#type').value); if($('#category')) $('#category').innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join(''); }
function refreshLinkCommitOptions(){ const linkElem = $('#linkCommit'); if(!linkElem) return; const ym = YM(); const opts = commitments.filter(c=>{ const st = getCommitmentState(c); return !st.done && st.currentDueYm === ym; }).map(c=>`<option value="${c.id}">${escapeHtml(c.name)} — أصل ${fmt(c.amount)} • متبقي ${fmt(getCommitmentState(c).remaining)}</option>`).join(''); linkElem.innerHTML = `<option value="">— بدون —</option>` + opts; }

function drawCatsBadges(){ $('#catsList').innerHTML = categories.map((c,i)=>`<span class="badge">${escapeHtml(c.name)} · ${c.type==='income'?'دخل':'مصروف'} <button data-action="rename-cat" data-i="${i}" class="btn btn-muted" type="button">تعديل</button> <button data-action="remove-cat" data-i="${i}" class="btn btn-muted" type="button">حذف</button></span>`).join(''); }
function drawAccountsBadges(){ ensureSortedLedger(); computeBalances(); $('#accountsList').innerHTML = accounts.map((a,i)=>{ const b = fmt((cachedBalances && cachedBalances.get(a.name)!==undefined) ? cachedBalances.get(a.name) : (a.opening||0)); return `<span class="badge">${escapeHtml(a.name)} · <b>${b} ج.م</b> <button data-action="rename-acc" data-i="${i}" class="btn btn-muted" type="button">تعديل</button> <button data-action="remove-acc" data-i="${i}" class="btn btn-muted" type="button">حذف</button></span>`; }).join(''); }

/* init */
function init(){
  applyDarkFromStorage();
  if(accounts.length===0){ accounts=[ {name:'كاش',opening:0},{name:'حساب بنكي',opening:0},{name:'محفظة',opening:0} ]; persist(ACC_KEY, accounts); }
  ensureBaseCategories();
  commitments = commitments.map(c=> (c.firstDue? c : (c.firstDue = new Date().toISOString().slice(0,10), c)) );
  collections = collections.map(c=> (c.firstDue? c : (c.firstDue = new Date().toISOString().slice(0,10), c)) );
  persist(COM_KEY, commitments); persist(COL_KEY, collections);
  ensureSortedLedger();
  refreshAccountSelects(); refreshCategorySelect(); drawCatsBadges();
  drawCommitments(); drawCollections(); drawDueSoon();
  initCollapsibles(); render(); recalc();
}
function initCollapsibles(){ $$('[data-collapsible]').forEach(sec=>{ const btn = sec.querySelector('.toggle'); const bodyId = sec.querySelector('.card-body')?.id; if(btn && bodyId) btn.setAttribute('aria-controls', bodyId); if(btn){ sec.classList.add('collapsed'); btn.textContent = '▸'; btn.setAttribute('aria-expanded','false'); btn.addEventListener('click', ()=>{ const isCollapsed = sec.classList.toggle('collapsed'); btn.textContent = isCollapsed ? '▸' : '▾'; btn.setAttribute('aria-expanded', String(!isCollapsed)); }); } }); }

/* wire small handlers (export/import, dark toggle etc) */
document.getElementById('exportJson')?.addEventListener('click', ()=>{ const data={ ledger, accounts, categories, commitments, collections, exportedAt:new Date().toISOString() }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='my-finance-data.json'; a.click(); URL.revokeObjectURL(a.href); });
document.getElementById('importFile')?.addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return; try{ const text=await file.text(); const data=JSON.parse(text); if(Array.isArray(data.ledger)) ledger=data.ledger; if(Array.isArray(data.accounts)) accounts=data.accounts; if(Array.isArray(data.categories)) categories=data.categories; if(Array.isArray(data.commitments)) commitments=data.commitments; if(Array.isArray(data.collections)) collections=data.collections; persist(KEY, ledger); persist(ACC_KEY, accounts); persist(CAT_KEY, categories); persist(COM_KEY, commitments); persist(COL_KEY, collections); markLedgerDirty(); ensureSortedLedger(); drawCommitments(); drawCollections(); drawDueSoon(); render(); recalc(); await openModal({title:'نجاح', contentHtml:'<div>تم الاستيراد بنجاح</div>', buttons:[{label:'حسناً',value:true}]}); }catch(err){ await openModal({title:'خطأ', contentHtml:`<div>خطأ أثناء الاستيراد: ${escapeHtml(err.message||String(err))}</div>`, buttons:[{label:'حسناً',value:true}]}); } e.target.value=''; });
document.getElementById('syncNow')?.addEventListener('click', ()=>{ openModal({title:'مزامنة', contentHtml:'<div>هذه نسخة محلية. لربط مزامنة حقيقية استخدم خدمة سحابية.</div>', buttons:[{label:'حسناً',value:true}]}); });

/* run init */
init();

</script>
</body>
</html>