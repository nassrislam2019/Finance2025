<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</title>
<meta name="theme-color" content="#0b1220" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220;
  --card:#0f172a;
  --muted:#94a3b8;
  --txt:#e5e7eb;
  --brand:#0369a1;
  --brand-2:#0ea5e9;
  --danger:#ef4444;
  --border:#1f2a44;
  --radius:12px;
}
body{margin:0;font-family:'Cairo',sans-serif;background-color:var(--bg);color:var(--txt);}
header{background:var(--card);display:flex;justify-content:space-between;align-items:center;padding:1rem;box-shadow:0 0 10px rgba(0,0,0,.4);}
.btn{background:var(--brand);border:none;color:#fff;padding:.5rem 1rem;border-radius:var(--radius);cursor:pointer;}
.btn:hover{background:var(--brand-2);}
.card{background:var(--card);padding:1rem;margin:1rem;border-radius:var(--radius);}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:100;}
.modal .card{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;}
label{display:block;margin-bottom:.3rem;color:var(--muted);}
input[type=text]{width:100%;padding:.5rem;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg);color:var(--txt);}
.grid{display:grid;gap:.5rem;}
.grid-2{grid-template-columns:1fr 1fr;}
</style>
</head>
<body>

<header>
  <h1>ğŸ“˜ Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</h1>
  <button id="btnSettings" class="btn">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸</button>
</header>

<main>
  <div class="card">
    <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ğŸ‘‹</h2>
    <p>Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØªØªØ¨Ø¹ Ø§Ù„ØªØ²Ø§Ù…Ø§ØªÙƒ ÙˆØªØ¬Ù…ÙŠØ¹Ø§ØªÙƒØŒ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¹Ø¨Ø± GitHub Gist.</p>
  </div>
</main>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div id="settingsModal" class="modal">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h2>
      <button id="closeSettingsModal" class="btn btn-danger" style="background:var(--danger)">âœ–</button>
    </div>
    <hr>
    <h3>Ù…Ø²Ø§Ù…Ù†Ø© GitHub Gist</h3>
    <form id="ghSyncForm">
      <div class="form-group">
        <label for="ghToken">Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ (Token)</label>
        <input type="text" id="ghToken" placeholder="ghp_..." required>
      </div>
      <div class="form-group">
        <label for="ghGistId">Ù…Ø¹Ø±Ù Gist (ID)</label>
        <input type="text" id="ghGistId" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯">
      </div>
      <div class="grid grid-2" style="margin-top:1rem;">
        <button type="submit" class="btn" id="btnSaveGhSettings">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button type="button" class="btn" id="btnGhPush" style="background:var(--brand-2)">â¬†ï¸ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†</button>
        <button type="button" class="btn" id="btnGhPull" style="background:var(--brand)">â¬‡ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Gist</button>
      </div>
    </form>
  </div>
</div>

<script>
// ======= Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© =======
let settings = JSON.parse(localStorage.getItem('mySettings') || '{}');
const els = {
  btnSettings: document.getElementById('btnSettings'),
  settingsModal: document.getElementById('settingsModal'),
  closeSettingsModal: document.getElementById('closeSettingsModal'),
  ghToken: document.getElementById('ghToken'),
  ghGistId: document.getElementById('ghGistId'),
  btnGhPush: document.getElementById('btnGhPush'),
  btnGhPull: document.getElementById('btnGhPull'),
  ghSyncForm: document.getElementById('ghSyncForm')
};

// ======= ÙˆØ¸Ø§Ø¦Ù Ù…Ø²Ø§Ù…Ù†Ø© GitHub =======
function saveSettings(){
  localStorage.setItem('mySettings', JSON.stringify(settings));
}

function fillGhFormFromStorage(){
  els.ghToken.value = settings.ghToken || '';
  els.ghGistId.value = settings.ghGistId || '';
}

function ghSaveSettings(e){
  e.preventDefault();
  settings.ghToken = els.ghToken.value.trim();
  settings.ghGistId = els.ghGistId.value.trim() || null;
  saveSettings();
  alert('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub Ø¨Ù†Ø¬Ø§Ø­.');
}

async function ghFetch(path, method='GET', body=null){
  const token = settings.ghToken || els.ghToken.value.trim();
  if(!token) throw new Error('Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ (Token) ØºÙŠØ± Ù…ÙØ¹Ø±Ù‘Ù.');
  const headers = { 'Authorization': 'token '+token, 'Accept': 'application/vnd.github+json' };
  if(body) headers['Content-Type'] = 'application/json';
  const res = await fetch('https://api.github.com'+path, {method,headers,body:body?JSON.stringify(body):undefined});
  if(!res.ok){
    const txt = await res.text().catch(()=>null);
    throw new Error(`GitHub API ${res.status}: ${txt}`);
  }
  return res.json().catch(()=>null);
}

async function ghPush(){
  try{
    const token = els.ghToken.value.trim();
    if(token) settings.ghToken = token;
    const gistId = els.ghGistId.value.trim();
    if(gistId) settings.ghGistId = gistId;
    saveSettings();

    if(!settings.ghToken) return alert('âš ï¸ Ø£Ø¯Ø®Ù„ Token Ø£ÙˆÙ„Ø§Ù‹.');

    const content = JSON.stringify({test:"my-finance demo sync",time:new Date().toISOString()},null,2);
    const fileName = 'my-finance-data.json';
    if(settings.ghGistId){
      await ghFetch(`/gists/${settings.ghGistId}`, 'PATCH', {files:{[fileName]:{content}}});
      alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Gist Ø¨Ù†Ø¬Ø§Ø­.');
    } else {
      const res = await ghFetch('/gists','POST',{public:false,description:'my-finance backup',files:{[fileName]:{content}}});
      if(res.id){ settings.ghGistId=res.id; saveSettings(); els.ghGistId.value=res.id; alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Gist Ø¬Ø¯ÙŠØ¯.'); }
    }
  }catch(err){ alert('âŒ ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: '+err.message); console.error(err); }
}

async function ghPull(){
  try{
    const gistId = els.ghGistId.value.trim() || settings.ghGistId;
    if(!gistId) return alert('âš ï¸ Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Gist Ø£ÙˆÙ„Ø§Ù‹.');
    const gist = await ghFetch(`/gists/${gistId}`,'GET');
    const files = gist.files || {};
    const file = files['my-finance-data.json'] || Object.values(files)[0];
    if(!file) throw new Error('Ø§Ù„Ù€ Gist Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„Ù ØµØ§Ù„Ø­.');
    const data = JSON.parse(file.content);
    alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n'+JSON.stringify(data,null,2));
  }catch(err){ alert('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: '+err.message); console.error(err); }
}

// ======= ÙØªØ­ ÙˆØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =======
els.btnSettings?.addEventListener('click',()=>{
  els.settingsModal.style.display='block';
  fillGhFormFromStorage();
});

els.closeSettingsModal?.addEventListener('click',()=>{
  els.settingsModal.style.display='none';
});

window.addEventListener('click',(ev)=>{
  if(ev.target===els.settingsModal){ els.settingsModal.style.display='none'; }
});

// ======= Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± =======
els.ghSyncForm?.addEventListener('submit',ghSaveSettings);
els.btnGhPush?.addEventListener('click',ghPush);
els.btnGhPull?.addEventListener('click',ghPull);
</script>
</body>
</html>