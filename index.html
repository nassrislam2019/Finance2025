<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ â€” Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø© Ù…ØµØ­Ø­Ø©</title>

  <!-- DEV NOTE: CDN Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ù…Ø­Ù„ÙŠØ§Ù‹. Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ù†ØªØ§Ø¬ÙŠ Ø§Ø³ØªØ¹Ù…Ù„ Tailwind CLI/PostCSS Ù„Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù CSS. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --muted: #6b7280;
      --txt: #0f172a;
      --brand: #4f46e5;
    }
    html,body{height:100%}
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--bg);
      color: var(--txt);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    /* scrollbar */
    ::-webkit-scrollbar { width:8px; height:8px; }
    ::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:10px; }
    /* modal transitions */
    .modal { transition: opacity .2s ease, transform .2s ease; transform: scale(.98); opacity:0; visibility:hidden; }
    .modal.is-open { transform: scale(1); opacity:1; visibility:visible; }
    /* toast */
    #toast-container { position: fixed; bottom: 1.25rem; left: 1.25rem; z-index:60; display:flex; flex-direction:column; gap:0.5rem; }
    .toast { animation: fadeIn .25s ease-out, fadeOut .25s ease-in 3.5s; padding:0.65rem 0.9rem; border-radius:.6rem; box-shadow:0 6px 18px rgba(2,6,23,0.08); }
    @keyframes fadeIn { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
    @keyframes fadeOut { from{opacity:1} to{opacity:0} }
    /* tiny responsive */
    @media (max-width:640px){ .container{padding-left:1rem;padding-right:1rem} }
    /* dark mode helper */
    .dark-mode { background:#0b1220; color:#e6eef8; }
    .dark-mode .bg-white{ background:#0f1724 !important; }
    .dark-mode input, .dark-mode select, .dark-mode textarea { background:#0f1724 !important; color:#e6eef8 !important; border-color:#24303a !important; }
  </style>
</head>
<body class="text-gray-800">

  <!-- HEADER -->
  <header class="bg-white shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-indigo-700">Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</h1>
      <div class="flex gap-2 items-center">
        <button id="toggle-dark-mode" class="text-sm bg-gray-800 text-white px-3 py-2 rounded-lg">ğŸŒ™ ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ</button>
        <button id="btn-open-import-export" class="text-sm bg-gray-200 text-gray-700 px-3 py-2 rounded-lg">Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±</button>
        <button id="btn-open-test-runner" class="text-sm bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg">Ù…Ø±ÙƒØ² Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
        <button id="btn-add-transaction" class="text-sm bg-indigo-600 text-white px-3 py-2 rounded-lg shadow">+ Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Left -->
    <aside class="lg:col-span-4 space-y-6">
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
          <h2 class="text-lg font-bold">Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h2>
          <button id="btn-gemini-summary" class="text-xs bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-3 py-1 rounded-full">âœ¨ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ø®Øµ</button>
        </div>
        <div class="grid grid-cols-2 gap-4 text-center">
          <div><p class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„</p><p id="summary-income" class="text-xl font-bold text-green-600">0.00</p></div>
          <div><p class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p><p id="summary-expense" class="text-xl font-bold text-red-600">0.00</p></div>
          <div class="col-span-2"><p class="text-sm text-gray-500">ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚</p><p id="summary-net" class="text-2xl font-bold text-gray-800">0.00</p></div>
        </div>
      </div>

      <div class="bg-white p-5 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
          <h2 class="text-lg font-bold">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
          <button id="btn-open-add-account" class="text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded-md">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</button>
        </div>
        <div id="accounts-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
        <div class="border-t pt-3 mt-4"><p class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©</p><p id="summary-total-balance" class="text-2xl font-bold text-indigo-800">0.00</p></div>
      </div>
    </aside>

    <!-- Right -->
    <section class="lg:col-span-8 space-y-6">
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</h2>
          <button id="btn-open-add-due" class="text-sm bg-indigo-100 text-indigo-700 px-3 py-1 rounded-md">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
        </div>

        <div class="border-b border-gray-200">
          <nav class="flex -mb-px gap-6">
            <button id="btn-tab-receivables" class="tab-btn active text-sm font-medium py-3 px-1">ØªØ­ØµÙŠÙ„Ø§Øª (Ù…Ø³ØªØ­Ù‚Ø© Ù„ÙŠ)</button>
            <button id="btn-tab-payables" class="tab-btn text-sm font-medium py-3 px-1 text-gray-500">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Ù…Ø³ØªØ­Ù‚Ø© Ø¹Ù„ÙŠ)</button>
          </nav>
        </div>

        <div id="tab-content-receivables" class="py-4 space-y-3 max-h-60 overflow-y-auto"></div>
        <div id="tab-content-payables" class="py-4 space-y-3 max-h-60 overflow-y-auto hidden"></div>
      </div>

      <div class="bg-white p-5 rounded-xl shadow-lg">
        <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
          <h2 class="text-lg font-bold">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
          <div class="flex gap-2 overflow-x-auto pb-2">
            <select id="filter-account" class="form-select w-32 text-sm rounded-lg border-gray-300"><option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option></select>
            <select id="filter-type" class="form-select w-28 text-sm rounded-lg border-gray-300"><option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option><option value="income">Ø¯Ø®Ù„</option><option value="expense">Ù…ØµØ±ÙˆÙ</option></select>
            <input type="date" id="filter-date-start" class="form-input w-36 text-sm rounded-lg border-gray-300">
            <input type="date" id="filter-date-end" class="form-input w-36 text-sm rounded-lg border-gray-300">
            <button id="btn-apply-filters" class="text-sm bg-gray-700 text-white px-3 py-1 rounded-lg">ØªØ·Ø¨ÙŠÙ‚</button>
            <button id="btn-clear-filters" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded-lg">Ù…Ø³Ø­</button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full min-w-max text-sm text-right">
            <thead class="bg-gray-50">
              <tr>
                <th class="p-3 font-semibold text-gray-600">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="p-3 font-semibold text-gray-600">Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                <th class="p-3 font-semibold text-gray-600">Ø§Ù„ÙˆØµÙ</th>
                <th class="p-3 font-semibold text-gray-600">Ø¯Ø§Ø¦Ù† (Ù„Ù‡)</th>
                <th class="p-3 font-semibold text-gray-600">Ù…Ø¯ÙŠÙ† (Ø¹Ù„ÙŠÙ‡)</th>
                <th class="p-3 font-semibold text-gray-600">Ø§Ù„Ø±ØµÙŠØ¯</th>
                <th class="p-3 font-semibold text-gray-600"></th>
              </tr>
            </thead>
            <tbody id="transactions-table-body"></tbody>
          </table>
          <div id="transactions-empty-state" class="text-center p-10 text-gray-500 hidden">
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§. Ø­Ø§ÙˆÙ„ Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast-container"></div>

  <!-- ===== MODALS (ÙƒØ§Ù…Ù„Ø©) ===== -->

  <!-- Transaction Modal -->
  <div id="transaction-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
    <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl p-6">
      <form id="transaction-form">
        <input type="hidden" id="tx-id">
        <input type="hidden" id="tx-linked-id">
        <h3 id="tx-modal-title" class="text-xl font-bold mb-6">Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="tx-type" class="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</label>
            <select id="tx-type" class="form-select w-full rounded-lg border-gray-300" required>
              <option value="income">Ø¯Ø®Ù„</option>
              <option value="expense">Ù…ØµØ±ÙˆÙ</option>
              <option value="transfer">ØªØ­ÙˆÙŠÙ„</option>
            </select>
          </div>
          <div>
            <label for="tx-date" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input type="datetime-local" id="tx-date" class="form-input w-full rounded-lg border-gray-300" required>
          </div>
          <div class="md:col-span-2">
            <label for="tx-amount" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº</label>
            <input type="number" step="0.01" id="tx-amount" class="form-input w-full rounded-lg border-gray-300" placeholder="0.00" required>
          </div>

          <div id="tx-account-from-container">
            <label for="tx-account-from" class="block text-sm font-medium text-gray-700 mb-1">Ù…Ù† Ø­Ø³Ø§Ø¨ (Ø§Ù„Ù…ØµØ¯Ø±)</label>
            <select id="tx-account-from" class="form-select w-full rounded-lg border-gray-300"></select>
          </div>
          <div id="tx-account-to-container">
            <label for="tx-account-to" class="block text-sm font-medium text-gray-700 mb-1">Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ (Ø§Ù„Ù‡Ø¯Ù)</label>
            <select id="tx-account-to" class="form-select w-full rounded-lg border-gray-300"></select>
          </div>

          <div>
            <label for="tx-category" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙØ¦Ø©</label>
            <input type="text" id="tx-category" class="form-input w-full rounded-lg border-gray-300" placeholder="Ø±Ø§ØªØ¨ØŒ ÙÙˆØ§ØªÙŠØ±ØŒ ...">
          </div>

          <div class="md:col-span-2">
            <label for="tx-notes" class="block text-sm font-medium text-gray-700 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea id="tx-notes" rows="2" class="form-textarea w-full rounded-lg border-gray-300"></textarea>
          </div>
        </div>

        <div class="flex justify-end gap-3 mt-6">
          <button type="button" class="btn-close-modal bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Account Modal -->
  <div id="account-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
    <div class="bg-white w-full max-w-md rounded-xl shadow-2xl p-6">
      <form id="account-form">
        <input type="hidden" id="account-id">
        <h3 id="account-modal-title" class="text-xl font-bold mb-6">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>

        <div class="space-y-4">
          <div>
            <label for="account-name" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <input type="text" id="account-name" class="form-input w-full rounded-lg border-gray-300" required>
          </div>
          <div>
            <label for="account-type" class="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <select id="account-type" class="form-select w-full rounded-lg border-gray-300" required>
              <option value="cash">Ù†Ù‚Ø¯ÙŠ (ÙƒØ§Ø´)</option>
              <option value="bank">Ø¨Ù†ÙƒÙŠ</option>
              <option value="wallet">Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
              <option value="other">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
          <div>
            <label for="account-initial-balance" class="block text-sm font-medium text-gray-700 mb-1">Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ</label>
            <input type="number" step="0.01" id="account-initial-balance" class="form-input w-full rounded-lg border-gray-300" value="0" required>
          </div>
        </div>

        <div class="flex justify-end gap-3 mt-6">
          <button type="button" class="btn-close-modal bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Due Modal -->
  <div id="due-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
    <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
      <form id="due-form">
        <input type="hidden" id="due-id">
        <h3 id="due-modal-title" class="text-xl font-bold mb-6">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="due-type" class="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
            <select id="due-type" class="form-select w-full rounded-lg border-gray-300" required>
              <option value="receivable">ØªØ­ØµÙŠÙ„ (Ù…Ø³ØªØ­Ù‚ Ù„ÙŠ)</option>
              <option value="payable">Ø§Ù„ØªØ²Ø§Ù… (Ù…Ø³ØªØ­Ù‚ Ø¹Ù„ÙŠ)</option>
            </select>
          </div>
          <div>
            <label for="due-recurrence" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªÙƒØ±Ø§Ø±</label>
            <select id="due-recurrence" class="form-select w-full rounded-lg border-gray-300" required>
              <option value="none">Ù„Ø§ ÙŠØªÙƒØ±Ø± (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</option>
              <option value="monthly">ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠØ§Ù‹</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label for="due-name" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</label>
            <input type="text" id="due-name" class="form-input w-full rounded-lg border-gray-300" placeholder="ÙØ§ØªÙˆØ±Ø©ØŒ Ø¥ÙŠØ¬Ø§Ø±..." required>
          </div>
          <div>
            <label for="due-amount" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº</label>
            <input type="number" step="0.01" id="due-amount" class="form-input w-full rounded-lg border-gray-300" value="0" required>
          </div>
          <div>
            <label for="due-date" class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
            <input type="date" id="due-date" class="form-input w-full rounded-lg border-gray-300" required>
          </div>
          <div class="md:col-span-2">
            <label for="due-account-id" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø·</label>
            <select id="due-account-id" class="form-select w-full rounded-lg border-gray-300" required></select>
            <p class="text-xs text-gray-500 mt-1">(Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„ Ø¥Ù„ÙŠÙ‡ Ø£Ùˆ Ø§Ù„Ø³Ø¯Ø§Ø¯ Ù…Ù†Ù‡)</p>
          </div>
        </div>

        <div class="flex justify-end gap-3 mt-6">
          <button type="button" class="btn-close-modal bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø¯</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirm-modal" class="modal fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 p-4">
    <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6">
      <h3 id="confirm-title" class="text-xl font-bold mb-4">ØªØ£ÙƒÙŠØ¯</h3>
      <p id="confirm-message" class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
      <div class="flex justify-end gap-3">
        <button id="btn-confirm-cancel" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="btn-confirm-action" class="bg-red-600 text-white px-4 py-2 rounded-lg">Ù†Ø¹Ù…</button>
      </div>
    </div>
  </div>

  <!-- Import/Export Modal -->
  <div id="import-export-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
    <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
      <h3 class="text-xl font-bold mb-6">Ø§Ø³ØªÙŠØ±Ø§Ø¯ / ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
      <p class="text-sm text-gray-600 mb-4">ÙŠØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­. ÙŠÙ…ÙƒÙ†Ùƒ ØªØµØ¯ÙŠØ±Ù‡Ø§ ÙƒÙ…Ù„Ù JSON.</p>

      <div class="space-y-4">
        <button id="btn-export-data" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
        <div>
          <label for="import-file" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</label>
          <input type="file" id="import-file" accept=".json" class="form-input w-full text-sm">
          <button id="btn-import-data" class="w-full mt-2 bg-green-600 text-white px-4 py-2 rounded-lg">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ùˆ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        </div>
      </div>

      <div class="flex justify-end mt-6"><button type="button" class="btn-close-modal bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>

  <!-- Test Runner Modal -->
  <div id="test-runner-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
    <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl p-6">
      <h3 class="text-xl font-bold mb-4">Ù…Ø±ÙƒØ² Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
      <button id="btn-run-tests" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg mb-4">Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
      <div id="test-results-container" class="mt-4 max-h-96 overflow-y-auto bg-gray-900 text-white rounded-lg p-4 font-mono text-sm">Ø§Ù†Ù‚Ø± "Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª" Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬...</div>
      <div class="flex justify-end mt-6"><button type="button" class="btn-close-modal bg-gray-200 px-4 py-2 rounded-lg">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>

  <!-- Gemini Summary Modal -->
  <div id="gemini-summary-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4">
    <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
      <h3 class="text-xl font-bold mb-4">âœ¨ ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ù„ÙŠ Ø°ÙƒÙŠ</h3>
      <div id="gemini-loading" class="text-center p-4 text-gray-600 hidden"><p>Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p></div>
      <div id="gemini-results" class="text-gray-700 leading-relaxed max-h-60 overflow-y-auto"></div>
      <div class="flex justify-end mt-6"><button type="button" class="btn-close-modal bg-gray-200 px-4 py-2 rounded-lg">Ø¥ØºÙ„Ø§Ù‚</button></div>
    </div>
  </div>

  <!-- ====== SCRIPT (JS ÙƒØ§Ù…Ù„) ====== -->
  <script>
    // -------------------------
    // 0. Utilities / Formatting
    // -------------------------
    const DB_KEY = 'myAccountingAppDB_v2';
    let state = { accounts:[], transactions:[], payables:[] };
    let currentFilters = { account:'all', type:'all', dateStart:'', dateEnd:'' };

    const currencyFormatter = new Intl.NumberFormat('ar-EG', { style:'currency', currency:'EGP', minimumFractionDigits:2, maximumFractionDigits:2 });

    function formatCurrency(num){
      if (num === null || num === undefined) return '0.00';
      const n = Number(num) || 0;
      return currencyFormatter.format(n).replace('EGP','').trim();
    }

    function formatDate(d){
      const date = new Date(d);
      if (isNaN(date)) return '';
      let month = '' + (date.getMonth() + 1);
      let day = '' + date.getDate();
      let year = date.getFullYear();
      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;
      return [year, month, day].join('-');
    }

    function formatDateTime(d){
      const date = new Date(d);
      if (isNaN(date)) return '';
      return date.toLocaleDateString('ar-EG', { year:'numeric', month:'short', day:'numeric' }) + ' ' + date.toLocaleTimeString('ar-EG', { hour:'2-digit', minute:'2-digit' });
    }

    // -------------------------
    // 1. Storage
    // -------------------------
    const StorageService = {
      load(){
        try {
          const raw = localStorage.getItem(DB_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            // convert Dates stored as strings to strings (we'll use ISO strings)
            state = parsed;
            // migration safety
            if (!state.accounts) state.accounts = [];
            if (!state.transactions) state.transactions = [];
            if (!state.payables) state.payables = [];
            return;
          }
        } catch (e) { console.warn('Failed to parse storage, seeding initial data.', e); }
        this.saveInitial();
      },
      save(){ localStorage.setItem(DB_KEY, JSON.stringify(state)); },
      exportData(){ return JSON.stringify(state, null, 2); },
      importData(jsonStr){
        try {
          const parsed = JSON.parse(jsonStr);
          if (!parsed.accounts || !parsed.transactions) return false;
          if (!parsed.payables) parsed.payables = [];
          state = parsed;
          this.save();
          return true;
        } catch (e) { return false; }
      },
      saveInitial(){
        const cashId = crypto.randomUUID();
        const bankId = crypto.randomUUID();
        const walletId = crypto.randomUUID();
        const today = new Date();
        const fiveDays = new Date(today); fiveDays.setDate(today.getDate()+5);
        const twoDaysAgo = new Date(today); twoDaysAgo.setDate(today.getDate()-2);
        const fifteenDaysAgo = new Date(today); fifteenDaysAgo.setDate(today.getDate()-15);

        state = {
          accounts: [
            { id: cashId, name: 'Ù†Ù‚Ø¯ (Ø§Ù„Ø®Ø²Ù†Ø©)', type:'cash', initialBalance:2000, currentBalance:2000 },
            { id: bankId, name: 'Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ', type:'bank', initialBalance:10000, currentBalance:10000 },
            { id: walletId, name: 'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©', type:'wallet', initialBalance:500, currentBalance:500 }
          ],
          transactions: [
            { id: crypto.randomUUID(), createdAt: new Date('2025-11-01T10:00:00').toISOString(), date: new Date('2025-11-01T10:00:00').toISOString(), type:'income', to: bankId, from: null, amount: 5000, category:'Ø±Ø§ØªØ¨', notes:'Ø±Ø§ØªØ¨ Ø´Ù‡Ø± Ø£ÙƒØªÙˆØ¨Ø±' },
            { id: crypto.randomUUID(), createdAt: new Date('2025-11-02T14:00:00').toISOString(), date: new Date('2025-11-02T14:00:00').toISOString(), type:'expense', from: cashId, to: null, amount: 300, category:'ÙÙˆØ§ØªÙŠØ±', notes:'ÙØ§ØªÙˆØ±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡' },
            // transfer pair
            ...(function(){ const linked = crypto.randomUUID(); return [
              { id: crypto.randomUUID(), createdAt: new Date('2025-11-03T11:00:00').toISOString(), date: new Date('2025-11-03T11:00:00').toISOString(), type:'expense', from: bankId, to:null, amount:1000, category:'ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø±', notes:'ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø¹Ù‡Ø¯Ø©', linkedId: linked },
              { id: linked, createdAt: new Date('2025-11-03T11:00:00').toISOString(), date: new Date('2025-11-03T11:00:00').toISOString(), type:'income', from:null, to: cashId, amount:1000, category:'ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯', notes:'ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø¹Ù‡Ø¯Ø©', linkedId: null }
            ]; })(),
            { id: crypto.randomUUID(), createdAt: new Date('2025-11-05T18:00:00').toISOString(), date: new Date('2025-11-05T18:00:00').toISOString(), type:'expense', from: walletId, to: null, amount:150, category:'Ù…Ø´ØªØ±ÙŠØ§Øª Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†', notes:'' },
            { id: crypto.randomUUID(), createdAt: new Date('2025-11-07T09:00:00').toISOString(), date: new Date('2025-11-07T09:00:00').toISOString(), type:'income', to: cashId, from: null, amount:200, category:'Ù…Ø¨ÙŠØ¹Ø§Øª', notes:'Ù…Ø¨ÙŠØ¹Ø§Øª Ù†Ù‚Ø¯ÙŠØ©' },
          ],
          payables: [
            { id: crypto.randomUUID(), type:'receivable', name:'Ø¯ÙØ¹Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£Ø­Ù…Ø¯)', amount:2500, dueDate: fiveDays.toISOString(), status:'pending', accountId: bankId, recurrence:'none' },
            { id: crypto.randomUUID(), type:'payable', name:'ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', amount:450, dueDate: twoDaysAgo.toISOString(), status:'pending', accountId: cashId, recurrence:'none' },
            { id: crypto.randomUUID(), type:'payable', name:'Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ÙƒØªØ¨ (Ø³Ø§Ø¨Ù‚)', amount:3000, dueDate: fifteenDaysAgo.toISOString(), status:'paid', accountId: bankId, recurrence:'none' },
            { id: crypto.randomUUID(), type:'payable', name:'Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ÙƒØªØ¨ (Ø´Ù‡Ø±ÙŠ)', amount:3000, dueDate: new Date(today.getFullYear(), today.getMonth(), 1).toISOString(), status:'pending', accountId: bankId, recurrence:'monthly' }
          ]
        };
        this.save();
      }
    };

    // -------------------------
    // 2. Core Logic
    // -------------------------
    const CoreLogic = {
      getAccountById(id){ return state.accounts.find(a=>a.id===id); },
      getTransactionById(id){ return state.transactions.find(t=>t.id===id); },
      getDueById(id){ return state.payables.find(p=>p.id===id); },

      createTransferPair(fromId, toId, amount, dateIso, notes){
        const linkedId = crypto.randomUUID();
        const expense = { id: crypto.randomUUID(), createdAt: dateIso, date: dateIso, type:'expense', from: fromId, to: null, amount: amount, category:'ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø±', notes: notes, linkedId: linkedId };
        const income = { id: linkedId, createdAt: dateIso, date: dateIso, type:'income', from:null, to: toId, amount: amount, category:'ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯', notes: notes, linkedId: expense.id };
        return [expense, income];
      },

      recalculateAccountBalance(accountId){
        const account = this.getAccountById(accountId);
        if (!account) return;
        const accountTxs = state.transactions.filter(t => t.from === accountId || t.to === accountId)
          .sort((a,b) => new Date(a.date).getTime() - new Date(b.date).getTime() || new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime());
        let currentBalance = Number(account.initialBalance) || 0;
        for (const tx of accountTxs) {
          tx.balanceBefore = currentBalance;
          if (tx.type === 'income' && tx.to === accountId) currentBalance += Number(tx.amount) || 0;
          else if (tx.type === 'expense' && tx.from === accountId) currentBalance -= Number(tx.amount) || 0;
          tx.balanceAfter = currentBalance;
        }
        account.currentBalance = currentBalance;
      },

      recalculateAllBalances(){
        for (const acc of state.accounts) this.recalculateAccountBalance(acc.id);
      },

      addAccount(name, type, initialBalance){
        state.accounts.push({ id: crypto.randomUUID(), name, type, initialBalance: Number(initialBalance)||0, currentBalance: Number(initialBalance)||0 });
        this.recalculateAllBalances();
        StorageService.save();
      },

      updateAccount(id, name, type, initialBalance){
        const acc = this.getAccountById(id);
        if (!acc) return;
        acc.name = name; acc.type = type; acc.initialBalance = Number(initialBalance)||0;
        this.recalculateAllBalances(); StorageService.save();
      },

      deleteAccount(id){
        if (state.transactions.some(t => t.from === id || t.to === id)) return false;
        state.accounts = state.accounts.filter(a => a.id !== id);
        StorageService.save();
        return true;
      },

      addTransaction(txData){
        const now = new Date().toISOString();
        if (txData.type === 'transfer') {
          const dateIso = new Date(txData.date).toISOString();
          const [expense, income] = this.createTransferPair(txData.from, txData.to, Number(txData.amount)||0, dateIso, txData.notes || '');
          state.transactions.push(expense, income);
        } else {
          state.transactions.push({
            id: crypto.randomUUID(),
            createdAt: now,
            date: new Date(txData.date).toISOString(),
            type: txData.type,
            from: txData.from || null,
            to: txData.to || null,
            amount: Number(txData.amount) || 0,
            category: txData.category || '',
            notes: txData.notes || '',
            linkedId: null
          });
        }
        this.recalculateAllBalances(); StorageService.save();
      },

      updateTransaction(id, newTxData){
        const tx = this.getTransactionById(id);
        if (!tx) return;
        if (tx.linkedId) {
          const linkedTx = this.getTransactionById(tx.linkedId);
          tx.date = new Date(newTxData.date).toISOString();
          tx.amount = Number(newTxData.amount)||tx.amount;
          tx.notes = newTxData.notes || tx.notes;
          tx.from = newTxData.from || tx.from;
          if (linkedTx) {
            linkedTx.date = tx.date;
            linkedTx.amount = tx.amount;
            linkedTx.notes = tx.notes;
            linkedTx.to = newTxData.to || linkedTx.to;
          }
        } else {
          tx.date = new Date(newTxData.date).toISOString();
          tx.amount = Number(newTxData.amount)||tx.amount;
          tx.category = newTxData.category || tx.category;
          tx.notes = newTxData.notes || tx.notes;
          tx.from = newTxData.from || tx.from;
          tx.to = newTxData.to || tx.to;
        }
        this.recalculateAllBalances(); StorageService.save();
      },

      deleteTransaction(id){
        const tx = this.getTransactionById(id);
        if (!tx) return;
        if (tx.linkedId) state.transactions = state.transactions.filter(t => t.id !== id && t.id !== tx.linkedId);
        else state.transactions = state.transactions.filter(t => t.id !== id);
        this.recalculateAllBalances(); StorageService.save();
      },

      addDue(data){
        state.payables.push({ id: crypto.randomUUID(), type: data.type, name: data.name, amount: Number(data.amount)||0, dueDate: data.dueDate, accountId: data.accountId, recurrence: data.recurrence || 'none', status: 'pending' });
        StorageService.save();
      },

      updateDue(id, data){
        const due = this.getDueById(id); if (!due) return;
        due.type = data.type; due.name = data.name; due.amount = Number(data.amount)||due.amount; due.dueDate = data.dueDate; due.accountId = data.accountId; due.recurrence = data.recurrence;
        StorageService.save();
      },

      deleteDue(id){ state.payables = state.payables.filter(p => p.id !== id); StorageService.save(); },

      getDuesWithStatus(){
        const today = new Date(); today.setHours(0,0,0,0);
        const sevenDays = new Date(today.getTime() + 7*24*60*60*1000);
        return state.payables.map(due => {
          const dueDate = new Date(due.dueDate); dueDate.setHours(0,0,0,0);
          let statusText = 'Ù…Ø³ØªØ­Ù‚', statusColor = 'bg-blue-100 text-blue-800';
          if (due.status === 'paid' && (due.recurrence === 'none' || !due.recurrence)) { statusText='Ù…Ø¯ÙÙˆØ¹'; statusColor='bg-gray-100 text-gray-800'; }
          else if (dueDate < today) { statusText='Ù…ØªØ£Ø®Ø±'; statusColor='bg-red-100 text-red-800'; }
          else if (dueDate <= sevenDays) { statusText='Ù‚Ø±ÙŠØ¨ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚'; statusColor='bg-yellow-100 text-yellow-800'; }
          return { ...due, statusText, statusColor };
        }).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
      },

      collectReceivable(dueId){
        const due = this.getDueById(dueId); if (!due || due.type !== 'receivable') return false;
        this.addTransaction({ type:'income', date: new Date().toISOString(), amount: due.amount, from: null, to: due.accountId, category:'ØªØ­ØµÙŠÙ„', notes:`ØªØ­ØµÙŠÙ„: ${due.name}` });
        if (due.recurrence === 'monthly') { const next = new Date(due.dueDate); next.setMonth(next.getMonth()+1); due.dueDate = next.toISOString(); }
        else due.status = 'paid';
        StorageService.save(); return true;
      },

      payPayable(dueId){
        const due = this.getDueById(dueId); if (!due || due.type !== 'payable') return false;
        this.addTransaction({ type:'expense', date: new Date().toISOString(), amount: due.amount, from: due.accountId, to: null, category:'Ø³Ø¯Ø§Ø¯ Ø§Ù„ØªØ²Ø§Ù…', notes:`Ø³Ø¯Ø§Ø¯: ${due.name}` });
        if (due.recurrence === 'monthly') { const next = new Date(due.dueDate); next.setMonth(next.getMonth()+1); due.dueDate = next.toISOString(); }
        else due.status = 'paid';
        StorageService.save(); return true;
      },

      getFilteredTransactions(filters){
        const { account, type, dateStart, dateEnd } = filters;
        return state.transactions.filter(tx => {
          if (account !== 'all' && tx.from !== account && tx.to !== account) return false;
          if (type !== 'all' && tx.type !== type) return false;
          if (dateStart) { if (formatDate(tx.date) < dateStart) return false; }
          if (dateEnd) { if (formatDate(tx.date) > dateEnd) return false; }
          return true;
        }).sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());
      },

      getTopSpendingCategories(){
        const spending = {};
        state.transactions.forEach(tx => { if (tx.type === 'expense') { const cat = tx.category || 'ØºÙŠØ± Ù…ØµÙ†Ù'; spending[cat] = (spending[cat] || 0) + Number(tx.amount || 0); }});
        return Object.entries(spending).map(([category, amount]) => ({ category, amount })).sort((a,b)=>b.amount-a.amount).slice(0,5);
      },

      getDashboardSummary(){
        let income=0, expense=0;
        state.transactions.forEach(tx => { if (tx.type === 'income') income += Number(tx.amount)||0; else if (tx.type === 'expense') expense += Number(tx.amount)||0; });
        const totalBalance = state.accounts.reduce((s,a) => s + (Number(a.currentBalance)||0), 0);
        return { income, expense, net: income - expense, totalBalance };
      }
    };

    // -------------------------
    // 3. View / DOM rendering
    // -------------------------
    const View = {
      renderAll(){ this.renderAccounts(); this.renderPayablesAndReceivables(); this.renderTransactions(); this.renderDashboard(); this.updateFilterDropdowns(); this.updateAccountDropdowns(['tx-account-from','tx-account-to','due-account-id']); },
      renderAccounts(){
        const list = document.getElementById('accounts-list'); list.innerHTML = '';
        if (state.accounts.length === 0) { list.innerHTML = '<p class="text-gray-500 text-sm">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ø¹Ø¯.</p>'; return; }
        state.accounts.forEach(acc => {
          const card = document.createElement('div'); card.className = 'p-4 rounded-lg border border-gray-200 bg-gray-50';
          card.innerHTML = `
            <div class="flex justify-between items-start">
              <div><h4 class="font-bold">${acc.name}</h4><span class="text-xs text-gray-500 bg-gray-200 px-2 py-0.5 rounded">${acc.type}</span></div>
              <div class="flex gap-2">
                <button class="btn-edit-account text-gray-400 hover:text-indigo-600" data-id="${acc.id}" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨">âœ</button>
                <button class="btn-delete-account text-gray-400 hover:text-red-600" data-id="${acc.id}" title="Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨">ğŸ—‘</button>
              </div>
            </div>
            <p class="text-xl font-bold text-indigo-700 mt-2">${formatCurrency(acc.currentBalance)}</p>
            <p class="text-xs text-gray-500">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ: ${formatCurrency(acc.initialBalance)}</p>
          `;
          list.appendChild(card);
        });
      },

      renderPayablesAndReceivables(){
        const allDues = CoreLogic.getDuesWithStatus();
        const receivables = allDues.filter(d => d.type === 'receivable');
        const payables = allDues.filter(d => d.type === 'payable');
        this.renderDuesList('tab-content-receivables', receivables);
        this.renderDuesList('tab-content-payables', payables);
      },

      renderDuesList(containerId, dues){
        const container = document.getElementById(containerId); container.innerHTML = '';
        if (dues.length === 0) { container.innerHTML = '<p class="text-gray-500 text-sm text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>'; return; }
        dues.forEach(due => {
          const item = document.createElement('div'); item.className = 'p-3 rounded-lg border border-gray-200 flex justify-between items-center';
          const account = CoreLogic.getAccountById(due.accountId);
          const isPaid = due.status === 'paid' && (due.recurrence === 'none' || !due.recurrence);
          item.innerHTML = `
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="text-xs font-medium px-2 py-0.5 rounded-full ${due.statusColor}">${due.statusText}</span>
                <h5 class="font-bold ${isPaid ? 'text-gray-500 line-through' : ''}">${due.name}</h5>
                ${due.recurrence === 'monthly' ? `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800">Ø´Ù‡Ø±ÙŠ</span>` : ''}
              </div>
              <p class="text-sm text-gray-600 mt-1">
                ${formatCurrency(due.amount)} <span class="text-xs text-gray-400">| Ù…Ø³ØªØ­Ù‚ ÙÙŠ: ${formatDate(due.dueDate)}</span>
                ${account ? `<span class="text-xs text-gray-400">| Ø§Ù„Ø­Ø³Ø§Ø¨: ${account.name}</span>` : ''}
              </p>
            </div>
            <div class="flex gap-2">
              ${!isPaid && due.type === 'receivable' ? `<button class="btn-collect-due text-sm bg-green-600 text-white px-3 py-1 rounded-md" data-id="${due.id}">ØªØ­ØµÙŠÙ„</button>` : ''}
              ${!isPaid && due.type === 'payable' ? `<button class="btn-pay-due text-sm bg-red-600 text-white px-3 py-1 rounded-md" data-id="${due.id}">Ø³Ø¯Ø§Ø¯</button>` : ''}
              <button class="btn-edit-due text-gray-400 hover:text-indigo-600" data-id="${due.id}" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø¯">âœ</button>
              <button class="btn-delete-due text-gray-400 hover:text-red-600" data-id="${due.id}" title="Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯">ğŸ—‘</button>
            </div>
          `;
          container.appendChild(item);
        });
      },

      renderTransactions(){
        const tbody = document.getElementById('transactions-table-body'); tbody.innerHTML = '';
        const filteredTxs = CoreLogic.getFilteredTransactions(currentFilters);
        const emptyState = document.getElementById('transactions-empty-state');
        if (filteredTxs.length === 0) { emptyState.classList.remove('hidden'); return; }
        emptyState.classList.add('hidden');

        const selectedAccountId = currentFilters.account;

        filteredTxs.forEach(tx => {
          // choose account name
          let accountIdToShow = selectedAccountId;
          if (selectedAccountId === 'all') accountIdToShow = tx.from || tx.to;
          const account = CoreLogic.getAccountById(accountIdToShow);
          const accountName = account ? account.name : (tx.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');

          let dain = '', madin = '', balanceAfter = null;
          if (selectedAccountId === 'all') {
            if (tx.type === 'income') dain = formatCurrency(tx.amount);
            else if (tx.type === 'expense') madin = formatCurrency(tx.amount);
            balanceAfter = null;
          } else {
            // ensure tx relates to selected account
            if (tx.from !== selectedAccountId && tx.to !== selectedAccountId) return;
            if (tx.type === 'income' && tx.to === selectedAccountId) dain = formatCurrency(tx.amount);
            else if (tx.type === 'expense' && tx.from === selectedAccountId) madin = formatCurrency(tx.amount);
            else if (tx.type === 'income' && tx.from === selectedAccountId) madin = formatCurrency(tx.amount);
            else if (tx.type === 'expense' && tx.to === selectedAccountId) dain = formatCurrency(tx.amount);
            balanceAfter = (tx.balanceAfter !== undefined) ? tx.balanceAfter : null;
          }

          const balanceColor = (balanceAfter !== null) ? (balanceAfter >= 0 ? 'text-gray-800' : 'text-red-600') : 'text-gray-800';

          const row = document.createElement('tr'); row.className = 'border-b hover:bg-gray-50';
          row.innerHTML = `
            <td class="p-3 text-gray-600 text-xs">${formatDateTime(tx.date)}</td>
            <td class="p-3">${accountName}</td>
            <td class="p-3">${tx.category || ''} <span class="block text-xs text-gray-400">${tx.notes || ''}</span></td>
            <td class="p-3 text-green-600 font-medium">${dain}</td>
            <td class="p-3 text-red-600 font-medium">${madin}</td>
            <td class="p-3 font-medium ${balanceColor}">${balanceAfter !== null ? formatCurrency(balanceAfter) : '---'}</td>
            <td class="p-3">
              <button class="btn-edit-tx text-gray-400 hover:text-indigo-600" data-id="${tx.id}" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©">âœ</button>
              <button class="btn-delete-tx text-gray-400 hover:text-red-600" data-id="${tx.id}" title="Ø­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ©">ğŸ—‘</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      },

      renderDashboard(){
        const summary = CoreLogic.getDashboardSummary();
        document.getElementById('summary-income').textContent = formatCurrency(summary.income);
        document.getElementById('summary-expense').textContent = formatCurrency(summary.expense);
        const netElem = document.getElementById('summary-net');
        netElem.textContent = formatCurrency(summary.net);
        netElem.classList.toggle('text-green-600', summary.net >= 0);
        netElem.classList.toggle('text-red-600', summary.net < 0);
        document.getElementById('summary-total-balance').textContent = formatCurrency(summary.totalBalance);
      },

      updateFilterDropdowns(){
        const select = document.getElementById('filter-account'); const cur = select.value || 'all';
        select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>';
        state.accounts.forEach(acc => select.innerHTML += `<option value="${acc.id}">${acc.name}</option>`);
        select.value = cur;
      },

      updateAccountDropdowns(selectIds){
        selectIds.forEach(id => {
          const sel = document.getElementById(id);
          if (!sel) return;
          sel.innerHTML = '';
          if (state.accounts.length === 0) { sel.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</option>'; return; }
          state.accounts.forEach(acc => sel.innerHTML += `<option value="${acc.id}">${acc.name} (${formatCurrency(acc.currentBalance)})</option>`);
        });
      },

      resetTxForm(){
        document.getElementById('transaction-form').reset();
        document.getElementById('tx-id').value = '';
        document.getElementById('tx-linked-id').value = '';
        document.getElementById('tx-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©';
        const nowSlice = new Date().toISOString().slice(0,16);
        document.getElementById('tx-date').value = nowSlice;
        this.toggleTxFormFields('expense');
      },

      resetAccountForm(){
        document.getElementById('account-form').reset();
        document.getElementById('account-id').value = '';
        document.getElementById('account-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      },

      resetDueForm(){
        document.getElementById('due-form').reset();
        document.getElementById('due-id').value = '';
        document.getElementById('due-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯';
        document.getElementById('due-date').value = formatDate(new Date());
        document.getElementById('due-recurrence').value = 'none';
      },

      toggleTxFormFields(type){
        const fromContainer = document.getElementById('tx-account-from-container');
        const toContainer = document.getElementById('tx-account-to-container');
        const category = document.getElementById('tx-category');
        fromContainer.classList.add('hidden'); toContainer.classList.add('hidden'); category.parentElement.classList.add('hidden');
        this.updateAccountDropdowns(['tx-account-from','tx-account-to']);
        if (type === 'income') { toContainer.classList.remove('hidden'); category.parentElement.classList.remove('hidden'); document.getElementById('tx-account-from').value=''; }
        else if (type === 'expense') { fromContainer.classList.remove('hidden'); category.parentElement.classList.remove('hidden'); document.getElementById('tx-account-to').value=''; }
        else if (type === 'transfer') { fromContainer.classList.remove('hidden'); toContainer.classList.remove('hidden'); category.parentElement.classList.add('hidden'); }
      },

      populateTxFormForEdit(tx){
        this.resetTxForm();
        document.getElementById('tx-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø­Ø±ÙƒØ©';
        let txData = {...tx};
        if (tx.linkedId) {
          const linked = CoreLogic.getTransactionById(tx.linkedId);
          txData.type = 'transfer';
          if (tx.type === 'expense') { txData.from = tx.from; txData.to = linked ? linked.to : ''; }
          else { txData.from = linked ? linked.from : ''; txData.to = tx.to; }
          document.getElementById('tx-linked-id').value = tx.linkedId;
        }
        document.getElementById('tx-id').value = txData.id;
        document.getElementById('tx-type').value = txData.type;
        document.getElementById('tx-amount').value = txData.amount;
        document.getElementById('tx-date').value = new Date(txData.date).toISOString().slice(0,16);
        document.getElementById('tx-category').value = txData.category || '';
        document.getElementById('tx-notes').value = txData.notes || '';
        this.toggleTxFormFields(txData.type);
        document.getElementById('tx-account-from').value = txData.from || '';
        document.getElementById('tx-account-to').value = txData.to || '';
        this.openModal('transaction-modal');
      },

      populateAccountFormForEdit(account){
        this.resetAccountForm();
        document.getElementById('account-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨';
        document.getElementById('account-id').value = account.id;
        document.getElementById('account-name').value = account.name;
        document.getElementById('account-type').value = account.type;
        document.getElementById('account-initial-balance').value = account.initialBalance;
        this.openModal('account-modal');
      },

      populateDueFormForEdit(due){
        this.resetDueForm();
        document.getElementById('due-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¯';
        document.getElementById('due-id').value = due.id;
        document.getElementById('due-type').value = due.type;
        document.getElementById('due-name').value = due.name;
        document.getElementById('due-amount').value = due.amount;
        document.getElementById('due-date').value = formatDate(due.dueDate);
        document.getElementById('due-account-id').value = due.accountId;
        document.getElementById('due-recurrence').value = due.recurrence || 'none';
        this.openModal('due-modal');
      },

      openModal(modalId){ document.getElementById(modalId).classList.add('is-open'); },
      closeModal(modalId){ document.getElementById(modalId).classList.remove('is-open'); if (modalId === 'transaction-modal') this.resetTxForm(); if (modalId === 'account-modal') this.resetAccountForm(); if (modalId === 'due-modal') this.resetDueForm(); },

      showToast(message, type='info'){
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        let bg = 'bg-blue-100 text-blue-800 border border-blue-200';
        if (type === 'success') bg = 'bg-green-100 text-green-800 border border-green-200';
        if (type === 'error') bg = 'bg-red-100 text-red-800 border border-red-200';
        toast.className = `toast ${bg}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(()=> toast.remove(), 4200);
      }
    };

    // -------------------------
    // 4. Event bindings
    // -------------------------
    function attachListeners(){
      // header buttons
      document.getElementById('btn-add-transaction').addEventListener('click', ()=>{ View.resetTxForm(); View.openModal('transaction-modal'); });
      document.getElementById('btn-open-add-account').addEventListener('click', ()=>{ View.resetAccountForm(); View.openModal('account-modal'); });
      document.getElementById('btn-open-add-due').addEventListener('click', ()=>{ View.resetDueForm(); View.openModal('due-modal'); });
      document.getElementById('btn-open-import-export').addEventListener('click', ()=> View.openModal('import-export-modal'));
      document.getElementById('btn-open-test-runner').addEventListener('click', ()=> View.openModal('test-runner-modal'));
      document.getElementById('btn-gemini-summary').addEventListener('click', handleGeminiSummary);

      // modal close buttons and overlay clicks
      document.querySelectorAll('.btn-close-modal').forEach(el => el.addEventListener('click', (e)=> { const modal = e.target.closest('.modal'); if (modal) modal.classList.remove('is-open'); }));
      document.querySelectorAll('.modal').forEach(el => el.addEventListener('click', (e)=> { if (e.target === el) el.classList.remove('is-open'); }));
      // prevent overlay close when clicking inner content
      document.querySelectorAll('.modal > div').forEach(el => el.addEventListener('click', e => e.stopPropagation()));

      // account form
      document.getElementById('account-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('account-id').value;
        const name = document.getElementById('account-name').value.trim();
        const type = document.getElementById('account-type').value;
        const initialBalance = parseFloat(document.getElementById('account-initial-balance').value || 0);
        if (!name || !type) { View.showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error'); return; }
        if (id) { CoreLogic.updateAccount(id, name, type, initialBalance); View.showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success'); }
        else { CoreLogic.addAccount(name, type, initialBalance); View.showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success'); }
        View.closeModal('account-modal'); View.renderAll();
      });

      // transaction form
      document.getElementById('transaction-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('tx-id').value;
        const type = document.getElementById('tx-type').value;
        const amount = parseFloat(document.getElementById('tx-amount').value || 0);
        const txData = {
          type,
          date: document.getElementById('tx-date').value,
          amount,
          from: document.getElementById('tx-account-from').value || null,
          to: document.getElementById('tx-account-to').value || null,
          category: document.getElementById('tx-category').value,
          notes: document.getElementById('tx-notes').value
        };
        // validation
        if (!txData.date || !amount || amount <= 0) { View.showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error'); return; }
        if (type === 'income' && !txData.to) { View.showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨ (Ø§Ù„Ù‡Ø¯Ù) Ù„Ù„Ø¯Ø®Ù„', 'error'); return; }
        if (type === 'expense' && !txData.from) { View.showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨ (Ø§Ù„Ù…ØµØ¯Ø±) Ù„Ù„Ù…ØµØ±ÙˆÙ', 'error'); return; }
        if (type === 'transfer' && (!txData.from || !txData.to)) { View.showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨ÙŠ Ø§Ù„Ù…ØµØ¯Ø± ÙˆØ§Ù„Ù‡Ø¯Ù Ù„Ù„ØªØ­ÙˆÙŠÙ„', 'error'); return; }
        if (type === 'transfer' && txData.from === txData.to) { View.showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨', 'error'); return; }
        if (id) { CoreLogic.updateTransaction(id, txData); View.showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­', 'success'); }
        else { CoreLogic.addTransaction(txData); View.showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­', 'success'); }
        View.closeModal('transaction-modal'); View.renderAll();
      });

      // toggle tx form fields on type change
      document.getElementById('tx-type').addEventListener('change', (e) => View.toggleTxFormFields(e.target.value));

      // due form
      document.getElementById('due-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('due-id').value;
        const data = {
          type: document.getElementById('due-type').value,
          name: document.getElementById('due-name').value,
          amount: parseFloat(document.getElementById('due-amount').value || 0),
          dueDate: document.getElementById('due-date').value,
          accountId: document.getElementById('due-account-id').value,
          recurrence: document.getElementById('due-recurrence').value
        };
        if (!data.name || !data.amount || data.amount <= 0 || !data.dueDate || !data.accountId) { View.showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'error'); return; }
        if (id) { CoreLogic.updateDue(id, data); View.showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success'); }
        else { CoreLogic.addDue(data); View.showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success'); }
        View.closeModal('due-modal'); View.renderPayablesAndReceivables(); View.renderAll();
      });

      // account list actions
      document.getElementById('accounts-list').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.btn-edit-account');
        const deleteBtn = e.target.closest('.btn-delete-account');
        if (editBtn) {
          const id = editBtn.dataset.id;
          const account = CoreLogic.getAccountById(id);
          if (account) View.populateAccountFormForEdit(account);
        }
        if (deleteBtn) {
          const id = deleteBtn.dataset.id;
          showConfirmModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ', () => {
            if (CoreLogic.deleteAccount(id)) {
              View.showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨', 'success'); View.renderAll();
            } else View.showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±ÙƒØ§Øª', 'error');
          });
        }
      });

      // transactions actions
      document.getElementById('transactions-table-body').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.btn-edit-tx');
        const deleteBtn = e.target.closest('.btn-delete-tx');
        if (editBtn) {
          const id = editBtn.dataset.id; const tx = CoreLogic.getTransactionById(id);
          if (tx) View.populateTxFormForEdit(tx);
        }
        if (deleteBtn) {
          const id = deleteBtn.dataset.id; const tx = CoreLogic.getTransactionById(id);
          const msg = tx && tx.linkedId ? 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø­Ø±ÙƒØªÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø§Ù„ØµØ§Ø¯Ø± ÙˆØ§Ù„ÙˆØ§Ø±Ø¯). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ' : 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ';
          showConfirmModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', msg, () => { CoreLogic.deleteTransaction(id); View.showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ©', 'success'); View.renderAll(); });
        }
      });

      // dues actions delegation
      document.getElementById('tab-content-receivables').addEventListener('click', handleDueActions);
      document.getElementById('tab-content-payables').addEventListener('click', handleDueActions);
      function handleDueActions(e){
        const collectBtn = e.target.closest('.btn-collect-due');
        const payBtn = e.target.closest('.btn-pay-due');
        const editBtn = e.target.closest('.btn-edit-due');
        const deleteBtn = e.target.closest('.btn-delete-due');

        if (collectBtn) {
          const id = collectBtn.dataset.id; const due = CoreLogic.getDueById(id);
          showConfirmModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„', `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯ ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„Øº ${formatCurrency(due.amount)} Ù„Ø¨Ù†Ø¯ "${due.name}"ØŸ`, () => {
            if (CoreLogic.collectReceivable(id)) { View.showToast('ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©', 'success'); View.renderAll(); }
          }, 'bg-green-600', 'Ù†Ø¹Ù…ØŒ Ù‚Ù… Ø¨Ø§Ù„ØªØ­ØµÙŠÙ„');
        }

        if (payBtn) {
          const id = payBtn.dataset.id; const due = CoreLogic.getDueById(id);
          showConfirmModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø¯Ø§Ø¯', `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯ Ø³Ø¯Ø§Ø¯ Ù…Ø¨Ù„Øº ${formatCurrency(due.amount)} Ù„Ø¨Ù†Ø¯ "${due.name}"ØŸ`, () => {
            if (CoreLogic.payPayable(id)) { View.showToast('ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©', 'success'); View.renderAll(); }
          }, 'bg-red-600', 'Ù†Ø¹Ù…ØŒ Ù‚Ù… Ø¨Ø§Ù„Ø³Ø¯Ø§Ø¯');
        }

        if (editBtn) {
          const id = editBtn.dataset.id; const due = CoreLogic.getDueById(id);
          if (due) View.populateDueFormForEdit(due);
        }

        if (deleteBtn) {
          const id = deleteBtn.dataset.id;
          showConfirmModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ', () => { CoreLogic.deleteDue(id); View.showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯', 'success'); View.renderPayablesAndReceivables(); });
        }
      }

      // tabs logic
      const tabs = [
        { btn: document.getElementById('btn-tab-receivables'), content: document.getElementById('tab-content-receivables') },
        { btn: document.getElementById('btn-tab-payables'), content: document.getElementById('tab-content-payables') }
      ];
      tabs.forEach(tab => {
        tab.btn.addEventListener('click', () => {
          tabs.forEach(t => { t.btn.classList.remove('active'); t.btn.classList.add('text-gray-500'); t.content.classList.add('hidden'); });
          tab.btn.classList.add('active'); tab.btn.classList.remove('text-gray-500'); tab.content.classList.remove('hidden');
        });
      });

      // confirm modal
      let confirmCallback = null;
      const btnConfirmAction = document.getElementById('btn-confirm-action');
      const btnConfirmCancel = document.getElementById('btn-confirm-cancel');
      function showConfirmModal(title, message, onConfirm, btnClass='bg-red-600', btnText='Ù†Ø¹Ù…') {
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').textContent = message;
        confirmCallback = onConfirm;
        btnConfirmAction.textContent = btnText;
        btnConfirmAction.className = `px-4 py-2 rounded-lg text-white transition ${btnClass}`;
        View.openModal('confirm-modal');
      }
      btnConfirmAction.addEventListener('click', () => { if (confirmCallback) confirmCallback(); confirmCallback = null; View.closeModal('confirm-modal'); });
      btnConfirmCancel.addEventListener('click', () => { confirmCallback = null; View.closeModal('confirm-modal'); });

      // filters
      document.getElementById('btn-apply-filters').addEventListener('click', applyFilters);
      document.getElementById('btn-clear-filters').addEventListener('click', clearFilters);
      function applyFilters(){
        currentFilters.account = document.getElementById('filter-account').value;
        currentFilters.type = document.getElementById('filter-type').value;
        currentFilters.dateStart = document.getElementById('filter-date-start').value;
        currentFilters.dateEnd = document.getElementById('filter-date-end').value;
        View.renderTransactions();
      }
      function clearFilters(){
        document.getElementById('filter-account').value = 'all';
        document.getElementById('filter-type').value = 'all';
        document.getElementById('filter-date-start').value = '';
        document.getElementById('filter-date-end').value = '';
        applyFilters();
      }

      // import/export
      document.getElementById('btn-export-data').addEventListener('click', () => {
        const data = StorageService.exportData();
        const blob = new Blob([data], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `dafatir_${formatDate(new Date())}.json`; a.click(); URL.revokeObjectURL(url);
        View.showToast('ØªÙ… Ø¨Ø¯Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
      });

      document.getElementById('btn-import-data').addEventListener('click', () => {
        const fileInput = document.getElementById('import-file');
        if (!fileInput.files.length) { View.showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹', 'error'); return; }
        const reader = new FileReader();
        reader.onload = (e) => {
          showConfirmModal('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ', () => {
            if (StorageService.importData(e.target.result)) {
              CoreLogic.recalculateAllBalances(); StorageService.save(); View.renderAll(); View.showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success'); View.closeModal('import-export-modal');
            } else { View.showToast('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.', 'error'); }
          }, 'bg-green-600','Ù†Ø¹Ù…ØŒ Ø§Ø³ØªÙˆØ±Ø¯');
        };
        reader.readAsText(fileInput.files[0]);
      });

      // test runner
      document.getElementById('btn-run-tests').addEventListener('click', runUnitTests);

      // dark mode toggle
      const darkBtn = document.getElementById('toggle-dark-mode');
      if (localStorage.getItem('darkMode') === 'on') document.body.classList.add('dark-mode');
      darkBtn.addEventListener('click', () => { const on = document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', on ? 'on' : 'off'); });

      // accounts and transactions delegated click handlers already attached above
    }

    // -------------------------
    // 5. Gemini (placeholder)
    // -------------------------
    // Note: real Gemini/AI requires API key & proper backend. This function uses the GeminiService.fetchGemini placeholder.
    async function handleGeminiSummary(){
      View.openModal('gemini-summary-modal');
      const loadingEl = document.getElementById('gemini-loading');
      const resultsEl = document.getElementById('gemini-results');
      loadingEl.classList.remove('hidden'); resultsEl.innerHTML = '';

      const summary = CoreLogic.getDashboardSummary();
      const topSpending = CoreLogic.getTopSpendingCategories();

      const systemPrompt = `Ø£Ù†Øª Ù…Ø³ØªØ´Ø§Ø± Ù…Ø§Ù„ÙŠ Ø´Ø®ØµÙŠ... (Ù…Ø­Ù„ÙŠ)`;
      const userQuery = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„: ${summary.income}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${summary.expense}\nØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚: ${summary.net}\nÙØ¦Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:\n${topSpending.length ? topSpending.map(c=>`- ${c.category}: ${c.amount}`).join('\n') : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª'}\nØ£Ø¹Ø·Ù†ÙŠ ØªØ­Ù„ÙŠÙ„ ÙˆÙ†ØµÙŠØ­Ø© Ù‚ØµÙŠØ±Ø©.`;

      // Placeholder: offline simple analysis
      setTimeout(() => {
        const advice = topSpending.length ? `Ù„Ùˆ Ø³Ù…Ø­Øª Ø±Ø§Ø¬Ø¹ ÙØ¦Ø© Ø§Ù„Ø¥Ù†ÙØ§Ù‚ ${topSpending[0].category} Ù„Ø£Ù†Ù‡Ø§ ØªÙ…Ø«Ù„ Ø¬Ø²Ø¡Ø§Ù‹ ÙƒØ¨ÙŠØ±Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.` : `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ â€” Ù…Ù…ØªØ§Ø²! Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø°Ù„Ùƒ.`;
        resultsEl.innerHTML = `<p><strong>Ù…Ù„Ø®Øµ Ù‚ØµÙŠØ±:</strong><br>${summary.net >= 0 ? 'ÙˆØ¶Ø¹Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø¬ÙŠØ¯ Ù†Ø³Ø¨ÙŠØ§Ù‹.' : 'ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚ Ø³Ù„Ø¨ÙŠØ› Ù„Ø§Ø­Ø¸ Ø§Ù„Ù†ÙÙ‚Ø§Øª.'}</p><p class="mt-2"><strong>Ù†ØµÙŠØ­Ø©:</strong><br>${advice}</p>`;
        loadingEl.classList.add('hidden');
      }, 700);
    }

    // -------------------------
    // 6. Unit tests (simple)
    // -------------------------
    function runUnitTests(){
      const container = document.getElementById('test-results-container'); container.innerHTML = '';
      const log = (msg, color='#9ca3af') => container.innerHTML += `<div style="color:${color};margin-bottom:6px">${msg}</div>`;
      log('--- Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ---');
      try {
        // Test 1: add account & tx
        const aId = crypto.randomUUID(); state.accounts.push({ id:aId, name:'T', type:'cash', initialBalance:1000, currentBalance:1000 });
        state.transactions.push({ id:crypto.randomUUID(), createdAt:new Date().toISOString(), date:new Date().toISOString(), type:'income', to:aId, from:null, amount:500 });
        CoreLogic.recalculateAllBalances();
        const acc = CoreLogic.getAccountById(aId);
        if (acc.currentBalance === 1500) log('âœ… Test 1 passed', '#22c55e'); else log(`âŒ Test 1 failed: balance=${acc.currentBalance}`, '#ef4444');
      } catch (e) { log('âŒ Test error: '+e.message, '#ef4444'); }
      log('--- Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ---');
    }

    // -------------------------
    // 7. Init
    // -------------------------
    document.addEventListener('DOMContentLoaded', () => {
      StorageService.load();
      CoreLogic.recalculateAllBalances();
      View.renderAll();
      attachListeners();
      View.showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ!', 'info');
    });

  </script>
</body>
</html>
