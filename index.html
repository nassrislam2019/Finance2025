<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساباتي — تتبُّع المصروفات والدخل</title>
<meta name="description" content="موقع شخصي بسيط لإدارة المصروفات والدخل — يعمل أوفلاين (PWA) ويحفظ البيانات محليًا." />
<meta name="theme-color" content="#ffffff" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<style>
:root{
  --bg:#ffffff; --card:#f2f2f2; --muted:#555; --txt:#000;
  --brand:#0077cc; --brand-2:#3399ff; --danger:#ef4444; --warn:#f59e0b; --ok:#22c55e; --border:#d0d0d0;
  --radius:14px; --field-h:46px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Kufi Arabic",Tahoma,Arial,sans-serif}
a{color:var(--brand);text-decoration:none}
.container{max-width:1180px;margin-inline:auto;padding:20px}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:0;overflow:hidden}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
.card-head h3{margin:0;font-size:18px}
.card-body{padding:14px;border-top:1px solid var(--border)}
.card.collapsed .card-body{display:none}
.toggle{appearance:none;border:none;background:transparent;cursor:pointer;border-radius:10px;font-size:18px;padding:6px 10px;color:#333}

/* Layout */
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,textarea{width:100%;background:#fff;color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;height:var(--field-h)}
input[type="date"],input[type="month"]{direction:ltr;text-align:center;font-variant-numeric:tabular-nums}
.checkbox-row{display:flex;align-items:center;gap:8px}
.checkbox-row input[type="checkbox"]{width:18px;height:18px}

.btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:opacity .15s;height:var(--field-h)}
.btn:hover{opacity:.95}
.btn-primary{background:var(--brand);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--txt)}
.btn-danger{background:var(--danger);color:#fff}
.btn-muted{background:#e6e6e6;color:var(--muted);border:1px dashed var(--border)}

.stats{display:grid;gap:10px}
@media(min-width:720px){.stats{grid-template-columns:repeat(5,1fr)}}
.stat{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:12px}
.stat small{color:var(--muted)}
.stat .num{font-weight:800;font-size:22px;margin-top:4px}
.pos{color:var(--ok)}.neg{color:var(--danger)}

.report-table-wrap{overflow:auto;max-height:340px}
#tbodyMonthly tr.active{background:rgba(0,119,204,0.1);box-shadow:0 0 0 1px rgba(0,119,204,0.3)}

.month-insights{margin-top:18px;display:grid;gap:16px}
.month-stats{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.month-stats .stat{background:#fff}
.month-selected{font-weight:700;font-size:18px;margin-top:6px}
.month-note{color:var(--muted);font-size:12px}
.month-cats{gap:16px}
.month-cats h4{margin:0 0 10px;font-size:15px;color:var(--muted)}
.bar-list{display:flex;flex-direction:column;gap:10px}
.bar-item{display:grid;gap:6px}
.bar-item .label{font-size:13px;font-weight:600;color:var(--txt)}
.bar-item .bar-track{background:#f1f5f9;border-radius:999px;height:26px;position:relative;overflow:hidden}
.bar-item .bar-fill{position:absolute;left:0;top:0;bottom:0;width:var(--w,0%);border-radius:999px;display:flex;align-items:center;justify-content:flex-end;padding-inline:12px;font-weight:700;color:#fff;font-size:13px;transition:width .3s ease}
.bar-item .bar-fill span{position:relative;z-index:1}
.bar-item .bar-fill.expense{background:linear-gradient(90deg,#fb7185,#ef4444)}
.bar-item .bar-fill.income{background:linear-gradient(90deg,#34d399,#22c55e)}
.bar-item .value{font-size:12px;color:var(--muted)}
.empty-state{padding:12px;border:1px dashed var(--border);border-radius:var(--radius);text-align:center;font-size:13px;color:var(--muted)}
.report-legend{display:flex;gap:12px;font-size:12px;color:var(--muted);align-items:center;flex-wrap:wrap;margin-top:8px}
.legend-dot{width:12px;height:12px;border-radius:999px;display:inline-block}

table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:right;padding:6px 10px}
tbody tr{background:#fff;border:1px solid var(--border);border-radius:var(--radius)}
tbody td{padding:12px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
tbody tr td:first-child{border-right:1px solid var(--border);border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
tbody tr td:last-child{border-left:1px solid var(--border);border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
.amount.exp{color:var(--danger);font-weight:700}.amount.inc{color:var(--ok);font-weight:700}

.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.spacer{flex:1}
.badge{display:inline-flex;gap:6px;align-items:center;background:#e6e6e6;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:var(--field-h)}
.footer{margin-top:24px;color:var(--muted);font-size:12px;text-align:center}
.note{color:var(--warn)}
canvas{background:#fff;border:1px solid var(--border);border-radius:var(--radius);display:block;width:100%;height:320px}
.hr{height:1px;background:var(--border);opacity:.7;margin:12px 0;border-radius:999px}
.list-plain{display:flex;flex-wrap:wrap;gap:8px}
.list-plain .item{background:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:12px}

/* تحويل */
.transfer-grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
.transfer-grid .full{grid-column:1/-1}
@media(max-width:900px){.transfer-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:720px){
  .grid-2{grid-template-columns:1fr}
  .grid-4{grid-template-columns:1fr 1fr}
  .badge{height:auto}
  .card-head h3{font-size:17px}
  .transfer-grid{grid-template-columns:1fr}
}

/* ===== استحقاقات قريبة ===== */
.d-none{display:none!important;} /* للتحكم من JS بدون كسر الميديا كويري */

#dueSoonWrap{overflow:auto;-webkit-overflow-scrolling:touch;}
#dueSoonWrap table{min-width:760px;}
#dueSoonWrap td.actions{white-space:nowrap;}
#dueSoonCards{display:none;}      /* افتراضيًا مخفي */

/* على الشاشات الصغيرة: نخفي الجدول ونُظهر الكروت */
@media(max-width:720px){
  #dueSoonWrap{display:none;}
  #dueSoonCards{display:block;}
  .month-stats{grid-template-columns:1fr 1fr;}
  .month-cats{grid-template-columns:1fr;}
  .report-table-wrap{max-height:none;}
}

/* بطاقات الموبايل */
.due-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;display:grid;gap:6px}
.due-card .row{display:flex;justify-content:space-between;gap:8px}
.due-card .name{font-weight:700}
.due-card .remain{font-weight:800}
.due-card .state{color:var(--warn);font-weight:700}
.due-card .state.over{color:var(--danger)}
.due-card .meta{color:var(--muted);font-size:12px}
.due-card .actions{display:flex;gap:8px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <div class="title">دفتر حساباتي</div>
      <div class="sub">تتبُّع المصروفات والدخل — يعمل أوفلاين (PWA) والبيانات محفوظة محليًا</div>
    </div>
    <div class="toolbar">
      <button id="exportJson" class="btn btn-outline" type="button">تصدير JSON</button>
      <button id="exportCsv" class="btn btn-outline" type="button">تصدير CSV</button>
      <label class="btn btn-muted" for="importFile">استيراد JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
      <button id="syncNow" class="btn btn-outline" type="button">مزامنة الآن</button>
@@ -325,58 +351,92 @@ canvas{background:#fff;border:1px solid var(--border);border-radius:var(--radius
      <div class="toolbar" style="margin-top:10px">
        <button id="addCollect" class="btn btn-outline">إضافة/تحديث</button>
        <span class="spacer"></span><span class="badge">لا يظهر في الحركات إلا بعد "تم التحصيل"</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>الاسم</th><th>المبلغ</th><th>التحصيل القادم</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th></tr></thead>
          <tbody id="tbodyCollect"></tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <!-- (4) التقارير -->
  <section class="card collapsed" id="card-reports" data-collapsible>
    <div class="card-head"><h3>تقارير شهرية و رسوم بيانية</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="toolbar" style="margin-bottom:8px">
        <input id="monthPicker" type="month" />
        <button id="refreshReports" class="btn btn-outline">تحديث</button>
        <span class="spacer"></span><span class="badge">إجمالي الدخل/المصروف لكل شهر</span>
      </div>
      <div class="grid grid-2">
        <div><canvas id="chartMonthly" width="560" height="320" aria-label="Monthly chart"></canvas></div>
        <div style="overflow:auto">
        <div>
          <canvas id="chartMonthly" width="560" height="320" aria-label="Monthly chart"></canvas>
          <div class="report-legend">
            <span><span class="legend-dot" style="background:#22c55e"></span> دخل</span>
            <span><span class="legend-dot" style="background:#ef4444"></span> مصروف</span>
            <span><span class="legend-dot" style="background:transparent;border:2px solid #0ea5e9"></span> صافي</span>
            <span style="margin-inline-start:auto;font-size:11px">القيم مقيّسة وفق أكبر شهر</span>
          </div>
        </div>
        <div class="report-table-wrap">
          <table>
            <thead><tr><th>الشهر</th><th>إجمالي الدخل</th><th>إجمالي المصروف</th><th>الصافي</th></tr></thead>
            <tbody id="tbodyMonthly"></tbody>
          </table>
        </div>
      </div>

      <div class="month-insights">
        <div class="stats month-stats">
          <div class="stat">
            <small>الشهر المحدد</small>
            <div id="monthSelectedLabel" class="month-selected">—</div>
          </div>
          <div class="stat"><small>إجمالي الدخل</small><div id="monthStatIncome" class="num pos">0.00</div></div>
          <div class="stat"><small>إجمالي المصروف</small><div id="monthStatExpense" class="num neg">0.00</div></div>
          <div class="stat"><small>الصافي</small><div id="monthStatNet" class="num">0.00</div></div>
          <div class="stat"><small>عدد الحركات</small><div id="monthStatTx" class="num">0</div></div>
          <div class="stat"><small>متوسط الصرف اليومي</small><div id="monthStatAvg" class="num">0.00</div></div>
        </div>
        <div id="monthNoData" class="empty-state d-none">لا توجد بيانات للشهر المحدد حتى الآن.</div>
        <div class="month-note">يتم تجاهل التحويلات الداخلية والرسوم المرتبطة بها من حساب الدخل/المصروف.</div>
        <div class="grid grid-2 month-cats">
          <div>
            <h4>أعلى المصروفات حسب الفئة</h4>
            <div id="monthCatsExpense" class="bar-list"></div>
          </div>
          <div>
            <h4>أهم مصادر الدخل</h4>
            <div id="monthCatsIncome" class="bar-list"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <!-- إعدادات GitHub -->
  <section class="card collapsed" id="card-github" data-collapsible>
    <div class="card-head"><h3>إعدادات مزامنة GitHub</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="grid grid-4">
        <div><label>اسم المستخدم</label><input id="ghUser" placeholder="مثال: username" /></div>
        <div><label>المستودع</label><input id="ghRepo" placeholder="مثال: Finance2025" /></div>
        <div><label>الفرع</label><input id="ghBranch" value="main" /></div>
        <div><label>مسار الملف (JSON)</label><input id="ghPath" value="my-finance.json" /></div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <div><label>Personal Access Token</label><input id="ghToken" type="password" placeholder="ghp_..." /></div>
        <div class="checkbox-row" style="margin-top:22px"><input id="ghAuto" type="checkbox"/><label for="ghAuto" style="margin:0">مزامنة تلقائيًا بعد كل تعديل</label></div>
        <div class="grid grid-2" style="margin-top:22px">
          <button id="ghSaveCfg" class="btn btn-outline">حفظ الإعدادات</button>
          <button id="ghTest" class="btn btn-outline">اختبار الاتصال</button>
        </div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <button id="ghPull" class="btn btn-outline">تحميل من GitHub</button>
@@ -420,81 +480,85 @@ function ensureBaseCategories(){
  if(categories.length===0){
    categories=[
      {name:'مرتب',type:'income'},{name:'دخل آخر',type:'income'},
      {name:'أكل وشرب',type:'expense'},{name:'مواصلات',type:'expense'},{name:'فواتير',type:'expense'},{name:'تسوق',type:'expense'}
    ];
    changed=true;
  }
  for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } }
  if(changed) saveCategories();
}
ensureBaseCategories();

/* DOM */
const $=s=>document.querySelector(s);
const els={
  totalBalance:$('#totalBalance'), balanceAfterCommit:$('#balanceAfterCommit'),
  monthCommitTotal:$('#monthCommitTotal'), monthIncome:$('#monthIncome'), txCount:$('#txCount'),
  perAccount:$('#perAccount'),
  tbody:$('#tbody'), type:$('#type'), amount:$('#amount'), date:$('#date'), desc:$('#desc'),
  account:$('#account'), category:$('#category'), linkCommit:$('#linkCommit'),
  saveTx:$('#saveTx'), resetForm:$('#resetForm'), search:$('#search'),
  exportJson:$('#exportJson'), exportCsv:$('#exportCsv'), importFile:$('#importFile'), syncNow:$('#syncNow'),
  newAccountName:$('#newAccountName'), newAccountOpening:$('#newAccountOpening'), addAccount:$('#addAccount'), accountsList:$('#accountsList'),
  newCatName:$('#newCatName'), newCatType:$('#newCatType'), addCategory:$('#addCategory'), catsList:$('#catsList'),
  monthPicker:$('#monthPicker'), refreshReports:$('#refreshReports'), tbodyMonthly:$('#tbodyMonthly'), chartMonthly:$('#chartMonthly'),
  monthSelectedLabel:$('#monthSelectedLabel'), monthStatIncome:$('#monthStatIncome'), monthStatExpense:$('#monthStatExpense'),
  monthStatNet:$('#monthStatNet'), monthStatTx:$('#monthStatTx'), monthStatAvg:$('#monthStatAvg'), monthNoData:$('#monthNoData'),
  monthCatsExpense:$('#monthCatsExpense'), monthCatsIncome:$('#monthCatsIncome'),
  /* التزامات */
  cName:$('#cName'), cAmount:$('#cAmount'), cFirstDue:$('#cFirstDue'), cRecurring:$('#cRecurring'), cEndAt:$('#cEndAt'),
  addCommitment:$('#addCommitment'), tbodyCommit:$('#tbodyCommit'),
  /* تحصيل */
  coName:$('#coName'), coAmount:$('#coAmount'), coFirstDue:$('#coFirstDue'), coRecurring:$('#coRecurring'), coEndAt:$('#coEndAt'),
  addCollect:$('#addCollect'), tbodyCollect:$('#tbodyCollect'),
  /* PWA & تحويل */
  installBtn:$('#installBtn'),
  trFrom:$('#trFrom'), trTo:$('#trTo'), trAmount:$('#trAmount'), trFee:$('#trFee'), trDate:$('#trDate'), trDesc:$('#trDesc'),
  execTransfer:$('#execTransfer'), resetTransfer:$('#resetTransfer'),
  /* GitHub */
  ghUser:$('#ghUser'), ghRepo:$('#ghRepo'), ghBranch:$('#ghBranch'), ghPath:$('#ghPath'), ghToken:$('#ghToken'),
  ghAuto:$('#ghAuto'), ghSaveCfg:$('#ghSaveCfg'), ghTest:$('#ghTest'), ghPull:$('#ghPull'), ghPush:$('#ghPush'), ghStatus:$('#ghStatus'),
  /* إجمالي الاستحقاقات + كروت الموبايل */
  dueTotalBadge:$('#dueTotalBadge'), dueSoonCards:$('#dueSoonCards')
};
['saveTx','resetForm','addAccount','addCategory','exportJson','exportCsv','refreshReports','addCommitment','addCollect','execTransfer','resetTransfer','syncNow','ghSaveCfg','ghTest','ghPull','ghPush']
  .forEach(id=>document.getElementById(id)?.setAttribute('type','button'));

/* Utils */
const eid=()=>Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const fmt=n=>Number(n).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const escapeHtml=s=>String(s).replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
els.date.value=new Date().toISOString().slice(0,10);
els.trDate.value=new Date().toISOString().slice(0,10);
function formatLocalDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function parseLocalDate(str){const [y,m,d]=str.split('-').map(Number);const dt=new Date(y,m-1,d,0,0,0,0);dt.setHours(0,0,0,0);return dt;}
function startOfToday(){const t=new Date();t.setHours(0,0,0,0);return t;}
function addMonthsPreserveDOM(date,months){const d=new Date(date.getTime());const targetMonth=d.getMonth()+months;const day=d.getDate(),y=d.getFullYear();const temp=new Date(y,targetMonth+1,0);const lastDay=temp.getDate();d.setMonth(targetMonth,Math.min(day,lastDay));d.setHours(0,0,0,0);return d;}
function daysBetween(a,b){const MS=24*60*60*1000;const da=new Date(a.getFullYear(),a.getMonth(),a.getDate());const db=new Date(b.getFullYear(),b.getMonth(),b.getDate());return Math.round((db-da)/MS);}
const YM=()=>formatLocalDate(startOfToday()).slice(0,7);
const monthLabel=ym=>{ if(!ym) return '—'; const [y,m]=ym.split('-').map(Number); if(!Number.isFinite(y)||!Number.isFinite(m)) return ym; const dt=new Date(y,m-1,1); return dt.toLocaleDateString('ar-EG',{month:'long',year:'numeric'}); };

/* ===== حفظ ===== */
function saveLedger(){ localStorage.setItem(KEY, JSON.stringify(ledger)); maybeAutoSync(); }
function saveAccounts(){ localStorage.setItem(ACC_KEY, JSON.stringify(accounts)); refreshAccountSelects(); drawAccountsBadges(); recalc(); maybeAutoSync(); }
function saveCategories(){ localStorage.setItem(CAT_KEY, JSON.stringify(categories)); refreshCategorySelect(); drawCatsBadges(); maybeAutoSync(); }
function saveCommitments(){ localStorage.setItem(COM_KEY, JSON.stringify(commitments)); drawCommitments(); drawDueSoon(); recalc(); maybeAutoSync(); }
function saveCollections(){ localStorage.setItem(COL_KEY, JSON.stringify(collections)); drawCollections(); recalc(); maybeAutoSync(); }

/* ===== قوائم الحساب/الفئات ===== */
function buildAccountOptions(excludeName){
  return accounts.filter(a=>a.name!==excludeName).map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
}
function refreshAccountSelects(){
  const optsAll = accounts.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
  if(els.account) els.account.innerHTML = optsAll;
  const fA=document.getElementById('fAccount');
  if(fA) fA.innerHTML = `<option value="all" selected>كل الحسابات</option>` + optsAll;

  if(els.trFrom){
    const prevFrom = els.trFrom.value;
    els.trFrom.innerHTML = optsAll;
    els.trFrom.value = (prevFrom && accounts.some(a=>a.name===prevFrom)) ? prevFrom : (accounts[0]?.name || '');
  }
  if(els.trTo){
    const from = els.trFrom?.value || '';
@@ -765,65 +829,230 @@ document.getElementById('importFile')?.addEventListener('change', async (e)=>{
    if(Array.isArray(data.ledger)) ledger=data.ledger;
    if(Array.isArray(data.accounts)) accounts=data.accounts;
    if(Array.isArray(data.categories)) categories=data.categories;
    if(Array.isArray(data.commitments)) commitments=data.commitments.map(c=>migrateCommit(c));
    if(Array.isArray(data.collections)) collections=data.collections.map(c=>migrateCollect(c));
    saveLedger(); saveAccounts(); saveCategories(); saveCommitments(); saveCollections();
    drawCommitments(); drawCollections(); drawDueSoon(); render();
    alert('تم الاستيراد بنجاح');
  }catch(err){ alert('خطأ أثناء الاستيراد: '+err.message); }
  e.target.value='';
});

/* ===== تقارير ===== */
function groupByMonth(){
  const map=new Map();
  for(const t of ledger){
    if(t.isTransfer) continue;
    const k=t.date.slice(0,7); const v=map.get(k)||{inc:0,exp:0};
    if(t.type==='income') v.inc+=t.amount; else v.exp+=t.amount; map.set(k,v);
  }
  const keys=[...map.keys()].sort();
  return keys.map(k=>({month:k,inc:map.get(k).inc,exp:map.get(k).exp,net:map.get(k).inc-map.get(k).exp}));
}
function drawMonthly(){
  const data=groupByMonth();
  if(els.tbodyMonthly) els.tbodyMonthly.innerHTML=data.map(d=>`<tr><td>${d.month}</td><td class="amount inc">+${fmt(d.inc)}</td><td class="amount exp">-${fmt(d.exp)}</td><td>${fmt(d.net)}</td></tr>`).join('');
  const months=data.map(d=>d.month);
  let selected=(els.monthPicker?.value||'').trim();
  if(!selected){
    selected=months[months.length-1]||YM();
  }else if(months.length && !months.includes(selected)){
    selected=months[months.length-1]||selected;
  }
  if(els.monthPicker && selected){
    els.monthPicker.value=selected;
  }

  if(els.tbodyMonthly){
    if(data.length===0){
      els.tbodyMonthly.innerHTML='<tr><td colspan="4" style="text-align:center;color:var(--muted)">لا توجد بيانات بعد.</td></tr>';
    }else{
      els.tbodyMonthly.innerHTML=data.map(d=>{
        const active=d.month===selected?' class="active"':'';
        const netCls=d.net>=0?'inc':'exp';
        const netVal=d.net>=0?`+${fmt(d.net)}`:`-${fmt(Math.abs(d.net))}`;
        return `<tr data-month="${d.month}"${active}><td>${monthLabel(d.month)}</td><td class="amount inc">+${fmt(d.inc)}</td><td class="amount exp">-${fmt(d.exp)}</td><td class="amount ${netCls}">${netVal}</td></tr>`;
      }).join('');
    }
  }

  drawMonthlyChart(data, selected);
  drawMonthSummary(selected);
}
function drawMonthlyChart(data, selected){
  const cv=els.chartMonthly; if(!cv) return;
  const ctx=cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height);
  const pad=38,w=cv.width,h=cv.height,innerW=w-pad*2,innerH=h-pad*2;
  ctx.strokeStyle='#c7c7c7'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
  const maxVal=Math.max(1, ...data.map(d=>Math.max(d.inc,d.exp)));
  const barGroup=innerW/Math.max(1,data.length), barW=Math.max(8,(barGroup*0.7)/2);
  ctx.font='12px system-ui'; ctx.fillStyle='#777'; ctx.textAlign='center';
  data.forEach((d,i)=>{ const x0=pad+i*barGroup+barGroup/2;
    const incH=(d.inc/maxVal)*(innerH-10); ctx.fillStyle='#22c55e'; ctx.fillRect(x0-barW-3, h-pad-incH, barW, incH);
    const expH=(d.exp/maxVal)*(innerH-10); ctx.fillStyle='#ef4444'; ctx.fillRect(x0+3, h-pad-expH, barW, expH);
    ctx.fillStyle='#777'; ctx.fillText(d.month, x0, h-pad+16);
  const pad=42,w=cv.width,h=cv.height,innerW=w-pad*2,innerH=h-pad*2;
  if(!data.length){
    ctx.fillStyle='#94a3b8';
    ctx.font='14px system-ui';
    ctx.textAlign='center';
    ctx.fillText('لا توجد بيانات لعرض الرسم البياني', w/2, h/2);
    return;
  }
  const maxInc=Math.max(0,...data.map(d=>d.inc));
  const maxExp=Math.max(0,...data.map(d=>d.exp));
  const maxNet=Math.max(0,...data.map(d=>d.net));
  const minNet=Math.min(0,...data.map(d=>d.net));
  const minVal=Math.min(0,minNet);
  const maxVal=Math.max(1,maxInc,maxExp,maxNet,Math.abs(minVal));
  const range=maxVal-minVal||1;
  const toY=v=>h-pad-((v-minVal)/range)*innerH;
  const zeroY=toY(0);
  const barGroup=innerW/Math.max(1,data.length);
  const barWidth=Math.min(28,Math.max(10,barGroup*0.28));

  ctx.strokeStyle='#e2e8f0';
  ctx.lineWidth=1;
  const gridLines=4;
  ctx.font='11px system-ui';
  ctx.textAlign='right';
  ctx.fillStyle='#94a3b8';
  for(let i=0;i<=gridLines;i++){
    const v=minVal+(range*i/gridLines);
    const y=toY(v);
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke();
    ctx.fillText(fmt(v), pad-6, y+4);
  }

  if(minVal<0){
    ctx.strokeStyle='rgba(15,118,110,0.4)';
    ctx.beginPath(); ctx.moveTo(pad,zeroY); ctx.lineTo(w-pad,zeroY); ctx.stroke();
  }

  data.forEach((d,i)=>{
    const xCenter=pad+i*barGroup+barGroup/2;
    if(d.month===selected){
      ctx.fillStyle='rgba(59,130,246,0.12)';
      ctx.fillRect(xCenter-barGroup/2+4, pad, barGroup-8, innerH);
    }
    if(d.inc>0){
      const top=toY(d.inc);
      const height=Math.max(2, zeroY-top);
      ctx.fillStyle='#22c55e';
      ctx.fillRect(xCenter-barWidth-4, top, barWidth, height);
    }
    if(d.exp>0){
      const top=toY(d.exp);
      const height=Math.max(2, zeroY-top);
      ctx.fillStyle='#ef4444';
      ctx.fillRect(xCenter+4, top, barWidth, height);
    }
  });

  ctx.strokeStyle='#0ea5e9';
  ctx.lineWidth=2;
  ctx.beginPath();
  data.forEach((d,i)=>{
    const xCenter=pad+i*barGroup+barGroup/2;
    const y=toY(d.net);
    if(i===0) ctx.moveTo(xCenter,y); else ctx.lineTo(xCenter,y);
  });
  ctx.stroke();

  ctx.fillStyle='#475569';
  ctx.font='12px system-ui';
  ctx.textAlign='center';
  data.forEach((d,i)=>{
    const xCenter=pad+i*barGroup+barGroup/2;
    ctx.fillText(monthLabel(d.month), xCenter, h-pad+18);
  });
}
function monthTransactions(month){
  if(!month) return [];
  return ledger.filter(t=>!t.isTransfer && t.date.slice(0,7)===month);
}
function aggregateMonthCategories(month,type){
  const map=new Map();
  let total=0;
  for(const t of ledger){
    if(t.isTransfer || t.type!==type) continue;
    if(t.date.slice(0,7)!==month) continue;
    const key=t.category?String(t.category):'غير مصنف';
    const prev=map.get(key)||0;
    const val=prev+t.amount;
    map.set(key,val);
    total+=t.amount;
  }
  const items=[...map.entries()].map(([name,sum])=>({name,sum})).sort((a,b)=>b.sum-a.sum);
  return {total,items};
}
function renderBarList(el, agg, type){
  if(!el) return;
  const items=agg.items.slice(0,6);
  if(!items.length){
    el.innerHTML='<div class="empty-state">لا توجد بيانات.</div>';
    return;
  }
  const maxVal=Math.max(...items.map(i=>i.sum),0);
  const total=agg.total||0;
  el.innerHTML=items.map(item=>{
    const width=maxVal>0?Math.min(100,Math.max(6,(item.sum/maxVal)*100)):0;
    const share=total>0?(item.sum/total):0;
    const shareTxt=share.toLocaleString('ar-EG',{maximumFractionDigits:1,minimumFractionDigits:1});
    const amountTxt=`${fmt(item.sum)} ج.م`;
    return `<div class="bar-item"><div class="label">${escapeHtml(item.name)}</div><div class="bar-track"><div class="bar-fill ${type}" style="--w:${width}%"><span>${amountTxt}</span></div></div><div class="value">${amountTxt} • ${shareTxt}٪ من الإجمالي</div></div>`;
  }).join('');
}
function drawMonthSummary(month){
  const txs=monthTransactions(month);
  const totalInc=txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const totalExp=txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const net=totalInc-totalExp;
  const expenseDays=new Set(txs.filter(t=>t.type==='expense').map(t=>t.date)).size;
  const avg=expenseDays>0?totalExp/expenseDays:0;
  if(els.monthSelectedLabel) els.monthSelectedLabel.textContent=monthLabel(month);
  if(els.monthStatIncome){
    const incTxt=totalInc>0?`+${fmt(totalInc)}`:fmt(0);
    els.monthStatIncome.textContent=incTxt;
  }
  if(els.monthStatExpense){
    const expTxt=totalExp>0?`-${fmt(totalExp)}`:fmt(0);
    els.monthStatExpense.textContent=expTxt;
  }
  if(els.monthStatNet){
    const netTxt=net>0?`+${fmt(net)}`:net<0?`-${fmt(Math.abs(net))}`:fmt(0);
    els.monthStatNet.textContent=netTxt;
    els.monthStatNet.classList.remove('pos','neg');
    if(net>0) els.monthStatNet.classList.add('pos');
    else if(net<0) els.monthStatNet.classList.add('neg');
  }
  if(els.monthStatTx) els.monthStatTx.textContent=txs.length.toString();
  if(els.monthStatAvg) els.monthStatAvg.textContent=fmt(avg);
  const hasData=txs.length>0;
  els.monthNoData?.classList.toggle('d-none', hasData);
  const expAgg=aggregateMonthCategories(month,'expense');
  const incAgg=aggregateMonthCategories(month,'income');
  renderBarList(els.monthCatsExpense, expAgg, 'expense');
  renderBarList(els.monthCatsIncome, incAgg, 'income');
}
els.refreshReports?.addEventListener('click', drawMonthly);
els.monthPicker?.addEventListener('change', drawMonthly);
els.tbodyMonthly?.addEventListener('click', e=>{
  const row=e.target.closest('tr[data-month]');
  if(row && els.monthPicker){ els.monthPicker.value=row.dataset.month; drawMonthly(); }
});

/* ==== الالتزامات ==== */
let editCommitId=null;
function migrateCommit(c){
  if(c.day && !c.firstDue){ const today=startOfToday(); const base=new Date(today.getFullYear(),today.getMonth(),Math.min(Math.max(1,c.day),28)); c.firstDue=formatLocalDate(base); c.nextDue=c.firstDue; delete c.day; }
  if(!c.nextDue && c.firstDue){ c.nextDue=c.firstDue; }
  if(typeof c.recurring!=='boolean') c.recurring=false;
  if(c.endAt===undefined) c.endAt=null;
  if(!c.payments) c.payments={};
  return c;
}
function drawCommitments(){
  if(!els.tbodyCommit) return;
  const ym=YM();
  const rows=[...commitments].sort((a,b)=>(a.nextDue||a.firstDue||'').localeCompare(b.nextDue||b.firstDue||''));
  els.tbodyCommit.innerHTML=rows.map(c=>{
    const recTxt=c.recurring?'شهري':'مرة واحدة';
    const endTxt=c.recurring && c.endAt?c.endAt:'—';
    const paid=(c.payments?.[ym]||0);
    const remain=Math.max(0,(Number(c.amount||0)-paid));
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${escapeHtml(c.nextDue||c.firstDue||'—')}</td>
      <td>${fmt(paid)}</td>
@@ -1094,102 +1323,159 @@ function fillGhFormFromStorage(){
  if(els.ghRepo)  els.ghRepo.value  = ghCfg.repo || '';
  if(els.ghBranch)els.ghBranch.value= ghCfg.branch || 'main';
  if(els.ghPath)  els.ghPath.value  = ghCfg.path || 'my-finance.json';
  if(els.ghToken) els.ghToken.value = ghCfg.token || '';
  if(els.ghAuto)  els.ghAuto.checked= !!ghCfg.auto;
}
function readGhFormToCfg(){
  ghCfg={
    user:els.ghUser.value.trim(),
    repo:els.ghRepo.value.trim(),
    branch:els.ghBranch.value.trim()||'main',
    path:els.ghPath.value.trim()||'my-finance.json',
    token:els.ghToken.value.trim(),
    auto:!!els.ghAuto.checked
  };
  localStorage.setItem(GH_KEY, JSON.stringify(ghCfg));
}
function ghStatus(msg, ok){
  if(els.ghStatus){ els.ghStatus.textContent='الحالة: '+msg; els.ghStatus.style.color= ok?'#0a0':'#900'; }
}
async function gh_api(url, method='GET', body){
  const headers={'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28'};
  if(ghCfg.token) headers['Authorization']='Bearer '+ghCfg.token;
  if(body) headers['Content-Type']='application/json';
  const res=await fetch(url,{method,headers,body: body?JSON.stringify(body):undefined});
  if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  if(!res.ok){
    let detail='';
    try{
      const data=await res.json();
      if(data){
        if(typeof data.message==='string') detail=data.message;
        else if(Array.isArray(data.errors)) detail=data.errors.map(err=>err.message||JSON.stringify(err)).join(' | ');
      }
    }catch{
      try{ detail=await res.text(); }catch{/* ignore */}
    }
    const extra=detail?` — ${detail}`:'';
    throw new Error(`HTTP ${res.status} ${res.statusText}${extra}`);
  }
  if(res.status===204) return null;
  return res.json();
}
function currentPayload(){ return { ledger, accounts, categories, commitments, collections, updatedAt:new Date().toISOString() }; }
async function ghGetFile(){
  const u=`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/contents/${ghCfg.path}?ref=${ghCfg.branch}`;
  try{ return await gh_api(u,'GET'); }catch(e){ return null; }
}
async function ghPutFile(contentObj, message){
  const u=`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/contents/${ghCfg.path}`;
  const text=JSON.stringify(contentObj,null,2);
  const b64=btoa(unescape(encodeURIComponent(text)));
  let sha=null;
  const existing=await ghGetFile();
  if(existing && existing.sha) sha=existing.sha;
  const body={message:message||'update data', content:b64, branch:ghCfg.branch};
  if(sha) body.sha=sha;
  return gh_api(u,'PUT', body);
}
async function ghEnsureBranchExists(createIfMissing=false){
  if(!ghCfg.branch) return;
  const refUrl=`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/git/ref/heads/${ghCfg.branch}`;
  try{
    await gh_api(refUrl,'GET');
  }catch(err){
    if(!/HTTP 404/.test(err.message||'')) throw err;
    if(!createIfMissing){
      throw new Error('الفرع المحدد غير موجود. أنشئه أولاً أو عدّل الاسم.');
    }
    const repoInfo=await gh_api(`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}`,'GET');
    if(repoInfo?.size===0){
      throw new Error('المستودع فارغ. أنشئ أول commit (مثل README) من GitHub قبل الرفع.');
    }
    const baseBranch=repoInfo?.default_branch || 'main';
    const baseRef=await gh_api(`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/git/ref/heads/${baseBranch}`,'GET');
    const sha=baseRef?.object?.sha;
    if(!sha){
      throw new Error('تعذّر الحصول على المرجع الأساسي لإنشاء الفرع الهدف.');
    }
    await gh_api(`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/git/refs`,'POST',{ref:`refs/heads/${ghCfg.branch}`, sha});
  }
}
async function ghTest(){
  readGhFormToCfg();
  if(!ghCfg.user||!ghCfg.repo||!ghCfg.token){ ghStatus('أكمل الإعدادات أولاً',false); return; }
  try{ await gh_api(`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}`,'GET'); ghStatus('الاتصال ناجح',true); }
  catch(e){ ghStatus('فشل الاتصال: '+e.message,false); }
}
async function ghPull(){
  readGhFormToCfg();
  if(!ghCfg.user||!ghCfg.repo){ ghStatus('أكمل الإعدادات (المستخدم والمستودع)',false); return; }
  try{
    await ghEnsureBranchExists(false);
    const meta=await ghGetFile();
    if(!meta || !meta.content){ ghStatus('الملف غير موجود — ارفع أول مرة',false); return; }
    const text=decodeURIComponent(escape(atob(meta.content)));
    const data=JSON.parse(text);
    if(Array.isArray(data.ledger)) ledger=data.ledger;
    if(Array.isArray(data.accounts)) accounts=data.accounts;
    if(Array.isArray(data.categories)) categories=data.categories;
    if(Array.isArray(data.commitments)) commitments=data.commitments.map(migrateCommit);
    if(Array.isArray(data.collections)) collections=data.collections.map(migrateCollect);
    saveLedger(); saveAccounts(); saveCategories(); saveCommitments(); saveCollections();
    render(); drawDueSoon(); ghStatus('تم التحميل',true);
  }catch(e){ ghStatus('فشل التحميل: '+e.message,false); }
  }catch(e){
    const errMsg=e?.message||'خطأ غير معروف';
    ghStatus('فشل التحميل: '+errMsg,false);
  }
}
async function ghPush(){
  readGhFormToCfg();
  try{ await ghPutFile(currentPayload(), 'sync: update finance data'); ghStatus('تم الرفع',true); }
  catch(e){ ghStatus('فشل الرفع: '+e.message,false); }
  if(!ghCfg.user||!ghCfg.repo||!ghCfg.token){ ghStatus('أكمل الإعدادات (المستخدم/المستودع/Token)',false); return; }
  try{
    await ghEnsureBranchExists(true);
    await ghPutFile(currentPayload(), 'sync: update finance data');
    ghStatus('تم الرفع',true);
  }
  catch(e){
    let msg=e?.message||'خطأ غير معروف';
    if(/HTTP 401/.test(msg)||/HTTP 403/.test(msg)) msg='فشل الرفع: تحقَّق من صلاحيات الـ Token (repo → contents:write).';
    else if(/409/.test(msg)) msg='فشل الرفع: يوجد تعارض مع النسخة الموجودة. حمّل آخر نسخة أولًا أو تأكد من أن الفرع غير محمي.';
    ghStatus(msg,false);
  }
}
function maybeAutoSync(){ if(ghCfg?.auto){ ghPush().catch(()=>{}); } }

/* ربط الأزرار */
els.ghSaveCfg?.addEventListener('click', ()=>{ readGhFormToCfg(); ghStatus('تم الحفظ',true); });
els.ghTest?.addEventListener('click', ghTest);
els.ghPull?.addEventListener('click', ghPull);
els.ghPush?.addEventListener('click', ghPush);
els.syncNow?.addEventListener('click', ghPush);

/* ===== تهيئة ===== */
function refreshCategorySelect(){
  const cats = categories.filter(c=>c.type===els.type.value);
  els.category.innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
}
function init(){
  initCollapsibles();
  commitments=commitments.map(c=>migrateCommit(c));
  collections=collections.map(c=>migrateCollect(c));
  saveCommitments(); saveCollections();
  ensureTransferCategories();
  if(els.monthPicker){
    const today=YM();
    if(!els.monthPicker.value) els.monthPicker.value=today;
    els.monthPicker.setAttribute('max', today);
  }
  refreshAccountSelects(); refreshCategorySelect(); drawCatsBadges();
  drawCommitments(); drawCollections(); drawDueSoon(); render();
  fillGhFormFromStorage();
  els.cEndAt?.toggleAttribute('required', els.cRecurring?.checked);
  els.coEndAt?.toggleAttribute('required', els.coRecurring?.checked);
  refreshLinkCommitOptions();
}
init();
</script>
</body>
</html>
