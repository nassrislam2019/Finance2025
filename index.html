<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دفتر حساباتي</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode:'class', theme:{ extend:{ fontFamily:{ sans:['Cairo','sans-serif'] }, colors:{ brand:'#0b84ff' } } } };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style> body{font-family:Cairo,system-ui;margin:0} </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <div class="flex h-screen" style="direction:rtl">
    <aside class="w-64 bg-white dark:bg-gray-800 shadow-xl flex flex-col p-4 hidden md:flex">
      <div class="flex items-center gap-3 mb-6">
        <h1 id="appTitle" class="text-2xl font-bold text-brand">دفتر حساباتي</h1>
        <button id="toggleColor" class="ml-2 px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-sm">تغيير اللون</button>
      </div>
      <nav class="flex-1">
        <ul class="space-y-2">
          <li><button data-page="dashboard" class="nav-link block w-full text-right p-2 rounded-lg bg-gray-100 dark:bg-gray-700 font-semibold">لوحة البيانات</button></li>
          <li><button data-page="transactions" class="nav-link block w-full text-right p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">الحركات</button></li>
          <li><button data-page="add" class="nav-link block w-full text-right p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">إضافة حركة</button></li>
          <li><button data-page="management" class="nav-link block w-full text-right p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">الإدارة</button></li>
          <li><button data-page="commitments" class="nav-link block w-full text-right p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">الالتزامات والتحصيلات</button></li>
        </ul>
      </nav>
      <div class="mt-4">
        <button id="darkToggle" class="w-full text-left p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">الوضع الليلي</button>
      </div>
    </aside>

    <main class="flex-1 p-6 overflow-auto">
      <!-- Dashboard -->
      <section id="dashboard-section" class="page-section">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-extrabold">لوحة البيانات</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <small class="text-sm text-gray-500 dark:text-gray-400">إجمالي الأرصدة</small>
            <div id="totalBalance" class="text-2xl font-bold mt-2">0.00 ج.م</div>
          </div>

          <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <small class="text-sm text-gray-500 dark:text-gray-400">الرصيد المتوقع</small>
            <div id="balanceAfter" class="text-2xl font-bold mt-2">0.00 ج.م</div>
            <div class="text-xs text-gray-400 mt-2">الأرصدة الآن - المتبقي من التزامات الشهر + ما لم يُحصَل</div>
          </div>

          <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <small class="text-sm text-gray-500 dark:text-gray-400">الشهر المحدد</small>
            <div id="monthLabel" class="text-xl font-bold mt-2"></div>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <div class="text-sm text-gray-500">إجمالي التزامات الشهر الحالي</div>
            <div id="commitThis_total" class="text-xl font-bold mt-2">0.00 ج.م</div>
            <div class="text-xs text-gray-400 mt-1">المتبقي: <span id="commitThis_remain">0.00</span></div>
          </div>

          <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <div class="text-sm text-gray-500">إجمالي تحصيلات الشهر الحالي</div>
            <div id="collectThis_total" class="text-xl font-bold mt-2">0.00 ج.م</div>
            <div class="text-xs text-gray-400 mt-1">لم يُحصّل: <span id="collectThis_remain">0.00</span></div>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-2 p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <div class="flex justify-between items-center mb-3">
              <div class="font-semibold">آخر 5 حركات</div>
              <div class="text-xs text-gray-400">مرتبة بحسب تنفيذ (الأحدث أولًا)</div>
            </div>
            <div id="latestTx" class="space-y-2"></div>
          </div>

          <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <div class="flex justify-between items-center mb-3">
              <div class="font-semibold">استحقاقات قريبة</div>
              <div class="text-xs text-gray-400">هذا الشهر و الشهر القادم</div>
            </div>
            <div id="dueSoonList" class="space-y-2 mb-3"></div>
            <canvas id="pieChart" width="300" height="200"></canvas>
          </div>
        </div>
      </section>

      <!-- Transactions -->
      <section id="transactions-section" class="page-section hidden mt-4">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-extrabold">الحركات</h2>
        </div>

        <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card mb-4">
          <div class="flex gap-2 flex-wrap mb-3">
            <input id="filterSearch" placeholder="بحث بالوصف/الفئة" class="border p-2 rounded flex-1" />
            <select id="filterType" class="border p-2 rounded"><option value="all">الكل</option><option value="income">دخل</option><option value="expense">مصروف</option></select>
            <select id="filterAccount" class="border p-2 rounded"></select>
            <input id="filterFrom" type="date" class="border p-2 rounded" />
            <input id="filterTo" type="date" class="border p-2 rounded" />
            <button id="clearFilters" class="px-3 py-2 bg-gray-100 rounded">مسح</button>
          </div>

          <div class="overflow-auto">
            <table class="w-full text-right">
              <thead><tr class="text-sm text-gray-500"><th class="p-2">تاريخ التنفيذ</th><th class="p-2">تاريخ الاستحقاق</th><th class="p-2">الوصف</th><th class="p-2">الفئة</th><th class="p-2">الحساب</th><th class="p-2">المبلغ</th><th class="p-2">إجراءات</th></tr></thead>
              <tbody id="txTableBody"></tbody>
            </table>
          </div>

          <div class="flex items-center justify-center gap-2 mt-3">
            <button id="prevPage" class="px-3 py-2 bg-gray-100 rounded">السابق</button>
            <div id="pageInfo" class="text-sm text-gray-500">الصفحة 1</div>
            <button id="nextPage" class="px-3 py-2 bg-gray-100 rounded">التالي</button>
          </div>
        </div>
      </section>

      <!-- Add -->
      <section id="add-section" class="page-section hidden mt-4">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-extrabold">إضافة / تعديل حركة</h2>
        </div>

        <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm">النوع</label>
              <select id="add_type" class="border p-2 rounded w-full"><option value="expense">مصروف</option><option value="income">دخل</option></select>
            </div>
            <div>
              <label class="text-sm">المبلغ</label>
              <input id="add_amount" type="number" step="0.01" class="border p-2 rounded w-full" />
            </div>
            <div>
              <label class="text-sm">تاريخ/وقت التنفيذ (اختياري)</label>
              <input id="add_exec" type="datetime-local" class="border p-2 rounded w-full" />
            </div>

            <div>
              <label class="text-sm">تاريخ الاستحقاق</label>
              <input id="add_date" type="date" class="border p-2 rounded w-full" />
            </div>
            <div>
              <label class="text-sm">الحساب</label>
              <select id="add_account" class="border p-2 rounded w-full"></select>
            </div>
            <div>
              <label class="text-sm">الفئة</label>
              <select id="add_category" class="border p-2 rounded w-full"></select>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm">الوصف</label>
              <input id="add_desc" class="border p-2 rounded w-full" />
            </div>
            <div>
              <label class="text-sm">ربط الالتزام (اختياري)</label>
              <select id="add_linkCommit" class="border p-2 rounded w-full"><option value="">— بدون —</option></select>
            </div>

            <div class="md:col-span-3 flex gap-2">
              <button id="add_save" class="px-4 py-2 bg-brand text-white rounded">حفظ</button>
              <button id="add_update" class="px-4 py-2 bg-yellow-500 text-white rounded hidden">تحديث</button>
              <button id="add_reset" class="px-4 py-2 bg-gray-100 rounded">إفراغ</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Management & Commitments omitted for brevity (kept in original impl) -->
      <section id="management-section" class="page-section hidden mt-4">
        <!-- same as previous full file -->
        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <h3 class="font-semibold mb-3">الحسابات</h3>
            <div class="grid grid-cols-1 gap-2 mb-3">
              <input id="acc_name" placeholder="اسم الحساب" class="border p-2 rounded" />
              <input id="acc_open" placeholder="رصيد افتتاحي" type="number" class="border p-2 rounded" />
              <div class="flex gap-2">
                <button id="btn_add_acc" class="px-3 py-2 bg-gray-800 text-white rounded">إضافة</button>
              </div>
            </div>
            <div id="accountsList" class="space-y-2 text-sm"></div>
          </div>

          <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <h3 class="font-semibold mb-3">الفئات</h3>
            <div class="grid grid-cols-1 gap-2 mb-3">
              <input id="cat_name" placeholder="اسم الفئة" class="border p-2 rounded" />
              <select id="cat_type" class="border p-2 rounded"><option value="expense">مصروف</option><option value="income">دخل</option></select>
              <div class="flex gap-2">
                <button id="btn_add_cat" class="px-3 py-2 bg-gray-800 text-white rounded">إضافة</button>
              </div>
            </div>
            <div id="catsList" class="space-y-2 text-sm"></div>
          </div>
        </div>
      </section>

      <section id="commitments-section" class="page-section hidden mt-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <h3 class="font-semibold mb-3">الالتزامات الشهرية</h3>
            <div class="grid grid-cols-1 gap-2 mb-3">
              <input id="c_name" placeholder="اسم الالتزام" class="border p-2 rounded" />
              <input id="c_amount" type="number" placeholder="المبلغ" class="border p-2 rounded" />
              <input id="c_first" type="date" class="border p-2 rounded" />
              <div class="flex gap-2 items-center">
                <label class="inline-flex items-center"><input id="c_rec" type="checkbox" class="ml-2"/>يتكرر شهريًا</label>
                <input id="c_end" type="date" class="border p-2 rounded" />
              </div>
              <div class="flex gap-2">
                <button id="btn_add_commit" class="px-3 py-2 bg-gray-800 text-white rounded">إضافة</button>
              </div>
            </div>
            <div id="commitList" class="space-y-2 text-sm"></div>
          </div>

          <div class="p-4 rounded-lg bg-white dark:bg-gray-800 shadow card">
            <h3 class="font-semibold mb-3">التحصيلات</h3>
            <div class="grid grid-cols-1 gap-2 mb-3">
              <input id="col_name" placeholder="اسم التحصيل" class="border p-2 rounded" />
              <input id="col_amount" type="number" placeholder="المبلغ" class="border p-2 rounded" />
              <input id="col_first" type="date" class="border p-2 rounded" />
              <div class="flex gap-2 items-center">
                <label class="inline-flex items-center"><input id="col_rec" type="checkbox" class="ml-2"/>يتكرر شهريًا</label>
                <input id="col_end" type="date" class="border p-2 rounded" />
              </div>
              <div class="flex gap-2">
                <button id="btn_add_col" class="px-3 py-2 bg-gray-800 text-white rounded">إضافة</button>
              </div>
            </div>
            <div id="collectList" class="space-y-2 text-sm"></div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- ===== JS corrected: use safeOn helper and error listener ===== -->
  <script>
  (function(){
    'use strict';
    /* safe helpers */
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function safeOn(sel, evt, handler){ const el = $(sel); if(el) el.addEventListener(evt, handler); else console.warn('element not found for', sel); }

    // show runtime errors in console visually
    window.addEventListener('error', e => {
      console.error('Runtime error:', e.message, 'at', e.filename + ':' + e.lineno + ':' + e.colno);
    });

    /* tiny storage helpers & defaults */
    function sp(k, fallback){ try{ const s=localStorage.getItem(k); return s? JSON.parse(s): fallback; }catch(e){ localStorage.removeItem(k); return fallback; } }
    function persist(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){ console.error(e); } }

    const KEY='pf_ledger_v3', ACC='pf_accounts_v3', CAT='pf_categories_v3', COM='pf_commitments_v3', COL='pf_collections_v3', THEME='pf_theme_v3';
    let ledger = sp(KEY, []), accounts = sp(ACC, []), categories = sp(CAT, []), commitments = sp(COM, []), collections = sp(COL, []);
    if(!accounts.length){ accounts=[{name:'كاش',opening:0},{name:'حساب بنكي',opening:0},{name:'محفظة',opening:0}]; persist(ACC, accounts); }
    if(!categories.length){ categories=[{name:'مرتب',type:'income'},{name:'أكل وشرب',type:'expense'},{name:'مواصلات',type:'expense'}]; persist(CAT, categories); }

    /* minimal copy of functionality: safe attach and delegation */
    function initUIBindings(){
      // navigation (delegated via data-page)
      $$('.nav-link').forEach(b=> b.addEventListener('click', (ev)=>{ ev.preventDefault(); const p=b.getAttribute('data-page'); gotoPage(p); }));

      safeOn('#darkToggle','click', ()=>{ const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem(THEME, isDark?'dark':'light'); });
      safeOn('#btn_add_acc','click', ()=>{ const n=$('#acc_name')?.value?.trim(); const o=Number($('#acc_open')?.value||0); if(!n) return alert('ادخل اسم الحساب'); accounts.push({name:n, opening:o}); persist(ACC, accounts); renderAll(); });
      safeOn('#btn_add_cat','click', ()=>{ const n=$('#cat_name')?.value?.trim(); const t=$('#cat_type')?.value||'expense'; if(!n) return alert('ادخل اسم الفئة'); categories.push({name:n,type:t}); persist(CAT, categories); renderAll(); });

      // add tx button
      safeOn('#add_save','click', ()=>{
        const type = $('#add_type')?.value || 'expense';
        const amount = Number($('#add_amount')?.value||0);
        const exec = $('#add_exec')?.value ? new Date($('#add_exec').value).toISOString() : new Date().toISOString();
        const date = $('#add_date')?.value || exec.slice(0,10);
        const account = $('#add_account')?.value;
        const category = $('#add_category')?.value;
        const desc = $('#add_desc')?.value || '';
        const link = $('#add_linkCommit')?.value || '';
        if(!account||!category||!amount) return alert('اكمل الحقول المطلوبة');
        ledger.push({ id: Date.now().toString(36), created:new Date().toISOString(), exec, date, desc, type, amount, account, category, linkCommitId: link||undefined });
        persist(KEY, ledger); renderAll(); gotoPage('transactions');
      });

      // filters & paging safe
      safeOn('#filterSearch','input', ()=> renderTransactions());
      safeOn('#filterType','change', ()=> renderTransactions());
      safeOn('#filterAccount','change', ()=> renderTransactions());
      safeOn('#filterFrom','change', ()=> renderTransactions());
      safeOn('#filterTo','change', ()=> renderTransactions());
      safeOn('#clearFilters','click', ()=>{ if($('#filterSearch')) $('#filterSearch').value=''; if($('#filterType')) $('#filterType').value='all'; if($('#filterAccount')) $('#filterAccount').value='all'; renderTransactions(); });

      // prev/next
      safeOn('#prevPage','click', ()=>{ if(window._pg>1){ window._pg--; renderTransactions(); }});
      safeOn('#nextPage','click', ()=>{ window._pg = (window._pg||1)+1; renderTransactions(); });

      // delegation for table actions (edit/delete/pay/collect)
      document.addEventListener('click', (e)=>{
        const del = e.target.closest('[data-del-id]'); if(del){ const id=del.getAttribute('data-del-id'); if(confirm('حذف؟')){ ledger = ledger.filter(x=>x.id!==id); persist(KEY, ledger); renderAll(); } return; }
        const edit = e.target.closest('[data-edit-id]'); if(edit){ const id=edit.getAttribute('data-edit-id'); const t=ledger.find(x=>x.id===id); if(!t) return; // prefill add form
          $('#add_type').value=t.type; $('#add_amount').value=t.amount; $('#add_exec').value=t.exec? new Date(t.exec).toISOString().slice(0,16):''; $('#add_date').value=t.date||''; $('#add_account').value=t.account||''; $('#add_category').value=t.category||''; $('#add_desc').value=t.desc||''; gotoPage('add'); return;
        }
      });
    }

    /* simple render functions (only safe exist checks) */
    function fmt(n){ return Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function renderAll(){
      // accounts list
      if($('#accountsList')) $('#accountsList').innerHTML = accounts.map(a=>`<div class="flex justify-between"><div>${a.name} · ${fmt(a.opening)}</div></div>`).join('');
      if($('#add_account')) $('#add_account').innerHTML = accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
      if($('#add_category')) $('#add_category').innerHTML = categories.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');

      // balances
      let totals = 0;
      for(const a of accounts) totals += Number(a.opening||0);
      // plus ledger computed balances (quick sum by account)
      const balByAcc = new Map(accounts.map(a=>[a.name, Number(a.opening||0)]));
      for(const t of ledger){
        balByAcc.set(t.account, (balByAcc.get(t.account)||0) + (t.type==='income'? Number(t.amount||0) : -Number(t.amount||0)));
      }
      let totNow = 0; for(const v of balByAcc.values()) totNow += v;
      if($('#totalBalance')) $('#totalBalance').textContent = fmt(totNow) + ' ج.م';
      if($('#balanceAfter')) $('#balanceAfter').textContent = fmt(totNow) + ' ج.م';

      // latest
      if($('#latestTx')) $('#latestTx').innerHTML = ledger.slice().sort((a,b)=> (b.exec||b.created||'').localeCompare(a.exec||a.created||'')).slice(0,5).map(t=>`<div class="flex justify-between p-2 border-b"><div><b>${t.desc||'—'}</b><div class="text-xs text-gray-500">${t.category||''}</div></div><div class="${t.type==='income'?'text-green-600':'text-red-600'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div></div>`).join('');
      renderTransactions();
    }

    function renderTransactions(){
      // simple filter + paging
      const q = $('#filterSearch')?.value?.toLowerCase()||'';
      const ftype = $('#filterType')?.value||'all';
      const facc = $('#filterAccount')?.value||'all';
      const from = $('#filterFrom')?.value||'';
      const to = $('#filterTo')?.value||'';
      let rows = ledger.slice().filter(t=>{
        if(q && !((t.desc||'').toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q))) return false;
        if(ftype!=='all' && t.type!==ftype) return false;
        if(facc!=='all' && t.account!==facc) return false;
        if(from && (t.date||'') < from) return false;
        if(to && (t.date||'') > to) return false;
        return true;
      }).sort((a,b)=> (b.exec||b.created||'').localeCompare(a.exec||a.created||''));
      const page = window._pg || 1, ps = 10;
      const pages = Math.max(1, Math.ceil(rows.length/ps));
      if(page>pages) window._pg = pages;
      const start = ((window._pg||1)-1)*ps;
      const slice = rows.slice(start, start+ps);
      if($('#txTableBody')) $('#txTableBody').innerHTML = slice.map(t=>`<tr><td class="p-2">${t.exec? new Date(t.exec).toLocaleString('ar-EG') : (t.created? new Date(t.created).toLocaleString('ar-EG'):'—')}</td><td class="p-2">${t.date||'—'}</td><td class="p-2">${t.desc||'—'}</td><td class="p-2">${t.category||'—'}</td><td class="p-2">${t.account||'—'}</td><td class="p-2 ${t.type==='income'?'text-green-600':'text-red-600'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td><td class="p-2"><button data-edit-id="${t.id}" class="px-2 py-1 bg-gray-100 rounded text-xs">تعديل</button> <button data-del-id="${t.id}" class="px-2 py-1 bg-red-100 rounded text-xs">حذف</button></td></tr>`).join('');
      if($('#pageInfo')) $('#pageInfo').textContent = `الصفحة ${window._pg||1} من ${pages} — إجمالي ${rows.length}`;
    }

    function gotoPage(p){
      $$('.page-section').forEach(s=>s.classList.add('hidden'));
      const map = { dashboard:'dashboard-section', transactions:'transactions-section', add:'add-section', management:'management-section', commitments:'commitments-section' };
      const id = map[p] || 'dashboard-section';
      const el = document.getElementById(id); if(el) el.classList.remove('hidden');
    }

    /* boot */
    function init(){
      // default page
      gotoPage('dashboard');
      initUIBindings();
      // set theme if exists
      if(localStorage.getItem(THEME)==='dark') document.documentElement.classList.add('dark');
      renderAll();
    }
    init();

    // expose for debug
    window._pf = { ledger, accounts, categories, renderAll };
  })();
  </script>
</body>
</html>