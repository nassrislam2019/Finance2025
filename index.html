<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساباتي</title>
<meta name="theme-color" content="#0b1220" id="themeColorMeta" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
/* ====== الوضع الليلي الافتراضي (Dark Theme) ====== */
:root{
  --bg:#0b1220;
  --card:#0f172a;
  --muted:#94a3b8;
  --txt:#e5e7eb;
  --brand:#0369a1;
  --brand-2:#0ea5e9;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#22c55e;
  --border:#1f2a44;
  --radius:12px;
  --field-h:42px;
  --shadow:0 8px 24px rgba(2,6,23,0.5);
  --sync-idle: #0c1a2f; 
  --sync-syncing: #0d2a45;
  --sync-success: #1a3224;
  --sync-danger: #351c1c;
  --table-row-bg: linear-gradient(180deg,#071226,#0b162a);
  --table-row-hover-shadow: 0 10px 30px rgba(2,6,23,0.6);
  --table-border-color: var(--border);
  /* ألوان التنقل السفلي */
  --nav-bg: #0f172a;
  --nav-item-color: var(--muted);
  --nav-item-active-color: var(--brand-2);
}

/* ====== الوضع النهاري (Light Theme) ====== */
body.light-theme {
  --bg: #f8fafc;
  --card: #ffffff;
  --muted: #64748b;
  --txt: #1e293b;
  --brand: #0369a1;
  --brand-2: #0ea5e9;
  --danger: #ef4444;
  --warn: #f59e0b;
  --ok: #22c55e;
  --border: #e2e8f0;
  --shadow: 0 4px 12px rgba(0,0,0,0.08);
  --sync-idle: #f1f5f9;
  --sync-syncing: #f0f9ff;
  --sync-success: #f0fff4;
  --sync-danger: #fff5f5;
  --table-row-bg: #ffffff;
  --table-row-hover-shadow: 0 4px 12px rgba(0,0,0,0.1);
  --table-border-color: #e2e8f0;
  /* ألوان التنقل السفلي */
  --nav-bg: #ffffff;
  --nav-item-color: var(--muted);
  --nav-item-active-color: var(--brand-2);
  background:
    radial-gradient(1200px 600px at 100% -10%, rgba(14,165,233,.05), transparent 70%),
    radial-gradient(900px 500px at -10% 100%, rgba(3,105,161,.06), transparent 70%),
    var(--bg);
}

/* خطوط */
body,h1,h2,h3,h4,h5,h6,p,div,span,li,a,button{font-family:"Cairo",sans-serif !important;}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 100% -10%, rgba(14,165,233,.10), transparent 70%),
    radial-gradient(900px 500px at -10% 100%, rgba(3,105,161,.12), transparent 70%),
    var(--bg); 
  color:var(--txt);
  transition: background-color 0.3s, color 0.3s;
  /* إضافة مسافة في الأسفل لـ Navigation Bar */
  padding-bottom: 60px; /* ارتفاع شريط التنقل */
}
.container{
  max-width:1180px;
  margin-inline:auto;
  padding:20px;
  /* ضبط المساحة العلوية للـ Toolbar */
  padding-top: 80px; 
}

/* Header and Toolbar (Fixed) */
header {
    position: fixed;
    top: 0;
    right: 0;
    left: 0;
    z-index: 100;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 10px 20px;
    box-shadow: var(--shadow);
}
header .container {
    padding: 0;
    max-width: 1180px;
    margin: auto;
}
header .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.title {
    font-weight: 900;
    font-size: 22px;
    color: var(--txt);
}
.header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}
.btn-toggle-theme {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    font-size: 15px;
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 999px;
    transition: all 0.2s;
}

/* ====== Navigation Bar (جديد) ====== */
.nav-bar {
    position: fixed;
    bottom: 0;
    right: 0;
    left: 0;
    z-index: 1000;
    height: 60px;
    background: var(--nav-bg);
    border-top: 1px solid var(--border);
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-around;
    padding-top: 4px;
}
body.light-theme .nav-bar {
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
}
.nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 600;
    color: var(--nav-item-color);
    cursor: pointer;
    transition: color 0.2s;
    user-select: none;
}
.nav-item i {
    font-size: 20px;
    margin-bottom: 2px;
}
.nav-item.active {
    color: var(--nav-item-active-color);
}
/* إخفاء تسمية العناصر في شاشات سطح المكتب */
@media (min-width: 720px) {
    .nav-item span {
        display: none;
    }
    .nav-item i {
        font-size: 24px;
        margin: 0;
    }
    .nav-bar {
        width: 100px;
        height: auto;
        top: 80px;
        bottom: auto;
        left: 0;
        right: auto;
        flex-direction: column;
        border-top: none;
        border-right: 1px solid var(--border);
        box-shadow: none;
        padding: 10px 0;
        background: transparent;
    }
    .container {
        /* إزاحة المحتوى عن الشريط الجانبي */
        padding-right: 120px; 
    }
    header {
        /* إزاحة الـ Header عن الشريط الجانبي */
        right: 100px; 
    }
}
/* ====== Page Management (جديد) ====== */
.page {
    display: none;
}
.page.active {
    display: block;
}

/* ... (بقية تنسيقات العناصر الأخرى مثل card, grid, btn, table, إلخ.) ... */
/* Cards */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:0; overflow:hidden; box-shadow:var(--shadow);
  transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
  margin-top: 12px; /* تم نقل الـ margin هنا بدلاً من كل <section> */
}
.card-head{
  display:flex;align-items:center;justify-content:space-between;padding:12px 14px;
  background:linear-gradient(135deg, rgba(3,105,161,.55), rgba(14,165,233,.12));
  border-bottom:1px solid var(--border);
}
body.light-theme .card-head {
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(3, 105, 161, 0.05));
    border-bottom-color: #f1f5f9;
}
.card-head h3{margin:0;font-size:18px;color:var(--txt)} 
.card-body{padding:14px}
.card.collapsed .card-body{display:none}
.toggle{appearance:none;border:none;background:transparent;cursor:pointer;border-radius:10px;font-size:18px;padding:6px 10px;color:var(--muted)}

/* Layout */
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,textarea{
  width:100%;background:var(--bg);
  color:var(--txt);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none;height:var(--field-h);
  transition: background-color 0.3s, border-color 0.3s, color 0.3s;
}
body.light-theme input, body.light-theme select, body.light-theme textarea { background: #f1f5f9; }
.btn-primary{background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff;border:1px solid rgba(14,165,233,.35)}
.hr{height:1px;background:var(--border);opacity:.7;margin:12px 0;border-radius:999px}
/* ... (بقية التنسيقات الأخرى كما هي) ... */
.btn{
  appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer;
  transition:transform .06s ease, opacity .15s,height .08s ease;font-size:13px;height:36px;
}
.btn:hover:not(:disabled){opacity:.95;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--txt);padding:8px 10px}
body.light-theme .btn-outline { border-color: #cbd5e1; color: #334155; }
.btn-danger{background:linear-gradient(180deg,#ef4444,#d02626);color:#fff;border:1px solid rgba(235,75,75,0.15)}
.btn-muted{background:transparent;color:var(--muted);border:1px dashed var(--border);padding:8px 10px}
.actions .btn{height:30px;padding:6px 8px;font-size:13px;border-radius:8px}
.actions .btn-outline{border-color:var(--border);color:var(--txt)}
.stats{display:grid;gap:10px}
@media(min-width:720px){.stats{grid-template-columns:repeat(5,1fr)}}
.stat{
  background:var(--card); 
  border:1px solid var(--border);border-radius:var(--radius);padding:14px; text-align:center;
  box-shadow:var(--shadow)
}
body.light-theme .stat { background: #f1f5f9; }
.stat small{color:var(--muted)}
.stat .num{font-weight:800;font-size:22px;margin-top:4px;color:var(--txt)}
.pos{color:#34d399}.neg{color:#fb7185}
.list-plain{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.list-plain .item{
  background:var(--card); 
  border:1px solid var(--border);padding:14px;border-radius:var(--radius);
  text-align:center;box-shadow:var(--shadow);font-weight:700;color:var(--txt)
}
body.light-theme .list-plain .item { background: #f1f5f9; }
.report-table-wrap{overflow:auto;max-height:340px}
#tbodyMonthly tr.active{background:rgba(14,165,233,0.18);box-shadow:0 0 0 1px rgba(14,165,233,0.35)}
body.light-theme #tbodyMonthly tr.active{background:rgba(14,165,233,0.1);box-shadow:0 0 0 1px rgba(14,165,233,0.2)}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.spacer{flex:1}
.badge{
    display:inline-flex;gap:6px;align-items:center;
    background:var(--bg); 
    color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:var(--field-h);
    transition: background-color 0.3s, border-color 0.3s, color 0.3s;
}
body.light-theme .badge { background: #f1f5f9; }
.badge-group{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
.footer{margin-top:24px;color:var(--muted);font-size:12px;text-align:center}
.note{color:var(--warn)}
canvas{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);display:block;width:100%;height:320px;transition: background-color 0.3s, border-color 0.3s}
body.light-theme canvas { background: #ffffff; }
.transfer-grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
.transfer-grid .full{grid-column:1/-1}
@media(max-width:900px){.transfer-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:720px){
  .grid-2{grid-template-columns:1fr}
  .grid-4{grid-template-columns:1fr 1fr}
  .badge{height:auto}
  .card-head h3{font-size:17px}
  .transfer-grid{grid-template-columns:1fr}
}
/* تنسيقات المزامنة */
#sync-card-v2 .card-head h3 i {margin-left: 8px; font-size: 1.1em;}
.sync-status-display {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
    border: 1px solid var(--border);
    font-weight: 600;
    transition: all 0.3s ease;
}
.sync-status-display i { margin-left: 10px; font-size: 1.4em; }
.status-idle {background-color: var(--sync-idle); color: var(--muted);}
.status-syncing {background-color: var(--sync-syncing); color: var(--brand-2);}
.status-success {background-color: var(--sync-success); color: var(--ok);}
.status-error {background-color: var(--sync-danger); color: var(--danger);}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:right;padding:6px 10px}
tbody tr{
    background:var(--table-row-bg); 
    border:1px solid rgba(255,255,255,0.02);
    border-radius:10px;
    transition:transform .08s ease, box-shadow .08s ease, background-color 0.3s;
}
body.light-theme tbody tr { border: 1px solid #f1f5f9; }
tbody tr:hover{
    transform:translateY(-4px);
    box-shadow:var(--table-row-hover-shadow); 
}
tbody td{padding:12px 10px;border-top:1px solid var(--table-border-color);border-bottom:1px solid var(--table-border-color);color:var(--txt)}
tbody tr td:first-child{border-right:1px solid var(--table-border-color);border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
tbody tr td:last-child{border-left:1px solid var(--table-border-color);border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
.amount.exp{color:#ff9aa0;font-weight:900}.amount.inc{color:#7ef0b8;font-weight:900}
body.light-theme .amount.exp{color:#dc2626}.amount.inc{color:#10b981}
.d-none{display:none!important;}
</style>
</head>
<body id="appBody">

<header>
  <div class="container">
    <div class="toolbar">
      <div class="title" id="pageTitle">دفتر حساباتي - الرئيسية</div>
      <div class="header-actions">
        <button id="toggleThemeBtn" class="btn btn-toggle-theme" type="button" title="تبديل الوضع"><i class="fas fa-sun"></i></button>
        <button id="installBtn" class="btn btn-primary" type="button" style="display:none">تثبيت</button>
      </div>
    </div>
  </div>
</header>

<div class="container" id="pagesContainer">
    
    <div class="page active" id="page-home">
        <section class="card" id="card-balance" data-lock="true">
            <div class="card-head"><h3>ملخص الحسابات</h3></div>
            <div class="card-body">
              <div class="stats">
                <div class="stat"><small>إجمالي الأرصدة</small><div id="totalBalance" class="num">0</div></div>
                <div class="stat"><small>إجمالي التزامات الشهر الحالي</small><div id="monthCommitTotal" class="num neg">0</div></div>
                <div class="stat"><small>إجمالي مبالغ تحت التحصيل (الشهر الحالي)</small><div id="currentMonthCollections" class="num pos">0</div></div>
                <div class="stat"><small>التزامات الشهر القادم (شامل متبقي الحالي)</small><div id="nextCommitWithCarry" class="num neg">0</div></div>
                <div class="stat"><small>إجمالي مبالغ تحت التحصيل الشهر القادم</small><div id="nextMonthCollections" class="num pos">0</div></div>
              </div>
              <div class="hr"></div>
              <div>
                <h3 style="margin:0 0 8px;font-size:14px;color:var(--muted)">تفاصيل الأرصدة بالحساب</h3>
                <div id="perAccount" class="list-plain"></div>
              </div>
            </div>
        </section>

        <section class="card" id="card-dueSoon">
            <div class="card-head">
              <h3>استحقاقات قريبة</h3>
              <div class="badge-group">
                <span id="dueTotalBadge" class="badge" title="إجمالي المتبقّي لهذا الشهر">إجمالي: 0.00 ج.م</span>
                <span id="dueNextTotalBadge" class="badge" title="إجمالي الاستحقاقات للشهر القادم">الشهر القادم: 0.00 ج.م</span>
              </div>
            </div>
            <div class="card-body">
              <div id="dueSoonWrap">
                <table style="width:100%">
                  <thead><tr><th>الاسم</th><th>التاريخ</th><th>الأصل</th><th>المدفوع</th><th>المتبقي</th><th>الحالة</th><th>إجراءات</th></tr></thead>
                  <tbody id="tbodyDueSoon"></tbody>
                </table>
              </div>
              <div id="dueSoonCards"></div>
              <div id="noDueSoon" class="d-none" style="color:var(--muted)">لا توجد استحقاقات هذا الشهر غير مسددة.</div>
            </div>
        </section>

        <section class="card" id="sync-card-v2">
            <div class="card-head">
                <h3><i class="fas fa-cloud-upload-alt"></i> حالة مزامنة GitHub</h3>
            </div>
            <div class="card-body">
                <div id="syncStatusDisplayV2" class="sync-status-display status-idle">
                    <i id="syncIconV2" class="fas fa-clock"></i>
                    <span id="syncMessageV2">الإعدادات محفوظة محلياً. اضغط **مزامنة الآن** للبدء.</span>
                </div>
                <div class="toolbar">
                    <button id="syncPushBtnV2" class="btn btn-primary" type="button" title="رفع البيانات الحالية إلى GitHub">مزامنة الآن (رفع)</button>
                    <button id="syncPullBtnV2" class="btn btn-outline" type="button" title="تحميل البيانات من GitHub واستبدال المحلي">تحميل من GitHub</button>
                    <span class="spacer"></span>
                    <span id="syncLastTimeV2" class="badge">آخر تحديث: —</span>
                    <button class="btn btn-outline" onclick="document.getElementById('card-github').classList.toggle('collapsed'); document.getElementById('card-github').querySelector('.toggle').textContent = document.getElementById('card-github').classList.contains('collapsed') ? '▸' : '▾';">الإعدادات المتقدمة</button>
                </div>
                <div style="margin-top:8px;color:var(--muted);font-size:12px;text-align:right;">
                     <span id="syncConfigInfo">المستودع: ${ghCfg.repo||'—'} / الفرع: ${ghCfg.branch||'main'}</span>
                </div>
            </div>
        </section>
    </div>

    <div class="page" id="page-txs">
        <section class="card" id="card-addtx" data-collapsible>
            <div class="card-head"><h3>إضافة حركة</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▾</button></div>
            <div class="card-body">
              <div class="grid grid-3">
                <div><label>النوع</label><select id="type"><option value="income">دخل</option><option value="expense" selected>مصروف</option></select></div>
                <div><label>المبلغ (ج.م)</label><input id="amount" type="number" step="0.01" placeholder="0.00" /></div>
                <div><label>التاريخ</label><input id="date" type="date" /></div>
                <div><label>الوصف</label><input id="desc" type="text" placeholder="مثال: سوبر ماركت" /></div>
                <div><label>الحساب</label><select id="account"></select></div>
                <div><label>الفئة</label><select id="category"></select></div>
                <div><label>ربط الالتزام (اختياري لمصروفات)</label><select id="linkCommit"></select></div>
                <div class="grid grid-2" style="grid-column:1/-1">
                  <button id="saveTx" class="btn btn-primary">حفظ</button>
                  <button id="resetForm" class="btn btn-outline">إفراغ</button>
                </div>
              </div>
            </div>
        </section>

        <div class="hr"></div>

        <section class="card" id="card-transfer" data-collapsible>
            <div class="card-head"><h3>تحويل بين الحسابات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
            <div class="card-body">
              <div class="transfer-grid">
                <div><label>من حساب</label><select id="trFrom"></select></div>
                <div><label>إلى حساب</label><select id="trTo"></select></div>
                <div><label>المبلغ (ج.م)</label><input id="trAmount" type="number" step="0.01" placeholder="0.00" /></div>
                <div><label>عمولة التحويل (اختياري)</label><input id="trFee" type="number" step="0.01" placeholder="0.00" /></div>
                <div><label>التاريخ</label><input id="trDate" type="date" /></div>
                <div><label>ملاحظة</label><input id="trDesc" type="text" placeholder="مثال: تحويل لمحفظة"/></div>
                <div class="full" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  <button id="execTransfer" class="btn btn-primary">تنفيذ التحويل</button>
                  <button id="resetTransfer" class="btn btn-outline">إفراغ</button>
                </div>
              </div>
              <div style="margin-top:8px;color:var(--muted);font-size:12px">ملاحظة: التحويلات لا تُحسب ضمن إجمالي الدخل/المصروف، لكن العمولة تُحسب كمصروف.</div>
            </div>
        </section>

        <div class="hr"></div>

        <section class="card" id="card-txs" data-collapsible>
            <div class="card-head"><h3>الحركات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▾</button></div>
            <div class="card-body">
              <div class="toolbar" style="margin-bottom:8px">
                <input id="search" placeholder="بحث بالوصف" style="max-width:220px"/>
                <select id="fType" style="max-width:150px"><option value="all" selected>الكل</option><option value="income">دخل فقط</option><option value="expense">مصروف فقط</option></select>
                <select id="fAccount" style="max-width:180px"></select>
                <input id="fFrom" type="date" />
                <input id="fTo" type="date" />
                <button id="clearFilters" class="btn btn-outline">مسح الفلاتر</button>
                <span class="spacer"></span>
                <span class="badge">العملة: ج.م</span>
              </div>
              <div style="overflow:auto">
                <table>
                  <thead><tr><th>التاريخ</th><th>الوصف</th><th>الفئة</th><th>الحساب</th><th>المبلغ</th><th>رصيد الحساب بعد العملية</th><th>إجراءات</th></tr></thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>
              <div class="pager" id="txPager" style="display:none">
                <button id="txPrev" class="btn btn-outline" type="button">السابق</button>
                <div class="info" id="txPagerInfo">صفحة 1 / 1</div>
                <button id="txNext" class="btn btn-outline" type="button">التالي</button>
              </div>
            </div>
        </section>
    </div>
    
    <div class="page" id="page-commitments">
        <section class="card" id="card-commit" data-collapsible>
            <div class="card-head"><h3>الالتزامات الشهرية</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▾</button></div>
            <div class="card-body">
              <div class="grid grid-4">
                <div><label>اسم الالتزام</label><input id="cName" placeholder="مثال: إيجار، إنترنت" /></div>
                <div><label>المبلغ (ج.م)</label><input id="cAmount" type="number" step="0.01" placeholder="0.00" /></div>
                <div><label>تاريخ أول استحقاق</label><input id="cFirstDue" type="date" required /></div>
                <div class="checkbox-row"><input id="cRecurring" type="checkbox" /><label for="cRecurring" style="margin:0">يتكرر شهريًا</label></div>
                <div style="grid-column:1/span 2"><label>ينتهي في (إجباري عند التكرار)</label><input id="cEndAt" type="date" /></div>
              </div>
              <div class="toolbar" style="margin-top:10px">
                <button id="addCommitment" class="btn btn-outline">إضافة/تحديث</button>
                <span class="spacer"></span><span class="badge">يمكن السداد جزئيًا من "إضافة حركة"</span>
              </div>
              <div style="overflow:auto">
                <table>
                  <thead><tr>
                    <th>الاسم</th><th>المبلغ</th><th>استحقاق</th><th>مدفوع (الشهر)</th><th>متبقّي</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th>
                  </tr></thead>
                  <tbody id="tbodyCommit"></tbody>
                </table>
              </div>
            </div>
        </section>

        <div class="hr"></div>

        <section class="card" id="card-collect" data-collapsible>
            <div class="card-head"><h3>مبالغ تحت التحصيل</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▾</button></div>
            <div class="card-body">
              <div class="grid grid-4">
                <div><label>اسم التحصيل</label><input id="coName" placeholder="مثال: إيجار مستلم، مبيعات آجل" /></div>
                <div><label>المبلغ (ج.م)</label><input id="coAmount" type="number" step="0.01" placeholder="0.00" /></div>
                <div><label>تاريخ أول استحقاق</label><input id="coFirstDue" type="date" required /></div>
                <div class="checkbox-row"><input id="coRecurring" type="checkbox" /><label for="coRecurring" style="margin:0">يتكرر شهريًا</label></div>
                <div style="grid-column:1/span 2"><label>ينتهي في (إجباري عند التكرار)</label><input id="coEndAt" type="date" /></div>
              </div>
              <div class="toolbar" style="margin-top:10px">
                <button id="addCollect" class="btn btn-outline">إضافة/تحديث</button>
                <span class="spacer"></span><span class="badge">لا يظهر في الحركات إلا بعد "تم التحصيل"</span>
              </div>
              <div style="overflow:auto">
                <table>
                  <thead><tr><th>الاسم</th><th>المبلغ</th><th>التحصيل القادم</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th></tr></thead>
                  <tbody id="tbodyCollect"></tbody>
                </table>
              </div>
            </div>
        </section>
    </div>

    <div class="page" id="page-settings">
        <section class="card" id="card-reports" data-collapsible>
            <div class="card-head"><h3>تقارير شهرية و رسوم بيانية</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▾</button></div>
            <div class="card-body">
              <div class="toolbar" style="margin-bottom:8px">
                <input id="monthPicker" type="month" />
                <button id="refreshReports" class="btn btn-outline">تحديث</button>
                <span class="spacer"></span><span class="badge">إجمالي الدخل/المصروف لكل شهر</span>
              </div>
              <div class="grid grid-2">
                <div>
                  <canvas id="chartMonthly" width="560" height="320" aria-label="Monthly chart"></canvas>
                  <div class="report-legend">
                    <span><span class="legend-dot" style="background:#22c55e"></span> دخل</span>
                    <span><span class="legend-dot" style="background:#ef4444"></span> مصروف</span>
                    <span><span class="legend-dot" style="background:transparent;border:2px solid #0ea5e9"></span> صافي</span>
                    <span style="margin-inline-start:auto;font-size:11px">القيم مقيّسة وفق أكبر شهر</span>
                  </div>
                </div>
                <div class="report-table-wrap">
                  <table>
                    <thead><tr><th>الشهر</th><th>إجمالي الدخل</th><th>إجمالي المصروف</th><th>الصافي</th></tr></thead>
                    <tbody id="tbodyMonthly"></tbody>
                  </table>
                </div>
              </div>
            </div>
        </section>

        <section class="card" id="card-accounts" data-collapsible>
            <div class="card-head"><h3>إدارة الحسابات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
            <div class="card-body">
              <div class="grid grid-3">
                <div><label>اسم الحساب</label><input id="newAccountName" placeholder="مثال: كاش/محفظة" /></div>
                <div><label>رصيد افتتاحي</label><input id="newAccountOpening" type="number" step="0.01" placeholder="0.00" /></div>
                <div><label>&nbsp;</label><button id="addAccount" class="btn btn-outline" style="width:100%">إضافة حساب</button></div>
              </div>
              <div id="accountsList" class="toolbar" style="margin-top:8px;flex-wrap:wrap"></div>
            </div>
        </section>

        <section class="card" id="card-cats" data-collapsible>
            <div class="card-head"><h3>إدارة الفئات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
            <div class="card-body">
              <div class="grid grid-3">
                <div><label>اسم الفئة</label><input id="newCatName" placeholder="مثال: أكل" /></div>
                <div><label>النوع</label><select id="newCatType"><option value="expense" selected>مصروف</option><option value="income">دخل</option></select></div>
                <div><label>&nbsp;</label><button id="addCategory" class="btn btn-outline" style="width:100%">إضافة فئة</button></div>
              </div>
              <div id="catsList" class="toolbar" style="margin-top:8px;flex-wrap:wrap"></div>
            </div>
        </section>
        
        <section class="card collapsed" id="card-github" data-collapsible>
            <div class="card-head"><h3>إعدادات مزامنة GitHub</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
            <div class="card-body">
              <div class="grid grid-4">
                <div><label>اسم المستخدم</label><input id="ghUser" placeholder="مثال: username" /></div>
                <div><label>المستودع</label><input id="ghRepo" placeholder="مثال: Finance2025" /></div>
                <div><label>الفرع</label><input id="ghBranch" value="main" /></div>
                <div><label>مسار الملف (JSON)</label><input id="ghPath" value="my-finance.json" /></div>
              </div>
              <div class="grid grid-3" style="margin-top:8px">
                <div><label>Personal Access Token</label><input id="ghToken" type="password" placeholder="ghp_..." /></div>
                <div class="checkbox-row" style="margin-top:22px"><input id="ghAuto" type="checkbox"/><label for="ghAuto" style="margin:0">مزامنة تلقائيًا بعد كل تعديل</label></div>
                <div class="grid grid-2" style="margin-top:22px">
                  <button id="ghSaveCfg" class="btn btn-outline">حفظ الإعدادات</button>
                  <button id="ghTest" class="btn btn-outline">اختبار الاتصال</button>
                </div>
              </div>
              <div class="grid grid-3" style="margin-top:8px">
                <button id="ghPullOld" class="btn btn-outline">تحميل من GitHub</button>
                <button id="ghPushOld" class="btn btn-primary">رفع إلى GitHub</button>
                <span id="ghStatus" class="badge">الحالة: غير متصل</span>
              </div>
              <div style="margin-top:8px;color:var(--muted);font-size:12px">⚠️ الـ Token محفوظ محليًا في جهازك فقط.</div>
            </div>
        </section>

        <div class="hr"></div>
        <div class="toolbar" style="justify-content:center;">
            <button id="exportJson" class="btn btn-outline" type="button">تصدير JSON</button>
            <button id="exportCsv" class="btn btn-outline" type="button">تصدير CSV</button>
            <label class="btn btn-muted" for="importFile">استيراد JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
        </div>
        
        <div class="footer">
            <div>⚠️ <span class="note">تنبيه:</span> كل البيانات محفوظة محليًا في <code>localStorage</code>. لا تنسَ التصدير كنسخة احتياطية.</div>
        </div>
    </div>
</div>

<nav class="nav-bar" id="bottomNav">
    <div class="nav-item active" data-page="page-home"><i class="fas fa-home"></i><span>الرئيسية</span></div>
    <div class="nav-item" data-page="page-txs"><i class="fas fa-exchange-alt"></i><span>حركات</span></div>
    <div class="nav-item" data-page="page-commitments"><i class="fas fa-calendar-check"></i><span>التزامات</span></div>
    <div class="nav-item" data-page="page-settings"><i class="fas fa-cog"></i><span>إعدادات</span></div>
</nav>

<script>
/* ===== مفاتيح التخزين ===== */
const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1',
      COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1', GH_KEY='pf_github_cfg_v1',
      THEME_KEY='pf_theme_v1', PAGE_KEY='pf_active_page_v1'; // مفتاح جديد للصفحة

/* ===== الحالة ===== */
let ledger=JSON.parse(localStorage.getItem(KEY)||'[]');
let accounts=JSON.parse(localStorage.getItem(ACC_KEY)||'[]');
let categories=JSON.parse(localStorage.getItem(CAT_KEY)||'[]');
let commitments=JSON.parse(localStorage.getItem(COM_KEY)||'[]');
let collections=JSON.parse(localStorage.getItem(COL_KEY)||'[]');
let ghCfg=JSON.parse(localStorage.getItem(GH_KEY)||'{}');
let currentTheme = localStorage.getItem(THEME_KEY) || 'dark'; 
let activePage = localStorage.getItem(PAGE_KEY) || 'page-home'; // الصفحة الافتراضية

/* ... (بقية الدالة ensureBaseCategories) ... */
function ensureBaseCategories(){
  const need=[
    {name:'التزامات شهرية',type:'expense'},
    {name:'تحصيلات شهرية',type:'income'},
    {name:'تحويل صادر',type:'expense'},
    {name:'تحويل وارد',type:'income'},
    {name:'عمولة تحويل',type:'expense'},
  ];
  let changed=false;
  if(categories.length===0){
    categories=[
      {name:'مرتب',type:'income'},{name:'دخل آخر',type:'income'},
      {name:'أكل وشرب',type:'expense'},{name:'مواصلات',type:'expense'},{name:'فواتير',type:'expense'},{name:'تسوق',type:'expense'}
    ];
    changed=true;
  }
  for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } }
  if(changed) saveCategories();
}

/* DOM */
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);

const els={
  // ... (عناصر الـ DOM السابقة) ...
  totalBalance:$('#totalBalance'),
  monthCommitTotal:$('#monthCommitTotal'),
  currentMonthCollections:$('#currentMonthCollections'), 
  nextCommitWithCarry:$('#nextCommitWithCarry'),
  nextMonthCollections:$('#nextMonthCollections'),
  perAccount:$('#perAccount'),
  tbody:$('#tbody'), type:$('#type'), amount:$('#amount'), date:$('#date'), desc:$('#desc'),
  account:$('#account'), category:$('#category'), linkCommit:$('#linkCommit'),
  saveTx:$('#saveTx'), resetForm:$('#resetForm'), search:$('#search'),
  exportJson:$('#exportJson'), exportCsv:$('#exportCsv'), importFile:$('#importFile'), 
  newAccountName:$('#newAccountName'), newAccountOpening:$('#newAccountOpening'), addAccount:$('#addAccount'), accountsList:$('#accountsList'),
  newCatName:$('#newCatName'), newCatType:$('#newCatType'), addCategory:$('#addCategory'), catsList:$('#catsList'),
  monthPicker:$('#monthPicker'), refreshReports:$('#refreshReports'), tbodyMonthly:$('#tbodyMonthly'), chartMonthly:$('#chartMonthly'),
  cName:$('#cName'), cAmount:$('#cAmount'), cFirstDue:$('#cFirstDue'), cRecurring:$('#cRecurring'), cEndAt:$('#cEndAt'),
  addCommitment:$('#addCommitment'), tbodyCommit:$('#tbodyCommit'),
  coName:$('#coName'), coAmount:$('#coAmount'), coFirstDue:$('#coFirstDue'), coRecurring:$('#coRecurring'), coEndAt:$('#coEndAt'),
  addCollect:$('#addCollect'), tbodyCollect:$('#tbodyCollect'),
  installBtn:$('#installBtn'),
  trFrom:$('#trFrom'), trTo:$('#trTo'), trAmount:$('#trAmount'), trFee:$('#trFee'), trDate:$('#trDate'), trDesc:$('#trDesc'),
  execTransfer:$('#execTransfer'), resetTransfer:$('#resetTransfer'),
  ghUser:$('#ghUser'), ghRepo:$('#ghRepo'), ghBranch:$('#ghBranch'), ghPath:$('#ghPath'), ghToken:$('#ghToken'),
  ghAuto:$('#ghAuto'), ghSaveCfg:$('#ghSaveCfg'), ghTest:$('#ghTest'), ghPullOld:$('#ghPullOld'), ghPushOld:$('#ghPushOld'), ghStatus:$('#ghStatus'),
  syncPushBtnV2:$('#syncPushBtnV2'), syncPullBtnV2:$('#syncPullBtnV2'), syncStatusDisplayV2:$('#syncStatusDisplayV2'),
  syncIconV2:$('#syncIconV2'), syncMessageV2:$('#syncMessageV2'), syncLastTimeV2:$('#syncLastTimeV2'),
  syncConfigInfo:$('#syncConfigInfo'),
  dueTotalBadge:$('#dueTotalBadge'), dueNextTotalBadge:$('#dueNextTotalBadge'), dueSoonCards:$('#dueSoonCards'),
  appBody: $('#appBody'),
  toggleThemeBtn: $('#toggleThemeBtn'),
  themeColorMeta: $('#themeColorMeta'),
  // عناصر التنقل الجديدة
  bottomNav: $('#bottomNav'),
  pageTitle: $('#pageTitle')
};

['saveTx','resetForm','addAccount','addCategory','exportJson','exportCsv','refreshReports','addCommitment','addCollect','execTransfer','resetTransfer','ghSaveCfg','ghTest','ghPullOld','ghPushOld','syncPushBtnV2','syncPullBtnV2', 'toggleThemeBtn']
  .forEach(id=>document.getElementById(id)?.setAttribute('type','button'));

/* Utils */
const eid=()=>Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const fmt=n=>Number(n).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const escapeHtml=s=>String(s).replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
document.getElementById('date') && (els.date.value=new Date().toISOString().slice(0,10));
document.getElementById('trDate') && (els.trDate.value=new Date().toISOString().slice(0,10));
function formatLocalDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function parseLocalDate(str){const [y,m,d]=str.split('-').map(Number);const dt=new Date(y,m-1,d,0,0,0,0);dt.setHours(0,0,0,0);return dt;}
function startOfToday(){const t=new Date();t.setHours(0,0,0,0);return t;}
function addMonthsPreserveDOM(date,months){const d=new Date(date.getTime());const targetMonth=d.getMonth()+months;const day=d.getDate(),y=d.getFullYear();const temp=new Date(y,targetMonth+1,0);const lastDay=temp.getDate();d.setMonth(targetMonth,Math.min(day,lastDay));d.setHours(0,0,0,0);return d;}
function daysBetween(a,b){const MS=24*60*60*1000;const da=new Date(a.getFullYear(),a.getMonth(),a.getDate());const db=new Date(b.getFullYear(),b.getMonth(),b.getDate());return Math.round((db-da)/MS);}
const YM=()=>formatLocalDate(startOfToday()).slice(0,7);
const addMonthsToYm=(ym, months)=>{
  const parts=(ym||'').split('-').map(Number);
  const y=parts[0], m=parts[1];
  if(!Number.isFinite(y)||!Number.isFinite(m)) return ym;
  const base=new Date(y,m-1,1);
  const next=addMonthsPreserveDOM(base, months);
  return formatLocalDate(next).slice(0,7);
};
const monthLabel=ym=>{ if(!ym) return '—'; const [y,m]=ym.split('-').map(Number); if(!Number.isFinite(y)||!Number.isFinite(m)) return ym; const dt=new Date(y,m-1,1); return dt.toLocaleDateString('ar-EG',{month:'long',year:'numeric'}); };
const formatTime=d=>d.toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit',hour12:true});

/* ===== دالة تبديل الوضع (Theme Toggle) ===== */
function setTheme(theme){
    if(!els.appBody || !els.toggleThemeBtn) return;
    currentTheme = theme;
    localStorage.setItem(THEME_KEY, theme);

    if(theme === 'light'){
        els.appBody.classList.add('light-theme');
        els.toggleThemeBtn.innerHTML = '<i class="fas fa-moon"></i>';
        els.toggleThemeBtn.title = 'الوضع الليلي';
        if(els.themeColorMeta) els.themeColorMeta.content = '#f8fafc';
    } else {
        els.appBody.classList.remove('light-theme');
        els.toggleThemeBtn.innerHTML = '<i class="fas fa-sun"></i>';
        els.toggleThemeBtn.title = 'الوضع النهاري';
        if(els.themeColorMeta) els.themeColorMeta.content = '#0b1220';
    }
}
els.toggleThemeBtn?.addEventListener('click', ()=>{
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
});

/* ===== دوال التنقل المبوب (جديد) ===== */
const pageTitles = {
    'page-home': 'دفتر حساباتي - الرئيسية',
    'page-txs': 'دفتر حساباتي - المعاملات',
    'page-commitments': 'دفتر حساباتي - الالتزامات والتحصيل',
    'page-settings': 'دفتر حساباتي - التقارير والإعدادات'
};
function showPage(pageId){
    // إخفاء جميع الصفحات
    $$('.page').forEach(page => page.classList.remove('active'));
    
    // إظهار الصفحة المطلوبة
    const targetPage = $(`#${pageId}`);
    if(targetPage) targetPage.classList.add('active');
    
    // تحديث شريط التنقل السفلي
    $$('.nav-item').forEach(item => item.classList.remove('active'));
    $(`.nav-item[data-page="${pageId}"]`)?.classList.add('active');
    
    // تحديث عنوان الصفحة في الـ Header
    if(els.pageTitle) els.pageTitle.textContent = pageTitles[pageId] || 'دفتر حساباتي';

    // حفظ الوضع
    activePage = pageId;
    localStorage.setItem(PAGE_KEY, pageId);
    
    // إعادة رسم الرسم البياني عند الانتقال لصفحة التقارير
    if(pageId === 'page-settings') {
        drawMonthly();
    }
    
    // التمرير للأعلى
    window.scrollTo({top:0,behavior:'smooth'});
}
els.bottomNav?.addEventListener('click', (e)=>{
    const item = e.target.closest('.nav-item');
    if(item){
        const pageId = item.dataset.page;
        if(pageId && pageId !== activePage) showPage(pageId);
    }
});

/* ... (بقية دوال العمليات: saveLedger, saveAccounts, إلخ.) ... */
function saveLedger(){ localStorage.setItem(KEY, JSON.stringify(ledger)); maybeAutoSync(); }
function saveAccounts(){ localStorage.setItem(ACC_KEY, JSON.stringify(accounts)); refreshAccountSelects(); drawAccountsBadges(); recalc(); maybeAutoSync(); }
function saveCategories(){ localStorage.setItem(CAT_KEY, JSON.stringify(categories)); refreshCategorySelect(); drawCatsBadges(); maybeAutoSync(); }
function saveCommitments(){ localStorage.setItem(COM_KEY, JSON.stringify(commitments)); drawCommitments(); drawDueSoon(); recalc(); maybeAutoSync(); }
function saveCollections(){ localStorage.setItem(COL_KEY, JSON.stringify(collections)); drawCollections(); recalc(); maybeAutoSync(); }

/* ... (بقية الدوال كما هي، لا تغيير في منطق العمليات) ... */

/* ===== إعادة الحساب + الملخص (recalc) ===== */
function recalc(){
  const {bal}=computeBalances(); let total=0; for(const v of bal.values()) total+=v;

  const monthComRemain = sumCurrentMonthCommitments();
  const nextWithCarry  = sumNextMonthCommitmentsIncludingCarry();
  const monthCol = sumCurrentMonthCollections(); 
  const nextCol        = sumNextMonthCollections();

  if(els.totalBalance) els.totalBalance.textContent=fmt(total);
  if(els.monthCommitTotal) els.monthCommitTotal.textContent='-'+fmt(monthComRemain);
  if(els.currentMonthCollections) els.currentMonthCollections.textContent=fmt(monthCol); 
  if(els.nextCommitWithCarry) els.nextCommitWithCarry.textContent='-'+fmt(nextWithCarry);
  if(els.nextMonthCollections) els.nextMonthCollections.textContent=fmt(nextCol);

  drawAccountsBadges(bal); drawPerAccount(bal);
  refreshLinkCommitOptions();
}

/* ===== جدول الحركات (render) ===== */
let editId=null;
const TXS_PER_PAGE = 15;
let txPage = 1;

function render(){
  const q=(els.search?.value||'').toLowerCase(),
        ft=document.getElementById('fType')?.value||'all',
        fa=document.getElementById('fAccount')?.value||'all',
        ff=document.getElementById('fFrom')?.value||'',
        fto=document.getElementById('fTo')?.value||'';
  const {after}=computeBalances();

  const rowsAsc=[...ledger].filter(t=>{
    if(q && !(t.desc||'').toLowerCase().includes(q)) return false;
    if(ft!=='all' && t.type!==ft) return false;
    if(fa!=='all' && t.account!==fa) return false;
    if(ff && t.date<ff) return false;
    if(fto && t.date>fto) return false;
    return true;
  }).sort((a,b)=> a.date.localeCompare(b.date) || (a.id>b.id?1:-1));

  const rowsDesc = rowsAsc.slice().reverse();

  // pagination
  const totalRows = rowsDesc.length;
  const totalPages = Math.max(1, Math.ceil(totalRows / TXS_PER_PAGE));
  if(txPage > totalPages) txPage = totalPages;
  const start = (txPage-1)*TXS_PER_PAGE;
  const pageRows = rowsDesc.slice(start, start + TXS_PER_PAGE);

  if(els.tbody){
    els.tbody.innerHTML=pageRows.map(t=>{
      const cls=t.type==='income'?'inc':'exp'; const afterVal=after.has(t.id)?after.get(t.id):0;
      const tag = t.isTransfer ? ' <span style="font-size:11px;color:var(--muted)">↔︎ تحويل</span>' : '';
      return `<tr>
        <td>${t.date}</td><td>${escapeHtml(t.desc||'—')}${tag}</td><td>${escapeHtml(t.category||'—')}</td><td>${escapeHtml(t.account)}</td>
        <td class="amount ${cls}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
        <td>${fmt(afterVal)}</td>
        <td class="actions"><button class="btn btn-primary" onclick="editTx('${t.id}')">تعديل</button>
            <button class="btn btn-danger" onclick="delTx('${t.id}')">حذف</button></td>
      </tr>`;
    }).join('');
  }

  // pager UI
  const pager = document.getElementById('txPager');
  const pagerInfo = document.getElementById('txPagerInfo');
  const prevBtn = document.getElementById('txPrev');
  const nextBtn = document.getElementById('txNext');
  if(!pager || totalRows <= TXS_PER_PAGE){ pager && (pager.style.display='none'); }
  else{
    pager.style.display='flex';
    pagerInfo.textContent = `صفحة ${txPage} / ${totalPages} — إجمالي ${totalRows} حركة`;
    prevBtn.disabled = txPage<=1;
    nextBtn.disabled = txPage>=totalPages;
  }

  recalc(); drawDueSoon(); 
  // لا نستدعي drawMonthly() هنا، يتم استدعاؤها فقط عند فتح صفحة التقارير
  if(activePage === 'page-settings') drawMonthly();
}
// ... (بقية الدوال: editTx, delTx, addTx, إلخ. تبقى كما هي) ...

/* ===== التقارير: drawMonthly (إعادة الرسم بناءً على الوضع) ===== */
// ... (دوال التقارير) ...
function drawMonthlyChart(data, selected){
  const cv=els.chartMonthly; if(!cv) return;
  // ... (منطق الرسم البياني مع استخدام currentTheme) ...
  const ctx=cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height);
  const pad=42,w=cv.width,h=cv.height,innerW=w-pad*2,innerH=h-pad*2;
  if(!data.length){
    ctx.fillStyle=currentTheme==='light'?'#475569':'#94a3b8'; ctx.font='14px system-ui'; ctx.textAlign='center';
    ctx.fillText('لا توجد بيانات لعرض الرسم البياني', w/2, h/2);
    return;
  }
  const maxInc=Math.max(0,...data.map(d=>d.inc));
  const maxExp=Math.max(0,...data.map(d=>d.exp));
  const maxNet=Math.max(0,...data.map(d=>d.net));
  const minNet=Math.min(0,...data.map(d=>d.net));
  const minVal=Math.min(0,minNet);
  const maxVal=Math.max(1,maxInc,maxExp,maxNet,Math.abs(minVal));
  const range=maxVal-minVal||1;
  const toY=v=>h-pad-((v-minVal)/range)*innerH;
  const zeroY=toY(0);
  const barGroup=innerW/Math.max(1,data.length);
  const barWidth=Math.min(28,Math.max(10,barGroup*0.28));

  // تحديث لون خطوط الشبكة في الرسم البياني
  ctx.strokeStyle=currentTheme==='light'?'#e2e8f0':'#1f2a44'; ctx.lineWidth=1; const gridLines=4;
  ctx.font='11px system-ui'; ctx.textAlign='right'; 
  ctx.fillStyle=currentTheme==='light'?'#64748b':'#94a3b8'; // تحديث لون النص

  for(let i=0;i<=gridLines;i++){
    const v=minVal+(range*i/gridLines);
    const y=toY(v);
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke();
    ctx.fillText(fmt(v), pad-6, y+4);
  }
  if(minVal<0){ ctx.strokeStyle='rgba(56,189,248,0.4)'; ctx.beginPath(); ctx.moveTo(pad,zeroY); ctx.lineTo(w-pad,zeroY); ctx.stroke(); }

  data.forEach((d,i)=>{
    const xCenter=pad+i*barGroup+barGroup/2;
    if(d.month===selected){ ctx.fillStyle='rgba(14,165,233,0.16)'; ctx.fillRect(xCenter-barGroup/2+4, pad, barGroup-8, innerH); }
    if(d.inc>0){
      const top=toY(d.inc); const height=Math.max(2, zeroY-top);
      ctx.fillStyle='#22c55e'; ctx.fillRect(xCenter-barWidth-4, top, barWidth, height);
    }
    if(d.exp>0){
      const top=toY(d.exp); const height=Math.max(2, zeroY-top);
      ctx.fillStyle='#ef4444'; ctx.fillRect(xCenter+4, top, barWidth, height);
    }
  });

  ctx.strokeStyle='#0ea5e9'; ctx.lineWidth=2; ctx.beginPath();
  data.forEach((d,i)=>{ const xCenter=pad+i*barGroup+barGroup/2; const y=toY(d.net); if(i===0) ctx.moveTo(xCenter,y); else ctx.lineTo(xCenter,y); }); ctx.stroke();
  
  // تحديث لون نص الشهور
  ctx.fillStyle=currentTheme==='light'?'#1e293b':'#cbd5e1'; 
  ctx.font='12px system-ui'; ctx.textAlign='center';
  data.forEach((d,i)=>{ const xCenter=pad+i*barGroup+barGroup/2; ctx.fillText(monthLabel(d.month), xCenter, h-pad+18); });
}

/* ... (بقية الدوال: drawMonthly, drawMonthSummary) ... */

/* ===== تهيئة ===== */
function init(){
  setTheme(currentTheme);

  if(accounts.length===0){
    accounts=[{name:'كاش',opening:0},{name:'حساب بنكي',opening:0},{name:'محفظة',opening:0}];
    saveAccounts();
  }
  ensureBaseCategories();
  // إزالة تهيئة Collapsibles القديمة
  // initCollapsibles(); 

  // تحديث Collapsibles: فتح الافتراضي في صفحاتها
  document.getElementById('card-addtx')?.classList.remove('collapsed');
  document.getElementById('card-txs')?.classList.remove('collapsed');
  document.getElementById('card-commit')?.classList.remove('collapsed');
  document.getElementById('card-collect')?.classList.remove('collapsed');
  
  // ... (بقية الهجرة والإعدادات) ...
  commitments=commitments.map(c=>migrateCommit(c));
  collections=collections.map(c=>migrateCollect(c));
  saveCommitments(); saveCollections();
  ensureTransferCategories();

  if(els.monthPicker){
    const today=YM();
    if(!els.monthPicker.value) els.monthPicker.value=today;
    els.monthPicker.setAttribute('max', today);
  }

  refreshAccountSelects(); refreshCategorySelect(); drawCatsBadges();
  drawCommitments(); drawCollections(); drawDueSoon(); render();
  fillGhFormFromStorage();
  els.cEndAt?.toggleAttribute('required', els.cRecurring?.checked);
  els.coEndAt?.toggleAttribute('required', els.coRecurring?.checked);
  refreshLinkCommitOptions();

  if(ghCfg.user && ghCfg.repo && ghCfg.token) {
    ghStatus('الإعدادات جاهزة. اضغط **مزامنة الآن** لرفع البيانات.', true);
  }
  
  // إظهار الصفحة المحفوظة (أو الافتراضية)
  showPage(activePage); 
}
init();

/* Pager events */
document.getElementById('txPrev')?.addEventListener('click', ()=>{ if(txPage>1){ txPage--; render(); }});
document.getElementById('txNext')?.addEventListener('click', ()=>{ txPage++; render(); });

</script>
</body>
</html>
