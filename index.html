<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>My Finance Pro</title>
    <style>
        /* --- CSS STYLING --- */
        :root {
            --primary: #6366f1;
            --primary-rgb: 99, 102, 241;
            --primary-dark: #4338ca;
            --bg-grad-start: #f3f4f6;
            --bg-grad-end: #e0e7ff;
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: rgba(255, 255, 255, 0.6);
            --text: #1e293b;
            --text-sub: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .dark {
            --primary: #818cf8;
            --primary-rgb: 129, 140, 248;
            --primary-dark: #6366f1;
            --bg-grad-start: #0f172a;
            --bg-grad-end: #1e1b4b;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
            --text: #f1f5f9;
            --text-sub: #94a3b8;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            background-attachment: fixed;
            color: var(--text); 
            padding-bottom: 90px; 
            min-height: 100vh;
            transition: color 0.3s; 
            overscroll-behavior-y: none; 
        }

        .container { max-width: 600px; margin: 0 auto; padding: 16px; }

        /* Typography */
        h1, h2, h3 { margin: 0; letter-spacing: -0.02em; }
        .text-xl { font-size: 22px; font-weight: 800; }
        .text-lg { font-size: 18px; font-weight: 700; }
        .text-base { font-size: 15px; }
        .text-sm { font-size: 13px; }
        .text-xs { font-size: 11px; }
        .text-sub { color: var(--text-sub); }
        .bold { font-weight: 700; }
        .uppercase { text-transform: uppercase; letter-spacing: 0.05em; }

        /* Privacy Blur Mode */
        body.privacy-mode .privacy-blur {
            filter: blur(6px);
            transition: filter 0.2s;
            user-select: none;
        }
        body.privacy-mode .privacy-blur:hover { filter: blur(0); }

        /* Components */
        .card { 
            background: var(--card-bg); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px; 
            padding: 20px; 
            box-shadow: var(--shadow); 
            margin-bottom: 16px; 
            border: 1px solid var(--card-border); 
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
        }
        
        .animate-enter { animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .btn { 
            border: none; padding: 12px 16px; border-radius: 14px; 
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            gap: 6px; transition: all 0.2s; font-size: 14px; 
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; width: 100%; 
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
        }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-outline { background: transparent; border: 1px solid var(--card-border); color: var(--text); }
        .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 10px; }

        /* Inputs */
        .input-group { margin-bottom: 14px; }
        .label { display: block; font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.05em; }
        .input { 
            width: 100%; padding: 14px; border-radius: 14px; 
            border: 1px solid var(--card-border); 
            background: rgba(255,255,255,0.5); 
            color: var(--text); font-size: 16px; outline: none; 
            transition: border-color 0.2s, background 0.2s;
        }
        .dark .input { background: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.1); }
        .input:focus { border-color: var(--primary); background: transparent; }

        /* Header & Nav */
        header { 
            position: sticky; top: 0; 
            background: var(--card-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            padding: 16px; border-bottom: 1px solid var(--card-border); 
            z-index: 50; display: flex; justify-content: space-between; align-items: center; 
        }
        
        nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--card-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid var(--card-border); display: flex; justify-content: space-around; 
            padding: 12px 0 24px 0; z-index: 50; box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        
        .nav-item { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-sub); font-size: 10px; font-weight: 600; cursor: pointer; transition: color 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active svg { transform: translateY(-2px); stroke-width: 2.5; }

        /* FAB */
        .fab { 
            position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; 
            border-radius: 20px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; border: none; box-shadow: 0 8px 20px rgba(var(--primary-rgb), 0.4); 
            z-index: 40; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            font-size: 28px; transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }
        [dir="rtl"] .fab { right: auto; left: 20px; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; padding: 20px; opacity: 0; transition: opacity 0.2s; }
        .modal.open { display: flex; opacity: 1; }
        .modal-content { 
            background: var(--bg-grad-start); width: 100%; max-width: 400px; border-radius: 24px; padding: 24px; 
            max-height: 90vh; overflow-y: auto; box-shadow: var(--glass-shadow);
            transform: scale(0.95); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .dark .modal-content { background: #1e293b; }
        .modal.open .modal-content { transform: scale(1); }

        /* Icons & Helpers */
        .icon { width: 22px; height: 22px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .hidden { display: none !important; }
        
        /* Charts (SVG) */
        .chart-container { position: relative; width: 100%; height: 200px; margin-bottom: 20px; display:flex; justify-content:center; }
        .chart-svg { width: 100%; height: 100%; overflow: visible; }
        
        /* Heatmap */
        .heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .heatmap-cell { aspect-ratio: 1; border-radius: 4px; background: rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--text-sub); }
        .dark .heatmap-cell { background: rgba(255,255,255,0.05); }
        .heat-1 { background: rgba(99, 102, 241, 0.2) !important; color: var(--text) !important; }
        .heat-2 { background: rgba(99, 102, 241, 0.5) !important; color: white !important; }
        .heat-3 { background: rgba(99, 102, 241, 0.8) !important; color: white !important; }
        .heat-4 { background: var(--primary) !important; color: white !important; }

        /* PIN Lock Overlay */
        #pinLock { position: fixed; inset: 0; background: var(--bg-grad-start); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: transform 0.3s ease-in-out; }
        #pinLock.unlocked { transform: translateY(-100%); }
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--text-sub); transition: background 0.2s; }
        .pin-dot.filled { background: var(--primary); border-color: var(--primary); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 40px; }
        .num-btn { width: 60px; height: 60px; border-radius: 50%; font-size: 24px; background: rgba(255,255,255,0.1); border: 1px solid var(--card-border); cursor: pointer; color: var(--text); }
        
        /* Progress Bar */
        .progress-bar { height: 6px; background: rgba(0,0,0,0.05); border-radius: 3px; overflow: hidden; margin-top: 6px; }
        .dark .progress-bar { background: rgba(255,255,255,0.1); }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

        .confirm-icon { width: 64px; height: 64px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; color: var(--danger); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px auto; }
        .info-icon { width: 64px; height: 64px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; color: var(--primary); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px auto; }
        
        /* Swipe visual cue */
        .swipe-hint { transition: transform 0.2s; position: relative; overflow: hidden; }
        .swiping { transform: translateX(-30px); opacity: 0.7; }
    </style>
</head>
<body id="body">

    <!-- PIN LOCK SCREEN -->
    <div id="pinLock" class="hidden">
        <div style="margin-bottom:20px; font-size:40px;">üîí</div>
        <h2 class="text-xl bold" style="margin-bottom:20px;">Enter PIN</h2>
        <div class="flex gap-3" id="pinDots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="numpad">
            <button class="num-btn" onclick="enterPin(1)">1</button>
            <button class="num-btn" onclick="enterPin(2)">2</button>
            <button class="num-btn" onclick="enterPin(3)">3</button>
            <button class="num-btn" onclick="enterPin(4)">4</button>
            <button class="num-btn" onclick="enterPin(5)">5</button>
            <button class="num-btn" onclick="enterPin(6)">6</button>
            <button class="num-btn" onclick="enterPin(7)">7</button>
            <button class="num-btn" onclick="enterPin(8)">8</button>
            <button class="num-btn" onclick="enterPin(9)">9</button>
            <button class="num-btn" style="opacity:0; pointer-events:none;"></button>
            <button class="num-btn" onclick="enterPin(0)">0</button>
            <button class="num-btn" onclick="enterPin('del')">‚å´</button>
        </div>
        <button class="btn-ghost" style="margin-top:30px;" onclick="forgotPin()">Forgot PIN?</button>
    </div>

    <header>
        <div class="flex items-center gap-2">
            <div style="width:36px; height:36px; background:linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; box-shadow: 0 4px 10px rgba(var(--primary-rgb), 0.3);">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
            </div>
            <div class="text-xl bold" id="appTitle">My Finance</div>
        </div>
        <div class="flex gap-2">
            <button class="btn-ghost" style="font-size:18px; width:40px; height:40px; border-radius:50%;" onclick="togglePrivacy()" id="eyeBtn">üëÅÔ∏è</button>
            <button class="btn-ghost" style="font-size:18px; width:40px; height:40px; border-radius:50%;" onclick="toggleTheme()" id="themeBtn">üåû</button>
        </div>
    </header>

    <div id="mainContainer" class="container"></div>

    <button class="fab" onclick="openModal('add')" aria-label="Add transaction">
        <svg class="icon" style="width:28px; height:28px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>

    <nav>
        <button class="nav-item active" onclick="switchView('dashboard')" id="nav-dash">
            <svg class="icon"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            <span data-i18n="dash">Home</span>
        </button>
        <button class="nav-item" onclick="switchView('analytics')" id="nav-ana">
            <svg class="icon"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
            <span>Analytics</span>
        </button>
        <button class="nav-item" onclick="switchView('transactions')" id="nav-tx">
            <svg class="icon"><path d="M9 17l-5-5 5-5"/><path d="M20 12H4"/></svg>
            <span data-i18n="tx">Transact</span>
        </button>
        <button class="nav-item" onclick="switchView('accounts')" id="nav-acc">
            <svg class="icon"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
            <span data-i18n="accs">Wallets</span>
        </button>
        <button class="nav-item" onclick="switchView('settings')" id="nav-set">
            <svg class="icon"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <span data-i18n="set">Settings</span>
        </button>
    </nav>

    <!-- Transaction Modal -->
    <div id="txModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom:20px;">
                <h2 class="text-xl" id="modalTitle">Transaction</h2>
                <button class="btn-ghost" onclick="closeModal()">‚úï</button>
            </div>

            <div class="flex gap-2" style="background:rgba(0,0,0,0.05); padding:4px; border-radius:16px; margin-bottom:16px;">
                <button type="button" class="btn" style="flex:1; background:var(--danger); color:white;" id="btn-exp" onclick="setTxType('exp')">Expense</button>
                <button type="button" class="btn btn-ghost" style="flex:1;" id="btn-inc" onclick="setTxType('inc')">Income</button>
            </div>

            <input type="hidden" id="txId"><input type="hidden" id="txRecurringId">

            <div class="input-group relative">
                <label class="label">Amount</label>
                <div class="relative">
                    <input type="number" id="txAmount" class="input" placeholder="0.00" inputmode="decimal" />
                </div>
            </div>
            <div class="input-group">
                <label class="label">Date</label>
                <input type="date" id="txDate" class="input" />
            </div>
            <div class="input-group">
                <label class="label">Description <span id="micStatus" class="text-xs text-green hidden">Listening...</span></label>
                <div class="flex gap-2">
                    <input type="text" id="txDesc" class="input" placeholder="e.g. Salary" />
                    <button class="btn btn-outline" id="voiceBtn" onclick="startVoice()" title="Speak: '50 for Taxi'">üé§</button>
                </div>
            </div>
            <div class="input-group">
                <label class="label">Account</label>
                <select id="txAcc" class="input"></select>
            </div>
            <div class="input-group">
                <label class="label">Category</label>
                <select id="txCatSelect" class="input"></select>
            </div>
            <div class="input-group">
                <label class="label">Attachment (Receipt)</label>
                <input type="file" id="txFile" class="input" accept="image/*" onchange="handleFileSelect(this)" style="padding:10px;">
                <input type="hidden" id="txFileBase64">
                <div id="txFilePreview" class="hidden" style="margin-top:5px; height:50px; background-size:contain; background-repeat:no-repeat;"></div>
            </div>

            <div class="flex gap-2" style="margin-top:24px;">
                <button class="btn btn-danger hidden" id="btnDelete" onclick="deleteTxClick()" style="flex:1">Delete</button>
                <button class="btn btn-primary" onclick="saveTx()" style="flex:2">Save</button>
            </div>
        </div>
    </div>

    <!-- Category Manager Modal -->
    <div id="catModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl">Categories</h2>
                <button class="btn-ghost" onclick="closeCatModal()">‚úï</button>
            </div>
            <div id="catListEdit" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
            <div class="input-group">
                <label class="label">New Category Name</label>
                <input type="text" id="newCatName" class="input">
            </div>
            <div class="flex gap-2">
                <div class="input-group" style="flex:1">
                    <label class="label">Color</label>
                    <input type="color" id="newCatColor" class="input" style="height:48px; padding:4px;">
                </div>
                <div class="input-group" style="flex:1">
                    <label class="label">Budget Limit</label>
                    <input type="number" id="newCatBudget" class="input" placeholder="Optional">
                </div>
            </div>
            <button class="btn btn-primary" onclick="addNewCategory()">Add Category</button>
        </div>
    </div>
    
    <!-- Split Bill Modal -->
    <div id="splitModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom:20px;">
                <h2 class="text-xl">Split Bill</h2>
                <button class="btn-ghost" onclick="document.getElementById('splitModal').classList.remove('open')">‚úï</button>
            </div>
            <div class="input-group">
                <label class="label">Total Amount</label>
                <input type="number" id="splitTotal" class="input" placeholder="0.00" oninput="calcSplit()">
            </div>
            <div class="input-group">
                <label class="label">Number of People</label>
                <input type="range" id="splitCount" min="2" max="10" value="2" style="width:100%" oninput="document.getElementById('splitCountVal').innerText=this.value; calcSplit()">
                <div class="text-center bold" id="splitCountVal">2</div>
            </div>
            <div class="card" style="text-align:center; background:var(--bg-grad-end);">
                <div class="text-xs text-sub">PER PERSON</div>
                <div class="text-xl bold" id="splitResult">$0.00</div>
            </div>
            <button class="btn btn-primary" onclick="alert('Not linked to transaction yet - calculation only')">Close</button>
        </div>
    </div>

    <!-- Smart Paste Modal -->
    <div id="pasteModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom:20px;">
                <h2 class="text-xl">Smart Import</h2>
                <button class="btn-ghost" onclick="document.getElementById('pasteModal').classList.remove('open')">‚úï</button>
            </div>
            <p class="text-sm text-sub" style="margin-bottom:10px;">Paste text (e.g. "50 Taxi, 20 Lunch")</p>
            <textarea id="pasteArea" class="input" style="height:100px; resize:none;"></textarea>
            <button class="btn btn-primary" style="margin-top:10px;" onclick="processPaste()">Import</button>
        </div>
    </div>

    <!-- Generic Modals -->
    <div id="transferModal" class="modal"><div class="modal-content"><h2 class="text-xl mb-4">Transfer</h2><label class="label">From</label><select id="tfFrom" class="input mb-2"></select><label class="label">To</label><select id="tfTo" class="input mb-2"></select><label class="label">Amount</label><input id="tfAmount" type="number" class="input mb-4"><button class="btn btn-primary" onclick="executeTransfer()">Transfer</button><button class="btn btn-ghost mt-2" onclick="document.getElementById('transferModal').classList.remove('open')">Cancel</button></div></div>
    
    <div id="goalModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl mb-4">Savings Goal</h2>
            <input type="hidden" id="goalId">
            <div class="input-group"><label class="label">Goal Name</label><input type="text" id="goalName" class="input"></div>
            <div class="input-group"><label class="label">Target Amount</label><input type="number" id="goalTarget" class="input"></div>
            <div class="input-group"><label class="label">Current Saved</label><input type="number" id="goalCurrent" class="input"></div>
            <button class="btn btn-primary" onclick="saveGoal()">Save Goal</button>
            <button class="btn btn-danger mt-2" onclick="deleteGoal()" id="btnDelGoal">Delete</button>
            <button class="btn btn-ghost mt-2" onclick="document.getElementById('goalModal').classList.remove('open')">Cancel</button>
        </div>
    </div>

    <div id="recModal" class="modal"><div class="modal-content"><h2 class="text-xl" id="recModalTitle">Recurring</h2><input type="hidden" id="recId"><input id="recName" class="input mb-2" placeholder="Name"><input id="recAmount" type="number" class="input mb-2" placeholder="Amount"><input type="date" id="recDate" class="input mb-2"><select id="recFreq" class="input mb-4"><option value="daily">Daily</option><option value="monthly">Monthly</option><option value="weekly">Weekly</option><option value="yearly">Yearly</option></select><input type="date" id="recSkipUntil" class="input mb-4" placeholder="Skip Until"><div class="flex gap-2"><button class="btn btn-danger hidden" onclick="deleteRecClick()" id="btnRecDelete">Del</button><button class="btn btn-primary" style="flex:2" onclick="saveRec()">Save</button><button class="btn btn-ghost" onclick="closeRecModal()">‚úï</button></div></div></div>
    
    <div id="msgModal" class="modal"><div class="modal-content text-center"><div class="info-icon">‚ÑπÔ∏è</div><h2 id="msgTitle" class="text-xl bold"></h2><p id="msgText" class="text-sub mb-4"></p><button class="btn btn-primary" onclick="document.getElementById('msgModal').classList.remove('open')">OK</button></div></div>
    
    <div id="confirmModal" class="modal"><div class="modal-content text-center"><div class="confirm-icon">‚ö†Ô∏è</div><h2 id="confirmTitle" class="text-xl bold"></h2><p id="confirmText" class="text-sub mb-4"></p><div class="flex gap-2"><button class="btn btn-outline" onclick="document.getElementById('confirmModal').classList.remove('open')">Cancel</button><button class="btn btn-danger" id="btnConfirmDelete">Confirm</button></div></div></div>

    <div id="promptModal" class="modal"><div class="modal-content"><h2 id="promptTitle" class="text-xl mb-4"></h2><input id="promptInput" class="input mb-4"><div class="flex gap-2"><button class="btn btn-outline" onclick="document.getElementById('promptModal').classList.remove('open')">Cancel</button><button class="btn btn-primary" id="btnPromptOk">OK</button></div></div></div>

    <script>
        // --- DATA & STATE ---
        const DEFAULT_ACCOUNTS = [ { id: '1', name: 'Wallet', initial: 0 }, { id: '2', name: 'Bank', initial: 0 } ];
        const DEFAULT_CATS = [
            { id: 'c1', name: 'Food', color: '#f59e0b', budget: 0 },
            { id: 'c2', name: 'Transport', color: '#3b82f6', budget: 0 },
            { id: 'c3', name: 'Home', color: '#10b981', budget: 0 },
            { id: 'c4', name: 'Ent', color: '#8b5cf6', budget: 0 }
        ];

        let data = {
            transactions: [],
            accounts: DEFAULT_ACCOUNTS.slice(),
            categories: DEFAULT_CATS.slice(),
            recurring: [],
            goals: [],
            settings: { lang: 'en', theme: 'light', currency: '$', pin: null, privacy: false }
        };

        let currentView = 'dashboard';
        let txType = 'exp';
        let recType = 'exp';
        let onConfirmAction = null; 
        let onPromptAction = null;
        let privacyMode = false;

        // --- INIT ---
        window.onload = () => {
            loadData();
            applyTheme();
            render();
            checkPinLock();
            document.getElementById('txDate').valueAsDate = new Date();
            setupModalBehavior();
        };

        function loadData() {
            // Using 'abouTiaData' to match original data key so you don't lose data
            const stored = localStorage.getItem('abouTiaData');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    data = { ...data, ...parsed };
                    if(!data.categories || data.categories.length === 0) data.categories = DEFAULT_CATS.slice();
                    if(!data.goals) data.goals = [];
                    if(!data.settings.currency) data.settings.currency = '$';
                } catch (e) { console.error("Data error", e); }
            }
        }

        function saveData() {
            localStorage.setItem('abouTiaData', JSON.stringify(data));
            render();
        }

        // --- RENDER FUNCTIONS ---
        function render() {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navMap = { dashboard: 'nav-dash', analytics: 'nav-ana', transactions: 'nav-tx', accounts: 'nav-acc', settings: 'nav-set' };
            if(navMap[currentView]) document.getElementById(navMap[currentView]).classList.add('active');

            const container = document.getElementById('mainContainer');
            container.innerHTML = '';

            if (currentView === 'dashboard') renderDashboard(container);
            else if (currentView === 'analytics') renderAnalytics(container);
            else if (currentView === 'transactions') renderTransactions(container);
            else if (currentView === 'accounts') renderAccounts(container);
            else if (currentView === 'settings') renderSettings(container);
            
            document.body.classList.toggle('privacy-mode', privacyMode);
            document.getElementById('eyeBtn').style.opacity = privacyMode ? '1' : '0.5';
        }

        // --- RECURRING LOGIC ---
        function getRecurringSummaryHTML() {
            const today = new Date();
            const curMonth = today.getMonth();
            const curYear = today.getFullYear();
            
            let unpaidExp = 0, unpaidInc = 0;
            data.recurring.forEach(r => {
                const d = new Date(r.date);
                if (d.getMonth() === curMonth && d.getFullYear() === curYear) {
                    if (r.type === 'exp') unpaidExp += safeNum(r.amount);
                    else unpaidInc += safeNum(r.amount);
                }
            });

            let paidExp = 0, collectedInc = 0;
            data.transactions.forEach(t => {
                if(!t.recId) return;
                const d = new Date(t.date);
                if (d.getMonth() === curMonth && d.getFullYear() === curYear) {
                    if (t.type === 'exp') paidExp += safeNum(t.amount);
                    else collectedInc += safeNum(t.amount);
                }
            });

            const totalExp = unpaidExp + paidExp;
            const totalInc = unpaidInc + collectedInc;
            const expPct = totalExp > 0 ? (paidExp / totalExp) * 100 : 0;
            const incPct = totalInc > 0 ? (collectedInc / totalInc) * 100 : 0;

            return `
                <div class="card animate-enter" style="animation-delay: 0.1s;">
                     <h3 class="text-xs bold text-sub uppercase" style="margin-bottom:12px;">Recurring (This Month)</h3>
                     <div class="flex gap-3" style="margin-bottom:12px;">
                        <div style="flex:1;">
                            <div class="flex justify-between text-xs text-sub"><span>Exp</span> <span>${fmt(unpaidExp)} left</span></div>
                            <div class="bold text-lg text-red">${fmt(totalExp)}</div>
                            <div class="progress-bar"><div class="progress-fill" style="width:${expPct}%; background:var(--danger);"></div></div>
                        </div>
                        <div style="flex:1;">
                            <div class="flex justify-between text-xs text-sub"><span>Inc</span> <span>${fmt(unpaidInc)} left</span></div>
                            <div class="bold text-lg text-green">${fmt(totalInc)}</div>
                            <div class="progress-bar"><div class="progress-fill" style="width:${incPct}%; background:var(--success);"></div></div>
                        </div>
                     </div>
                </div>
            `;
        }

        function getRecurringAlertsHTML() {
            let html = '';
            const recs = data.recurring.map(r => ({ ...r, dateObj: new Date(r.date) }))
                            .sort((a,b) => a.dateObj - b.dateObj);

            recs.forEach((r, idx) => {
                if (r.skipUntil && new Date(r.skipUntil) >= r.dateObj) return;

                const diffDays = daysUntil(r.date);
                if (diffDays > 31) return; 

                let statusColor = diffDays < 0 ? 'var(--danger)' : diffDays === 0 ? 'var(--warning)' : 'var(--text-sub)';
                let borderLeft = diffDays < 0 ? '4px solid var(--danger)' : diffDays === 0 ? '4px solid var(--warning)' : '4px solid var(--primary)';
                const msg = diffDays < 0 ? 'Overdue!' : diffDays === 0 ? 'Due Today' : `In ${diffDays} days`;

                html += `
                    <div class="card flex justify-between items-center animate-enter" style="animation-delay: ${0.15 + (idx * 0.05)}s; border-left:${borderLeft}; padding:14px;">
                        <div>
                            <div class="bold text-base">${r.name}</div>
                            <div class="text-xs" style="color:${statusColor}">${msg} ‚Ä¢ ${r.date}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="bold text-base">${fmt(r.amount)}</div>
                            <div class="flex gap-2" style="margin-top:6px;">
                                <button class="btn btn-sm btn-outline" style="padding:4px 8px;" onclick="skipRecurring('${r.id}')" title="Skip">Skip</button>
                                <button class="btn btn-sm" style="background:var(--primary); color:white; padding:4px 10px;" onclick="payRecurring('${r.id}')">${r.type === 'inc' ? 'Get' : 'Pay'}</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            return html;
        }

        function renderDashboard(container) {
            const total = data.accounts.reduce((sum, acc) => sum + getAccBalance(acc.id), 0);
            
            // Budget Alerts
            let budgetHtml = '';
            const curMonth = new Date().toISOString().slice(0, 7);
            data.categories.forEach(cat => {
                if(cat.budget > 0) {
                    const spent = data.transactions
                        .filter(t => t.type === 'exp' && t.catId === cat.id && t.date.startsWith(curMonth))
                        .reduce((s, t) => s + t.amount, 0);
                    const pct = (spent / cat.budget) * 100;
                    if(pct > 80) {
                        budgetHtml += `
                            <div class="card flex justify-between items-center" style="padding:12px; margin-bottom:8px; border-left:4px solid ${pct>100 ? 'var(--danger)':'var(--warning)'};">
                                <div class="text-sm bold">${cat.name}</div>
                                <div class="text-xs ${pct>100?'text-red':''}"> ${fmt(spent)} / ${fmt(cat.budget)}</div>
                            </div>
                        `;
                    }
                }
            });

            container.innerHTML = `
                <div class="card animate-enter" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border:none; padding:24px;">
                    <div class="text-sm" style="opacity:0.8; font-weight:600;">Total Balance</div>
                    <div class="text-xl bold privacy-blur" style="font-size:36px; margin: 6px 0;">${fmt(total)}</div>
                </div>
                ${getRecurringSummaryHTML()}
                <h3 class="text-xs bold text-sub uppercase mb-2">Upcoming Payments</h3>
                ${getRecurringAlertsHTML()}
                ${budgetHtml ? `<h3 class="text-xs bold text-sub uppercase mb-2">Budget Alerts</h3>${budgetHtml}` : ''}
                
                <h3 class="text-xs bold text-sub uppercase mb-2 mt-4">Wallets</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    ${data.accounts.map(acc => `
                        <div class="card mb-0" style="padding:16px;">
                            <div class="text-xs text-sub uppercase">${acc.name}</div>
                            <div class="text-lg bold privacy-blur">${fmt(getAccBalance(acc.id))}</div>
                        </div>
                    `).join('')}
                </div>

                <h3 class="text-xs bold text-sub uppercase mb-2 mt-4">Recent</h3>
                ${getRecentTxHtml()}
            `;
        }
        
        function getRecentTxHtml() {
            const recent = [...data.transactions].sort((a,b) => new Date(b.date)-new Date(a.date)).slice(0, 5);
            if(recent.length===0) return '<div class="text-center text-sub text-sm">No recent activity</div>';
            return recent.map(t => {
                const cat = data.categories.find(c => c.id === t.catId) || {name:'Misc', color:'#999'};
                return `
                <div class="card flex justify-between items-center" style="padding:12px; margin-bottom:8px;" onclick="editTx('${t.id}')">
                    <div class="flex items-center gap-3">
                        <div style="width:10px; height:10px; border-radius:50%; background:${cat.color}"></div>
                        <div>
                            <div class="bold text-sm">${t.desc}</div>
                            <div class="text-xs text-sub">${t.date}</div>
                        </div>
                    </div>
                    <div class="bold text-sm privacy-blur ${t.type==='inc'?'text-green':''}">${t.type==='inc'?'+':'-'}${fmt(t.amount)}</div>
                </div>`;
            }).join('');
        }

        // --- ANALYTICS ---
        function renderAnalytics(container) {
            const curMonth = new Date().toISOString().slice(0, 7);
            const expensesByCat = {};
            data.transactions.filter(t => t.type==='exp' && t.date.startsWith(curMonth)).forEach(t => {
                const cId = t.catId || 'uncat';
                expensesByCat[cId] = (expensesByCat[cId] || 0) + t.amount;
            });

            // Donut Chart
            let donutSvg = '';
            let totalExp = Object.values(expensesByCat).reduce((a,b)=>a+b, 0);
            let currentAngle = 0;
            const radius = 15.915; 
            
            const donutSegments = Object.keys(expensesByCat).map(catId => {
                const val = expensesByCat[catId];
                const pct = (val / totalExp) * 100;
                const cat = data.categories.find(c=>c.id===catId) || {color:'#ccc', name:'Uncategorized'};
                const seg = `<circle cx="21" cy="21" r="${radius}" fill="none" stroke="${cat.color}" stroke-width="5" stroke-dasharray="${pct} ${100-pct}" stroke-dashoffset="${25 - currentAngle}"></circle>`;
                currentAngle += pct;
                return seg;
            }).join('');

            // Heatmap
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
            let heatmapHtml = '';
            for(let i=1; i<=daysInMonth; i++) {
                const dateKey = `${curMonth}-${String(i).padStart(2,'0')}`;
                const dailyTotal = data.transactions.filter(t=>t.date === dateKey && t.type==='exp').reduce((s,t)=>s+t.amount,0);
                let heatClass = '';
                if(dailyTotal > 0) heatClass = 'heat-1';
                if(dailyTotal > 100) heatClass = 'heat-2';
                if(dailyTotal > 500) heatClass = 'heat-3';
                if(dailyTotal > 1000) heatClass = 'heat-4';
                heatmapHtml += `<div class="heatmap-cell ${heatClass}">${i}</div>`;
            }

            container.innerHTML = `
                <h2 class="text-xl bold mb-4">Analytics (${curMonth})</h2>
                <div class="card">
                    <h3 class="text-sm bold mb-2">Expense Breakdown</h3>
                    <div class="chart-container">
                        <svg viewBox="0 0 42 42" class="chart-svg">${totalExp>0 ? donutSegments : '<circle cx="21" cy="21" r="15.915" fill="none" stroke="#eee" stroke-width="5"></circle>'}</svg>
                        <div style="position:absolute; top:45%; font-weight:bold; font-size:12px;">${fmt(totalExp)}</div>
                    </div>
                    <div class="flex gap-2" style="flex-wrap:wrap; justify-content:center;">
                        ${Object.keys(expensesByCat).map(catId => {
                            const cat = data.categories.find(c=>c.id===catId) || {name:'Misc', color:'#999'};
                            return `<div class="flex items-center gap-2"><div style="width:8px; height:8px; border-radius:50%; background:${cat.color}"></div><span class="text-xs">${cat.name}</span></div>`;
                        }).join('')}
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-sm bold">Spending Heatmap</h3>
                    <div class="heatmap-grid">${heatmapHtml}</div>
                </div>
            `;
        }

        // --- TRANSACTIONS ---
        function renderTransactions(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl bold">Transact</h2>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="txSearch" class="input" placeholder="Search..." onkeyup="filterTx()" style="padding:8px;">
                    <input type="month" id="txFilterDate" class="input" onchange="filterTx()" style="padding:8px; width:120px;">
                </div>
                <div id="txList"></div>
            `;
            filterTx();
        }

        function filterTx() {
            const search = document.getElementById('txSearch')?.value.toLowerCase() || '';
            const dateFilter = document.getElementById('txFilterDate')?.value || '';
            const list = document.getElementById('txList');
            
            let filtered = data.transactions.filter(t => {
                const matchSearch = t.desc.toLowerCase().includes(search) || t.amount.toString().includes(search);
                const matchDate = dateFilter ? t.date.startsWith(dateFilter) : true;
                return matchSearch && matchDate;
            }).reverse();

            if(filtered.length === 0) list.innerHTML = '<div class="text-center text-sub mt-4">No match found</div>';
            else {
                list.innerHTML = filtered.map(t => {
                    const cat = data.categories.find(c => c.id === t.catId);
                    return `
                    <div class="card flex justify-between items-center swipe-hint" onclick="editTx('${t.id}')">
                        <div class="flex items-center gap-3">
                            <div style="width:40px; height:40px; border-radius:12px; background:${cat ? cat.color+'20' : '#eee'}; color:${cat?cat.color:'#555'}; display:flex; align-items:center; justify-content:center; font-size:18px;">
                                ${t.file ? 'üìé' : (t.type==='inc'?'‚Üì':'‚Üë')}
                            </div>
                            <div>
                                <div class="bold text-sm">${t.desc}</div>
                                <div class="text-xs text-sub">${t.date} ‚Ä¢ ${cat ? cat.name : 'Misc'}</div>
                            </div>
                        </div>
                        <div class="bold text-sm privacy-blur ${t.type==='inc'?'text-green':'text-red'}">${t.type==='inc'?'+':'-'}${fmt(t.amount)}</div>
                    </div>`;
                }).join('');
            }
        }

        // --- ACCOUNTS & GOALS ---
        function renderAccounts(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl bold">Wallets</h2>
                    <button class="btn btn-sm btn-outline" onclick="openTransferModal()">Transfer ‚áÑ</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                    ${data.accounts.map(acc => `
                        <div class="card mb-0">
                            <div class="text-xs text-sub uppercase">${acc.name}</div>
                            <div class="text-lg bold privacy-blur">${fmt(getAccBalance(acc.id))}</div>
                        </div>
                    `).join('')}
                    <button class="card flex items-center justify-center mb-0" onclick="addAccount()" style="font-size:24px; color:var(--primary)">+</button>
                </div>

                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg bold">Savings Goals</h3>
                    <button class="btn btn-sm btn-outline" onclick="openGoalModal()">+ New Goal</button>
                </div>
                ${data.goals.length === 0 ? '<div class="text-sub text-sm">No goals yet.</div>' : data.goals.map(g => {
                    const pct = Math.min(100, (g.current / g.target) * 100);
                    return `
                    <div class="card" onclick="editGoal('${g.id}')">
                        <div class="flex justify-between text-sm bold mb-1">
                            <span>${g.name}</span>
                            <span class="privacy-blur">${fmt(g.current)} / ${fmt(g.target)}</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%; background:${pct>=100?'var(--success)':'var(--primary)'}"></div></div>
                    </div>`;
                }).join('')}
            `;
        }

        // --- SETTINGS ---
        function renderSettings(container) {
            container.innerHTML = `
                <h2 class="text-xl bold mb-4">Settings</h2>

                <div class="card" onclick="openCatManager()">
                    <div class="flex justify-between items-center">
                        <span class="bold">Manage Categories</span>
                        <span>‚Ä∫</span>
                    </div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <span class="bold">Recurring Items</span>
                        <button class="btn btn-sm btn-primary" onclick="openRecModal('add')">+ Add</button>
                    </div>
                    ${data.recurring.length === 0 ? '<div class="text-sub text-sm">No items yet.</div>' : 
                      data.recurring.map(r => `
                        <div class="flex justify-between items-center py-2" style="padding: 10px 0; border-bottom: 1px solid var(--card-border); cursor:pointer;" onclick="editRec('${r.id}')">
                            <div>
                                <div class="bold text-sm">${r.name}</div>
                                <div class="text-xs text-sub">${r.frequency} ‚Ä¢ ${r.date}</div>
                            </div>
                            <div class="bold text-sm privacy-blur">${fmt(r.amount)}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="card">
                    <div class="flex justify-between items-center mb-3">
                        <span class="bold">Currency Symbol</span>
                        <button class="btn btn-sm btn-outline" onclick="changeCurrency()">${data.settings.currency}</button>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="bold">App Lock (PIN)</span>
                        <button class="btn btn-sm ${data.settings.pin ? 'btn-danger' : 'btn-primary'}" onclick="setupPin()">${data.settings.pin ? 'Remove PIN' : 'Set PIN'}</button>
                    </div>
                </div>
                <h3 class="text-sm bold text-sub uppercase mb-2">Tools</h3>
                <div class="flex gap-2 mb-4">
                    <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('splitModal').classList.add('open')">üî¢ Split Bill</button>
                    <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('pasteModal').classList.add('open')">üìã Smart Import</button>
                </div>
                <button class="btn btn-outline w-full" onclick="exportCSV()">‚¨á Export CSV</button>
            `;
        }

        // --- LOGIC: TRANSACTIONS & TRANSFERS ---
        function switchView(view) { currentView = view; render(); }

        function openModal(mode, tx) {
            const m = document.getElementById('txModal');
            const accSel = document.getElementById('txAcc');
            const catSel = document.getElementById('txCatSelect');
            accSel.innerHTML = data.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            catSel.innerHTML = data.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('txFile').value = '';
            document.getElementById('txFilePreview').classList.add('hidden');
            document.getElementById('txFileBase64').value = '';

            if(mode === 'edit' && tx) {
                document.getElementById('txId').value = tx.id;
                document.getElementById('txAmount').value = tx.amount;
                document.getElementById('txDesc').value = tx.desc;
                document.getElementById('txDate').value = tx.date;
                accSel.value = tx.accId;
                catSel.value = tx.catId || (data.categories[0]?data.categories[0].id:'');
                setTxType(tx.type);
                document.getElementById('btnDelete').classList.remove('hidden');
            } else {
                document.getElementById('txId').value = '';
                document.getElementById('txAmount').value = '';
                document.getElementById('txDesc').value = '';
                document.getElementById('txDate').valueAsDate = new Date();
                setTxType('exp');
                document.getElementById('btnDelete').classList.add('hidden');
            }
            m.classList.add('open');
        }

        function saveTx() {
            const id = document.getElementById('txId').value;
            const amt = parseFloat(document.getElementById('txAmount').value);
            const desc = document.getElementById('txDesc').value;
            const acc = document.getElementById('txAcc').value;
            const cat = document.getElementById('txCatSelect').value;
            const file = document.getElementById('txFileBase64').value;
            const date = document.getElementById('txDate').value;

            if(!amt || !desc) return showAlert("Error", "Missing Amount or Description");

            const tx = { id: id || uid(), amount: amt, desc, accId: acc, catId: cat, date, type: txType, file };
            
            if(id) {
                const idx = data.transactions.findIndex(t => t.id === id);
                data.transactions[idx] = tx;
            } else {
                data.transactions.push(tx);
                const recId = document.getElementById('txRecurringId').value;
                if (recId) {
                    const rIdx = data.recurring.findIndex(r => eqId(r.id, recId));
                    if (rIdx > -1) {
                        const r = data.recurring[rIdx];
                        if (r.frequency === 'one-time') data.recurring.splice(rIdx, 1);
                        else {
                            r.date = getNextDate(r.date, r.frequency);
                            data.recurring[rIdx] = r;
                        }
                    }
                }
            }
            saveData();
            closeModal();
        }

        function setTxType(t) {
            txType = t;
            document.getElementById('btn-exp').style.background = t==='exp'?'var(--danger)':'transparent';
            document.getElementById('btn-exp').style.color = t==='exp'?'white':'var(--text-sub)';
            document.getElementById('btn-inc').style.background = t==='inc'?'var(--success)':'transparent';
            document.getElementById('btn-inc').style.color = t==='inc'?'white':'var(--text-sub)';
        }

        function editTx(id) { openModal('edit', data.transactions.find(t=>t.id===id)); }
        function deleteTxClick() {
            const id = document.getElementById('txId').value;
            openConfirm("Delete?", "Remove transaction?", () => {
                data.transactions = data.transactions.filter(t=>t.id!==id);
                saveData(); closeModal();
            });
        }

        function openTransferModal() {
            const modal = document.getElementById('transferModal');
            modal.classList.add('open');
            const opts = data.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            document.getElementById('tfFrom').innerHTML = opts;
            document.getElementById('tfTo').innerHTML = opts;
            document.getElementById('tfAmount').value = '';
            if(data.accounts.length > 1) document.getElementById('tfTo').selectedIndex = 1;
        }

        function executeTransfer() {
            const fromId = document.getElementById('tfFrom').value;
            const toId = document.getElementById('tfTo').value;
            const amount = parseFloat(document.getElementById('tfAmount').value);
            
            if(fromId === toId) return showAlert("Error", "Source and Destination cannot be the same.");
            if(!amount || amount <= 0) return showAlert("Error", "Invalid amount");
            
            const fromAcc = data.accounts.find(a => a.id === fromId).name;
            const toAcc = data.accounts.find(a => a.id === toId).name;
            const date = new Date().toISOString().slice(0, 10);
            
            // Outgoing
            data.transactions.push({ id: uid(), type: 'exp', amount: amount, desc: `Transfer to ${toAcc}`, date: date, accId: fromId, catId: '', file: null });
            // Incoming
            data.transactions.push({ id: uid(), type: 'inc', amount: amount, desc: `Transfer from ${fromAcc}`, date: date, accId: toId, catId: '', file: null });
            
            saveData();
            document.getElementById('transferModal').classList.remove('open');
        }

        // --- LOGIC: UTILS (Categories, Goals, Recurring, PIN, etc) ---
        function addAccount() {
            showPrompt("New Wallet", "Wallet Name", (name) => {
                if (name) { 
                    data.accounts.push({ id: uid(), name: name.trim(), initial: 0 }); 
                    saveData(); 
                }
            });
        }

        function openRecModal(mode) {
            document.getElementById('recModal').classList.add('open');
            document.getElementById('recId').value = '';
            document.getElementById('recName').value = '';
            document.getElementById('recAmount').value = '';
            document.getElementById('recDate').valueAsDate = new Date();
            document.getElementById('btnRecDelete').classList.add('hidden');
        }
        function editRec(id) {
            const r = data.recurring.find(x => x.id === id);
            if(r) {
                document.getElementById('recModal').classList.add('open');
                document.getElementById('recId').value = r.id;
                document.getElementById('recName').value = r.name;
                document.getElementById('recAmount').value = r.amount;
                document.getElementById('recDate').value = r.date;
                document.getElementById('recFreq').value = r.frequency;
                document.getElementById('recSkipUntil').value = r.skipUntil || '';
                document.getElementById('btnRecDelete').classList.remove('hidden');
            }
        }
        function saveRec() {
            const id = document.getElementById('recId').value;
            const name = document.getElementById('recName').value;
            const amount = parseFloat(document.getElementById('recAmount').value);
            const date = document.getElementById('recDate').value;
            const freq = document.getElementById('recFreq').value;
            const skip = document.getElementById('recSkipUntil').value;
            
            if(!name || !amount) return showAlert("Error", "Missing info");
            const r = { id: id||uid(), name, amount, date, frequency:freq, skipUntil:skip, type:'exp' };
            if(id) {
                const idx = data.recurring.findIndex(x=>x.id===id);
                data.recurring[idx] = r;
            } else data.recurring.push(r);
            saveData();
            closeRecModal();
        }
        function deleteRecClick() {
            const id = document.getElementById('recId').value;
            data.recurring = data.recurring.filter(r => r.id !== id);
            saveData(); closeRecModal();
        }
        function closeRecModal() { document.getElementById('recModal').classList.remove('open'); }
        function payRecurring(id) {
            const r = data.recurring.find(x => eqId(x.id, id));
            if (r) {
                openModal('add');
                document.getElementById('txAmount').value = safeNum(r.amount);
                document.getElementById('txDesc').value = r.name;
                document.getElementById('txRecurringId').value = r.id;
                setTxType(r.type || 'exp');
                document.getElementById('modalTitle').innerText = r.type === 'inc' ? 'Collect Recurring' : 'Pay Recurring';
            }
        }
        function skipRecurring(id) {
            const idx = data.recurring.findIndex(r => eqId(r.id, id));
            if (idx > -1) {
                const r = data.recurring[idx];
                r.date = getNextDate(r.date, r.frequency);
                data.recurring[idx] = r;
                saveData();
            }
        }

        function openCatManager() {
            document.getElementById('catModal').classList.add('open');
            renderCatListEdit();
        }
        function renderCatListEdit() {
            const list = document.getElementById('catListEdit');
            list.innerHTML = data.categories.map(c => `
                <div class="flex justify-between items-center mb-2" style="border-bottom:1px solid #eee; padding-bottom:5px;">
                    <div class="flex items-center gap-2">
                        <div style="width:16px; height:16px; background:${c.color}; border-radius:4px;"></div>
                        <span>${c.name}</span>
                    </div>
                    <button class="btn-ghost text-red" onclick="deleteCategory('${c.id}')">‚úï</button>
                </div>
            `).join('');
        }
        function addNewCategory() {
            const name = document.getElementById('newCatName').value;
            const color = document.getElementById('newCatColor').value;
            const budget = parseFloat(document.getElementById('newCatBudget').value) || 0;
            if(name) {
                data.categories.push({ id: uid(), name, color, budget });
                document.getElementById('newCatName').value = '';
                saveData();
                renderCatListEdit();
            }
        }
        function deleteCategory(id) {
            if(data.transactions.some(t => t.catId === id)) return showAlert("In Use", "Cannot delete category used in transactions.");
            data.categories = data.categories.filter(c => c.id !== id);
            saveData(); renderCatListEdit();
        }
        function closeCatModal() { document.getElementById('catModal').classList.remove('open'); render(); }

        // Goals
        function openGoalModal() {
            document.getElementById('goalId').value = '';
            document.getElementById('goalName').value = '';
            document.getElementById('goalTarget').value = '';
            document.getElementById('goalCurrent').value = '';
            document.getElementById('btnDelGoal').classList.add('hidden');
            document.getElementById('goalModal').classList.add('open');
        }
        function editGoal(id) {
            const g = data.goals.find(x => x.id === id);
            document.getElementById('goalId').value = g.id;
            document.getElementById('goalName').value = g.name;
            document.getElementById('goalTarget').value = g.target;
            document.getElementById('goalCurrent').value = g.current;
            document.getElementById('btnDelGoal').classList.remove('hidden');
            document.getElementById('goalModal').classList.add('open');
        }
        function saveGoal() {
            const id = document.getElementById('goalId').value;
            const name = document.getElementById('goalName').value;
            const target = parseFloat(document.getElementById('goalTarget').value);
            const current = parseFloat(document.getElementById('goalCurrent').value) || 0;
            if(!name || !target) return;
            const g = { id: id || uid(), name, target, current };
            if(id) {
                const idx = data.goals.findIndex(x=>x.id===id);
                data.goals[idx] = g;
            } else data.goals.push(g);
            saveData(); document.getElementById('goalModal').classList.remove('open');
        }
        function deleteGoal() {
            const id = document.getElementById('goalId').value;
            data.goals = data.goals.filter(g => g.id !== id);
            saveData(); document.getElementById('goalModal').classList.remove('open');
        }

        // Voice
        function startVoice() {
            if (!('webkitSpeechRecognition' in window)) return showAlert("Error", "Voice not supported in this browser");
            const recognition = new webkitSpeechRecognition();
            const status = document.getElementById('micStatus');
            status.classList.remove('hidden');
            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                document.getElementById('txDesc').value = text;
                const match = text.match(/(\d+)/);
                if(match) document.getElementById('txAmount').value = match[0];
                status.classList.add('hidden');
            };
            recognition.onerror = () => status.classList.add('hidden');
            recognition.start();
        }

        // File/Image Attachments
        function handleFileSelect(input) {
            const file = input.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = 300 / img.width; 
                        canvas.width = 300;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const compressed = canvas.toDataURL('image/jpeg', 0.5);
                        document.getElementById('txFileBase64').value = compressed;
                        document.getElementById('txFilePreview').style.backgroundImage = `url(${compressed})`;
                        document.getElementById('txFilePreview').classList.remove('hidden');
                    };
                };
                reader.readAsDataURL(file);
            }
        }

        // Privacy
        function togglePrivacy() {
            privacyMode = !privacyMode;
            render();
        }

        // PIN System
        let pinBuffer = '';
        function checkPinLock() {
            if(data.settings.pin) document.getElementById('pinLock').classList.remove('hidden', 'unlocked');
            else document.getElementById('pinLock').classList.add('hidden');
        }
        function enterPin(num) {
            if(num === 'del') pinBuffer = pinBuffer.slice(0, -1);
            else if(pinBuffer.length < 4) pinBuffer += num;
            
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((d, i) => {
                if(i < pinBuffer.length) d.classList.add('filled');
                else d.classList.remove('filled');
            });

            if(pinBuffer.length === 4) {
                if(pinBuffer === data.settings.pin) {
                    document.getElementById('pinLock').classList.add('unlocked');
                    pinBuffer = '';
                } else {
                    document.getElementById('pinLock').classList.add('shake');
                    pinBuffer = '';
                    dots.forEach(d => d.classList.remove('filled'));
                    alert('Wrong PIN'); 
                }
            }
        }
        function setupPin() {
            if(data.settings.pin) {
                openConfirm("Remove PIN?", "Anyone can access data.", () => {
                    data.settings.pin = null; saveData(); render();
                });
            } else {
                showPrompt("Set 4-digit PIN", "1234", (val) => {
                    if(val && val.length === 4 && !isNaN(val)) {
                        data.settings.pin = val; saveData(); render();
                        showAlert("Success", "PIN Set!");
                    } else showAlert("Error", "Must be 4 digits");
                });
            }
        }
        function forgotPin() {
            if(confirm("Factory Reset to bypass PIN? This deletes ALL data.")) {
                localStorage.removeItem('abouTiaData');
                location.reload();
            }
        }

        // Export
        function exportCSV() {
            let csv = "Date,Description,Type,Amount,Category,Account\n";
            data.transactions.forEach(t => {
                const cat = data.categories.find(c=>c.id===t.catId)?.name || 'Misc';
                const acc = data.accounts.find(a=>a.id===t.accId)?.name || 'Unknown';
                csv += `${t.date},"${t.desc}",${t.type},${t.amount},${cat},${acc}\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'finance_export.csv';
            a.click();
        }

        // Smart Paste
        function processPaste() {
            const text = document.getElementById('pasteArea').value;
            const lines = text.split('\n');
            let count = 0;
            const defAcc = data.accounts[0].id;
            const defCat = data.categories[0].id;
            const today = new Date().toISOString().slice(0, 10);
            
            lines.forEach(line => {
                const match = line.match(/(\d+(\.\d+)?)/);
                if(match) {
                    const amt = parseFloat(match[0]);
                    const desc = line.replace(match[0], '').trim() || 'Imported';
                    if(amt > 0) {
                        data.transactions.push({
                            id: uid(), amount: amt, desc, date: today,
                            accId: defAcc, catId: defCat, type: 'exp'
                        });
                        count++;
                    }
                }
            });
            saveData();
            document.getElementById('pasteModal').classList.remove('open');
            showAlert("Imported", `${count} transactions added.`);
        }
        
        function calcSplit() {
            const tot = parseFloat(document.getElementById('splitTotal').value) || 0;
            const ppl = parseInt(document.getElementById('splitCount').value) || 2;
            document.getElementById('splitResult').innerText = fmt(tot / ppl);
        }
        
        function changeCurrency() {
            showPrompt("Currency Symbol", "$ or ‚Ç¨ or EGP", (val) => {
                if(val) { data.settings.currency = val; saveData(); }
            });
        }

        // --- HELPERS ---
        function t(k) { return {dash:'Home',tx:'Transact',accs:'Wallets',set:'Settings'}[k]||k; }
        function fmt(n) { return (data.settings.currency || '$') + Number(n).toLocaleString(); }
        function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function safeNum(v) { return Number(v) || 0; }
        function eqId(a, b) { return String(a) === String(b); }
        function getAccBalance(id) {
            let b = Number(data.accounts.find(a=>a.id===id).initial||0);
            data.transactions.filter(t=>t.accId===id).forEach(t=> b += (t.type==='inc'?1:-1)*t.amount);
            return b;
        }
        function toggleTheme() { data.settings.theme = data.settings.theme==='light'?'dark':'light'; saveData(); applyTheme(); }
        function applyTheme() { document.body.classList.toggle('dark', data.settings.theme==='dark'); }
        
        // Date helpers for recurring logic
        function getNextDate(dateStr, freq) {
            const date = new Date(dateStr);
            const originalDay = date.getDate();
            if (freq === 'daily') date.setDate(date.getDate() + 1);
            else if (freq === 'weekly') date.setDate(date.getDate() + 7);
            else if (freq === 'monthly') {
                date.setMonth(date.getMonth() + 1);
                if (date.getDate() !== originalDay) date.setDate(0); 
            } 
            else if (freq === 'quarterly') date.setMonth(date.getMonth() + 3);
            else if (freq === '6months') date.setMonth(date.getMonth() + 6);
            else if (freq === 'yearly') date.setFullYear(date.getFullYear() + 1);
            return date.toISOString().split('T')[0];
        }

        function daysUntil(targetDate) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const t = new Date(targetDate);
            t.setHours(0,0,0,0);
            return Math.ceil((t - today) / (1000 * 60 * 60 * 24));
        }

        // Modals
        function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.classList.remove('open')); }
        function showAlert(t,m) { document.getElementById('msgTitle').innerText=t; document.getElementById('msgText').innerText=m; document.getElementById('msgModal').classList.add('open'); }
        function showPrompt(t,p,cb) { onPromptAction=cb; document.getElementById('promptTitle').innerText=t; document.getElementById('promptInput').placeholder=p; document.getElementById('promptInput').value=''; document.getElementById('promptModal').classList.add('open'); }
        document.getElementById('btnPromptOk').onclick=()=>{if(onPromptAction)onPromptAction(document.getElementById('promptInput').value); closeModal();}
        function openConfirm(t,m,cb) { onConfirmAction=cb; document.getElementById('confirmTitle').innerText=t; document.getElementById('confirmText').innerText=m; document.getElementById('confirmModal').classList.add('open'); }
        document.getElementById('btnConfirmDelete').onclick=()=>{if(onConfirmAction)onConfirmAction(); closeModal();}
        function setupModalBehavior() { document.querySelectorAll('.modal').forEach(m=>m.onclick=e=>{if(e.target===m)m.classList.remove('open')}); }

    </script>
</body>
</html>
