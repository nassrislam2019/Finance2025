<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</title>
<meta name="theme-color" content="#0b1220" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Dark Mode) */
:root{
  --bg:#0b1220;
  --card:#0f172a;
  --muted:#94a3b8;
  --txt:#e5e7eb;
  --brand:#0369a1;
  --brand-2:#0ea5e9;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#22c55e;
  --border:#1f2a44;
  --radius:12px;
  --field-h:42px;
  --shadow:0 8px 24px rgba(2, 6, 23, 0.4);
}

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ (Light Mode) */
html.light-mode{
  --bg:#f8fafc;
  --card:#ffffff;
  --muted:#64748b;
  --txt:#1e293b;
  --brand:#1d4ed8;
  --brand-2:#3b82f6;
  --danger:#dc2626;
  --warn:#f59e0b;
  --ok:#16a34a;
  --border:#e2e8f0;
  --shadow:0 8px 24px rgba(0, 0, 0, 0.1);
}

html.light-mode header{
  box-shadow:0 2px 4px rgba(0, 0, 0, 0.1);
}
html.light-mode input:focus, html.light-mode select:focus, html.light-mode textarea:focus{
  border-color:var(--brand);
}
html.light-mode body {
  color: var(--txt);
}
/* Ù†Ù‡Ø§ÙŠØ© ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ */

*{
  box-sizing:border-box;
}
html,body{
  margin:0;
  padding:0;
  background-color:var(--bg);
  color:var(--txt);
  font-family:'Cairo', sans-serif;
  font-size:16px;
  line-height:1.6;
}
header{
  background-color:var(--card);
  padding:1rem;
  box-shadow:var(--shadow);
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:1rem;
}
header h1{
  margin:0;
  font-size:1.5rem;
  color:var(--brand-2);
}
main{
  padding:0 1rem 1rem;
  max-width:1200px;
  margin:0 auto;
}
.card{
  background-color:var(--card);
  padding:1rem;
  border-radius:var(--radius);
  margin-bottom:1rem;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}
.card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  padding-bottom:0.5rem;
  margin-bottom:0.5rem;
  border-bottom:1px solid var(--border);
}
.card-header h2{
  margin:0;
  font-size:1.25rem;
  color:var(--brand-2);
}
.content{
  display:block;
  padding-top:0.5rem;
}
.content.hidden{
  display:none;
}
.grid{
  display:grid;
  gap:1rem;
}
@media (min-width: 768px) {
  .grid-2{
    grid-template-columns:1fr 1fr;
  }
  .grid-3{
    grid-template-columns:1fr 1fr 1fr;
  }
}
form{
  display:flex;
  flex-direction:column;
  gap:1rem;
}
.form-group{
  display:flex;
  flex-direction:column;
  gap:0.25rem;
}
label{
  color:var(--muted);
  font-size:0.9rem;
}
input[type="text"], input[type="number"], input[type="date"], input[type="month"], select, textarea{
  background-color:var(--bg);
  color:var(--txt);
  border:1px solid var(--border);
  padding:0 0.75rem;
  height:var(--field-h);
  border-radius:var(--radius);
  font-size:1rem;
  transition:border-color 0.2s;
  font-family:'Cairo', sans-serif;
}
textarea{
  height:auto;
  min-height:80px;
  padding:0.75rem;
}
input:focus, select:focus, textarea:focus{
  border-color:var(--brand-2);
  outline:none;
}
.btn{
  background-color:var(--brand);
  color:white;
  border:none;
  padding:0.75rem 1rem;
  border-radius:var(--radius);
  cursor:pointer;
  font-size:1rem;
  transition:background-color 0.2s;
  height:var(--field-h);
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:'Cairo', sans-serif;
}
.btn:hover{
  background-color:var(--brand-2);
}
.btn-danger{
  background-color:var(--danger);
}
.btn-danger:hover{
  background-color:#c81919;
}
.btn-warn{
  background-color:var(--warn);
}
.btn-warn:hover{
  background-color:#d4900a;
}
.btn-ok{
  background-color:var(--ok);
}
.btn-ok:hover{
  background-color:#1e9c4c;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:1rem;
  font-size:0.95rem;
}
th,td{
  padding:0.75rem;
  text-align:right;
  border-bottom:1px solid var(--border);
}
th{
  background-color:var(--bg);
  color:var(--brand-2);
  font-weight:bold;
  position:sticky;
  top:0;
}
tr:hover{
  background-color:rgba(255, 255, 255, 0.05);
}
.text-danger{
  color:var(--danger);
}
.text-ok{
  color:var(--ok);
}
.text-warn{
  color:var(--warn);
}
.badge{
  display:inline-block;
  padding:0.25rem 0.5rem;
  border-radius:9999px;
  font-size:0.8rem;
  margin-left:0.5rem;
}
.badge-danger{
  background-color:rgba(239, 68, 68, 0.2);
  color:var(--danger);
}
.badge-ok{
  background-color:rgba(34, 197, 94, 0.2);
  color:var(--ok);
}
.badge-warn{
  background-color:rgba(245, 158, 11, 0.2);
  color:var(--warn);
}
.nav{
  display:flex;
  border-bottom:2px solid var(--border);
  margin-bottom:1rem;
}
.nav-btn{
  padding:0.75rem 1.25rem;
  cursor:pointer;
  transition:background-color 0.2s, color 0.2s;
  color:var(--muted);
  border-bottom:2px solid transparent;
}
.nav-btn:hover{
  color:var(--txt);
}
.nav-btn.active{
  color:var(--brand-2);
  border-bottom-color:var(--brand-2);
  font-weight:bold;
}
.tab-content{
  display:none;
}
.tab-content.active{
  display:block;
}
.summary-box{
  background-color:var(--card);
  padding:1rem;
  border-radius:var(--radius);
  text-align:center;
  border:1px solid var(--border);
}
.summary-box h3{
  margin-top:0;
  font-size:1rem;
  color:var(--muted);
}
.summary-box p{
  margin-bottom:0;
  font-size:1.5rem;
  font-weight:bold;
}
.summary-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
  gap:1rem;
  margin-bottom:1rem;
}
ul{
  list-style:none;
  padding:0;
}
ul li{
  padding:0.5rem 0;
  border-bottom:1px solid var(--border);
}
ul li:last-child{
  border-bottom:none;
}
.actions button{
  margin-left:0.5rem;
}
.search-controls{
  display:flex;
  gap:1rem;
  align-items:center;
  margin-bottom:1rem;
}
.search-controls input[type="month"]{
  flex-grow:1;
}
.search-controls button{
  width:auto;
}
.collapsible-icon{
  transition:transform 0.3s;
}
.card.collapsed .collapsible-icon{
  transform:rotate(180deg);
}
.toggle-switch{
  position:relative;
  display:inline-block;
  width:50px;
  height:24px;
}
.toggle-switch input{
  opacity:0;
  width:0;
  height:0;
}
.slider{
  position:absolute;
  cursor:pointer;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background-color:var(--muted);
  transition:0.4s;
  border-radius:24px;
}
.slider:before{
  position:absolute;
  content:"";
  height:16px;
  width:16px;
  left:4px;
  bottom:4px;
  background-color:white;
  transition:0.4s;
  border-radius:50%;
}
input:checked + .slider{
  background-color:var(--brand-2);
}
input:checked + .slider:before{
  transform:translateX(26px);
}
.inline-toggle{
  display:flex;
  align-items:center;
  gap:1rem;
}
.no-data{
  text-align:center;
  color:var(--muted);
  padding:2rem 0;
}
</style>
</head>
<body>

<header>
  <h1>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</h1>
  <div style="display:flex; gap:10px;">
    <button id="btnThemeToggle" class="btn" style="width:auto; padding: 0.75rem 0.5rem; font-size:1.2rem; line-height:1;">ğŸŒ™</button>
    <button id="btnSettings" class="btn">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  </div>
</header>

<main>
  
  <div id="tabsContainer">
    <div class="nav">
      <div class="nav-btn active" data-tab="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      <div class="nav-btn" data-tab="transactions">Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
      <div class="nav-btn" data-tab="commitments">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</div> <div class="nav-btn" data-tab="collections">Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª</div> <div class="nav-btn" data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div> </div>

    <div id="tab-home" class="tab-content active">
      <div class="summary-grid">
        <div class="summary-box">
          <h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ</h3>
          <p id="totalBalance"></p>
        </div>
        <div class="summary-box">
          <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ (Ø§Ù„Ø´Ù‡Ø±)</h3>
          <p id="monthlyIncome" class="text-ok"></p>
        </div>
        <div class="summary-box">
          <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø§Ù„Ø´Ù‡Ø±)</h3>
          <p id="monthlyExpense" class="text-danger"></p>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card" id="cardDueSoon">
          <div class="card-header">
            <h2>Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© <span class="badge badge-warn" id="dueSoonCount">0</span></h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="content">
            <ul id="dueSoonList">
              <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹.</li>
            </ul>
          </div>
        </div>

        <div class="card" id="cardAccountsList">
          <div class="card-header">
            <h2>Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="content">
            <ul id="accountsList">
              </ul>
            <div class="actions" style="margin-top:1rem; text-align:left;">
              <button id="btnOpenAccountForm" class="btn">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-transactions" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content" id="transactionFormContent">
          <form id="transactionForm">
            <div class="grid grid-3">
              <div class="form-group">
                <label for="type">Ø§Ù„Ù†ÙˆØ¹</label>
                <select id="type" required>
                  <option value="Ø¯Ø®Ù„">Ø¯Ø®Ù„</option>
                  <option value="Ù…ØµØ±ÙˆÙ">Ù…ØµØ±ÙˆÙ</option>
                  <option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„</option>
                </select>
              </div>
              <div class="form-group" id="categoryGroup">
                <label for="category">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                <select id="category" required>
                  </select>
              </div>
              <div class="form-group">
                <label for="amount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="amount" required min="0.01" step="0.01">
              </div>
            </div>
            <div class="grid grid-2">
              <div class="form-group">
                <label for="accountFrom">Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„Ù…ØµØ¯Ø±)</label>
                <select id="accountFrom" required>
                  </select>
              </div>
              <div class="form-group" id="accountToGroup" style="display:none;">
                <label for="accountTo">Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„ÙˆØ¬Ù‡Ø©)</label>
                <select id="accountTo">
                  </select>
              </div>
            </div>
            <div class="form-group">
              <label for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="date" required>
            </div>
            <div class="form-group">
              <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
              <textarea id="notes"></textarea>
            </div>
            <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content">
          <div class="search-controls">
            <input type="month" id="monthPicker">
            <select id="filterAccount">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>
              </select>
            <button id="btnApplyFilter" class="btn">ØªØ·Ø¨ÙŠÙ‚</button>
          </div>
          <div style="overflow-x:auto;">
            <table id="transactionsTable">
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                  <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                <tr class="no-data-row" style="display:none;"><td colspan="7" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-commitments" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ²Ø§Ù… Ø´Ù‡Ø±ÙŠ Ø¬Ø¯ÙŠØ¯ (Ø¯ÙØ¹Ø§Øª ØµØ§Ø¯Ø±Ø©)</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content">
          <form id="commitmentForm">
            <div class="form-group">
              <label for="cName">Ø§Ø³Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</label>
              <input type="text" id="cName" required>
            </div>
            <div class="form-group inline-toggle">
              <label for="cRecurring">Ù…ØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠØ§Ù‹</label>
              <label class="toggle-switch">
                <input type="checkbox" id="cRecurring">
                <span class="slider"></span>
              </label>
            </div>
            <div class="grid grid-3">
              <div class="form-group">
                <label for="cAmount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="cAmount" required min="0.01" step="0.01">
              </div>
              <div class="form-group">
                <label for="cFirstDue">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„</label>
                <input type="date" id="cFirstDue" required>
              </div>
              <div class="form-group" id="cEndAtGroup" style="display:none;">
                <label for="cEndAt">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="date" id="cEndAt">
              </div>
            </div>
            <div class="form-group">
              <label for="cNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
              <textarea id="cNotes"></textarea>
            </div>
            <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</button>
          </form>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content">
          <ul id="commitmentsList">
            <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="tab-collections" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Ø¥Ø¶Ø§ÙØ© ØªØ¬Ù…ÙŠØ¹/Ø§Ù‚ØªØ·Ø§Ø¹ Ø´Ù‡Ø±ÙŠ Ø¬Ø¯ÙŠØ¯ (Ø¯ÙØ¹Ø§Øª ÙˆØ§Ø±Ø¯Ø©)</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content">
          <form id="collectionForm">
            <div class="form-group">
              <label for="coName">Ø§Ø³Ù… Ø§Ù„ØªØ¬Ù…ÙŠØ¹</label>
              <input type="text" id="coName" required>
            </div>
            <div class="form-group inline-toggle">
              <label for="coRecurring">Ù…ØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠØ§Ù‹</label>
              <label class="toggle-switch">
                <input type="checkbox" id="coRecurring">
                <span class="slider"></span>
              </label>
            </div>
            <div class="grid grid-3">
              <div class="form-group">
                <label for="coAmount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="coAmount" required min="0.01" step="0.01">
              </div>
              <div class="form-group">
                <label for="coFirstDue">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„</label>
                <input type="date" id="coFirstDue" required>
              </div>
              <div class="form-group" id="coEndAtGroup" style="display:none;">
                <label for="coEndAt">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="date" id="coEndAt">
              </div>
            </div>
            <div class="form-group">
              <label for="coNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
              <textarea id="coNotes"></textarea>
            </div>
            <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„ØªØ¬Ù…ÙŠØ¹</button>
          </form>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content">
          <ul id="collectionsList">
            <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="tab-reports" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
        </div>
        <div class="content">
          <div class="search-controls">
            <input type="month" id="reportMonthPicker">
            <button id="btnGenerateReport" class="btn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          </div>
          <div class="grid grid-2">
            <div>
              <canvas id="chartMonthly"></canvas>
            </div>
            <div>
              <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±</h3>
              <ul id="reportStatsList">
                </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2>Ù…Ù„Ø®Øµ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…ØµØ±ÙˆÙØ§Ù‹)</h2>
        </div>
        <div class="content">
          <ul id="categorySummaryList">
            </ul>
        </div>
      </div>
    </div>

  </div>

  <div id="accountModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100;">
    <div class="card" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:500px;">
      <div class="card-header">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
        <button id="closeAccountModal" class="btn btn-danger" style="height:30px; padding:0 0.5rem;">X</button>
      </div>
      <div class="content">
        <form id="accountForm">
          <div class="form-group">
            <label for="accountName">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <input type="text" id="accountName" required>
          </div>
          <div class="form-group">
            <label for="accountOpening">Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­</label>
            <input type="number" id="accountOpening" required min="0" step="0.01" value="0">
          </div>
          <button type="submit" class="btn">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨</button>
        </form>
        <h3 style="margin-top:1rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem; color:var(--muted);">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <ul id="manageAccountsList">
          </ul>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100;">
    <div class="card" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:500px;">
      <div class="card-header">
        <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h2>
        <button id="closeSettingsModal" class="btn btn-danger" style="height:30px; padding:0 0.5rem;">X</button>
      </div>
      <div class="content">
        <h3>Ù…Ø²Ø§Ù…Ù†Ø© GitHub Gist</h3>
        <p style="font-size:0.85rem; color:var(--muted);">Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø¹Ø¨Ø± GitHub Gist.</p>
        <form id="ghSyncForm">
          <div class="form-group">
            <label for="ghToken">Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ (Token)</label>
            <input type="text" id="ghToken" placeholder="ghp_..." required>
          </div>
          <div class="form-group">
            <label for="ghGistId">Ù…Ø¹Ø±Ù Gist (ID)</label>
            <input type="text" id="ghGistId" placeholder="ex: 123abc456def..." required>
          </div>
          <div class="grid grid-2">
            <button type="submit" id="btnSaveGhSettings" class="btn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button type="button" id="btnGhPush" class="btn btn-ok">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†</button>
          </div>
        </form>

        <h3 style="margin-top:1.5rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem; color:var(--muted);">Ø£Ø¯ÙˆØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
        <button id="btnExportData" class="btn btn-warn">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;">
        <button id="btnImportData" class="btn" style="margin-top:1rem;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
        <button id="btnClearData" class="btn btn-danger" style="margin-top:1rem;">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </div>
  </div>

</main>

<script>
// ======================================================================
// Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
// ======================================================================
const escapeHtml=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
const YM = (d=new Date())=>{
  const year=d.getFullYear();
  const month=String(d.getMonth()+1).padStart(2, '0');
  return `${year}-${month}`;
};
const startOfToday = () => {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  return d;
};
const parseLocalDate = (s) => {
  if (!s) return null;
  const parts = s.split('-').map(p => parseInt(p, 10));
  return new Date(parts[0], parts[1] - 1, parts[2]);
};
const formatLocalDate = (d) => {
  if (!d) return '';
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};
const addMonthsPreserveDOM = (dateStr, months) => {
  if (!dateStr) return '';
  const d = parseLocalDate(dateStr);
  if (!d) return dateStr;
  const dayOfMonth = d.getDate();
  d.setMonth(d.getMonth() + months);
  if (d.getDate() !== dayOfMonth) {
      d.setDate(0);
  }
  return formatLocalDate(d);
};
const daysBetween = (s1, s2) => {
  const d1 = parseLocalDate(s1);
  const d2 = parseLocalDate(s2);
  if (!d1 || !d2) return 0;
  const diffTime = Math.abs(d2.getTime() - d1.getTime());
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
};

// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ±Ø­ÙŠÙ„ Placeholder
const migrateCommit=(c)=>c;
const migrateCollect=(c)=>c;

const STORAGE_KEY='myFin';
const BASE_CATEGORIES = [
  {name: 'Ø±Ø§ØªØ¨', type: 'Ø¯Ø®Ù„'},
  {name: 'Ù‡Ø¯ÙŠØ©', type: 'Ø¯Ø®Ù„'},
  {name: 'ÙÙˆØ§ØªÙŠØ±', type: 'Ù…ØµØ±ÙˆÙ'},
  {name: 'Ø·Ø¹Ø§Ù…', type: 'Ù…ØµØ±ÙˆÙ'},
  {name: 'ØªØ³Ù„ÙŠØ©', type: 'Ù…ØµØ±ÙˆÙ'},
];

let transactions=[], accounts=[], categories=[], commitments=[], collections=[], settings={};
let currentMonth = YM();
let currentAccountFilter = '';

const els = {
  // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  totalBalance: document.getElementById('totalBalance'),
  monthlyIncome: document.getElementById('monthlyIncome'),
  monthlyExpense: document.getElementById('monthlyExpense'),
  transactionsTableBody: document.querySelector('#transactionsTable tbody'),
  monthPicker: document.getElementById('monthPicker'),
  reportMonthPicker: document.getElementById('reportMonthPicker'),
  
  // Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø­Ø±ÙƒØ§Øª
  transactionForm: document.getElementById('transactionForm'),
  type: document.getElementById('type'),
  category: document.getElementById('category'),
  amount: document.getElementById('amount'),
  accountFrom: document.getElementById('accountFrom'),
  accountTo: document.getElementById('accountTo'),
  accountToGroup: document.getElementById('accountToGroup'),
  date: document.getElementById('date'),

  // Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
  commitmentForm: document.getElementById('commitmentForm'),
  cRecurring: document.getElementById('cRecurring'),
  cEndAt: document.getElementById('cEndAt'),
  cEndAtGroup: document.getElementById('cEndAtGroup'),
  
  // Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª
  collectionForm: document.getElementById('collectionForm'),
  coRecurring: document.getElementById('coRecurring'),
  coEndAt: document.getElementById('coEndAt'),
  coEndAtGroup: document.getElementById('coEndAtGroup'),
  
  // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  settingsModal: document.getElementById('settingsModal'),
  btnSettings: document.getElementById('btnSettings'),
  closeSettingsModal: document.getElementById('closeSettingsModal'),
  ghSyncForm: document.getElementById('ghSyncForm'),
  ghToken: document.getElementById('ghToken'),
  ghGistId: document.getElementById('ghGistId'),
  btnGhPush: document.getElementById('btnGhPush'),
  btnThemeToggle: document.getElementById('btnThemeToggle'), // Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ
  
  // Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
  accountsList: document.getElementById('accountsList'),
  dueSoonList: document.getElementById('dueSoonList'),
  dueSoonCount: document.getElementById('dueSoonCount'),
  commitmentsList: document.getElementById('commitmentsList'),
  collectionsList: document.getElementById('collectionsList'),
  
  // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
  accountModal: document.getElementById('accountModal'),
  accountForm: document.getElementById('accountForm'),
  manageAccountsList: document.getElementById('manageAccountsList'),
};

// ======================================================================
// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† (Storage Functions)
// ======================================================================
function loadData(){
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  transactions = data.transactions || [];
  accounts = data.accounts || [];
  categories = data.categories || [];
  commitments = data.commitments || [];
  collections = data.collections || [];
  settings = data.settings || {};
}
function saveData(){
  const data = {transactions, accounts, categories, commitments, collections, settings};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function saveSettings(){ saveData(); } // ØªÙ… ØªÙˆØ­ÙŠØ¯ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­ÙØ¸

// ======================================================================
// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ (Formatting & Theme Functions)
// ======================================================================

function formatCurrency(amount){
  // ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ (EGP)
  return new Intl.NumberFormat('ar-EG', {style: 'currency', currency: 'EGP'}).format(amount);
}

function loadTheme() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    if (savedTheme === 'light') {
        document.documentElement.classList.add('light-mode');
        if (els.btnThemeToggle) els.btnThemeToggle.textContent = 'â˜€ï¸';
    } else {
        document.documentElement.classList.remove('light-mode');
        if (els.btnThemeToggle) els.btnThemeToggle.textContent = 'ğŸŒ™';
    }
}

function toggleTheme() {
    const isLight = document.documentElement.classList.toggle('light-mode');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    if (els.btnThemeToggle) {
        els.btnThemeToggle.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù„ÙˆØ§Ù†
    if (document.getElementById('tab-reports').classList.contains('active')) {
      drawMonthly();
    }
}

// ======================================================================
// Ø¯ÙˆØ§Ù„ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ (Business Logic)
// ======================================================================

function calculateAccountBalance(accountName){
  const account = accounts.find(a => a.name === accountName);
  if (!account) return 0;
  
  const initial = account.opening || 0;
  const balance = transactions
    .filter(t => t.account === accountName || t.accountTo === accountName)
    .reduce((sum, t) => {
      if (t.type === 'Ø¯Ø®Ù„' && t.account === accountName) return sum + t.amount;
      if (t.type === 'Ù…ØµØ±ÙˆÙ' && t.account === accountName) return sum - t.amount;
      if (t.type === 'ØªØ­ÙˆÙŠÙ„') {
        if (t.account === accountName) return sum - t.amount;
        if (t.accountTo === accountName) return sum + t.amount;
      }
      return sum;
    }, 0);

  return initial + balance;
}

function calculateTotalBalance(){
  return accounts.reduce((sum, a) => sum + calculateAccountBalance(a.name), 0);
}

function ensureBaseCategories(){
  BASE_CATEGORIES.forEach(baseCat => {
    if (!categories.find(c => c.name === baseCat.name && c.type === baseCat.type)) {
      categories.push(baseCat);
    }
  });
  saveData();
}

function ensureTransferCategories(){
  const transferCat = {name: 'ØªØ­ÙˆÙŠÙ„', type: 'Ù†Ø¸Ø§Ù…ÙŠ'};
  if (!categories.find(c => c.name === transferCat.name)) {
    categories.push(transferCat);
  }
  saveData();
}

function calculateMonthlySummary(month){
  const filtered = transactions.filter(t => t.date.startsWith(month));
  const income = filtered.filter(t => t.type === 'Ø¯Ø®Ù„').reduce((sum, t) => sum + t.amount, 0);
  const expense = filtered.filter(t => t.type === 'Ù…ØµØ±ÙˆÙ').reduce((sum, t) => sum + t.amount, 0);
  return {income, expense};
}

// ======================================================================
// Ø¯ÙˆØ§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UI/Rendering)
// ======================================================================

function refreshAccountSelects(){
  const accountOptions = accounts.map(a => `<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
  
  if(els.accountFrom) els.accountFrom.innerHTML = accountOptions;
  if(els.accountTo) els.accountTo.innerHTML = accountOptions;
  
  const filterOptions = `<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>` + accountOptions;
  if(els.filterAccount) els.filterAccount.innerHTML = filterOptions;
}

function refreshCategorySelect(){
  if(!els.type) return;
  const cats = categories.filter(c=>c.type===els.type.value);
  els.category.innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
}

function renderTransactions(month, accountName = ''){
  const filtered = transactions
    .filter(t => t.date.startsWith(month))
    .filter(t => !accountName || t.account === accountName || t.accountTo === accountName)
    .sort((a, b) => parseLocalDate(b.date).getTime() - parseLocalDate(a.date).getTime());
  
  if (filtered.length === 0) {
    els.transactionsTableBody.innerHTML = `<tr class="no-data-row"><td colspan="7" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>`;
    return;
  }
  
  const rows = filtered.map(t => {
    const amountClass = t.type === 'Ø¯Ø®Ù„' ? 'text-ok' : (t.type === 'Ù…ØµØ±ÙˆÙ' ? 'text-danger' : '');
    const accountDisplay = t.type === 'ØªØ­ÙˆÙŠÙ„' ? `${t.account} -> ${t.accountTo}` : t.account;
    const typeDisplay = t.type === 'ØªØ­ÙˆÙŠÙ„' ? 'ØªØ­ÙˆÙŠÙ„' : t.type;
    const amountSign = t.type === 'Ù…ØµØ±ÙˆÙ' ? '-' : (t.type === 'Ø¯Ø®Ù„' ? '+' : '');
    
    return `
      <tr>
        <td>${escapeHtml(t.date)}</td>
        <td>${escapeHtml(typeDisplay)}</td>
        <td>${escapeHtml(t.category)}</td>
        <td>${escapeHtml(accountDisplay)}</td>
        <td class="${amountClass}">${amountSign}${formatCurrency(t.amount)}</td>
        <td>${escapeHtml(t.notes || '')}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteTransaction('${t.id}')" style="height:30px; padding:0 0.5rem;">Ø­Ø°Ù</button></td>
      </tr>
    `;
  }).join('');
  
  els.transactionsTableBody.innerHTML = rows;
}

function renderSummary(month){
  const {income, expense} = calculateMonthlySummary(month);
  
  els.totalBalance.textContent = formatCurrency(calculateTotalBalance());
  els.monthlyIncome.textContent = formatCurrency(income);
  els.monthlyExpense.textContent = formatCurrency(expense);
}

function render(){
  renderSummary(currentMonth);
  renderTransactions(currentMonth, currentAccountFilter);
  drawAccountsList(); 
}

function drawAccountsList(){
    if(!els.accountsList) return;
    const listHtml = accounts.map(a=>`<li>${escapeHtml(a.name)}: ${formatCurrency(calculateAccountBalance(a.name))}</li>`).join('');
    els.accountsList.innerHTML = listHtml || '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</li>';
}
function drawCommitments(){
    if(!els.commitmentsList) return;
    els.commitmentsList.innerHTML = commitments.length ? commitments.map(c=>`<li>${escapeHtml(c.name)} - ${formatCurrency(c.amount)}</li>`).join('') : '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>';
}
function drawCollections(){
    if(!els.collectionsList) return;
    els.collectionsList.innerHTML = collections.length ? collections.map(c=>`<li>${escapeHtml(c.name)} - ${formatCurrency(c.amount)}</li>`).join('') : '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>';
}
function drawDueSoon(){
    if(!els.dueSoonList) return;
    // Ù…Ù†Ø·Ù‚ ÙˆÙ‡Ù…ÙŠ Ø¨Ø³ÙŠØ·
    els.dueSoonList.innerHTML = '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹.</li>';
    els.dueSoonCount.textContent = '0';
}
let monthlyChartInstance = null;
function drawMonthly(){
    if(monthlyChartInstance) monthlyChartInstance.destroy();
    const ctx = document.getElementById('chartMonthly').getContext('2d');
    
    // Ø­Ø³Ø§Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    const currentReportMonth = els.reportMonthPicker.value || YM();
    const {income, expense} = calculateMonthlySummary(currentReportMonth);

    const isLightMode = document.documentElement.classList.contains('light-mode');
    
    const data = {
        labels: [`Ø¯Ø®Ù„ (${formatCurrency(income)})`, [`Ù…ØµØ±ÙˆÙ (${formatCurrency(expense)})`]],
        datasets: [{
            label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº',
            data: [income, expense],
            backgroundColor: [isLightMode ? '#16a34a' : '#22c55e', isLightMode ? '#dc2626' : '#ef4444'],
            hoverOffset: 4
        }]
    };

    monthlyChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--txt'), // Ù„ÙˆÙ† Ø§Ù„Ù†Øµ
                        font: { family: 'Cairo, sans-serif' }
                    }
                },
                title: {
                    display: true,
                    text: `ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª (${currentReportMonth})`,
                    color: getComputedStyle(document.documentElement).getPropertyValue('--brand-2'),
                    font: { family: 'Cairo, sans-serif', size: 16 }
                }
            }
        }
    });
}
function drawCatsBadges(){} // Ø¯Ø§Ù„Ø© placeholder

// ======================================================================
// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Handlers)
// ======================================================================

function deleteTransaction(id){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')) return;
  transactions = transactions.filter(t => t.id !== id);
  saveData();
  render();
}

function handleTransactionTypeChange(e){
  const isTransfer = e.target.value === 'ØªØ­ÙˆÙŠÙ„';
  els.accountToGroup.style.display = isTransfer ? 'flex' : 'none';
  if(els.accountTo) els.accountTo.toggleAttribute('required', isTransfer);
  if(els.category) els.category.toggleAttribute('required', !isTransfer);
  if(els.categoryGroup) els.categoryGroup.style.display = isTransfer ? 'none' : 'flex';
  refreshCategorySelect();
}

function addTransaction(e){
  e.preventDefault();
  
  const type = els.type.value;
  const amount = parseFloat(els.amount.value);
  const date = els.date.value;
  const accountFrom = els.accountFrom.value;
  const notes = els.notes.value;
  
  if(amount <= 0 || !date) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ÙˆØªØ§Ø±ÙŠØ® ØµØ§Ù„Ø­ÙŠÙ†.');
    return;
  }
  
  if (type === 'ØªØ­ÙˆÙŠÙ„') {
    const accountTo = els.accountTo.value;
    if (accountFrom === accountTo) {
      alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† ÙˆØ¥Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨.');
      return;
    }
    
    // Ø§Ù„Ø­Ø±ÙƒØ© 1: Ù…ØµØ±ÙˆÙ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ¯Ø±
    transactions.push({
      id: Date.now() + '-out',
      type: 'Ù…ØµØ±ÙˆÙ',
      category: 'ØªØ­ÙˆÙŠÙ„',
      amount: amount,
      account: accountFrom,
      date: date,
      notes: `ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø± Ø¥Ù„Ù‰ ${accountTo}`
    });
    
    // Ø§Ù„Ø­Ø±ÙƒØ© 2: Ø¯Ø®Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆØ¬Ù‡Ø©
    transactions.push({
      id: Date.now() + '-in',
      type: 'Ø¯Ø®Ù„',
      category: 'ØªØ­ÙˆÙŠÙ„',
      amount: amount,
      account: accountTo,
      date: date,
      notes: `ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯ Ù…Ù† ${accountFrom}`
    });
    
  } else {
    // Ø¯Ø®Ù„ Ø£Ùˆ Ù…ØµØ±ÙˆÙ Ø¹Ø§Ø¯ÙŠ
    const category = els.category.value;
    if (!category) {
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªØµÙ†ÙŠÙ.');
      return;
    }
    
    transactions.push({
      id: Date.now().toString(),
      type: type,
      category: category,
      amount: amount,
      account: accountFrom,
      date: date,
      notes: notes
    });
  }
  
  saveData();
  e.target.reset();
  
  els.date.value = formatLocalDate(startOfToday());
  
  render();
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!');
}

function addCommitment(e){
  e.preventDefault();
  const name = document.getElementById('cName').value;
  const amount = parseFloat(document.getElementById('cAmount').value);
  const firstDueStr = document.getElementById('cFirstDue').value;
  const notes = document.getElementById('cNotes').value;
  const recurring = els.cRecurring.checked;
  const endAtStr = els.cEndAt.value;

  if (amount <= 0 || !firstDueStr) {
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ÙˆØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ­Ù‚Ø§Ù‚ ØµØ§Ù„Ø­ÙŠÙ†.');
      return;
  }
  
  if(recurring && endAtStr && parseLocalDate(endAtStr) < parseLocalDate(firstDueStr)){
    alert('ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„.');
    e.preventDefault();
    return;
  }

  commitments.push({
    id: Date.now().toString(),
    name, amount, firstDue: firstDueStr, notes, recurring, endAt: endAtStr || null
  });

  saveData();
  e.target.reset();
  drawCommitments();
  drawDueSoon();
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!');
}

function addCollection(e){
  e.preventDefault();
  const name = document.getElementById('coName').value;
  const amount = parseFloat(document.getElementById('coAmount').value);
  const firstDueStr = document.getElementById('coFirstDue').value;
  const notes = document.getElementById('coNotes').value;
  const recurring = els.coRecurring.checked;
  const endAtStr = els.coEndAt.value;

  if (amount <= 0 || !firstDueStr) {
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ÙˆØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ­Ù‚Ø§Ù‚ ØµØ§Ù„Ø­ÙŠÙ†.');
      return;
  }

  if(recurring && endAtStr && parseLocalDate(endAtStr) < parseLocalDate(firstDueStr)){
    alert('ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„.');
    e.preventDefault();
    return;
  }

  collections.push({
    id: Date.now().toString(),
    name, amount, firstDue: firstDueStr, notes, recurring, endAt: endAtStr || null
  });

  saveData();
  e.target.reset();
  drawCollections();
  drawDueSoon();
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!');
}

function handleMonthFilter(e){
  currentMonth = els.monthPicker.value;
  currentAccountFilter = els.filterAccount.value;
  render();
}

// ======================================================================
// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ (Initialization & Interaction)
// ======================================================================

function initCollapsibles(){
  document.querySelectorAll('.card-header').forEach(header => {
    header.addEventListener('click', () => {
      const card = header.closest('.card');
      card.classList.toggle('collapsed');
      const content = card.querySelector('.content');
      if (content) content.classList.toggle('hidden');
    });
  });
}

function initTabs(){
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tabId = e.target.dataset.tab;
      
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      e.target.classList.add('active');
      const targetContent = document.getElementById(`tab-${tabId}`);
      if (targetContent) targetContent.classList.add('active');
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
      if (tabId === 'reports') {
        const defaultReportMonth = YM();
        if(!els.reportMonthPicker.value) els.reportMonthPicker.value = defaultReportMonth;
        drawMonthly();
      }
    });
  });
}

// GitHub Sync (Placeholder functions)
function ghSaveSettings(e){
    e.preventDefault();
    settings.ghToken = els.ghToken.value;
    settings.ghGistId = els.ghGistId.value;
    saveSettings();
    alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub.');
}
function fillGhFormFromStorage(){
    els.ghToken.value = settings.ghToken || '';
    els.ghGistId.value = settings.ghGistId || '';
}
function ghPush(){
    alert('ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØºÙŠØ± Ù…ÙØ¹Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±.');
}

// ======================================================================
/* ===== ØªÙ‡ÙŠØ¦Ø© ===== */
function init(){
  loadTheme(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ Ø£ÙˆÙ„Ø§Ù‹
  loadData();
  
  if(accounts.length===0){
    accounts=[{name:'ÙƒØ§Ø´',opening:0},{name:'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ',opening:0},{name:'Ù…Ø­ÙØ¸Ø©',opening:0}];
    saveData();
  }
  ensureBaseCategories();
  initCollapsibles();
  initTabs();

  commitments=commitments.map(c=>migrateCommit(c));
  collections=collections.map(c=>migrateCollect(c));
  saveData();
  ensureTransferCategories();

  if(els.monthPicker){
    const today=YM();
    if(!els.monthPicker.value) els.monthPicker.value=today;
    els.monthPicker.setAttribute('max', today);
  }
  
  if(els.date) els.date.value = formatLocalDate(startOfToday());

  refreshAccountSelects(); refreshCategorySelect(); drawCatsBadges();
  drawCommitments(); drawCollections(); drawDueSoon(); render();
  fillGhFormFromStorage();
  
  els.cEndAt?.toggleAttribute('required', els.cRecurring?.checked);
  els.coEndAt?.toggleAttribute('required', els.coRecurring?.checked);
}

// ======================================================================
// Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª (Event Listeners)
// ======================================================================
document.addEventListener('DOMContentLoaded', init);

// Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ
els.btnThemeToggle?.addEventListener('click', toggleTheme);

// Ø­Ø±ÙƒØ§Øª
els.transactionForm.addEventListener('submit', addTransaction);
els.type.addEventListener('change', handleTransactionTypeChange);
els.type.addEventListener('change', refreshCategorySelect);
els.btnApplyFilter?.addEventListener('click', handleMonthFilter);

// Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
els.commitmentForm.addEventListener('submit', addCommitment);
els.cRecurring?.addEventListener('change', e => {
  els.cEndAtGroup.style.display = e.target.checked ? 'flex' : 'none';
  els.cEndAt?.toggleAttribute('required', e.target.checked);
});

// ØªØ¬Ù…ÙŠØ¹Ø§Øª
els.collectionForm.addEventListener('submit', addCollection);
els.coRecurring?.addEventListener('change', e => {
  els.coEndAtGroup.style.display = e.target.checked ? 'flex' : 'none';
  els.coEndAt?.toggleAttribute('required', e.target.checked);
});

// ØªÙ‚Ø§Ø±ÙŠØ±
els.btnGenerateReport?.addEventListener('click', drawMonthly);


// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Modal) - Placeholder
els.btnOpenAccountForm?.addEventListener('click', () => {
  els.accountModal.style.display = 'block';
});
els.closeAccountModal?.addEventListener('click', () => {
  els.accountModal.style.display = 'none';
});

// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Modal)
els.btnSettings?.addEventListener('click', () => {
  els.settingsModal.style.display = 'block';
});
els.closeSettingsModal?.addEventListener('click', () => {
  els.settingsModal.style.display = 'none';
});
els.ghSyncForm?.addEventListener('submit', ghSaveSettings);
els.btnGhPush?.addEventListener('click', ghPush);

</script>
</body>
</html>
