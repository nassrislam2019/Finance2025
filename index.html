<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساباتي — تتبُّع المصروفات والدخل</title>
<meta name="description" content="موقع شخصي بسيط لإدارة المصروفات والدخل — يعمل أوفلاين (PWA) ويحفظ البيانات محليًا." />
<meta name="theme-color" content="#ffffff" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<style>
:root{
  --bg:#ffffff; --card:#f2f2f2; --muted:#555; --txt:#000;
  --brand:#0077cc; --brand-2:#3399ff; --danger:#ef4444; --warn:#f59e0b; --ok:#22c55e; --border:#d0d0d0;
  --radius:14px; --field-h:46px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Kufi Arabic",Tahoma,Arial,sans-serif}
a{color:var(--brand);text-decoration:none}
.container{max-width:1180px;margin-inline:auto;padding:20px}

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:0;overflow:hidden}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
.card-head h3{margin:0;font-size:18px}
.card-body{padding:14px;border-top:1px solid var(--border)}
.card.collapsed .card-body{display:none}
.toggle{appearance:none;border:none;background:transparent;cursor:pointer;border-radius:10px;font-size:18px;padding:6px 10px;color:#333}

/* Layout */
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,textarea{width:100%;background:#fff;color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;height:var(--field-h)}
input[type="date"],input[type="month"]{direction:ltr;text-align:center;font-variant-numeric:tabular-nums}
.checkbox-row{display:flex;align-items:center;gap:8px}
.checkbox-row input[type="checkbox"]{width:18px;height:18px}

.btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:opacity .15s;height:var(--field-h)}
.btn:hover{opacity:.95}
.btn-primary{background:var(--brand);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--txt)}
.btn-danger{background:var(--danger);color:#fff}
.btn-muted{background:#e6e6e6;color:var(--muted);border:1px dashed var(--border)}

.stats{display:grid;gap:10px}
@media(min-width:720px){.stats{grid-template-columns:repeat(5,1fr)}}
.stat{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:12px}
.stat small{color:var(--muted)}
.stat .num{font-weight:800;font-size:22px;margin-top:4px}
.pos{color:var(--ok)}.neg{color:var(--danger)}

table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:right;padding:6px 10px}
tbody tr{background:#fff;border:1px solid var(--border);border-radius:var(--radius)}
tbody td{padding:12px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
tbody tr td:first-child{border-right:1px solid var(--border);border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
tbody tr td:last-child{border-left:1px solid var(--border);border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
.amount.exp{color:var(--danger);font-weight:700}.amount.inc{color:var(--ok);font-weight:700}

.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.spacer{flex:1}
.badge{display:inline-flex;gap:6px;align-items:center;background:#e6e6e6;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:var(--field-h)}
.footer{margin-top:24px;color:var(--muted);font-size:12px;text-align:center}
.note{color:var(--warn)}
canvas{background:#fff;border:1px solid var(--border);border-radius:var(--radius);display:block;width:100%;height:320px}
.hr{height:1px;background:var(--border);opacity:.7;margin:12px 0;border-radius:999px}
.list-plain{display:flex;flex-wrap:wrap;gap:8px}
.list-plain .item{background:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:12px}

/* تحويل */
.transfer-grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
.transfer-grid .full{grid-column:1/-1}
@media(max-width:900px){.transfer-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:720px){
  .grid-2{grid-template-columns:1fr}
  .grid-4{grid-template-columns:1fr 1fr}
  .badge{height:auto}
  .card-head h3{font-size:17px}
  .transfer-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <div class="title">دفتر حساباتي</div>
      <div class="sub">تتبُّع المصروفات والدخل — يعمل أوفلاين (PWA) والبيانات محفوظة محليًا</div>
    </div>
    <div class="toolbar">
      <button id="exportJson" class="btn btn-outline" type="button">تصدير JSON</button>
      <button id="exportCsv" class="btn btn-outline" type="button">تصدير CSV</button>
      <label class="btn btn-muted" for="importFile">استيراد JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
      <button id="syncNow" class="btn btn-outline" type="button">مزامنة الآن</button>
      <button id="installBtn" class="btn btn-outline" type="button" style="display:none">تثبيت التطبيق</button>
    </div>
  </header>

  <!-- (1) ملخص الحسابات -->
  <section class="card" id="card-balance" data-lock="true">
    <div class="card-head"><h3>ملخص الحسابات</h3></div>
    <div class="card-body">
      <div class="stats">
        <div class="stat"><small>إجمالي الأرصدة</small><div id="totalBalance" class="num">0</div></div>
        <div class="stat"><small>بعد التحصيلات والالتزامات</small><div id="balanceAfterCommit" class="num">0</div></div>
        <div class="stat"><small>دخل الشهر الجاري</small><div id="monthIncome" class="num pos">0</div></div>
        <div class="stat"><small>التزامات الشهر الجاري</small><div id="monthCommitTotal" class="num neg">0</div></div>
        <div class="stat"><small>عدد الحركات</small><div id="txCount" class="num">0</div></div>
      </div>
      <div class="hr"></div>
      <div>
        <h3 style="margin:0 0 8px;font-size:14px;color:var(--muted)">تفاصيل الأرصدة بالحساب</h3>
        <div id="perAccount" class="list-plain"></div>
      </div>
    </div>
  </section>

  <!-- كارت الاستحقاقات القريبة -->
  <section class="card" id="card-dueSoon" style="margin-top:12px">
    <div class="card-head">
      <h3>استحقاقات قريبة</h3>
      <!-- ✅ بادج إجمالي المتبقّي لهذا الشهر -->
      <span id="dueTotalBadge" class="badge" title="إجمالي المتبقّي لهذا الشهر">إجمالي: 0.00 ج.م</span>
    </div>
    <div class="card-body">
      <div id="dueSoonWrap" style="display:none">
        <table style="width:100%">
          <thead><tr>
            <th style="text-align:right">الاسم</th>
            <th style="text-align:right">التاريخ</th>
            <th style="text-align:right">الأصل</th>
            <th style="text-align:right">المدفوع</th>
            <th style="text-align:right">المتبقي</th>
            <th style="text-align:right">الحالة</th>
            <!-- ✅ عمود جديد للإجراءات -->
            <th style="text-align:right">إجراءات</th>
          </tr></thead>
          <tbody id="tbodyDueSoon"></tbody>
        </table>
      </div>
      <div id="noDueSoon" style="color:var(--muted)">لا توجد استحقاقات هذا الشهر غير مسددة.</div>
    </div>
  </section>

  <div class="hr"></div>

  <!-- (2) إدارة الحسابات + الفئات -->
  <div class="grid grid-2">
    <section class="card collapsed" id="card-accounts" data-collapsible>
      <div class="card-head"><h3>إدارة الحسابات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
      <div class="card-body">
        <div class="grid grid-3">
          <div><label>اسم الحساب</label><input id="newAccountName" placeholder="مثال: كاش/محفظة" /></div>
          <div><label>رصيد افتتاحي</label><input id="newAccountOpening" type="number" step="0.01" placeholder="0.00" /></div>
          <div><label>&nbsp;</label><button id="addAccount" class="btn btn-outline" style="width:100%">إضافة حساب</button></div>
        </div>
        <div id="accountsList" class="toolbar" style="margin-top:8px;flex-wrap:wrap"></div>
      </div>
    </section>

    <section class="card collapsed" id="card-cats" data-collapsible>
      <div class="card-head"><h3>إدارة الفئات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
      <div class="card-body">
        <div class="grid grid-3">
          <div><label>اسم الفئة</label><input id="newCatName" placeholder="مثال: أكل" /></div>
          <div><label>النوع</label><select id="newCatType"><option value="expense" selected>مصروف</option><option value="income">دخل</option></select></div>
          <div><label>&nbsp;</label><button id="addCategory" class="btn btn-outline" style="width:100%">إضافة فئة</button></div>
        </div>
        <div id="catsList" class="toolbar" style="margin-top:8px;flex-wrap:wrap"></div>
      </div>
    </section>
  </div>

  <div class="hr"></div>

  <!-- (2.5) تحويل بين الحسابات (مطوي افتراضيًا) -->
  <section class="card collapsed" id="card-transfer" data-collapsible>
    <div class="card-head"><h3>تحويل بين الحسابات</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="transfer-grid">
        <div><label>من حساب</label><select id="trFrom"></select></div>
        <div><label>إلى حساب</label><select id="trTo"></select></div>
        <div><label>المبلغ (ج.م)</label><input id="trAmount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>عمولة التحويل (اختياري)</label><input id="trFee" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>التاريخ</label><input id="trDate" type="date" /></div>
        <div><label>ملاحظة</label><input id="trDesc" type="text" placeholder="مثال: تحويل لمحفظة"/></div>
        <div class="full" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <button id="execTransfer" class="btn btn-primary">تنفيذ التحويل</button>
          <button id="resetTransfer" class="btn btn-outline">إفراغ</button>
        </div>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">ملاحظة: التحويلات لا تُحسب ضمن إجمالي الدخل/المصروف، لكن العمولة تُحسب كمصروف.</div>
    </div>
  </section>

  <div class="hr"></div>

  <!-- (3) إضافة حركة -->
  <section class="card collapsed" id="card-addtx" data-collapsible>
    <div class="card-head"><h3>إضافة حركة</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="grid grid-3">
        <div><label>النوع</label><select id="type"><option value="income">دخل</option><option value="expense" selected>مصروف</option></select></div>
        <div><label>المبلغ (ج.م)</label><input id="amount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>التاريخ</label><input id="date" type="date" /></div>
        <div><label>الوصف</label><input id="desc" type="text" placeholder="مثال: سوبر ماركت" /></div>
        <div><label>الحساب</label><select id="account"></select></div>
        <div><label>الفئة</label><select id="category"></select></div>
        <div><label>ربط الالتزام (اختياري لمصروفات)</label><select id="linkCommit"></select></div>
        <div class="grid grid-2" style="grid-column:1/-1">
          <button id="saveTx" class="btn btn-primary">حفظ</button>
          <button id="resetForm" class="btn btn-outline">إفراغ</button>
        </div>
      </div>
    </div>
  </section>
  <div class="hr"></div>

  <!-- (5) جدول الحركات -->
  <section class="card collapsed" id="card-txs" data-collapsible>
    <div class="card-head">
      <h3>الحركات</h3>
      <button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button>
    </div>
    <div class="card-body">
      <div class="toolbar" style="margin-bottom:8px">
        <input id="search" placeholder="بحث بالوصف" style="max-width:220px"/>
        <select id="fType" style="max-width:150px">
          <option value="all" selected>الكل</option>
          <option value="income">دخل فقط</option>
          <option value="expense">مصروف فقط</option>
        </select>
        <select id="fAccount" style="max-width:180px"></select>
        <input id="fFrom" type="date" />
        <input id="fTo" type="date" />
        <button id="clearFilters" class="btn btn-outline">مسح الفلاتر</button>
        <span class="spacer"></span>
        <span class="badge">العملة: ج.م</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>التاريخ</th>
              <th>الوصف</th>
              <th>الفئة</th>
              <th>الحساب</th>
              <th>المبلغ</th>
              <th>رصيد الحساب بعد العملية</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>
  
  <div class="hr"></div>

  <!-- (6) الالتزامات الشهرية -->
  <section class="card collapsed" id="card-commit" data-collapsible>
    <div class="card-head"><h3>الالتزامات الشهرية</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="grid grid-4">
        <div><label>اسم الالتزام</label><input id="cName" placeholder="مثال: إيجار، إنترنت" /></div>
        <div><label>المبلغ (ج.م)</label><input id="cAmount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>تاريخ أول استحقاق</label><input id="cFirstDue" type="date" required /></div>
        <div class="checkbox-row"><input id="cRecurring" type="checkbox" /><label for="cRecurring" style="margin:0">يتكرر شهريًا</label></div>
        <div style="grid-column:1/span 2"><label>ينتهي في (إجباري عند التكرار)</label><input id="cEndAt" type="date" /></div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button id="addCommitment" class="btn btn-outline">إضافة/تحديث</button>
        <span class="spacer"></span><span class="badge">يمكن السداد جزئيًا من "إضافة حركة"</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr>
            <th>الاسم</th><th>المبلغ</th><th>استحقاق</th><th>مدفوع (الشهر)</th><th>متبقّي</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th>
          </tr></thead>
          <tbody id="tbodyCommit"></tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <!-- (7) مبالغ تحت التحصيل -->
  <section class="card collapsed" id="card-collect" data-collapsible>
    <div class="card-head"><h3>مبالغ تحت التحصيل</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="grid grid-4">
        <div><label>اسم التحصيل</label><input id="coName" placeholder="مثال: إيجار مستلم، مبيعات آجل" /></div>
        <div><label>المبلغ (ج.م)</label><input id="coAmount" type="number" step="0.01" placeholder="0.00" /></div>
        <div><label>تاريخ أول استحقاق</label><input id="coFirstDue" type="date" required /></div>
        <div class="checkbox-row"><input id="coRecurring" type="checkbox" /><label for="coRecurring" style="margin:0">يتكرر شهريًا</label></div>
        <div style="grid-column:1/span 2"><label>ينتهي في (إجباري عند التكرار)</label><input id="coEndAt" type="date" /></div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button id="addCollect" class="btn btn-outline">إضافة/تحديث</button>
        <span class="spacer"></span><span class="badge">لا يظهر في الحركات إلا بعد "تم التحصيل"</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>الاسم</th><th>المبلغ</th><th>التحصيل القادم</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th></tr></thead>
          <tbody id="tbodyCollect"></tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <!-- (4) التقارير — نُقِل لأسفل قبل إعدادات GitHub -->
  <section class="card collapsed" id="card-reports" data-collapsible>
    <div class="card-head"><h3>تقارير شهرية و رسوم بيانية</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="toolbar" style="margin-bottom:8px">
        <input id="monthPicker" type="month" />
        <button id="refreshReports" class="btn btn-outline">تحديث</button>
        <span class="spacer"></span><span class="badge">إجمالي الدخل/المصروف لكل شهر</span>
      </div>
      <div class="grid grid-2">
        <div><canvas id="chartMonthly" width="560" height="320" aria-label="Monthly chart"></canvas></div>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>الشهر</th><th>إجمالي الدخل</th><th>إجمالي المصروف</th><th>الصافي</th></tr></thead>
            <tbody id="tbodyMonthly"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <!-- إعدادات GitHub (مطوي افتراضيًا) -->
  <section class="card collapsed" id="card-github" data-collapsible>
    <div class="card-head"><h3>إعدادات مزامنة GitHub</h3><button class="toggle" aria-expanded="false" title="عرض/إخفاء">▸</button></div>
    <div class="card-body">
      <div class="grid grid-4">
        <div><label>اسم المستخدم</label><input id="ghUser" placeholder="مثال: username" /></div>
        <div><label>المستودع</label><input id="ghRepo" placeholder="مثال: Finance2025" /></div>
        <div><label>الفرع</label><input id="ghBranch" value="main" /></div>
        <div><label>مسار الملف (JSON)</label><input id="ghPath" value="my-finance.json" /></div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <div><label>Personal Access Token</label><input id="ghToken" type="password" placeholder="ghp_..." /></div>
        <div class="checkbox-row" style="margin-top:22px"><input id="ghAuto" type="checkbox"/><label for="ghAuto" style="margin:0">مزامنة تلقائيًا بعد كل تعديل</label></div>
        <div class="grid grid-2" style="margin-top:22px">
          <button id="ghSaveCfg" class="btn btn-outline">حفظ الإعدادات</button>
          <button id="ghTest" class="btn btn-outline">اختبار الاتصال</button>
        </div>
      </div>
      <div class="grid grid-3" style="margin-top:8px">
        <button id="ghPull" class="btn btn-outline">تحميل من GitHub</button>
        <button id="ghPush" class="btn btn-primary">رفع إلى GitHub</button>
        <span id="ghStatus" class="badge">الحالة: غير متصل</span>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px">⚠️ الـ Token محفوظ محليًا في جهازك فقط.</div>
    </div>
  </section>

  <div class="footer">
    <div>⚠️ <span class="note">تنبيه:</span> كل البيانات محفوظة محليًا في <code>localStorage</code>. لا تنسَ التصدير كنسخة احتياطية.</div>
    <div style="margin-top:6px">تقدر تثبّت الموقع كتطبيق لأنه PWA.</div>
  </div>
</div>

<script>
/* ===== مفاتيح التخزين ===== */
const KEY='pf_ledger_v1',
      ACC_KEY='pf_accounts_v1',
      CAT_KEY='pf_categories_v1',
      COM_KEY='pf_commitments_v1',
      COL_KEY='pf_collections_v1',
      GH_KEY='pf_github_cfg_v1'; // إعدادات GitHub

/* ===== الحالة ===== */
let ledger=JSON.parse(localStorage.getItem(KEY)||'[]');          // معاملات
let accounts=JSON.parse(localStorage.getItem(ACC_KEY)||'[]');     // حسابات
let categories=JSON.parse(localStorage.getItem(CAT_KEY)||'[]');   // فئات
let commitments=JSON.parse(localStorage.getItem(COM_KEY)||'[]');  // التزامات {payments:{'YYYY-MM':number}}
let collections=JSON.parse(localStorage.getItem(COL_KEY)||'[]');  // تحصيل
let ghCfg=JSON.parse(localStorage.getItem(GH_KEY)||'{}');         // GitHub

/* افتراضات أولية */
if(accounts.length===0){ accounts=[{name:'كاش',opening:0},{name:'حساب بنكي',opening:0},{name:'محفظة',opening:0}]; saveAccounts(); }
function ensureBaseCategories(){
  const need=[
    {name:'التزامات شهرية',type:'expense'},
    {name:'تحصيلات شهرية',type:'income'},
    {name:'تحويل صادر',type:'expense'},
    {name:'تحويل وارد',type:'income'},
    {name:'عمولة تحويل',type:'expense'},
  ];
  let changed=false;
  if(categories.length===0){
    categories=[
      {name:'مرتب',type:'income'},{name:'دخل آخر',type:'income'},
      {name:'أكل وشرب',type:'expense'},{name:'مواصلات',type:'expense'},{name:'فواتير',type:'expense'},{name:'تسوق',type:'expense'}
    ];
    changed=true;
  }
  for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } }
  if(changed) saveCategories();
}
ensureBaseCategories();

/* DOM */
const $=s=>document.querySelector(s);
const els={
  totalBalance:$('#totalBalance'), balanceAfterCommit:$('#balanceAfterCommit'),
  monthCommitTotal:$('#monthCommitTotal'), monthIncome:$('#monthIncome'), txCount:$('#txCount'),
  perAccount:$('#perAccount'),
  tbody:$('#tbody'), type:$('#type'), amount:$('#amount'), date:$('#date'), desc:$('#desc'),
  account:$('#account'), category:$('#category'), linkCommit:$('#linkCommit'),
  saveTx:$('#saveTx'), resetForm:$('#resetForm'), search:$('#search'),
  exportJson:$('#exportJson'), exportCsv:$('#exportCsv'), importFile:$('#importFile'), syncNow:$('#syncNow'),
  newAccountName:$('#newAccountName'), newAccountOpening:$('#newAccountOpening'), addAccount:$('#addAccount'), accountsList:$('#accountsList'),
  newCatName:$('#newCatName'), newCatType:$('#newCatType'), addCategory:$('#addCategory'), catsList:$('#catsList'),
  monthPicker:$('#monthPicker'), refreshReports:$('#refreshReports'), tbodyMonthly:$('#tbodyMonthly'), chartMonthly:$('#chartMonthly'),
  /* التزامات */
  cName:$('#cName'), cAmount:$('#cAmount'), cFirstDue:$('#cFirstDue'), cRecurring:$('#cRecurring'), cEndAt:$('#cEndAt'),
  addCommitment:$('#addCommitment'), tbodyCommit:$('#tbodyCommit'),
  /* تحصيل */
  coName:$('#coName'), coAmount:$('#coAmount'), coFirstDue:$('#coFirstDue'), coRecurring:$('#coRecurring'), coEndAt:$('#coEndAt'),
  addCollect:$('#addCollect'), tbodyCollect:$('#tbodyCollect'),
  /* PWA & تحويل */
  installBtn:$('#installBtn'),
  trFrom:$('#trFrom'), trTo:$('#trTo'), trAmount:$('#trAmount'), trFee:$('#trFee'), trDate:$('#trDate'), trDesc:$('#trDesc'),
  execTransfer:$('#execTransfer'), resetTransfer:$('#resetTransfer'),
  /* GitHub */
  ghUser:$('#ghUser'), ghRepo:$('#ghRepo'), ghBranch:$('#ghBranch'), ghPath:$('#ghPath'), ghToken:$('#ghToken'),
  ghAuto:$('#ghAuto'), ghSaveCfg:$('#ghSaveCfg'), ghTest:$('#ghTest'), ghPull:$('#ghPull'), ghPush:$('#ghPush'), ghStatus:$('#ghStatus'),
  /* ✅ إجمالي الاستحقاقات */
  dueTotalBadge:$('#dueTotalBadge')
};
['saveTx','resetForm','addAccount','addCategory','exportJson','exportCsv','refreshReports','addCommitment','addCollect','execTransfer','resetTransfer','syncNow','ghSaveCfg','ghTest','ghPull','ghPush']
  .forEach(id=>document.getElementById(id)?.setAttribute('type','button'));

/* Utils */
const eid=()=>Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const fmt=n=>Number(n).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const escapeHtml=s=>String(s).replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
els.date.value=new Date().toISOString().slice(0,10);
els.trDate.value=new Date().toISOString().slice(0,10);
function formatLocalDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function parseLocalDate(str){const [y,m,d]=str.split('-').map(Number);const dt=new Date(y,m-1,d,0,0,0,0);dt.setHours(0,0,0,0);return dt;}
function startOfToday(){const t=new Date();t.setHours(0,0,0,0);return t;}
function addMonthsPreserveDOM(date,months){const d=new Date(date.getTime());const targetMonth=d.getMonth()+months;const day=d.getDate(),y=d.getFullYear();const temp=new Date(y,targetMonth+1,0);const lastDay=temp.getDate();d.setMonth(targetMonth,Math.min(day,lastDay));d.setHours(0,0,0,0);return d;}
function daysBetween(a,b){const MS=24*60*60*1000;const da=new Date(a.getFullYear(),a.getMonth(),a.getDate());const db=new Date(b.getFullYear(),b.getMonth(),b.getDate());return Math.round((db-da)/MS);}
const YM=()=>formatLocalDate(startOfToday()).slice(0,7);

/* ===== حفظ ===== */
function saveLedger(){ localStorage.setItem(KEY, JSON.stringify(ledger)); maybeAutoSync(); }
function saveAccounts(){ localStorage.setItem(ACC_KEY, JSON.stringify(accounts)); refreshAccountSelects(); drawAccountsBadges(); recalc(); maybeAutoSync(); }
function saveCategories(){ localStorage.setItem(CAT_KEY, JSON.stringify(categories)); refreshCategorySelect(); drawCatsBadges(); maybeAutoSync(); }
function saveCommitments(){ localStorage.setItem(COM_KEY, JSON.stringify(commitments)); drawCommitments(); drawDueSoon(); recalc(); maybeAutoSync(); }
function saveCollections(){ localStorage.setItem(COL_KEY, JSON.stringify(collections)); drawCollections(); recalc(); maybeAutoSync(); }

/* ===== القوائم ===== */
function buildAccountOptions(excludeName){
  return accounts.filter(a=>a.name!==excludeName).map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
}
function refreshAccountSelects(){
  const optsAll = accounts.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
  if(els.account) els.account.innerHTML = optsAll;
  const fA=document.getElementById('fAccount');
  if(fA) fA.innerHTML = `<option value="all" selected>كل الحسابات</option>` + optsAll;

  if(els.trFrom){
    const prevFrom = els.trFrom.value;
    els.trFrom.innerHTML = optsAll;
    els.trFrom.value = (prevFrom && accounts.some(a=>a.name===prevFrom)) ? prevFrom : (accounts[0]?.name || '');
  }
  if(els.trTo){
    const from = els.trFrom?.value || '';
    const prevTo = els.trTo.value;
    els.trTo.innerHTML = buildAccountOptions(from);
    if(prevTo && prevTo !== from && accounts.some(a=>a.name===prevTo)){
      els.trTo.value = prevTo;
    }else{
      els.trTo.selectedIndex = 0;
    }
  }
}

/* تعبئة قائمة ربط الالتزام (التزامات الشهر الحالي غير المسددة بالكامل) */
function refreshLinkCommitOptions(){
  if(!els.linkCommit) return;
  const ym=YM();
  const opts = commitments
    .filter(c=>{
      const due=(c.nextDue||c.firstDue||'').slice(0,7)===ym;
      const paid=(c.payments?.[ym]||0);
      return due && paid < Number(c.amount||0);
    })
    .map(c=>`<option value="${c.id}">${escapeHtml(c.name)} — أصل ${fmt(c.amount)} • مدفوع ${fmt(c.payments?.[ym]||0)} • متبقي ${fmt((c.amount)-(c.payments?.[ym]||0))}</option>`)
    .join('');
  els.linkCommit.innerHTML = `<option value="">— بدون —</option>` + opts;
}

/* ===== التحويل ===== */
function ensureTransferCategories(){
  const need=[{name:'تحويل صادر',type:'expense'},{name:'تحويل وارد',type:'income'},{name:'عمولة تحويل',type:'expense'}];
  let changed=false;
  for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } }
  if(changed) saveCategories();
}
function syncTransferSelects(trigger){
  if(trigger === 'from' && els.trTo){
    const from = els.trFrom.value;
    const prevTo = els.trTo.value;
    els.trTo.innerHTML = buildAccountOptions(from);
    if(prevTo && prevTo !== from && accounts.some(a=>a.name===prevTo)){
      els.trTo.value = prevTo;
    }else{
      els.trTo.selectedIndex = 0;
    }
  } else if(trigger === 'to' && els.trFrom){
    const to = els.trTo.value;
    const prevFrom = els.trFrom.value;
    els.trFrom.innerHTML = buildAccountOptions(to);
    if(prevFrom && prevFrom !== to && accounts.some(a=>a.name===prevFrom)){
      els.trFrom.value = prevFrom;
    }else{
      els.trFrom.selectedIndex = 0;
    }
  }
}

/* ===== حساب الأرصدة ===== */
function computeBalances(){
  const bal = new Map(accounts.map(a=>[a.name, a.opening||0]));
  const sorted=[...ledger].sort((a,b)=> a.date.localeCompare(b.date) || (a.id>b.id?1:-1));
  const after=new Map();
  for(const t of sorted){
    const cur=bal.get(t.account)??0;
    const delta=(t.type==='income'?t.amount:-t.amount);
    const next=cur+delta;
    bal.set(t.account,next);
    after.set(t.id,next);
  }
  return {bal,after};
}
function drawPerAccount(balMap){
  const items=[]; for(const a of accounts){const v=balMap.get(a.name)??a.opening??0; items.push(`<span class="item">${escapeHtml(a.name)} · <b>${fmt(v)} ج.م</b></span>`);}
  for(const [name,val] of balMap){ if(!accounts.some(a=>a.name===name)){ items.push(`<span class="item">⚠️ ${escapeHtml(name)} · <b>${fmt(val)} ج.م</b></span>`);} }
  if(els.perAccount) els.perAccount.innerHTML=items.join('');
}

/* ===== دفعات الالتزامات (مدفوع/متبقي لكل شهر) ===== */
function ensurePaymentsObj(c){ if(!c.payments) c.payments={}; }
function addCommitPayment(commitId, ym, amount){
  const c=commitments.find(x=>x.id===commitId); if(!c) return;
  ensurePaymentsObj(c);
  c.payments[ym]=(c.payments[ym]||0)+amount;
  const total=Number(c.amount||0);
  if(c.payments[ym] >= total - 1e-9){ // تم السداد الكامل للشهر
    const due=c.nextDue?parseLocalDate(c.nextDue):parseLocalDate(c.firstDue);
    if(c.recurring){
      const next=addMonthsPreserveDOM(due,1);
      if(c.endAt && next>parseLocalDate(c.endAt)){
        commitments=commitments.filter(xx=>xx.id!==commitId);
      }else{
        c.nextDue=formatLocalDate(next);
      }
    }else{
      commitments=commitments.filter(xx=>xx.id!==commitId);
    }
  }
  saveCommitments();
}

/* ===== إجماليات الشهر ===== */
function sumCurrentMonthCommitments(){
  const ym=YM();
  let total=0;
  for(const c of commitments){
    const dueStr=c.nextDue||c.firstDue; if(!dueStr) continue;
    if(dueStr.slice(0,7)!==ym) continue;
    const paid=(c.payments?.[ym]||0);
    const remain=(Number(c.amount||0)-paid);
    total += Math.max(remain,0);
  }
  return total;
}
function sumCurrentMonthCollections(){
  const ym=YM();
  let total=0;
  for(const c of collections){
    const dueStr=c.nextDue||c.firstDue; if(!dueStr) continue;
    if(dueStr.slice(0,7)!==ym) continue;
    total += Number(c.amount||0);
  }
  return total;
}
function sumCurrentMonthIncome(){
  const ym=YM();
  return ledger.filter(t=>!t.isTransfer && t.type==='income' && t.date.slice(0,7)===ym)
               .reduce((s,t)=>s+t.amount,0);
}

/* ===== إعادة الحساب + الملخص ===== */
function recalc(){
  const {bal}=computeBalances(); let total=0; for(const v of bal.values()) total+=v;

  const monthComRemain = sumCurrentMonthCommitments();
  const monthCol = sumCurrentMonthCollections();
  const monthInc = sumCurrentMonthIncome();
  const afterCom = total - monthComRemain + monthCol;

  if(els.totalBalance) els.totalBalance.textContent=fmt(total);
  if(els.monthCommitTotal) els.monthCommitTotal.textContent = '-'+fmt(monthComRemain);
  if(els.monthIncome) els.monthIncome.textContent = fmt(monthInc);
  if(els.balanceAfterCommit) els.balanceAfterCommit.textContent = fmt(afterCom);
  if(els.txCount) els.txCount.textContent=ledger.length.toString();

  drawAccountsBadges(bal); drawPerAccount(bal);
  refreshLinkCommitOptions();
}

/* ===== جدول الحركات (الأقدم -> الأحدث) ===== */
let editId=null;
function render(){
  const q=(els.search?.value||'').toLowerCase(),
        ft=document.getElementById('fType')?.value||'all',
        fa=document.getElementById('fAccount')?.value||'all',
        ff=document.getElementById('fFrom')?.value||'',
        fto=document.getElementById('fTo')?.value||'';
  const {after}=computeBalances();
  const rows=[...ledger].filter(t=>{
    if(q && !(t.desc||'').toLowerCase().includes(q)) return false;
    if(ft!=='all' && t.type!==ft) return false;
    if(fa!=='all' && t.account!==fa) return false;
    if(ff && t.date<ff) return false;
    if(fto && t.date>fto) return false;
    return true;
  }).sort((a,b)=> a.date.localeCompare(b.date) || (a.id>b.id?1:-1));

  if(els.tbody){
    els.tbody.innerHTML=rows.map(t=>{
      const cls=t.type==='income'?'inc':'exp'; const afterVal=after.has(t.id)?after.get(t.id):0;
      const tag = t.isTransfer ? ' <span style="font-size:11px;color:#666">↔︎ تحويل</span>' : '';
      return `<tr>
        <td>${t.date}</td><td>${escapeHtml(t.desc||'—')}${tag}</td><td>${escapeHtml(t.category||'—')}</td><td>${escapeHtml(t.account)}</td>
        <td class="amount ${cls}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
        <td>${fmt(afterVal)}</td>
        <td><button class="btn btn-outline" onclick="editTx('${t.id}')">تعديل</button>
            <button class="btn btn-danger" onclick="delTx('${t.id}')">حذف</button></td>
      </tr>`;
    }).join('');
  }
  recalc(); drawMonthly();
}
window.editTx=id=>{ const t=ledger.find(x=>x.id===id); if(!t) return;
  editId=id; els.saveTx.textContent='تحديث';
  els.type.value=t.type; refreshCategorySelect(); els.amount.value=t.amount; els.date.value=t.date; els.desc.value=t.desc||'';
  els.account.value=t.account; els.category.value=t.category||''; els.linkCommit.value=t.linkCommitId||'';
  window.scrollTo({top:0,behavior:'smooth'});
};
window.delTx=id=>{ if(!confirm('هل تريد حذف هذه الحركة؟')) return; const was=ledger.find(t=>t.id===id);
  ledger=ledger.filter(t=>t.id!==id); saveLedger();
  if(was && was.type==='expense' && was.linkCommitId){
    const ym=was.date.slice(0,7);
    const c=commitments.find(x=>x.id===was.linkCommitId);
    if(c && c.payments?.[ym]){ c.payments[ym]=Math.max(0,(c.payments[ym]-was.amount)); saveCommitments(); }
  }
  render();
};
els.saveTx?.addEventListener('click',()=>{
  const type=els.type.value, amount=parseFloat(els.amount.value), date=els.date.value,
        desc=els.desc.value.trim(), account=els.account.value, category=els.category.value, linkCommitId=els.linkCommit.value||'';
  if(!date || !account || !category || !amount || amount<=0){ alert('من فضلك أدخل بيانات صحيحة (تاريخ/حساب/فئة/مبلغ)'); return; }

  const tx={ id:editId||eid(), date, desc, type, amount, account:account.trim(), category:category.trim(), linkCommitId: (type==='expense' && linkCommitId)?linkCommitId:undefined };
  if(editId){ const i=ledger.findIndex(t=>t.id===editId); if(i>-1) ledger[i]=tx; editId=null; els.saveTx.textContent='حفظ'; }
  else { ledger.push(tx); }
  saveLedger();

  if(type==='expense' && tx.linkCommitId){
    addCommitPayment(tx.linkCommitId, tx.date.slice(0,7), tx.amount);
  }

  els.desc.value=''; els.amount.value=''; els.linkCommit.value='';
  render();
});
els.resetForm?.addEventListener('click',()=>{ editId=null; els.saveTx.textContent='حفظ'; els.type.value='expense'; els.amount.value=''; els.desc.value=''; els.linkCommit.value=''; refreshCategorySelect(); });

/* ===== فلاتر ===== */
els.search?.addEventListener('input',render);
['fType','fAccount','fFrom','fTo'].forEach(id=>document.getElementById(id)?.addEventListener('change',render));
document.getElementById('clearFilters')?.addEventListener('click',()=>{ els.search.value=''; document.getElementById('fType').value='all'; document.getElementById('fAccount').value='all'; document.getElementById('fFrom').value=''; document.getElementById('fTo').value=''; render(); });
els.type?.addEventListener('change', refreshCategorySelect);

/* ===== حسابات/فئات ===== */
function drawAccountsBadges(balMap){
  const bal = balMap || computeBalances().bal;
  if(!els.accountsList) return;
  els.accountsList.innerHTML = accounts.map((a,i)=>{
    const b = fmt(bal.get(a.name) ?? a.opening ?? 0);
    return `<span class="badge">${escapeHtml(a.name)} · <b>${b} ج.م</b>
      <button class="btn btn-muted" style="margin-inline-start:6px" onclick="renameAcc(${i})">تعديل</button>
      <button class="btn btn-muted" onclick="removeAcc(${i})">حذف</button></span>`;
  }).join('');
}
window.renameAcc=i=>{
  const cur=accounts[i]; if(!cur) return;
  const newName=prompt('اسم الحساب الجديد', cur.name); if(!newName) return;
  const openingStr=prompt('الرصيد الافتتاحي', cur.opening); const opening=parseFloat(openingStr);
  accounts[i].name=newName.trim(); if(Number.isFinite(opening)) accounts[i].opening=opening;
  for(const t of ledger){ if(t.account===cur.name){ t.account=accounts[i].name; } }
  saveLedger(); saveAccounts(); render();
};
window.removeAcc=i=>{ if(!confirm('سيتم حذف الحساب من القوائم (لن تُحذف الحركات القديمة). متابعة؟')) return; accounts.splice(i,1); saveAccounts(); render(); };
document.getElementById('addAccount')?.addEventListener('click',()=>{
  const name=els.newAccountName.value.trim(); const opening=parseFloat(els.newAccountOpening.value||'0');
  if(!name){ alert('ادخل اسم الحساب'); return; }
  accounts.push({name, opening:Number.isFinite(opening)?opening:0}); els.newAccountName.value=''; els.newAccountOpening.value=''; saveAccounts(); render();
});
function drawCatsBadges(){
  if(!els.catsList) return;
  els.catsList.innerHTML = categories.map((c,i)=>`<span class="badge">${escapeHtml(c.name)} · ${c.type==='income'?'دخل':'مصروف'}
    <button class="btn btn-muted" style="margin-inline-start:6px" onclick="renameCat(${i})">تعديل</button>
    <button class="btn btn-muted" onclick="removeCat(${i})">حذف</button></span>`).join('');
}
window.renameCat=i=>{
  const cur=categories[i]; if(!cur) return;
  const name=prompt('اسم الفئة', cur.name); if(!name) return;
  const type=prompt('النوع (income/expense)', cur.type); if(type!=='income'&&type!=='expense') return alert('نوع غير صحيح');
  categories[i]={name:name.trim(), type}; saveCategories(); render();
};
window.removeCat=i=>{ if(!confirm('هل تريد حذف هذه الفئة؟')) return; categories.splice(i,1); saveCategories(); render(); };
document.getElementById('addCategory')?.addEventListener('click',()=>{ const name=els.newCatName.value.trim(); const type=els.newCatType.value;
  if(!name){ alert('ادخل اسم الفئة'); return; } categories.push({name,type}); els.newCatName.value=''; saveCategories(); refreshCategorySelect(); render();
});

/* ===== تصدير/استيراد ===== */
document.getElementById('exportJson')?.addEventListener('click',()=>{ const data={ ledger, accounts, categories, commitments, collections, exportedAt:new Date().toISOString() }; download('my-finance-data.json', JSON.stringify(data,null,2)); });
document.getElementById('exportCsv')?.addEventListener('click',()=>{
  const header=['id','date','desc','type','amount','account','category'];
  const rows=[...ledger].sort((a,b)=> a.date.localeCompare(b.date) || (a.id>b.id?1:-1))
                        .map(t=>[t.id,t.date,escCsv(t.desc||''),t.type,t.amount,t.account,t.category]);
  const csv=[header.join(','), ...rows.map(r=>r.join(','))].join('\n');
  download('transactions.csv', csv);
});
function escCsv(s){ const need=/[",\n]/.test(String(s)); return need ? '"'+String(s).replace(/"/g,'""')+'"' : String(s); }
function download(name, content){ const blob=new Blob([content],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
document.getElementById('importFile')?.addEventListener('change', async (e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  try{
    const text=await file.text(); const data=JSON.parse(text);
    if(Array.isArray(data.ledger)) ledger=data.ledger;
    if(Array.isArray(data.accounts)) accounts=data.accounts;
    if(Array.isArray(data.categories)) categories=data.categories;
    if(Array.isArray(data.commitments)) commitments=data.commitments.map(c=>migrateCommit(c));
    if(Array.isArray(data.collections)) collections=data.collections.map(c=>migrateCollect(c));
    saveLedger(); saveAccounts(); saveCategories(); saveCommitments(); saveCollections();
    drawCommitments(); drawCollections(); drawDueSoon(); render();
    alert('تم الاستيراد بنجاح');
  }catch(err){ alert('خطأ أثناء الاستيراد: '+err.message); }
  e.target.value='';
});

/* ===== تقارير ===== */
function groupByMonth(){
  const map=new Map();
  for(const t of ledger){
    if(t.isTransfer) continue;
    const k=t.date.slice(0,7); const v=map.get(k)||{inc:0,exp:0};
    if(t.type==='income') v.inc+=t.amount; else v.exp+=t.amount; map.set(k,v);
  }
  const keys=[...map.keys()].sort();
  return keys.map(k=>({month:k,inc:map.get(k).inc,exp:map.get(k).exp,net:map.get(k).inc-map.get(k).exp}));
}
function drawMonthly(){
  const data=groupByMonth();
  if(els.tbodyMonthly) els.tbodyMonthly.innerHTML=data.map(d=>`<tr><td>${d.month}</td><td class="amount inc">+${fmt(d.inc)}</td><td class="amount exp">-${fmt(d.exp)}</td><td>${fmt(d.net)}</td></tr>`).join('');
  const cv=els.chartMonthly; if(!cv) return;
  const ctx=cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height);
  const pad=38,w=cv.width,h=cv.height,innerW=w-pad*2,innerH=h-pad*2;
  ctx.strokeStyle='#c7c7c7'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
  const maxVal=Math.max(1, ...data.map(d=>Math.max(d.inc,d.exp)));
  const barGroup=innerW/Math.max(1,data.length), barW=Math.max(8,(barGroup*0.7)/2);
  ctx.font='12px system-ui'; ctx.fillStyle='#777'; ctx.textAlign='center';
  data.forEach((d,i)=>{ const x0=pad+i*barGroup+barGroup/2;
    const incH=(d.inc/maxVal)*(innerH-10); ctx.fillStyle='#22c55e'; ctx.fillRect(x0-barW-3, h-pad-incH, barW, incH);
    const expH=(d.exp/maxVal)*(innerH-10); ctx.fillStyle='#ef4444'; ctx.fillRect(x0+3, h-pad-expH, barW, expH);
    ctx.fillStyle='#777'; ctx.fillText(d.month, x0, h-pad+16);
  });
}
els.refreshReports?.addEventListener('click', drawMonthly);

/* ==== الالتزامات ==== */
let editCommitId=null;
function migrateCommit(c){
  if(c.day && !c.firstDue){ const today=startOfToday(); const base=new Date(today.getFullYear(),today.getMonth(),Math.min(Math.max(1,c.day),28)); c.firstDue=formatLocalDate(base); c.nextDue=c.firstDue; delete c.day; }
  if(!c.nextDue && c.firstDue){ c.nextDue=c.firstDue; }
  if(typeof c.recurring!=='boolean') c.recurring=false;
  if(c.endAt===undefined) c.endAt=null;
  if(!c.payments) c.payments={};
  return c;
}
function drawCommitments(){
  if(!els.tbodyCommit) return;
  const ym=YM();
  const rows=[...commitments].sort((a,b)=>(a.nextDue||a.firstDue||'').localeCompare(b.nextDue||b.firstDue||''));
  els.tbodyCommit.innerHTML=rows.map(c=>{
    const recTxt=c.recurring?'شهري':'مرة واحدة';
    const endTxt=c.recurring && c.endAt?c.endAt:'—';
    const paid=(c.payments?.[ym]||0);
    const remain=Math.max(0,(Number(c.amount||0)-paid));
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${escapeHtml(c.nextDue||c.firstDue||'—')}</td>
      <td>${fmt(paid)}</td>
      <td>${fmt(remain)}</td>
      <td>${recTxt}</td>
      <td>${endTxt}</td>
      <td>
        <button class='btn btn-primary' onclick='payCommit("${c.id}")'>تم السداد (كامل)</button>
        <button class='btn btn-outline' onclick='editCommit("${c.id}")'>تعديل</button>
        <button class='btn btn-danger' onclick='delCommit("${c.id}")'>حذف</button>
      </td>
    </tr>`;
  }).join('');
}
function endRequiredToggle(){ els.cEndAt?.toggleAttribute('required', els.cRecurring?.checked); }
els.cRecurring?.addEventListener('change', endRequiredToggle);
window.editCommit=id=>{
  const c=commitments.find(x=>x.id===id); if(!c) return;
  editCommitId=id; els.cName.value=c.name; els.cAmount.value=c.amount; els.cFirstDue.value=c.firstDue||'';
  els.cRecurring.checked=!!c.recurring; els.cEndAt.value=c.endAt||''; els.addCommitment.textContent='تحديث الالتزام';
};
window.delCommit=id=>{ if(!confirm('هل تريد حذف هذا الالتزام؟')) return; commitments=commitments.filter(c=>c.id!==id); saveCommitments(); };
els.addCommitment?.addEventListener('click',()=>{
  const name=els.cName.value.trim(), amount=parseFloat(els.cAmount.value), firstDueStr=els.cFirstDue.value;
  const recurring=els.cRecurring.checked; const endAtStr=(els.cEndAt.value||'').trim();
  if(!name || !amount || amount<=0 || !firstDueStr){ alert('أدخل اسم + مبلغ صحيح + تاريخ أول استحقاق'); return; }
  if(recurring && !endAtStr){ alert('عند التكرار يجب تحديد تاريخ النهاية'); return; }
  if(recurring && endAtStr && parseLocalDate(endAtStr) < parseLocalDate(firstDueStr)){ alert('تاريخ النهاية يجب أن يكون بعد تاريخ أول استحقاق'); return; }

  let firstDue=parseLocalDate(firstDueStr), nextDue=parseLocalDate(firstDueStr);
  const today=startOfToday();
  while(nextDue<today){ const tryNext=addMonthsPreserveDOM(nextDue,1); if(recurring && (!endAtStr || tryNext<=parseLocalDate(endAtStr))) nextDue=tryNext; else break; }

  const commit={ id:editCommitId||eid(), name, amount,
    firstDue:formatLocalDate(firstDue), nextDue:formatLocalDate(nextDue),
    recurring, endAt:(recurring?(endAtStr||null):null), payments:{} };

  if(editCommitId){ const i=commitments.findIndex(c=>c.id===editCommitId); if(i>-1) commitments[i]=commit; editCommitId=null; els.addCommitment.textContent='إضافة/تحديث'; }
  else commitments.push(commit);

  els.cName.value=''; els.cAmount.value=''; els.cFirstDue.value=''; els.cRecurring.checked=false; els.cEndAt.value=''; endRequiredToggle();
  saveCommitments(); drawCommitments(); drawDueSoon();
});
function chooseAccount(){
  if(accounts.length===0){ alert('لا توجد حسابات لإتمام العملية'); return null; }
  const menu=accounts.map((a,i)=>`${i+1} - ${a.name}`).join('\n');
  const ans=prompt(`اختَر الحساب:\n${menu}`);
  if(ans===null) return null;
  const idx=parseInt(ans,10)-1; if(Number.isNaN(idx)||idx<0||idx>=accounts.length){ alert('اختيار غير صحيح'); return null; }
  return accounts[idx].name;
}
window.payCommit=id=>{
  const c=commitments.find(x=>x.id===id); if(!c) return;
  const due=c.nextDue?parseLocalDate(c.nextDue):parseLocalDate(c.firstDue);
  const dateStr=formatLocalDate(due);
  const ym=dateStr.slice(0,7);
  const paid=(c.payments?.[ym]||0);
  const remain=Math.max(0,(Number(c.amount||0)-paid));
  if(remain<=0){ alert('لا يوجد مبلغ متبقٍ لهذا الشهر.'); return; }
  const accName=chooseAccount(); if(!accName) return;
  if(!confirm(`سداد كامل متبقّي الالتزام "${c.name}" بقيمة ${fmt(remain)} ج.م من "${accName}" بتاريخ ${dateStr}؟`)) return;

  const tx={ id:eid(), date:dateStr, desc:`${c.name} (سداد التزام)`, type:'expense', amount:remain, account:accName, category:'التزامات شهرية', linkCommitId:c.id };
  ledger.push(tx); saveLedger();
  addCommitPayment(c.id, ym, remain);
  render(); drawDueSoon();
};

/* ==== التحصيل ==== */
let editCollectId=null;
function migrateCollect(c){
  if(c.day && !c.firstDue){ const today=startOfToday(); const base=new Date(today.getFullYear(),today.getMonth(),Math.min(Math.max(1,c.day),28)); c.firstDue=formatLocalDate(base); c.nextDue=c.firstDue; delete c.day; }
  if(!c.nextDue && c.firstDue){ c.nextDue=c.firstDue; }
  if(typeof c.recurring!=='boolean') c.recurring=false;
  if(c.endAt===undefined) c.endAt=null;
  return c;
}
function drawCollections(){
  if(!els.tbodyCollect) return;
  const rows=[...collections].sort((a,b)=>(a.nextDue||a.firstDue||'').localeCompare(b.nextDue||b.firstDue||''));
  els.tbodyCollect.innerHTML=rows.map(c=>{
    const recTxt=c.recurring?'شهري':'مرة واحدة';
    const endTxt=c.recurring && c.endAt?c.endAt:'—';
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${escapeHtml(c.nextDue||c.firstDue||'—')}</td>
      <td>${recTxt}</td>
      <td>${endTxt}</td>
      <td>
        <button class='btn btn-primary' onclick='collectNow("${c.id}")'>تم التحصيل</button>
        <button class='btn btn-outline' onclick='editCollect("${c.id}")'>تعديل</button>
        <button class='btn btn-danger' onclick='delCollect("${c.id}")'>حذف</button>
      </td>
    </tr>`;
  }).join('');
}
window.editCollect=id=>{
  const c=collections.find(x=>x.id===id); if(!c) return;
  editCollectId=id; els.coName.value=c.name; els.coAmount.value=c.amount; els.coFirstDue.value=c.firstDue||'';
  els.coRecurring.checked=!!c.recurring; els.coEndAt.value=c.endAt||''; els.addCollect.textContent='تحديث التحصيل';
};
window.delCollect=id=>{ if(!confirm('هل تريد حذف هذا التحصيل؟')) return; collections=collections.filter(c=>c.id!==id); saveCollections(); };
function endRequiredToggleCollect(){ els.coEndAt?.toggleAttribute('required', els.coRecurring?.checked); }
els.coRecurring?.addEventListener('change', endRequiredToggleCollect);

els.addCollect?.addEventListener('click',()=>{
  const name=els.coName.value.trim(), amount=parseFloat(els.coAmount.value), firstDueStr=els.coFirstDue.value;
  const recurring=els.coRecurring.checked; const endAtStr=(els.coEndAt.value||'').trim();
  if(!name || !amount || amount<=0 || !firstDueStr){ alert('أدخل اسم + مبلغ صحيح + تاريخ أول استحقاق'); return; }
  if(recurring && !endAtStr){ alert('عند التكرار يجب تحديد تاريخ النهاية'); return; }
  if(recurring && endAtStr && parseLocalDate(endAtStr) < parseLocalDate(firstDueStr)){ alert('تاريخ النهاية يجب أن يكون بعد تاريخ أول استحقاق'); return; }

  let firstDue=parseLocalDate(firstDueStr), nextDue=parseLocalDate(firstDueStr);
  const today=startOfToday();
  while(nextDue<today){ const tryNext=addMonthsPreserveDOM(nextDue,1); if(recurring && (!endAtStr || tryNext<=parseLocalDate(endAtStr))) nextDue=tryNext; else break; }

  const item={ id:editCollectId||eid(), name, amount,
    firstDue:formatLocalDate(firstDue), nextDue:formatLocalDate(nextDue),
    recurring, endAt:(recurring?(endAtStr||null):null) };

  if(editCollectId){ const i=collections.findIndex(c=>c.id===editCollectId); if(i>-1) collections[i]=item; editCollectId=null; els.addCollect.textContent='إضافة/تحديث'; }
  else collections.push(item);

  els.coName.value=''; els.coAmount.value=''; els.coFirstDue.value=''; els.coRecurring.checked=false; els.coEndAt.value=''; endRequiredToggleCollect();
  saveCollections(); drawCollections();
});
window.collectNow=id=>{
  const c=collections.find(x=>x.id===id); if(!c) return;
  const due=c.nextDue?parseLocalDate(c.nextDue):parseLocalDate(c.firstDue);
  const dateStr=formatLocalDate(due);
  const accName=chooseAccount(); if(!accName) return;
  if(!confirm(`تأكيد تحصيل "${c.name}" بمبلغ ${fmt(c.amount)} ج.م إلى حساب "${accName}" بتاريخ ${dateStr}؟`)) return;

  ledger.push({ id:eid(), date:dateStr, desc:`${c.name} (تحصيل)`, type:'income', amount:c.amount, account:accName, category:'تحصيلات شهرية' });
  saveLedger();

  if(c.recurring){
    const next=addMonthsPreserveDOM(due,1);
    if(c.endAt && next>parseLocalDate(c.endAt)){ collections=collections.filter(x=>x.id!==id); }
    else{ c.nextDue=formatLocalDate(next); }
  }else{
    collections=collections.filter(x=>x.id!==id);
  }
  saveCollections(); render();
};

/* ===== الاستحقاقات القريبة ===== */
function drawDueSoon(){
  const wrap=document.getElementById('dueSoonWrap'); const none=document.getElementById('noDueSoon'); const tbody=document.getElementById('tbodyDueSoon');
  if(!wrap||!tbody) return;
  const ym=YM();
  const today=startOfToday();
  const list=commitments.map(c=>{
    const dueStr=c.nextDue||c.firstDue; if(!dueStr) return null;
    if(dueStr.slice(0,7)!==ym) return null;
    const paid=(c.payments?.[ym]||0); const total=Number(c.amount||0); const remaining=Math.max(0,total-paid);
    if(remaining<=0) return null;
    const due=parseLocalDate(dueStr);
    const diff=daysBetween(today,due);
    return {...c,due,dueStr,paid,total,remaining,diff};
  }).filter(Boolean).sort((a,b)=> a.dueStr.localeCompare(b.dueStr));

  // ✅ تحديث إجمالي الاستحقاقات في البادج
  const totalRemain = list.reduce((s,x)=>s + x.remaining, 0);
  if(els.dueTotalBadge){
    els.dueTotalBadge.textContent = 'إجمالي: ' + fmt(totalRemain) + ' ج.م';
  }

  if(list.length===0){ wrap.style.display='none'; none.style.display='block'; tbody.innerHTML=''; return; }
  wrap.style.display='block'; none.style.display='none';
  tbody.innerHTML=list.map(x=>{
    const state = x.diff<0 ? `<span style="color:var(--danger);font-weight:700">متأخر ${Math.abs(x.diff)} يوم</span>`
                 : x.diff===0 ? `<span style="color:var(--warn);font-weight:700">اليوم</span>`
                 : `<span style="color:var(--warn);font-weight:700">متبقي ${x.diff} يوم</span>`;
    return `<tr>
      <td>${escapeHtml(x.name)}</td>
      <td>${x.dueStr}</td>
      <td>${fmt(x.total)}</td>
      <td>${fmt(x.paid)}</td>
      <td><b>${fmt(x.remaining)}</b></td>
      <td>${state}</td>
      <!-- ✅ زر سداد الآن -->
      <td><button class="btn btn-primary" onclick='payCommit("${x.id}")'>سداد الآن</button></td>
    </tr>`;
  }).join('');
}

/* ===== تحويل بين الحسابات ===== */
function doTransfer(){
  const from=els.trFrom.value, to=els.trTo.value,
        amount=parseFloat(els.trAmount.value||'0'),
        fee=parseFloat(els.trFee.value||'0')||0,
        date=els.trDate.value,
        note=(els.trDesc.value||'').trim();

  if(!from || !to || from===to){ alert('اختر حسابين مختلفين'); return; }
  if(!date || !amount || amount<=0){ alert('أدخل تاريخ ومبلغ صحيح'); return; }
  ensureTransferCategories();

  const link=eid();
  const descOut = note ? `تحويل إلى ${to} — ${note}` : `تحويل إلى ${to}`;
  const descIn  = note ? `تحويل من ${from} — ${note}` : `تحويل من ${from}`;

  ledger.push({ id:eid(), link, isTransfer:true, date, desc:descOut, type:'expense', amount:amount, account:from, category:'تحويل صادر' });
  ledger.push({ id:eid(), link, isTransfer:true, date, desc:descIn,  type:'income',  amount:amount, account:to,   category:'تحويل وارد' });
  if(fee>0){
    const descFee = note ? `عمولة تحويل — ${note}` : `عمولة تحويل`;
    ledger.push({ id:eid(), date, desc:descFee, type:'expense', amount:fee, account:from, category:'عمولة تحويل' });
  }

  saveLedger(); render();
  els.trAmount.value=''; els.trFee.value=''; els.trDesc.value='';
}
els.execTransfer?.addEventListener('click', doTransfer);
els.resetTransfer?.addEventListener('click', ()=>{ els.trAmount.value=''; els.trFee.value=''; els.trDesc.value=''; });
els.trFrom?.addEventListener('change', ()=>syncTransferSelects('from'));
els.trTo  ?.addEventListener('change', ()=>syncTransferSelects('to'));

/* ===== كروت الطي/الفتح ===== */
function initCollapsibles(){
  document.querySelectorAll('[data-collapsible]').forEach(sec=>{
    const btn=sec.querySelector('.toggle'); if(!btn) return;
    btn.addEventListener('click',()=>{
      const isCollapsed=sec.classList.toggle('collapsed');
      btn.textContent=isCollapsed?'▸':'▾'; btn.setAttribute('aria-expanded',String(!isCollapsed));
    });
    sec.classList.add('collapsed'); btn.textContent='▸'; btn.setAttribute('aria-expanded','false');
  });
}

/* ===== PWA: زر قبل التثبيت ===== */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; if(els.installBtn) els.installBtn.style.display='inline-flex'; });
els.installBtn?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; els.installBtn.disabled=true; await deferredPrompt.prompt(); deferredPrompt=null; els.installBtn.style.display='none'; });

/* ===== Service Worker ===== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('/my-finance/sw.js').catch(()=>{}); });
}

/* ===== GitHub Sync ===== */
function fillGhFormFromStorage(){
  if(!ghCfg) ghCfg={};
  if(els.ghUser)  els.ghUser.value  = ghCfg.user || '';
  if(els.ghRepo)  els.ghRepo.value  = ghCfg.repo || '';
  if(els.ghBranch)els.ghBranch.value= ghCfg.branch || 'main';
  if(els.ghPath)  els.ghPath.value  = ghCfg.path || 'my-finance.json';
  if(els.ghToken) els.ghToken.value = ghCfg.token || '';
  if(els.ghAuto)  els.ghAuto.checked= !!ghCfg.auto;
}
function readGhFormToCfg(){
  ghCfg={
    user:els.ghUser.value.trim(),
    repo:els.ghRepo.value.trim(),
    branch:els.ghBranch.value.trim()||'main',
    path:els.ghPath.value.trim()||'my-finance.json',
    token:els.ghToken.value.trim(),
    auto:!!els.ghAuto.checked
  };
  localStorage.setItem(GH_KEY, JSON.stringify(ghCfg));
}
function ghStatus(msg, ok){
  if(els.ghStatus){ els.ghStatus.textContent='الحالة: '+msg; els.ghStatus.style.color= ok?'#0a0':'#900'; }
}

/* GitHub REST (مباشر من المتصفح) */
async function gh_api(url, method='GET', body){
  const headers={'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28'};
  if(ghCfg.token) headers['Authorization']='Bearer '+ghCfg.token;
  if(body) headers['Content-Type']='application/json';
  const res=await fetch(url,{method,headers,body: body?JSON.stringify(body):undefined});
  if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  return res.json();
}
function currentPayload(){
  return { ledger, accounts, categories, commitments, collections, updatedAt:new Date().toISOString() };
}
async function ghGetFile(){
  const u=`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/contents/${ghCfg.path}?ref=${ghCfg.branch}`;
  try{ return await gh_api(u,'GET'); }catch(e){ return null; }
}
async function ghPutFile(contentObj, message){
  const u=`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/contents/${ghCfg.path}`;
  const text=JSON.stringify(contentObj,null,2);
  const b64=btoa(unescape(encodeURIComponent(text)));
  let sha=null;
  const existing=await ghGetFile();
  if(existing && existing.sha) sha=existing.sha;
  const body={message:message||'update data', content:b64, branch:ghCfg.branch};
  if(sha) body.sha=sha;
  return gh_api(u,'PUT', body);
}
async function ghTest(){
  readGhFormToCfg();
  if(!ghCfg.user||!ghCfg.repo||!ghCfg.token){ ghStatus('أكمل الإعدادات أولاً',false); return; }
  try{
    await gh_api(`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}`,'GET');
    ghStatus('الاتصال ناجح',true);
  }catch(e){ ghStatus('فشل الاتصال: '+e.message,false); }
}
async function ghPull(){
  readGhFormToCfg();
  try{
    const meta=await ghGetFile();
    if(!meta || !meta.content){ ghStatus('الملف غير موجود — ارفع أول مرة',false); return; }
    const text=decodeURIComponent(escape(atob(meta.content)));
    const data=JSON.parse(text);
    if(Array.isArray(data.ledger)) ledger=data.ledger;
    if(Array.isArray(data.accounts)) accounts=data.accounts;
    if(Array.isArray(data.categories)) categories=data.categories;
    if(Array.isArray(data.commitments)) commitments=data.commitments.map(migrateCommit);
    if(Array.isArray(data.collections)) collections=data.collections.map(migrateCollect);
    saveLedger(); saveAccounts(); saveCategories(); saveCommitments(); saveCollections();
    render(); drawDueSoon(); ghStatus('تم التحميل',true);
  }catch(e){ ghStatus('فشل التحميل: '+e.message,false); }
}
async function ghPush(){
  readGhFormToCfg();
  try{
    await ghPutFile(currentPayload(), 'sync: update finance data');
    ghStatus('تم الرفع',true);
  }catch(e){ ghStatus('فشل الرفع: '+e.message,false); }
}
function maybeAutoSync(){ if(ghCfg?.auto){ ghPush().catch(()=>{}); } }

/* ربط الأزرار */
els.ghSaveCfg?.addEventListener('click', ()=>{ readGhFormToCfg(); ghStatus('تم الحفظ',true); });
els.ghTest?.addEventListener('click', ghTest);
els.ghPull?.addEventListener('click', ghPull);
els.ghPush?.addEventListener('click', ghPush);
els.syncNow?.addEventListener('click', ghPush);

/* ===== تهيئة ===== */
function refreshCategorySelect(){
  const cats = categories.filter(c=>c.type===els.type.value);
  els.category.innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
}
function init(){
  initCollapsibles();
  commitments=commitments.map(c=>migrateCommit(c));
  collections=collections.map(c=>migrateCollect(c));
  saveCommitments(); saveCollections();
  ensureTransferCategories();
  refreshAccountSelects(); refreshCategorySelect(); drawCatsBadges();
  drawCommitments(); drawCollections(); drawDueSoon(); render();
  fillGhFormFromStorage();
  els.cEndAt?.toggleAttribute('required', els.cRecurring?.checked);
  els.coEndAt?.toggleAttribute('required', els.coRecurring?.checked);
  refreshLinkCommitOptions();
}
init();
</script>
</body>
</html>