<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</title>
<meta name="theme-color" content="#0b1220" />
<link rel="manifest" href="/my-finance/manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
/* (Ù†ÙØ³ CSS Ø§Ù„Ù…Ø¯Ù…Ø¬ Ù…Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚) */
:root{
  --bg:#0b1220;
  --card:#0f172a;
  --muted:#94a3b8;
  --txt:#e5e7eb;
  --brand:#0369a1;
  --brand-2:#0ea5e9;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#22c55e;
  --border:#1f2a44;
  --radius:12px;
  --field-h:42px;
  --shadow:0 8px 24px rgba(2, 6, 23, 0.4);
}
html.light-mode{
  --bg:#f8fafc;
  --card:#ffffff;
  --muted:#64748b;
  --txt:#1e293b;
  --brand:#1d4ed8;
  --brand-2:#3b82f6;
  --danger:#dc2626;
  --warn:#f59e0b;
  --ok:#16a34a;
  --border:#e2e8f0;
  --shadow:0 8px 24px rgba(0, 0, 0, 0.1);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background-color:var(--bg);color:var(--txt);font-family:'Cairo',sans-serif;font-size:16px;line-height:1.6}
header{background-color:var(--card);padding:1rem;box-shadow:var(--shadow);display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
header h1{margin:0;font-size:1.5rem;color:var(--brand-2)}
main{padding:0 1rem 1rem;max-width:1200px;margin:0 auto}
.card{background-color:var(--card);padding:1rem;border-radius:var(--radius);margin-bottom:1rem;box-shadow:var(--shadow);border:1px solid var(--border)}
.card-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding-bottom:0.5rem;margin-bottom:0.5rem;border-bottom:1px solid var(--border)}
.card-header h2{margin:0;font-size:1.25rem;color:var(--brand-2)}
.content{display:block;padding-top:0.5rem}
.content.hidden{display:none}
.grid{display:grid;gap:1rem}
@media (min-width: 768px) {.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}}
form{display:flex;flex-direction:column;gap:1rem}
.form-group{display:flex;flex-direction:column;gap:0.25rem}
label{color:var(--muted);font-size:0.9rem}
input[type="text"], input[type="number"], input[type="date"], input[type="month"], select, textarea{
  background-color:var(--bg);color:var(--txt);border:1px solid var(--border);padding:0 0.75rem;height:var(--field-h);border-radius:var(--radius);font-size:1rem;transition:border-color 0.2s;font-family:'Cairo',sans-serif;
}
textarea{height:auto;min-height:80px;padding:0.75rem}
input:focus, select:focus, textarea:focus{border-color:var(--brand-2);outline:none}
.btn{background-color:var(--brand);color:white;border:none;padding:0.75rem 1rem;border-radius:var(--radius);cursor:pointer;font-size:1rem;transition:background-color 0.2s;height:var(--field-h);display:flex;justify-content:center;align-items:center;font-family:'Cairo',sans-serif}
.btn:hover{background-color:var(--brand-2)}
.btn-danger{background-color:var(--danger)}.btn-danger:hover{background-color:#c81919}
.btn-warn{background-color:var(--warn)}.btn-warn:hover{background-color:#d4900a}
.btn-ok{background-color:var(--ok)}.btn-ok:hover{background-color:#1e9c4c}
table{width:100%;border-collapse:collapse;margin-top:1rem;font-size:0.95rem}
th,td{padding:0.75rem;text-align:right;border-bottom:1px solid var(--border)}
th{background-color:var(--bg);color:var(--brand-2);font-weight:bold;position:sticky;top:0}
tr:hover{background-color:rgba(255,255,255,0.03)}
.text-danger{color:var(--danger)}.text-ok{color:var(--ok)}.text-warn{color:var(--warn)}
.badge{display:inline-block;padding:0.25rem 0.5rem;border-radius:9999px;font-size:0.8rem;margin-left:0.5rem}
.badge-danger{background-color:rgba(239,68,68,0.2);color:var(--danger)}.badge-ok{background-color:rgba(34,197,94,0.2);color:var(--ok)}.badge-warn{background-color:rgba(245,158,11,0.2);color:var(--warn)}
.nav{display:flex;border-bottom:2px solid var(--border);margin-bottom:1rem}
.nav-btn{padding:0.75rem 1.25rem;cursor:pointer;transition:background-color 0.2s,color 0.2s;color:var(--muted);border-bottom:2px solid transparent}
.nav-btn:hover{color:var(--txt)}
.nav-btn.active{color:var(--brand-2);border-bottom-color:var(--brand-2);font-weight:bold}
.tab-content{display:none}.tab-content.active{display:block}
.summary-box{background-color:var(--card);padding:1rem;border-radius:var(--radius);text-align:center;border:1px solid var(--border)}
.summary-box h3{margin-top:0;font-size:1rem;color:var(--muted)}.summary-box p{margin-bottom:0;font-size:1.5rem;font-weight:bold}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1rem}
ul{list-style:none;padding:0}ul li{padding:0.5rem 0;border-bottom:1px solid var(--border)}ul li:last-child{border-bottom:none}
.actions button{margin-left:0.5rem}.search-controls{display:flex;gap:1rem;align-items:center;margin-bottom:1rem}
.search-controls input[type="month"]{flex-grow:1}.search-controls button{width:auto}
.collapsible-icon{transition:transform 0.3s}.card.collapsed .collapsible-icon{transform:rotate(180deg)}
.toggle-switch{position:relative;display:inline-block;width:50px;height:24px}.toggle-switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--muted);transition:0.4s;border-radius:24px}
.slider:before{position:absolute;content:"";height:16px;width:16px;left:4px;bottom:4px;background-color:white;transition:0.4s;border-radius:50%}
input:checked + .slider{background-color:var(--brand-2)}input:checked + .slider:before{transform:translateX(26px)}
.inline-toggle{display:flex;align-items:center;gap:1rem}.no-data{text-align:center;color:var(--muted);padding:2rem 0}
.modal{display:none}
</style>
</head>
<body>

<header>
  <h1>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</h1>
  <div style="display:flex; gap:10px;">
    <button id="btnThemeToggle" class="btn" style="width:auto; padding: 0.75rem 0.5rem; font-size:1.2rem; line-height:1;">ğŸŒ™</button>
    <button id="btnSettings" class="btn">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  </div>
</header>

<main>
  <div id="tabsContainer">
    <div class="nav">
      <div class="nav-btn active" data-tab="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
      <div class="nav-btn" data-tab="transactions">Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
      <div class="nav-btn" data-tab="commitments">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</div>
      <div class="nav-btn" data-tab="collections">Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª</div>
      <div class="nav-btn" data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    </div>

    <div id="tab-home" class="tab-content active">
      <div class="summary-grid">
        <div class="summary-box">
          <h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ</h3>
          <p id="totalBalance"></p>
        </div>
        <div class="summary-box">
          <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ (Ø§Ù„Ø´Ù‡Ø±)</h3>
          <p id="monthlyIncome" class="text-ok"></p>
        </div>
        <div class="summary-box">
          <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø§Ù„Ø´Ù‡Ø±)</h3>
          <p id="monthlyExpense" class="text-danger"></p>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card" id="cardDueSoon">
          <div class="card-header">
            <h2>Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© <span class="badge badge-warn" id="dueSoonCount">0</span></h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="content">
            <ul id="dueSoonList">
              <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹.</li>
            </ul>
          </div>
        </div>

        <div class="card" id="cardAccountsList">
          <div class="card-header">
            <h2>Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
            <span class="collapsible-icon">â–¼</span>
          </div>
          <div class="content">
            <ul id="accountsList"></ul>
            <div class="actions" style="margin-top:1rem; text-align:left;">
              <button id="btnOpenAccountForm" class="btn">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-transactions" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content" id="transactionFormContent">
          <form id="transactionForm">
            <div class="grid grid-3">
              <div class="form-group">
                <label for="type">Ø§Ù„Ù†ÙˆØ¹</label>
                <select id="type" required>
                  <option value="Ø¯Ø®Ù„">Ø¯Ø®Ù„</option>
                  <option value="Ù…ØµØ±ÙˆÙ">Ù…ØµØ±ÙˆÙ</option>
                  <option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„</option>
                </select>
              </div>
              <div class="form-group" id="categoryGroup">
                <label for="category">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                <select id="category" required></select>
              </div>
              <div class="form-group">
                <label for="amount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="amount" required min="0.01" step="0.01">
              </div>
            </div>
            <div class="grid grid-2">
              <div class="form-group">
                <label for="accountFrom">Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„Ù…ØµØ¯Ø±)</label>
                <select id="accountFrom" required></select>
              </div>
              <div class="form-group" id="accountToGroup" style="display:none;">
                <label for="accountTo">Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„ÙˆØ¬Ù‡Ø©)</label>
                <select id="accountTo"></select>
              </div>
            </div>
            <div class="form-group">
              <label for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="date" required>
            </div>
            <div class="form-group">
              <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
              <textarea id="notes"></textarea>
            </div>
            <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content">
          <div class="search-controls">
            <input type="month" id="monthPicker">
            <select id="filterAccount">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>
            </select>
            <button id="btnApplyFilter" class="btn">ØªØ·Ø¨ÙŠÙ‚</button>
          </div>
          <div style="overflow-x:auto;">
            <table id="transactionsTable">
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                  <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                <tr class="no-data-row" style="display:none;"><td colspan="7" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-commitments" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ²Ø§Ù… Ø´Ù‡Ø±ÙŠ Ø¬Ø¯ÙŠØ¯ (Ø¯ÙØ¹Ø§Øª ØµØ§Ø¯Ø±Ø©)</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content">
          <form id="commitmentForm">
            <div class="form-group">
              <label for="cName">Ø§Ø³Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</label>
              <input type="text" id="cName" required>
            </div>
            <div class="form-group inline-toggle">
              <label for="cRecurring">Ù…ØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠØ§Ù‹</label>
              <label class="toggle-switch">
                <input type="checkbox" id="cRecurring">
                <span class="slider"></span>
              </label>
            </div>
            <div class="grid grid-3">
              <div class="form-group">
                <label for="cAmount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="cAmount" required min="0.01" step="0.01">
              </div>
              <div class="form-group">
                <label for="cFirstDue">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„</label>
                <input type="date" id="cFirstDue" required>
              </div>
              <div class="form-group" id="cEndAtGroup" style="display:none;">
                <label for="cEndAt">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="date" id="cEndAt">
              </div>
            </div>
            <div class="form-group">
              <label for="cNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
              <textarea id="cNotes"></textarea>
            </div>
            <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</button>
          </form>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content">
          <ul id="commitmentsList">
            <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="tab-collections" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Ø¥Ø¶Ø§ÙØ© ØªØ¬Ù…ÙŠØ¹/Ø§Ù‚ØªØ·Ø§Ø¹ Ø´Ù‡Ø±ÙŠ Ø¬Ø¯ÙŠØ¯ (Ø¯ÙØ¹Ø§Øª ÙˆØ§Ø±Ø¯Ø©)</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content">
          <form id="collectionForm">
            <div class="form-group">
              <label for="coName">Ø§Ø³Ù… Ø§Ù„ØªØ¬Ù…ÙŠØ¹</label>
              <input type="text" id="coName" required>
            </div>
            <div class="form-group inline-toggle">
              <label for="coRecurring">Ù…ØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠØ§Ù‹</label>
              <label class="toggle-switch">
                <input type="checkbox" id="coRecurring">
                <span class="slider"></span>
              </label>
            </div>
            <div class="grid grid-3">
              <div class="form-group">
                <label for="coAmount">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                <input type="number" id="coAmount" required min="0.01" step="0.01">
              </div>
              <div class="form-group">
                <label for="coFirstDue">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„</label>
                <input type="date" id="coFirstDue" required>
              </div>
              <div class="form-group" id="coEndAtGroup" style="display:none;">
                <label for="coEndAt">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="date" id="coEndAt">
              </div>
            </div>
            <div class="form-group">
              <label for="coNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
              <textarea id="coNotes"></textarea>
            </div>
            <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„ØªØ¬Ù…ÙŠØ¹</button>
          </form>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h2>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="content">
          <ul id="collectionsList">
            <li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="tab-reports" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
        </div>
        <div class="content">
          <div class="search-controls">
            <input type="month" id="reportMonthPicker">
            <button id="btnGenerateReport" class="btn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          </div>
          <div class="grid grid-2">
            <div>
              <canvas id="chartMonthly"></canvas>
            </div>
            <div>
              <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±</h3>
              <ul id="reportStatsList"></ul>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2>Ù…Ù„Ø®Øµ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…ØµØ±ÙˆÙØ§Ù‹)</h2>
        </div>
        <div class="content">
          <ul id="categorySummaryList"></ul>
        </div>
      </div>
    </div>

  </div>

  <div id="accountModal" class="modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100;">
    <div class="card" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:500px;">
      <div class="card-header">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
        <button id="closeAccountModal" class="btn btn-danger" style="height:30px; padding:0 0.5rem;">X</button>
      </div>
      <div class="content">
        <form id="accountForm">
          <div class="form-group">
            <label for="accountName">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <input type="text" id="accountName" required>
          </div>
          <div class="form-group">
            <label for="accountOpening">Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­</label>
            <input type="number" id="accountOpening" required min="0" step="0.01" value="0">
          </div>
          <button type="submit" class="btn">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨</button>
        </form>
        <h3 style="margin-top:1rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem; color:var(--muted);">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <ul id="manageAccountsList"></ul>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100;">
    <div class="card" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:500px;">
      <div class="card-header">
        <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h2>
        <button id="closeSettingsModal" class="btn btn-danger" style="height:30px; padding:0 0.5rem;">X</button>
      </div>
      <div class="content">
        <h3>Ù…Ø²Ø§Ù…Ù†Ø© GitHub Gist</h3>
        <p style="font-size:0.85rem; color:var(--muted);">Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø¹Ø¨Ø± GitHub Gist. Ø£Ø¨Ù‚ÙŠ Token Ø³Ø±ÙŠÙ‹Ø§.</p>
        <form id="ghSyncForm">
          <div class="form-group">
            <label for="ghToken">Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø´Ø®ØµÙŠ (Token)</label>
            <input type="text" id="ghToken" placeholder="ghp_..." required>
          </div>
          <div class="form-group">
            <label for="ghGistId">Ù…Ø¹Ø±Ù Gist (ID) â€” Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ø¥Ù†Ø´Ø§Ø¡ Gist Ø¬Ø¯ÙŠØ¯</label>
            <input type="text" id="ghGistId" placeholder="ex: 123abc456def...">
          </div>
          <div class="grid grid-2">
            <button type="submit" id="btnSaveGhSettings" class="btn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button type="button" id="btnGhPush" class="btn btn-ok">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†</button>
            <button type="button" id="btnGhPull" class="btn" style="margin-left:8px">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Gist</button>
          </div>
        </form>

        <h3 style="margin-top:1.5rem; border-bottom:1px solid var(--border); padding-bottom:0.5rem; color:var(--muted);">Ø£Ø¯ÙˆØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
        <button id="btnExportData" class="btn btn-warn">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;">
        <button id="btnImportData" class="btn" style="margin-top:1rem;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
        <button id="btnClearData" class="btn btn-danger" style="margin-top:1rem;">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </div>
  </div>

</main>

<script>
// ==================== Utilities ====================
const escapeHtml=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
const YM=(d=new Date())=>{const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0');return `${y}-${m}`};
const startOfToday=()=>{const d=new Date();d.setHours(0,0,0,0);return d;};
const parseLocalDate=(s)=>{ if(!s) return null; const parts=s.split('-').map(n=>parseInt(n,10)); return new Date(parts[0],parts[1]-1,parts[2]||1); };
const formatLocalDate=(d)=>{ if(!d) return ''; const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; };

// ==================== Storage & State ====================
const STORAGE_KEY='myFin';
let transactions=[], accounts=[], categories=[], commitments=[], collections=[], settings={};
let currentMonth=YM(), currentAccountFilter='';
const BASE_CATEGORIES=[{name:'Ø±Ø§ØªØ¨',type:'Ø¯Ø®Ù„'},{name:'Ù‡Ø¯ÙŠØ©',type:'Ø¯Ø®Ù„'},{name:'ÙÙˆØ§ØªÙŠØ±',type:'Ù…ØµØ±ÙˆÙ'},{name:'Ø·Ø¹Ø§Ù…',type:'Ù…ØµØ±ÙˆÙ'},{name:'ØªØ³Ù„ÙŠØ©',type:'Ù…ØµØ±ÙˆÙ'}];

// ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù† Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©/ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙˆØµÙˆÙ„
const els = {
  totalBalance: document.getElementById('totalBalance'),
  monthlyIncome: document.getElementById('monthlyIncome'),
  monthlyExpense: document.getElementById('monthlyExpense'),
  transactionsTableBody: document.querySelector('#transactionsTable tbody'),
  monthPicker: document.getElementById('monthPicker'),
  reportMonthPicker: document.getElementById('reportMonthPicker'),
  
  // Transaction Form elements
  transactionForm: document.getElementById('transactionForm'),
  type: document.getElementById('type'),
  category: document.getElementById('category'),
  categoryGroup: document.getElementById('categoryGroup'), // ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†
  amount: document.getElementById('amount'),
  accountFrom: document.getElementById('accountFrom'),
  accountTo: document.getElementById('accountTo'),
  accountToGroup: document.getElementById('accountToGroup'),
  date: document.getElementById('date'),
  filterAccount: document.getElementById('filterAccount'), // ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†

  // Commitments elements
  commitmentForm: document.getElementById('commitmentForm'),
  cRecurring: document.getElementById('cRecurring'),
  cEndAt: document.getElementById('cEndAt'),
  cEndAtGroup: document.getElementById('cEndAtGroup'),
  
  // Collections elements
  collectionForm: document.getElementById('collectionForm'),
  coRecurring: document.getElementById('coRecurring'),
  coEndAt: document.getElementById('coEndAt'),
  coEndAtGroup: document.getElementById('coEndAtGroup'),
  
  // Modals & Buttons
  settingsModal: document.getElementById('settingsModal'),
  btnSettings: document.getElementById('btnSettings'),
  closeSettingsModal: document.getElementById('closeSettingsModal'),
  ghSyncForm: document.getElementById('ghSyncForm'),
  ghToken: document.getElementById('ghToken'),
  ghGistId: document.getElementById('ghGistId'),
  btnGhPush: document.getElementById('btnGhPush'),
  btnGhPull: document.getElementById('btnGhPull'),
  btnThemeToggle: document.getElementById('btnThemeToggle'),
  accountsList: document.getElementById('accountsList'),
  dueSoonList: document.getElementById('dueSoonList'),
  dueSoonCount: document.getElementById('dueSoonCount'),
  commitmentsList: document.getElementById('commitmentsList'),
  collectionsList: document.getElementById('collectionsList'),
  accountModal: document.getElementById('accountModal'),
  accountForm: document.getElementById('accountForm'),
  manageAccountsList: document.getElementById('manageAccountsList'),
  btnOpenAccountForm: document.getElementById('btnOpenAccountForm'),
  closeAccountModal: document.getElementById('closeAccountModal'),
  btnApplyFilter: document.getElementById('btnApplyFilter'),
  btnExportData: document.getElementById('btnExportData'),
  btnImportData: document.getElementById('btnImportData'),
  importFile: document.getElementById('importFile'),
  btnClearData: document.getElementById('btnClearData'),
  btnSaveGhSettings: document.getElementById('btnSaveGhSettings'),
};

// ==================== Storage functions ====================
function loadData(){
  const d = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  transactions = d.transactions || [];
  accounts = d.accounts || [];
  categories = d.categories || [];
  commitments = d.commitments || [];
  collections = d.collections || [];
  settings = d.settings || {};
}
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({transactions, accounts, categories, commitments, collections, settings})); }
function saveSettings(){ saveData(); }

// ==================== Formatting & Theme ====================
function formatCurrency(amount){ return new Intl.NumberFormat('ar-EG',{style:'currency',currency:'EGP'}).format(amount||0); }
function loadTheme(){ const t=localStorage.getItem('theme')||'dark'; if(t==='light'){ document.documentElement.classList.add('light-mode'); if(els.btnThemeToggle) els.btnThemeToggle.textContent='â˜€ï¸'; } else { document.documentElement.classList.remove('light-mode'); if(els.btnThemeToggle) els.btnThemeToggle.textContent='ğŸŒ™'; } }
function toggleTheme(){ const isLight=document.documentElement.classList.toggle('light-mode'); localStorage.setItem('theme', isLight?'light':'dark'); els.btnThemeToggle.textContent = isLight?'â˜€ï¸':'ğŸŒ™'; if(document.getElementById('tab-reports')?.classList.contains('active')) drawMonthly(); }

// ==================== Business logic ====================
function calculateAccountBalance(accountName){
  const acc = accounts.find(a=>a.name===accountName);
  if(!acc) return 0;
  const initial = Number(acc.opening||0);
  const net = transactions.reduce((s,t)=>{
    if(t.type==='Ø¯Ø®Ù„' && t.account===accountName) return s + Number(t.amount||0);
    if(t.type==='Ù…ØµØ±ÙˆÙ' && t.account===accountName) return s - Number(t.amount||0);
    if(t.type==='ØªØ­ÙˆÙŠÙ„'){
      if(t.account===accountName) return s - Number(t.amount||0);
      if(t.accountTo===accountName) return s + Number(t.amount||0);
    }
    return s;
  },0);
  return initial + net;
}
function calculateTotalBalance(){ return accounts.reduce((s,a)=>s+calculateAccountBalance(a.name),0); }
function ensureBaseCategories(){ BASE_CATEGORIES.forEach(b=>{ if(!categories.find(c=>c.name===b.name && c.type===b.type)) categories.push(b); }); saveData(); }
function ensureTransferCategories(){ if(!categories.find(c=>c.name==='ØªØ­ÙˆÙŠÙ„')) categories.push({name:'ØªØ­ÙˆÙŠÙ„',type:'Ù†Ø¸Ø§Ù…ÙŠ'}); saveData(); }
function calculateMonthlySummary(month){ const fil = transactions.filter(t=>t.date && t.date.startsWith(month)); const inc = fil.filter(t=>t.type==='Ø¯Ø®Ù„').reduce((s,t)=>s+Number(t.amount||0),0); const exp = fil.filter(t=>t.type==='Ù…ØµØ±ÙˆÙ').reduce((s,t)=>s+Number(t.amount||0),0); return {income:inc, expense:exp}; }

// ==================== UI Rendering ====================
function refreshAccountSelects(){
  const opts = accounts.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
  
  if(els.accountFrom) els.accountFrom.innerHTML = opts;
  if(els.accountTo) els.accountTo.innerHTML = opts;
  
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… els.filterAccount (Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ø­Ø¯ÙŠØ«Ø§Ù‹)
  const filterOptions = `<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>` + opts;
  if(els.filterAccount) els.filterAccount.innerHTML = filterOptions;
}
function refreshCategorySelect(){
  if(!els.type) return;
  const cats = categories.filter(c=>c.type===els.type.value || c.type==='Ù†Ø¸Ø§Ù…ÙŠ');
  if(els.category) {
    els.category.innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');
  }
}
function renderTransactions(month, accountName=''){
  const rows = transactions.filter(t=>t.date && t.date.startsWith(month)).filter(t=> !accountName || t.account===accountName || t.accountTo===accountName).sort((a,b)=> (b.date||'').localeCompare(a.date||''));
  if(rows.length===0){
    if(els.transactionsTableBody) {
      els.transactionsTableBody.innerHTML = `<tr class="no-data-row"><td colspan="7" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</td></tr>`;
    }
    return;
  }
  if(els.transactionsTableBody) {
    els.transactionsTableBody.innerHTML = rows.map(t=>{
      const amountClass = t.type==='Ø¯Ø®Ù„' ? 'text-ok' : (t.type==='Ù…ØµØ±ÙˆÙ' ? 'text-danger' : '');
      const accountDisplay = t.type==='ØªØ­ÙˆÙŠÙ„' ? `${escapeHtml(t.account)} â†’ ${escapeHtml(t.accountTo||'')}` : escapeHtml(t.account||'');
      const amountSign = t.type==='Ù…ØµØ±ÙˆÙ' ? '-' : (t.type==='Ø¯Ø®Ù„' ? '+' : '');
      return `<tr>
        <td>${escapeHtml(t.date||'')}</td>
        <td>${escapeHtml(t.type||'')}</td>
        <td>${escapeHtml(t.category||'')}</td>
        <td>${accountDisplay}</td>
        <td class="${amountClass}">${amountSign}${formatCurrency(Number(t.amount||0))}</td>
        <td>${escapeHtml(t.notes||'')}</td>
        <td><button class="btn btn-danger" onclick="deleteTransaction('${t.id}')" style="height:30px;padding:0 0.5rem;">Ø­Ø°Ù</button></td>
      </tr>`;
    }).join('');
  }
}
function renderSummary(month){
  const {income, expense} = calculateMonthlySummary(month);
  if(els.totalBalance) els.totalBalance.textContent = formatCurrency(calculateTotalBalance());
  if(els.monthlyIncome) els.monthlyIncome.textContent = formatCurrency(income);
  if(els.monthlyExpense) els.monthlyExpense.textContent = formatCurrency(expense);
}
function drawAccountsList(){ if(els.accountsList) els.accountsList.innerHTML = accounts.length ? accounts.map(a=>`<li>${escapeHtml(a.name)}: ${formatCurrency(calculateAccountBalance(a.name))}</li>`).join('') : '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</li>'; }
function drawCommitments(){ if(els.commitmentsList) els.commitmentsList.innerHTML = commitments.length ? commitments.map(c=>`<li>${escapeHtml(c.name)} - ${formatCurrency(c.amount)}</li>`).join('') : '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>'; }
function drawCollections(){ if(els.collectionsList) els.collectionsList.innerHTML = collections.length ? collections.map(c=>`<li>${escapeHtml(c.name)} - ${formatCurrency(c.amount)}</li>`).join('') : '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¬Ù…ÙŠØ¹Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø³Ø¬Ù„Ø©.</li>'; }
function drawDueSoon(){ 
  if(els.dueSoonList) els.dueSoonList.innerHTML = '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹.</li>'; 
  if(els.dueSoonCount) els.dueSoonCount.textContent='0'; 
}

// ==================== Chart ====================
let monthlyChartInstance = null;
function drawMonthly(){
  if(monthlyChartInstance) monthlyChartInstance.destroy();
  const ctxEl = document.getElementById('chartMonthly');
  if (!ctxEl) return;
  const ctx = ctxEl.getContext('2d');
  const month = els.reportMonthPicker?.value || YM();
  const {income, expense} = calculateMonthlySummary(month);
  const isLight = document.documentElement.classList.contains('light-mode');
  const data = { labels:[`Ø¯Ø®Ù„ (${formatCurrency(income)})`,`Ù…ØµØ±ÙˆÙ (${formatCurrency(expense)})`], datasets:[{label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ',data:[income,expense],backgroundColor:[isLight?'#16a34a':'#22c55e',isLight?'#dc2626':'#ef4444'],hoverOffset:4}] };
  monthlyChartInstance = new Chart(ctx, { type:'doughnut', data, options:{responsive:true,plugins:{legend:{position:'top',labels:{color:getComputedStyle(document.documentElement).getPropertyValue('--txt')}},title:{display:true,text:`ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª (${month})`,color:getComputedStyle(document.documentElement).getPropertyValue('--brand-2')}}}});
}

// ==================== Events & Handlers ====================
function deleteTransaction(id){ if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')) return; transactions = transactions.filter(t=>t.id!==id); saveData(); render(); }

function handleTransactionTypeChange(e){ 
  const isTransfer = e.target.value==='ØªØ­ÙˆÙŠÙ„'; 
  
  // ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ù…Ø­ØªÙ…Ù„ Ù‡Ù†Ø§: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ù‚Ø¨Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø®ØµØ§Ø¦ØµÙ‡
  if (els.accountToGroup) {
      els.accountToGroup.style.display = isTransfer ? 'flex' : 'none'; 
  }
  if (els.categoryGroup) {
      els.categoryGroup.style.display = isTransfer ? 'none' : 'flex'; 
  }

  if(els.accountTo) els.accountTo.toggleAttribute('required', isTransfer); 
  if(els.category) els.category.toggleAttribute('required', !isTransfer); 

  refreshCategorySelect(); 
}

function addTransaction(e){ e.preventDefault(); const type=els.type?.value, amount=Number(els.amount?.value||0), date=els.date?.value, accountFrom=els.accountFrom?.value, notes=document.getElementById('notes')?.value||'' ; if(amount<=0||!date){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ÙˆØªØ§Ø±ÙŠØ® ØµØ§Ù„Ø­ÙŠÙ†.'); return; } if(type==='ØªØ­ÙˆÙŠÙ„'){ const accountTo=els.accountTo?.value; if(accountFrom===accountTo){ alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† ÙˆØ¥Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨.'); return; } transactions.push({id:Date.now()+'-out', type:'Ù…ØµØ±ÙˆÙ', category:'ØªØ­ÙˆÙŠÙ„', amount, account:accountFrom, date, notes:`ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ${accountTo}`}); transactions.push({id:Date.now()+'-in', type:'Ø¯Ø®Ù„', category:'ØªØ­ÙˆÙŠÙ„', amount, account:accountTo, date, notes:`ØªØ­ÙˆÙŠÙ„ Ù…Ù† ${accountFrom}`}); } else { const category = els.category?.value; if(!category){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªØµÙ†ÙŠÙ.'); return; } transactions.push({id:Date.now().toString(), type, category, amount, account:accountFrom, date, notes}); } saveData(); e.target.reset(); els.date.value = formatLocalDate(startOfToday()); render(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!'); }
function addCommitment(e){ e.preventDefault(); const name=document.getElementById('cName').value, amount=Number(document.getElementById('cAmount').value||0), firstDue=document.getElementById('cFirstDue').value, notes=document.getElementById('cNotes').value||'', recurring=els.cRecurring?.checked, endAt=document.getElementById('cEndAt').value||null; if(amount<=0||!firstDue){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ÙˆØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ­Ù‚Ø§Ù‚ ØµØ§Ù„Ø­ÙŠÙ†.'); return; } if(recurring && endAt && parseLocalDate(endAt) < parseLocalDate(firstDue)){ alert('ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„.'); return; } commitments.push({id:Date.now().toString(), name, amount, firstDue, notes, recurring, endAt}); saveData(); e.target.reset(); drawCommitments(); drawDueSoon(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!'); }
function addCollection(e){ e.preventDefault(); const name=document.getElementById('coName').value, amount=Number(document.getElementById('coAmount').value||0), firstDue=document.getElementById('coFirstDue').value, notes=document.getElementById('coNotes').value||'', recurring=els.coRecurring?.checked, endAt=document.getElementById('coEndAt').value||null; if(amount<=0||!firstDue){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ÙˆØªØ§Ø±ÙŠØ® Ø§Ø³ØªØ­Ù‚Ø§Ù‚ ØµØ§Ù„Ø­ÙŠÙ†.'); return; } if(recurring && endAt && parseLocalDate(endAt) < parseLocalDate(firstDue)){ alert('ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„.'); return; } collections.push({id:Date.now().toString(), name, amount, firstDue, notes, recurring, endAt}); saveData(); e.target.reset(); drawCollections(); drawDueSoon(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!'); }
function handleMonthFilter(){ currentMonth = els.monthPicker?.value || YM(); currentAccountFilter = els.filterAccount?.value || ''; render(); }

// ==================== GitHub Gist Sync Implementation ====================
function currentPayload(){ return { transactions, accounts, categories, commitments, collections, exportedAt:new Date().toISOString() }; }

function ghSaveSettings(e){ if(e && e.preventDefault) e.preventDefault(); settings.ghToken = els.ghToken?.value.trim(); settings.ghGistId = els.ghGistId?.value.trim() || null; saveSettings(); fillGhFormFromStorage(); alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub.'); }
function fillGhFormFromStorage(){ if(els.ghToken) els.ghToken.value = settings.ghToken || ''; if(els.ghGistId) els.ghGistId.value = settings.ghGistId || ''; }

async function ghFetch(path, method='GET', body=null){
  const token = settings.ghToken || els.ghToken?.value.trim();
  if(!token) throw new Error('Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ (Token) ØºÙŠØ± Ù…ÙØ¹Ø±Ù‘Ù.');
  const headers = { 'Authorization': 'token ' + token, 'Accept':'application/vnd.github+json' };
  if(body) headers['Content-Type']='application/json';
  const res = await fetch('https://api.github.com' + path, { method, headers, body: body ? JSON.stringify(body) : undefined });
  if(!res.ok){
    const text = await res.text().catch(()=>null);
    throw new Error(`GitHub API ${res.status} ${res.statusText}${text?(': '+text):''}`);
  }
  return res.json().catch(()=>null);
}

async function ghGetGist(gistId){
  if(!gistId) throw new Error('Ù…Ø¹Ø±Ù Gist ØºÙŠØ± Ù…Ø­Ø¯Ø¯.');
  return ghFetch(`/gists/${gistId}`, 'GET');
}
async function ghUpdateGist(gistId, filename, content, message){
  const body = { files: {} };
  body.files[filename] = { content };
  if(message) body.description = message;
  return ghFetch(`/gists/${gistId}`, 'PATCH', body);
}
async function ghCreateGist(filename, content, description='my-finance export', isPublic=false){
  const body = { description, public: !!isPublic, files:{} };
  body.files[filename] = { content };
  return ghFetch('/gists', 'POST', body);
}

async function ghPush(){
  try{
    const tokenField = els.ghToken?.value.trim();
    if(tokenField) settings.ghToken = tokenField;
    if(!settings.ghToken) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Token ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
    const gistIdField = els.ghGistId?.value.trim();
    if(gistIdField) settings.ghGistId = gistIdField;
    saveSettings();
    const payload = currentPayload();
    const filename = 'my-finance-data.json';
    const content = JSON.stringify(payload, null, 2);
    if(settings.ghGistId){
      await ghUpdateGist(settings.ghGistId, filename, content, `sync: update ${new Date().toISOString()}`);
      alert('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Gist.');
    }else{
      const created = await ghCreateGist(filename, content, 'my-finance backup (auto)', false);
      if(created && created.id){
        settings.ghGistId = created.id; saveSettings(); fillGhFormFromStorage();
        alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Gist Ø¬Ø¯ÙŠØ¯ ÙˆØ­ÙØ¸Ù‡ Ø¨Ù†Ø¬Ø§Ø­. (ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Gist ID)');
      }else{ throw new Error('ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Gist.'); }
    }
  }catch(err){ console.error('ghPush error', err); alert('ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + (err.message || err)); }
}

async function ghPull(){
  try{
    const tokenField = els.ghToken?.value.trim();
    if(tokenField) settings.ghToken = tokenField;
    const gistId = els.ghGistId?.value.trim() || settings.ghGistId;
    if(!settings.ghToken) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Token ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
    if(!gistId) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Gist Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
    const gist = await ghGetGist(gistId);
    const files = gist.files || {};
    let targetFile = files['my-finance-data.json'] ? 'my-finance-data.json' : Object.keys(files)[0];
    if(!targetFile) throw new Error('Ø§Ù„Ù€ Gist Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª.');
    const fileContent = files[targetFile].content;
    if(!fileContent) throw new Error('Ù…Ù„Ù Ø§Ù„Ù€ Gist ÙØ§Ø±Øº.');
    const data = JSON.parse(fileContent);
    transactions = data.transactions || data.ledger || [];
    accounts = data.accounts || [];
    categories = data.categories || [];
    commitments = (data.commitments || []).map(c=>c);
    collections = (data.collections || []).map(c=>c);
    saveData();
    render();
    drawCommitments(); drawCollections(); drawDueSoon();
    alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ Gist Ø¨Ù†Ø¬Ø§Ø­.');
  }catch(err){ console.error('ghPull error', err); alert('ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Gist: ' + (err.message || err)); }
}

// ==================== Init & Wiring ====================
function render(){ renderSummary(currentMonth); renderTransactions(currentMonth,currentAccountFilter); drawAccountsList(); }
function initCollapsibles(){ document.querySelectorAll('.card-header').forEach(h=>h.addEventListener('click', ()=>{ const card=h.closest('.card'); card.classList.toggle('collapsed'); const content=card.querySelector('.content'); if(content) content.classList.toggle('hidden'); })); }
function initTabs(){ document.querySelectorAll('.nav-btn').forEach(btn=>btn.addEventListener('click',(e)=>{ const tabId=e.target.dataset.tab; document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); e.target.classList.add('active'); const target=document.getElementById('tab-'+tabId); if(target) target.classList.add('active'); if(tabId==='reports'){ const def=YM(); if(els.reportMonthPicker && !els.reportMonthPicker.value) els.reportMonthPicker.value=def; drawMonthly(); } })); }

function init(){
  loadTheme();
  loadData();
  if(accounts.length===0){ accounts=[{name:'ÙƒØ§Ø´',opening:0},{name:'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ',opening:0},{name:'Ù…Ø­ÙØ¸Ø©',opening:0}]; saveData(); }
  ensureBaseCategories();
  initCollapsibles();
  initTabs();
  commitments = commitments.map(c=>c);
  collections = collections.map(c=>c);
  saveData();
  ensureTransferCategories();
  if(els.monthPicker){ const today=YM(); if(!els.monthPicker.value) els.monthPicker.value=today; els.monthPicker.setAttribute('max',today); }
  if(els.date) els.date.value = formatLocalDate(startOfToday());
  refreshAccountSelects(); refreshCategorySelect();
  drawCommitments(); drawCollections(); drawDueSoon(); render();
  fillGhFormFromStorage();
  els.cEndAt?.toggleAttribute('required', els.cRecurring?.checked);
  els.coEndAt?.toggleAttribute('required', els.coRecurring?.checked);
}

// Listeners
document.addEventListener('DOMContentLoaded', init);
els.btnThemeToggle?.addEventListener('click', toggleTheme);
els.transactionForm?.addEventListener('submit', addTransaction);
els.type?.addEventListener('change', handleTransactionTypeChange);
els.type?.addEventListener('change', refreshCategorySelect);
els.btnApplyFilter?.addEventListener('click', handleMonthFilter);
els.commitmentForm?.addEventListener('submit', addCommitment);
els.cRecurring?.addEventListener('change', e=>{ if(document.getElementById('cEndAtGroup')) document.getElementById('cEndAtGroup').style.display = e.target.checked ? 'flex' : 'none'; els.cEndAt?.toggleAttribute('required', e.target.checked); });
els.collectionForm?.addEventListener('submit', addCollection);
els.coRecurring?.addEventListener('change', e=>{ if(document.getElementById('coEndAtGroup')) document.getElementById('coEndAtGroup').style.display = e.target.checked ? 'flex' : 'none'; els.coEndAt?.toggleAttribute('required', e.target.checked); });
els.btnGenerateReport?.addEventListener('click', drawMonthly);

// Accounts modal
els.btnOpenAccountForm?.addEventListener('click', ()=>{ els.accountModal.style.display='block'; drawManageAccounts(); });
els.closeAccountModal?.addEventListener('click', ()=>{ els.accountModal.style.display='none'; });
function drawManageAccounts(){ 
  if(!els.manageAccountsList) return;
  els.manageAccountsList.innerHTML = accounts.length ? accounts.map((a,i)=>`<li>${escapeHtml(a.name)} Â· ${formatCurrency(a.opening||0)} <button class="btn" onclick="editAccount(${i})" style="height:28px;padding:0 6px;margin-left:6px">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn btn-danger" onclick="deleteAccount(${i})" style="height:28px;padding:0 6px">Ø­Ø°Ù</button></li>`).join('') : '<li class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</li>'; 
}
window.editAccount=(i)=>{ const acc=accounts[i]; if(!acc) return; const name=prompt('Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨',acc.name); if(!name) return; const openingStr=prompt('Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ',acc.opening||0); const op=parseFloat(openingStr); accounts[i].name=name.trim(); if(Number.isFinite(op)) accounts[i].opening=op; saveData(); refreshAccountSelects(); render(); drawManageAccounts(); }
window.deleteAccount=(i)=>{ if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù„Ù† ØªÙØ­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ§Øª). Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return; accounts.splice(i,1); saveData(); refreshAccountSelects(); render(); drawManageAccounts(); }
document.getElementById('accountForm')?.addEventListener('submit', function(e){ e.preventDefault(); const name=document.getElementById('accountName').value.trim(); const opening=Number(document.getElementById('accountOpening').value||0); if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'); return; } accounts.push({name, opening}); saveData(); refreshAccountSelects(); render(); drawManageAccounts(); this.reset(); });

// Export/Import/Clear
els.btnExportData?.addEventListener('click', ()=>{ const data = JSON.stringify({transactions, accounts, categories, commitments, collections, exportedAt:new Date().toISOString()}, null, 2); const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='my-finance-data.json'; a.click(); URL.revokeObjectURL(a.href); });
els.btnImportData?.addEventListener('click', ()=>document.getElementById('importFile')?.click());
document.getElementById('importFile')?.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; try{ const text=await f.text(); const data=JSON.parse(text); transactions=data.transactions||[]; accounts=data.accounts||[]; categories=data.categories||[]; commitments=(data.commitments||[]).map(c=>c); collections=(data.collections||[]).map(c=>c); saveData(); render(); drawCommitments(); drawCollections(); drawDueSoon(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­'); }catch(err){ alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: '+err.message); } e.target.value=''; });
els.btnClearData?.addEventListener('click', ()=>{ if(!confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹. Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ')) return; transactions=[]; accounts=[]; categories=[]; commitments=[]; collections=[]; settings={}; saveData(); render(); drawCommitments(); drawCollections(); drawDueSoon(); alert('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹.'); });

// GitHub sync buttons
els.btnGhPush?.addEventListener('click', ghPush);
els.btnGhPull?.addEventListener('click', ghPull);
els.ghSyncForm?.addEventListener('submit', ghSaveSettings);

</script>
</body>
</html>
