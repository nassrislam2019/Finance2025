<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>دفتر حساباتي — نسخة محسّنة ومدمجة (تناسق الكروت)</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
:root{
  --bg:#ffffff;
  --card:#f7f9fc;
  --muted:#55626b;
  --txt:#09101a;
  --brand:#0b84ff;
  --brand-rgb: 11, 132, 255;
  --danger:#ef4444;
  --ok:#16a34a;
  --border:#081827;
  --radius:16px;

  /* fallback contrast colors (used if browser doesn't support color-mix) */
  --contrast-on-light:#0b1220; /* dark text for light surfaces */
  --contrast-on-dark:#f3f8ff;  /* light text for dark surfaces */
}

.dark{
  --bg:#071227;
  --card:#071a2b;
  /* make muted a light tone in dark mode so icons and muted text remain visible */
  --muted:#9fb3cc;
  --txt:#e6f2ff;
  --brand:#4ea8ff;
  --danger:#fb6f6f;
  --ok:#34d399;
  --border:#123142;
  --radius:16px;

  /* update fallbacks for dark theme */
  --contrast-on-light:#071227;
  --contrast-on-dark:#e6f2ff;
}

html, body { height: 100%; }
body {
  font-family: 'Cairo', sans-serif;
  background: var(--bg);
  color: var(--txt);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* -----------------------------
   Card base (keeps existing look)
   ----------------------------- */
.card-custom {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin: 0 auto;
  overflow: hidden;
  box-shadow: 0 10px 25px rgba(9, 16, 26, 0.08);
  border-bottom: 3px solid var(--border);
  /* default internal contrast variables (will be overridden) */
  --inner-text: var(--txt);
  --inner-muted: var(--muted);
  --inner-border: var(--border);
  color: var(--inner-text);
}

/* -----------------------------
   Auto-contrast rules
   Use either color-mix (modern browsers) or fallbacks
   ----------------------------- */

:root:not(.dark) .card-custom,
.card-custom.light-surface {
  --inner-text: color-mix(in srgb, var(--txt) 75%, black 25%);
  --inner-muted: color-mix(in srgb, var(--muted) 80%, black 20%);
  --inner-border: color-mix(in srgb, var(--border) 85%, black 15%);
  --inner-text-fallback: var(--contrast-on-light);
  --inner-muted-fallback: var(--muted);
  --inner-border-fallback: var(--border);
}

:root .dark .card-custom,
.card-custom.dark-surface {
  --inner-text: color-mix(in srgb, var(--txt) 85%, white 20%);
  --inner-muted: color-mix(in srgb, var(--muted) 85%, white 30%);
  --inner-border: color-mix(in srgb, var(--border) 80%, white 25%);
  --inner-text-fallback: var(--contrast-on-dark);
  --inner-muted-fallback: var(--muted);
  --inner-border-fallback: var(--border);
}

/* Force sensible card text colors (extra safeguard for inconsistent classes) */
.card-custom h1,
.card-custom h2,
.card-custom h3,
.card-custom h4,
.card-custom h5,
.card-custom p,
.card-custom span,
.card-custom .nav-label,
.card-custom .nav-icon,
.card-custom a,
.card-custom button,
.card-custom .muted,
.card-custom small,
.card-custom .subtle {
  color: var(--inner-text, var(--inner-text-fallback)) !important;
}

/* Muted text inside card */
.card-custom .muted,
.card-custom small,
.card-custom .subtle {
  color: var(--inner-muted, var(--inner-muted-fallback)) !important;
}

/* Borders inside card */
.card-custom,
.card-inner-list .item {
  border-color: var(--inner-border, var(--inner-border-fallback)) !important;
}

/* -----------------------------
   Preserve original footer/nav styles
   ----------------------------- */
.nav-btn {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  width:62px;
  height:62px;
  padding:6px;
  border-radius:14px;
  transition: background .18s, color .18s, transform .12s;
  color:var(--muted); /* fallback for light theme */
  background:transparent;
  border:none;
}
.nav-btn .nav-icon{ font-size:20px; display:block; }
.nav-btn .nav-label{ font-size:11px; margin-top:4px; display:block; color:var(--muted); }
/* dark-mode nav button color fix */
:root .dark .nav-btn, :root .dark .nav-btn .nav-label, :root .dark .nav-btn .nav-icon{
  color: var(--contrast-on-dark) !important;
}
:root:not(.dark) .nav-btn, :root:not(.dark) .nav-btn .nav-label, :root:not(.dark) .nav-btn .nav-icon{
  color: var(--muted) !important;
}

.nav-btn.active {
  color:white;
  background: linear-gradient(135deg, var(--brand), rgba(var(--brand-rgb),0.9));
  box-shadow:0 8px 24px rgba(var(--brand-rgb),0.16);
  transform: translateY(-4px) scale(1.02);
}
.nav-btn.active .nav-label{ color: rgba(255,255,255,0.95); font-weight:700; }
.nav-btn:focus{ outline: none; box-shadow: 0 0 0 4px rgba(var(--brand-rgb),0.14); }
.nav-btn.play-anim{ animation: nav-pulse 350ms ease; }
@keyframes nav-pulse{ 0%{ transform: scale(1); } 50%{ transform: scale(0.94); } 100%{ transform: scale(1); } }
.dark-toggle{ width:44px; height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--border); }
footer{ position:sticky; bottom:0; z-index:60; }

/* -----------------------------
   Badges, inputs, tables, lists
   ----------------------------- */
.pill-badge-income { padding:4px 10px; border-radius:9999px; font-size:0.75rem; font-weight:700; background-color:#d1fae5; color:#059669; direction:ltr; white-space:nowrap; }
.pill-badge-expense { padding:4px 10px; border-radius:9999px; font-size:0.75rem; font-weight:700; background-color:#fee2e2; color:#ef4444; direction:ltr; white-space:nowrap; }

/* status helper classes that adapt to theme via variables */
.status-overdue{ color: var(--danger) !important; font-weight:700; }
.status-today{ color: var(--ok) !important; font-weight:700; }
.status-soon{ color: var(--inner-muted, var(--muted)) !important; font-weight:700; }

input:focus, select:focus, textarea:focus {
  border-color: var(--brand) !important;
  box-shadow: 0 0 0 4px rgba(var(--brand-rgb),0.18) !important;
}

/* Table custom */
.custom th { background-color: var(--card); border-bottom: 2px solid var(--inner-border, var(--border)); }
.custom td { border-bottom: 1px solid var(--inner-border, var(--border)); }
.custom tbody tr:nth-child(even) { background-color: color-mix(in srgb, var(--card) 92%, var(--inner-border, var(--border)) 8%); }
.custom tbody tr:hover { background-color: color-mix(in srgb, var(--brand) 6%, transparent 94%); }

/* List inside card */
.card-inner-list .item { padding:10px 0; border-bottom:1px dashed var(--inner-border, var(--border)); }
.card-inner-list .item:last-child { border-bottom:none; }

/* Modal */
#modalBackdrop{ display:flex; align-items:center; justify-content:center; }
#modalBackdrop.hidden{ display:none; }
#modalBackdrop .modal-box{ max-height:80vh; overflow:auto; }
.modal-list{ display:flex; flex-direction:column; gap:8px; }
.modal-list button{ text-align:right; padding:10px; border-radius:10px; border:1px solid var(--inner-border, var(--border)); background:transparent; color:var(--inner-text, var(--inner-text-fallback)); }

/* Responsive tweaks */
@media (max-width:640px){ .due-wide{ padding-left:20px; padding-right:20px; } }

/* Grid helpers */
.stacked-on-all-sizes { display:grid; grid-template-columns:1fr; gap:1rem; }
.per-account .account-row{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
.per-account .account-name{ flex:1 1 55%; }
.per-account .account-balance{ flex:1 1 40%; text-align:left; }

/* Utility classes for forcing surfaces */
.card-custom.force-light {
  background: color-mix(in srgb, var(--card) 90%, white 10%);
  --inner-text: color-mix(in srgb, var(--txt) 70%, black 25%);
}
.card-custom.force-dark {
  background: color-mix(in srgb, var(--card) 65%, black 25%);
  --inner-text: color-mix(in srgb, var(--txt) 85%, white 20%);
}

/* Accessibility: ensure minimum contrast on headings (simple clamp) */
.card-custom h1, .card-custom h2 {
  text-shadow: 0 1px 0 rgba(0,0,0,0.02);
  line-height:1.15;
}

/* END of style */
</style>

</head>
<body class="antialiased">

<div class="min-h-screen flex direction-rtl flex-col">
  <main class="flex-1 p-6 overflow-auto mb-20">
    <section id="dashboard" class="page-section">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 top-grid">
        <div class="md:col-span-1 card-custom shadow-xl per-account" style="background-color: var(--card);"> 
          <h4 class="font-semibold mb-2">تفاصيل الأرصدة بالحساب</h4>
          <div id="perAccount" class="card-inner-list space-y-3 pt-1"></div>
        </div>

        <div class="md:col-span-1 card-custom shadow-xl" style="background-color: var(--card);"> 
          <small class="muted">صافي الأرصدة</small>
          <div id="totalBalance" class="text-3xl font-bold mt-2 text-brand" style="color:var(--brand);">0.00</div>
        </div>

        <div class="md:col-span-1 card-custom shadow-xl" style="background-color: var(--card);">
          <small class="muted">الشهر الحالي</small>
          <div id="monthLabel" class="text-3xl font-bold mt-2"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="card-custom">
          <h4 class="font-semibold text-lg mb-1">إجمالي تحصيلات الشهر الحالي</h4>
          <div id="totalCollectionThis" class="text-xl font-bold mt-2 text-ok" style="color:var(--ok);">0.00</div>
        </div>
        <div class="card-custom">
          <h4 class="font-semibold text-lg mb-1">إجمالي تحصيلات الشهر القادم</h4>
          <div id="totalCollectionNext" class="text-xl font-bold mt-2 text-ok" style="color:var(--ok);">0.00</div>
        </div>
        <div class="card-custom">
          <h4 class="font-semibold text-lg mb-1">إجمالي التزامات الشهر الحالي</h4>
          <div id="totalCommitThisTotal" class="text-xl font-bold mt-2 text-danger" style="color:var(--danger);">0.00</div>
        </div>
        <div class="card-custom">
          <h4 class="font-semibold text-lg mb-1">إجمالي التزامات الشهر القادم</h4>
          <div id="totalCommitNextTotal" class="text-xl font-bold mt-2 text-danger" style="color:var(--danger);">0.00</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card-custom">
          <h4 class="font-semibold mb-2 border-b pb-2 border-border" style="border-color: var(--border);">آخر 10 حركات</h4>
          <div id="latestTx" class="card-inner-list"></div>
        </div>

        <div class="card-custom due-wide">
          <h4 class="font-semibold mb-2 border-b pb-2 border-border" style="border-color: var(--border);">الاستحقاقات القريبة (التزامات وتحصيلات)</h4>
          <div id="dueSoonWrap" class="card-inner-list"></div>
        </div>

        <div class="card-custom">
          <h4 class="font-semibold mb-2 border-b pb-2 border-border" style="border-color: var(--border);">ملاحظات سريعة</h4>
          <div id="quickNotes" class="text-sm muted">هنا يمكن إضافة ملاحظات قصيرة أو تذكيرات.</div>
        </div>
      </div>
    </section>

    <section id="transactions" class="page-section hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">سجل الحركات</h2>
        <div class="flex items-center gap-2">
          <input id="importFile" type="file" accept="application/json" class="hidden" />
          <button id="importJsonBtn" class="px-3 py-2 border rounded hover:bg-gray-100">استيراد</button>
          <button id="exportJson" class="px-3 py-2 border rounded hover:bg-gray-100">تصدير</button>
          <button id="syncNow" class="px-3 py-2 border rounded hover:bg-gray-100">مزامنة</button>
        </div>
      </div>

      <!-- MOVED: Add/Edit card placed here ABOVE the transactions table -->
      <div class="card-custom mb-4">
        <h3 class="font-semibold mb-2">إضافة / تعديل حركة</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm">النوع</label>
            <select id="type" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-brand">
              <option value="income">دخل</option>
              <option value="expense">مصروف</option>
              <option value="transfer">تحويل</option> </select>
          </div>
          <div>
            <label class="text-sm">المبلغ (ج.م)</label>
            <input id="amount" type="number" step="0.01" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-brand" dir="ltr" />
          </div>
          <div>
            <label class="text-sm">تاريخ/وقت التنفيذ (اختياري)</label>
            <input id="exec" type="datetime-local" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
          </div>
          <div>
            <label class="text-sm">تاريخ الاستحقاق</label>
            <input id="date" type="date" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
          </div>
          <div>
            <label class="text-sm">الوصف</label>
            <input id="desc" type="text" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
          </div>
          <div>
            <label class="text-sm" id="accountLabel">الحساب</label> <select id="account" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-brand"></select>
          </div>
          <div id="toAccountDiv" class="hidden"> <label class="text-sm">الحساب المُحوَّل إليه (إلى)</label>
            <select id="toAccount" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-brand"></select>
          </div>
          <div id="categoryDiv"> <label class="text-sm">الفئة</label>
            <select id="category" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-brand"></select>
          </div>
          <div id="linkCommitDiv"> <label class="text-sm">ربط الالتزام (اختياري)</label>
            <select id="linkCommit" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-brand"></select>
          </div>
          <div class="col-span-3 flex gap-2 mt-2">
            <button id="saveTx" class="px-6 py-3 text-white font-semibold rounded-xl hover:opacity-90 transition-opacity" style="background:var(--brand);">
                <i class="fas fa-save ml-2"></i> حفظ
            </button>
            <button id="resetForm" class="px-4 py-2 border rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700">إفراغ</button>
          </div>
        </div>
      </div>

      <div class="card-custom mb-4">
        <div class="flex gap-2 flex-wrap items-center mb-3">
          <input id="search" placeholder="بحث بالوصف/الفئة" class="px-3 py-2 border rounded flex-1 focus:ring-2 focus:ring-brand" />
          <select id="fType" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand">
            <option value="all">الكل</option>
            <option value="income">دخل</option>
            <option value="expense">مصروف</option>
          </select>
          <select id="fAccount" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand"></select>
          <input id="fFrom" type="date" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
          <input id="fTo" type="date" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
          <button id="clearFilters" class="px-3 py-2 border rounded hover:bg-gray-100">مسح</button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full custom">
            <thead>
              <tr class="text-sm uppercase tracking-wider text-muted">
                <th class="px-4 py-3 text-right">تاريخ التنفيذ</th><th>تاريخ الاستحقاق</th><th>الوصف</th><th>الفئة</th><th>الحساب</th><th>المبلغ</th><th>رصيد بعد العملية</th><th>إجراءات</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="mt-3 flex	items-center justify-center gap-3">
          <button id="prevPage" class="px-3 py-2 border rounded hover:bg-gray-100">السابق</button>
          <div id="pageInfo" class="text-sm muted">الصفحة 1</div>
          <button id="nextPage" class="px-3 py-2 border rounded hover:bg-gray-100">التالي</button>
        </div>
      </div>
    </section>

    <section id="accounts" class="page-section hidden">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card-custom">
          <h3 class="font-semibold mb-2">الحسابات</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="newAccountName" placeholder="اسم الحساب" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
            <input id="newAccountOpening" type="number" placeholder="رصيد افتتاحي" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
            <button id="addAccount" class="px-3 py-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700">إضافة حساب</button>
          </div>
          <div id="accountsList" class="mt-3 space-y-2"></div>
        </div>

        <div class="card-custom">
          <h3 class="font-semibold mb-2">الفئات</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="newCatName" placeholder="اسم الفئة" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
            <select id="newCatType" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand"><option value="expense">مصروف</option><option value="income">دخل</option></select>
            <button id="addCategory" class="px-3 py-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700">إضافة فئة</button>
          </div>
          <div id="catsList" class="mt-3 space-y-2"></div>
        </div>
      </div>
    </section>

    <section id="commitments" class="page-section hidden">
      <div class="grid md:grid-cols-1 gap-4">
        <div class="card-custom">
          <h3 class="font-semibold mb-2">الالتزامات الشهرية</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
            <input id="cName" placeholder="اسم الالتزام" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
            <input id="cAmount" type="number" placeholder="المبلغ" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
            <input id="cFirstDue" type="date" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
            <div class="flex items-center gap-2"><input id="cRecurring" type="checkbox" /><label>يتكرر شهريًا</label></div>
            <input id="cEndAt" type="date" class="px-3 py-2 border rounded col-span-2 focus:ring-2 focus:ring-brand" placeholder="ينتهي في (عند التكرار)" />
            <button id="addCommitment" class="px-3 py-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700">إضافة/تحديث</button>
          </div>

          <div class="mt-4 overflow-x-auto">
            <table class="min-w-full custom">
              <thead><tr class="text-sm uppercase tracking-wider text-muted"><th>الاسم</th><th>المبلغ</th><th>استحقاق</th><th>مدفوع (شهر)</th><th>متبقي</th><th>تكرار</th><th>ينتهي</th><th>إجراءات</th></tr></thead>
              <tbody id="tbodyCommit"></tbody>
            </table>
          </div>
        </div>

        <div class="card-custom mt-4">
          <h3 class="font-semibold mb-2">التحصيلات</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
            <input id="coName" placeholder="اسم التحصيل" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
            <input id="coAmount" type="number" placeholder="المبلغ" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
            <input id="coFirstDue" type="date" class="px-3 py-2 border rounded focus:ring-2 focus:ring-brand" />
            <div class="flex items-center gap-2"><input id="coRecurring" type="checkbox" /><label>يتكرر شهريًا</label></div>
            <input id="coEndAt" type="date" class="px-3 py-2 border rounded col-span-2 focus:ring-2 focus:ring-brand" />
            <button id="addCollect" class="px-3 py-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700">إضافة/تحديث</button>
          </div>

          <div class="mt-4 overflow-x-auto">
            <table class="min-w-full custom">
              <thead><tr class="text-sm uppercase tracking-wider text-muted"><th>الاسم</th><th>المبلغ</th><th>التحصيل القادم</th><th>التكرار</th><th>ينتهي</th><th>إجراءات</th></tr></thead>
              <tbody id="tbodyCollect"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <div class="mt-6 text-center text-sm muted">تم ملء شاشات الإضافة والالتزامات والحسابات — جرب إضافة حساب/فئة/حركة/التزام/تحصيل.</div>
  </main>
</div>

<footer class="flex justify-between items-center p-2 bg-card border-t border-border z-50" style="background-color: var(--card); border-color: var(--border);">
  <div class="flex gap-2 px-2">
    <button class="nav-btn" data-page="dashboard" aria-label="الرئيسية" title="الرئيسية">
      <span class="nav-icon"><i class="fas fa-house-chimney"></i></span>
      <span class="nav-label">الرئيسية</span>
    </button>
    <button class="nav-btn" data-page="transactions" aria-label="الحركات" title="الحركات">
      <span class="nav-icon"><i class="fas fa-list-check"></i></span>
      <span class="nav-label">الحركات</span>
    </button>
    <!-- Changed: 'add' now navigates to transactions (where the add card lives) -->
    <button class="nav-btn" data-page="transactions" aria-label="إضافة" title="إضافة">
      <span class="nav-icon"><i class="fas fa-plus-circle"></i></span>
      <span class="nav-label">إضافة</span>
    </button>
    <button class="nav-btn" data-page="accounts" aria-label="الحسابات" title="الحسابات">
      <span class="nav-icon"><i class="fas fa-wallet"></i></span>
      <span class="nav-label">الحسابات</span>
    </button>
    <button class="nav-btn" data-page="commitments" aria-label="الالتزامات" title="الالتزامات">
      <span class="nav-icon"><i class="fas fa-calendar-days"></i></span>
      <span class="nav-label">الالتزامات</span>
    </button>
  </div>
  <div class="flex items-center gap-2 pr-2">
    <button id="darkToggleFooter" class="dark-toggle" title="الوضع الليلي/النهاري" aria-pressed="false"><i id="darkToggleIcon" class="fas fa-moon"></i></button>
  </div>
</footer>

<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="modal-box bg-white dark:bg-gray-800 p-4 rounded-xl w-11/12 md:w-1/2" role="dialog" aria-modal="true" style="background-color: var(--card);">
    <h4 id="modalTitle" class="font-semibold mb-2">...</h4>
    <div id="modalContent"></div>
    <div class="mt-4 text-right">
      <button id="modalClose" class="px-3 py-1 border rounded hover:bg-gray-100 dark:hover:bg-gray-700">إغلاق</button>
    </div>
  </div>
</div>

<script>
// Local storage keys
const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1', COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1', DARK_KEY='pf_dark_v1';

function safeParse(key,fallback){ try{ const raw = localStorage.getItem(key); if(!raw) return fallback; return JSON.parse(raw);}catch(e){ console.error('Corrupt localStorage',key,e); try{ localStorage.setItem(key+'_backup', localStorage.getItem(key)); }catch{} localStorage.removeItem(key); return fallback; }}
let ledger = safeParse(KEY,[]); let accounts = safeParse(ACC_KEY,[]); let categories = safeParse(CAT_KEY,[]); let commitments = safeParse(COM_KEY,[]); let collections = safeParse(COL_KEY,[]);

let sortedLedger=[]; let isLedgerDirty=true; function markLedgerDirty(){ isLedgerDirty=true; }
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s)); const eid=()=>Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const fmt = n=>Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2}); const escapeHtml = s=>String(s||'').replace(/[&<>\"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
function formatLocalDate(d){ if(!d) return ''; const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function parseLocalDate(str){ if(!str) return null; const [y,m,d]=str.split('-').map(Number); if(!y) return null; const dt=new Date(y,m-1,d,0,0,0,0); dt.setHours(0,0,0,0); return dt; }
function YM(){ return formatLocalDate(new Date()).slice(0,7); }
function addMonthsPreserveDOM(date, months){ const d=new Date(date.getTime()); const targetMonth=d.getMonth()+months; const day=d.getDate(), y=d.getFullYear(); const temp=new Date(y,targetMonth+1,0); const lastDay=temp.getDate(); d.setMonth(targetMonth, Math.min(day,lastDay)); d.setHours(0,0,0,0); return d; }
function addMonthsToYm(ym, months){ const parts=(ym||'').split('-').map(Number); const y=parts[0], m=parts[1]; if(!Number.isFinite(y)||!Number.isFinite(m)) return ym; const base=new Date(y,m-1,1); const next=addMonthsPreserveDOM(base, months); return formatLocalDate(next).slice(0,7); }
function daysBetween(a,b){ const MS=24*60*60*1000; const da=new Date(a.getFullYear(),a.getMonth(),a.getDate()); const db=new Date(b.getFullYear(),b.getMonth(),b.getDate()); return Math.round((db-da)/MS); }

function persist(key,obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){ console.error('persist error',e); }}

function ensureSortedLedger(){ if(!isLedgerDirty && sortedLedger.length) return; sortedLedger = [...ledger].slice().sort((a,b)=>{ const aKey=(a.exec||a.created||a.date||''); const bKey=(b.exec||b.created||b.date||''); if(aKey===bKey) return (a.id||'').localeCompare(b.id||''); return aKey.localeCompare(bKey); }); isLedgerDirty=false; }

let cachedBalances=null, cachedAfter=null;
function computeBalances(){ ensureSortedLedger(); const bal = new Map(accounts.map(a=>[a.name, Number(a.opening||0)])); const after = new Map(); for(const t of sortedLedger){ const cur = bal.get(t.account) ?? 0; const delta = (t.type==='income' ? Number(t.amount||0) : -Number(t.amount||0)); const next = cur + delta; bal.set(t.account, next); after.set(t.id, next); } cachedBalances = bal; cachedAfter = after; return {bal, after}; }

function getCommitmentState(commit){ if(!commit || !commit.firstDue) return { currentDueYm:null, paid:0, remaining:Number(commit.amount||0) }; const amount = Number(commit.amount||0); const start = parseLocalDate(commit.firstDue); if(!start) return { currentDueYm:null, paid:0, remaining:amount }; const endDate = commit.endAt ? parseLocalDate(commit.endAt) : null; const payMap = new Map(); for(const t of ledger){ if(t.linkCommitId !== commit.id) continue; const ym = (t.exec||t.created||t.date||'').slice(0,7); if(!ym) continue; const arr = payMap.get(ym) || []; arr.push(t); payMap.set(ym, arr); } let cursor = new Date(start.getTime()); let guard=0; while(guard<500){ const ym=formatLocalDate(cursor).slice(0,7); if(endDate && cursor > endDate) return { done:true }; const txs = payMap.get(ym) || []; const paidThisMonth = txs.reduce((s,t)=>s + Number(t.amount||0), 0); if(paidThisMonth + 1e-9 < amount){ return { currentDueYm: ym, paid: paidThisMonth, remaining: Math.max(0, amount - paidThisMonth) }; } else { if(!commit.recurring) return { done:true }; const next = addMonthsPreserveDOM(cursor,1); if(endDate && next > endDate) return { done:true }; cursor = next; } guard++; } return { done:true }; }

function collectedCollectionsForYm(ym){ let total=0; for(const t of ledger){ if(t.type !== 'income') continue; const when=(t.exec||t.created||t.date||'').slice(0,7); if(when !== ym) continue; if(t.sourceCollectionId) total += Number(t.amount||0); } return total; }

// DRAW functions
function drawPerAccount(){ computeBalances(); const list=[]; for(const a of accounts){ const v = (cachedBalances && cachedBalances.get(a.name)!==undefined) ? cachedBalances.get(a.name) : Number(a.opening||0); list.push(`<div class="item"><div class="account-row"><div class="account-name"><div class="text-sm muted">${escapeHtml(a.name)}</div></div><div class="account-balance"><b>${fmt(v)} ج.م</b></div></div></div>`); } $('#perAccount').innerHTML = list.join(''); }

function drawCommitments(){ const rows = commitments.slice().sort((a,b)=> (a.firstDue||'').localeCompare(b.firstDue||'')); if($('#tbodyCommit')) $('#tbodyCommit').innerHTML = rows.map(c=>{ const st = getCommitmentState(c); const paid = st.paid || 0; const remaining = st.remaining !== undefined ? st.remaining : Number(c.amount||0); const due = st.currentDueYm || (c.firstDue? c.firstDue.slice(0,7) : '—'); return `<tr class="row-item" data-id="${c.id}"><td class="p-2">${escapeHtml(c.name)}</td><td class="p-2">${fmt(c.amount)}</td><td class="p-2">${escapeHtml(due)}</td><td class="p-2">${fmt(paid)}</td><td class="p-2"><b>${fmt(remaining)}</b></td><td class="p-2">${c.recurring? 'شهري':'مرة'}</td><td class="p-2">${c.endAt||'—'}</td><td class="p-2 space-x-2 space-x-reverse"><button data-action="pay-commit" data-id="${c.id}" class="px-2 py-1 bg-brand text-white rounded-lg hover:opacity-90"><i class="fas fa-hand-holding-usd"></i> سداد</button><button data-action="edit-commit" data-id="${c.id}" class="px-2 py-1 border rounded hover:bg-gray-100"><i class="fas fa-edit"></i> تعديل</button><button data-action="del-commit" data-id="${c.id}" class="px-2 py-1 bg-danger text-white rounded-lg hover:opacity-90"><i class="fas fa-trash-alt"></i> حذف</button></td></tr>`; }).join(''); }

function drawCollections(){ const rows = collections.slice().sort((a,b)=> (a.nextDue||a.firstDue||'').localeCompare(b.nextDue||b.firstDue||'')); if($('#tbodyCollect')) $('#tbodyCollect').innerHTML = rows.map(c=>{ return `<tr class="row-item" data-id="${c.id}"><td class="p-2">${escapeHtml(c.name)}</td><td class="p-2">${fmt(c.amount)}</td><td class="p-2">${escapeHtml(c.nextDue||c.firstDue||'—')}</td><td class="p-2">${c.recurring? 'شهري':'مرة'}</td><td class="p-2">${c.endAt||'—'}</td><td class="p-2 space-x-2 space-x-reverse"><button data-action="collect-now" data-id="${c.id}" class="px-2 py-1 bg-ok text-white rounded-lg hover:opacity-90"><i class="fas fa-check"></i> تحصيل</button><button data-action="edit-collect" data-id="${c.id}" class="px-2 py-1 border rounded hover:bg-gray-100"><i class="fas fa-edit"></i> تعديل</button><button data-action="del-collect" data-id="${c.id}" class="px-2 py-1 bg-danger text-white rounded-lg hover:opacity-90"><i class="fas fa-trash-alt"></i> حذف</button></td></tr>`; }).join(''); }

// Updated drawDueSoon: include commitments & collections for current month and sort by real date (oldest -> newest)
function drawDueSoon(){ const wrap=$('#dueSoonWrap'); if(!wrap) return; const ym=YM(); const today=new Date();
  const commitList = commitments.map(c=>{ const st=getCommitmentState(c); if(st.done || st.remaining<=0) return null; if(st.currentDueYm !== ym) return null; // only this month
    // determine a realistic day for the commitment within the month: prefer original firstDue day if possible
    let day = 1;
    if(c.firstDue){ const p = parseLocalDate(c.firstDue); if(p) day = Math.min(28, p.getDate()); } // clamp to avoid invalid days
    const due = parseLocalDate(st.currentDueYm + '-' + String(day).padStart(2,'0')) || parseLocalDate(st.currentDueYm + '-01');
    const diff = daysBetween(today,due);
    return {...c, dueDate: due, dueStr: st.currentDueYm, paid:st.paid, remaining:st.remaining, diff, type:'commitment'}; }).filter(Boolean);

  const collectList = collections.map(c=>{ const dueStr = c.nextDue || c.firstDue; if(!dueStr || dueStr.slice(0,7)!==ym) return null; // only this month
    // if collection has a full date use it, otherwise default to day 1
    const due = parseLocalDate(dueStr) || parseLocalDate(dueStr.slice(0,7) + '-01');
    const diff = daysBetween(today,due);
    return {...c, dueDate: due, dueStr, diff, type:'collection'}; }).filter(Boolean);

  // merge and sort by actual dueDate (oldest => newest)
  const list = [...commitList, ...collectList].sort((a,b)=> a.dueDate - b.dueDate);

  let html='';
  if(list.length===0){ html=`<div class="text-sm muted pt-2">لا توجد استحقاقات/تحصيلات قريبة لهذا الشهر غير مسجلة.</div>`; }
  else {
    html = list.map(x=>{
      const isCommit = x.type==='commitment';
      const isOverdue = x.diff < 0;
      const state = isOverdue ? `<span class="status-overdue"><i class="fas fa-exclamation-triangle"></i> متأخر ${Math.abs(x.diff)} يوم</span>` : x.diff===0 ? `<span class="status-today"><i class="fas fa-bell"></i> اليوم</span>` : `<span class="status-soon"><i class="fas fa-clock"></i> متبقي ${x.diff} يوم</span>`;
      const bgClass = isOverdue && isCommit ? 'bg-red-50 dark:bg-red-900 border-red-300' : 'border-border';
      const actionButton = isCommit ? `<button data-action="pay-commit" data-id="${x.id}" class="px-3 py-1 text-white rounded-lg hover:opacity-90" style="background:var(--brand);"><i class="fas fa-credit-card"></i> سداد</button>` : `<button data-action="collect-now" data-id="${x.id}" class="px-3 py-1 text-white rounded-lg hover:opacity-90" style="background:var(--ok);"><i class="fas fa-check"></i> تحصيل</button>`;
      const details = isCommit ? `الأصل: ${fmt(x.amount)} · المدفوع: ${fmt(x.paid || 0)} · استحقاق: ${x.dueDate ? formatLocalDate(x.dueDate) : x.dueStr}` : `المبلغ: ${fmt(x.amount)} · التحصيل: ${x.dueDate ? formatLocalDate(x.dueDate) : x.dueStr}`;
      const amountDisplay = isCommit ? fmt(x.remaining) : fmt(x.amount);
      return `<div class="item mb-2 p-3 border rounded-lg ${bgClass}"><div class="flex justify-between items-center"><div class="font-bold">${escapeHtml(x.name)} (${isCommit ? 'التزام' : 'تحصيل'})</div><div class="font-bold text-lg">${amountDisplay} ج.م</div></div><div class="text-xs muted mt-1">${details}</div><div class="mt-2 flex justify-between items-center">${state}${actionButton}</div></div>`;
    }).join('');
  }
  wrap.innerHTML = html;
}

// Transaction rendering (latest-first) implemented earlier as renderTransactions
let currentPage=1; const pageSize=20;
function renderTransactions(){ ensureSortedLedger(); computeBalances(); const search = ($('#search')?.value||'').toLowerCase(); const fType = $('#fType')?.value||'all'; const fAccount = $('#fAccount')?.value||'all'; const fFrom = $('#fFrom')?.value; const fTo = $('#fTo')?.value; const filtered = sortedLedger.filter(t=>{ if(fType !== 'all' && t.type !== fType) return false; if(fAccount !== 'all' && t.account !== fAccount) return false; if(search){ const match = (t.desc||'').toLowerCase().includes(search) || (t.category||'').toLowerCase().includes(search); if(!match) return false; } if(fFrom && t.date && t.date < fFrom) return false; if(fTo && t.date && t.date > fTo) return false; return true; }); const rows = filtered.slice().sort((a,b)=>{ const aKey=(a.exec||a.created||a.date||''); const bKey=(b.exec||b.created||b.date||''); return (bKey).localeCompare(aKey); }); const total = rows.length; const pages = Math.ceil(total / pageSize); if(currentPage > pages) currentPage = pages; const start = (currentPage - 1) * pageSize; const pageRows = rows.slice(start, start+pageSize); const after = (cachedAfter || new Map()); $('#tbody').innerHTML = pageRows.map(t=>{ const afterVal = after.has(t.id) ? after.get(t.id) : 0; const execTxt = t.exec ? new Date(t.exec).toLocaleString('ar-EG') : (t.created ? new Date(t.created).toLocaleString('ar-EG') : '—'); const dueTxt = t.date || t.due || '—'; const tag = t.isTransfer ? ' <span class="text-xs text-brand"><i class="fas fa-sync-alt"></i> تحويل</span>' : ''; const pillClass = t.type === 'income' ? 'pill-badge-income' : 'pill-badge-expense'; const sign = t.type === 'income' ? '+' : '-'; return `<tr class="row-item" data-id="${t.id}"><td class="p-2" data-label="تاريخ التنفيذ">${escapeHtml(execTxt)}</td><td class="p-2" data-label="تاريخ الاستحقاق">${escapeHtml(dueTxt)}</td><td class="p-2" data-label="الوصف"><div class="font-semibold">${escapeHtml(t.desc||'—')}${tag}</div><div class="text-xs muted">${escapeHtml(t.category||'—')}</div></td><td class="p-2" data-label="الفئة">${escapeHtml(t.category||'—')}</td><td class="p-2" data-label="الحساب">${escapeHtml(t.account||'—')}</td><td class="p-2 text-left" data-label="المبلغ"><span class="${pillClass}" dir="ltr">${sign}${fmt(t.amount)}</span></td><td class="p-2" data-label="رصيد بعد العملية">${fmt(afterVal)}</td><td class="p-2" data-label="إجراءات"><button data-action="edit-tx" data-id="${t.id}" class="px-2 py-1 text-brand hover:bg-gray-100 rounded-lg"><i class="fas fa-edit"></i> تعديل</button> <button data-action="del-tx" data-id="${t.id}" class="px-2 py-1 text-danger hover:bg-red-50 rounded-lg"><i class="fas fa-trash-alt"></i> حذف</button></td></tr>`; }).join(''); $('#pageInfo').textContent = `الصفحة ${currentPage} من ${pages||1} — إجمالي ${total}`; $('#prevPage').disabled = currentPage <= 1; $('#nextPage').disabled = currentPage >= pages; }

// Pagination buttons
$('#prevPage')?.addEventListener('click', ()=>{ if(currentPage>1) currentPage--; renderTransactions(); });
$('#nextPage')?.addEventListener('click', ()=>{ currentPage++; renderTransactions(); });

// small helpers for accounts/categories rendering
function drawAccountsList(){ if(!$('#accountsList')) return; $('#accountsList').innerHTML = accounts.map((a,i)=>`<div class="flex items-center gap-2 p-2 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700"><div class="badge-custom flex-1">${escapeHtml(a.name)} · <b>${fmt(a.opening||0)} ج.م</b></div><div class="ml-auto space-x-2 space-x-reverse"><button data-action="rename-acc" data-i="${i}" class="px-2 py-1 text-brand hover:bg-gray-100 rounded">تعديل</button><button data-action="remove-acc" data-i="${i}" class="px-2 py-1 text-red-500 hover:bg-red-50 rounded">حذف</button></div></div>`).join(''); }
function drawCatsList(){ if(!$('#catsList')) return; $('#catsList').innerHTML = categories.map((c,i)=>`<div class="flex items-center gap-2 p-2 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700"><div class="badge-custom flex-1">${escapeHtml(c.name)} · <span class="text-sm ${c.type==='income'?'text-ok':'text-danger'}">${c.type==='income'?'دخل':'مصروف'}</span></div><div class="ml-auto space-x-2 space-x-reverse"><button data-action="rename-cat" data-i="${i}" class="px-2 py-1 text-brand hover:bg-gray-100 rounded">تعديل</button><button data-action="remove-cat" data-i="${i}" class="px-2 py-1 text-red-500 hover:bg-red-50 rounded">حذف</button></div></div>`).join(''); }

// showModal implementation and modal handlers
function showModal(title, content, asList){ $('#modalTitle').textContent = title; const cont = $('#modalContent'); if(asList && Array.isArray(content)){ cont.innerHTML = '<div class="modal-list">' + content.map((it,i)=>`<button data-modal-i="${i}" class="px-2 py-2 border rounded text-right">${escapeHtml(it)}</button>`).join('') + '</div>'; } else if(typeof content === 'string'){ cont.innerHTML = content; } else { cont.innerHTML = `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(content,null,2))}</pre>`; } $('#modalBackdrop').classList.remove('hidden'); }

$('#modalClose')?.addEventListener('click', ()=>{ $('#modalBackdrop').classList.add('hidden'); });
document.addEventListener('click', (e)=>{ const modalBackdrop=$('#modalBackdrop'); if(modalBackdrop && !modalBackdrop.classList.contains('hidden') && e.target === modalBackdrop){ $('#modalClose')?.click(); return; } const mi = e.target.closest('[data-modal-i]'); if(mi){ const idx=Number(mi.getAttribute('data-modal-i')); console.log('modal selection', idx); $('#modalBackdrop')?.classList.add('hidden'); } });

// Import/Export handlers
$('#importJsonBtn')?.addEventListener('click', ()=>{ $('#importFile')?.click(); });
$('#importFile')?.addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return; try{ const text = await file.text(); const data = JSON.parse(text); if(Array.isArray(data.ledger)) ledger = data.ledger; if(Array.isArray(data.accounts)) accounts = data.accounts; if(Array.isArray(data.categories)) categories = data.categories; if(Array.isArray(data.commitments)) commitments = data.commitments; if(Array.isArray(data.collections)) collections = data.collections; persist(KEY, ledger); persist(ACC_KEY, accounts); persist(CAT_KEY, categories); persist(COM_KEY, commitments); persist(COL_KEY, collections); init(); alert('تم استيراد البيانات بنجاح!'); }catch(err){ console.error('Import error', err); alert('فشل استيراد الملف. تأكد من أنه ملف JSON صحيح.'); } });
$('#exportJson')?.addEventListener('click', ()=>{ const data={ ledger, accounts, categories, commitments, collections, exportedAt:new Date().toISOString() }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='my-finance-data.json'; a.click(); URL.revokeObjectURL(a.href); });

// Footer buttons binding + animation + dark toggle
function bindFooter(){ $$('button.nav-btn').forEach(btn=>{ btn.addEventListener('click', ()=>{ const page=btn.dataset.page; btn.classList.remove('play-anim'); void btn.offsetWidth; btn.classList.add('play-anim'); $$('button.nav-btn').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); }); btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); if(typeof gotoPage === 'function') gotoPage(page); else{ $$('.page-section').forEach(p=>p.classList.add('hidden')); const t=document.getElementById(page); if(t) t.classList.remove('hidden'); } }); }); const darkBtn=$('#darkToggleFooter'); if(darkBtn){ darkBtn.addEventListener('click', ()=>{ const isDark=document.documentElement.classList.toggle('dark'); localStorage.setItem(DARK_KEY, isDark? 'true':'false'); const ic=$('#darkToggleIcon'); if(ic) ic.className = isDark? 'fas fa-sun' : 'fas fa-moon'; darkBtn.setAttribute('aria-pressed', String(isDark)); }); }
}

// Keep footer active in sync when gotoPage is called
function setFooterActiveByPage(pageId){ const btn=document.querySelector(`button.nav-btn[data-page="${pageId}"]`); if(btn){ $$('button.nav-btn').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); }); btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); } }

// small UI helpers
function refreshAccountSelects(){ 
    const opts = accounts.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join(''); 
    if($('#account')) $('#account').innerHTML = opts; 
    if($('#toAccount')) $('#toAccount').innerHTML = opts; // ADDED
    if($('#fAccount')) $('#fAccount').innerHTML = `<option value="all">كل الحسابات</option>` + opts; 
}

function refreshCategorySelect(){ 
    const type = $('#type')?.value || 'expense';
    const cats = categories.filter(c=>c.type === type); 
    if($('#category')) $('#category').innerHTML = cats.map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join(''); 
}

function refreshLinkCommitOptions(){ if(!$('#linkCommit')) return; const ym=YM(); const opts = commitments.filter(c=>{ const st=getCommitmentState(c); return !st.done && st.currentDueYm===ym && st.remaining>0; }).map(c=>{ const st=getCommitmentState(c); return `<option value="${c.id}">${escapeHtml(c.name)} (متبقي: ${fmt(st.remaining||c.amount)} ج.م)</option>`; }).join(''); $('#linkCommit').innerHTML = `<option value="">لا يوجد ربط</option>` + opts; }

// computeAndUpdateSummary (already implemented)
function computeAndUpdateSummary(){ ensureSortedLedger(); computeBalances(); let total=0; for(const v of (cachedBalances||new Map()).values()) total += Number(v||0); const ym = YM(); const nextYm = addMonthsToYm(ym,1); let commitTotalThis=0; let totalCommitNextTotal=0; for(const c of commitments){ const st = getCommitmentState(c); if(!st.done && st.currentDueYm===ym) commitTotalThis += Number(c.amount||0); if(!st.done && st.currentDueYm===nextYm) totalCommitNextTotal += Number(c.amount||0); } let totalCollectionThis=0; let totalCollectionNext=0; for(const c of collections){ const dueYm = (c.nextDue||c.firstDue||'').slice(0,7); if(dueYm===ym) totalCollectionThis += Number(c.amount||0); if(dueYm===nextYm) totalCollectionNext += Number(c.amount||0); } if($('#totalBalance')) $('#totalBalance').textContent = fmt(total) + ' ج.م'; if($('#monthLabel')) $('#monthLabel').textContent = ym; if($('#totalCollectionThis')) $('#totalCollectionThis').textContent = fmt(totalCollectionThis) + ' ج.م'; if($('#totalCollectionNext')) $('#totalCollectionNext').textContent = fmt(totalCollectionNext) + ' ج.م'; if($('#totalCommitThisTotal')) $('#totalCommitThisTotal').textContent = fmt(commitTotalThis) + ' ج.م'; if($('#totalCommitNextTotal')) $('#totalCommitNextTotal').textContent = fmt(totalCommitNextTotal) + ' ج.م'; drawPerAccount(); $('#latestTx').innerHTML = ledger.slice().sort((a,b)=> (b.exec||b.created||'').localeCompare(a.exec||a.created||'')).slice(0,10).map(t=>{ const sign=t.type==='income'?'+':'-'; const color = t.type==='income'?'text-ok':'text-danger'; return `<div class="flex justify-between items-center item"><div><b>${escapeHtml(t.desc||'—')}</b><div class="text-xs muted">${escapeHtml(t.category||'')}</div></div><div class="${color} font-bold">${sign}${fmt(t.amount)}</div></div>`; }).join(''); drawDueSoon(); }

// init function
function gotoPage(pageId){ $$('.page-section').forEach(p=>p.classList.add('hidden')); $(`#${pageId}`)?.classList.remove('hidden'); setFooterActiveByPage(pageId); }
function loadThemeData(){ const isDark = localStorage.getItem(DARK_KEY) === 'true'; if(isDark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); const ic=$('#darkToggleIcon'); if(ic) ic.className = isDark? 'fas fa-sun' : 'fas fa-moon'; }

function ensureTransferCategories(){ const need=[{name:'تحويل صادر',type:'expense'},{name:'تحويل وارد',type:'income'},{name:'عمولة تحويل',type:'expense'}]; let changed=false; for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } } if(changed) persist(CAT_KEY, categories); }

// NEW: Function to handle UI visibility based on transaction type (transfer/normal)
function handleTypeChange(){
    const type = $('#type')?.value;
    const isTransfer = type === 'transfer';

    $('#toAccountDiv')?.classList.toggle('hidden', !isTransfer);
    $('#categoryDiv')?.classList.toggle('hidden', isTransfer);
    $('#linkCommitDiv')?.classList.toggle('hidden', isTransfer);

    if($('#accountLabel')) {
        $('#accountLabel').textContent = isTransfer ? 'الحساب المُحوَّل منه (من)' : 'الحساب';
    } else if($('#account')?.previousElementSibling) { // Fallback if no ID on label
        $('#account').previousElementSibling.textContent = isTransfer ? 'الحساب المُحوَّل منه (من)' : 'الحساب';
    }
    refreshCategorySelect();
}

// basic event bindings for add account/category and compute summary
$('#addAccount')?.addEventListener('click', ()=>{ const name=($('#newAccountName')?.value||'').trim(); const opening=Number($('#newAccountOpening')?.value||0); if(!name) return; accounts.push({name, opening}); persist(ACC_KEY, accounts); $('#newAccountName').value=''; $('#newAccountOpening').value=''; drawAccountsList(); refreshAccountSelects(); computeAndUpdateSummary(); });
$('#addCategory')?.addEventListener('click', ()=>{ const name=($('#newCatName')?.value||'').trim(); const type=($('#newCatType')?.value||'expense'); if(!name) return; categories.push({name, type}); persist(CAT_KEY, categories); $('#newCatName').value=''; drawCatsList(); refreshCategorySelect(); });

// UPDATED: Save Transaction Logic (Handling Transfers)
let editTxId=null; 
$('#saveTx')?.addEventListener('click', ()=>{ 
    const type=($('#type')?.value||'income'); 
    const amount=Number($('#amount')?.value||0); 
    const execVal = $('#exec')?.value; 
    const dateVal = $('#date')?.value; 
    const desc=($('#desc')?.value||'').trim(); 
    const fromAccount = ($('#account')?.value||''); 
    const category = ($('#category')?.value||''); 
    const linkCommitId = ($('#linkCommit')?.value||''); 
    const toAccount = ($('#toAccount')?.value||'');

    // VALIDATION
    if(!fromAccount || !amount || amount<=0){ 
        alert('من فضلك أدخل: حساب (المحوَّل منه) ومبلغ صحيح.'); 
        return; 
    } 
    if(type === 'transfer'){
        if(!toAccount || fromAccount === toAccount){
            alert('يجب تحديد حسابين مختلفين للتحويل.');
            return;
        }
    } else if (!category) {
        alert('من فضلك حدد فئة.');
        return;
    }

    let execISO=null; 
    if(execVal){ 
        const d=new Date(execVal); 
        const tzOffset = d.getTimezoneOffset()*60000; 
        execISO = new Date(d.getTime() - tzOffset).toISOString(); 
    } else execISO = new Date().toISOString(); 
    
    let txsToSave = [];
    const isEditMode = !!editTxId;

    // --- TRANSFER LOGIC ---
    if(type === 'transfer'){
        const transferBaseId = editTxId || eid();
        const outgoingTxId = transferBaseId;
        const incomingTxId = transferBaseId + '_in';

        // 1. Outgoing Transaction (Expense)
        const outgoingTx = { 
            id: outgoingTxId, 
            created: new Date().toISOString(), 
            exec: execISO, 
            date: dateVal || execISO.slice(0,10), 
            desc: desc || `تحويل إلى ${toAccount}`, 
            type: 'expense', 
            amount: amount, 
            account: fromAccount, 
            category: 'تحويل صادر', 
            linkCommitId: null, 
            isTransfer: true,
            linkedTxId: incomingTxId
        };
        txsToSave.push(outgoingTx);

        // 2. Incoming Transaction (Income)
        const incomingTx = {
            id: incomingTxId,
            created: new Date().toISOString(), 
            exec: execISO, 
            date: dateVal || execISO.slice(0,10), 
            desc: desc || `تحويل من ${fromAccount}`, 
            type: 'income', 
            amount: amount, 
            account: toAccount, 
            category: 'تحويل وارد', 
            linkCommitId: null, 
            isTransfer: true,
            linkedTxId: outgoingTxId
        };
        txsToSave.push(incomingTx);

        // If editing, remove the old pair first
        if (isEditMode) {
             // remove any existing pair that uses the same base id (best-effort)
             ledger = ledger.filter(t => !(t.id === outgoingTxId || t.id === incomingTxId || t.linkedTxId === outgoingTxId || t.linkedTxId === incomingTxId));
        }
    } 
    // --- NORMAL INCOME/EXPENSE LOGIC ---
    else {
        // If editing, check if the old transaction was a transfer. If so, delete the linked pair.
        if (isEditMode) {
            const existingTx = ledger.find(t=>t.id===editTxId);
            if(existingTx?.isTransfer && existingTx.linkedTxId) {
                ledger = ledger.filter(t => t.id !== editTxId && t.id !== existingTx.linkedTxId);
            }
        }
        
        const newTx = { 
            id: editTxId || eid(), 
            created: new Date().toISOString(), 
            exec: execISO, 
            date: dateVal || execISO.slice(0,10), 
            desc, 
            type, 
            amount: Number(amount), 
            account: fromAccount, 
            category, 
            linkCommitId, 
            isTransfer:false 
        }; 
        txsToSave.push(newTx);
    }
    
    // Final Save and Cleanup
    if(isEditMode && type !== 'transfer'){ 
        const i = ledger.findIndex(t=>t.id===txsToSave[0].id); 
        if(i>-1) ledger[i]=txsToSave[0]; 
        else ledger.push(...txsToSave);
    } else {
        ledger.push(...txsToSave); 
    }

    editTxId=null; 
    $('#saveTx').textContent='حفظ'; 
    persist(KEY, ledger); 
    markLedgerDirty(); 
    ensureSortedLedger(); 
    renderTransactions(); 
    drawCommitments(); 
    drawDueSoon(); 
    computeAndUpdateSummary(); 
    
    // Reset form and UI state
    $('#amount').value=''; 
    $('#desc').value=''; 
    $('#exec').value=''; 
    $('#date').value=''; 
    $('#linkCommit').value='';
    $('#type').value = 'expense'; 
    handleTypeChange(); // Ensure UI state is reset
});

$('#resetForm')?.addEventListener('click', ()=>{ editTxId=null; $('#saveTx').textContent='حفظ'; $('#amount').value=''; $('#desc').value=''; $('#exec').value=''; $('#date').value=''; $('#linkCommit').value=''; $('#type').value='expense'; handleTypeChange(); });

// delegated click handlers (delete/edit tx, commitments, collections)
document.addEventListener('click', function(e){ const btn = e.target.closest('button[data-action]'); if(!btn) return; const action = btn.getAttribute('data-action'); const id = btn.getAttribute('data-id'); if(action === 'del-tx'){ if(confirm('هل تريد حذف هذه الحركة؟')){ 
        // If deleting a transfer, delete the linked transaction too
        const txToDelete = ledger.find(t => t.id === id);
        if (txToDelete?.isTransfer && txToDelete.linkedTxId) {
            ledger = ledger.filter(t => t.id !== id && t.id !== txToDelete.linkedTxId);
        } else {
            ledger = ledger.filter(t=>t.id!==id);
        }

        persist(KEY, ledger); markLedgerDirty(); ensureSortedLedger(); renderTransactions(); drawCommitments(); drawDueSoon(); computeAndUpdateSummary(); 
    } } else if(action === 'edit-tx'){ const t = ledger.find(x=>x.id===id); if(!t) return; 
        
        editTxId = id; 
        $('#saveTx').textContent='تحديث'; 
        
        // Transfer handling logic
        if(t.isTransfer && t.linkedTxId) {
            const linkedTx = ledger.find(x => x.id === t.linkedTxId);
            
            // Determine the 'from' (expense) and 'to' (income) part
            const isOutgoing = t.type === 'expense';
            const fromTx = isOutgoing ? t : linkedTx;
            const toTx = isOutgoing ? linkedTx : t;
            
            // Use the expense part ID as the base for editTxId
            editTxId = fromTx?.id || t.id;

            $('#type').value = 'transfer';
            $('#account').value = fromTx?.account || '';
            $('#toAccount').value = toTx?.account || '';
            $('#amount').value = t.amount;
            $('#desc').value = fromTx?.desc || t.desc || '';
            $('#category').value = ''; // Hide category for transfers
            $('#linkCommit').value = ''; // Hide link commit
        } else {
            // Normal transaction
            $('#type').value = t.type;
            $('#account').value = t.account||''; 
            $('#amount').value = t.amount; 
            $('#desc').value = t.desc||''; 
            $('#category').value = t.category||''; 
            $('#linkCommit').value = t.linkCommitId || '';
            $('#toAccount').value = ''; // Clear to account in case UI state is wrong
        }

        // Common fields
        if(t.exec){ 
            const d = new Date(t.exec); 
            const tzOffset = d.getTimezoneOffset()*60000; 
            const localISOTime = new Date(d - tzOffset).toISOString().slice(0,16); 
            $('#exec').value = localISOTime; 
        } else $('#exec').value=''; 
        
        $('#date').value = t.date || t.due || ''; 
        
        handleTypeChange(); // Call to set the UI visibility correctly
        window.scrollTo({top:0,behavior:'smooth'}); 
    } else if(action === 'pay-commit'){ const c = commitments.find(x=>x.id===id); if(!c) return; const st = getCommitmentState(c); if(st.done || st.remaining<=0){ alert('تم سداد هذا الالتزام بالفعل أو انتهى.'); return; } const remain = st.remaining; const accName = prompt(`سداد الالتزام: ${c.name}
المبلغ المتبقي: ${fmt(remain)} ج.م
من فضلك أدخل اسم الحساب:`, accounts[0]?.name||''); if(!accName) return; if(!accounts.some(a=>a.name===accName)){ alert('هذا الحساب غير موجود'); return; } const execISO = new Date().toISOString(); const due = st.currentDueYm ? (st.currentDueYm+'-01') : (c.firstDue || execISO.slice(0,10)); ledger.push({ id:eid(), created:new Date().toISOString(), exec:execISO, date:due, due, desc:`${c.name} (سداد التزام)`, type:'expense', amount:remain, account:accName, category:'التزامات شهرية', linkCommitId:c.id }); persist(KEY, ledger); markLedgerDirty(); ensureSortedLedger(); drawCommitments(); drawDueSoon(); renderTransactions(); computeAndUpdateSummary(); } else if(action === 'del-commit'){ if(!confirm('هل تريد حذف هذا الالتزام؟ (ستبقى أي دفعات سُجلت محفوظة)')) return; commitments = commitments.filter(x=>x.id!==id); persist(COM_KEY, commitments); drawCommitments(); drawDueSoon(); computeAndUpdateSummary(); } else if(action === 'edit-commit'){ const c = commitments.find(x=>x.id===id); if(!c) return; $('#cName').value = c.name; $('#cAmount').value = c.amount; $('#cFirstDue').value = c.firstDue||''; $('#cRecurring').checked = !!c.recurring; $('#cEndAt').value = c.endAt||''; $('#addCommitment').textContent='تحديث الالتزام'; window.scrollTo({top:0,behavior:'smooth'}); } else if(action === 'collect-now'){ const c = collections.find(x=>x.id===id); if(!c) return; const accName = prompt(`تحصيل: ${c.name}
المبلغ: ${fmt(c.amount)} ج.م
من فضلك ادخل اسم الحساب المستقبل:`, accounts[0]?.name||''); if(!accName) return; if(!accounts.some(a=>a.name===accName)){ alert('هذا الحساب غير موجود'); return; } const execISO=new Date().toISOString(); const due = c.nextDue || c.firstDue || execISO.slice(0,10); ledger.push({ id:eid(), created:new Date().toISOString(), exec:execISO, date:due, due, desc:`${c.name} (تحصيل)`, type:'income', amount:c.amount, account:accName, category:'تحصيلات', sourceCollectionId:c.id }); if(c.recurring){ const currentDue = parseLocalDate(c.nextDue || c.firstDue); const next = addMonthsPreserveDOM(currentDue,1); let ci = collections.find(x=>x.id===id); if(ci) ci.nextDue = formatLocalDate(next); } else collections = collections.filter(x=>x.id!==id); persist(COL_KEY, collections); markLedgerDirty(); ensureSortedLedger(); drawCollections(); renderTransactions(); drawCommitments(); drawDueSoon(); computeAndUpdateSummary(); } else if(action === 'del-collect'){ if(confirm('هل تريد حذف هذا التحصيل؟')){ collections = collections.filter(x=>x.id!==id); persist(COL_KEY, collections); drawCollections(); computeAndUpdateSummary(); } } else if(action === 'edit-collect'){ const c = collections.find(x=>x.id===id); if(!c) return; $('#coName').value=c.name; $('#coAmount').value=c.amount; $('#coFirstDue').value=c.firstDue||''; $('#coRecurring').checked=!!c.recurring; $('#coEndAt').value=c.endAt||''; $('#addCollect').textContent='تحديث التحصيل'; window.scrollTo({top:0,behavior:'smooth'}); } });


// commitments add
$('#addCommitment')?.addEventListener('click', ()=>{ const name=($('#cName')?.value||'').trim(); const amount=Number($('#cAmount')?.value||0); const firstDueStr=$('#cFirstDue')?.value; const recurring = $('#cRecurring')?.checked; const endAt = $('#cEndAt')?.value || null; if(!name||!amount||!firstDueStr){ alert('أدخل اسم + مبلغ صحيح + تاريخ أول استحقاق'); return; } if(recurring && !endAt){ alert('عند التكرار يجب تحديد تاريخ النهاية'); return; } const firstDue = parseLocalDate(firstDueStr); let nextDue = new Date(firstDue.getTime()); const today=new Date(); nextDue.setHours(0,0,0,0); while(nextDue < today){ const tryNext = addMonthsPreserveDOM(nextDue,1); if(recurring && endAt && tryNext > parseLocalDate(endAt)) break; nextDue = tryNext; if(!recurring) break; } const commit = { id: eid(), name, amount:Number(amount), firstDue: formatLocalDate(firstDue), recurring, endAt: recurring ? (endAt||null): null, nextDue: formatLocalDate(nextDue) }; commitments.push(commit); persist(COM_KEY, commitments); $('#cName').value=''; $('#cAmount').value=''; $('#cFirstDue').value=''; $('#cRecurring').checked=false; $('#cEndAt').value=''; drawCommitments(); drawDueSoon(); computeAndUpdateSummary(); });

// collections add
$('#addCollect')?.addEventListener('click', ()=>{ const name=($('#coName')?.value||'').trim(); const amount=Number($('#coAmount')?.value||0); const firstDueStr=$('#coFirstDue')?.value; const recurring=$('#coRecurring')?.checked; const endAt = $('#coEndAt')?.value || null; if(!name||!amount||!firstDueStr){ alert('أدخل اسم + مبلغ صحيح + تاريخ أول استحقاق'); return; } if(recurring && !endAt){ alert('عند التكرار يجب تحديد تاريخ النهاية'); return; } const firstDue=parseLocalDate(firstDueStr); let nextDue=new Date(firstDue.getTime()); const today=new Date(); nextDue.setHours(0,0,0,0); while(nextDue < today){ const tryNext = addMonthsPreserveDOM(nextDue,1); if(recurring && endAt && tryNext > parseLocalDate(endAt)) break; nextDue = tryNext; if(!recurring) break; } const item = { id: eid(), name, amount:Number(amount), firstDue: formatLocalDate(firstDue), recurring, endAt: recurring? (endAt||null): null, nextDue: formatLocalDate(nextDue) }; collections.push(item); persist(COL_KEY, collections); $('#coName').value=''; $('#coAmount').value=''; $('#coFirstDue').value=''; $('#coRecurring').checked=false; $('#coEndAt').value=''; drawCollections(); computeAndUpdateSummary(); });

// draw lists on init
function init(){ loadThemeData(); ensureTransferCategories(); ensureSortedLedger(); drawAccountsList(); drawCatsList(); refreshAccountSelects(); refreshCategorySelect(); refreshLinkCommitOptions(); drawCommitments(); drawCollections(); drawDueSoon(); renderTransactions(); computeAndUpdateSummary(); bindFooter(); gotoPage('dashboard'); setFooterActiveByPage('dashboard'); handleTypeChange(); // Set initial UI state for 'Add' form
}

// safe init
try{ init(); }catch(err){ console.error('init error', err); }

// NEW: Consolidated Filter/Pagination Logic
function filterChanged(e){ 
    currentPage=1; 
    renderTransactions(); 
    if(e?.target?.id === 'fType') refreshCategorySelect();
}

$('#search')?.addEventListener('input', filterChanged); 
$('#fType')?.addEventListener('change', filterChanged); 
$('#fAccount')?.addEventListener('change', filterChanged); 
$('#fFrom')?.addEventListener('change', filterChanged); 
$('#fTo')?.addEventListener('change', filterChanged); 
$('#clearFilters')?.addEventListener('click', ()=>{ 
    $('#search').value=''; 
    $('#fType').value='all'; 
    $('#fAccount').value='all'; 
    $('#fFrom').value=''; 
    $('#fTo').value=''; 
    filterChanged(); 
});

// Added listener for the main transaction type change
$('#type')?.addEventListener('change', handleTypeChange); 

// capture uncaught errors to console
window.addEventListener('error', e=>{ console.error('Unhandled JS Error:', e.message); });

</script>
</body>
</html>
