<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ â€” Dashboard</title>
<!-- Tailwind via CDN for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* tiny custom tweaks for RTL & components */
  :root{--gap:0.75rem}
  .sidebar { min-width:220px; max-width:260px; }
  /* mobile bottom-nav */
  @media(max-width:768px){
    .sidebar { display:none }
    .mobile-nav { display:flex }
  }
  @media(min-width:769px){
    .mobile-nav { display:none }
  }
  /* dark tuning */
  .dark .card { background:#0b1220; border-color:#163145 }
  .dark body { background:#071227; color:#e6f0fb }
  .card { background:var(--card-bg,#fff); border:1px solid var(--card-border,#e6eef8) }
</style>
</head>
<body class="antialiased" id="appRoot">
<div class="min-h-screen flex">
  <!-- Sidebar -->
  <aside class="sidebar bg-slate-50 dark:bg-slate-900 p-4 hidden md:block border-l">
    <div class="mb-6 flex items-center justify-between">
      <div>
        <div class="text-xl font-extrabold">Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</div>
        <div class="text-sm text-slate-500 dark:text-slate-300">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      </div>
      <button id="toggleTheme" class="px-2 py-1 border rounded text-sm">Dark</button>
    </div>

    <nav class="space-y-2 text-right">
      <button data-page="dashboard" class="w-full text-right nav-btn px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button data-page="transactions" class="w-full text-right nav-btn px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">ğŸ“‹ Ø§Ù„Ø­Ø±ÙƒØ§Øª</button>
      <button data-page="add" class="w-full text-right nav-btn px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button data-page="settings" class="w-full text-right nav-btn px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </nav>

    <div class="mt-6 text-sm text-slate-500 dark:text-slate-400">
      <div id="summaryBalance" class="mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©: 0.00 Ø¬.Ù…</div>
      <div id="summaryAfter" class="">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: 0.00 Ø¬.Ù…</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-4">
    <!-- Mobile bottom nav -->
    <div class="mobile-nav fixed bottom-3 left-1/2 -translate-x-1/2 bg-white dark:bg-slate-900 border rounded-xl px-3 py-2 shadow-md z-50">
      <div class="flex gap-2">
        <button data-page="dashboard" class="px-3 py-2 nav-btn rounded">ğŸ </button>
        <button data-page="transactions" class="px-3 py-2 nav-btn rounded">ğŸ“‹</button>
        <button data-page="add" class="px-3 py-2 nav-btn rounded bg-blue-500 text-white">+</button>
        <button data-page="settings" class="px-3 py-2 nav-btn rounded">âš™ï¸</button>
      </div>
    </div>

    <!-- Pages -->
    <section id="page-dashboard" class="page">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-extrabold">Ù„ÙˆØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
      </div>

      <!-- Dashboard grid -->
      <div class="grid gap-4 grid-cols-1 md:grid-cols-3">
        <div class="md:col-span-2">
          <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 mb-4">
            <div class="card p-4 rounded-lg">
              <div class="text-sm text-slate-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©</div>
              <div id="totalBalance" class="text-2xl font-bold mt-2">0.00 Ø¬.Ù…</div>
              <div class="text-xs text-slate-400 mt-2">Ù…Ø¬Ù…ÙˆØ¹ Ø£Ø±ØµØ¯Ø© ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¢Ù†</div>
            </div>

            <div class="card p-4 rounded-lg">
              <div class="text-sm text-slate-500">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
              <div id="balanceAfter" class="text-2xl font-bold mt-2">0.00 Ø¬.Ù…</div>
              <div class="text-xs text-slate-400 mt-2">Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ùˆ Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</div>
            </div>

            <div class="card p-4 rounded-lg">
              <div class="text-sm text-slate-500">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
              <div id="commitThis_total" class="text-xl font-bold mt-2">0.00 Ø¬.Ù…</div>
              <div class="text-xs text-slate-400 mt-2">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="commitThis_remain">0.00</span></div>
            </div>

            <div class="card p-4 rounded-lg">
              <div class="text-sm text-slate-500">ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
              <div id="collectThis_total" class="text-xl font-bold mt-2">0.00 Ø¬.Ù…</div>
              <div class="text-xs text-slate-400 mt-2">Ù„Ù… ÙŠÙØ­ØµÙ‘Ù„: <span id="collectThis_remain">0.00</span></div>
            </div>
          </div>

          <div class="card p-4 rounded-lg mb-4">
            <div class="flex items-center justify-between">
              <div class="font-semibold">Ø¢Ø®Ø± 5 Ø­Ø±ÙƒØ§Øª</div>
              <div class="text-xs text-slate-400">Ù…Ø±ØªØ¨ Ø­Ø³Ø¨ ØªÙ†ÙÙŠØ° (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ù‹Ø§)</div>
            </div>
            <div id="latestTx" class="mt-3 space-y-2"></div>
          </div>

        </div>

        <div>
          <div class="card p-4 rounded-lg mb-4">
            <div class="flex items-center justify-between">
              <div class="font-semibold">Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ù‚Ø±ÙŠØ¨Ø©</div>
              <div class="text-xs text-slate-400">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± / Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…</div>
            </div>
            <div id="dueSoonList" class="mt-3 space-y-2"></div>
          </div>

          <div class="card p-4 rounded-lg">
            <div class="font-semibold">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±</div>
            <canvas id="pieChart" width="300" height="240"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section id="page-transactions" class="page hidden">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-extrabold">Ø§Ù„Ø­Ø±ÙƒØ§Øª</h1>
      </div>

      <div class="card p-4 rounded-lg mb-4">
        <div class="flex gap-2 flex-wrap mb-3">
          <input id="filterSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØµÙ/Ø§Ù„ÙØ¦Ø©" class="border p-2 rounded flex-1" />
          <select id="filterType" class="border p-2 rounded"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="income">Ø¯Ø®Ù„</option><option value="expense">Ù…ØµØ±ÙˆÙ</option></select>
          <select id="filterAccount" class="border p-2 rounded"></select>
          <input id="filterFrom" type="date" class="border p-2 rounded" />
          <input id="filterTo" type="date" class="border p-2 rounded" />
          <button id="clearFilters" class="px-3 py-2 bg-slate-100 rounded">Ù…Ø³Ø­</button>
        </div>

        <div class="overflow-auto">
          <table class="w-full text-right">
            <thead><tr class="text-sm text-slate-500"><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
            <tbody id="txTableBody" class="align-top"></tbody>
          </table>
        </div>

        <div class="flex items-center justify-center gap-2 mt-3">
          <button id="prevPage" class="px-3 py-2 bg-slate-100 rounded">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <div id="pageInfo" class="text-sm text-slate-500">Ø§Ù„ØµÙØ­Ø© 1</div>
          <button id="nextPage" class="px-3 py-2 bg-slate-100 rounded">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>
      </div>
    </section>

    <section id="page-add" class="page hidden">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-extrabold">Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</h1>
      </div>

      <div class="card p-4 rounded-lg">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm">Ø§Ù„Ù†ÙˆØ¹</label>
            <select id="add_type" class="border p-2 rounded w-full"><option value="expense">Ù…ØµØ±ÙˆÙ</option><option value="income">Ø¯Ø®Ù„</option></select>
          </div>
          <div>
            <label class="text-sm">Ø§Ù„Ù…Ø¨Ù„Øº</label>
            <input id="add_amount" type="number" step="0.01" class="border p-2 rounded w-full" />
          </div>
          <div>
            <label class="text-sm">ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="add_exec" type="datetime-local" class="border p-2 rounded w-full" />
          </div>

          <div>
            <label class="text-sm">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ø³ÙŠÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§ Ø¥Ø°Ø§ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„ØªØ²Ø§Ù…)</label>
            <input id="add_date" type="date" class="border p-2 rounded w-full" />
          </div>
          <div>
            <label class="text-sm">Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <select id="add_account" class="border p-2 rounded w-full"></select>
          </div>
          <div>
            <label class="text-sm">Ø§Ù„ÙØ¦Ø©</label>
            <select id="add_category" class="border p-2 rounded w-full"></select>
          </div>

          <div class="md:col-span-2">
            <label class="text-sm">Ø§Ù„ÙˆØµÙ</label>
            <input id="add_desc" class="border p-2 rounded w-full" />
          </div>
          <div>
            <label class="text-sm">Ø±Ø¨Ø· Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <select id="add_linkCommit" class="border p-2 rounded w-full"><option value="">â€” Ø¨Ø¯ÙˆÙ† â€”</option></select>
          </div>

          <div class="md:col-span-3 flex gap-2">
            <button id="add_save" class="px-4 py-2 bg-blue-600 text-white rounded">Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©</button>
            <button id="add_reset" class="px-4 py-2 bg-slate-100 rounded">Ø¥ÙØ±Ø§Øº</button>
          </div>
        </div>
      </div>
    </section>

    <section id="page-settings" class="page hidden">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-extrabold">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="card p-4 rounded-lg">
          <h3 class="font-semibold mb-3">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
          <div class="grid grid-cols-1 gap-2 mb-3">
            <input id="acc_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨" class="border p-2 rounded" />
            <input id="acc_open" placeholder="Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ" type="number" class="border p-2 rounded" />
            <div class="flex gap-2">
              <button id="btn_add_acc" class="px-3 py-2 bg-slate-700 text-white rounded">Ø¥Ø¶Ø§ÙØ©</button>
              <button id="btn_refresh_acc" class="px-3 py-2 bg-slate-100 rounded">ØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>
          <div id="accountsList" class="space-y-2 text-sm"></div>
        </div>

        <div class="card p-4 rounded-lg">
          <h3 class="font-semibold mb-3">Ø§Ù„ÙØ¦Ø§Øª</h3>
          <div class="grid grid-cols-1 gap-2 mb-3">
            <input id="cat_name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©" class="border p-2 rounded" />
            <select id="cat_type" class="border p-2 rounded"><option value="expense">Ù…ØµØ±ÙˆÙ</option><option value="income">Ø¯Ø®Ù„</option></select>
            <div class="flex gap-2">
              <button id="btn_add_cat" class="px-3 py-2 bg-slate-700 text-white rounded">Ø¥Ø¶Ø§ÙØ©</button>
              <button id="btn_refresh_cat" class="px-3 py-2 bg-slate-100 rounded">ØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>
          <div id="catsList" class="space-y-2 text-sm"></div>
        </div>

        <div class="card p-4 rounded-lg">
          <h3 class="font-semibold mb-3">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
          <div class="grid grid-cols-1 gap-2 mb-2">
            <input id="c_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…" class="border p-2 rounded" />
            <input id="c_amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="border p-2 rounded" />
            <input id="c_first" type="date" class="border p-2 rounded" />
            <div class="flex gap-2">
              <label class="inline-flex items-center"><input id="c_rec" type="checkbox" class="mr-2"/>ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠÙ‹Ø§</label>
              <input id="c_end" type="date" class="border p-2 rounded" placeholder="ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ" />
            </div>
            <div class="flex gap-2">
              <button id="btn_add_commit" class="px-3 py-2 bg-slate-700 text-white rounded">Ø¥Ø¶Ø§ÙØ©</button>
              <button id="btn_refresh_commit" class="px-3 py-2 bg-slate-100 rounded">ØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>
          <div id="commitList" class="space-y-2 text-sm"></div>
        </div>

        <div class="card p-4 rounded-lg">
          <h3 class="font-semibold mb-3">Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª</h3>
          <div class="grid grid-cols-1 gap-2 mb-2">
            <input id="col_name" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ­ØµÙŠÙ„" class="border p-2 rounded" />
            <input id="col_amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="border p-2 rounded" />
            <input id="col_first" type="date" class="border p-2 rounded" />
            <div class="flex gap-2">
              <label class="inline-flex items-center"><input id="col_rec" type="checkbox" class="mr-2"/>ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠÙ‹Ø§</label>
              <input id="col_end" type="date" class="border p-2 rounded" placeholder="ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ" />
            </div>
            <div class="flex gap-2">
              <button id="btn_add_col" class="px-3 py-2 bg-slate-700 text-white rounded">Ø¥Ø¶Ø§ÙØ©</button>
              <button id="btn_refresh_col" class="px-3 py-2 bg-slate-100 rounded">ØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>
          <div id="collectList" class="space-y-2 text-sm"></div>
        </div>
      </div>

    </section>

  </main>
</div>

<script>
/* ===== Storage keys ===== */
const KEY='pf_ledger_v2', ACC_KEY='pf_accounts_v2', CAT_KEY='pf_categories_v2', COM_KEY='pf_commitments_v2', COL_KEY='pf_collections_v2', THEME_KEY='pf_theme_v2';
/* ===== Safe parse ===== */
function safeParse(k, fallback){ try{ const s = localStorage.getItem(k); if(!s) return fallback; return JSON.parse(s); }catch(e){ console.warn('corrupt',k); localStorage.removeItem(k); return fallback; } }
let ledger = safeParse(KEY, []);
let accounts = safeParse(ACC_KEY, []);
let categories = safeParse(CAT_KEY, []);
let commitments = safeParse(COM_KEY, []);
let collections = safeParse(COL_KEY, []);
/* defaults */
function ensureDefaults(){
  if(!accounts.length){ accounts = [{name:'ÙƒØ§Ø´',opening:0},{name:'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ',opening:0}]; localSave(ACC_KEY, accounts); }
  if(!categories.length){ categories = [{name:'Ù…Ø±ØªØ¨',type:'income'},{name:'Ø¯Ø®Ù„ Ø¢Ø®Ø±',type:'income'},{name:'Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨',type:'expense'},{name:'Ù…ÙˆØ§ØµÙ„Ø§Øª',type:'expense'},{name:'ÙÙˆØ§ØªÙŠØ±',type:'expense'}]; localSave(CAT_KEY,categories); }
}
ensureDefaults();

/* utils */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const eid = ()=> Math.random().toString(36).slice(2,9)+Date.now().toString(36);
const fmt = n => Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
function persist(key, obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){ console.error(e); } }
function localSave(k,v){ persist(k,v); }

/* sorted ledger cache */
let sortedLedger = []; let isLedgerDirty = true;
function markDirty(){ isLedgerDirty = true; }
function ensureSorted(){
  if(!isLedgerDirty && sortedLedger.length) return;
  sortedLedger = [...ledger].slice().sort((a,b)=>{
    const aKey = (a.exec||a.created||a.date||'');
    const bKey = (b.exec||b.created||b.date||'');
    if(aKey === bKey) return (b.created||'').localeCompare(a.created||'');
    return bKey.localeCompare(aKey);
  });
  isLedgerDirty = false;
}

/* compute balances */
let cachedBalances = null, cachedAfter = null;
function computeBalances(){
  ensureSorted();
  const bal = new Map(accounts.map(a=>[a.name, Number(a.opening||0)]));
  const after = new Map();
  for(const t of sortedLedger){
    const cur = bal.get(t.account) ?? 0;
    const delta = t.type === 'income' ? Number(t.amount||0) : -Number(t.amount||0);
    const next = cur + delta;
    bal.set(t.account, next);
    after.set(t.id, next);
  }
  cachedBalances = bal; cachedAfter = after;
  return {bal,after};
}

/* Commitment state - derived from ledger */
function parseDateYmd(s){ if(!s) return null; const parts=s.split('-').map(Number); if(parts.length<3) return null; return new Date(parts[0],parts[1]-1,parts[2]); }
function addMonthsPreserve(date, months){ const d=new Date(date.getTime()); const targetMonth=d.getMonth()+months; const day=d.getDate(), y=d.getFullYear(); const temp=new Date(y,targetMonth+1,0); const lastDay=temp.getDate(); d.setMonth(targetMonth, Math.min(day,lastDay)); d.setHours(0,0,0,0); return d; }
function formatYmd(dt){ if(!dt) return ''; const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), d=String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }

function getCommitmentState(c){
  if(!c || !c.firstDue) return {done:true};
  const amount = Number(c.amount||0);
  const start = parseDateYmd(c.firstDue);
  if(!start) return {done:true};
  const endDate = c.endAt ? parseDateYmd(c.endAt) : null;
  // collect payments per ym from ledger where linkCommitId === c.id
  const payments = {};
  for(const t of ledger){
    if(t.linkCommitId !== c.id) continue;
    const ym = (t.exec||t.created||t.date||'').slice(0,7);
    if(!ym) continue;
    payments[ym] = (payments[ym]||0) + Number(t.amount||0);
  }
  let cursor = new Date(start.getTime()); cursor.setHours(0,0,0,0);
  for(let i=0;i<500;i++){
    if(endDate && cursor > endDate) return {done:true};
    const ym = formatYmd(cursor).slice(0,7);
    const paidThis = payments[ym]||0;
    if(paidThis + 1e-9 < amount){
      return {currentDueYm: ym, paid: paidThis, remaining: Math.max(0, amount - paidThis)};
    }
    if(!c.recurring) return {done:true};
    cursor = addMonthsPreserve(cursor, 1);
  }
  return {done:true};
}

/* Collections - get collected totals by ym */
function collectedCollectionsForYm(ym){
  let total = 0;
  for(const t of ledger){
    if(t.type !== 'income') continue;
    const when = (t.exec||t.created||t.date||'').slice(0,7);
    if(when !== ym) continue;
    if(t.sourceCollectionId && String(t.sourceCollectionId).startsWith('collect_')) total += Number(t.amount||0);
  }
  return total;
}

/* Draw dashboard */
let pieChart = null;
function drawDashboard(){
  computeBalances();
  // totals
  let totalBal = 0;
  for(const v of (cachedBalances||new Map()).values()) totalBal += v;
  $('#totalBalance').textContent = fmt(totalBal) + ' Ø¬.Ù…';

  const ym = (new Date()).toISOString().slice(0,7);
  const nextYm = (new Date(new Date().getFullYear(), new Date().getMonth()+1,1)).toISOString().slice(0,7);

  // commit this month
  let commitThis_total = 0, commitThis_remain = 0;
  for(const c of commitments){
    const st = getCommitmentState(c);
    if(!st.done && st.currentDueYm === ym){
      commitThis_total += Number(c.amount||0);
      commitThis_remain += Number(st.remaining||0);
    }
  }

  // collections this month
  let collectThis_target = 0;
  for(const c of collections){
    const dueYm = (c.nextDue||c.firstDue||'').slice(0,7);
    if(dueYm === ym) collectThis_target += Number(c.amount||0);
  }
  const collectedThis = collectedCollectionsForYm(ym);
  const collectThis_not = Math.max(0, collectThis_target - collectedThis);

  // next month commitments & collections
  let commitNext_total = 0;
  for(const c of commitments){
    const st = getCommitmentState(c);
    if(!st.done && st.currentDueYm === nextYm) commitNext_total += Number(st.remaining||0);
  }
  let collectNext_total = 0;
  for(const c of collections){ const dueYm = (c.nextDue||c.firstDue||'').slice(0,7); if(dueYm===nextYm) collectNext_total += Number(c.amount||0); }

  // balanceAfter = totalBal - commitThis_remain + collectThis_not
  const after = totalBal - commitThis_remain + collectThis_not;

  $('#balanceAfter').textContent = fmt(after) + ' Ø¬.Ù…';
  $('#commitThis_total').textContent = fmt(commitThis_total) + ' Ø¬.Ù…';
  $('#commitThis_remain').textContent = fmt(commitThis_remain) + ' Ø¬.Ù…';
  $('#collectThis_total').textContent = fmt(collectThis_target) + ' Ø¬.Ù…';
  $('#collectThis_remain').textContent = fmt(collectThis_not) + ' Ø¬.Ù…';
  $('#summaryBalance').textContent = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©: ' + fmt(totalBal) + ' Ø¬.Ù…';
  $('#summaryAfter').textContent = 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ' + fmt(after) + ' Ø¬.Ù…';

  // latest 5 tx
  ensureSorted();
  const latest = sortedLedger.slice(0,5);
  $('#latestTx').innerHTML = latest.map(t=> {
    const execTxt = t.exec ? new Date(t.exec).toLocaleString('ar-EG') : (t.created? new Date(t.created).toLocaleString('ar-EG') : 'â€”');
    return `<div class="flex justify-between items-center"><div><div class="font-semibold">${t.desc||'â€”'}</div><div class="text-xs text-slate-500">${t.category||''} â€¢ ${t.account||''}</div></div><div class="text-right"><div class="${t.type==='income'?'text-green-600':'text-red-600'} font-bold">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div><div class="text-xs text-slate-400">${execTxt}</div></div></div>`;
  }).join('');

  // due soon list
  const dueList = commitments.map(c=>{
    const st = getCommitmentState(c);
    if(st.done) return null;
    return { id:c.id, name:c.name, due:st.currentDueYm, remaining:st.remaining, paid:st.paid };
  }).filter(Boolean).sort((a,b)=> (a.due||'').localeCompare(b.due||''));
  $('#dueSoonList').innerHTML = dueList.slice(0,6).map(d=>`<div class="flex justify-between"><div><div class="font-semibold">${d.name}</div><div class="text-xs text-slate-500">${d.due}</div></div><div class="text-right"><div class="font-bold text-red-600">${fmt(d.remaining)} Ø¬.Ù…</div></div></div>`).join('');

  // pie chart for expense categories this month
  const agg = {};
  const month = ym;
  for(const t of ledger){
    const when = (t.exec||t.created||t.date||'').slice(0,7);
    if(when !== month) continue;
    if(t.type !== 'expense') continue;
    const key = t.category || 'ØºÙŠØ± Ù…ØµÙ†Ù';
    agg[key] = (agg[key]||0) + Number(t.amount||0);
  }
  const labels = Object.keys(agg);
  const data = labels.map(l=>agg[l]);
  const ctx = document.getElementById('pieChart').getContext('2d');
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(ctx, { type:'pie', data:{ labels, datasets:[{data, backgroundColor: labels.map((_,i)=>['#ef4444','#f59e0b','#10b981','#0ea5e9','#7c3aed'][i%5]) }] }, options:{plugins:{legend:{position:'bottom'}}} );
}

/* Transactions page rendering with paging */
let pageSize = 10, currentPage = 1;
function refreshAccountFilter(){
  $('#filterAccount').innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>` + accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
  $('#add_account').innerHTML = accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
  $('#accountsList').innerHTML = accounts.map((a,i)=>`<div class="flex justify-between items-center"><div>${a.name} Â· <span class="text-slate-500">${fmt(a.opening)} Ø¬.Ù…</span></div><div><button data-acc-index="${i}" class="btn-edit-acc text-xs px-2 py-1 bg-slate-100 rounded">ØªØ¹Ø¯ÙŠÙ„</button> <button data-acc-del="${i}" class="btn-del-acc text-xs px-2 py-1 bg-red-100 rounded">Ø­Ø°Ù</button></div></div>`).join('');
}

function refreshCatSelect(){
  $('#add_category').innerHTML = categories.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
  $('#catsList').innerHTML = categories.map((c,i)=>`<div class="flex justify-between items-center"><div>${c.name} Â· <span class="text-slate-500">${c.type}</span></div><div><button data-cat-index="${i}" class="btn-edit-cat text-xs px-2 py-1 bg-slate-100 rounded">ØªØ¹Ø¯ÙŠÙ„</button> <button data-cat-del="${i}" class="btn-del-cat text-xs px-2 py-1 bg-red-100 rounded">Ø­Ø°Ù</button></div></div>`).join('');
}

function refreshCommitList(){
  $('#commitList').innerHTML = commitments.map((c,i)=>{
    const st = getCommitmentState(c);
    const due = st.done ? 'â€”' : (st.currentDueYm || c.firstDue.slice(0,7));
    const rem = st.done ? 0 : (st.remaining||0);
    return `<div class="flex justify-between items-center"><div><div class="font-semibold">${c.name} Â· ${fmt(c.amount)} Ø¬.Ù…</div><div class="text-xs text-slate-500">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚: ${due}</div></div><div><button data-commit-del="${c.id}" class="px-2 py-1 bg-red-100 rounded text-xs">Ø­Ø°Ù</button></div></div>`;
  }).join('');
}

function refreshCollectList(){
  $('#collectList').innerHTML = collections.map((c,i)=>{
    return `<div class="flex justify-between items-center"><div><div class="font-semibold">${c.name} Â· ${fmt(c.amount)} Ø¬.Ù…</div><div class="text-xs text-slate-500">Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…: ${(c.nextDue||c.firstDue||'â€”')}</div></div><div><button data-collect-del="${c.id}" class="px-2 py-1 bg-red-100 rounded text-xs">Ø­Ø°Ù</button></div></div>`;
  }).join('');
}

function renderTransactions(){
  ensureSorted();
  const q = $('#filterSearch').value.trim().toLowerCase();
  const ft = $('#filterType').value;
  const fa = $('#filterAccount').value;
  const ff = $('#filterFrom').value;
  const fto = $('#filterTo').value;
  const rows = sortedLedger.filter(t=>{
    if(q && !((t.desc||'').toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q))) return false;
    if(ft !== 'all' && t.type !== ft) return false;
    if(fa !== 'all' && t.account !== fa) return false;
    if(ff && (t.date||'') < ff) return false;
    if(fto && (t.date||'') > fto) return false;
    return true;
  });
  const total = rows.length;
  const pages = Math.max(1, Math.ceil(total/pageSize));
  if(currentPage > pages) currentPage = pages;
  const start = (currentPage-1)*pageSize;
  const pageRows = rows.slice(start, start+pageSize);
  $('#txTableBody').innerHTML = pageRows.map(t=>{
    const execTxt = t.exec ? new Date(t.exec).toLocaleString('ar-EG') : (t.created? new Date(t.created).toLocaleString('ar-EG') : 'â€”');
    return `<tr class="border-b"><td class="p-2">${execTxt}</td><td class="p-2">${t.date||'â€”'}</td><td class="p-2">${t.desc||'â€”'}</td><td class="p-2">${t.category||'â€”'}</td><td class="p-2">${t.account||'â€”'}</td><td class="p-2 font-bold ${t.type==='income'?'text-green-600':'text-red-600'}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td><td class="p-2"><button data-edit-id="${t.id}" class="px-2 py-1 bg-slate-100 rounded text-xs">ØªØ¹Ø¯ÙŠÙ„</button> <button data-del-id="${t.id}" class="px-2 py-1 bg-red-100 rounded text-xs">Ø­Ø°Ù</button></td></tr>`;
  }).join('');
  $('#pageInfo').textContent = `Ø§Ù„ØµÙØ­Ø© ${currentPage} Ù…Ù† ${pages} â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${total}`;
}

/* add tx */
$('#add_save').addEventListener('click', ()=>{
  const type = $('#add_type').value;
  const amount = Number($('#add_amount').value||0);
  const exec = $('#add_exec').value ? new Date($('#add_exec').value).toISOString() : null;
  const date = $('#add_date').value || (exec? new Date(exec).toISOString().slice(0,10) : new Date().toISOString().slice(0,10));
  const account = $('#add_account').value;
  const category = $('#add_category').value;
  const desc = $('#add_desc').value || '';
  const linkCommit = $('#add_linkCommit').value || '';
  if(!account || !category || !amount || amount<=0){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨/Ø§Ù„ÙØ¦Ø©/Ø§Ù„Ù…Ø¨Ù„Øº'); return; }
  const tx = { id:eid(), created: new Date().toISOString(), exec: exec || new Date().toISOString(), date: date, desc, type, amount: Number(amount), account, category };
  if(linkCommit && type==='expense'){ tx.linkCommitId = linkCommit; }
  // if linkCommit -> keep source of truth; payments inferred from ledger
  ledger.push(tx); persist(KEY, ledger); markDirty(); renderAll();
  // clear
  $('#add_amount').value=''; $('#add_exec').value=''; $('#add_date').value=''; $('#add_desc').value=''; $('#add_linkCommit').value='';
});

/*Paging and filters events*/
$('#filterSearch').addEventListener('input', ()=>{ currentPage = 1; renderTransactions(); });
$('#filterType').addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); });
$('#filterAccount').addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); });
$('#filterFrom').addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); });
$('#filterTo').addEventListener('change', ()=>{ currentPage = 1; renderTransactions(); });
$('#clearFilters').addEventListener('click', ()=>{ $('#filterSearch').value=''; $('#filterType').value='all'; $('#filterAccount').value='all'; $('#filterFrom').value=''; $('#filterTo').value=''; currentPage=1; renderTransactions(); });
$('#prevPage').addEventListener('click', ()=>{ if(currentPage>1) currentPage--; renderTransactions(); });
$('#nextPage').addEventListener('click', ()=>{ currentPage++; renderTransactions(); });

/* edit / del via delegation */
document.addEventListener('click', (e)=>{
  const del = e.target.closest('[data-del-id]');
  const edit = e.target.closest('[data-edit-id]');
  if(del){ const id = del.getAttribute('data-del-id'); if(confirm('Ø­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')){ ledger = ledger.filter(t=>t.id!==id); persist(KEY, ledger); markDirty(); renderAll(); } }
  if(edit){ const id = edit.getAttribute('data-edit-id'); const tx = ledger.find(t=>t.id===id); if(!tx) return; // populate add form for editing
    $('#add_type').value = tx.type; $('#add_amount').value = tx.amount; if(tx.exec) { const d = new Date(tx.exec); const tz = d.getTimezoneOffset()*60000; const local = new Date(d - tz).toISOString().slice(0,16); $('#add_exec').value = local; } else $('#add_exec').value=''; $('#add_date').value = tx.date || ''; $('#add_account').value = tx.account || ''; $('#add_category').value = tx.category || ''; $('#add_desc').value = tx.desc || ''; $('#add_linkCommit').value = tx.linkCommitId||''; // remove old and open add page to edit - simpler: delete old and user saves new
    if(confirm('Ø³ØªÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸. Ù…ÙˆØ§ÙÙ‚ØŸ')){ ledger = ledger.filter(t=>t.id!==id); persist(KEY, ledger); markDirty(); renderAll(); gotoPage('add'); } }
});

/* accounts management */
$('#btn_add_acc').addEventListener('click', ()=>{
  const name = $('#acc_name').value.trim(); const opening = Number($('#acc_open').value||0);
  if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'); return; }
  accounts.push({name, opening: Number(opening||0)}); persist(ACC_KEY, accounts); refreshAccountFilter(); renderAll();
  $('#acc_name').value=''; $('#acc_open').value='';
});

/* categories */
$('#btn_add_cat').addEventListener('click', ()=>{
  const name = $('#cat_name').value.trim(); const type = $('#cat_type').value;
  if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©'); return; }
  categories.push({name,type}); persist(CAT_KEY, categories); refreshCatSelect(); renderAll();
  $('#cat_name').value='';
});

/* commitments */
$('#btn_add_commit').addEventListener('click', ()=>{
  const name = $('#c_name').value.trim(); const amount = Number($('#c_amount').value||0); const first = $('#c_first').value; const rec = $('#c_rec').checked; const end = $('#c_end').value||null;
  if(!name || !amount || !first){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… + Ù…Ø¨Ù„Øº + ØªØ§Ø±ÙŠØ®'); return; }
  // compute nextDue as first or advanced to current month
  let firstDate = parseDateYmd(first);
  let next = new Date(firstDate.getTime()); next.setHours(0,0,0,0);
  const today = new Date(); today.setHours(0,0,0,0);
  while(next < today){
    const candidate = addMonthsPreserve(next,1);
    if(rec && end && candidate > parseDateYmd(end)) break;
    next = candidate;
    if(!rec) break;
  }
  const commit = { id: eid(), name, amount: Number(amount), firstDue: formatYmd(firstDate), recurring: !!rec, endAt: rec ? (end||null): null, nextDue: formatYmd(next) };
  commitments.push(commit); persist(COM_KEY, commitments); refreshCommitList(); renderAll();
  $('#c_name').value=''; $('#c_amount').value=''; $('#c_first').value=''; $('#c_rec').checked=false; $('#c_end').value='';
});

/* collections */
$('#btn_add_col').addEventListener('click', ()=>{
  const name = $('#col_name').value.trim(); const amount = Number($('#col_amount').value||0); const first = $('#col_first').value; const rec = $('#col_rec').checked; const end = $('#col_end').value||null;
  if(!name || !amount || !first){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… + Ù…Ø¨Ù„Øº + ØªØ§Ø±ÙŠØ®'); return; }
  let firstDate = parseDateYmd(first);
  let next = new Date(firstDate.getTime()); next.setHours(0,0,0,0);
  const today = new Date(); today.setHours(0,0,0,0);
  while(next < today){
    const candidate = addMonthsPreserve(next,1);
    if(rec && end && candidate > parseDateYmd(end)) break;
    next = candidate;
    if(!rec) break;
  }
  const item = { id: eid(), name, amount: Number(amount), firstDue: formatYmd(firstDate), recurring: !!rec, endAt: rec ? (end||null): null, nextDue: formatYmd(next) };
  collections.push(item); persist(COL_KEY, collections); refreshCollectList(); renderAll();
  $('#col_name').value=''; $('#col_amount').value=''; $('#col_first').value=''; $('#col_rec').checked=false; $('#col_end').value='';
});

/* handle deletions from lists */
document.addEventListener('click', (e)=>{
  const accDel = e.target.closest('[data-acc-del]');
  if(accDel){ const i=Number(accDel.getAttribute('data-acc-del')); if(confirm('Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ Ù„Ù† ØªÙØ­Ø°Ù Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.')){ accounts.splice(i,1); persist(ACC_KEY, accounts); refreshAccountFilter(); renderAll(); } }
  const catDel = e.target.closest('[data-cat-del]');
  if(catDel){ const i=Number(catDel.getAttribute('data-cat-del')); if(confirm('Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©ØŸ')){ categories.splice(i,1); persist(CAT_KEY,categories); refreshCatSelect(); renderAll(); } }
  const commitDel = e.target.closest('[data-commit-del]');
  if(commitDel){ const id = commitDel.getAttribute('data-commit-del'); if(confirm('Ø­Ø°Ù Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…ØŸ (Ø³ÙŠØ¨Ù‚Ù‰ Ø£ÙŠ Ø¯ÙØ¹Ø§Øª Ø³ÙØ¬Ù„Øª ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ§Øª ÙƒÙ…Ø§ Ù‡ÙŠ)')){ commitments = commitments.filter(c=>c.id!==id); persist(COM_KEY, commitments); refreshCommitList(); renderAll(); } }
  const collectDel = e.target.closest('[data-collect-del]');
  if(collectDel){ const id = collectDel.getAttribute('data-collect-del'); if(confirm('Ø­Ø°Ù Ø§Ù„ØªØ­ØµÙŠÙ„ØŸ')){ collections = collections.filter(c=>c.id!==id); persist(COL_KEY, collections); refreshCollectList(); renderAll(); } }
});

/* collect now action: converts collection to ledger income and advances nextDue or removes */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-collect-now]');
  if(btn){
    const id = btn.getAttribute('data-collect-now');
    const c = collections.find(x=>x.id===id); if(!c) return;
    const accIndex = prompt('Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„ØªØ­ØµÙŠÙ„ Ø¥Ù„ÙŠÙ‡:\n' + accounts.map((a,i)=>`${i+1}. ${a.name}`).join('\n'));
    if(!accIndex) return;
    const idx = parseInt(accIndex,10)-1; if(isNaN(idx)||!accounts[idx]){ alert('Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­'); return; }
    const accName = accounts[idx].name;
    const execISO = new Date().toISOString();
    const due = c.nextDue || c.firstDue || execISO.slice(0,10);
    ledger.push({ id:eid(), created: new Date().toISOString(), exec: execISO, date: due, desc: `${c.name} (ØªØ­ØµÙŠÙ„)`, type:'income', amount:c.amount, account:accName, category:'ØªØ­ØµÙŠÙ„Ø§Øª Ø´Ù‡Ø±ÙŠØ©', sourceCollectionId:`collect_${c.id}`});
    persist(KEY, ledger); markDirty();
    if(c.recurring){ const next = addMonthsPreserve(parseDateYmd(c.nextDue||c.firstDue),1); if(c.endAt && next > parseDateYmd(c.endAt)){ collections = collections.filter(x=>x.id!==id); } else { const it = collections.find(x=>x.id===id); if(it) it.nextDue = formatYmd(next); } } else { collections = collections.filter(x=>x.id!==id); }
    persist(COL_KEY, collections); refreshCollectList(); renderAll();
  }
});

/* "pay commit" buttons in lists handled via add transaction by linking commit on add form for simplicity */

/* navigation */
function gotoPage(p){
  $$('.page').forEach(el=>el.classList.add('hidden'));
  $(`#page-${p}`).classList.remove('hidden');
}
$$('.nav-btn').forEach(b=>b.addEventListener('click', ()=>{ gotoPage(b.getAttribute('data-page')); }));

/* theme toggle */
function initTheme(){
  const t = localStorage.getItem(THEME_KEY) || 'light';
  if(t === 'dark') document.documentElement.classList.add('dark'), $('#toggleTheme').textContent='Light';
  else document.documentElement.classList.remove('dark'), $('#toggleTheme').textContent='Dark';
}
$('#toggleTheme').addEventListener('click', ()=>{
  const dark = document.documentElement.classList.toggle('dark');
  localStorage.setItem(THEME_KEY, dark? 'dark':'light');
  $('#toggleTheme').textContent = dark? 'Light':'Dark';
});

/* initial render helpers */
function markDirty(){ isLedgerDirty=true; }
function renderAll(){
  markDirty(); ensureSorted(); computeBalances(); drawDashboard(); refreshAccountFilter(); refreshCatSelect(); refreshCommitList(); refreshCollectList(); renderTransactions();
}
initTheme();
renderAll();

/* initial page */
gotoPage('dashboard');

/* small housekeeping: fill add_linkCommit with current month's available commitments */
function refreshLinkCommitOptions(){
  const ym = (new Date()).toISOString().slice(0,7);
  const opts = commitments.filter(c=>{ const st = getCommitmentState(c); return !st.done && st.currentDueYm === ym; }).map(c => `<option value="${c.id}">${c.name} â€” Ø£ØµÙ„ ${fmt(c.amount)} â€¢ Ù…ØªØ¨Ù‚ÙŠ ${fmt(getCommitmentState(c).remaining||0)}</option>`).join('');
  $('#add_linkCommit').innerHTML = `<option value="">â€” Ø¨Ø¯ÙˆÙ† â€”</option>` + opts;
}
setInterval(refreshLinkCommitOptions, 2000);

/* expose a global save for debugging (optional) */
window.app = { ledger, accounts, categories, commitments, collections, persist, renderAll };

</script>
</body>
</html>