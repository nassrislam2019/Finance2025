<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساباتي</title>
<meta name="theme-color" content="#0b1220" />

<link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">
<link rel="apple-touch-icon" href="./icons/icon-512.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- Fixed Cairo font weights to explicit list to ensure proper loading -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;600;700;900&display=swap" rel="stylesheet">

<style>
:root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--txt:#e5e7eb;--brand:#0369a1;--brand-2:#0ea5e9;--danger:#ef4444;--ok:#22c55e;--border:#1f2a44;--field-bg:#0b1220}
body[data-theme="light"]{--bg:#f8fafc;--card:#fff;--muted:#64748b;--txt:#1e293b;--brand-2:#1493e8;--border:#e2e8f0;--field-bg:#f1f5f9}
:root{--radius:12px;--field-h:42px;--shadow:0 8px 24px rgba(2,6,23,0.5)}
*{box-sizing:border-box}
/* Force Cairo on all elements to avoid fallback rendering issues */
html,body,input,select,textarea,button{font-family:'Cairo', sans-serif !important;}

body{margin:0;padding-bottom:60px;background:var(--bg);color:var(--txt);min-height:100vh}
.container{max-width:1180px;margin-inline:auto;padding:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:0;overflow:hidden;box-shadow:var(--shadow);margin-bottom:12px}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
.card-head h3{margin:0}
.card-body{padding:14px}
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.transfer-grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
.transfer-grid .full{grid-column:1/-1}
.list-plain{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.stat{background:var(--field-bg);border:1px solid var(--border);border-radius:var(--radius);padding:14px;text-align:center}
.stat .num{font-weight:800;font-size:22px;margin-top:4px}
.pos{color:var(--ok)}.neg{color:var(--danger)}
.footer-nav{position:fixed;bottom:0;right:0;left:0;height:56px;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;z-index:1000}
.footer-nav button{flex:1;border:none;background:transparent;color:var(--muted);font-size:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer}
.footer-nav button.active{color:var(--brand-2)}
.screen{display:none;padding-top:12px}
.screen.active{display:block}
#themeToggle{position:fixed;top:10px;right:10px;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--card);border:1px solid var(--border);cursor:pointer;z-index:1001}
#backBtn{position:fixed;top:10px;left:10px;width:70px;height:40px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer;z-index:1001}
input,select,textarea{width:100%;background:var(--field-bg);color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;height:var(--field-h)}
.actions .btn{height:30px;padding:6px 8px;font-size:13px;border-radius:8px}
.btn{appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-danger{background:linear-gradient(180deg,#ef4444,#d02626);color:#fff}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body data-theme="dark">
<div class="container">
  <header style="display:flex;align-items:center;justify-content:space-between;gap:10px">
    <div style="font-weight:900;font-size:22px">دفتر حساباتي</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="exportJson" class="btn btn-outline">تصدير JSON</button>
      <label class="btn btn-outline" style="cursor:pointer">استيراد JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
      <button id="syncNow" class="btn btn-primary">مزامنة الآن</button>
    </div>
  </header>

  <button id="themeToggle" title="تبديل الثيم"><i class="fas fa-sun"></i></button>
  <button id="backBtn" style="display:none">راجع</button>

  <!-- Overview -->
  <div id="screen-overview" class="screen active">
    <div class="card">
      <div class="card-head"><h3>إجمالي الحسابات</h3></div>
      <div class="card-body">
        <div id="totalStats" class="grid"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-head"><h3>حركات الشهر الحالي</h3></div>
      <div class="card-body"><canvas id="monthlyChart"></canvas></div>
    </div>
  </div>

  <!-- Transactions -->
  <div id="screen-txs" class="screen">
    <h3>إضافة حركة جديدة</h3>
    <form id="txForm" class="card card-body">
      <div class="transfer-grid">
        <div>
          <label>النوع</label>
          <select id="txType"><option value="expense">مصروف</option><option value="income">دخل</option><option value="transfer">تحويل</option></select>
        </div>
        <div>
          <label>التاريخ</label>
          <input type="date" id="txDate">
        </div>
        <div>
          <label>المبلغ</label>
          <input type="number" id="txAmount" placeholder="0.00" step="0.01">
        </div>
        <div id="txSourceWrap">
          <label>من حساب</label>
          <select id="txSource"></select>
        </div>
        <div id="txTargetWrap">
          <label>إلى حساب</label>
          <select id="txTarget"></select>
        </div>
        <div id="txCatWrap">
          <label>الفئة</label>
          <select id="txCat"></select>
        </div>
        <div class="full">
          <label>ملاحظات</label>
          <input id="txNote" type="text">
        </div>
        <div class="full"><button class="btn btn-primary" type="submit">حفظ الحركة</button></div>
      </div>
    </form>

    <h3 style="margin-top:16px">سجل الحركات</h3>
    <div class="card"><div class="card-body"><table style="width:100%;text-align:right"><thead><tr><th>التاريخ</th><th>النوع</th><th>القيمة</th><th>حساب/فئة</th><th>عمليات</th></tr></thead><tbody id="tbodyTxs"></tbody></table></div></div>
  </div>

  <!-- Accounts -->
  <div id="screen-accounts" class="screen">
    <h3>إضافة حساب جديد</h3>
    <form id="accountForm" class="card card-body grid grid-2">
      <div><label>اسم الحساب</label><input id="accName" required></div>
      <div><label>الرصيد الابتدائي</label><input id="accInitial" type="number" step="0.01"></div>
      <div class="full"><button class="btn btn-primary" type="submit">إضافة حساب</button></div>
    </form>

    <h3 style="margin-top:16px">قائمة الحسابات</h3>
    <div id="accountsList" class="list-plain"></div>
  </div>

  <!-- Categories -->
  <div id="screen-cats" class="screen">
    <h3>إضافة فئة جديدة</h3>
    <form id="catForm" class="card card-body grid grid-2">
      <div><label>اسم الفئة</label><input id="catName" required></div>
      <div><label>نوع الفئة</label><select id="catType"><option value="expense">مصروف</option><option value="income">دخل</option></select></div>
      <div class="full"><button class="btn btn-primary" type="submit">إضافة فئة</button></div>
    </form>

    <h3 style="margin-top:16px">قائمة الفئات</h3>
    <div class="card"><div class="card-body"><table style="width:100%;text-align:right"><thead><tr><th>الاسم</th><th>النوع</th><th>عمليات</th></tr></thead><tbody id="tbodyCats"></tbody></table></div></div>
  </div>

  <!-- GitHub -->
  <div id="screen-github" class="screen">
    <div class="card card-body">
      <h3>إعدادات المزامنة</h3>
      <div class="grid grid-2"><div><label>صاحب المستودع</label><input id="repoOwner" value="nassrislam2019" readonly></div><div><label>اسم المستودع</label><input id="repoName" value="Finance2025" readonly></div></div>
      <div style="margin-top:10px"><label>GitHub Token</label><input id="githubToken" type="password"></div>
      <div style="margin-top:10px"><button id="saveGithubSettings" class="btn btn-primary">حفظ</button></div>
      <p id="githubStatus" style="margin-top:8px;color:var(--muted)">حالة المزامنة: غير متصل</p>
    </div>
  </div>

</div>

<nav class="footer-nav nav-tabs">
  <button data-screen="screen-overview" class="active"><i class="fas fa-chart-pie"></i><span>ملخص</span></button>
  <button data-screen="screen-txs" data-screen-idx="1"><i class="fas fa-exchange-alt"></i><span>حركات</span></button>
  <button data-screen="screen-accounts" data-screen-idx="2"><i class="fas fa-wallet"></i><span>حسابات</span></button>
  <button data-screen="screen-cats" data-screen-idx="3"><i class="fas fa-tags"></i><span>فئات</span></button>
  <button data-screen="screen-github" data-screen-idx="4"><i class="fas fa-cog"></i><span>إعدادات</span></button>
</nav>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script>
// ===== App state =====
let financeData = {accounts:[],categories:[],transactions:[],commitments:[]};
const STORAGE_KEY = 'my-finance-data';
const screenHistory = [];

// ===== Navigation =====
function showScreen(id, push=true){
  const target = document.getElementById(id);
  if(!target) return;
  const current = document.querySelector('.screen.active');
  if(current && current.id === id) return;
  if(push && current) screenHistory.push(current.id);
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  target.classList.add('active');
  document.querySelectorAll('.footer-nav button').forEach(b=>b.classList.remove('active'));
  const btn = document.querySelector(`.footer-nav button[data-screen="${id}"]`);
  if(btn) btn.classList.add('active');
  document.getElementById('backBtn').style.display = screenHistory.length ? 'block' : 'none';
}

document.getElementById('backBtn').addEventListener('click', ()=>{ if(screenHistory.length===0) return; const prev = screenHistory.pop(); showScreen(prev,false); });

document.querySelectorAll('.footer-nav button').forEach(btn=>{ btn.addEventListener('click', ()=>{ const id = btn.getAttribute('data-screen'); showScreen(id); }); });

// ===== Theme =====n
document.getElementById('themeToggle').addEventListener('click', ()=>{ const body=document.body; const newTheme=body.getAttribute('data-theme')==='dark'?'light':'dark'; body.setAttribute('data-theme',newTheme); document.getElementById('themeToggle').querySelector('i').className=newTheme==='dark'?'fas fa-sun':'fas fa-moon'; localStorage.setItem('theme',newTheme); });

document.addEventListener('DOMContentLoaded', ()=>{ const saved=localStorage.getItem('theme')||'dark'; document.body.setAttribute('data-theme',saved); document.getElementById('themeToggle').querySelector('i').className=saved==='dark'?'fas fa-sun':'fas fa-moon'; document.getElementById('txDate').value=new Date().toISOString().slice(0,10); loadData(); });

// ===== Storage =====
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(financeData)); renderAll(); }

function loadData(){ const localData=localStorage.getItem(STORAGE_KEY); if(localData){ try{ const ld=JSON.parse(localData); financeData=Object.assign({},financeData,ld); }catch(e){console.error('parse error',e);} }
 // ensure arrays
 financeData.accounts=Array.isArray(financeData.accounts)?financeData.accounts:[];
 financeData.categories=Array.isArray(financeData.categories)?financeData.categories:[];
 financeData.transactions=Array.isArray(financeData.transactions)?financeData.transactions:[];
 financeData.commitments=Array.isArray(financeData.commitments)?financeData.commitments:[];
 // normalize accounts
 financeData.accounts=financeData.accounts.map(acc=>({ id:acc.id||('a'+Date.now()+Math.random().toString(36).slice(2,6)), name:acc.name||'حساب', initialBalance: typeof acc.initialBalance==='number'? acc.initialBalance: (parseFloat(acc.initialBalance)||0), balance: typeof acc.balance==='number'? acc.balance: (parseFloat(acc.balance)|| (parseFloat(acc.initialBalance)||0)) }));
 if(financeData.accounts.length===0){ financeData.accounts=[{id:'a'+Date.now(),name:'المحفظة',initialBalance:0,balance:0}]; financeData.categories=[{id:'c'+Date.now(),name:'مصروفات عامة',type:'expense'},{id:'c'+(Date.now()+1),name:'دخل شهري',type:'income'}]; }
 renderAll(); }

// ===== Calculations & rendering =====
function calculateBalances(){ financeData.accounts.forEach(acc=>{ acc.initialBalance= typeof acc.initialBalance==='number'?acc.initialBalance:(parseFloat(acc.initialBalance)||0); acc.balance=acc.initialBalance; }); financeData.transactions.sort((a,b)=>new Date(a.date)-new Date(b.date)); financeData.transactions.forEach(tx=>{ const amt= typeof tx.amount==='number'?tx.amount:(parseFloat(tx.amount)||0); const source=financeData.accounts.find(a=>a.id===tx.source); const target=financeData.accounts.find(a=>a.id===tx.target); if(tx.type==='expense'){ if(source) source.balance-=amt; } else if(tx.type==='income'){ if(target) target.balance+=amt; } else if(tx.type==='transfer'){ if(source) source.balance-=amt; if(target) target.balance+=amt; } }); }

function renderOverview(){ calculateBalances(); const totalStats=document.getElementById('totalStats'); totalStats.innerHTML=''; let totalAssets=0; financeData.accounts.forEach(acc=> totalAssets+= (typeof acc.balance==='number'?acc.balance:(parseFloat(acc.balance)||0))); const totalIncome=financeData.transactions.filter(tx=>tx.type==='income').reduce((s,tx)=>s+((typeof tx.amount==='number')?tx.amount:(parseFloat(tx.amount)||0)),0); const totalExpense=financeData.transactions.filter(tx=>tx.type==='expense').reduce((s,tx)=>s+((typeof tx.amount==='number')?tx.amount:(parseFloat(tx.amount)||0)),0); totalStats.innerHTML+=`<div class="stat"><small>إجمالي الأصول</small><div class="num ${totalAssets>=0?'pos':'neg'}">${totalAssets.toFixed(2)}</div></div><div class="stat"><small>إجمالي الدخل</small><div class="num pos">${totalIncome.toFixed(2)}</div></div><div class="stat"><small>إجمالي المصروفات</small><div class="num neg">${totalExpense.toFixed(2)}</div></div>`; }

function updateFormSelects(){ const source=document.getElementById('txSource'); const target=document.getElementById('txTarget'); const cat=document.getElementById('txCat'); source.innerHTML='<option value="">اختر حساب</option>'; target.innerHTML='<option value="">اختر حساب</option>'; cat.innerHTML='<option value="">اختر فئة</option>'; financeData.accounts.forEach(a=>{ source.innerHTML+=`<option value="${a.id}">${a.name}</option>`; target.innerHTML+=`<option value="${a.id}">${a.name}</option>`; }); financeData.categories.forEach(c=>{ cat.innerHTML+=`<option value="${c.id}">${c.name} (${c.type==='expense'?'مصروف':'دخل'})</option>`; }); const txType=document.getElementById('txType').value; document.getElementById('txSourceWrap').style.display = txType==='income'?'none':'block'; document.getElementById('txTargetWrap').style.display = txType==='expense'?'none':'block'; document.getElementById('txCatWrap').style.display = txType==='transfer'?'none':'block'; document.getElementById('txSource').required = txType!=='income'; document.getElementById('txTarget').required = txType!=='expense'; }

function renderTxs(){ const tbody=document.getElementById('tbodyTxs'); tbody.innerHTML=''; financeData.transactions.slice().reverse().forEach(tx=>{ const sourceName=tx.source?financeData.accounts.find(a=>a.id===tx.source)?.name||'N/A':''; const targetName=tx.target?financeData.accounts.find(a=>a.id===tx.target)?.name||'N/A':''; const catName=tx.category?financeData.categories.find(c=>c.id===tx.category)?.name||'N/A':''; let info=''; let cls='neg'; if(tx.type==='expense'){ info=`${catName} / ${sourceName}`; cls='neg'; } else if(tx.type==='income'){ info=`${catName} / ${targetName}`; cls='pos'; } else{ info=`من: ${sourceName} إلى: ${targetName}`; cls='pos'; } const amt = (typeof tx.amount==='number')?tx.amount:(parseFloat(tx.amount)||0); const tr=document.createElement('tr'); tr.innerHTML=`<td>${tx.date}</td><td>${tx.type==='expense'?'مصروف':tx.type==='income'?'دخل':'تحويل'}</td><td class="${cls}">${amt.toFixed(2)}</td><td>${info}</td><td class="actions"><button class="btn btn-danger" onclick="deleteTx('${tx.id}')">حذف</button></td>`; tbody.appendChild(tr); }); updateFormSelects(); }

function renderAccounts(){ const wrap=document.getElementById('accountsList'); wrap.innerHTML=''; financeData.accounts.forEach(acc=>{ const bal=(typeof acc.balance==='number')?acc.balance:(parseFloat(acc.balance)||0); const cls=bal>=0?'pos':'neg'; wrap.innerHTML+=`<div class="item"><div style="font-weight:700">${acc.name}</div><div style="margin-top:8px" class="num ${cls}">${bal.toFixed(2)}</div><div style="margin-top:8px"><button class="btn btn-outline" onclick="deleteAccount('${acc.id}')">حذف</button></div></div>`; }); }

function renderCats(){ const tb=document.getElementById('tbodyCats'); tb.innerHTML=''; financeData.categories.forEach(cat=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${cat.name}</td><td>${cat.type==='expense'?'مصروف':'دخل'}</td><td class="actions"><button class="btn btn-danger" onclick="deleteCategory('${cat.id}')">حذف</button></td>`; tb.appendChild(tr); }); }

function renderAll(){ calculateBalances(); renderOverview(); renderTxs(); renderAccounts(); renderCats(); }

// ===== CRUD =====
document.getElementById('accountForm').addEventListener('submit', e=>{ e.preventDefault(); const name=document.getElementById('accName').value; const initial=parseFloat(document.getElementById('accInitial').value)||0; financeData.accounts.push({id:'a'+Date.now(),name,initialBalance:initial,balance:initial}); saveData(); e.target.reset(); });
function deleteAccount(id){ if(confirm('هل تريد حذف الحساب؟')){ financeData.accounts=financeData.accounts.filter(a=>a.id!==id); financeData.transactions=financeData.transactions.filter(tx=>tx.source!==id&&tx.target!==id); saveData(); }}

document.getElementById('catForm').addEventListener('submit', e=>{ e.preventDefault(); const name=document.getElementById('catName').value; const type=document.getElementById('catType').value; financeData.categories.push({id:'c'+Date.now(),name,type}); saveData(); e.target.reset(); });
function deleteCategory(id){ if(confirm('هل تريد حذف الفئة؟')){ financeData.categories=financeData.categories.filter(c=>c.id!==id); financeData.transactions.forEach(tx=>{ if(tx.category===id) tx.category=null; }); saveData(); }}

document.getElementById('txType').addEventListener('change', updateFormSelects);
document.getElementById('txForm').addEventListener('submit', e=>{ e.preventDefault(); const txType=document.getElementById('txType').value; const date=document.getElementById('txDate').value||new Date().toISOString().slice(0,10); const amount=parseFloat(document.getElementById('txAmount').value); const source=document.getElementById('txSource').value; const target=document.getElementById('txTarget').value; const category=document.getElementById('txCat').value; const note=document.getElementById('txNote').value; if(isNaN(amount)||amount<=0){ alert('الرجاء إدخال مبلغ صحيح'); return; } if(txType==='transfer'&&source===target){ alert('المصدر والهدف لا يمكن أن يكونا نفس الحساب'); return; } financeData.transactions.push({id:'t'+Date.now(),type:txType,date,amount,source:txType!=='income'?source:null,target:txType!=='expense'?target:null,category:txType==='transfer'?null:category,note}); saveData(); e.target.reset(); document.getElementById('txDate').value=new Date().toISOString().slice(0,10); });
function deleteTx(id){ if(confirm('هل تريد حذف الحركة؟')){ financeData.transactions=financeData.transactions.filter(t=>t.id!==id); saveData(); }}

// ===== Export/Import =====
document.getElementById('exportJson').addEventListener('click', ()=>{ const dataStr=JSON.stringify(financeData,null,2); const uri='data:application/json;charset=utf-8,'+encodeURIComponent(dataStr); const a=document.createElement('a'); a.href=uri; a.download='my-finance-export.json'; a.click(); });
document.getElementById('importFile').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=function(evt){ try{ const d=JSON.parse(evt.target.result); if(d.accounts&&d.transactions){ d.accounts=d.accounts.map(acc=>({ id:acc.id||('a'+Date.now()+Math.random().toString(36).slice(2,6)), name:acc.name||'حساب', initialBalance:typeof acc.initialBalance==='number'?acc.initialBalance:(parseFloat(acc.initialBalance)||0), balance:typeof acc.balance==='number'?acc.balance:(parseFloat(acc.balance)||(parseFloat(acc.initialBalance)||0)) })); d.categories=Array.isArray(d.categories)?d.categories:[]; d.transactions=Array.isArray(d.transactions)?d.transactions:[]; if(confirm('سيؤدي الاستيراد إلى استبدال البيانات الحالية. متابعة؟')){ financeData=d; saveData(); alert('تم الاستيراد'); } } else alert('صيغة JSON غير صحيحة'); }catch(err){ alert('خطأ في قراءة الملف: '+err.message); } }; r.readAsText(f); });

// ===== GitHub sync placeholders (unchanged behavior) =====
document.getElementById('saveGithubSettings')?.addEventListener('click', ()=>{ const token=document.getElementById('githubToken').value; if(token){ localStorage.setItem('githubToken',token); alert('تم الحفظ'); } else alert('أدخل التوكن'); });
document.getElementById('syncNow').addEventListener('click', ()=>{ alert('ستعمل المزامنة إذا رغبت بإضافة GitHub token والعمل عليه.'); });

// ===== Init =====
// set default date for tx form
try{ document.getElementById('txDate').value=new Date().toISOString().slice(0,10); }catch(e){}
loadData();
</script>
</body>
</html>
