<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abou Tia Finance</title>
    <style>
        /* --- CSS STYLING --- */
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .dark {
            --primary: #6366f1;
            --primary-light: #312e81;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --text-sub: #94a3b8;
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; transition: background 0.2s, color 0.2s; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }
        
        /* Typography */
        h1, h2, h3 { margin: 0; }
        .text-xl { font-size: 20px; font-weight: 700; }
        .text-lg { font-size: 18px; font-weight: 700; }
        .text-sm { font-size: 14px; }
        .text-xs { font-size: 12px; }
        .text-sub { color: var(--text-sub); }
        .bold { font-weight: 700; }
        .uppercase { text-transform: uppercase; }
        
        /* Components */
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 16px; border: 1px solid var(--border); }
        .btn { border: none; padding: 12px 16px; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 14px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        
        /* Header & Nav */
        header { position: sticky; top: 0; background: var(--card); padding: 16px; border-bottom: 1px solid var(--border); z-index: 50; display: flex; justify-content: space-between; align-items: center; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0 24px 0; z-index: 50; }
        .nav-item { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-sub); font-size: 10px; font-weight: 700; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        
        /* Inputs */
        .input-group { margin-bottom: 12px; }
        .label { display: block; font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 6px; }
        .input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 16px; outline: none; }
        .input:focus { border-color: var(--primary); }
        
        /* FAB */
        .fab { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4); z-index: 40; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        [dir="rtl"] .fab { right: auto; left: 20px; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal.open { display: flex; }
        .modal-content { background: var(--card); width: 100%; max-width: 400px; border-radius: 20px; padding: 20px; max-height: 90vh; overflow-y: auto; animation: popUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Icons */
        .icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        
        /* Helpers */
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .hidden { display: none !important; } /* Force hidden to win over flex */
        
        /* Delete Confirm Modal Specifics */
        .confirm-icon { width: 60px; height: 60px; background: #fee2e2; border-radius: 50%; color: var(--danger); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px auto; }
    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-2">
            <div style="width:32px; height:32px; background:var(--primary); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">A</div>
            <div class="text-lg bold" id="appTitle">Abou Tia Finance</div>
        </div>
        <button class="btn-ghost" onclick="toggleTheme()" id="themeBtn">ðŸŒ™</button>
    </header>

    <div id="mainContainer" class="container">
        </div>

    <button class="fab" onclick="openModal('add')">+</button>

    <nav>
        <button class="nav-item active" onclick="switchView('dashboard')" id="nav-dash">
            <svg class="icon"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
            <span data-i18n="dash">Dashboard</span>
        </button>
        <button class="nav-item" onclick="switchView('transactions')" id="nav-tx">
            <svg class="icon"><path d="M7 10h14"/><path d="M7 14h14"/><path d="M3 10h.01"/><path d="M3 14h.01"/></svg>
            <span data-i18n="tx">Transactions</span>
        </button>
        <button class="nav-item" onclick="switchView('accounts')" id="nav-acc">
            <svg class="icon"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
            <span data-i18n="accs">Accounts</span>
        </button>
        <button class="nav-item" onclick="switchView('settings')" id="nav-set">
            <svg class="icon"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <span data-i18n="set">Settings</span>
        </button>
    </nav>

    <div id="txModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom:20px;">
                <h2 class="text-xl" id="modalTitle">Transaction</h2>
                <button class="btn-ghost" onclick="closeModal()">âœ•</button>
            </div>
            
            <div class="flex gap-2" style="background:var(--bg); padding:4px; border-radius:12px; margin-bottom:16px;">
                <button type="button" class="btn" style="flex:1; background:var(--danger); color:white;" id="btn-exp" onclick="setTxType('exp')">Deduction</button>
                <button type="button" class="btn btn-ghost" style="flex:1;" id="btn-inc" onclick="setTxType('inc')">Addition</button>
            </div>

            <input type="hidden" id="txId">
            <input type="hidden" id="txRecurringId">

            <div class="input-group">
                <label class="label" data-i18n="amt">Amount</label>
                <input type="number" id="txAmount" class="input" placeholder="0.00">
            </div>
            <div class="input-group">
                <label class="label" data-i18n="date">Date</label>
                <input type="date" id="txDate" class="input">
            </div>
            <div class="input-group">
                <label class="label" data-i18n="desc">Description</label>
                <input type="text" id="txDesc" class="input" placeholder="e.g. Salary">
            </div>
            <div class="input-group">
                <label class="label" data-i18n="acc">Account</label>
                <select id="txAcc" class="input"></select>
            </div>
            <div class="input-group">
                <label class="label" data-i18n="cat">Category</label>
                <input type="text" id="txCat" class="input" list="catList">
                <datalist id="catList"></datalist>
            </div>

            <div class="flex gap-2" style="margin-top:20px;">
                <button class="btn btn-danger hidden" id="btnDelete" onclick="deleteTxClick()">Delete</button>
                <button class="btn btn-primary" onclick="saveTx()" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <div id="recModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom:20px;">
                <h2 class="text-xl" id="recModalTitle">Recurring Item</h2>
                <button class="btn-ghost" onclick="closeRecModal()">âœ•</button>
            </div>
            
            <div class="flex gap-2" style="background:var(--bg); padding:4px; border-radius:12px; margin-bottom:16px;">
                <button type="button" class="btn" style="flex:1; background:var(--danger); color:white;" id="btn-rec-exp" onclick="setRecType('exp')">Deduction</button>
                <button type="button" class="btn btn-ghost" style="flex:1;" id="btn-rec-inc" onclick="setRecType('inc')">Addition</button>
            </div>

            <input type="hidden" id="recId">

            <div class="input-group">
                <label class="label" data-i18n="desc">Description (Name)</label>
                <input type="text" id="recName" class="input" placeholder="e.g. Rent, Salary">
            </div>
            <div class="input-group">
                <label class="label" data-i18n="amt">Amount</label>
                <input type="number" id="recAmount" class="input" placeholder="0.00">
            </div>
            <div class="input-group">
                <label class="label">Due Date (Start Date)</label>
                <input type="date" id="recDate" class="input">
            </div>

            <div class="flex gap-2" style="margin-top:20px;">
                <button class="btn btn-danger hidden" id="btnRecDelete" onclick="deleteRecClick()">Delete</button>
                <button class="btn btn-primary" onclick="saveRec()" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="confirm-icon">
                <svg class="icon" style="width:32px; height:32px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </div>
            <h2 class="text-xl bold">Are you sure?</h2>
            <p class="text-sub" style="margin-bottom: 24px;">Do you really want to delete this? This process cannot be undone.</p>
            <div class="flex gap-2">
                <button class="btn btn-ghost" style="flex:1; border:1px solid var(--border);" onclick="closeConfirm()">Cancel</button>
                <button class="btn btn-danger" style="flex:1;" id="btnConfirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const DEFAULT_ACCOUNTS = [
            { id: '1', name: 'Vodafone Cash', initial: 0 },
            { id: '2', name: 'Bank Account', initial: 0 },
            { id: '3', name: 'Credit Card', initial: 0 },
            { id: '4', name: 'Cash', initial: 0 }
        ];

        let data = {
            transactions: [],
            accounts: DEFAULT_ACCOUNTS,
            categories: [],
            recurring: [],
            settings: { lang: 'en', theme: 'light' }
        };

        let currentView = 'dashboard';
        let txType = 'exp';
        let recType = 'exp';
        
        // Callback for the confirmation modal
        let onConfirmAction = null;

        const TRANSLATIONS = {
            en: { dash: "Dashboard", tx: "Transactions", accs: "Accounts", set: "Settings", amt: "Amount", date: "Date", desc: "Description", acc: "Account", cat: "Category", save: "Save", del: "Delete", income: "Addition", expense: "Deduction", total: "Total Balance", rec: "Recurring", export: "Backup", import: "Restore" },
            ar: { dash: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", tx: "Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª", accs: "Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", set: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", amt: "Ø§Ù„Ù…Ø¨Ù„Øº", date: "Ø§Ù„ØªØ§Ø±ÙŠØ®", desc: "Ø§Ù„ÙˆØµÙ", acc: "Ø§Ù„Ø­Ø³Ø§Ø¨", cat: "Ø§Ù„ÙØ¦Ø©", save: "Ø­ÙØ¸", del: "Ø­Ø°Ù", income: "Ø¥Ø¶Ø§ÙØ©", expense: "Ø®ØµÙ…", total: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯", rec: "Ø¯ÙˆØ±ÙŠ", export: "Ù†Ø³Ø®", import: "Ø§Ø³ØªØ±Ø¬Ø§Ø¹" }
        };

        // --- INIT ---
        window.onload = () => {
            loadData();
            applyTheme();
            applyLang();
            render();
            document.getElementById('txDate').valueAsDate = new Date();
        };

        // --- CORE FUNCTIONS ---
        function loadData() {
            const stored = localStorage.getItem('abouTiaData');
            if(stored) {
                try { data = JSON.parse(stored); } catch(e) {}
            }
        }

        function saveData() {
            localStorage.setItem('abouTiaData', JSON.stringify(data));
            render();
        }

        function render() {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${currentView === 'dashboard' ? 'dash' : currentView === 'transactions' ? 'tx' : currentView === 'accounts' ? 'acc' : 'set'}`).classList.add('active');

            const container = document.getElementById('mainContainer');
            container.innerHTML = '';

            if(currentView === 'dashboard') renderDashboard(container);
            else if(currentView === 'transactions') renderTransactions(container);
            else if(currentView === 'accounts') renderAccounts(container);
            else if(currentView === 'settings') renderSettings(container);
        }

        // --- RENDERERS ---
        function renderDashboard(container) {
            const total = data.accounts.reduce((sum, acc) => sum + getAccBalance(acc.id), 0);
            const income = data.transactions.filter(t => t.type === 'inc').reduce((sum, t) => sum + Number(t.amount), 0);
            const expense = data.transactions.filter(t => t.type === 'exp').reduce((sum, t) => sum + Number(t.amount), 0);

            container.innerHTML = `
                <div class="card" style="background: linear-gradient(135deg, var(--primary), #3b82f6); color: white; border:none;">
                    <div class="text-sm" style="opacity:0.8">${t('total')}</div>
                    <div class="text-xl bold" style="font-size:32px; margin: 4px 0;">${fmt(total)}</div>
                    <div class="flex gap-2 mt-2">
                        <div style="background:rgba(255,255,255,0.2); padding:8px 12px; border-radius:8px; flex:1;">
                            <div class="text-xs">Addition</div>
                            <div class="bold">+${fmt(income)}</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.2); padding:8px 12px; border-radius:8px; flex:1;">
                            <div class="text-xs">Deduction</div>
                            <div class="bold">-${fmt(expense)}</div>
                        </div>
                    </div>
                </div>

                ${getRecurringAlertsHTML()}

                <h3 class="text-sm bold text-sub uppercase" style="margin-bottom:10px; margin-top:20px;">Accounts</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    ${data.accounts.map(acc => `
                        <div class="card" style="margin:0; padding:16px;">
                            <div class="text-xs text-sub uppercase">${acc.name}</div>
                            <div class="text-lg bold">${fmt(getAccBalance(acc.id))}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="flex justify-between items-center" style="margin-top:24px; margin-bottom:10px;">
                    <h3 class="text-sm bold text-sub uppercase">Recent</h3>
                    <button class="btn-ghost text-xs" onclick="switchView('transactions')">See All</button>
                </div>
                ${data.transactions.length === 0 ? '<div class="text-sub text-center text-sm" style="padding:20px;">No transactions yet</div>' : ''}
                ${data.transactions.slice(0, 5).map(tx => getTxHTML(tx)).join('')}
            `;
        }

        function renderTransactions(container) {
            container.innerHTML = `<h2 class="text-xl bold" style="margin-bottom:16px;">${t('tx')}</h2>`;
            if(data.transactions.length === 0) {
                container.innerHTML += `<div class="text-center text-sub" style="margin-top:40px;">No transactions found.</div>`;
            } else {
                data.transactions.forEach(tx => {
                    container.innerHTML += getTxHTML(tx);
                });
            }
        }

        function renderAccounts(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center" style="margin-bottom:16px;">
                    <h2 class="text-xl bold">${t('accs')}</h2>
                    <button class="btn btn-primary" style="width:auto;" onclick="addAccount()">+ Add</button>
                </div>
            `;
            data.accounts.forEach(acc => {
                container.innerHTML += `
                    <div class="card relative">
                        <div class="text-xs text-sub uppercase">${acc.name}</div>
                        <div class="text-xl bold">${fmt(getAccBalance(acc.id))}</div>
                        <button class="btn-ghost" style="position:absolute; top:10px; right:10px; color:var(--danger);" onclick="deleteAccount('${acc.id}')">âœ•</button>
                    </div>
                `;
            });
        }

        function renderSettings(container) {
            container.innerHTML = `
                <h2 class="text-xl bold" style="margin-bottom:16px;">${t('set')}</h2>
                
                <div class="card">
                    <div class="flex justify-between items-center">
                        <span class="bold">Language</span>
                        <button class="btn" style="border:1px solid var(--border);" onclick="toggleLang()">${data.settings.lang === 'en' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'}</button>
                    </div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center" style="margin-bottom:10px;">
                        <span class="bold">Recurring Items</span>
                        <button class="btn btn-primary" style="width:auto; padding:6px 12px;" onclick="openRecModal('add')">+ Add</button>
                    </div>
                    ${data.recurring.map(r => `
                        <div class="flex justify-between items-center" style="padding:8px 0; border-bottom:1px solid var(--border); cursor:pointer;" onclick="editRec(${r.id})">
                            <div>
                                <div class="bold text-sm" style="color: ${r.type === 'inc' ? 'var(--success)' : ''}">${r.name}</div>
                                <div class="text-xs text-sub">Monthly on day ${r.day} â€¢ ${fmt(r.amount)}</div>
                            </div>
                            <button class="btn-ghost">âœŽ</button>
                        </div>
                    `).join('')}
                </div>

                <div class="card">
                    <button class="btn" style="width:100%; border:1px solid var(--border); margin-bottom:10px;" onclick="exportData()">â¬‡ ${t('export')}</button>
                    <button class="btn" style="width:100%; border:1px solid var(--border);" onclick="document.getElementById('fileInput').click()">â¬† ${t('import')}</button>
                    <input type="file" id="fileInput" class="hidden" onchange="importData(this)">
                </div>
            `;
        }

        // --- HELPERS ---
        function getTxHTML(tx) {
            const accName = data.accounts.find(a => a.id == tx.accId)?.name || 'Unknown';
            const isInc = tx.type === 'inc';
            return `
                <div class="card flex justify-between items-center" style="padding:16px; cursor:pointer;" onclick="editTx(${tx.id})">
                    <div class="flex items-center gap-2">
                        <div style="width:40px; height:40px; border-radius:50%; background:${isInc ? '#dcfce7' : '#fee2e2'}; display:flex; align-items:center; justify-content:center; font-size:18px;">
                            ${isInc ? 'â†—' : 'â†™'}
                        </div>
                        <div>
                            <div class="bold text-sm">${tx.desc}</div>
                            <div class="text-xs text-sub">${tx.date} â€¢ ${accName}</div>
                        </div>
                    </div>
                    <div class="bold ${isInc ? 'text-green' : 'text-red'}">
                        ${isInc ? '+' : '-'}${fmt(tx.amount)}
                    </div>
                </div>
            `;
        }

        function getRecurringAlertsHTML() {
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonthStr = `${today.getFullYear()}-${today.getMonth()}`;
            
            let html = '';
            data.recurring.forEach(r => {
                if(r.lastPaid === currentMonthStr) return;
                const due = r.day - currentDay;
                if(due > 5) return; 
                
                let color;
                if(r.type === 'inc') {
                     color = 'var(--success)';
                } else {
                     color = due < 0 ? 'var(--danger)' : '#f59e0b';
                }
                
                const msg = due < 0 ? 'Overdue!' : due === 0 ? 'Due Today' : `Due in ${due} days`;
                
                html += `
                    <div class="card flex justify-between items-center" style="border-left:4px solid ${color}; padding:12px;">
                        <div>
                            <div class="bold text-sm">${r.name}</div>
                            <div class="text-xs text-sub">${msg}</div>
                        </div>
                        <button class="btn" style="border:1px solid var(--border); padding:6px 12px; font-size:12px;" onclick="payRecurring(${r.id})">${r.type === 'inc' ? 'Collect' : 'Pay'}</button>
                    </div>
                `;
            });
            return html;
        }

        function getAccBalance(accId) {
            let bal = Number(data.accounts.find(a => a.id == accId)?.initial || 0);
            data.transactions.forEach(tx => {
                if(tx.accId == accId) {
                    if(tx.type === 'inc') bal += Number(tx.amount);
                    else bal -= Number(tx.amount);
                }
            });
            return bal;
        }

        // --- ACTIONS ---
        function switchView(view) {
            currentView = view;
            render();
        }

        function openModal(mode, txData = null) {
            const modal = document.getElementById('txModal');
            modal.classList.add('open');
            
            document.getElementById('txRecurringId').value = '';
            
            const accSelect = document.getElementById('txAcc');
            accSelect.innerHTML = data.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            
            const catList = document.getElementById('catList');
            catList.innerHTML = data.categories.map(c => `<option value="${c.name}">`).join('');

            if(mode === 'edit' && txData) {
                document.getElementById('modalTitle').innerText = 'Edit Transaction';
                document.getElementById('txId').value = txData.id;
                document.getElementById('txAmount').value = txData.amount;
                document.getElementById('txDesc').value = txData.desc;
                document.getElementById('txDate').value = txData.date;
                document.getElementById('txAcc').value = txData.accId;
                document.getElementById('txCat').value = txData.cat;
                setTxType(txData.type);
                document.getElementById('btnDelete').classList.remove('hidden');
            } else {
                document.getElementById('modalTitle').innerText = 'New Transaction';
                document.getElementById('txId').value = '';
                document.getElementById('txAmount').value = '';
                document.getElementById('txDesc').value = '';
                document.getElementById('txDate').valueAsDate = new Date();
                document.getElementById('txCat').value = '';
                setTxType('exp');
                document.getElementById('btnDelete').classList.add('hidden');
            }
        }

        function closeModal() {
            document.getElementById('txModal').classList.remove('open');
        }

        function openRecModal(mode, recData = null) {
            const modal = document.getElementById('recModal');
            modal.classList.add('open');
            
            if(mode === 'edit' && recData) {
                document.getElementById('recModalTitle').innerText = 'Edit Recurring';
                document.getElementById('recId').value = recData.id;
                document.getElementById('recName').value = recData.name;
                document.getElementById('recAmount').value = recData.amount;
                // Set Date Input based on stored Day
                const d = new Date();
                d.setDate(recData.day);
                document.getElementById('recDate').valueAsDate = d;
                
                setRecType(recData.type || 'exp');
                document.getElementById('btnRecDelete').classList.remove('hidden');
            } else {
                document.getElementById('recModalTitle').innerText = 'New Recurring';
                document.getElementById('recId').value = '';
                document.getElementById('recName').value = '';
                document.getElementById('recAmount').value = '';
                document.getElementById('recDate').valueAsDate = new Date();
                setRecType('exp');
                document.getElementById('btnRecDelete').classList.add('hidden');
            }
        }

        function closeRecModal() {
            document.getElementById('recModal').classList.remove('open');
        }

        function openConfirm(callback) {
            onConfirmAction = callback;
            document.getElementById('confirmModal').classList.add('open');
        }

        function closeConfirm() {
            document.getElementById('confirmModal').classList.remove('open');
            onConfirmAction = null;
        }

        // Bind Confirm Button
        document.getElementById('btnConfirmDelete').addEventListener('click', () => {
            if(onConfirmAction) onConfirmAction();
            closeConfirm();
        });

        function setTxType(type) {
            txType = type;
            const btnExp = document.getElementById('btn-exp');
            const btnInc = document.getElementById('btn-inc');
            updateTypeButtons(type, btnExp, btnInc);
        }

        function setRecType(type) {
            recType = type;
            const btnExp = document.getElementById('btn-rec-exp');
            const btnInc = document.getElementById('btn-rec-inc');
            updateTypeButtons(type, btnExp, btnInc);
        }

        function updateTypeButtons(type, btnExp, btnInc) {
            if(type === 'exp') {
                btnExp.style.background = 'var(--danger)'; btnExp.style.color = 'white';
                btnInc.style.background = 'transparent'; btnInc.style.color = 'var(--text-sub)';
            } else {
                btnInc.style.background = 'var(--success)'; btnInc.style.color = 'white';
                btnExp.style.background = 'transparent'; btnExp.style.color = 'var(--text-sub)';
            }
        }

        function saveTx() {
            const id = document.getElementById('txId').value;
            const amount = document.getElementById('txAmount').value;
            const desc = document.getElementById('txDesc').value;
            const date = document.getElementById('txDate').value;
            const accId = document.getElementById('txAcc').value;
            const cat = document.getElementById('txCat').value;
            const recId = document.getElementById('txRecurringId').value;

            if(!amount || !desc || !accId) return alert('Please fill details');

            const txObj = {
                id: id ? Number(id) : Date.now(),
                type: txType,
                amount, desc, date, accId, cat
            };

            if(id) {
                const idx = data.transactions.findIndex(t => t.id == id);
                if(idx > -1) data.transactions[idx] = txObj;
            } else {
                data.transactions.unshift(txObj);
            }

            if(cat && !data.categories.find(c => c.name === cat)) {
                data.categories.push({name: cat});
            }

            if(recId) {
                const r = data.recurring.find(x => x.id == recId);
                if(r) {
                    const today = new Date();
                    r.lastPaid = `${today.getFullYear()}-${today.getMonth()}`;
                }
            }

            saveData();
            closeModal();
        }

        function editTx(id) {
            const tx = data.transactions.find(t => t.id == id);
            if(tx) openModal('edit', tx);
        }

        function deleteTxClick() {
            const id = Number(document.getElementById('txId').value);
            openConfirm(() => {
                data.transactions = data.transactions.filter(t => t.id !== id);
                saveData();
                closeModal();
            });
        }

        function addAccount() {
            const name = prompt("Account Name:");
            if(name) {
                data.accounts.push({id: Date.now(), name, initial: 0});
                saveData();
            }
        }

        function deleteAccount(id) {
            openConfirm(() => {
                data.accounts = data.accounts.filter(a => a.id != id);
                data.transactions = data.transactions.filter(t => t.accId != id);
                saveData();
            });
        }

        function saveRec() {
            const id = document.getElementById('recId').value;
            const name = document.getElementById('recName').value;
            const amt = document.getElementById('recAmount').value;
            const dateVal = document.getElementById('recDate').value;

            if(name && amt && dateVal) {
                const day = new Date(dateVal).getDate();
                const recObj = {
                    id: id ? Number(id) : Date.now(),
                    name, 
                    amount: amt, 
                    day: day, 
                    type: recType,
                    lastPaid: ''
                };

                if(id) {
                    // Update existing
                    const idx = data.recurring.findIndex(r => r.id == id);
                    if(idx > -1) {
                        recObj.lastPaid = data.recurring[idx].lastPaid; // Preserve payment status
                        data.recurring[idx] = recObj;
                    }
                } else {
                    // Add new
                    data.recurring.push(recObj);
                }

                saveData();
                closeRecModal();
            } else {
                alert("Please fill all fields");
            }
        }

        function editRec(id) {
            const r = data.recurring.find(item => item.id == id);
            if(r) openRecModal('edit', r);
        }

        function deleteRecClick() {
            const id = Number(document.getElementById('recId').value);
            openConfirm(() => {
                data.recurring = data.recurring.filter(r => r.id !== id);
                saveData();
                closeRecModal();
            });
        }

        function payRecurring(id) {
            const r = data.recurring.find(x => x.id == id);
            if(r) {
                openModal('add');
                document.getElementById('txAmount').value = r.amount;
                document.getElementById('txDesc').value = r.name;
                document.getElementById('txCat').value = 'Recurring'; 
                document.getElementById('txRecurringId').value = r.id;
                setTxType(r.type || 'exp');
                document.getElementById('modalTitle').innerText = 'Confirm Recurring';
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `aboutia_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    data = JSON.parse(e.target.result);
                    saveData();
                    alert("Data restored!");
                } catch(err) {
                    alert("Invalid file");
                }
            };
            reader.readAsText(file);
        }

        function toggleTheme() {
            data.settings.theme = data.settings.theme === 'light' ? 'dark' : 'light';
            saveData();
            applyTheme();
        }

        function applyTheme() {
            if(data.settings.theme === 'dark') document.body.classList.add('dark');
            else document.body.classList.remove('dark');
        }

        function toggleLang() {
            data.settings.lang = data.settings.lang === 'en' ? 'ar' : 'en';
            saveData();
            applyLang();
            render();
        }

        function applyLang() {
            document.dir = data.settings.lang === 'ar' ? 'rtl' : 'ltr';
        }

        function t(key) {
            return TRANSLATIONS[data.settings.lang][key] || key;
        }

        function fmt(num) {
            return new Intl.NumberFormat(data.settings.lang === 'ar' ? 'ar-EG' : 'en-US', { style: 'currency', currency: 'EGP' }).format(num);
        }
    </script>
</body>
</html>
