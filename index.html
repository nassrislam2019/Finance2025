<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>دفتر حساباتي</title>
<meta name="theme-color" content="#0b1220" />
<link rel="manifest" href="manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet">
<style>
/* ===== الثيمات (Theme Variables) ===== */
:root{
  /* Dark Mode Default */
  --bg:#0b1220;
  --card:#0f172a;
  --muted:#94a3b8;
  --txt:#e5e7eb;
  --brand:#0369a1;
  --brand-2:#0ea5e9;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#22c55e;
  --border:#1f2a44;
  --field-bg:#0b1220;
}
/* Light Mode */
body[data-theme="light"]{
  --bg:#f8fafc;
  --card:#ffffff;
  --muted:#64748b;
  --txt:#1e293b;
  --brand:#1076b9;
  --brand-2:#1493e8;
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#16a34a;
  --border:#e2e8f0;
  --field-bg:#f1f5f9;
  --shadow:0 8px 24px rgba(2,6,23,0.1);
}
:root{
  --radius:12px;
  --field-h:42px;
  --shadow:0 8px 24px rgba(2,6,23,0.5);
}

/* خطوط */
body,h1,h2,h3,h4,h5,h6,p,div,span,li,a,button{font-family:"Cairo",sans-serif !important;}
*{box-sizing:border-box}
html{height:100%}
body{
  margin:0;
  padding-bottom:60px; /* مسافة لشريط التنقل السفلي */
  background:var(--bg);
  color:var(--txt);
  min-height:100vh;
  transition:background .3s;
}
.container{max-width:1180px;margin-inline:auto;padding:20px}

/* Cards */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:0; overflow:hidden; box-shadow:var(--shadow);
  margin-bottom:12px; /* تم إضافة مسافة بين البطاقات */
}
.card-head{
  display:flex;align-items:center;justify-content:space-between;padding:12px 14px;
  background:linear-gradient(135deg, rgba(3,105,161,var(--grad-opacity,0.55)), rgba(14,165,233,var(--grad-opacity,0.12)));
  border-bottom:1px solid var(--border);
}
body[data-theme="light"] .card-head{
  --grad-opacity:.1;
  background:linear-gradient(135deg, rgba(14,165,233,.1), rgba(3,105,161,.05));
  border-bottom:1px solid var(--border);
}
.card-head h3{margin:0;font-size:18px;color:var(--txt)}
.card-body{padding:14px}

/* Layout */
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,textarea{
  width:100%;background:var(--field-bg);color:var(--txt);border:1px solid var(--border);
  border-radius:10px;padding:10px 12px;font-size:14px;outline:none;height:var(--field-h)
}
input[type="date"],input[type="month"]{direction:ltr;text-align:center;font-variant-numeric:tabular-nums}
.checkbox-row{display:flex;align-items:center;gap:8px}
.checkbox-row input[type="checkbox"]{width:18px;height:18px}

/* Buttons */
.btn{
  appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer;
  transition:transform .06s ease, opacity .15s,height .08s ease;font-size:13px;height:36px;
}
.btn:hover{opacity:.95;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted);padding:8px 10px}
.btn-primary{background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff;border:1px solid rgba(14,165,233,.35)}
.btn-danger{background:linear-gradient(180deg,#ef4444,#d02626);color:#fff;border:1px solid rgba(235,75,75,0.15)}
.btn-muted{background:transparent;color:var(--muted);border:1px dashed var(--border);padding:8px 10px}

/* action buttons داخل الجداول — حجم أصغر */
.actions .btn{height:30px;padding:6px 8px;font-size:13px;border-radius:8px}
.actions .btn-outline{border-color:var(--border);color:var(--txt)}

/* Stats (ملخص الحسابات) */
.stats{display:grid;gap:10px}
@media(min-width:720px){.stats{grid-template-columns:repeat(6,1fr)}}
.stat{
  background:var(--field-bg);border:1px solid var(--border);border-radius:var(--radius);padding:14px; text-align:center;
  box-shadow:var(--shadow)
}
.stat small{color:var(--muted)}
.stat .num{font-weight:800;font-size:22px;margin-top:4px;color:var(--txt)}
.pos{color:var(--ok)}.neg{color:var(--danger)}

/* perAccount */
.list-plain{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.list-plain .item{
  background:var(--field-bg);border:1px solid var(--border);padding:14px;border-radius:var(--radius);
  text-align:center;box-shadow:var(--shadow);font-weight:700;color:var(--txt)
}

/* Reports & Tables */
#catsTableWrap table, #tbodyCommit table, #tbodyCollect table {
  border-spacing:0;margin-top:8px
}
#catsTableWrap tbody tr:hover{transform:none;box-shadow:none}
#catsTableWrap tbody td{padding:8px 10px;border:none;border-bottom:1px solid var(--border);}
#catsTableWrap tbody td:first-child, #catsTableWrap tbody td:last-child{border-radius:0;border-left:none;border-right:none;}

.report-table-wrap{overflow:auto;max-height:340px}
#tbodyMonthly tr.active{background:rgba(14,165,233,0.18);box-shadow:0 0 0 1px rgba(14,165,233,0.35)}
.month-stats .stat{background:var(--field-bg)}
.empty-state{padding:12px;border:1px dashed var(--border);border-radius:var(--radius);text-align:center;font-size:13px;color:var(--muted)}

table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:right;padding:6px 10px}
tbody tr{background:var(--field-bg);border:1px solid rgba(255,255,255,0.02);border-radius:10px;transition:transform .08s ease, box-shadow .08s ease}
body[data-theme="light"] tbody tr{background:#fff;border-color:#eee}
tbody tr:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(2,6,23,0.6)}
body[data-theme="light"] tbody tr:hover{box-shadow:0 8px 16px rgba(0,0,0,0.1)}
tbody td{padding:12px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);color:var(--txt)}
tbody tr td:first-child{border-right:1px solid var(--border);border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
tbody tr td:last-child{border-left:1px solid var(--border);border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
.amount.exp{color:var(--danger);font-weight:900}.amount.inc{color:var(--ok);font-weight:900}

.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.spacer{flex:1}
.badge{display:inline-flex;gap:6px;align-items:center;background:var(--field-bg);color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;height:var(--field-h)}

.hr{height:1px;background:var(--border);opacity:.7;margin:12px 0;border-radius:999px}
/* تحويل */
.transfer-grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}
.transfer-grid .full{grid-column:1/-1}
@media(max-width:900px){.transfer-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:720px){
  .grid-2{grid-template-columns:1fr}
  .grid-4{grid-template-columns:1fr 1fr}
  .badge{height:auto}
  .card-head h3{font-size:17px}
  .transfer-grid{grid-template-columns:1fr}
}

/* ===== شريط التنقل السفلي (Footer Navigation) ===== */
.footer-nav{
  position:fixed;bottom:0;right:0;left:0;
  height:56px;padding:0;
  background:var(--card);border-top:1px solid var(--border);
  display:flex;justify-content:space-around;
  z-index:1000;box-shadow:0 -4px 12px rgba(0,0,0,var(--shadow-op,0.4));
}
body[data-theme="light"] .footer-nav{--shadow-op:0.15;}

.footer-nav button{
  flex:1;appearance:none;border:none;background:transparent;
  color:var(--muted);font-size:11px;font-weight:600;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:2px;cursor:pointer;
  transition:color .2s;padding:4px 0;
}
.footer-nav button.active{
  color:var(--brand-2);
}
.footer-nav button i{font-size:18px}

/* ===== شاشات المحتوى (Screens) ===== */
.screen{display:none;margin-top:12px}
.screen.active{display:block}

/* ===== وضع ليلي نهاري ===== */
#themeToggle{
  position:fixed;top:10px;right:10px;z-index:1001;
  width:40px;height:40px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:var(--card);border:1px solid var(--border);
  color:var(--txt);cursor:pointer;
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body data-theme="dark">
<div class="container">
  <header>
    <div class="title" style="font-weight:900;font-size:22px;color:var(--txt)">دفتر حساباتي</div>
    <div class="toolbar" style="margin-top:10px">
      <button id="exportJson" class="btn btn-outline" type="button">تصدير JSON</button>
      <button id="exportCsv" class="btn btn-outline" type="button">تصدير CSV</button>
      <label class="btn btn-muted" for="importFile">استيراد JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
      <button id="syncNow" class="btn btn-outline" type="button">مزامنة الآن</button>
      <button id="installBtn" class="btn btn-outline" type="button" style="display:none">تثبيت التطبيق</button>
    </div>
  </header>

  <button id="themeToggle" type="button">
    <i class="fas fa-sun"></i>
  </button>

  <div class="screen active" id="screen-overview">
    <section class="card" id="card-balance">
      <div class="card-head"><h3>ملخص الحسابات</h3></div>
      <div class="card-body">
        <div class="stats">
          <div class="stat"><small>إجمالي الأرصدة</small><div id="totalBalance" class="num">0</div></div>
          <div class="stat"><small>إجمالي التزامات الشهر الحالي</small><div id="monthCommitTotal" class="num neg">0</div></div>
          <div class="stat"><small>إجمالي مبالغ تحت التحصيل (الشهر الحالي)</small><div id="currentMonthCollections" class="num pos">0</div></div>
          <div class="stat"><small>الرصيد بعد خصم الالتزامات الحالية</small><div id="balanceAfterCommitments" class="num">0</div></div>
          <div class="stat"><small>التزامات الشهر القادم (شامل متبقي الحالي)</small><div id="nextCommitWithCarry" class="num neg">0</div></div>
          <div class="stat"><small>إجمالي مبالغ تحت التحصيل الشهر القادم</small><div id="nextMonthCollections" class="num pos">0</div></div>
        </div>
        <div class="hr"></div>
        <div>
          <h3 style="margin:0 0 8px;font-size:14px;color:var(--muted)">تفاصيل الأرصدة بالحساب</h3>
          <div id="perAccount" class="list-plain"></div>
        </div>
      </div>
    </section>

    <section class="card" id="card-dueSoon">
      <div class="card-head">
        <h3>استحقاقات قريبة</h3>
        <div class="badge-group">
          <span id="dueTotalBadge" class="badge" title="إجمالي المتبقّي لهذا الشهر">إجمالي: 0.00 ج.م</span>
          <span id="dueNextTotalBadge" class="badge" title="إجمالي الاستحقاقات للشهر القادم">الشهر القادم: 0.00 ج.م</span>
        </div>
      </div>
      <div class="card-body">
        <div id="dueSoonWrap">
          <table style="width:100%">
            <thead><tr><th>الاسم</th><th>التاريخ</th><th>الأصل</th><th>المدفوع</th><th>المتبقي</th><th>الحالة</th><th>إجراءات</th></tr></thead>
            <tbody id="tbodyDueSoon"></tbody>
          </table>
        </div>
        <div id="dueSoonCards"></div>
        <div id="noDueSoon" class="d-none" style="color:var(--muted)">لا توجد استحقاقات هذا الشهر غير مسددة.</div>
      </div>
    </section>

    <section class="card" id="card-reports">
      <div class="card-head"><h3>تقارير شهرية و رسوم بيانية</h3></div>
      <div class="card-body">
        <div class="toolbar" style="margin-bottom:8px">
          <input id="monthPicker" type="month" />
          <button id="refreshReports" class="btn btn-outline">تحديث</button>
          <span class="spacer"></span><span class="badge">إجمالي الدخل/المصروف لكل شهر</span>
        </div>
        <div class="grid grid-2">
          <div>
            <canvas id="chartMonthly" width="560" height="320" aria-label="Monthly chart"></canvas>
            </div>
          <div class="report-table-wrap">
            <table>
              <thead><tr><th>الشهر</th><th>إجمالي الدخل</th><th>إجمالي المصروف</th><th>الصافي</th></tr></thead>
              <tbody id="tbodyMonthly"></tbody>
            </table>
          </div>
        </div>
        <div class="month-insights">
          <div class="stats month-stats">
            <div class="stat"><small>الشهر المحدد</small><div id="monthSelectedLabel" class="month-selected">—</div></div>
            <div class="stat"><small>إجمالي الدخل</small><div id="monthStatIncome" class="num pos">0.00</div></div>
            <div class="stat"><small>إجمالي المصروف</small><div id="monthStatExpense" class="num neg">0.00</div></div>
            <div class="stat"><small>الصافي</small><div id="monthStatNet" class="num">0.00</div></div>
            <div class="stat"><small>عدد الحركات</small><div id="monthStatTx" class="num">0</div></div>
            <div class="stat"><small>متوسط الصرف اليومي</small><div id="monthStatAvg" class="num">0.00</div></div>
          </div>
          <div id="monthNoData" class="empty-state d-none">لا توجد بيانات للشهر المحدد حتى الآن.</div>
          <div class="month-note">يتم تجاهل التحويلات الداخلية والرسوم المرتبطة بها من حساب الدخل/المصروف.</div>
          <div class="grid grid-2 month-cats">
            <div><h4>أعلى المصروفات حسب الفئة</h4><div id="monthCatsExpense" class="bar-list"></div></div>
            <div><h4>أهم مصادر الدخل</h4><div id="monthCatsIncome" class="bar-list"></div></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="screen" id="screen-txs">
    <section class="card" id="card-addtx">
      <div class="card-head"><h3>إضافة حركة</h3></div>
      <div class="card-body">
        <div class="grid grid-3">
          <div><label>النوع</label><select id="type"><option value="income">دخل</option><option value="expense" selected>مصروف</option></select></div>
          <div><label>المبلغ (ج.م)</label><input id="amount" type="number" step="0.01" placeholder="0.00" /></div>
          <div><label>التاريخ</label><input id="date" type="date" /></div>
          <div><label>الوصف</label><input id="desc" type="text" placeholder="مثال: سوبر ماركت" /></div>
          <div><label>الحساب</label><select id="account"></select></div>
          <div><label>الفئة</label><select id="category"></select></div>
          <div><label>ربط الالتزام (اختياري لمصروفات)</label><select id="linkCommit"></select></div>
          <div class="grid grid-2" style="grid-column:1/-1">
            <button id="saveTx" class="btn btn-primary">حفظ</button>
            <button id="resetForm" class="btn btn-outline">إفراغ</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" id="card-txs">
      <div class="card-head"><h3>سجل الحركات</h3></div>
      <div class="card-body">
        <div class="toolbar" style="margin-bottom:8px">
          <input id="search" placeholder="بحث بالوصف" style="max-width:220px"/>
          <select id="fType" style="max-width:150px"><option value="all" selected>الكل</option><option value="income">دخل فقط</option><option value="expense">مصروف فقط</option></select>
          <select id="fAccount" style="max-width:180px"></select>
          <input id="fFrom" type="date" />
          <input id="fTo" type="date" />
          <button id="clearFilters" class="btn btn-outline">مسح الفلاتر</button>
          <span class="spacer"></span>
          <span class="badge">العملة: ج.م</span>
        </div>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>التاريخ</th><th>الوصف</th><th>الفئة</th><th>الحساب</th><th>المبلغ</th><th>رصيد الحساب بعد العملية</th><th>إجراءات</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="pager" id="txPager" style="display:none">
          <button id="txPrev" class="btn btn-outline" type="button">السابق</button>
          <div class="info" id="txPagerInfo">صفحة 1 / 1</div>
          <button id="txNext" class="btn btn-outline" type="button">التالي</button>
        </div>
      </div>
    </section>
  </div>

  <div class="screen" id="screen-commitments">
    <section class="card" id="card-commit">
      <div class="card-head"><h3>الالتزامات الشهرية</h3></div>
      <div class="card-body">
        <div class="grid grid-4">
          <div><label>اسم الالتزام</label><input id="cName" placeholder="مثال: إيجار، إنترنت" /></div>
          <div><label>المبلغ (ج.م)</label><input id="cAmount" type="number" step="0.01" placeholder="0.00" /></div>
          <div><label>تاريخ أول استحقاق</label><input id="cFirstDue" type="date" required /></div>
          <div class="checkbox-row"><input id="cRecurring" type="checkbox" /><label for="cRecurring" style="margin:0">يتكرر شهريًا</label></div>
          <div style="grid-column:1/span 2"><label>ينتهي في (إجباري عند التكرار)</label><input id="cEndAt" type="date" /></div>
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button id="addCommitment" class="btn btn-outline">إضافة/تحديث</button>
          <span class="spacer"></span><span class="badge">يمكن السداد جزئيًا من "إضافة حركة"</span>
        </div>
        <div style="overflow:auto">
          <table>
            <thead><tr>
              <th>الاسم</th><th>المبلغ</th><th>استحقاق</th><th>مدفوع (الشهر)</th><th>متبقّي</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th>
            </tr></thead>
            <tbody id="tbodyCommit"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card" id="card-collect">
      <div class="card-head"><h3>مبالغ تحت التحصيل</h3></div>
      <div class="card-body">
        <div class="grid grid-4">
          <div><label>اسم التحصيل</label><input id="coName" placeholder="مثال: إيجار مستلم، مبيعات آجل" /></div>
          <div><label>المبلغ (ج.م)</label><input id="coAmount" type="number" step="0.01" placeholder="0.00" /></div>
          <div><label>تاريخ أول استحقاق</label><input id="coFirstDue" type="date" required /></div>
          <div class="checkbox-row"><input id="coRecurring" type="checkbox" /><label for="coRecurring" style="margin:0">يتكرر شهريًا</label></div>
          <div style="grid-column:1/span 2"><label>ينتهي في (إجباري عند التكرار)</label><input id="coEndAt" type="date" /></div>
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button id="addCollect" class="btn btn-outline">إضافة/تحديث</button>
          <span class="spacer"></span><span class="badge">لا يظهر في الحركات إلا بعد "تم التحصيل"</span>
        </div>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>الاسم</th><th>المبلغ</th><th>التحصيل القادم</th><th>التكرار</th><th>ينتهي في</th><th>إجراءات</th></tr></thead>
            <tbody id="tbodyCollect"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div class="screen" id="screen-accounts">
    <section class="card" id="card-accounts">
      <div class="card-head"><h3>إدارة الحسابات</h3></div>
      <div class="card-body">
        <div class="grid grid-3">
          <div><label>اسم الحساب</label><input id="newAccountName" placeholder="مثال: كاش/محفظة" /></div>
          <div><label>رصيد افتتاحي</label><input id="newAccountOpening" type="number" step="0.01" placeholder="0.00" /></div>
          <div><label>&nbsp;</label><button id="addAccount" class="btn btn-outline" style="width:100%">إضافة حساب</button></div>
        </div>
        <div id="accountsList" class="toolbar" style="margin-top:8px;flex-wrap:wrap"></div>
      </div>
    </section>

    <section class="card" id="card-transfer">
      <div class="card-head"><h3>تحويل بين الحسابات</h3></div>
      <div class="card-body">
        <div class="transfer-grid">
          <div><label>من حساب</label><select id="trFrom"></select></div>
          <div><label>إلى حساب</label><select id="trTo"></select></div>
          <div><label>المبلغ (ج.م)</label><input id="trAmount" type="number" step="0.01" placeholder="0.00" /></div>
          <div><label>عمولة التحويل (اختياري)</label><input id="trFee" type="number" step="0.01" placeholder="0.00" /></div>
          <div><label>التاريخ</label><input id="trDate" type="date" /></div>
          <div><label>ملاحظة</label><input id="trDesc" type="text" placeholder="مثال: تحويل لمحفظة"/></div>
          <div class="full" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <button id="execTransfer" class="btn btn-primary">تنفيذ التحويل</button>
            <button id="resetTransfer" class="btn btn-outline">إفراغ</button>
          </div>
        </div>
        <div style="margin-top:8px;color:var(--muted);font-size:12px">ملاحظة: التحويلات لا تُحسب ضمن إجمالي الدخل/المصروف، لكن العمولة تُحسب كمصروف.</div>
      </div>
    </section>
  </div>

  <div class="screen" id="screen-cats">
    <section class="card" id="card-cats">
      <div class="card-head"><h3>إدارة الفئات</h3></div>
      <div class="card-body">
        <div class="grid grid-3">
          <div><label>اسم الفئة</label><input id="newCatName" placeholder="مثال: أكل" /></div>
          <div><label>النوع</label><select id="newCatType"><option value="expense" selected>مصروف</option><option value="income">دخل</option></select></div>
          <div><label>&nbsp;</label><button id="addCategory" class="btn btn-outline" style="width:100%">إضافة فئة</button></div>
        </div>
        <div id="catsTableWrap" style="overflow-x:auto">
          <table>
            <thead>
              <tr><th>الاسم</th><th>النوع</th><th>الإجراءات</th></tr>
            </thead>
            <tbody id="catsList">
              </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div class="screen" id="screen-github">
    <section class="card" id="card-github">
      <div class="card-head"><h3>إعدادات مزامنة GitHub</h3></div>
      <div class="card-body">
        <div class="grid grid-4">
          <div><label>اسم المستخدم</label><input id="ghUser" placeholder="مثال: username" /></div>
          <div><label>المستودع</label><input id="ghRepo" placeholder="مثال: Finance2025" /></div>
          <div><label>الفرع</label><input id="ghBranch" value="main" /></div>
          <div><label>مسار الملف (JSON)</label><input id="ghPath" value="my-finance.json" /></div>
        </div>
        <div class="grid grid-3" style="margin-top:8px">
          <div><label>Personal Access Token</label><input id="ghToken" type="password" placeholder="ghp_..." /></div>
          <div class="checkbox-row" style="margin-top:22px"><input id="ghAuto" type="checkbox"/><label for="ghAuto" style="margin:0">مزامنة تلقائيًا بعد كل تعديل</label></div>
          <div class="grid grid-2" style="margin-top:22px">
            <button id="ghSaveCfg" class="btn btn-outline">حفظ الإعدادات</button>
            <button id="ghTest" class="btn btn-outline">اختبار الاتصال</button>
          </div>
        </div>
        <div class="grid grid-3" style="margin-top:8px">
          <button id="ghPull" class="btn btn-outline">تحميل من GitHub</button>
          <button id="ghPush" class="btn btn-primary">رفع إلى GitHub</button>
          <span id="ghStatus" class="badge">الحالة: غير متصل</span>
        </div>
        <div style="margin-top:8px;color:var(--muted);font-size:12px">⚠️ الـ Token محفوظ محليًا في جهازك فقط.</div>
      </div>
    </section>
  </div>


  <div class="footer">
    <div>⚠️ <span class="note">تنبيه:</span> كل البيانات محفوظة محليًا في <code>localStorage</code>. لا تنسَ التصدير كنسخة احتياطية.</div>
    <div style="margin-top:6px">تقدر تثبّت الموقع كتطبيق لأنه PWA.</div>
  </div>
</div>

<nav class="footer-nav nav-tabs">
  <button data-screen="screen-overview" class="active" type="button" onclick="showScreen('screen-overview')">
    <i class="fas fa-chart-pie"></i> ملخص
  </button>
  <button data-screen="screen-txs" type="button" onclick="showScreen('screen-txs')">
    <i class="fas fa-exchange-alt"></i> حركات
  </button>
  <button data-screen="screen-commitments" type="button" onclick="showScreen('screen-commitments')">
    <i class="fas fa-handshake"></i> التزامات
  </button>
  <button data-screen="screen-accounts" type="button" onclick="showScreen('screen-accounts')">
    <i class="fas fa-wallet"></i> حسابات
  </button>
  <button data-screen="screen-cats" type="button" onclick="showScreen('screen-cats')">
    <i class="fas fa-tags"></i> فئات
  </button>
  <button data-screen="screen-github" type="button" onclick="showScreen('screen-github')">
    <i class="fas fa-cog"></i> إعدادات
  </button>
</nav>

<script>
/* ===== مفاتيح التخزين ===== */
const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1',
      COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1', GH_KEY='pf_github_cfg_v1',
      THEME_KEY='pf_theme_v1'; /* مفتاح جديد للثيم */

/* ===== الحالة ===== */
let ledger=JSON.parse(localStorage.getItem(KEY)||'[]');
let accounts=JSON.parse(localStorage.getItem(ACC_KEY)||'[]');
let categories=JSON.parse(localStorage.getItem(CAT_KEY)||'[]');
let commitments=JSON.parse(localStorage.getItem(COM_KEY)||'[]'); 
let collections=JSON.parse(localStorage.getItem(COL_KEY)||'[]');
let ghCfg=JSON.parse(localStorage.getItem(GH_KEY)||'{}');

/* افتراضات أولية */
function ensureBaseCategories(){
  const need=[
    {name:'التزامات شهرية',type:'expense'},
    {name:'تحصيلات شهرية',type:'income'},
    {name:'تحويل صادر',type:'expense'},
    {name:'تحويل وارد',type:'income'},
    {name:'عمولة تحويل',type:'expense'},
  ];
  let changed=false;
  if(categories.length===0){
    categories=[
      {name:'مرتب',type:'income'},{name:'دخل آخر',type:'income'},
      {name:'أكل وشرب',type:'expense'},{name:'مواصلات',type:'expense'},{name:'فواتير',type:'expense'},{name:'تسوق',type:'expense'}
    ];
    changed=true;
  }
  for(const n of need){ if(!categories.some(c=>c.name===n.name && c.type===n.type)){ categories.push(n); changed=true; } }
  if(changed) saveCategories();
}

/* DOM */
const $=s=>document.querySelector(s);
const els={
  totalBalance:$('#totalBalance'),
  monthCommitTotal:$('#monthCommitTotal'),
  currentMonthCollections:$('#currentMonthCollections'),
  balanceAfterCommitments:$('#balanceAfterCommitments'),
  nextCommitWithCarry:$('#nextCommitWithCarry'),
  nextMonthCollections:$('#nextMonthCollections'),
  perAccount:$('#perAccount'),

  tbody:$('#tbody'), type:$('#type'), amount:$('#amount'), date:$('#date'), desc:$('#desc'),
  account:$('#account'), category:$('#category'), linkCommit:$('#linkCommit'),
  saveTx:$('#saveTx'), resetForm:$('#resetForm'), search:$('#search'),

  exportJson:$('#exportJson'), exportCsv:$('#exportCsv'), importFile:$('#importFile'), syncNow:$('#syncNow'),

  newAccountName:$('#newAccountName'), newAccountOpening:$('#newAccountOpening'), addAccount:$('#addAccount'), accountsList:$('#accountsList'),

  newCatName:$('#newCatName'), newCatType:$('#newCatType'), addCategory:$('#addCategory'), catsList:$('#catsList'),

  monthPicker:$('#monthPicker'), refreshReports:$('#refreshReports'), tbodyMonthly:$('#tbodyMonthly'), chartMonthly:$('#chartMonthly'),
  monthSelectedLabel:$('#monthSelectedLabel'), monthStatIncome:$('#monthStatIncome'), monthStatExpense:$('#monthStatExpense'),
  monthStatNet:$('#monthStatNet'), monthStatTx:$('#monthStatTx'), monthStatAvg:$('#monthStatAvg'), monthNoData:$('#monthNoData'),
  monthCatsExpense:$('#monthCatsExpense'), monthCatsIncome:$('#monthCatsIncome'),

  /* التزامات */
  cName:$('#cName'), cAmount:$('#cAmount'), cFirstDue:$('#cFirstDue'), cRecurring:$('#cRecurring'), cEndAt:$('#cEndAt'),
  addCommitment:$('#addCommitment'), tbodyCommit:$('#tbodyCommit'),

  /* تحصيل */
  coName:$('#coName'), coAmount:$('#coAmount'), coFirstDue:$('#coFirstDue'), coRecurring:$('#coRecurring'), coEndAt:$('#coEndAt'),
  addCollect:$('#addCollect'), tbodyCollect:$('#tbodyCollect'),

  /* PWA & تحويل */
  installBtn:$('#installBtn'),
  trFrom:$('#trFrom'), trTo:$('#trTo'), trAmount:$('#trAmount'), trFee:$('#trFee'), trDate:$('#trDate'), trDesc:$('#trDesc'),
  execTransfer:$('#execTransfer'), resetTransfer:$('#resetTransfer'),

  /* GitHub */
  ghUser:$('#ghUser'), ghRepo:$('#ghRepo'), ghBranch:$('#ghBranch'), ghPath:$('#ghPath'), ghToken:$('#ghToken'),
  ghAuto:$('#ghAuto'), ghSaveCfg:$('#ghSaveCfg'), ghTest:$('#ghTest'), ghPull:$('#ghPull'), ghPush:$('#ghPush'), ghStatus:$('#ghStatus'),

  /* إجمالي الاستحقاقات + كروت الموبايل */
  dueTotalBadge:$('#dueTotalBadge'), dueNextTotalBadge:$('#dueNextTotalBadge'), dueSoonCards:$('#dueSoonCards'),
  
  /* تبديل الوضع */
  themeToggle:$('#themeToggle')
};
['saveTx','resetForm','addAccount','addCategory','exportJson','exportCsv','refreshReports','addCommitment','addCollect','execTransfer','resetTransfer','syncNow','ghSaveCfg','ghTest','ghPull','ghPush']
  .forEach(id=>document.getElementById(id)?.setAttribute('type','button'));

/* Utils */
const eid=()=>Math.random().toString(36).slice(2,10)+Date.now().toString(36);
const fmt=n=>Number(n).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const escapeHtml=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
const YM=()=>new Date().toISOString().slice(0,7);
const parseLocalDate=d=>d?new Date(d+'T00:00:00'):new Date(NaN);
const formatLocalDate=d=>d.toISOString().slice(0,10);
const startOfToday=()=>parseLocalDate(formatLocalDate(new Date()));
const daysBetween=(d1,d2)=>Math.round((d2-d1)/(1000*60*60*24));
const addMonthsToYm=(ym,count)=>{
  const [y,m]=ym.split('-').map(Number);
  const d=new Date(y,m-1+count,1);
  return d.toISOString().slice(0,7);
};
function addMonthsPreserveDOM(date,count){
  const dayOfMonth=date.getDate();
  const nextDate=new Date(date.getFullYear(),date.getMonth()+count,dayOfMonth);
  if(nextDate.getDate()!==dayOfMonth){
    return new Date(date.getFullYear(),date.getMonth()+count+1,0); // اليوم الأخير من الشهر
  }
  return nextDate;
}
const monthLabel=ym=>{
  const [y,m]=ym.split('-').map(Number);
  return new Date(y,m-1,1).toLocaleString('ar-EG',{month:'long',year:'numeric'});
};
const chooseAccount=()=>{
  const names=accounts.map(a=>a.name);
  if(names.length===0) return null;
  if(names.length===1) return names[0];
  const choice=prompt('اختر الحساب لسداد الالتزام:',names[0]);
  return choice;
};

/* ===== التخزين ===== */
function saveLedger(){localStorage.setItem(KEY,JSON.stringify(ledger));if(ghCfg.autoSync) ghPush();}
function saveAccounts(){localStorage.setItem(ACC_KEY,JSON.stringify(accounts));}
function saveCategories(){localStorage.setItem(CAT_KEY,JSON.stringify(categories));}
function saveCommitments(){localStorage.setItem(COM_KEY,JSON.stringify(commitments));}
function saveCollections(){localStorage.setItem(COL_KEY,JSON.stringify(collections));}
function saveGhCfg(){localStorage.setItem(GH_KEY,JSON.stringify(ghCfg));}
function saveTheme(theme){document.body.dataset.theme=theme;localStorage.setItem(THEME_KEY,theme);}

/* ===== الحسابات (Accounts) ===== */
function renderAccounts(){
  if(!els.accountsList) return;
  els.accountsList.innerHTML=accounts.map((a,i)=>{
    return `<div class="badge">${escapeHtml(a.name)} (${fmt(a.opening)} ج.م)
      <button class="btn btn-muted" onclick="editAccount(${i})"><i class="fas fa-edit"></i></button>
      <button class="btn btn-muted" onclick="removeAccount(${i})" style="color:var(--danger)"><i class="fas fa-trash"></i></button>
    </div>`;
  }).join('');
  renderTxAccountSelect();
  renderTransferSelects();
}
window.editAccount=i=>{
  const cur=accounts[i];
  const newName=prompt('اسم الحساب الجديد:', cur.name);
  if(newName===null) return;
  const newOpening=prompt('الرصيد الافتتاحي الجديد:', cur.opening);
  if(newOpening===null||isNaN(parseFloat(newOpening))) return alert('رصيد غير صحيح');
  
  const oldName=cur.name;
  cur.name=newName.trim();
  cur.opening=parseFloat(newOpening);
  ledger.filter(t=>t.account===oldName).forEach(t=>t.account=cur.name);
  
  saveAccounts();
  saveLedger();
  txPage = 1;
  render();
};
window.removeAccount=i=>{
  const name=accounts[i].name;
  if(!confirm(`هل تريد حذف حساب ${name}؟ سيتم حذف كل الحركات المرتبطة به!`)) return;
  accounts.splice(i,1);
  ledger=ledger.filter(t=>t.account!==name);
  saveAccounts();
  saveLedger();
  txPage = 1;
  render();
};
document.getElementById('addAccount')?.addEventListener('click',()=>{
  const name=els.newAccountName.value.trim();
  const opening=parseFloat(els.newAccountOpening.value||'0');
  if(!name){ alert('ادخل اسم الحساب'); return; }
  const existingIndex=accounts.findIndex(a=>a.name===name);
  if(existingIndex!==-1){
    accounts[existingIndex]={name,opening};
    els.addAccount.textContent='إضافة حساب';
  } else {
    accounts.push({name,opening});
  }
  els.newAccountName.value='';
  els.newAccountOpening.value='';
  saveAccounts();
  saveLedger();
});
function renderTxAccountSelect(){
  if(!els.account) return;
  const opts=accounts.map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
  els.account.innerHTML=opts;
  // فلاتر الحركات
  if(els.fAccount){
    els.fAccount.innerHTML=`<option value="all">كل الحسابات</option>`+opts;
  }
}
function buildAccountOptions(excludeName=null){
  return accounts.filter(a=>a.name!==excludeName)
    .map(a=>`<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
}

/* ===== الفئات (عرض جدول) ===== */
function renderCategories(){
  if(!els.catsList) return;
  const list=categories.map((c,i)=>{
    const color=c.type==='income'?'var(--ok)':'var(--danger)';
    const typeText=c.type==='income'?'دخل':'مصروف';
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td><span style="color:${color}">${typeText}</span></td>
      <td class="actions">
        <button class="btn btn-outline" onclick="editCatIdx(${i})">تعديل</button>
        <button class="btn btn-danger" onclick="removeCat(${i})">حذف</button>
      </td>
    </tr>`;
  }).join('');
  els.catsList.innerHTML=list;
}
window.editCatIdx=i=>{
  const cur=categories[i];
  const newName=prompt('اسم الفئة الجديد:', cur.name);
  if(newName===null) return;
  const newType=prompt('نوع الفئة الجديد (income/expense)', cur.type);
  if(newType!=='income'&&newType!=='expense') return alert('نوع غير صحيح');
  
  const oldName=cur.name;
  cur.name=newName.trim();
  cur.type=newType;
  
  ledger.filter(t=>t.category===oldName).forEach(t=>t.category=cur.name);
  
  saveCategories();
  refreshCategorySelect();
  render();
};
window.removeCat=i=>{
  const name=categories[i].name;
  if(!confirm(`هل تريد حذف فئة ${name}؟ لن يتم حذف الحركات المرتبطة بها لكن ستصبح 'غير مصنفة'.`)) return;
  categories.splice(i,1);
  ledger.filter(t=>t.category===name).forEach(t=>t.category='غير مصنفة');
  saveCategories();
  refreshCategorySelect();
  render();
};
document.getElementById('addCategory')?.addEventListener('click',()=>{
  const name=els.newCatName.value.trim();
  const type=els.newCatType.value;
  if(!name){ alert('ادخل اسم الفئة'); return; }
  
  const existingIndex=categories.findIndex(c=>c.name===name);
  if(existingIndex!==-1){
    categories[existingIndex]={name,type};
  } else {
    categories.push({name,type});
  }
  els.newCatName.value='';
  els.newCatType.value='expense';
  saveCategories();
  refreshCategorySelect();
  render();
});

/* ===== الحركات (Ledger) ===== */
let txPage=1, txPerPage=20, txFilter={search:'',type:'all',account:'all',from:'',to:''};

function filterLedger(data){
  let filtered=data;
  // البحث بالوصف
  if(txFilter.search){
    const s=txFilter.search.toLowerCase();
    filtered=filtered.filter(t=>t.desc.toLowerCase().includes(s));
  }
  // فلاتر النوع والحساب
  if(txFilter.type!=='all') filtered=filtered.filter(t=>t.type===txFilter.type);
  if(txFilter.account!=='all') filtered=filtered.filter(t=>t.account===txFilter.account);
  // فلاتر التاريخ
  if(txFilter.from) filtered=filtered.filter(t=>t.date>=txFilter.from);
  if(txFilter.to) filtered=filtered.filter(t=>t.date<=txFilter.to);
  
  filtered.sort((a,b)=>b.date.localeCompare(a.date)||(b.timestamp||0)-(a.timestamp||0));
  return filtered;
}
function renderTxTable(data){
  const filtered=filterLedger(data);
  const totalPages=Math.max(1,Math.ceil(filtered.length/txPerPage));
  txPage=Math.min(txPage,totalPages);
  const start=(txPage-1)*txPerPage;
  const end=start+txPerPage;
  const paginated=filtered.slice(start,end);
  const {after:balanceAfter}=computeBalances(data);

  if(els.tbody) els.tbody.innerHTML=paginated.map(t=>{
    const cls=t.type==='income'?'inc':'exp';
    const afterBal=balanceAfter.get(t.id)||0;
    
    return `<tr>
      <td>${t.date}</td>
      <td>${escapeHtml(t.desc||'غير مصنف')}</td>
      <td>${escapeHtml(t.category||'غير مصنفة')}</td>
      <td>${escapeHtml(t.account)}</td>
      <td class="amount ${cls}">${fmt(t.amount)}</td>
      <td class="${afterBal>=0?'pos':'neg'}">${fmt(afterBal)}</td>
      <td class="actions">
        <button class="btn btn-outline" onclick="editTx('${t.id}')">تعديل</button>
        <button class="btn btn-danger" onclick="removeTx('${t.id}')">حذف</button>
      </td>
    </tr>`;
  }).join('');
  
  if(els.txPager){
    els.txPager.style.display=filtered.length>txPerPage?'flex':'none';
    $('#txPagerInfo').textContent=`صفحة ${txPage} / ${totalPages}`;
    $('#txPrev').disabled=txPage===1;
    $('#txNext').disabled=txPage===totalPages;
  }
}

// إضافة/تعديل حركة
function renderCommitLink(currentId=null){
  if(!els.linkCommit) return;
  
  // فقط للمصروفات التي ليست تحويلات
  if(els.type.value==='expense'&&!['تحويل صادر','عمولة تحويل'].includes(els.category.value)){
    els.linkCommit.parentElement.style.display='block';
    const opts=commitments
      .filter(c=>!currentId || c.id===currentId || hasDueInMonth(c, YM()))
      .map(c=>`<option value="${c.id}">${escapeHtml(c.name)} (${fmt(c.amount)})</option>`)
      .join('');
    els.linkCommit.innerHTML = `<option value="">— بدون —</option>` + opts;
  } else {
    els.linkCommit.parentElement.style.display='none';
    els.linkCommit.innerHTML = `<option value="">— بدون —</option>`;
  }
}
window.editTx=id=>{
  const tx=ledger.find(t=>t.id===id);
  if(!tx) return;
  editId=id;
  
  els.saveTx.textContent='تحديث الحركة';
  els.type.value=tx.type;
  els.amount.value=tx.amount;
  els.date.value=tx.date;
  els.desc.value=tx.desc;
  els.account.value=tx.account;
  refreshCategorySelect();
  els.category.value=tx.category;
  renderCommitLink(tx.linkCommitId);
  els.linkCommit.value=tx.linkCommitId||'';
  window.scrollTo({top:0,behavior:'smooth'});
};
let editId=null;
window.removeTx=id=>{
  const tx=ledger.find(t=>t.id===id);
  if(!tx) return;
  if(!confirm(`هل تريد حذف حركة "${tx.desc||'غير مصنف'}" بمبلغ ${fmt(tx.amount)}؟`)) return;

  // إلغاء تأثير الحركة على الالتزام (إن وجدت)
  if(tx.type==='expense'&&tx.linkCommitId){
    const ym=tx.date.slice(0,7);
    const c=commitments.find(x=>x.id===tx.linkCommitId);
    if(c && c.payments?.[ym]){
      c.payments[ym]=Math.max(0,(c.payments[ym]-tx.amount));
      saveCommitments();
    }
  }
  ledger=ledger.filter(t=>t.id!==id);
  saveLedger();
  txPage = 1;
  render();
};
document.getElementById('saveTx')?.addEventListener('click',()=>{
  const type=els.type.value;
  const amount=parseFloat(els.amount.value);
  const date=els.date.value;
  const desc=els.desc.value.trim();
  const account=els.account.value;
  const category=els.category.value;
  const linkCommitId=els.linkCommit.value||null;

  if(isNaN(amount)||amount<=0){ alert('ادخل مبلغ صحيح'); return; }
  if(!date){ alert('ادخل التاريخ'); return; }
  if(!account){ alert('ادخل الحساب'); return; }
  if(!category){ alert('ادخل الفئة'); return; }

  const newTx={
    id:editId||eid(), date, desc, type, amount, account, category, linkCommitId,
    timestamp: Date.now()
  };

  if(editId){
    // عند التعديل
    const was=ledger.find(t=>t.id===editId);
    if(was){
      // إذا كانت الحركة القديمة مرتبطة بالتزام، نلغي تأثيرها أولاً
      if(was.type==='expense'&&was.linkCommitId){
        const ym=was.date.slice(0,7);
        const c=commitments.find(x=>x.id===was.linkCommitId);
        if(c && c.payments?.[ym]){
          c.payments[ym]=Math.max(0,(c.payments[ym]-was.amount));
        }
      }
      // إذا كانت الحركة الجديدة مرتبطة بالتزام، نطبق تأثيرها
      if(newTx.type==='expense'&&newTx.linkCommitId){
        const ym=newTx.date.slice(0,7);
        const c=commitments.find(x=>x.id===newTx.linkCommitId);
        if(c){
          c.payments[ym]=(c.payments[ym]||0)+newTx.amount;
        }
      }
      if(newTx.type==='expense'||was.type==='expense') saveCommitments();
    }
    ledger=ledger.filter(t=>t.id!==editId);
  } else {
    // عند الإضافة
    // إذا كانت الحركة مرتبطة بالتزام، نطبق تأثيرها
    if(newTx.type==='expense'&&newTx.linkCommitId){
      const ym=newTx.date.slice(0,7);
      const c=commitments.find(x=>x.id===newTx.linkCommitId);
      if(c){
        c.payments[ym]=(c.payments[ym]||0)+newTx.amount;
        saveCommitments();
      }
    }
  }
  
  // إذا كانت حركة تحويل، يتم إلغاء ربط الالتزام (لأنها لا يجب أن تكون كذلك)
  if(['تحويل صادر','تحويل وارد','عمولة تحويل'].includes(newTx.category)){
    delete newTx.linkCommitId;
  }
  
  ledger.push(newTx);
  saveLedger();
  
  // إعادة ضبط النموذج
  editId=null;
  els.saveTx.textContent='حفظ';
  els.amount.value='';
  els.desc.value='';
  els.linkCommit.value='';
  renderCommitLink();
  txPage = 1;
  render();
});
document.getElementById('resetForm')?.addEventListener('click',()=>{
  editId=null;
  els.saveTx.textContent='حفظ';
  els.amount.value='';
  els.desc.value='';
  els.linkCommit.value='';
  els.date.value=formatLocalDate(new Date());
  els.type.value='expense';
  refreshCategorySelect();
  renderCommitLink();
});
els.type.addEventListener('change',()=>{
  refreshCategorySelect();
  renderCommitLink();
});
els.category.addEventListener('change', renderCommitLink);

// فلاتر الحركات
els.search?.addEventListener('input',()=>{ txFilter.search=els.search.value; txPage=1; renderTxTable(ledger); });
els.fType?.addEventListener('change',()=>{ txFilter.type=els.fType.value; txPage=1; renderTxTable(ledger); });
els.fAccount?.addEventListener('change',()=>{ txFilter.account=els.fAccount.value; txPage=1; renderTxTable(ledger); });
els.fFrom?.addEventListener('change',()=>{ txFilter.from=els.fFrom.value; txPage=1; renderTxTable(ledger); });
els.fTo?.addEventListener('change',()=>{ txFilter.to=els.fTo.value; txPage=1; renderTxTable(ledger); });
$('#clearFilters')?.addEventListener('click',()=>{
  txFilter={search:'',type:'all',account:'all',from:'',to:''};
  els.search.value=''; els.fType.value='all'; els.fAccount.value='all'; els.fFrom.value=''; els.fTo.value='';
  txPage=1;
  renderTxTable(ledger);
});
$('#txPrev')?.addEventListener('click',()=>{ txPage=Math.max(1,txPage-1); renderTxTable(ledger); });
$('#txNext')?.addEventListener('click',()=>{ txPage++; renderTxTable(ledger); });

function refreshCategorySelect(){
  if(!els.category) return;
  const incCats=categories.filter(c=>c.type==='income').map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`);
  const expCats=categories.filter(c=>c.type==='expense').map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`);
  const allCats=categories.filter(c=>c.name!=='تحويل صادر'&&c.name!=='تحويل وارد'&&c.name!=='عمولة تحويل').map(c=>`<option value="${escapeHtml(c.name)}">${escapeHtml(c.name)}</option>`).join('');

  if(els.type.value==='income'){
    els.category.innerHTML=incCats.join('');
  } else {
    els.category.innerHTML=expCats.join('');
  }
  if(els.fCategory) els.fCategory.innerHTML=`<option value="all">كل الفئات</option>`+allCats;
}

// هذا التعديل يحل خطأ Uncaught ReferenceError: showScreen is not defined
window.showScreen = function(screenId){ 
  document.querySelectorAll('.screen').forEach(el=>{
    el.classList.remove('active');
  });
  const activeScreen = document.getElementById(screenId);
  if(activeScreen) activeScreen.classList.add('active');
  document.querySelectorAll('.footer-nav button').forEach(btn=>{
    btn.classList.remove('active');
    if(btn.dataset.screen===screenId) btn.classList.add('active');
  });
}

/* ===== الميزان (Recalculate) ===== */
function computeBalances(txs=ledger){
  const bal=new Map(); // اسم الحساب => الرصيد النهائي
  const after=new Map(); // id الحركة => الرصيد بعد الحركة
  // 1. الأرصدة الافتتاحية
  accounts.forEach(a=>bal.set(a.name,Number(a.opening||0)));
  // 2. تطبيق الحركات
  for(const t of txs){
    if(!t.account||!bal.has(t.account)) continue;
    const current=bal.get(t.account)||0;
    const amount=Number(t.amount||0);
    const newBal = current + (t.type==='income' ? amount : -amount);
    bal.set(t.account, newBal);
    after.set(t.id, newBal);
  }
  return {bal, after};
}
function drawPerAccount(balances){
  if(!els.perAccount) return;
  els.perAccount.innerHTML = accounts.map(a=>{
    const bal=balances.get(a.name)||0;
    const cls=bal>=0?'pos':'neg';
    return `<div class="item">${escapeHtml(a.name)}: <span class="${cls}">${fmt(bal)} ج.م</span></div>`;
  }).join('');
}

/* ===== الالتزامات الشهرية والتحصيلات (Commitments & Collections) ===== */
function migrateCommit(c){
  if(!c.payments) c.payments={};
  if(c.firstDue && !c.nextDue){
    const today=startOfToday();
    let due=parseLocalDate(c.firstDue);
    while(due<today){
      const next=addMonthsPreserveDOM(due,1);
      if(c.recurring && (!c.endAt || next<=parseLocalDate(c.endAt))) due=next;
      else break;
    }
    c.nextDue=formatLocalDate(due);
  }
  return c;
}
function migrateCollect(c){
  if(c.firstDue && !c.nextDue){
    const today=startOfToday();
    let due=parseLocalDate(c.firstDue);
    while(due<today){
      const next=addMonthsPreserveDOM(due,1);
      if(c.recurring && (!c.endAt || next<=parseLocalDate(c.endAt))) due=next;
      else break;
    }
    c.nextDue=formatLocalDate(due);
  }
  return c;
}
function hasDueInMonth(item,ym){
  if(!item.recurring) return item.firstDue.slice(0,7)===ym;
  // التزام يتكرر: نتحقق من نطاق البداية والنهاية
  const firstMonth=item.firstDue.slice(0,7);
  const endMonth=item.endAt?item.endAt.slice(0,7):null;
  if(ym<firstMonth) return false;
  if(endMonth && ym>endMonth) return false;
  return true;
}
function addCommitPayment(id, ym, amount){
  const c=commitments.find(x=>x.id===id);
  if(!c) return;
  if(!c.payments) c.payments={};
  c.payments[ym]=(c.payments[ym]||0)+amount;
  saveCommitments();
  drawCommitments();
  drawDueSoon();
}
let editCommitId=null;
function drawCommitments(){
  if(!els.tbodyCommit) return;
  els.tbodyCommit.innerHTML=commitments.map(c=>{
    const ym=YM();
    const paid=(c.payments?.[ym]||0);
    const total=Number(c.amount||0);
    const remaining=Math.max(0,total-paid);
    const repeat=c.recurring?'شهرياً':'مرة واحدة';
    const end=c.endAt?c.endAt:'—';
    const due=c.nextDue||c.firstDue;
    const status=remaining<=0?'<span class="pos">مُسدد</span>':(remaining===total?'<span class="neg">متبقٍ بالكامل</span>':'<span class="warn">مدفوع جزئياً</span>');
    const dueCls=due.slice(0,7)===ym?'warn':'muted';
    
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(total)}</td>
      <td><span class="${dueCls}">${due}</span></td>
      <td class="pos">${fmt(paid)}</td>
      <td class="neg">${fmt(remaining)}</td>
      <td>${repeat}</td>
      <td>${end}</td>
      <td class="actions">
        ${remaining>0?`<button class="btn btn-primary" onclick="payCommitment('${c.id}')">سداد المتبقي</button>`:''}
        <button class="btn btn-outline" onclick="editCommit('${c.id}')">تعديل</button>
        <button class="btn btn-danger" onclick="removeCommit('${c.id}')">حذف</button>
      </td>
    </tr>`;
  }).join('');
  endRequiredToggleCommit();
}
window.editCommit=id=>{
  const c=commitments.find(x=>x.id===id);
  if(!c) return;
  editCommitId=id;
  els.addCommitment.textContent='تحديث الالتزام';
  els.cName.value=c.name;
  els.cAmount.value=c.amount;
  els.cFirstDue.value=c.firstDue;
  els.cRecurring.checked=!!c.recurring;
  els.cEndAt.value=c.endAt||'';
  window.scrollTo({top:0,behavior:'smooth'});
  endRequiredToggleCommit();
};
window.removeCommit=id=>{
  if(!confirm('هل تريد حذف هذا الالتزام؟')) return;
  commitments=commitments.filter(c=>c.id!==id);
  saveCommitments();
  drawCommitments();
  drawDueSoon();
};
document.getElementById('addCommitment')?.addEventListener('click',()=>{
  const name=els.cName.value.trim();
  const amount=parseFloat(els.cAmount.value);
  const firstDue=els.cFirstDue.value;
  const recurring=els.cRecurring.checked;
  const endAt=els.cEndAt.value||null;

  if(!name||isNaN(amount)||amount<=0||!firstDue){
    alert('يجب إدخال الاسم والمبلغ وتاريخ أول استحقاق');
    return;
  }
  if(recurring&&!endAt){
    alert('يجب إدخال تاريخ انتهاء للالتزام المتكرر');
    return;
  }
  
  const newCommit={
    id:editCommitId||eid(), name, amount, firstDue, recurring, endAt
  };
  
  if(editCommitId){
    commitments=commitments.filter(c=>c.id!==editCommitId);
  }
  
  commitments.push(migrateCommit(newCommit));
  saveCommitments();
  
  editCommitId=null;
  els.addCommitment.textContent='إضافة/تحديث';
  els.cName.value=''; els.cAmount.value=''; els.cFirstDue.value=''; els.cRecurring.checked=false; els.cEndAt.value='';
  
  drawCommitments();
  drawDueSoon();
  renderCommitLink();
});
els.cRecurring?.addEventListener('change',endRequiredToggleCommit);
function endRequiredToggleCommit(){
  els.cEndAt.required=els.cRecurring.checked;
  els.cEndAt.parentElement.querySelector('label').textContent=`ينتهي في (إجباري ${els.cRecurring.checked?'عند التكرار':'اختياري'})`;
}
window.payCommitment=id=>{
  const c=commitments.find(x=>x.id===id);
  if(!c) return;
  
  const dateStr=formatLocalDate(new Date());
  const ym=dateStr.slice(0,7);
  
  const paid=(c.payments?.[ym]||0);
  const remain=Math.max(0,(Number(c.amount||0)-paid));
  if(remain<=0){ alert('لا يوجد مبلغ متبقٍ لهذا الشهر.'); return; }
  
  const accName=chooseAccount();
  if(!accName) return;

  if(!confirm(`سداد كامل متبقّي الالتزام "${c.name}" بقيمة ${fmt(remain)} ج.م من "${accName}" بتاريخ ${dateStr}؟`)) return;

  const tx={
    id:eid(), date:dateStr, desc:`${c.name} (سداد التزام)`, type:'expense', amount:remain, account:accName, category:'التزامات شهرية', linkCommitId:c.id,
    timestamp: Date.now()
  };
  ledger.push(tx);
  saveLedger();
  addCommitPayment(c.id, ym, remain);
  txPage = 1;
  render();
};
let editCollectId=null;
function drawCollections(){
  if(!els.tbodyCollect) return;
  els.tbodyCollect.innerHTML=collections.map(c=>{
    const repeat=c.recurring?'شهرياً':'مرة واحدة';
    const end=c.endAt?c.endAt:'—';
    const due=c.nextDue||c.firstDue;

    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${due}</td>
      <td>${repeat}</td>
      <td>${end}</td>
      <td class="actions">
        <button class="btn btn-primary" onclick="collectNow('${c.id}')">تم التحصيل</button>
        <button class="btn btn-outline" onclick="editCollect('${c.id}')">تعديل</button>
        <button class="btn btn-danger" onclick="removeCollect('${c.id}')">حذف</button>
      </td>
    </tr>`;
  }).join('');
  endRequiredToggleCollect();
}
window.editCollect=id=>{
  const c=collections.find(x=>x.id===id);
  if(!c) return;
  editCollectId=id;
  els.addCollect.textContent='تحديث التحصيل';
  els.coName.value=c.name;
  els.coAmount.value=c.amount;
  els.coFirstDue.value=c.firstDue;
  els.coRecurring.checked=!!c.recurring;
  els.coEndAt.value=c.endAt||'';
  window.scrollTo({top:0,behavior:'smooth'});
  endRequiredToggleCollect();
};
window.removeCollect=id=>{
  if(!confirm('هل تريد حذف هذا التحصيل؟')) return;
  collections=collections.filter(c=>c.id!==id);
  saveCollections();
  drawCollections();
  drawDueSoon();
};
document.getElementById('addCollect')?.addEventListener('click',()=>{
  const name=els.coName.value.trim();
  const amount=parseFloat(els.coAmount.value);
  const firstDue=els.coFirstDue.value;
  const recurring=els.coRecurring.checked;
  const endAt=els.coEndAt.value||null;

  if(!name||isNaN(amount)||amount<=0||!firstDue){
    alert('يجب إدخال الاسم والمبلغ وتاريخ أول تحصيل');
    return;
  }
  if(recurring&&!endAt){
    alert('يجب إدخال تاريخ انتهاء للتحصيل المتكرر');
    return;
  }
  
  const newCollect={
    id:editCollectId||eid(), name, amount, firstDue, recurring, endAt
  };
  
  if(editCollectId){
    collections=collections.filter(c=>c.id!==editCollectId);
  }
  
  collections.push(migrateCollect(newCollect));
  saveCollections();
  
  editCollectId=null;
  els.addCollect.textContent='إضافة/تحديث';
  els.coName.value=''; els.coAmount.value=''; els.coFirstDue.value=''; els.coRecurring.checked=false; els.coEndAt.value='';
  
  drawCollections();
  drawDueSoon();
});
els.coRecurring?.addEventListener('change',endRequiredToggleCollect);
function endRequiredToggleCollect(){
  els.coEndAt.required=els.coRecurring.checked;
  els.coEndAt.parentElement.querySelector('label').textContent=`ينتهي في (إجباري ${els.coRecurring.checked?'عند التكرار':'اختياري'})`;
}
window.collectNow=id=>{
  const c=collections.find(x=>x.id===id);
  if(!c) return;
  
  const dateStr=formatLocalDate(new Date());
  const ym=dateStr.slice(0,7);
  
  const accName=chooseAccount();
  if(!accName) return;

  if(!confirm(`تحصيل مبلغ "${c.name}" بقيمة ${fmt(c.amount)} ج.م في حساب "${accName}" بتاريخ ${dateStr}؟`)) return;

  const tx={
    id:eid(), date:dateStr, desc:`${c.name} (تحصيل مبلغ)`, type:'income', amount:Number(c.amount), account:accName, category:'تحصيلات شهرية',
    timestamp: Date.now()
  };
  ledger.push(tx);
  saveLedger();
  
  // تحديث تاريخ الاستحقاق القادم
  if(c.recurring){
    const nextDue=addMonthsPreserveDOM(parseLocalDate(c.nextDue||c.firstDue), 1);
    if(c.endAt && nextDue>parseLocalDate(c.endAt)){
      // وصل لنهاية التكرار، يتم حذفه
      collections=collections.filter(x=>x.id!==id);
      saveCollections();
    } else {
      c.nextDue=formatLocalDate(nextDue);
      saveCollections();
    }
  } else {
    // مرة واحدة، يتم حذفه
    collections=collections.filter(x=>x.id!==id);
    saveCollections();
  }
  
  drawCollections();
  txPage = 1;
  render();
};

function sumCurrentMonthCommitments(){
  const ym=YM();
  let total=0;
  for(const c of commitments){
    const due=(c.nextDue||c.firstDue||'');
    if(due.slice(0,7)===ym){
      const paid=(c.payments?.[ym]||0);
      const remain=Math.max(0,(Number(c.amount||0)-paid));
      total += remain;
    }
  }
  return total;
}
function sumCurrentMonthCollections(){
  const ym=YM();
  let total=0;
  for(const c of collections){
    const due=(c.nextDue||c.firstDue||'');
    if(due.slice(0,7)===ym){
      total += Number(c.amount||0);
    }
  }
  return total;
}
function sumNextMonthCommitmentsIncludingCarry(){
  const ym=YM();
  const nextYm=addMonthsToYm(ym,1);

  // المتبقي من الشهر الحالي (غير المسدد)
  let currentRemain = 0;
  for(const c of commitments){
    const due=(c.nextDue||c.firstDue||'');
    if(due.slice(0,7)===ym){
      const paid=(c.payments?.[ym]||0);
      const remain=Math.max(0,(Number(c.amount||0)-paid));
      currentRemain += remain;
    }
  }

  // التزامات الشهر القادم
  let nextRemain = 0;
  for(const c of commitments){
    if(!hasDueInMonth(c, nextYm)) continue;
    const paidNext=(c.payments?.[nextYm]||0);
    const remainNext=Math.max(0,(Number(c.amount||0)-paidNext));
    nextRemain += remainNext;
  }
  return currentRemain + nextRemain;
}
function sumNextMonthCollections(){
  const ym=YM();
  const nextYm=addMonthsToYm(ym,1);
  let total=0;
  for(const c of collections){
    if(hasDueInMonth(c, nextYm)){
      total += Number(c.amount||0);
    }
  }
  return total;
}

function recalc(){
  const {bal}=computeBalances();
  let total=0;
  for(const v of bal.values()) total+=v;
  
  const monthComRemain = sumCurrentMonthCommitments();
  const currentCol = sumCurrentMonthCollections();
  const nextComWithCarry = sumNextMonthCommitmentsIncludingCarry();
  const nextCol = sumNextMonthCollections();

  els.totalBalance.textContent = fmt(total);
  els.monthCommitTotal.textContent = fmt(monthComRemain);
  els.currentMonthCollections.textContent = fmt(currentCol);
  els.balanceAfterCommitments.textContent = fmt(total - monthComRemain);
  els.nextCommitWithCarry.textContent = fmt(nextComWithCarry);
  els.nextMonthCollections.textContent = fmt(nextCol);
  
  els.dueTotalBadge.textContent=`إجمالي: ${fmt(sumCurrentMonthCommitments())} ج.م`;
  els.dueNextTotalBadge.textContent=`الشهر القادم: ${fmt(sumNextMonthCommitmentsExcludingCurrentCarry())} ج.م`;

  drawPerAccount(bal);
}
function sumNextMonthCommitmentsExcludingCurrentCarry(){
  const ym=YM();
  const nextYm=addMonthsToYm(ym,1);
  let nextRemain = 0;
  for(const c of commitments){
    if(!hasDueInMonth(c, nextYm)) continue;
    const paidNext=(c.payments?.[nextYm]||0);
    const remainNext=Math.max(0,(Number(c.amount||0)-paidNext));
    nextRemain += remainNext;
  }
  return nextRemain;
}
function drawDueSoon(){
  const today=startOfToday();
  const ym=YM();
  
  let htmlTable='';
  let htmlCards='';
  let hasUnpaid=false;

  for(const c of commitments){
    // تحديد الاستحقاق القادم الذي يقع في الشهر الحالي (YM)
    let dueStr=c.nextDue||c.firstDue||'';
    if(dueStr.slice(0,7)!==ym) continue; // ليس استحقاق هذا الشهر

    const paid=(c.payments?.[ym]||0);
    const total=Number(c.amount||0);
    const remaining=Math.max(0,total-paid);
    
    if(remaining<=0) continue; // تم التسديد
    hasUnpaid=true;

    const daysLeft=daysBetween(today,parseLocalDate(dueStr));
    const statusCls=daysLeft<0?'danger':(daysLeft<=7?'warn':'ok');
    const statusText=daysLeft<0?`متأخر بـ ${Math.abs(daysLeft)} يوم`:`باقٍ ${daysLeft} يوم`;
    
    htmlTable+=`<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${dueStr}</td>
      <td>${fmt(total)}</td>
      <td class="pos">${fmt(paid)}</td>
      <td class="neg">${fmt(remaining)}</td>
      <td><span style="color:var(--${statusCls})">${statusText}</span></td>
      <td class="actions">
        <button class="btn btn-primary" onclick="payCommitment('${c.id}')">سداد</button>
      </td>
    </tr>`;

    // كروت الموبايل
    htmlCards+=`<div class="card" style="padding:14px;border-color:var(--${statusCls})">
      <div style="font-weight:700;font-size:16px">${escapeHtml(c.name)}</div>
      <div style="font-size:14px;color:var(--muted)">المتبقي: <span class="neg">${fmt(remaining)} ج.م</span> (الأصل: ${fmt(total)})</div>
      <div style="font-size:12px;color:var(--muted)">تاريخ الاستحقاق: ${dueStr} - <span style="color:var(--${statusCls})">${statusText}</span></div>
      <button class="btn btn-primary" onclick="payCommitment('${c.id}')" style="margin-top:8px;width:100%;height:36px">سداد المتبقي</button>
    </div>`;
  }

  // كروت الموبايل (في شاشة الملخص)
  if(els.dueSoonCards){
    els.dueSoonCards.innerHTML=htmlCards;
    els.dueSoonCards.style.display=hasUnpaid?'grid':'none';
  }
  // جدول (في شاشة الملخص)
  if(els.tbodyDueSoon){
    els.tbodyDueSoon.innerHTML=htmlTable;
    $('#dueSoonWrap').style.display=htmlTable?'block':'none';
    $('#noDueSoon').classList.toggle('d-none',hasUnpaid);
  }
}

/* ===== التقارير (Reports) ===== */
let monthlyData = [];
function getMonthlyData(){
  const agg=new Map(); // { 'YYYY-MM': {inc, exp, net} }
  let minMonth=YM(), maxMonth=YM();
  for(const t of ledger){
    if(t.isTransfer) continue;
    const ym=t.date.slice(0,7);
    if(ym<minMonth) minMonth=ym;
    if(ym>maxMonth) maxMonth=ym;
    
    const data=agg.get(ym)||{inc:0,exp:0,net:0,month:ym,txCount:0,totalExpense:0};
    if(t.type==='income') data.inc+=t.amount;
    else if(t.type==='expense'){ data.exp+=t.amount; data.totalExpense+=t.amount;}
    data.txCount++;
    data.net=data.inc-data.exp;
    agg.set(ym,data);
  }
  // ملء الفجوات الشهرية بـ 0
  let cursor=minMonth;
  while(cursor<=maxMonth){
    if(!agg.has(cursor)) agg.set(cursor,{inc:0,exp:0,net:0,month:cursor,txCount:0,totalExpense:0});
    cursor=addMonthsToYm(cursor,1);
  }
  monthlyData=[...agg.values()].sort((a,b)=>a.month.localeCompare(b.month));
}
function renderMonthlyTable(){
  if(!els.tbodyMonthly) return;
  const selectedMonth=els.monthPicker.value;
  els.tbodyMonthly.innerHTML=monthlyData.map(m=>{
    const cls=m.month===selectedMonth?'active':'';
    return `<tr class="${cls}" onclick="selectMonth('${m.month}')">
      <td>${monthLabel(m.month)}</td>
      <td class="pos">${fmt(m.inc)}</td>
      <td class="neg">${fmt(m.exp)}</td>
      <td class="${m.net>=0?'pos':'neg'}">${fmt(m.net)}</td>
    </tr>`;
  }).join('');
}
window.selectMonth=month=>{
  els.monthPicker.value=month;
  renderMonthlyTable();
  drawMonthlyChart(monthlyData);
  drawMonthSummary(month);
};
// مخطط Chart.js
let chartInstance=null;
function drawMonthlyChart(data){
  if(!els.chartMonthly) return;
  getMonthlyData();
  const ctx=els.chartMonthly.getContext('2d');
  if(chartInstance) chartInstance.destroy();
  
  const labels=data.map(d=>monthLabel(d.month));
  const maxVal=Math.max(...data.map(d=>Math.max(d.inc,d.exp,Math.abs(d.net))));
  const incData=data.map(d=>d.inc);
  const expData=data.map(d=>d.exp);
  const netData=data.map(d=>d.net);

  chartInstance=new Chart(ctx,{
    type:'bar',
    data:{
      labels,
      datasets:[
        {
          type:'bar',label:'الدخل',data:incData,
          backgroundColor:'rgba(34,197,94,0.6)',borderColor:'#22c55e',borderWidth:1,yAxisID:'y'
        },{
          type:'bar',label:'المصروف',data:expData,
          backgroundColor:'rgba(239,68,68,0.6)',borderColor:'#ef4444',borderWidth:1,yAxisID:'y'
        },{
          type:'line',label:'الصافي',data:netData,
          backgroundColor:'transparent',borderColor:'#0ea5e9',borderWidth:2,yAxisID:'y',
          pointRadius:5,pointBackgroundColor:'#0ea5e9',tension:0.4
        }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      layout:{padding:{top:10}},
      scales:{
        x:{stacked:true,grid:{color:'rgba(255,255,255,0.05)'}},
        y:{stacked:false,grid:{color:'rgba(255,255,255,0.05)'},suggestedMax:maxVal*1.1}
      },
      plugins:{
        legend:{labels:{color:document.body.dataset.theme==='light'?'#1e293b':'#e5e7eb',usePointStyle:true}},
        tooltip:{rtl:true}
      }
    }
  });
  
  // تحديث الثيمات لـ Chart.js
  document.body.addEventListener('change-theme', (e) => {
    const newTheme = e.detail;
    const isDark = newTheme === 'dark';
    chartInstance.options.scales.x.grid.color = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
    chartInstance.options.scales.y.grid.color = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
    chartInstance.options.plugins.legend.labels.color = isDark ? '#e5e7eb' : '#1e293b';
    chartInstance.update();
  });
}
function drawMonthSummary(ym){
  const data=monthlyData.find(m=>m.month===ym);
  const today=new Date();
  const currentMonth=today.toISOString().slice(0,7)===ym;
  let daysInMonth=30;
  if(currentMonth){
    daysInMonth=today.getDate();
  } else {
    const [y,m]=ym.split('-').map(Number);
    daysInMonth=new Date(y,m,0).getDate();
  }
  
  if(!data){
    els.monthNoData.classList.remove('d-none');
    $('#monthStatIncome').textContent='0.00';
    $('#monthStatExpense').textContent='0.00';
    $('#monthStatNet').textContent='0.00';
    $('#monthStatTx').textContent='0';
    $('#monthStatAvg').textContent='0.00';
    $('#monthCatsExpense').innerHTML='';
    $('#monthCatsIncome').innerHTML='';
    return;
  }
  els.monthNoData.classList.add('d-none');
  
  els.monthSelectedLabel.textContent=monthLabel(ym);
  els.monthStatIncome.textContent=fmt(data.inc);
  els.monthStatExpense.textContent=fmt(data.exp);
  els.monthStatNet.textContent=fmt(data.net);
  els.monthStatTx.textContent=data.txCount;
  els.monthStatAvg.textContent=fmt(data.totalExpense/daysInMonth);
  
  // تفاصيل الفئات
  const txsInMonth=ledger.filter(t=>t.date.slice(0,7)===ym && !t.isTransfer);
  function getCatBreakdown(type){
    const agg=new Map();
    txsInMonth.filter(t=>t.type===type).forEach(t=>{
      const current=agg.get(t.category)||0;
      agg.set(t.category,current+t.amount);
    });
    return [...agg.entries()].sort((a,b)=>b[1]-a[1]);
  }
  
  function renderCatList(breakdown, target, total){
    if(breakdown.length===0){ target.innerHTML='— لا توجد حركات —'; return; }
    target.innerHTML=breakdown.map(([cat,amount])=>{
      const percent=(amount/total)*100;
      const color=type==='income'?'var(--ok)':'var(--danger)';
      return `<div style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;font-size:14px"><span>${escapeHtml(cat)}</span><span>${fmt(amount)} (${percent.toFixed(1)}%)</span></div>
        <div style="height:6px;background:var(--border);border-radius:3px;margin-top:4px">
          <div style="width:${percent}%;height:100%;background:${color};border-radius:3px"></div>
        </div>
      </div>`;
    }).join('');
  }
  
  const expBreakdown=getCatBreakdown('expense');
  renderCatList(expBreakdown, els.monthCatsExpense, data.exp);
  
  const incBreakdown=getCatBreakdown('income');
  renderCatList(incBreakdown, els.monthCatsIncome, data.inc);
}
els.monthPicker?.addEventListener('change',()=>{ selectMonth(els.monthPicker.value); });
els.refreshReports?.addEventListener('click',()=>{ render(); });

/* ===== تحويل بين الحسابات (Transfer) ===== */
function ensureTransferCategories(){
  const need=[{name:'تحويل صادر',type:'expense'},{name:'تحويل وارد',type:'income'},{name:'عمولة تحويل',type:'expense'}];
  let changed=false;
  for(const n of need){
    if(!categories.some(c=>c.name===n.name && c.type===n.type)){
      categories.push(n); changed=true;
    }
  }
  if(changed) saveCategories();
}
function renderTransferSelects(){
  if(els.trFrom) els.trFrom.innerHTML = buildAccountOptions(els.trTo?.value);
  if(els.trTo) els.trTo.innerHTML = buildAccountOptions(els.trFrom?.value);
}
function syncTransferSelects(trigger){
  if(trigger === 'from' && els.trTo){
    const from = els.trFrom.value;
    const prevTo = els.trTo.value;
    els.trTo.innerHTML = buildAccountOptions(from);
    if(prevTo && prevTo !== from && accounts.some(a=>a.name===prevTo)){
      els.trTo.value = prevTo;
    }else{
      els.trTo.selectedIndex = 0;
    }
  } else if(trigger === 'to' && els.trFrom){
    const to = els.trTo.value;
    const prevFrom = els.trFrom.value;
    els.trFrom.innerHTML = buildAccountOptions(to);
    if(prevFrom && prevFrom !== to && accounts.some(a=>a.name===prevFrom)){
      els.trFrom.value = prevFrom;
    }else{
      els.trFrom.selectedIndex = 0;
    }
  }
}
function doTransfer(){
  const from=els.trFrom.value, to=els.trTo.value, amount=parseFloat(els.trAmount.value), fee=parseFloat(els.trFee.value||'0'),
        date=els.trDate.value||formatLocalDate(new Date()), note=els.trDesc.value.trim();
  
  if(!from || !to){ alert('يجب اختيار الحسابين'); return; }
  if(from===to){ alert('يجب اختيار حسابين مختلفين للتحويل'); return; }
  if(isNaN(amount)||amount<=0){ alert('يجب إدخال مبلغ صحيح للتحويل'); return; }
  
  const fromAcc=accounts.find(a=>a.name===from);
  const currentBal=(computeBalances().bal.get(from)||0);
  if(currentBal < amount + fee){
    if(!confirm(`رصيد حساب ${from} (${fmt(currentBal)} ج.م) غير كافٍ لتنفيذ التحويل (${fmt(amount+fee)} ج.م). هل تريد الاستمرار؟`)) return;
  }

  const txFrom={
    id:eid(), date, desc:`${note} (تحويل صادر إلى ${to})`, type:'expense', amount, account:from, category:'تحويل صادر', isTransfer:true,
    timestamp: Date.now()
  };
  const txTo={
    id:eid(), date, desc:`${note} (تحويل وارد من ${from})`, type:'income', amount, account:to, category:'تحويل وارد', isTransfer:true,
    timestamp: Date.now() + 1 // ضمان ترتيب الحركة الـ To بعد الـ From
  };
  
  ledger.push(txFrom);
  ledger.push(txTo);

  // تسجيل العمولة إذا وجدت
  if(fee>0){
    const txFee={
      id:eid(), date, desc:`عمولة تحويل إلى ${to} (${note})`, type:'expense', amount:fee, account:from, category:'عمولة تحويل', isTransfer:true,
      timestamp: Date.now() + 2 // ضمان ترتيب العمولة بعد التحويل
    };
    ledger.push(txFee);
  }
  
  saveLedger();
  
  els.trAmount.value=''; els.trFee.value=''; els.trDesc.value=''; els.trDate.value=formatLocalDate(new Date());
  txPage = 1;
  render();
}
els.trFrom?.addEventListener('change',()=>syncTransferSelects('from'));
els.trTo?.addEventListener('change',()=>syncTransferSelects('to'));
els.execTransfer?.addEventListener('click',doTransfer);
els.resetTransfer?.addEventListener('click',()=>{
  els.trAmount.value=''; els.trFee.value=''; els.trDesc.value=''; els.trDate.value=formatLocalDate(new Date());
});

/* ===== التصدير والاستيراد والمزامنة (Export/Import/Sync) ===== */
document.getElementById('exportJson')?.addEventListener('click', () => {
  const data = {
    ledger,
    accounts,
    categories,
    commitments,
    collections,
    version: 1
  };
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'finance_export_'+formatLocalDate(new Date())+'.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
document.getElementById('exportCsv')?.addEventListener('click', () => {
  const headers = ['التاريخ', 'الوصف', 'النوع', 'المبلغ', 'الحساب', 'الفئة'];
  const csv = [headers.join(',')];
  ledger.forEach(t => {
    const row = [
      `"${t.date}"`,
      `"${t.desc || ''}"`,
      `"${t.type === 'income' ? 'دخل' : 'مصروف'}"`,
      t.amount,
      `"${t.account}"`,
      `"${t.category || ''}"`
    ];
    csv.push(row.join(','));
  });
  const csvContent = csv.join('\n');
  const blob = new Blob(["\uFEFF"+csvContent], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'finance_export_'+formatLocalDate(new Date())+'.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
document.getElementById('importFile')?.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      const data = JSON.parse(event.target.result);
      if(Array.isArray(data.ledger)) ledger=data.ledger.map(t=>t.timestamp?t:{...t,timestamp:Date.now()});
      if(Array.isArray(data.accounts)) accounts=data.accounts;
      if(Array.isArray(data.categories)) categories=data.categories;
      if(Array.isArray(data.commitments)) commitments=data.commitments.map(migrateCommit);
      if(Array.isArray(data.collections)) collections=data.collections.map(migrateCollect);
      saveLedger(); saveAccounts(); saveCategories(); saveCommitments(); saveCollections();
      alert('تم استيراد البيانات بنجاح!');
      txPage = 1;
      render();
    } catch (error) {
      alert('فشل الاستيراد: ملف JSON غير صحيح أو تالف. \nالخطأ: '+error.message);
    }
  };
  reader.readAsText(file);
});
document.getElementById('syncNow')?.addEventListener('click',()=>{
  if(!ghCfg.user) return alert('يرجى حفظ إعدادات GitHub أولاً.');
  ghPull();
});

/* ===== GitHub Sync ===== */
function ghStatus(msg,ok=true){
  if(!els.ghStatus) return;
  els.ghStatus.textContent=`الحالة: ${msg}`;
  els.ghStatus.style.borderColor=ok?'var(--ok)':'var(--danger)';
  els.ghStatus.style.color=ok?'var(--ok)':'var(--danger)';
}
async function gh_api(url,method='GET',data=null){
  const headers={'Accept':'application/vnd.github.v3+json'};
  if(ghCfg.token){
    headers['Authorization']=`token ${ghCfg.token}`;
  }
  if(method!=='GET'&&method!=='HEAD'){
    headers['Content-Type']='application/json';
  }
  const body=data?JSON.stringify(data):undefined;
  
  const res=await fetch(url,{method,headers,body});
  const json=await res.json();
  
  if(!res.ok){
    throw new Error(json.message||`HTTP Error: ${res.status}`);
  }
  return json;
}
async function ghTest(){
  ghStatus('جاري الاختبار...');
  try{
    const repo=await gh_api(`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}`,'GET');
    const file=await gh_read_file(false);
    ghStatus(`نجح الاختبار! المستودع: ${repo.full_name}. حالة الملف: ${file?'موجود':'غير موجود'}`);
  } catch(e){
    ghStatus('فشل الاختبار: '+e.message,false);
  }
}
async function gh_read_file(updateStatus=true){
  if(!ghCfg.user||!ghCfg.repo||!ghCfg.path) throw new Error('يرجى إدخال اسم المستخدم والمستودع ومسار الملف في الإعدادات.');
  if(!ghCfg.token) throw new Error('يرجى إدخال Personal Access Token للمزامنة.');
  
  if(updateStatus) ghStatus('جاري قراءة الملف...');
  const url=`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/contents/${ghCfg.path}?ref=${ghCfg.branch}`;
  try{
    const fileData=await gh_api(url,'GET');
    if(updateStatus) ghStatus('تم قراءة الملف بنجاح.');
    return fileData;
  } catch(e){
    if(e.message.includes('404')) return null; // الملف غير موجود
    throw e;
  }
}
async function ghPull(){
  ghStatus('جاري التحميل...');
  try{
    const file=await gh_read_file(false);
    if(!file){
      ghStatus('فشل التحميل: الملف غير موجود على GitHub.',false);
      return;
    }
    const content=atob(file.content);
    const data=JSON.parse(content);

    // تطبيق الاستيراد
    if(Array.isArray(data.ledger)) ledger=data.ledger.map(t=>t.timestamp?t:{...t,timestamp:Date.now()});
    if(Array.isArray(data.accounts)) accounts=data.accounts;
    if(Array.isArray(data.categories)) categories=data.categories;
    if(Array.isArray(data.commitments)) commitments=data.commitments.map(migrateCommit);
    if(Array.isArray(data.collections)) collections=data.collections.map(migrateCollect);
    
    saveLedger(); saveAccounts(); saveCategories(); saveCommitments(); saveCollections();
    
    // حفظ الـ SHA للملف للرفع لاحقاً
    ghCfg.sha=file.sha;
    saveGhCfg();
    
    ghStatus('تم التحميل والمزامنة بنجاح!');
    txPage = 1;
    render();
  } catch(e){
    ghStatus('فشل التحميل والمزامنة: '+e.message,false);
  }
}
async function ghPush(){
  if(!ghCfg.user||!ghCfg.repo||!ghCfg.path) return console.error('GitHub config incomplete');
  ghStatus('جاري الرفع...');
  try{
    // 1. قراءة الملف الحالي للحصول على SHA (للتحديث)
    const file=await gh_read_file(false);
    const sha=file?file.sha:undefined;
    
    // 2. إعداد محتوى الملف للرفع
    const data = {
      ledger, accounts, categories, commitments, collections, version: 1
    };
    const content=btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    
    const url=`https://api.github.com/repos/${ghCfg.user}/${ghCfg.repo}/contents/${ghCfg.path}`;
    const commitData={
      message: `Sync: ${new Date().toISOString()}`,
      content,
      sha: sha, // SHA مطلوب للتحديث
      branch: ghCfg.branch || 'main'
    };
    
    const result=await gh_api(url,'PUT',commitData);
    
    // تحديث SHA بعد الرفع
    ghCfg.sha=result.content.sha;
    saveGhCfg();
    
    ghStatus('تم الرفع والمزامنة بنجاح!');
  } catch(e){
    ghStatus('فشل الرفع والمزامنة: '+e.message,false);
  }
}

document.getElementById('ghSaveCfg')?.addEventListener('click',()=>{
  ghCfg.user=els.ghUser.value.trim();
  ghCfg.repo=els.ghRepo.value.trim();
  ghCfg.branch=els.ghBranch.value.trim();
  ghCfg.path=els.ghPath.value.trim();
  ghCfg.token=els.ghToken.value.trim();
  saveGhCfg();
  ghTest();
});
document.getElementById('ghTest')?.addEventListener('click',ghTest);
document.getElementById('ghPull')?.addEventListener('click',ghPull);
document.getElementById('ghPush')?.addEventListener('click',ghPush);
document.getElementById('ghAuto')?.addEventListener('change',()=>{
  ghCfg.autoSync=els.ghAuto.checked;
  saveGhCfg();
  if(ghCfg.autoSync) ghPush();
});
function renderGhCfg(){
  els.ghUser.value=ghCfg.user||'';
  els.ghRepo.value=ghCfg.repo||'';
  els.ghBranch.value=ghCfg.branch||'main';
  els.ghPath.value=ghCfg.path||'my-finance.json';
  els.ghToken.value=ghCfg.token||'';
  els.ghAuto.checked=!!ghCfg.autoSync;
}

/* ===== تهيئة (Init) ===== */
function render(){
  renderTxAccountSelect();
  renderTransferSelects();
  renderAccounts();
  renderCategories();
  drawCommitments();
  drawCollections();
  drawDueSoon();
  recalc();
  renderTxTable(ledger);
  renderCommitLink();
  getMonthlyData();
  renderMonthlyTable();
  drawMonthlyChart(monthlyData);
  drawMonthSummary(els.monthPicker.value);
}

function init(){
  // تطبيق الثيم المحفوظ
  const savedTheme=localStorage.getItem(THEME_KEY)||'dark';
  saveTheme(savedTheme);
  els.themeToggle.innerHTML=`<i class="fas fa-${savedTheme==='light'?'moon':'sun'}"></i>`;

  // إعدادات التاريخ الافتراضية
  els.date.value=formatLocalDate(new Date());
  els.trDate.value=formatLocalDate(new Date());
  els.cFirstDue.value=formatLocalDate(new Date());
  els.coFirstDue.value=formatLocalDate(new Date());
  els.monthPicker.value=YM();
  
  // تهيئة البيانات الأساسية
  ensureBaseCategories();
  ensureTransferCategories();
  
  // تهيئة إعدادات GitHub
  renderGhCfg();

  // ترحيل الالتزامات (مهم)
  commitments=commitments.map(migrateCommit);
  collections=collections.map(migrateCollect);

  // تحديث وعرض
  render();

  // تفعيل تبديل الثيم
  els.themeToggle.addEventListener('click',()=>{
    const newTheme=document.body.dataset.theme==='light'?'dark':'light';
    saveTheme(newTheme);
    els.themeToggle.innerHTML=`<i class="fas fa-${newTheme==='light'?'moon':'sun'}"></i>`;
    document.body.dispatchEvent(new CustomEvent('change-theme', { detail: newTheme }));
  });
  
  // عرض الشاشة الافتراضية
  window.showScreen('screen-overview');

  // تفعيل PWA
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    els.installBtn.style.display = 'block';
    els.installBtn.addEventListener('click', () => {
      els.installBtn.style.display = 'none';
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        } else {
          console.log('User dismissed the install prompt');
        }
        deferredPrompt = null;
      });
    });
  });
}

// تحميل مكتبة Chart.js
const chartScript=document.createElement('script');
chartScript.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js';
chartScript.onload=()=>document.addEventListener('DOMContentLoaded', init);
document.head.appendChild(chartScript);
</script>
</body>
</html>
