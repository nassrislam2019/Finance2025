<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ â€” Ù…Ø­Ø³Ù‘Ù† (Ø¯Ø§ÙƒÙ†/ÙØ§ØªØ­) </title>
<meta name="description" content="Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ â€” ØªØªØ¨Ø¹ Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ¯Ø®Ù„ØŒ Ù…ØªÙˆØ§ÙÙ‚ Ù…ÙˆØ¨Ø§ÙŠÙ„/Ø¯ÙŠØ³ÙƒØªÙˆØ¨ØŒ Ø¯Ø§ÙƒÙ†/ÙØ§ØªØ­ØŒ ÙƒØ±ÙˆØª Ù…Ø·ÙˆÙŠØ©." />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* ========= variables (light by default) ========= */
:root{
  --bg:#ffffff; --card:#f8fafc; --muted:#475569; --txt:#05202a;
  --brand:#0ea5e9; --danger:#ef4444; --warn:#f59e0b; --ok:#16a34a; --border:#e6eef3;
  --radius:12px; --field-h:46px; --gap:12px;
}

/* dark theme variables (will be applied when .dark class on body) */
body.dark{
  --bg:#071316; --card:#0d1a1c; --muted:#9fb6ba; --txt:#e6f6f7;
  --brand:#38bdf8; --danger:#f87171; --warn:#fbbf24; --ok:#34d399; --border:#123235;
}

*{box-sizing:border-box;font-family:"Cairo",sans-serif}
html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);-webkit-font-smoothing:antialiased}
.container{max-width:1180px;margin-inline:auto;padding:18px;display:flex;flex-direction:column;gap:18px}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.title{font-size:20px;font-weight:700}
.sub{font-size:13px;color:var(--muted)}
.header-right{display:flex;align-items:center;gap:8px}
.btn{appearance:none;border:0;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700;background:transparent;color:var(--txt);border:1px solid var(--border)}
.btn:hover{opacity:.95}
.btn-primary{background:var(--brand);color:#fff;border-color:transparent}
.btn-outline{background:transparent;border:1px solid var(--border)}
.btn-danger{background:var(--danger);color:#fff;border-color:transparent}
.badge{background:transparent;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:13px}

/* layout */
.grid{display:grid;gap:var(--gap)}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
@media(max-width:900px){ .grid-3{grid-template-columns:1fr} .grid-2{grid-template-columns:1fr} }

/* card */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;gap:8px}
.card-body{padding:14px;border-top:1px solid var(--border)}
.card.collapsed .card-body{display:none}
.toggle{appearance:none;border:none;background:transparent;cursor:pointer;font-size:18px;padding:6px 10px;border-radius:8px;color:var(--muted)}

/* stats */
.stats{display:grid;gap:12px}
@media(min-width:900px){ .stats{grid-template-columns:repeat(5,1fr)} }
.stat{background:var(--bg);padding:12px;border-radius:10px;border:1px solid var(--border)}
.stat small{color:var(--muted);font-size:12px}
.stat .num{font-weight:800;font-size:18px;margin-top:6px}
.pos{color:var(--ok)} .neg{color:var(--danger)} .warn{color:var(--warn)}

/* forms */
.input, select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--txt);height:var(--field-h)}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
.form-grid{display:grid;gap:12px}
.form-grid-3{grid-template-columns:repeat(3,1fr)}
@media(max-width:900px){ .form-grid-3{grid-template-columns:1fr} }

/* tables */
.table-wrap{overflow:auto;border-radius:8px}
table{width:100%;border-collapse:collapse}
thead th{font-size:13px;color:var(--muted);padding:10px;text-align:right;border-bottom:1px solid var(--border)}
tbody td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.03);background:var(--bg)}
.amount.inc{color:var(--ok);font-weight:700} .amount.exp{color:var(--danger);font-weight:700}
.exec-dt{font-size:12px;color:var(--muted)}

/* small utilities */
.small{font-size:13px;color:var(--muted)}
.list-plain{display:flex;flex-wrap:wrap;gap:8px}
.item{background:var(--bg);padding:8px 10px;border-radius:8px;border:1px solid var(--border)}
.empty{padding:12px;border-radius:10px;border:1px dashed var(--border);color:var(--muted);text-align:center}

/* spacing for mobile - ensure clear separation of cards */
.container > section.card{margin-bottom:6px}

/* collapse behavior default: collapsed */
.card[data-init-collapsed="true"] .card-body{display:none}

/* responsive tweaks */
@media(max-width:720px){
  .header{gap:8px}
  .title{font-size:18px}
  .stat .num{font-size:16px}
  .btn{padding:8px 10px}
}

/* accessibility focus */
:focus{outline:2px solid rgba(14,165,233,0.2);outline-offset:2px}
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div>
      <div class="title">Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</div>
      <div class="sub">ØªØ·Ø¨ÙŠÙ‚Ùƒ â€” Ø§Ù„Ø¢Ù† Ù…Ø¹ Ø¯Ø§ÙƒÙ†/ÙØ§ØªØ­ ÙˆÙƒØ±ÙˆØª Ù…Ø·ÙˆÙŠØ© ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
    </div>

    <div class="header-right">
      <button id="themeToggle" class="btn btn-outline" title="ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©">ÙˆØ¶Ø¹</button>
      <button id="exportJson" class="btn">ØªØµØ¯ÙŠØ± JSON</button>
      <label class="btn btn-outline" for="importFile">Ø§Ø³ØªÙŠØ±Ø§Ø¯</label>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="syncNow" class="btn btn-outline">Ù…Ø²Ø§Ù…Ù†Ø©</button>
    </div>
  </div>

  <!-- (1) Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª - Ù…Ø·ÙˆÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ -->
  <section class="card collapsed" data-init-collapsed="true" id="card-balance">
    <div class="card-head">
      <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="statusSummary" class="small">Ø¬Ø§Ù‡Ø²</div>
        <button class="toggle" aria-expanded="false" title="Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡"></button>
      </div>
    </div>
    <div class="card-body">
      <div class="stats" id="summaryStats">
        <div class="stat"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©</small><div id="totalBalance" class="num">0.00</div></div>
        <div class="stat"><small>Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø§Ø±ÙŠ</small><div id="monthIncome" class="num pos">0.00</div></div>
        <div class="stat"><small>Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø§Ø±ÙŠ (Ù…ØªØ¨Ù‚ÙŠ)</small><div id="monthCommitTotal" class="num neg">0.00</div></div>
        <div class="stat"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ø§Ù„Øº ØªØ­Øª Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)</small><div id="monthCollectTotal" class="num">0.00</div></div>
        <div class="stat"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…</small><div id="monthNextDueTotal" class="num warn">0.00</div></div>
      </div>

      <div style="height:12px"></div>
      <div>
        <h4 class="small">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨</h4>
        <div id="perAccount" class="list-plain"></div>
      </div>
    </div>
  </section>

  <!-- (2) Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ùˆ Ø§Ù„ÙØ¦Ø§Øª -->
  <section class="card collapsed" data-init-collapsed="true">
    <div class="card-head">
      <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ùˆ Ø§Ù„ÙØ¦Ø§Øª</h3>
      <button class="toggle" aria-expanded="false" title="Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡"></button>
    </div>
    <div class="card-body">
      <div class="form-grid form-grid-3" style="margin-bottom:10px">
        <div><label class="small">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label><input id="accName" class="input" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ§Ø´"></div>
        <div><label class="small">Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ</label><input id="accOpening" class="input" type="number" placeholder="0.00"></div>
        <div style="align-self:end"><button id="addAccount" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</button></div>
      </div>
      <div id="accountsList" class="list-plain small"></div>

      <hr style="margin:12px 0;border:none;height:1px;background:var(--border)">

      <div class="form-grid form-grid-3" style="margin-bottom:10px">
        <div><label class="small">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©</label><input id="catName" class="input" placeholder="Ù…Ø«Ø§Ù„: Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨"></div>
        <div><label class="small">Ù†ÙˆØ¹ Ø§Ù„ÙØ¦Ø©</label><select id="catType" class="input"><option value="expense">Ù…ØµØ±ÙˆÙ</option><option value="income">Ø¯Ø®Ù„</option></select></div>
        <div style="align-self:end"><button id="addCat" class="btn btn-outline">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</button></div>
      </div>
      <div id="catsList" class="list-plain small"></div>
    </div>
  </section>

  <!-- (3) Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© -->
  <section class="card collapsed" data-init-collapsed="true">
    <div class="card-head">
      <h3>Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ©</h3>
      <button class="toggle" aria-expanded="false" title="Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡"></button>
    </div>
    <div class="card-body">
      <div class="form-grid form-grid-3">
        <div>
          <label class="small">Ø§Ù„Ù†ÙˆØ¹</label>
          <select id="txType" class="input"><option value="expense">Ù…ØµØ±ÙˆÙ</option><option value="income">Ø¯Ø®Ù„</option></select>
        </div>
        <div>
          <label class="small">Ø§Ù„Ù…Ø¨Ù„Øº</label>
          <input id="txAmount" class="input" type="number" placeholder="0.00">
        </div>
        <div>
          <label class="small">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
          <input id="txDue" class="input" type="date">
        </div>

        <div>
          <label class="small">Ø§Ù„Ø­Ø³Ø§Ø¨</label>
          <select id="txAccount" class="input"></select>
        </div>
        <div>
          <label class="small">Ø§Ù„ÙØ¦Ø©</label>
          <select id="txCategory" class="input"></select>
        </div>
        <div>
          <label class="small">ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="txExec" class="input" type="datetime-local">
        </div>

        <div style="grid-column:1 / -1">
          <label class="small">Ø§Ù„ÙˆØµÙ</label>
          <input id="txDesc" class="input">
        </div>

        <div style="grid-column:1 / -1;display:flex;gap:8px;align-items:center">
          <button id="saveTx" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©</button>
          <button id="resetTx" class="btn btn-outline">Ø¥ÙØ±Ø§Øº</button>
          <div style="flex:1"></div>
          <label class="small">Ø±Ø¨Ø· Ø¨Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="txLinkCommit" class="input" style="max-width:320px"></select>
        </div>
      </div>
    </div>
  </section>

  <!-- (4) Ø§Ù„Ø­Ø±ÙƒØ§Øª -->
  <section class="card collapsed" data-init-collapsed="true">
    <div class="card-head">
      <h3>Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="small">Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù… (Ø­Ø³Ø¨ ØªÙ†ÙÙŠØ°)</div>
        <button class="toggle" aria-expanded="false" title="Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡"></button>
      </div>
    </div>
    <div class="card-body">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
        <input id="search" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØµÙ Ø£Ùˆ Ø§Ù„ÙØ¦Ø©" style="max-width:260px">
        <select id="filterType" class="input" style="max-width:150px"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="income">Ø¯Ø®Ù„</option><option value="expense">Ù…ØµØ±ÙˆÙ</option></select>
        <select id="filterAccount" class="input" style="max-width:200px"></select>
        <div style="flex:1"></div>
        <button id="clearFilters" class="btn btn-outline">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      </div>

      <div class="table-wrap" style="border-radius:10px">
        <table>
          <thead>
            <tr>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
              <th>Ø§Ù„ÙˆØµÙ</th>
              <th>Ø§Ù„ÙØ¦Ø©</th>
              <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="tbodyTxs"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- (5) Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© -->
  <section class="card collapsed" data-init-collapsed="true">
    <div class="card-head">
      <h3>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
      <button class="toggle" aria-expanded="false" title="Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡"></button>
    </div>
    <div class="card-body">
      <div class="form-grid form-grid-3" style="margin-bottom:10px">
        <div><label class="small">Ø§Ø³Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</label><input id="cName" class="input"></div>
        <div><label class="small">Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="cAmount" class="input" type="number"></div>
        <div><label class="small">ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input id="cFirstDue" class="input" type="date"></div>
        <div style="display:flex;align-items:center;gap:8px"><input id="cRecurring" type="checkbox"><label class="small">ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠÙ‹Ø§</label></div>
        <div><label class="small">ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="cEndAt" class="input" type="date"></div>
        <div style="align-self:end"><button id="addCommit" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ«</button></div>
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</th><th>Ù…Ø¯ÙÙˆØ¹ (Ø§Ù„Ø´Ù‡Ø±)</th><th>Ù…ØªØ¨Ù‚ÙŠ</th><th>ØªÙƒØ±Ø§Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody id="tbodyCommit"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- (6) Ù…Ø¨Ø§Ù„Øº ØªØ­Øª Ø§Ù„ØªØ­ØµÙŠÙ„ -->
  <section class="card collapsed" data-init-collapsed="true">
    <div class="card-head">
      <h3>Ù…Ø¨Ø§Ù„Øº ØªØ­Øª Ø§Ù„ØªØ­ØµÙŠÙ„</h3>
      <button class="toggle" aria-expanded="false" title="Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡"></button>
    </div>
    <div class="card-body">
      <div class="form-grid form-grid-3" style="margin-bottom:10px">
        <div><label class="small">Ø§Ø³Ù… Ø§Ù„ØªØ­ØµÙŠÙ„</label><input id="coName" class="input"></div>
        <div><label class="small">Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="coAmount" class="input" type="number"></div>
        <div><label class="small">ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input id="coFirstDue" class="input" type="date"></div>
        <div style="display:flex;align-items:center;gap:8px"><input id="coRecurring" type="checkbox"><label class="small">ÙŠØªÙƒØ±Ø± Ø´Ù‡Ø±ÙŠÙ‹Ø§</label></div>
        <div><label class="small">ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="coEndAt" class="input" type="date"></div>
        <div style="align-self:end"><button id="addCollect" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ«</button></div>
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…</th><th>ØªÙƒØ±Ø§Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody id="tbodyCollect"></tbody>
        </table>
      </div>
    </div>
  </section>

  <div style="height:40px"></div>
</div>

<script>
/* ============================
  App state & storage keys
   ============================ */
const KEY='pf_ledger_v1', ACC_KEY='pf_accounts_v1', CAT_KEY='pf_categories_v1',
      COM_KEY='pf_commitments_v1', COL_KEY='pf_collections_v1', THEME_KEY='pf_theme_v1';

let ledger = JSON.parse(localStorage.getItem(KEY) || '[]');
let accounts = JSON.parse(localStorage.getItem(ACC_KEY) || '[]');
let categories = JSON.parse(localStorage.getItem(CAT_KEY) || '[]');
let commitments = JSON.parse(localStorage.getItem(COM_KEY) || '[]');
let collections = JSON.parse(localStorage.getItem(COL_KEY) || '[]');

/* ===== utils ===== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmt = n => Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2});
const eid = ()=> Math.random().toString(36).slice(2,9)+Date.now().toString(36);
const startOfToday = ()=>{ const t=new Date(); t.setHours(0,0,0,0); return t; }
const formatLocalDate = d => { const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
const parseLocalDate = s => { const parts = (s||'').split('-').map(Number); if(!parts[0]) return null; const d=new Date(parts[0],parts[1]-1,parts[2]); d.setHours(0,0,0,0); return d; }
const addMonthsPreserveDOM = (date, months) => { const d=new Date(date.getTime()); const targetMonth = d.getMonth()+months; const day=d.getDate(), y=d.getFullYear(); const lastOfTarget = new Date(y, targetMonth+1, 0).getDate(); d.setMonth(targetMonth, Math.min(day,lastOfTarget)); d.setHours(0,0,0,0); return d; }
const YM = ()=> formatLocalDate(startOfToday()).slice(0,7)
const addMonthsToYm = (ym, n)=>{ const [y,m]= (ym||'').split('-').map(Number); if(!y) return ym; const base=new Date(y,m-1,1); return formatLocalDate(addMonthsPreserveDOM(base,n)).slice(0,7); }
const monthLabel = ym=>{ if(!ym) return 'â€”'; const [y,m]=ym.split('-').map(Number); const d=new Date(y,m-1,1); return d.toLocaleDateString('ar-EG',{month:'long', year:'numeric'}); }

/* ===== storage helpers ===== */
function saveAll(){ localStorage.setItem(KEY, JSON.stringify(ledger)); localStorage.setItem(ACC_KEY, JSON.stringify(accounts)); localStorage.setItem(CAT_KEY, JSON.stringify(categories)); localStorage.setItem(COM_KEY, JSON.stringify(commitments)); localStorage.setItem(COL_KEY, JSON.stringify(collections)); }

/* ===== theme (dark/light) ===== */
function applyTheme(theme){
  if(theme==='dark') document.body.classList.add('dark');
  else document.body.classList.remove('dark');
  localStorage.setItem(THEME_KEY, theme);
  $('#themeToggle').textContent = theme==='dark' ? 'Ø¯Ø§ÙƒÙ†' : 'ÙØ§ØªØ­';
}
$('#themeToggle').addEventListener('click', ()=>{
  const current = localStorage.getItem(THEME_KEY) || 'light';
  applyTheme(current==='dark' ? 'light' : 'dark');
});
applyTheme(localStorage.getItem(THEME_KEY) || 'light');

/* ===== ensure base categories ===== */
function ensureBaseCategories(){
  const need=[ {name:'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ©',type:'expense'},{name:'ØªØ­ØµÙŠÙ„Ø§Øª Ø´Ù‡Ø±ÙŠØ©',type:'income'},{name:'ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø±',type:'expense'},{name:'ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯',type:'income'},{name:'Ø¹Ù…ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„',type:'expense'} ];
  if(categories.length===0){
    categories = [{name:'Ù…Ø±ØªØ¨',type:'income'},{name:'Ø¯Ø®Ù„ Ø¢Ø®Ø±',type:'income'},{name:'Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨',type:'expense'},{name:'ÙÙˆØ§ØªÙŠØ±',type:'expense'},{name:'ØªØ³ÙˆÙ‚',type:'expense'}];
  }
  for(const c of need) if(!categories.some(x=>x.name===c.name && x.type===c.type)) categories.push(c);
}

/* ===== compute balances =====
   Important: balances are computed by ascending execution time (exec).
   Each transaction MUST have exec (ISO) and due (YYYY-MM-DD).
*/
function computeBalances(){
  const bal = new Map(accounts.map(a=>[a.name, Number(a.opening||0)]));
  // sort by exec ascending; if exec missing use created; tie-break id
  const sorted = [...ledger].sort((a,b)=>{
    const A = (a.exec||a.created||'') , B = (b.exec||b.created||'');
    if(A!==B) return A.localeCompare(B);
    return (a.id||'').localeCompare(b.id||'');
  });
  const after = new Map();
  for(const t of sorted){
    // if account missing, ensure key exists
    if(!bal.has(t.account)) bal.set(t.account, 0);
    const cur = bal.get(t.account) || 0;
    const delta = (t.type==='income' ? Number(t.amount||0) : -Number(t.amount||0));
    const next = cur + delta;
    bal.set(t.account, next);
    after.set(t.id, next);
  }
  return {bal, after};
}

/* ===== recalc summary ===== */
function sumCurrentMonthCommitments(){
  const ym = YM(); let total=0;
  for(const c of commitments){
    const due = (c.nextDue||c.firstDue||'').slice(0,7); if(due!==ym) continue;
    const paid = c.payments?.[ym] || 0;
    const remain = Math.max(0, Number(c.amount||0)-paid);
    total += remain;
  }
  return total;
}
function sumCurrentMonthCollections(){
  const ym = YM(); let total=0;
  for(const c of collections){
    const due = (c.nextDue||c.firstDue||'').slice(0,7); if(due!==ym) continue;
    total += Number(c.amount||0);
  }
  return total;
}
function sumCurrentMonthIncome(){
  // Count incomes whose exec date is in current YM
  const ym = YM(); let total=0;
  for(const t of ledger){
    const execYM = (t.exec||t.created||'').slice(0,7);
    if(execYM===ym && t.type==='income') total += Number(t.amount||0);
  }
  return total;
}

function recalcAndRender(){
  const {bal, after} = computeBalances();
  const total = Array.from(bal.values()).reduce((s,v)=>s+v,0);
  $('#totalBalance').textContent = fmt(total);
  const monthComRemain = sumCurrentMonthCommitments();
  $('#monthCommitTotal').textContent = '-' + fmt(monthComRemain);
  const monthCollect = sumCurrentMonthCollections();
  $('#monthCollectTotal').textContent = fmt(monthCollect);
  const monthInc = sumCurrentMonthIncome();
  $('#monthIncome').textContent = fmt(monthInc);

  // compute next month due totals
  const ym = YM(); const nextYm = addMonthsToYm(ym,1);
  let nextDue = 0;
  for(const c of commitments){
    const due = (c.nextDue||c.firstDue||'').slice(0,7);
    if(due===nextYm){
      const paidNext = c.payments?.[nextYm] || 0;
      const remainNext = Math.max(0, Number(c.amount||0)-paidNext);
      nextDue += remainNext;
    }
  }
  $('#monthNextDueTotal').textContent = fmt(nextDue);

  // per-account display
  const arr = accounts.map(a=>({name:a.name, val: bal.get(a.name) ?? Number(a.opening||0)}));
  $('#perAccount').innerHTML = arr.map(a=>`<span class="item">${a.name} Â· <b>${fmt(a.val)}</b></span>`).join(' ');

  // render other parts
  renderTxs();
  drawCommitments();
  drawCollections();
  drawDueSoon();
  saveAll();
}

/* ===== rendering transactions (display newest first) ===== */
function renderTxs(){
  const tbody = $('#tbodyTxs'); if(!tbody) return;
  const q = ($('#search')?.value||'').trim().toLowerCase();
  const fType = $('#filterType')?.value || 'all';
  const fAcc = $('#filterAccount')?.value || 'all';
  const {after} = computeBalances();

  const rows = [...ledger].sort((a,b)=>{
    // newest first by exec (or created)
    const A = (b.exec||b.created||''), B = (a.exec||a.created||'');
    if(A!==B) return A.localeCompare(B);
    return (b.id||'').localeCompare(a.id||'');
  }).filter(t=>{
    if(q){
      if(!((t.desc||'').toLowerCase().includes(q) || (t.category||'').toLowerCase().includes(q))) return false;
    }
    if(fType !== 'all' && t.type !== fType) return false;
    if(fAcc && fAcc !== 'all' && t.account !== fAcc) return false;
    return true;
  });

  tbody.innerHTML = rows.length ? rows.map(t=>{
    const execTxt = t.exec ? new Date(t.exec).toLocaleString('ar-EG') : (t.created ? new Date(t.created).toLocaleString('ar-EG') : 'â€”');
    const dueTxt = t.due || 'â€”';
    const cls = t.type==='income' ? 'amount inc' : 'amount exp';
    const afterVal = after.get(t.id) ?? 0;
    const tag = t.isTransfer ? 'â†”ï¸ ØªØ­ÙˆÙŠÙ„' : (t.linkCommitId ? 'ğŸ”— Ø§Ù„ØªØ²Ø§Ù…' : '');
    return `<tr>
      <td class="right"><div class="exec-dt">${execTxt}</div></td>
      <td class="right">${dueTxt}</td>
      <td>${escapeHtml(t.desc||'â€”')} ${tag}</td>
      <td>${escapeHtml(t.category||'â€”')}</td>
      <td>${escapeHtml(t.account||'â€”')}</td>
      <td class="${cls}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</td>
      <td>${fmt(afterVal)}</td>
      <td>
        <button class="btn btn-outline" onclick="editTx('${t.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-danger" onclick="delTx('${t.id}')">Ø­Ø°Ù</button>
      </td>
    </tr>`;
  }).join('') : '<tr><td colspan="8" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø¨Ø¹Ø¯.</td></tr>';
}

/* ===== transaction CRUD ===== */
let editId = null;
function clearTxForm(){
  editId = null; $('#txAmount').value=''; $('#txDue').value=''; $('#txDesc').value=''; $('#txExec').value=''; $('#txLinkCommit').value=''; $('#saveTx').textContent='Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©';
}
function editTx(id){
  const t = ledger.find(x=>x.id===id); if(!t) return;
  editId = id; $('#saveTx').textContent='ØªØ­Ø¯ÙŠØ«';
  $('#txAmount').value = t.amount;
  $('#txDue').value = t.due || '';
  $('#txDesc').value = t.desc || '';
  $('#txType').value = t.type;
  $('#txAccount').value = t.account || (accounts[0]?.name||'');
  $('#txCategory').value = t.category || '';
  $('#txExec').value = t.exec ? new Date(t.exec).toISOString().slice(0,16) : '';
  $('#txLinkCommit').value = t.linkCommitId || '';
  window.scrollTo({top:0,behavior:'smooth'});
}
function delTx(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')) return;
  const t = ledger.find(x=>x.id===id);
  ledger = ledger.filter(x=>x.id!==id);
  if(t && t.linkCommitId && t.type==='expense'){
    const ym = (t.exec||t.created||'').slice(0,7);
    const c = commitments.find(x=>x.id===t.linkCommitId);
    if(c && c.payments && c.payments[ym]) c.payments[ym] = Math.max(0, c.payments[ym] - Number(t.amount||0));
  }
  saveAll(); recalcAndRender();
}

$('#saveTx').addEventListener('click', ()=>{
  const type = $('#txType').value;
  const amount = Number($('#txAmount').value||0);
  const due = $('#txDue').value || '';
  const execInput = $('#txExec').value;
  const account = $('#txAccount').value;
  const category = $('#txCategory').value;
  const desc = $('#txDesc').value.trim() || '';
  const linkCommitId = $('#txLinkCommit').value || null;

  if(!account || !category || !amount || amount<=0){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø­Ø³Ø§Ø¨/ÙØ¦Ø©/Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }

  // exec handling: prefer provided datetime; if not, if linked to commitment -> execution = now; else use due at noon or now
  let execISO;
  if(execInput) execISO = new Date(execInput).toISOString();
  else if(linkCommitId) execISO = new Date().toISOString();
  else if(due){ const pd = parseLocalDate(due); if(pd){ pd.setHours(12,0,0,0); execISO = pd.toISOString(); } else execISO = new Date().toISOString(); }
  else execISO = new Date().toISOString();

  const tx = {
    id: editId || eid(),
    created: new Date().toISOString(),
    exec: execISO,
    due: due || execISO.slice(0,10),
    desc, type, amount: Number(amount), account, category,
    isTransfer:false,
    linkCommitId: linkCommitId || undefined
  };

  if(editId){
    const i = ledger.findIndex(x=>x.id===editId); if(i>-1) ledger[i] = tx; editId=null; $('#saveTx').textContent='Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©';
  } else ledger.push(tx);

  // if expense linked to commitment -> update payments & maybe move nextDue
  if(tx.type==='expense' && tx.linkCommitId){
    addCommitPayment(tx.linkCommitId, tx.exec.slice(0,7), tx.amount);
  }

  saveAll(); clearTxForm(); recalcAndRender();
});

$('#resetTx').addEventListener('click', clearTxForm);

/* ===== accounts & categories UI ===== */
$('#addAccount').addEventListener('click', ()=>{
  const name = $('#accName').value.trim(), opening = Number($('#accOpening').value||0);
  if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'); return; }
  accounts.push({name, opening: Number.isFinite(opening)?opening:0});
  $('#accName').value=''; $('#accOpening').value='';
  saveAll(); refreshAccountsAndFilters();
  recalcAndRender();
});
function refreshAccountsAndFilters(){
  $('#accountsList').innerHTML = accounts.map((a,i)=>`<span class="item">${a.name} Â· <b>${fmt(a.opening||0)}</b></span>`).join(' ');
  $('#txAccount').innerHTML = accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
  $('#filterAccount').innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>` + accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join('');
}

$('#addCat').addEventListener('click', ()=>{
  const name = $('#catName').value.trim(), type = $('#catType').value;
  if(!name){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©'); return; }
  categories.push({name,type}); $('#catName').value=''; saveAll(); refreshCats();
});
function refreshCats(){
  $('#catsList').innerHTML = categories.map(c=>`<span class="item">${c.name} Â· ${c.type==='income'?'Ø¯Ø®Ù„':'Ù…ØµØ±ÙˆÙ'}</span>`).join(' ');
  // set txCategory to show only matching type when txType changes (update below)
  const t = $('#txType').value || 'expense';
  $('#txCategory').innerHTML = categories.filter(c=>c.type===t).map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
}

/* when txType changes, filter categories accordingly */
$('#txType').addEventListener('change', ()=>{
  const t = $('#txType').value;
  $('#txCategory').innerHTML = categories.filter(c=>c.type===t).map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
});

/* ===== commitments (Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª) ===== */
let editCommitId = null;
function migrateCommit(c){
  if(c.day && !c.firstDue){ const today = startOfToday(); const base = new Date(today.getFullYear(), today.getMonth(), Math.min(Math.max(1,c.day),28)); c.firstDue = formatLocalDate(base); c.nextDue = c.firstDue; delete c.day; }
  if(!c.nextDue && c.firstDue) c.nextDue = c.firstDue;
  if(typeof c.recurring!=='boolean') c.recurring=false;
  if(c.endAt===undefined) c.endAt=null;
  if(!c.payments) c.payments={};
  return c;
}
function drawCommitments(){
  const tbody = $('#tbodyCommit'); if(!tbody) return;
  commitments = commitments.map(migrateCommit);
  const ym = YM();
  tbody.innerHTML = commitments.length ? commitments.map(c=>{
    const paid = c.payments?.[ym] || 0;
    const remain = Math.max(0, Number(c.amount||0) - paid);
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${escapeHtml(c.nextDue||c.firstDue||'â€”')}</td>
      <td>${fmt(paid)}</td>
      <td>${fmt(remain)}</td>
      <td>${c.recurring?'Ø´Ù‡Ø±ÙŠ':'Ù…Ø±Ø©'}</td>
      <td>
        <button class="btn btn-primary" onclick="payCommit('${c.id}')">Ø³Ø¯Ø§Ø¯</button>
        <button class="btn btn-outline" onclick="editCommit('${c.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-danger" onclick="delCommit('${c.id}')">Ø­Ø°Ù</button>
      </td>
    </tr>`;
  }).join('') : '<tr><td colspan="7" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø¨Ø¹Ø¯.</td></tr>';
}

$('#addCommit').addEventListener('click', ()=>{
  const name = $('#cName').value.trim(), amount = Number($('#cAmount').value||0), firstDue = $('#cFirstDue').value, recurring = $('#cRecurring').checked, endAt = $('#cEndAt').value || null;
  if(!name || !amount || !firstDue){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… + Ù…Ø¨Ù„Øº + ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚'); return; }
  if(recurring && endAt && parseLocalDate(endAt) < parseLocalDate(firstDue)){ alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚'); return; }
  // compute nextDue as nearest upcoming
  let nextDue = parseLocalDate(firstDue);
  const today = startOfToday();
  while(nextDue < today){
    const tryNext = addMonthsPreserveDOM(nextDue, 1);
    if(recurring && (!endAt || tryNext <= parseLocalDate(endAt))) nextDue = tryNext;
    else break;
  }
  const commit = { id: editCommitId || eid(), name, amount: Number(amount), firstDue: formatLocalDate(parseLocalDate(firstDue)), nextDue: formatLocalDate(nextDue), recurring, endAt: recurring ? (endAt||null) : null, payments: {} };
  if(editCommitId){ const idx = commitments.findIndex(x=>x.id===editCommitId); if(idx>-1) commitments[idx] = commit; editCommitId=null; } else commitments.push(commit);
  $('#cName').value=''; $('#cAmount').value=''; $('#cFirstDue').value=''; $('#cRecurring').checked=false; $('#cEndAt').value='';
  saveAll(); drawCommitments(); recalcAndRender();
});
window.editCommit = id => {
  const c = commitments.find(x=>x.id===id); if(!c) return;
  editCommitId = id; $('#cName').value = c.name; $('#cAmount').value = c.amount; $('#cFirstDue').value = c.firstDue||''; $('#cRecurring').checked = !!c.recurring; $('#cEndAt').value = c.endAt||'';
}
window.delCommit = id => { if(!confirm('Ø­Ø°Ù Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…ØŸ')) return; commitments = commitments.filter(x=>x.id!==id); saveAll(); drawCommitments(); recalcAndRender(); }

/* pay commit: creates an expense transaction (exec = now), updates payments and nextDue if needed */
function addCommitPayment(commitId, ym, amount){
  const c = commitments.find(x=>x.id===commitId); if(!c) return;
  c.payments = c.payments || {};
  c.payments[ym] = (c.payments[ym]||0) + Number(amount||0);
  // if paid >= amount, advance nextDue or remove
  if(c.payments[ym] >= Number(c.amount||0) - 1e-9){
    const dueDate = parseLocalDate(c.nextDue||c.firstDue);
    if(c.recurring){
      const next = addMonthsPreserveDOM(dueDate,1);
      if(c.endAt && next > parseLocalDate(c.endAt)) commitments = commitments.filter(xx=>xx.id!==commitId);
      else c.nextDue = formatLocalDate(next);
    } else commitments = commitments.filter(xx=>xx.id!==commitId);
  }
  saveAll();
}

window.payCommit = id => {
  const c = commitments.find(x=>x.id===id); if(!c) return;
  const dueStr = c.nextDue || c.firstDue || YM()+'-01';
  const ym = dueStr.slice(0,7);
  const paid = c.payments?.[ym] || 0;
  const remain = Math.max(0, Number(c.amount||0) - paid);
  if(remain<=0){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ù„Øº Ù…ØªØ¨Ù‚ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.'); return; }
  const acc = chooseAccount(); if(!acc) return;
  if(!confirm(`Ø³Ø¯Ø§Ø¯ "${c.name}" Ø¨Ù‚ÙŠÙ…Ø© ${fmt(remain)} Ø¬.Ù… Ù…Ù† "${acc}"ØŸ`)) return;
  const execISO = new Date().toISOString();
  const tx = { id: eid(), created: execISO, exec: execISO, due: dueStr, desc: `${c.name} (Ø³Ø¯Ø§Ø¯ Ø§Ù„ØªØ²Ø§Ù…)`, type:'expense', amount: remain, account: acc, category:'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ©', isTransfer:false, linkCommitId: c.id };
  ledger.push(tx);
  addCommitPayment(c.id, ym, remain);
  saveAll(); recalcAndRender();
}

/* ===== collections (ØªØ­ØµÙŠÙ„Ø§Øª) ===== */
let editCollectId = null;
function migrateCollect(c){
  if(!c.nextDue && c.firstDue) c.nextDue = c.firstDue;
  if(typeof c.recurring!=='boolean') c.recurring=false;
  if(c.endAt===undefined) c.endAt=null;
  return c;
}
function drawCollections(){
  const tbody = $('#tbodyCollect'); if(!tbody) return;
  collections = collections.map(migrateCollect);
  tbody.innerHTML = collections.length ? collections.map(c=>{
    return `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${fmt(c.amount)}</td>
      <td>${escapeHtml(c.nextDue||c.firstDue||'â€”')}</td>
      <td>${c.recurring?'Ø´Ù‡Ø±ÙŠ':'Ù…Ø±Ø©'}</td>
      <td>
        <button class="btn btn-primary" onclick="collectNow('${c.id}')">ØªØ­ØµÙŠÙ„</button>
        <button class="btn btn-outline" onclick="editCollect('${c.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-danger" onclick="delCollect('${c.id}')">Ø­Ø°Ù</button>
      </td>
    </tr>`;
  }).join('') : '<tr><td colspan="5" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº ØªØ­Øª Ø§Ù„ØªØ­ØµÙŠÙ„.</td></tr>';
}
$('#addCollect').addEventListener('click', ()=>{
  const name = $('#coName').value.trim(), amount = Number($('#coAmount').value||0), firstDue = $('#coFirstDue').value, recurring = $('#coRecurring').checked, endAt = $('#coEndAt').value||null;
  if(!name || !amount || !firstDue){ alert('Ø§Ø¯Ø®Ù„: Ø§Ø³Ù… + Ù…Ø¨Ù„Øº + ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ Ø§Ø³ØªØ­Ù‚Ø§Ù‚'); return; }
  let nextDue = parseLocalDate(firstDue);
  const today = startOfToday();
  while(nextDue < today){
    const tryNext = addMonthsPreserveDOM(nextDue,1);
    if(recurring && (!endAt || tryNext <= parseLocalDate(endAt))) nextDue = tryNext; else break;
  }
  const item = { id: editCollectId || eid(), name, amount: Number(amount), firstDue: formatLocalDate(parseLocalDate(firstDue)), nextDue: formatLocalDate(nextDue), recurring, endAt: recurring ? (endAt||null) : null };
  if(editCollectId){ const i = collections.findIndex(x=>x.id===editCollectId); if(i>-1) collections[i]=item; editCollectId=null; } else collections.push(item);
  $('#coName').value=''; $('#coAmount').value=''; $('#coFirstDue').value=''; $('#coRecurring').checked=false; $('#coEndAt').value='';
  saveAll(); drawCollections(); recalcAndRender();
});
window.collectNow = id => {
  const c = collections.find(x=>x.id===id); if(!c) return;
  const dueStr = c.nextDue || c.firstDue || YM()+'-01';
  const acc = chooseAccount(); if(!acc) return;
  if(!confirm(`ØªØ­ØµÙŠÙ„ "${c.name}" Ø¨Ù…Ø¨Ù„Øº ${fmt(c.amount)} Ø¬.Ù… Ø¥Ù„Ù‰ "${acc}"ØŸ`)) return;
  const execISO = new Date().toISOString();
  const tx = { id: eid(), created: execISO, exec: execISO, due: dueStr, desc: `${c.name} (ØªØ­ØµÙŠÙ„)`, type:'income', amount: Number(c.amount||0), account: acc, category: 'ØªØ­ØµÙŠÙ„Ø§Øª Ø´Ù‡Ø±ÙŠØ©', isTransfer:false };
  ledger.push(tx);
  if(c.recurring){
    const next = addMonthsPreserveDOM(parseLocalDate(c.nextDue||c.firstDue),1);
    if(c.endAt && next > parseLocalDate(c.endAt)) collections = collections.filter(x=>x.id!==id);
    else c.nextDue = formatLocalDate(next);
  }else collections = collections.filter(x=>x.id!==id);
  saveAll(); recalcAndRender();
}
window.editCollect = id => { const c = collections.find(x=>x.id===id); if(!c) return; editCollectId = id; $('#coName').value=c.name; $('#coAmount').value=c.amount; $('#coFirstDue').value=c.firstDue||''; $('#coRecurring').checked=!!c.recurring; $('#coEndAt').value=c.endAt||''; }
window.delCollect = id => { if(!confirm('Ø­Ø°Ù Ø§Ù„ØªØ­ØµÙŠÙ„ØŸ')) return; collections = collections.filter(x=>x.id!==id); saveAll(); drawCollections(); recalcAndRender(); }

/* ===== due soon (Ø§Ù„ØªØ¬Ù…ÙŠØ¹: Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„Ù‰ + Ø§Ù„Ù‚Ø§Ø¯Ù… Ùˆ ÙŠØ´Ù…Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø§Ø±Ù‰ ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù… Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ) ===== */
function drawDueSoon(){
  // we'll update badges in header summary area already in recalc
  // but keep a compact representation by updating badges above
  // for simplicity the table cells exist in commit/collect tables
  // here we won't duplicate heavy UI
}

/* ===== helper chooseAccount (console prompt style) ===== */
function chooseAccount(){
  if(accounts.length===0){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª'); return null; }
  const menu = accounts.map((a,i)=>`${i+1} - ${a.name}`).join('\n');
  const ans = prompt(`Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨:\n${menu}`); if(ans===null) return null;
  const idx = parseInt(ans,10)-1; if(isNaN(idx)||idx<0||idx>=accounts.length){ alert('Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­'); return null; }
  return accounts[idx].name;
}

/* ===== link commit options for tx form ===== */
function refreshLinkCommitOptions(){
  const sel = $('#txLinkCommit'); if(!sel) return;
  const ym = YM();
  const html = commitments.filter(c=>{
    const due = (c.nextDue||c.firstDue||'').slice(0,7);
    const paid = c.payments?.[ym] || 0;
    return due===ym && paid < Number(c.amount||0);
  }).map(c=>`<option value="${c.id}">${escapeHtml(c.name)} â€” Ø£ØµÙ„ ${fmt(c.amount)} â€¢ Ù…Ø¯ÙÙˆØ¹ ${fmt(c.payments?.[ym]||0)}</option>`).join('');
  sel.innerHTML = `<option value="">â€” Ø¨Ø¯ÙˆÙ† â€”</option>` + html;
}

/* ===== export/import ===== */
$('#exportJson').addEventListener('click', ()=> {
  const data = { ledger, accounts, categories, commitments, collections, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'my-finance-data.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('#importFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{
    const text = await f.text(); const data = JSON.parse(text);
    if(Array.isArray(data.accounts)) accounts = data.accounts;
    if(Array.isArray(data.categories)) categories = data.categories;
    if(Array.isArray(data.ledger)) ledger = data.ledger;
    if(Array.isArray(data.commitments)) commitments = data.commitments.map(migrateCommit);
    if(Array.isArray(data.collections)) collections = data.collections;
    saveAll(); bootRender(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
  }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: '+err.message); }
  e.target.value='';
});

/* ===== small helpers ===== */
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

/* ===== collapsible init: set all cards to collapsed by default (respect data-init-collapsed) ===== */
function initCollapsibles(){
  document.querySelectorAll('.card').forEach(card=>{
    const btn = card.querySelector('.toggle');
    if(!btn) return;
    const initCollapsed = card.hasAttribute('data-init-collapsed') || card.dataset.initCollapsed==='true' || card.classList.contains('collapsed');
    if(initCollapsed) card.classList.add('collapsed');
    btn.textContent = card.classList.contains('collapsed') ? 'â–¸' : 'â–¾';
    btn.setAttribute('aria-expanded', String(!card.classList.contains('collapsed')));
    btn.addEventListener('click', ()=> {
      const is = card.classList.toggle('collapsed');
      btn.textContent = is ? 'â–¸' : 'â–¾';
      btn.setAttribute('aria-expanded', String(!is));
    });
  });
}

/* ===== seed minimal data if empty to help UX ===== */
function seedIfEmpty(){
  if(accounts.length===0){
    accounts = [{name:'ÙƒØ§Ø´',opening:5000},{name:'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ',opening:10000}];
  }
  ensureBaseCategories();
  if(ledger.length===0){
    const now = new Date().toISOString();
    ledger.push({id:eid(), created:now, exec:now, due:now.slice(0,10), desc:'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ', type:'income', amount:5000, account:'ÙƒØ§Ø´', category:'Ù…Ø±ØªØ¨', isTransfer:false});
  }
  saveAll();
}

/* ===== boot render ===== */
function bootRender(){
  ensureBaseCategories();
  seedIfEmpty();
  // refresh UI parts
  refreshAccountsAndFilters(); refreshCats();
  drawCommitments(); drawCollections(); refreshLinkCommitOptions();
  recalcAndRender();
  initCollapsibles();
}
bootRender();

/* ===== small UX wiring ===== */
$('#search')?.addEventListener('input', renderTxs);
$('#filterType')?.addEventListener('change', renderTxs);
$('#filterAccount')?.addEventListener('change', renderTxs);
$('#clearFilters')?.addEventListener('click', ()=>{ $('#search').value=''; $('#filterType').value='all'; $('#filterAccount').value='all'; renderTxs(); });

/* ===== helper to expose some functions in window for onclick handlers in table rows ===== */
window.editTx = editTx;
window.delTx = delTx;
window.payCommit = window.payCommit;
window.collectNow = window.collectNow;
window.editCommit = editCommit;
window.delCommit = delCommit;
window.editCollect = editCollect;
window.delCollect = delCollect;
window.chooseAccount = chooseAccount;

/* ===== initial focus & accessibility small tweak ===== */
document.addEventListener('keydown', (e)=>{
  if(e.key==='/' && document.activeElement.tagName.toLowerCase()!=='input') { e.preventDefault(); $('#search').focus(); }
});
</script>
</body>
</html>